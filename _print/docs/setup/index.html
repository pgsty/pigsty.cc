<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/setup/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/setup/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>上手 | PIGSTY</title><meta name=description content="在你的笔记本/云服务器上部署 Pigsty 单机版本，访问数据库以及 Web 用户界面"><meta property="og:url" content="https://pigsty.cc/docs/setup/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="上手"><meta property="og:description" content="在你的笔记本/云服务器上部署 Pigsty 单机版本，访问数据库以及 Web 用户界面"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="上手"><meta itemprop=description content="在你的笔记本/云服务器上部署 Pigsty 单机版本，访问数据库以及 Web 用户界面"><meta itemprop=dateModified content="2026-01-29T10:51:53+08:00"><meta itemprop=wordCount content="114"><meta itemprop=keywords content="教程,PIGSTY"><meta name=twitter:card content="summary"><meta name=twitter:title content="上手"><meta name=twitter:description content="在你的笔记本/云服务器上部署 Pigsty 单机版本，访问数据库以及 Web 用户界面"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/setup/>返回本页常规视图</a>.</p></div><h1 class=title>上手</h1><div class=lead>在你的笔记本/云服务器上部署 Pigsty 单机版本，访问数据库以及 Web 用户界面</div><ul><li>1: <a href=#pg-feb220ce98138be93707bc30fc029cd1>快速上手 Pigsty 单机部署</a></li><li>2: <a href=#pg-e4f81cb32b00220bc332c330a7c6d803>Docker 部署</a></li><li>3: <a href=#pg-fcae07fc2570b34306c20c69a4aab512>从浏览器访问图形用户界面</a></li><li>4: <a href=#pg-b74607462cd5472ff13684ffc71d526f>快速上手 PostgreSQL</a></li><li>5: <a href=#pg-d96b1765e9d967725a0824edd07fe95d>通过配置清单定制 Pigsty 部署</a></li><li>6: <a href=#pg-98758ad7ef56ab0b1a9ad8320b14506b>使用 Ansible 剧本完成部署</a></li><li>7: <a href=#pg-01b2a33b37e8e7124df9aa116794fa36>离线安装</a></li><li>8: <a href=#pg-c38b3e7bce8cb65ffd26ccafa496eb5e>精简安装</a></li><li>9: <a href=#pg-d6a656f7f8306b7de558a78bf1164ae0>安全建议</a></li></ul><div class=content><p>Pigsty 采用可伸缩的架构设计，既可用于 <a href=/docs/deploy><strong>超大规模生产环境</strong></a>，也可用于 <a href=/docs/setup/install><strong>单机开发演示环境</strong></a>，本文关注后者。</p><p>如果您打算学习了解 Pigsty，可以从 <a href=/docs/setup/install/><strong>快速上手</strong></a> 单机部署开始。一台 1C/2G 的 Linux 虚拟机即可运行 Pigsty。</p><p>您可以利用一台 Linux MiniPC，云厂商提供的免费/优惠虚拟机，Windows 的 WSL，或者在自己的笔记本上创建虚拟机用于 Pigsty 部署。
Pigsty 提供了开箱即用的 <a href=/docs/deploy/vagrant/><strong>Vagrant</strong></a> 模板与 <a href=/docs/deploy/terraform/><strong>Terraform</strong></a> 模版，可以帮助您一键在本地或云端置备 Linux 虚拟机。</p><p><a href=/docs/concept/arch><img src=/img/pigsty/arch.png alt=pigsty-arch></a></p><p>单机版本的 Pigsty 包含了所有核心功能，<strong>444</strong> 个 <a href=/docs/pgsql/ext><strong>PG 扩展</strong></a>，自包含的 Grafana / Victoria 监控，<a href=/docs/concept/iac><strong>IaC</strong></a> 置备能力。
以及本地 <a href=/docs/concept/pitr><strong>PITR</strong></a> 时间点恢复。如果您配备了外部的对象存储（用于 PostgreSQL PITR 备份），那么对于 Demo，个人网站，小型服务等场景，
即使是单机环境，也可以提供一定程度的 <a href=/docs/concept/pitr><strong>数据持久性</strong></a> 保证。
不过，单机无法实现 <a href=/docs/concept/ha><strong>高可用</strong></a> —— 故障自动切换至少需要 3 个节点。</p><p>如果您想要在没有互联网连接的环境中安装 Pigsty，请参考 <a href=/docs/setup/offline/><strong>离线安装</strong></a> 模式。
如果您只需要 PostgreSQL 数据库本身，请参考 <a href=/docs/setup/slim/><strong>精简安装</strong></a> 模式。
如果您准备开始进行严肃的多节点生产部署，请参考 <a href=/docs/deploy/><strong>部署指南</strong></a>。</p><hr><h2 id=快速开始>快速开始</h2><p><a href=/docs/deploy/prepare><strong>准备</strong></a> 一台具有 <a href=/docs/deploy/admin#ssh><strong>SSH 权限</strong></a> 的 <a href=/docs/deploy/prepare#%E8%8A%82%E7%82%B9><strong>节点</strong></a>，
安装 <a href=/docs/ref/linux/><strong>兼容的 Linux 系统</strong></a>，使用具有免密 <a href=/docs/deploy/admin#ssh><strong><code>ssh</code></strong></a> 和 <a href=/docs/deploy/admin#sudo><strong><code>sudo</code></strong></a> 权限的 <a href=/docs/deploy/admin><strong>管理用户</strong></a> 执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/get <span style=color:#000;font-weight:700>|</span> bash  <span style=color:#8f5902;font-style:italic># 安装 Pigsty 与依赖</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span> ./configure -g                   <span style=color:#8f5902;font-style:italic># 生成配置（使用默认单机配置模板，-g 参数会生成随机密码）</span>
</span></span><span style=display:flex><span>./deploy.yml                                  <span style=color:#8f5902;font-style:italic># 执行部署剧本，完成部署</span>
</span></span></code></pre></div><p>是的，就是这么简单。您完全可以在不了解任何细节的情况下，使用 <a href=/docs/concept/iac/template><strong>预制配置模板</strong></a> 一键拉起 Pigsty。</p><p>接下来，您可以探索 <a href=/docs/setup/webui/><strong>图形用户界面</strong></a>，访问 <a href=/docs/setup/pgsql/><strong>PostgreSQL 数据库服务</strong></a>；或者进行 <a href=/docs/setup/config><strong>配置定制</strong></a> 并 <a href=/docs/setup/playbook><strong>执行剧本</strong></a> 部署更多集群。</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-feb220ce98138be93707bc30fc029cd1>1 - 快速上手 Pigsty 单机部署</h1><div class=lead>快速上手 Pigsty，从一台全新的 Linux 主机开始，完成单机安装部署！</div><p>本文是 Pigsty 单节点安装指南，生产环境的多节点高可用部署请参考 <a href=/docs/deploy/><strong>部署</strong></a> 文档。</p><p>Pigsty 单机安装分为三步走：<a href=#%E5%AE%89%E8%A3%85><strong>安装</strong></a>，<a href=#%E9%85%8D%E7%BD%AE><strong>配置</strong></a> 与 <a href=#%E9%83%A8%E7%BD%B2><strong>部署</strong></a>。</p><hr><h2 id=摘要>摘要</h2><p><a href=/docs/deploy/prepare><strong>准备</strong></a> 一台具有 <a href=/docs/deploy/admin#ssh><strong>SSH 权限</strong></a> 的 <a href=/docs/deploy/prepare#%E8%8A%82%E7%82%B9><strong>节点</strong></a>，
安装 <a href=/docs/ref/linux/><strong>兼容的 Linux 系统</strong></a>，使用具有免密 <a href=/docs/deploy/admin#ssh><strong><code>ssh</code></strong></a> 和 <a href=/docs/deploy/admin#sudo><strong><code>sudo</code></strong></a> 权限的 <a href=/docs/deploy/admin><strong>管理用户</strong></a> 执行：</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=pigsty.cc（中国） aria-controls=tabs-00-00 aria-selected=true>
pigsty.cc（中国）</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=pigsty.io（全球） aria-controls=tabs-00-01 aria-selected=false>
pigsty.io（全球）</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div></div></div><p>该命令会执行 <a href=#%E5%AE%89%E8%A3%85><strong>安装</strong></a> 脚本，下载并提取 Pigsty 源码至家目录并安装依赖，接下来依次完成 <a href=#%E9%85%8D%E7%BD%AE><strong>配置</strong></a> 与 <a href=#%E9%83%A8%E7%BD%B2><strong>部署</strong></a> 即可完成交付。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty      <span style=color:#8f5902;font-style:italic># 进入 Pigsty 目录</span>
</span></span><span style=display:flex><span>./configure -g   <span style=color:#8f5902;font-style:italic># 生成配置文件（可选，如果知道如何配置可以跳过）</span>
</span></span><span style=display:flex><span>./deploy.yml     <span style=color:#8f5902;font-style:italic># 执行部署剧本，根据生成的配置文件开始安装</span>
</span></span></code></pre></div><p>安装完成后，您可以通过 IP / 域名 + <code>80/443</code> 端口访问 <a href=/docs/setup/webui/><strong>Web 用户界面</strong></a>，
并通过 <code>5432</code> 端口访问 <a href=/docs/setup/pgsql/><strong>PostgreSQL 服务</strong></a>。</p><p>完整流程根据服务器规格/网络条件需 3~10 分钟，<a href=/docs/setup/offline/><strong>离线安装</strong></a> 时能够显著加速；无需监控时可使用 <a href=/docs/setup/slim/><strong>精简安装</strong></a> 进一步加速。</p><p><strong>视频样例：在线单机安装（Debian 13, x86_64）</strong></p><div id=asciinema-5b46e71dbcd3d8fb39b11e5f19e7933f class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-5b46e71dbcd3d8fb39b11e5f19e7933f",o="/demo/install-hero.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[4.5,"安装"],[20,"配置"],[24,"部署"],[170,"完成"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=准备>准备</h2><p>安装 Pigsty 涉及一些 <a href=/docs/deploy/><strong>准备工作</strong></a> ，以下是简略检查清单，单机部署时，许多限制可以放宽。</p><table class=full-width><thead><tr><th style=text-align:center>项目</th><th style=text-align:left>要求</th><th style=text-align:center>项目</th><th style=text-align:left>要求</th></tr></thead><tbody><tr><td style=text-align:center><a href=/docs/deploy/prepare#%E8%8A%82%E7%82%B9><strong>节点</strong></a></td><td style=text-align:left><strong>单节点</strong>，至少 <code>1C2G</code>，上不封顶</td><td style=text-align:center><a href=/docs/deploy/prepare#%E7%A3%81%E7%9B%98><strong>磁盘</strong></a></td><td style=text-align:left><code>/data</code> 作为默认主挂载点，建议使用 <code>xfs</code></td></tr><tr><td style=text-align:center><a href=/docs/deploy/prepare#linux><strong>系统</strong></a></td><td style=text-align:left><code>Linux</code> <code>x86_64</code> / <code>aarch64</code>，EL / Debian / Ubuntu</td><td style=text-align:center><a href=/docs/deploy/prepare#%E7%BD%91%E7%BB%9C><strong>网络</strong></a></td><td style=text-align:left>静态 IPv4 内网地址</td></tr><tr><td style=text-align:center><a href=/docs/deploy/admin#ssh><strong>SSH</strong></a></td><td style=text-align:left>通过公钥 <code>nopass</code> SSH 登陆纳管节点</td><td style=text-align:center><a href=/docs/deploy/admin#sudo><strong>SUDO</strong></a></td><td style=text-align:left>sudo 权限，最好带有 <code>nopass</code> 免密选项</td></tr></tbody></table><p>通常您只需要关注本机 <strong>IP 地址</strong> —— 作为特例，单机部署时，如果没有静态 IP 地址，可使用 <code>127.0.0.1</code> 作为逃生窗口。</p><hr><h2 id=安装>安装</h2><p>您可以使用以下命令自动安装 Pigsty 源码包至 <code>~/pigsty</code> 目录（推荐），部署所需依赖（Ansible）会自动安装。</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=pigsty.cc（中国） aria-controls=tabs-02-00 aria-selected=true>
pigsty.cc（中国）</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=pigsty.io（全球） aria-controls=tabs-02-01 aria-selected=false>
pigsty.io（全球）</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/get <span style=color:#000;font-weight:700>|</span> bash            <span style=color:#8f5902;font-style:italic># 安装最新稳定版本</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/get <span style=color:#000;font-weight:700>|</span> bash -s v4.1.0  <span style=color:#8f5902;font-style:italic># 安装特定版本</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash            <span style=color:#8f5902;font-style:italic># 安装最新稳定版本</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash -s v4.1.0  <span style=color:#8f5902;font-style:italic># 安装特定版本</span>
</span></span></code></pre></div></div></div><p>如果您不希望执行远程脚本，可以手动 <a href=https://github.com/pgsty/pigsty/releases><strong>下载</strong></a> 或克隆源码。使用 <code>git</code> 克隆安装时，请务必检出特定版本后再使用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>git clone https://github.com/pgsty/pigsty<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> pigsty<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>git checkout v4.1.0<span style=color:#000;font-weight:700>;</span>  <span style=color:#8f5902;font-style:italic># 使用 git 安装时，请务必检出特定版本</span>
</span></span></code></pre></div><p>手工下载克隆安装时，请额外执行 <a href=/docs/setup/offline#bootstrap><strong><code>bootstrap</code></strong></a> 脚本以手动安装 Ansible 等部署依赖，您也可以 <a href=/docs/setup/playbook#%E5%AE%89%E8%A3%85-ansible><strong>自行安装</strong></a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./bootstrap           <span style=color:#8f5902;font-style:italic># 安装 ansible，用于执行后续部署</span>
</span></span></code></pre></div><hr><h2 id=配置>配置</h2><p>在 Pigsty 中，部署的蓝图细节由 <a href=/docs/setup/config/><strong>配置清单</strong></a> 所定义，也就是 <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><strong><code>pigsty.yml</code></strong></a> 配置文件，您可以通过声明式配置进行定制。</p><p>Pigsty 提供了 <a href=https://github.com/pgsty/pigsty/blob/main/configure><strong><code>configure</code></strong></a> 脚本作为可选的 <a href=/docs/concept/iac/configure><strong>配置向导</strong></a>，
它将根据您的环境和输入，生成具有良好默认值的 <a href=/docs/concept/iac/inventory/><strong>配置清单</strong></a>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -g                <span style=color:#8f5902;font-style:italic># 使用配置向导生成配置文件，并且生成随机密码</span>
</span></span></code></pre></div><p>配置过程生成的配置文件默认位于：<code>~/pigsty/pigsty.yml</code>，您可以在安装前进行检查，按需修改与定制。</p><p>有许多 <a href=/docs/concept/iac/template/><strong>配置模板</strong></a> 供您参考与使用，但您也完全可以跳过配置向导，直接编辑 <code>pigsty.yml</code> 配置文件进行定制。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure                  <span style=color:#8f5902;font-style:italic># 使用默认模板，安装默认的 PG 18，带有必要扩展</span>
</span></span><span style=display:flex><span>./configure -v <span style=color:#0000cf;font-weight:700>17</span>            <span style=color:#8f5902;font-style:italic># 使用 PG 17 的版本，而非默认的 PG18</span>
</span></span><span style=display:flex><span>./configure -c rich          <span style=color:#8f5902;font-style:italic># 创建本地软件仓库，下载所有扩展，安装主要扩展</span>
</span></span><span style=display:flex><span>./configure -c slim          <span style=color:#8f5902;font-style:italic># 最小安装模板，与 ./slim.yml 剧本一起使用</span>
</span></span><span style=display:flex><span>./configure -c app/supa      <span style=color:#8f5902;font-style:italic># 使用 app/supa 自托管 supabase 配置模板</span>
</span></span><span style=display:flex><span>./configure -c ivory         <span style=color:#8f5902;font-style:italic># 使用 ivorysql 内核而非原生 PG</span>
</span></span><span style=display:flex><span>./configure -i 10.11.12.13   <span style=color:#8f5902;font-style:italic># 显式指定主 IP 地址</span>
</span></span><span style=display:flex><span>./configure -r china         <span style=color:#8f5902;font-style:italic># 使用中国镜像而非默认仓库</span>
</span></span><span style=display:flex><span>./configure -c ha/full -s    <span style=color:#8f5902;font-style:italic># 使用 4 节点沙箱配置模板，不进行 IP 替换和探测</span>
</span></span></code></pre></div><details><summary>配置 / configure 过程的样例输出</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant@meta:~/pigsty$ ./configure
</span></span><span style=display:flex><span>configure pigsty v4.1.0 begin
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>region</span> <span style=color:#ce5c00;font-weight:700>=</span> china
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>kernel</span>  <span style=color:#ce5c00;font-weight:700>=</span> Linux
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>machine</span> <span style=color:#ce5c00;font-weight:700>=</span> x86_64
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>package</span> <span style=color:#ce5c00;font-weight:700>=</span> deb,apt
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>vendor</span>  <span style=color:#ce5c00;font-weight:700>=</span> ubuntu <span style=color:#ce5c00;font-weight:700>(</span>Ubuntu<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>22</span> <span style=color:#ce5c00;font-weight:700>(</span>22.04<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>sudo</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ssh</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@127.0.0.1 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> Multiple IP address candidates found:
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span> 192.168.121.38	    inet 192.168.121.38/24 metric <span style=color:#0000cf;font-weight:700>100</span> brd 192.168.121.255 scope global dynamic eth0
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> 10.10.10.10	    inet 10.10.10.10/24 brd 10.10.10.255 scope global eth1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>primary_ip</span> <span style=color:#ce5c00;font-weight:700>=</span> 10.10.10.10 <span style=color:#ce5c00;font-weight:700>(</span>from demo<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>admin</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@10.10.10.10 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>=</span> meta <span style=color:#ce5c00;font-weight:700>(</span>ubuntu22.04<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>locale</span>  <span style=color:#ce5c00;font-weight:700>=</span> C.UTF-8
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ansible</span> <span style=color:#ce5c00;font-weight:700>=</span> ready
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> pigsty configured
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> don<span style=color:#a40000>&#39;</span>t forget to check it and change passwords!
</span></span><span style=display:flex><span>proceed with ./deploy.yml
</span></span></code></pre></div></details><br><p><strong>配置脚本常用参数</strong>：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>-i|--ip</code></td><td style=text-align:left>当前主机的首要内网 IP 地址，用于替换配置文件中的 IP 地址占位符 <code>10.10.10.10</code></td></tr><tr><td style=text-align:left><code>-c|--conf</code></td><td style=text-align:left>用于指定使用的 <a href=/docs/conf/><strong>配置模板</strong></a>，相对于 <code>conf/</code> 目录，不带 <code>.yml</code> 后缀的配置名称</td></tr><tr><td style=text-align:left><code>-v|--version</code></td><td style=text-align:left>用于指定要安装的 PostgreSQL 大版本，如 <code>13</code>、<code>14</code>、<code>15</code>、<code>16</code>、<code>17</code>、<code>18</code></td></tr><tr><td style=text-align:left><code>-r|--region</code></td><td style=text-align:left>用于指定上游软件源的区域，加速下载： (<code>default|china|europe</code>)</td></tr><tr><td style=text-align:left><code>-n|--non-interactive</code></td><td style=text-align:left>直接使用命令行参数提供首要 IP 地址，跳过交互式向导</td></tr><tr><td style=text-align:left><code>-x|--proxy</code></td><td style=text-align:left>使用当前环境变量配置 <a href=/docs/infra/param#proxy_env><code>proxy_env</code></a> 变量</td></tr></tbody></table><p>如果您的机器网卡绑定了多个 IP 地址，那么需要使用 <code>-i|--ip &lt;ipaddr></code> 显式指定一个当前节点的首要 IP 地址，或在交互式问询中提供。
该脚本将把 IP 占位符 <code>10.10.10.10</code> 替换为当前节点的主 IPv4 地址。选用的地址应为静态 IP 地址，请勿使用公网 IP 地址。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>修改默认密码！</div><p>我们强烈建议您在安装前，事先修改配置文件中使用的默认密码与凭据，详情参考 <a href=/docs/setup/security/><strong>安全建议</strong></a>。</p></div><hr><h2 id=部署>部署</h2><p>Pigsty 的 <a href=/docs/setup/playbook/><strong><code>deploy.yml</code></strong></a> <a href=/docs/setup/playbook/><strong>剧本</strong></a> 会将 <a href=#%E9%85%8D%E7%BD%AE><strong>配置</strong></a> 中生成的蓝图应用至目标节点。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy.yml     <span style=color:#8f5902;font-style:italic># 一次性在当前节点上部署所有定义的模块</span>
</span></span></code></pre></div><details><summary>部署过程的样例输出</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>......
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#ce5c00;font-weight:700>[</span>pgsql : pgsql init <span style=color:#204a87;font-weight:700>done</span><span style=color:#ce5c00;font-weight:700>]</span> *************************************************
</span></span><span style=display:flex><span>ok: <span style=color:#ce5c00;font-weight:700>[</span>10.10.10.11<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>=</span>&gt; <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#4e9a06>&#34;msg&#34;</span>: <span style=color:#4e9a06>&#34;postgres://10.10.10.11/postgres | meta  | dbuser_meta dbuser_view &#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>......
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TASK <span style=color:#ce5c00;font-weight:700>[</span>pg_monitor : load grafana datasource meta<span style=color:#ce5c00;font-weight:700>]</span> *******************************
</span></span><span style=display:flex><span>changed: <span style=color:#ce5c00;font-weight:700>[</span>10.10.10.11<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>PLAY RECAP *********************************************************************
</span></span><span style=display:flex><span>10.10.10.11                : <span style=color:#000>ok</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>302</span>  <span style=color:#000>changed</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>232</span>  <span style=color:#000>unreachable</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#000>skipped</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>65</span>   <span style=color:#000>rescued</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#000>ignored</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>localhost                  : <span style=color:#000>ok</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>6</span>    <span style=color:#000>changed</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>    <span style=color:#000>unreachable</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#000>failed</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#000>skipped</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1</span>    <span style=color:#000>rescued</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>    <span style=color:#000>ignored</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>0</span>
</span></span></code></pre></div><p>当您看到输出尾部如果带有 <code>pgsql init done</code>，<code>PLAY RECAP</code> 等字样，说明安装已经完成！</p></details><br><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>上游软件仓库变更可能导致在线安装失败！</div><p>Pigsty 使用的上游软件仓库（如 Linux / PGDG 仓库）可能会因为不恰当的更新，进入崩溃状态并导致部署失败（有过多次先例）！
您可以选择等待上游仓库修复后安装，或者使用预制的 <a href=/docs/setup/offline#%E7%A6%BB%E7%BA%BF%E8%BD%AF%E4%BB%B6%E5%8C%85><strong>离线软件包</strong></a> 解决这个问题。</p></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>避免重复执行部署剧本！</div><p>警告： 在已经完成部署的环境中再次完整运行 <a href=https://github.com/pgsty/pigsty/blob/main/deploy.yml><strong><code>deploy.yml</code></strong></a> 可能会重启相关服务并覆盖配置，请务必注意！</p></div><hr><h2 id=界面>界面</h2><p>Pigsty 单机安装完成后，您在当前节点上通常会安装有四个功能模块：
<a href=/docs/pgsql/><strong><code>PGSQL</code></strong></a>、<a href=/docs/infra/><strong><code>INFRA</code></strong></a>、<a href=/docs/node/><strong><code>NODE</code></strong></a> 和 <a href=/docs/etcd/><strong><code>ETCD</code></strong></a>。</p><table class=full-width><thead><tr><th style=text-align:center>ID</th><th style=text-align:center><a href=/docs/node/>NODE</a></th><th style=text-align:center><a href=/docs/pgsql/>PGSQL</a></th><th style=text-align:center><a href=/docs/infra/>INFRA</a></th><th style=text-align:center><a href=/docs/etcd/><strong>ETCD</strong></a></th></tr></thead><tbody><tr><td style=text-align:center>1</td><td style=text-align:center><code>10.10.10.10</code></td><td style=text-align:center><code>pg-meta-1</code></td><td style=text-align:center><code>infra-1</code></td><td style=text-align:center><code>etcd-1</code></td></tr></tbody></table><p><a href=/docs/infra><strong><code>INFRA</code></strong></a> 模块通过浏览器提供了一个 <a href=/docs/setup/webui><strong>图形化管理界面</strong></a>，您可以直接通过这台节点上的 Nginx 的 <strong>80/443</strong> 端口访问。</p><p><a href=/docs/pgsql/><strong><code>PGSQL</code></strong></a> 模块提供了一个 <a href=/docs/setup/pgsql><strong>PostgreSQL 数据库服务器</strong></a>，监听 <strong>5432</strong> 端口，也可通过 Pgbouncer / HAProxy <a href=/docs/pgsql/service><strong>代理访问</strong></a>。</p><p><a href=https://demo.pigsty.cc/zh><img src=/img/pigsty/home.png alt></a></p><hr><h2 id=更多>更多</h2><p>您可以以当前节点作为基础，部署和监控 <a href=/docs/conf/full><strong>更多集群</strong></a>：向 <a href=/docs/setup/config/><strong>配置清单</strong></a> 添加数据库集群的定义并运行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add   pg-test      <span style=color:#8f5902;font-style:italic># 将集群 pg-test 的 3 个节点纳入 Pigsty 管理</span>
</span></span><span style=display:flex><span>bin/pgsql-add  pg-test      <span style=color:#8f5902;font-style:italic># 初始化一个 3 节点的 pg-test 高可用 PG 集群</span>
</span></span><span style=display:flex><span>bin/redis-add  redis-ms     <span style=color:#8f5902;font-style:italic># 初始化 Redis 集群： redis-ms</span>
</span></span></code></pre></div><p>大多数模块都需要先安装 <a href=/docs/node/><strong><code>NODE</code></strong></a> 模块。查看可用的 <a href=/docs/ref/module/><strong>模块</strong></a> 了解详情：</p><p><a href=/docs/pgsql/><strong><code>PGSQL</code></strong></a>、<a href=/docs/infra/><strong><code>INFRA</code></strong></a>、<a href=/docs/node/><strong><code>NODE</code></strong></a>、<a href=/docs/etcd/><strong><code>ETCD</code></strong></a>、
<a href=/docs/minio/><strong><code>MINIO</code></strong></a>、<a href=/docs/redis/><strong><code>REDIS</code></strong></a>、<a href=/docs/ferret/><strong><code>FERRET</code></strong></a>、<a href=/docs/docker/><strong><code>DOCKER</code></strong></a>……</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e4f81cb32b00220bc332c330a7c6d803>2 - Docker 部署</h1><div class=lead>在 Docker 容器中快速拉起 Pigsty 单机环境，适合 macOS/Windows 用户体验学习</div><p>Pigsty 旨在运行于原生 Linux 系统上，但也可以在带有 systemd 的 Linux 容器环境中运行。
如果您没有原生 Linux 环境（例如 <strong>macOS</strong> 或 <strong>Windows</strong> 用户），可以使用 Docker 快速拉起一个本地单机 Pigsty 环境进行测试与体验。</p><hr><h2 id=快速开始>快速开始</h2><p>进入 Pigsty 源码包的 <a href=https://github.com/pgsty/pigsty/tree/main/docker><strong><code>docker/</code></strong></a> 目录，使用以下一键命令启动 Pigsty：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty/docker
</span></span><span style=display:flex><span>make launch          <span style=color:#8f5902;font-style:italic># 启动容器 + 生成配置 + 执行部署</span>
</span></span></code></pre></div><p>部署完成后，您可以通过以下方式访问服务：</p><table><thead><tr><th style=text-align:left>服务</th><th style=text-align:left>地址</th><th style=text-align:left>凭据</th></tr></thead><tbody><tr><td style=text-align:left>SSH</td><td style=text-align:left><code>ssh root@localhost -p 2222</code></td><td style=text-align:left>密码：<code>pigsty</code></td></tr><tr><td style=text-align:left>Web 界面</td><td style=text-align:left>http://localhost:8080</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left>Grafana</td><td style=text-align:left>http://localhost:8080/ui</td><td style=text-align:left><code>admin</code> / <code>pigsty</code></td></tr><tr><td style=text-align:left>PostgreSQL</td><td style=text-align:left><code>psql postgres://dbuser_dba:DBUser.DBA@localhost:5432/postgres</code></td><td style=text-align:left><code>DBUser.DBA</code></td></tr></tbody></table><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>Web 界面与 PostgreSQL 服务</div><p>Web 界面与 PostgreSQL 服务仅在完成 <strong>部署</strong>（<code>./deploy.yml</code>）后才可用。</p></div><hr><h2 id=准备>准备</h2><p>使用 Docker 部署 Pigsty 需要满足以下条件：</p><table><thead><tr><th style=text-align:center>项目</th><th style=text-align:left>要求</th><th style=text-align:center>项目</th><th style=text-align:left>要求</th></tr></thead><tbody><tr><td style=text-align:center><strong>Docker</strong></td><td style=text-align:left>Docker 20.10+（Docker Desktop 或 CE）</td><td style=text-align:center><strong>CPU</strong></td><td style=text-align:left>至少 1 核</td></tr><tr><td style=text-align:center><strong>内存</strong></td><td style=text-align:left>至少 2GB</td><td style=text-align:center><strong>磁盘</strong></td><td style=text-align:left>至少 20GB 可用空间</td></tr></tbody></table><p>请确保默认宿主机端口（2222/8080/8443/5432）可用，否则请先修改 <a href=#%E9%85%8D%E7%BD%AE><strong><code>.env</code></strong></a> 文件。</p><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>Docker 部署适用场景</div><ul><li>在 macOS / Windows 等非 Linux 环境下快速体验 Pigsty</li><li>学习和测试 Pigsty 的功能特性，进行开发调试</li><li>快速构建一个本地开发用的 PostgreSQL 环境</li></ul></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>Docker 部署不适用场景</div><ul><li><strong>生产环境部署</strong>：容器环境性能和稳定性不如原生 Linux</li><li><strong>高可用集群</strong>：Docker 单机模式无法实现多节点高可用</li><li><strong>大规模部署</strong>：建议使用原生 Linux 虚拟机或物理机</li></ul></div><hr><h2 id=镜像>镜像</h2><p>Pigsty 提供开箱即用的 Docker 镜像，发布在 <a href=https://hub.docker.com/r/pgsty/pigsty><strong>Docker Hub</strong></a>。</p><table><thead><tr><th style=text-align:left>镜像</th><th style=text-align:left>拉取大小</th><th style=text-align:left>解压大小</th><th style=text-align:left>内容</th></tr></thead><tbody><tr><td style=text-align:left><code>pgsty/pigsty</code></td><td style=text-align:left>~500MB</td><td style=text-align:left>1.3GB</td><td style=text-align:left>Debian 13 + systemd + SSH + pig + Ansible</td></tr></tbody></table><ul><li>同时支持 <strong>amd64</strong>（x86_64）和 <strong>arm64</strong>（Apple Silicon、AWS Graviton）架构</li><li>镜像标签与 Pigsty 版本一致：<code>v4.1.0</code>、<code>latest</code> 等</li><li>镜像内已预生成 docker 配置模板，可直接执行 <code>./deploy.yml</code> 部署</li></ul><p>镜像基于 <strong>Debian 13 (Trixie)</strong> 构建，预装了 <a href=/docs/pig/><strong><code>pig</code></strong></a> CLI 工具和 Ansible，并已初始化好 Pigsty 源码。</p><hr><h2 id=启动>启动</h2><p>Pigsty 提供了开箱即用的 Docker 支持，位于源码的 <a href=https://github.com/pgsty/pigsty/tree/main/docker><strong><code>docker/</code></strong></a> 目录中。</p><p>最简单的方式是使用 <code>make launch</code> 一键启动，它会自动完成启动容器、生成配置、执行部署三个步骤：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty/docker
</span></span><span style=display:flex><span>make launch          <span style=color:#8f5902;font-style:italic># 一键启动：up + config + deploy</span>
</span></span></code></pre></div><p>或者分步执行，可以在每一步进行检查和调整：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty/docker
</span></span><span style=display:flex><span>make up              <span style=color:#8f5902;font-style:italic># 启动容器</span>
</span></span><span style=display:flex><span>make <span style=color:#204a87>exec</span>            <span style=color:#8f5902;font-style:italic># 进入容器</span>
</span></span><span style=display:flex><span>./configure -c docker -g --ip 127.0.0.1  <span style=color:#8f5902;font-style:italic># 生成配置（可选，镜像已预配置）</span>
</span></span><span style=display:flex><span>./deploy.yml         <span style=color:#8f5902;font-style:italic># 执行部署</span>
</span></span></code></pre></div><p>如果您想要使用本地构建的镜像而非从 Docker Hub 拉取，可以先执行构建：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty/docker
</span></span><span style=display:flex><span>make build           <span style=color:#8f5902;font-style:italic># 本地构建镜像</span>
</span></span><span style=display:flex><span>make launch          <span style=color:#8f5902;font-style:italic># 启动容器 + 生成配置 + 执行部署</span>
</span></span></code></pre></div><hr><h2 id=配置>配置</h2><p>您可以通过修改 <a href=https://github.com/pgsty/pigsty/blob/main/docker/.env><strong><code>.env</code></strong></a> 文件来自定义镜像版本和端口映射：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PIGSTY_VERSION</span><span style=color:#ce5c00;font-weight:700>=</span>v4.1.0         <span style=color:#8f5902;font-style:italic># 镜像版本，与 Pigsty 版本号一致</span>
</span></span><span style=display:flex><span><span style=color:#000>PIGSTY_SSH_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>2222</span>          <span style=color:#8f5902;font-style:italic># SSH 端口</span>
</span></span><span style=display:flex><span><span style=color:#000>PIGSTY_HTTP_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>8080</span>         <span style=color:#8f5902;font-style:italic># Nginx HTTP 端口</span>
</span></span><span style=display:flex><span><span style=color:#000>PIGSTY_HTTPS_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>8443</span>        <span style=color:#8f5902;font-style:italic># Nginx HTTPS 端口</span>
</span></span><span style=display:flex><span><span style=color:#000>PIGSTY_PG_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5432</span>           <span style=color:#8f5902;font-style:italic># PostgreSQL 端口</span>
</span></span></code></pre></div><p><strong>端口映射说明</strong>：</p><table><thead><tr><th style=text-align:left>环境变量</th><th style=text-align:left>默认值</th><th style=text-align:left>容器端口</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>PIGSTY_VERSION</code></td><td style=text-align:left><code>v4.1.0</code></td><td style=text-align:left>-</td><td style=text-align:left>镜像版本标签</td></tr><tr><td style=text-align:left><code>PIGSTY_SSH_PORT</code></td><td style=text-align:left><code>2222</code></td><td style=text-align:left>22</td><td style=text-align:left>SSH 访问端口</td></tr><tr><td style=text-align:left><code>PIGSTY_HTTP_PORT</code></td><td style=text-align:left><code>8080</code></td><td style=text-align:left>80</td><td style=text-align:left>Nginx HTTP 端口</td></tr><tr><td style=text-align:left><code>PIGSTY_HTTPS_PORT</code></td><td style=text-align:left><code>8443</code></td><td style=text-align:left>443</td><td style=text-align:left>Nginx HTTPS 端口</td></tr><tr><td style=text-align:left><code>PIGSTY_PG_PORT</code></td><td style=text-align:left><code>5432</code></td><td style=text-align:left>5432</td><td style=text-align:left>PostgreSQL 端口</td></tr></tbody></table><p>如果默认端口已被占用，可以通过环境变量临时覆盖：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PIGSTY_HTTP_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>8888</span> docker compose up -d
</span></span></code></pre></div><hr><h2 id=命令>命令</h2><p>Pigsty Docker 提供了丰富的 Makefile 命令，方便您管理容器和镜像。</p><h3 id=docker-compose-命令>Docker Compose 命令</h3><p>推荐使用 Docker Compose 方式运行，以下是常用命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make up           <span style=color:#8f5902;font-style:italic># 启动容器</span>
</span></span><span style=display:flex><span>make down         <span style=color:#8f5902;font-style:italic># 停止并删除容器</span>
</span></span><span style=display:flex><span>make start        <span style=color:#8f5902;font-style:italic># 启动已停止的容器</span>
</span></span><span style=display:flex><span>make stop         <span style=color:#8f5902;font-style:italic># 停止容器</span>
</span></span><span style=display:flex><span>make restart      <span style=color:#8f5902;font-style:italic># 重启容器</span>
</span></span><span style=display:flex><span>make pull         <span style=color:#8f5902;font-style:italic># 拉取最新镜像</span>
</span></span><span style=display:flex><span>make config       <span style=color:#8f5902;font-style:italic># 在容器内执行 ./configure</span>
</span></span><span style=display:flex><span>make deploy       <span style=color:#8f5902;font-style:italic># 在容器内执行 ./deploy.yml</span>
</span></span><span style=display:flex><span>make launch       <span style=color:#8f5902;font-style:italic># 一键启动：up + config + deploy</span>
</span></span></code></pre></div><h3 id=容器访问命令>容器访问命令</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make <span style=color:#204a87>exec</span>         <span style=color:#8f5902;font-style:italic># 进入容器 bash</span>
</span></span><span style=display:flex><span>make ssh          <span style=color:#8f5902;font-style:italic># 通过 SSH 进入容器</span>
</span></span><span style=display:flex><span>make log          <span style=color:#8f5902;font-style:italic># 查看容器日志</span>
</span></span><span style=display:flex><span>make status       <span style=color:#8f5902;font-style:italic># 查看 systemd 状态</span>
</span></span><span style=display:flex><span>make ps           <span style=color:#8f5902;font-style:italic># 查看进程列表</span>
</span></span><span style=display:flex><span>make conf         <span style=color:#8f5902;font-style:italic># 查看配置文件</span>
</span></span><span style=display:flex><span>make pass         <span style=color:#8f5902;font-style:italic># 查看配置中的密码</span>
</span></span></code></pre></div><h3 id=镜像构建命令>镜像构建命令</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make build        <span style=color:#8f5902;font-style:italic># 本地构建镜像</span>
</span></span><span style=display:flex><span>make buildnc      <span style=color:#8f5902;font-style:italic># 不使用缓存构建镜像</span>
</span></span><span style=display:flex><span>make push         <span style=color:#8f5902;font-style:italic># 构建并推送多架构镜像</span>
</span></span></code></pre></div><h3 id=镜像管理命令>镜像管理命令</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make save         <span style=color:#8f5902;font-style:italic># 导出镜像到 pigsty-&lt;version&gt;-&lt;arch&gt;.tgz</span>
</span></span><span style=display:flex><span>make load         <span style=color:#8f5902;font-style:italic># 从 tgz 文件导入镜像</span>
</span></span><span style=display:flex><span>make rmi          <span style=color:#8f5902;font-style:italic># 删除当前版本的 pigsty 镜像</span>
</span></span></code></pre></div><h3 id=容器清理命令>容器清理命令</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make clean        <span style=color:#8f5902;font-style:italic># 停止并删除容器</span>
</span></span><span style=display:flex><span>make purge        <span style=color:#8f5902;font-style:italic># 删除容器并清空数据（会提示确认）</span>
</span></span></code></pre></div><hr><h2 id=手动运行>手动运行</h2><p>如果您不想使用 Docker Compose，也可以直接使用 <code>docker run</code> 命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p ./data
</span></span><span style=display:flex><span>docker run -d --privileged --name pigsty <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -p 2222:22 -p 8080:80 -p 5432:5432 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -v ./data:/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  pgsty/pigsty:v4.1.0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>docker <span style=color:#204a87>exec</span> -it pigsty ./configure -c docker -g --ip 127.0.0.1
</span></span><span style=display:flex><span>docker <span style=color:#204a87>exec</span> -it pigsty ./deploy.yml
</span></span></code></pre></div><p>或者使用 Makefile 提供的 <code>make run</code> 命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make run          <span style=color:#8f5902;font-style:italic># 使用 docker run 启动</span>
</span></span><span style=display:flex><span>make <span style=color:#204a87>exec</span>         <span style=color:#8f5902;font-style:italic># 进入容器</span>
</span></span><span style=display:flex><span>make clean        <span style=color:#8f5902;font-style:italic># 停止并删除容器</span>
</span></span><span style=display:flex><span>make purge        <span style=color:#8f5902;font-style:italic># 删除容器并清空数据</span>
</span></span></code></pre></div><hr><h2 id=原理>原理</h2><p>Pigsty Docker 镜像基于 <strong>Debian 13 (Trixie)</strong>，启用了 <strong>systemd</strong> 作为 init 系统。
这使得容器内的服务管理方式与原生 Linux 系统保持一致，可以使用 <code>systemctl</code> 管理服务。</p><p>镜像的关键特性：</p><ul><li><strong>systemd 支持</strong>：容器内运行完整的 systemd，可以正常使用服务管理</li><li><strong>SSH 访问</strong>：预配置了 SSH 服务，root 密码为 <code>pigsty</code></li><li><strong>特权模式</strong>：需要 <code>--privileged</code> 参数以支持 systemd</li><li><strong>数据持久化</strong>：通过 <code>/data</code> 卷挂载实现数据持久化</li><li><strong>预装软件</strong>：预装 pig CLI 和 Ansible，已完成 Pigsty 源码初始化</li></ul><p>镜像构建时会执行以下初始化步骤：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 安装 pig CLI</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;deb [trusted=yes] https://repo.pigsty.cc/apt/infra/ generic main&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    &gt; /etc/apt/sources.list.d/pigsty.list <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> apt-get update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> apt-get install -y pig<span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 初始化 Pigsty 源码并安装 Ansible</span><span style=color:#a40000>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>RUN</span> pig sty init -v <span style=color:#4e9a06>${</span><span style=color:#000>PIGSTY_VERSION</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> pig sty boot <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> pig sty conf -c docker --ip 127.0.0.1<span style=color:#a40000>
</span></span></span></code></pre></div><p>在容器内执行 <code>./configure</code> 时，使用 <code>-c docker</code> 参数会应用专门针对 Docker 环境优化的 <a href=/docs/concept/iac/template/><strong>配置模板</strong></a>：</p><ul><li>使用 <code>127.0.0.1</code> 作为默认 IP 地址</li><li>针对容器环境进行了优化调整</li></ul><hr><h2 id=常见问题>常见问题</h2><h3 id=容器无法启动>容器无法启动</h3><p>确保 Docker 已正确安装且有足够的资源分配。在 Docker Desktop 中，建议分配至少 2GB 内存。
检查是否有端口冲突，特别是 2222、8080、8443、5432 端口。</p><h3 id=服务访问失败>服务访问失败</h3><p>Web 界面和 PostgreSQL 服务仅在部署完成后才可用。请确保 <code>./deploy.yml</code> 已成功执行完成。
可以通过 <code>make status</code> 检查容器内服务状态。</p><h3 id=端口冲突>端口冲突</h3><p>如果默认端口已被占用，可以通过修改 <code>.env</code> 文件或使用环境变量指定其他端口：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PIGSTY_HTTP_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>8888</span> <span style=color:#000>PIGSTY_PG_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5433</span> docker compose up -d
</span></span></code></pre></div><h3 id=数据持久化>数据持久化</h3><p>容器数据默认挂载到 <code>./data</code> 目录。如果需要清空数据重新开始：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make purge        <span style=color:#8f5902;font-style:italic># 删除容器并清空数据（会提示确认）</span>
</span></span></code></pre></div><h3 id=macos-上的性能>macOS 上的性能</h3><p>在 macOS 上使用 Docker Desktop 时，由于虚拟化层的开销，性能会比原生 Linux 环境差。
这是正常现象，Docker 部署主要用于开发测试，生产环境请使用 <a href=/docs/setup/install/><strong>原生 Linux 安装</strong></a>。</p><hr><h2 id=更多>更多</h2><ul><li><strong>Docker Hub</strong>：https://hub.docker.com/r/pgsty/pigsty</li><li><strong>源码目录</strong>：https://github.com/pgsty/pigsty/tree/main/docker</li><li><strong>快速上手</strong>：<a href=/docs/setup/install/><strong>原生 Linux 安装</strong></a></li><li><strong>离线安装</strong>：<a href=/docs/setup/offline/><strong>离线安装</strong></a></li><li><strong>生产部署</strong>：<a href=/docs/deploy/><strong>部署指南</strong></a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fcae07fc2570b34306c20c69a4aab512>3 - 从浏览器访问图形用户界面</h1><div class=lead>探索 Pigsty 提供的 Web 图形管理界面，Grafana 大盘，以及如何通过域名和 HTTPS 访问它们。</div><p>Pigsty <a href=/docs/setup/install><strong>单机安装</strong></a> 完成后，您在当前节点上将安装有 <a href=/docs/infra/><strong><code>INFRA</code></strong></a> 模块，它带有一套开箱即用的 Nginx Web 服务器。</p><p>其中的默认服务器配置提供了一个 WebUI 图形界面，用于展示监控仪表盘，并统一代理访问其他组件的 Web 界面。</p><hr><h2 id=访问>访问</h2><p>您可以通过在浏览器中键入部署节点 IP 地址来访问这个图形界面。在默认配置下，Nginx 将通过 <code>80/443</code> 标准端口对外提供服务。</p><table class=full-width><thead><tr><th style=text-align:center>IP 直接访问</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>Demo</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10><strong><code>http://10.10.10.10</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty><strong><code>http://i.pigsty</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty><strong><code>https://i.pigsty</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/zh><strong><code>https://demo.pigsty.cc</code></strong></a></td><td></td></tr></tbody></table><p><a href=https://demo.pigsty.cc/zh><img src=/img/pigsty/home.png alt></a></p><hr><h2 id=监控>监控</h2><p>要访问 Pigsty 的监控系统大盘（Grafana），您可以访问服务器的 <code>/ui</code> 端点。</p><table class=full-width><thead><tr><th style=text-align:center>IP 直接访问</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>Demo</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/ui><strong><code>http://10.10.10.10/ui</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/ui><strong><code>http://i.pigsty/ui</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/ui><strong><code>https://i.pigsty/ui</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/ui><strong><code>https://demo.pigsty.cc/ui</code></strong></a></td><td></td></tr></tbody></table><p>如果您的服务对互联网与办公网开放，我们建议您通过 <a href=/docs/infra/admin/domain/><strong>域名</strong></a> 访问，并启用 <a href=/docs/infra/admin/cert><strong>HTTPS</strong></a> 加密，只需要少量配置工作即可实现。</p><hr><h2 id=端点>端点</h2><p>在默认配置下，Nginx 会在 <code>80/443</code> 端口的默认服务器上，通过不同的路径暴露以下端点：</p><table class=full-width><thead><tr><th style=text-align:left>端点</th><th style=text-align:left>组件</th><th style=text-align:left>原生端口</th><th style=text-align:left>备注</th><th>公开演示</th></tr></thead><tbody><tr><td style=text-align:left><code>/</code></td><td style=text-align:left><a href=/docs/infra/><strong>Nginx</strong></a></td><td style=text-align:left><code>80/443</code></td><td style=text-align:left>首页、本地仓库、文件服务</td><td><a href=https://demo.pigsty.cc><code>demo.pigsty.cc</code></a></td></tr><tr><td style=text-align:left><code>/ui/</code></td><td style=text-align:left><a href=#%E7%9B%91%E6%8E%A7><strong>Grafana</strong></a></td><td style=text-align:left><code>3000</code></td><td style=text-align:left>Grafana 仪表盘入口</td><td><a href=https://demo.pigsty.cc/ui/><code>demo.pigsty.cc/ui/</code></a></td></tr><tr><td style=text-align:left><code>/vmetrics/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VictoriaMetrics</strong></a></td><td style=text-align:left><code>8428</code></td><td style=text-align:left>时序数据库 Web UI</td><td><a href=https://demo.pigsty.cc/vmetrics/><code>demo.pigsty.cc/vmetrics/</code></a></td></tr><tr><td style=text-align:left><code>/vlogs/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VictoriaLogs</strong></a></td><td style=text-align:left><code>9428</code></td><td style=text-align:left>日志数据库 Web UI</td><td><a href=https://demo.pigsty.cc/vlogs/><code>demo.pigsty.cc/vlogs/</code></a></td></tr><tr><td style=text-align:left><code>/vtraces/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VictoriaTraces</strong></a></td><td style=text-align:left><code>10428</code></td><td style=text-align:left>链路追踪 Web UI</td><td><a href=https://demo.pigsty.cc/vtraces/><code>demo.pigsty.cc/vtraces/</code></a></td></tr><tr><td style=text-align:left><code>/vmalert/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VMAlert</strong></a></td><td style=text-align:left><code>8880</code></td><td style=text-align:left>告警规则管理</td><td><a href=https://demo.pigsty.cc/vmalert/><code>demo.pigsty.cc/vmalert/</code></a></td></tr><tr><td style=text-align:left><code>/alertmgr/</code></td><td style=text-align:left><a href=/docs/infra/><strong>AlertManager</strong></a></td><td style=text-align:left><code>9059</code></td><td style=text-align:left>告警管理 Web UI</td><td><a href=https://demo.pigsty.cc/alertmgr/><code>demo.pigsty.cc/alertmgr/</code></a></td></tr><tr><td style=text-align:left><code>/blackbox/</code></td><td style=text-align:left><a href=/docs/infra/><strong>Blackbox</strong></a></td><td style=text-align:left><code>9115</code></td><td style=text-align:left>黑盒探测器</td><td></td></tr><tr><td style=text-align:left><code>/haproxy/*</code></td><td style=text-align:left><a href=/docs/node/><strong>HAProxy</strong></a></td><td style=text-align:left><code>9101</code></td><td style=text-align:left>负载均衡管理 Web UI</td><td></td></tr><tr><td style=text-align:left><code>/pev</code></td><td style=text-align:left><a href=https://github.com/dalibo/pev2><strong>PEV2</strong></a></td><td style=text-align:left><code>80</code></td><td style=text-align:left>PostgreSQL 执行计划可视化</td><td><a href=https://demo.pigsty.cc/pev><code>demo.pigsty.cc/pev</code></a></td></tr><tr><td style=text-align:left><code>/nginx</code></td><td style=text-align:left><a href=/docs/infra/><strong>Nginx</strong></a></td><td style=text-align:left><code>80</code></td><td style=text-align:left>Nginx 状态页（指标采集用）</td><td></td></tr></tbody></table><hr><h2 id=域名访问>域名访问</h2><p>如果您有自己的域名，可以将其解析到 Pigsty 服务器的 IP 地址，从而通过域名访问 Pigsty 提供的各项服务。</p><p>如果您希望启用 HTTPS，则应当修改 <a href=/docs/infra/param#infra_portal><strong><code>infra_portal</code></strong></a> 参数中 <a href=https://github.com/pgsty/pigsty/blob/main/conf/meta.yml#L139><strong><code>home</code></strong></a> 服务器的配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>home </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 将 i.pigsty 替换为你的域名</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># domain 指定域名  # certbot 参数指定证书名称</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>home </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: demo.pigsty.cc ,certbot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mycert }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您可以在部署完成后，执行 <code>make cert</code> 命令为该域名申请免费的 Let&rsquo;s Encrypt 证书。
如果您没有定义 <code>certbot</code> 字段，Pigsty 会默认使用本地 CA 签发自签名的 HTTPS 证书，
在这种情况下，您必须首先信任 Pigsty 的自签名 CA 才可以在浏览器中正常访问。</p><p>您还可以将本地目录与其他上游服务挂载到 Nginx 上，更多管理预案，请参考 <a href=/docs/infra/admin/portal><strong>INFRA 管理 - Nginx</strong></a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b74607462cd5472ff13684ffc71d526f>4 - 快速上手 PostgreSQL</h1><div class=lead>快速上手 PostgreSQL，使用命令行与图形客户端连接上 PostgreSQL 并开始使用。</div><p><a href=https://www.postgresql.org/><strong>PostgreSQL</strong></a>（简称 PG）是世界上最先进、最流行的开源关系型数据库，你可以用它来存储和检索多模态数据。</p><p>本指南面向有基础 Linux 基本命令行操作经验、但对 PostgreSQL 不太熟悉的开发者，带你快速上手 Pigsty 中的 PG。</p><p>我们假设您是个人用户，使用默认单机模式进行部署。关于生产环境多节点高可用集群的使用，请参考 <a href=/docs/pgsql/service/><strong>生产服务接入</strong></a>。</p><hr><h2 id=基本知识>基本知识</h2><p>默认 <a href=/docs/setup/install><strong>单机安装</strong></a> 模板下，您将在当前节点上创建一个名为 <code>pg-meta</code> 的 PostgreSQL 数据库集群，只有一个主库实例。</p><p>PostgreSQL 监听在 <code>5432</code> 端口，集群中带有一个预置的数据库 <code>meta</code> 可供使用。</p><p>您可以在安装完毕后退出当前管理用户 ssh 会话，并重新登陆刷新环境变量后，
通过简单地敲一个 <code>pp</code> 回车，通过命令行工具 <code>psql</code> 访问该数据库集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant@pg-meta-1:~$ pp
</span></span><span style=display:flex><span>psql <span style=color:#ce5c00;font-weight:700>(</span>18.2 <span style=color:#ce5c00;font-weight:700>(</span>Ubuntu 18.2-1.pgdg24.04+2<span style=color:#ce5c00;font-weight:700>))</span>
</span></span><span style=display:flex><span>Type <span style=color:#4e9a06>&#34;help&#34;</span> <span style=color:#204a87;font-weight:700>for</span> help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>postgres</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic>#</span>
</span></span></code></pre></div><p>您也可以切换为操作系统的 <code>postgres</code> 用户，直接执行 <code>psql</code> 命令，即可连接到默认的 <code>postgres</code> 管理数据库上。</p><hr><h2 id=连接数据库>连接数据库</h2><p>想要访问 PostgreSQL 数据库，您需要使用 命令行工具 或者 图形化客户端 工具，填入 PostgreSQL 的 <strong>连接字符串</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres://username:password@host:port/dbname
</span></span></code></pre></div><p>一些驱动和工具也可能会要求你分别填写这些参数，通常以下五项为必选项：</p><table class=full-width><thead><tr><th>参数</th><th>说明</th><th>示例值</th><th>备注</th></tr></thead><tbody><tr><td><code>host</code></td><td>数据库服务器地址</td><td><code>10.10.10.10</code></td><td>换为你的节点 IP 地址或域名，本机可以省略</td></tr><tr><td><code>port</code></td><td>端口号</td><td><code>5432</code></td><td>PG 默认端口，可以省略</td></tr><tr><td><code>username</code></td><td>用户名</td><td><code>dbuser_dba</code></td><td>Pigsty 默认的数据库管理员</td></tr><tr><td><code>password</code></td><td>密码</td><td><code>DBUser.DBA</code></td><td>Pigsty 默认的管理员密码，（<strong>请修改密码</strong>）</td></tr><tr><td><code>dbname</code></td><td>数据库名</td><td><code>meta</code></td><td>默认模板的数据库名称</td></tr></tbody></table><p>个人使用时可以直接使用 Pigsty 默认的数据库超级用户 <code>dbuser_dba</code> 进行连接和管理，数据库管理用户 <code>dbuser_dba</code> 拥有数据库的全部权限。
默认情况下，如果您在配置 Pigsty 时指定了 <code>configure -g</code> 参数，密码会随机生成，并保存在 <code>~/pigsty/pigsty.yml</code> 文件中，可以通过以下命令查看：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat ~/pigsty/pigsty.yml <span style=color:#000;font-weight:700>|</span> grep pg_admin_password
</span></span></code></pre></div><hr><h2 id=默认账号密码>默认账号密码</h2><p>Pigsty 的默认 <a href=/docs/conf/meta><strong>单机模板</strong></a> 默认配置预置了以下数据库用户，可以开箱即用：</p><table class=full-width><thead><tr><th>用户名</th><th>密码</th><th>角色</th><th>用途</th></tr></thead><tbody><tr><td><code>dbuser_dba</code></td><td><code>DBUser.DBA</code></td><td>超级用户</td><td>数据库管理（<strong>请修改密码</strong>）</td></tr><tr><td><code>dbuser_meta</code></td><td><code>DBUser.Meta</code></td><td>业务管理员</td><td>应用读写（<strong>请修改密码</strong>）</td></tr><tr><td><code>dbuser_view</code></td><td><code>DBUser.Viewer</code></td><td>只读用户</td><td>数据查阅（<strong>请修改密码</strong>）</td></tr></tbody></table><p>例如，你可以通过三个不同的连接串，使用三个不同的用户连接到 <code>pg-meta</code> 集群的 <code>meta</code> 数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta
</span></span><span style=display:flex><span>postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5432/meta
</span></span><span style=display:flex><span>postgres://dbuser_view:DBUser.View@10.10.10.10:5432/meta
</span></span></code></pre></div><p>请注意，这些默认密码会在 <code>configure -g</code> 时自动被替换为随机强密码，请注意将 IP 地址和密码替换为实际值。</p><hr><h2 id=使用命令行工具>使用命令行工具</h2><p><code>psql</code> 是 PostgreSQL 官方命令行客户端工具，功能强大，是 DBA 和开发者的首选工具。</p><p>在部署了 Pigsty 的服务器上，你可以直接使用 <code>psql</code> 连接本地数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 最简单的方式：使用 postgres 系统用户本地连接（无需密码）</span>
</span></span><span style=display:flex><span>sudo -u postgres psql
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用连接字符串（推荐，通用性最好）</span>
</span></span><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用参数形式</span>
</span></span><span style=display:flex><span>psql -h 10.10.10.10 -p <span style=color:#0000cf;font-weight:700>5432</span> -U dbuser_dba -d meta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用环境变量避免密码出现在命令行</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>PGPASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;DBUser.DBA&#39;</span>
</span></span><span style=display:flex><span>psql -h 10.10.10.10 -p <span style=color:#0000cf;font-weight:700>5432</span> -U dbuser_dba -d meta
</span></span></code></pre></div><p>成功连接后，你会看到类似这样的提示符：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#ce5c00;font-weight:700>(</span>18.2<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>Type <span style=color:#4e9a06>&#34;help&#34;</span> <span style=color:#204a87;font-weight:700>for</span> help.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>meta</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic>#</span>
</span></span></code></pre></div><p><strong>常用 psql 命令</strong></p><p>进入 psql 后，可以执行 SQL 语句，也可以使用以 <code>\</code> 开头的元命令：</p><table><thead><tr><th>命令</th><th>说明</th><th>命令</th><th>说明</th></tr></thead><tbody><tr><td><code>Ctrl+C</code></td><td>中断查询</td><td><code>Ctrl+D</code></td><td>退出 psql</td></tr><tr><td><code>\?</code></td><td>显示所有元命令帮助</td><td><code>\h</code></td><td>显示 SQL 命令帮助</td></tr><tr><td><code>\l</code></td><td>列出所有数据库</td><td><code>\c dbname</code></td><td>切换到指定数据库</td></tr><tr><td><code>\d table</code></td><td>查看表结构</td><td><code>\d+ table</code></td><td>查看表的详细信息</td></tr><tr><td><code>\du</code></td><td>列出所有用户/角色</td><td><code>\dx</code></td><td>列出已安装的扩展</td></tr><tr><td><code>\dn</code></td><td>列出所有的模式</td><td><code>\dt</code></td><td>列出所有表</td></tr></tbody></table><p><strong>执行 SQL</strong></p><p>在 <code>psql</code> 中直接输入 SQL 语句，以分号 <code>;</code> 结尾：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看 PostgreSQL 版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看当前时间
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 创建一张测试表
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>test</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>id</span><span style=color:#f8f8f8> </span><span style=color:#204a87>SERIAL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#204a87>TEXT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>created_at</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>());</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 插入数据
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>test</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>name</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;hello&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;world&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查询数据
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 删除测试表
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>test</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=使用图形客户端>使用图形客户端</h2><p>如果你更喜欢图形界面，以下是几款流行的 PostgreSQL 客户端：</p><p><strong>Grafana</strong></p><p>Pigsty <a href=/docs/infra><strong><code>INFRA</code></strong></a> 模块中自带了 <a href=/docs/infra><strong>Grafana</strong></a>，并预先配置好了 PostgreSQL 数据源（Meta）。
您可以直接通过 <a href=/docs/setup/webui><strong>浏览器图形界面</strong></a>，从 Grafana Explore 面板中使用 SQL 查询数据库，无需额外安装客户端工具。</p><p>Grafana 默认的用户名是 <strong><code>admin</code></strong>，密码可以在 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中的 <a href=/docs/infra/param#grafana_admin_password><strong><code>grafana_admin_password</code></strong></a> 字段找到（默认 <code>pigsty</code>）。</p><p><strong>DataGrip</strong></p><p><a href=https://www.jetbrains.com/datagrip/><strong>DataGrip</strong></a> 是 JetBrains 出品的专业数据库 IDE，功能强大。
Intellij IDEA 自带的 Database Console 也可以使用类似的方式连接 PostgreSQL。</p><p><strong>DBeaver</strong></p><p><a href=https://dbeaver.io/><strong>DBeaver</strong></a> 是免费开源的通用数据库工具，支持几乎所有主流数据库。这是一个多平台可用的桌面客户端。</p><p><strong>pgAdmin</strong></p><p><a href=https://www.pgadmin.org/><strong>pgAdmin</strong></a> 是 PGDG 官方提供的 PostgreSQL 专用 GUI 工具，可以通过浏览器使用，也有桌面客户端版本。</p><p>Pigsty 在 <a href=/docs/app/pgadmin><strong>软件模板：pgAdmin</strong></a> 中提供了使用 Docker 一键部署 pgAdmin 服务的配置模板。</p><hr><h2 id=查阅监控大盘>查阅监控大盘</h2><p>Pigsty 提供了许多 PostgreSQL <a href=/docs/pgsql/monitor><strong>监控面板</strong></a>，覆盖从集群总览到单表分析的各个层面：</p><p>推荐先从 <strong>PGSQL Overview</strong> 开始浏览，面板中的许多元素都可以点击，您可以逐层深入，查阅每个集群、实例、数据库甚至是表，索引，函数等数据库内对象的详情信息。</p><hr><h2 id=尝试扩展插件>尝试扩展插件</h2><p>PostgreSQL 最强大的特性之一是其 <a href=/docs/pgsql/ext><strong>扩展生态系统</strong></a>。扩展可以为数据库添加新的数据类型、函数、索引方法等能力。</p><p>Pigsty 提供了 PG 生态中独一无二的 <a href=https://pgext.cloud/zh/list><strong>444 扩展</strong></a>，涵盖时序、地理、向量、全文检索等 16 大类别，一键安装即可使用。
你可以先从三个最强大常用的功能扩展开始，这三个扩展是 Pigsty <a href=/docs/conf/meta><strong>默认配置模板</strong></a> 中自动安装的，你还可以继续 <a href=/docs/pgsql/ext/install><strong>加装</strong></a> 更多需要的扩展。</p><ul><li><a href=https://pgext.cloud/e/postgis><strong><code>postgis</code></strong></a> ：地理信息系统，处理地图、位置数据</li><li><a href=https://pgext.cloud/e/vector><strong><code>pgvector</code></strong></a> ： 向量数据库，支持 AI 嵌入向量相似度搜索</li><li><a href=https://pgext.cloud/e/timescaledb><strong><code>timescaledb</code></strong></a> ：时序数据库，高效存储和查询时间序列数据</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>\</span><span style=color:#000>dx</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic>-- psql 元命令，列出已经安装的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>-- 查询已经安装，可以启用的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>--  启用 postgis 扩展
</span></span></span></code></pre></div><hr><h2 id=下一步>下一步</h2><p>恭喜你完成了 PostgreSQL 的基础上手！下一步，你可以开始对你的数据库进行一些 <a href=/docs/setup/config><strong>配置与定制</strong></a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d96b1765e9d967725a0824edd07fe95d>5 - 通过配置清单定制 Pigsty 部署</h1><div class=lead>使用声明式的配置文件，表达你需要的基础设施与集群。</div><p>除了使用 <a href=/docs/concept/iac/configure><strong>配置向导</strong></a> 自动生成配置，您也可以从零开始手工编写 Pigsty 配置文件。
本教程将指导您从头开始，逐步构建一个复杂的 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a>。</p><p>如果您事先就在 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中定义好了一切，那么只要 <code>deploy.yml</code> 剧本一把梭，即可完成所有部署工作，但它隐藏了所有细节。</p><p>所以本文档会把所有模块与剧本拆解开来，介绍如何从一个简单的配置，通过增量添加的方式，形成一套复杂完备的部署。</p><hr><h2 id=最小配置>最小配置</h2><p>最简单的有效配置文件可能如下所示，唯一的内容是定义 <a href=/docs/infra/param#admin_ip><strong><code>admin_ip</code></strong></a> 变量，这是当前安装 Pigsty 节点的 IP 地址（<strong>管理节点</strong>）</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=最简配置 aria-controls=tabs-00-00 aria-selected=true>
最简配置</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=中国特色 aria-controls=tabs-00-01 aria-selected=false>
中国特色</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 天朝自有国情在此，额外配置 region: chian 以使用国内的镜像源加速下载</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>admin_ip: 10.10.10.10, region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>china } }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p>这个配置不会部署任何东西，但是执行 <code>./deploy.yml</code> 剧本时，会在 <code>files/pki/ca</code> 生成一套自签名的 <strong>CA</strong>，用于签发证书。</p><p>为了方便起见，我们还可以额外设置 <a href=/docs/infra/param/#region><strong><code>region</code></strong></a> 参数，指定使用哪个区域的软件镜像源（<code>default</code>，<code>china</code>，<code>europe</code>）。</p><hr><h2 id=加入节点>加入节点</h2><p>Pigsty 的 <a href=/docs/node/><strong><code>NODE</code></strong></a> 模块负责管理集群中的节点。配置清单里存在的 IP 地址，都会被 Pigsty 纳入管理，安装 NODE 模块。</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=最简配置 aria-controls=tabs-01-00 aria-selected=true>
最简配置</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=中国特色 aria-controls=tabs-01-01 aria-selected=false>
中国特色</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 不要忘了将 10.10.10.10 替换为您的实际 IP 地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>nodes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 当前节点 IP 地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 全球默认软件仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>node,pgsql,infra    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 添加 node, pgsql, infra 软件仓库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 不要忘了将 10.10.10.10 替换为您的实际 IP 地址                        </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>nodes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 当前节点 IP 地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>china                        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用中国镜像</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>node,pgsql,infra  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 添加 node, pgsql, infra 软件仓库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p>为了让这个配置更有用，我们添加了两个 <a href=/docs/concept/iac/parameter><strong>全局参数</strong></a>：
指定该节点要添加的软件源 <a href=/docs/node/param/#node_repo_modules><strong><code>node_repo_modules</code></strong></a>；
以及使用哪个区域的镜像的 <a href=/docs/infra/param/#region><strong><code>region</code></strong></a>。</p><p>上面的两个参数能够让节点使用正确的软件仓库，安装默认指定的必须包。
在 NODE 模块中有许多可用的 <a href=/docs/node/param><strong>定制项</strong></a>：您可以定制节点的名称，DNS，软件仓库，要安装的软件包，DNS，NTP，内核参数，调优模板，监控，日志采集等各种细节。
但即使您什么都不改，默认配置也足够了。</p><p>接下来，执行 <code>deploy.yml</code> 剧本，或者更精确地执行 <code>node.yml</code> 剧本，将会把这里定义节点 “纳入 Pigsty 管理”，调整至默认配置描述的状态。</p><table class=full-width><thead><tr><th style=text-align:center>ID</th><th style=text-align:center><a href=/docs/node/>NODE</a></th><th style=text-align:center><a href=/docs/infra/>INFRA</a></th><th style=text-align:center><a href=/docs/etcd/><strong>ETCD</strong></a></th><th style=text-align:center><a href=/docs/pgsql/>PGSQL</a></th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center>1</td><td style=text-align:center><code>10.10.10.10</code></td><td style=text-align:center>-</td><td style=text-align:center>-</td><td style=text-align:center>-</td><td style=text-align:left>添加节点</td></tr></tbody></table><hr><h2 id=加入基础设施>加入基础设施</h2><p>一套功能完备的 RDS 云数据库服务需要基础设施的支持，例如，监控系统（指标/日志采集，告警，可视化），NTP，DNS 等各种基础性服务。</p><p>现在，我们通过定义一个特殊的分组 <code>infra</code>，来部署 <a href=/docs/infra/><strong><code>INFRA</code></strong></a> 模块。为 Pigsty 添加基础设施支持。</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=最简配置 aria-controls=tabs-02-00 aria-selected=true>
最简配置</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=中国特色 aria-controls=tabs-02-01 aria-selected=false>
中国特色</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 只是简单的改了个分组名 nodes -&gt; infra，并添加新的实例变量 infra_seq</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>node,pgsql,infra</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 只是简单的改了个分组名 nodes -&gt; infra，并添加新的实例变量 infra_seq</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>china</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>node,pgsql,infra</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p>同时，我们还分配了一个 <a href=/docs/concept/iac/parameter#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a>：<a href=/docs/infra/param/#infra_seq><strong><code>infra_seq</code></strong></a>，这是为了在多节点部署高可用 <strong>INFRA</strong> 模块时将不同的节点区分开来。</p><p>执行 <code>infra.yml</code> 剧本，将在 <code>10.10.10.10</code> 上安装 <a href=/docs/infra/><strong>INFRA</strong></a> 和 <a href=/docs/node/><strong>NODE</strong></a> 模块。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml   <span style=color:#8f5902;font-style:italic># 在 infra 分组上安装 INFRA 模块（连带安装 NODE 模块）</span>
</span></span></code></pre></div><div id=asciinema-391032ce9daca47d8627cb2574fd29b4 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-391032ce9daca47d8627cb2574fd29b4",o="/demo/infra.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[4,"执行"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><blockquote><p>只要 IP 地址存在，NODE 模块会隐含定义。NODE 模块也是幂等的，即使重复执行一次，也没有什么副作用。</p></blockquote><p>安装完成后，您将拥有一套完整的可观测性基础设施，以及节点监控功能，但 PostgreSQL 数据库服务尚未部署。</p><p>如果您的目的就是设置这一套监控系统（Grafana + Victoria），那么到此为止就大功告成了！<a href=/docs/conf/infra><strong><code>infra</code></strong></a> 模板就是为此设计的。
Pigsty 中的一切都是 <strong>模块化</strong> 的：您可以只部署监控基础设施，而不部署数据库服务；
或者反过来 —— 在没有基础设施的情况下，运行高可用 PostgreSQL 集群 —— <a href=/docs/setup/slim><strong>精简安装</strong></a>。</p><table class=full-width><thead><tr><th style=text-align:center>ID</th><th style=text-align:center><a href=/docs/node/>NODE</a></th><th style=text-align:center><a href=/docs/infra/>INFRA</a></th><th style=text-align:center><a href=/docs/etcd/><strong>ETCD</strong></a></th><th style=text-align:center><a href=/docs/pgsql/>PGSQL</a></th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center>1</td><td style=text-align:center><code>10.10.10.10</code></td><td style=text-align:center><code>infra-1</code></td><td style=text-align:center>-</td><td style=text-align:center>-</td><td style=text-align:left>添加基础设施模块</td></tr></tbody></table><hr><h2 id=部署数据库集群>部署数据库集群</h2><p>要提供 PostgreSQL 服务，您还需要额外安装 <a href=/docs/pgsql/><strong>PGSQL</strong></a> 模块和它所依赖的 <a href=/docs/etcd/><strong>ETCD</strong></a> 模块，这并不复杂，两行配置而已：</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=最简配置 aria-controls=tabs-04-00 aria-selected=true>
最简配置</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=中国特色 aria-controls=tabs-04-01 aria-selected=false>
中国特色</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 新增 etcd 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 新增 pg 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>admin_ip: 10.10.10.10, region: default, node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>node,pgsql,infra }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 新增 etcd 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 新增 pg 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>admin_ip: 10.10.10.10, region: china, node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>node,pgsql,infra }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p>我们在这里添加了两个新的分组：<code>etcd</code> 与 <code>pg-meta</code>，分别定义了一个单节点的 etcd 集群和一个单节点的 PostgreSQL 集群。</p><p>您可以使用 <code>./deploy.yml</code> 重新部署所有内容，也可以使用以下命令进行增量部署：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml  -l etcd      <span style=color:#8f5902;font-style:italic># 在 etcd 组上安装 ETCD 模块</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-meta   <span style=color:#8f5902;font-style:italic># 在 pg-meta 组上安装 PGSQL 模块</span>
</span></span></code></pre></div><p><a href=/docs/pgsql/><strong>PGSQL</strong></a> 模块依赖 <a href=/docs/etcd/><strong>ETCD</strong></a> 进行高可用共识，因此请确保先安装 ETCD 模块。
执行完毕后，您就拥有一个可用的 PostgreSQL 服务了！</p><table class=full-width><thead><tr><th style=text-align:center>ID</th><th style=text-align:center><a href=/docs/node/>NODE</a></th><th style=text-align:center><a href=/docs/infra/>INFRA</a></th><th style=text-align:center><a href=/docs/etcd/><strong>ETCD</strong></a></th><th style=text-align:center><a href=/docs/pgsql/>PGSQL</a></th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center>1</td><td style=text-align:center><code>10.10.10.10</code></td><td style=text-align:center><code>infra-1</code></td><td style=text-align:center><code>etcd-1</code></td><td style=text-align:center><code>etcd-1</code></td><td style=text-align:left>添加 etcd 与 PostgreSQL 集群</td></tr></tbody></table><p>至此，我们用 <a href=/docs/node/playbook#nodeyml><strong><code>node.yml</code></strong></a>, <a href=/docs/infra/playbook#infrayml><strong><code>infra.yml</code></strong></a>, <a href=/docs/etcd/playbook#etcdyml><strong><code>etcd.yml</code></strong></a> 和 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> 四个 <a href=/docs/setup/playbook><strong>剧本</strong></a>，
在单机上部署了完整的四个核心功能模块。</p><hr><h2 id=定义数据库与用户>定义数据库与用户</h2><p>您不仅可以定制在哪些节点上安装哪些模块，还可以定制 PostgreSQL 集群的内部细节，例如 <a href=/docs/pgsql/config/db><strong>数据库</strong></a> 与 <a href=/docs/pgsql/config/user><strong>用户</strong></a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 隐藏其他分组与变量以简化展示</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 定义数据库用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles: [dbrole_admin] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 定义业务数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><a href=/docs/pgsql/param/#pg_users><strong><code>pg_users</code></strong></a>：这里定义一个名为 <code>dbuser_meta</code> 的新用户，密码为 <code>DBUser.Meta</code></li><li><a href=/docs/pgsql/param/#pg_databases><strong><code>pg_databases</code></strong></a>：定义一个名为 <code>meta</code> 的新数据库，包含 Pigsty <a href=/docs/concept/iac/cmdb><strong>CMDB</strong></a> 模式（完全可选）。</li></ul><p>Pigsty 提供了非常丰富的定制参数，覆盖了数据库与用户的方方面面。
如果您事先定义好了上面两个参数描述所需的数据库与用户，那么它们会在 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>./pgsql.yml</code></strong></a> 剧本执行时被自动创建。
如果集群已经创建，您也可以进行增量变更，在现有集群上创建或修改 <a href=/docs/pgsql/admin/user><strong>用户</strong></a> 与 <a href=/docs/pgsql/admin/db><strong>数据库</strong></a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_meta      <span style=color:#8f5902;font-style:italic># 确保 pg-meta 集群中有用户 dbuser_meta</span>
</span></span><span style=display:flex><span>bin/pgsql-db   pg-meta meta             <span style=color:#8f5902;font-style:italic># 确保 pg-meta 集群中有数据库 meta</span>
</span></span></code></pre></div><hr><h2 id=配置-pg-版本与扩展>配置 PG 版本与扩展</h2><p>您可以安装 <a href=/docs/pgsql/config/kernel><strong>不同大版本</strong></a> 的 PostgreSQL，以及多达 <a href=https://pgext.cloud/list><strong>444</strong></a> 种 <a href=/docs/pgsql/ext><strong>扩展插件</strong></a>。让我们卸载当前默认的 PG 18，并安装 PG 17：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l pg-meta   <span style=color:#8f5902;font-style:italic># 移除旧的 pg-meta 集群（因为它是 PG 18）</span>
</span></span></code></pre></div><p>我们可以通过定制参数，让集群默认安装并启用一些常用的扩展：<code>timescaledb</code>、<code>postgis</code> 和 <code>pgvector</code>：</p><ul><li><a href=/docs/pgsql/param/#pg_extensions><strong><code>pg_extensions</code></strong></a>：<a href=/docs/pgsql/ext/install><strong>安装</strong></a> <code>timescaledb</code>、<code>postgis</code>、<code>pgvector</code> 扩展。</li><li><a href=/docs/pgsql/param/#pg_libs><strong><code>pg_libs</code></strong></a>：<a href=/docs/pgsql/ext/config><strong>配置加载</strong></a> <code>timescaledb</code>、<code>pg_stat_statements</code>、<code>auto_explain</code> 扩展动态库。</li><li><a href=/docs/pgsql/param/#pg_databases><strong><code>pg_databases</code></strong></a>：为 <code>meta</code> 数据库 <a href=/docs/pgsql/ext/create><strong>创建启用</strong></a> <code>vector</code>、<code>postgis</code>、<code>timescaledb</code> 扩展。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 新增 etcd 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 指定 PG 版本为 17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb, postgis, pgvector ]     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装这些扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_lib</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb,pg_stat_statements,auto_explain&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 预加载这些扩展动态库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>vector, postgis, timescaledb ] } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles: [dbrole_admin] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>node,pgsql,infra</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta   <span style=color:#8f5902;font-style:italic># 安装 PG17 和扩展重新创建 pg-meta 集群</span>
</span></span></code></pre></div><hr><h2 id=添加更多节点>添加更多节点</h2><p>我们可以向部署中添加更多节点，将其纳入 Pigsty 的管理之中，部署监控，配置仓库，安装软件 ……</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>一次添加整个集群，或者逐个添加节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bin/node-add pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bin/node-add 10.10.10.11</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bin/node-add 10.10.10.12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bin/node-add 10.10.10.13</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div id=asciinema-51d52490efbdd966365988956f52b35f class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-51d52490efbdd966365988956f52b35f",o="/demo/node.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[4,"执行"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=部署高可用pg集群>部署高可用PG集群</h2><p>现在假设我们要在刚添加的三个新节点上，部署一套新的数据库集群 <code>pg-test</code>，采用三节点高可用架构，只需要：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div id=asciinema-942dc186323899bcee0f4643447fbd01 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-942dc186323899bcee0f4643447fbd01",o="/demo/pgsql.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[4,"执行"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=部署-redis-集群>部署 Redis 集群</h2><p>Pigsty 提供了可选的 Redis 支持，可作为 PostgreSQL 前端的缓存服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/redis-add redis-ms
</span></span><span style=display:flex><span>bin/redis-add redis-meta
</span></span><span style=display:flex><span>bin/redis-add redis-test
</span></span></code></pre></div><p>Redis 高可用设置需要使用集群模式或哨兵模式，详情请参阅 <a href=/docs/redis/config/><strong>Redis 配置</strong></a>。</p><hr><h2 id=部署-minio-集群>部署 MinIO 集群</h2><p>Pigsty 提供了可选的开源对象存储，S3 替代 —— <a href=/docs/minio><strong>MinIO</strong></a> 支持，可作为 PostgreSQL 的 <a href=/docs/pgsql/backup/repository><strong>备份存储仓库</strong></a> 。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./minio.yml -l minio
</span></span></code></pre></div><p>严肃的生产环境 MinIO 部署通常需要至少 4 个节点，每个节点配备 4 块硬盘（4N/16D）。</p><hr><h2 id=部署-docker-模块>部署 Docker 模块</h2><p>如果您想要使用容器运行一些 <a href=/docs/app><strong>管理 PG 的工具</strong></a> 或者 <a href=/docs/app><strong>使用 PostgreSQL 的软件</strong></a>，可以安装 <a href=/docs/docker/><strong><code>DOCKER</code></strong></a> 模块。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./docker.yml -l infra
</span></span></code></pre></div><p>你可以使用预制的应用配置模板，一键拉起一些常见的软件工具，例如用于 PG 管理的 GUI 工具： <a href=/docs/app/pgadmin/><strong>Pgadmin</strong></a>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./app.yml    -l infra -e <span style=color:#000>app</span><span style=color:#ce5c00;font-weight:700>=</span>pgadmin
</span></span></code></pre></div><p>甚至，您还可以用 Pigsty 自建 <strong>企业级质量的</strong> <a href=/docs/app/supabase/><strong>Supabase</strong></a>，使用外面的高可用 PostgreSQL 集群作为底座，将无状态的部分运行在容器之中。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-98758ad7ef56ab0b1a9ad8320b14506b>6 - 使用 Ansible 剧本完成部署</h1><div class=lead>使用 Ansible 剧本部署与管理 Pigsty 集群</div><p>Pigsty 使用 <a href=https://docs.ansible.com/><strong>Ansible</strong></a> 对集群进行管理，这是在 SRE 群体中非常流行的大规模/批量化/自动化运维工具。</p><p>Ansible 可以使用 <strong>声明式</strong> 的方式对服务器进行配置管理，所有模块的部署都是通过一系列幂等的 <a href=/docs/ref/playbook><strong>Ansible 剧本</strong></a> 实现的。</p><p>例如，在单机部署时，您会用到 <a href=#%E9%83%A8%E7%BD%B2%E5%89%A7%E6%9C%AC><strong><code>deploy.yml</code></strong></a> 剧本。Pigsty 还有更多 <a href=/docs/ref/playbook><strong>内置剧本</strong></a>，您可以根据需要选择使用。</p><p>了解 Ansible 基础知识有助于更好的使用 Pigsty，但这 <strong>并非必须</strong>，特别是在单机部署时。</p><hr><h2 id=部署剧本>部署剧本</h2><p>Pigsty 提供了一个 “一条龙” 部署剧本 <strong><code>deploy.yml</code></strong>，一次性在当前环境上安装所有模块（如果在配置中定义）：</p><table class=full-width><thead><tr><th>Playbook</th><th>命令</th><th>分组</th><th style=text-align:center><code>infra</code></th><th style=text-align:center><code>[nodes]</code></th><th style=text-align:center><code>etcd</code></th><th style=text-align:center><code>minio</code></th><th style=text-align:center><code>[pgsql]</code></th></tr></thead><tbody><tr><td><code>infra.yml</code></td><td><code>./infra.yml</code></td><td><code>-l infra</code></td><td style=text-align:center>✓</td><td style=text-align:center>✓</td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td></tr><tr><td><code>node.yml</code></td><td><code>./node.yml</code></td><td></td><td style=text-align:center></td><td style=text-align:center>✓</td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td></tr><tr><td><code>etcd.yml</code></td><td><code>./etcd.yml</code></td><td><code>-l etcd</code></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>✓</td><td style=text-align:center></td><td style=text-align:center></td></tr><tr><td><code>minio.yml</code></td><td><code>./minio.yml</code></td><td><code>-l minio</code></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>✓</td><td style=text-align:center></td></tr><tr><td><code>pgsql.yml</code></td><td><code>./pgsql.yml</code></td><td></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center>✓</td></tr></tbody></table><p>这是最简单的部署方式，您也可以参考 <a href=/docs/setup/config/><strong>定制指南</strong></a> 里的说明，一步一步来增量式地完成所有模块与节点的部署。</p><hr><h2 id=安装-ansible>安装 Ansible</h2><p>使用 <a href=/docs/setup/install#%E5%AE%89%E8%A3%85><strong>Pigsty 安装脚本</strong></a> ，或离线安装的 <a href=/docs/setup/offline#bootstrap><strong><code>bootstrap</code></strong></a> 阶段，Pigsty 会自动为您安装 <code>ansible</code> 及其依赖。</p><p>如果您想手动安装 Ansible，可以参考以下说明，支持的 Ansible 最低版本为 2.9</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=true>
Debian / Ubuntu</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=false>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
MacOS</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install -y ansible python3-jmespath
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo dnf install -y ansible python-jmespath         <span style=color:#8f5902;font-style:italic># EL 10</span>
</span></span><span style=display:flex><span>sudo dnf install -y ansible python3.12-jmespath     <span style=color:#8f5902;font-style:italic># EL 9/8</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>brew install ansible
</span></span><span style=display:flex><span>pip3 install jmespath
</span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>修改默认密码！</div><p>请注意，目前 EL10 EPEL 仓库尚未提供完整的 Ansible 包，<a href=/docs/repo/pgsql><strong>Pigsty PGSQL</strong></a> EL10 仓库中补充了这个包。</p></div><p>Ansible 在 macOS 上也可用。您可以使用 <a href=https://brew.sh/><strong>Homebrew</strong></a> 在 Mac 上安装 Ansible，
并将其用作管理节点来管理远程云服务器。如果您在云 VPS 上部署单节点 Pigsty 这很方便，但不建议在生产环境中使用。</p><hr><h2 id=执行剧本>执行剧本</h2><p>Ansible 剧本（Playbook）是包含要执行的一系列任务定义的可执行 YAML 文件。
执行剧本需要您的环境变量 <code>PATH</code> 中有 <code>ansible-playbook</code> 可执行文件。
运行 <code>./node.yml</code> 剧本本质上是执行 <code>ansible-playbook node.yml</code> 命令。</p><p>您可以使用一些参数来精细控制剧本的执行，其中以下 <strong>4 个参数</strong> 需要您了解，以便有效使用 Ansible：</p><table class=full-width><thead><tr><th style=text-align:center>目的</th><th>参数</th><th>描述</th></tr></thead><tbody><tr><td style=text-align:center><a href=#%E9%99%90%E5%88%B6%E4%B8%BB%E6%9C%BA><strong>对象</strong></a></td><td><code>-l|--limit &lt;pattern></code></td><td>限制在特定 分组 / 主机 / 模式 上执行</td></tr><tr><td style=text-align:center><a href=#%E9%99%90%E5%88%B6%E4%BB%BB%E5%8A%A1><strong>任务</strong></a></td><td><code>-t|--tags &lt;tags></code></td><td>只运行具有特定标签的任务</td></tr><tr><td style=text-align:center><a href=#%E9%A2%9D%E5%A4%96%E5%8F%98%E9%87%8F><strong>参数</strong></a></td><td><code>-e|--extra-vars &lt;vars></code></td><td>额外的命令行参数</td></tr><tr><td style=text-align:center><a href=#%E6%8C%87%E5%AE%9A%E6%B8%85%E5%8D%95><strong>配置</strong></a></td><td><code>-i|--inventory &lt;path></code></td><td>使用特定的清单文件</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml                         <span style=color:#8f5902;font-style:italic># 在所有主机上运行 node 剧本</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-test             <span style=color:#8f5902;font-style:italic># 在 pg-test 集群上运行 pgsql 剧本</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build          <span style=color:#8f5902;font-style:italic># 运行 infra.yml 的子任务 repo_build</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_pkg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>  <span style=color:#8f5902;font-style:italic># 删除 pgsql，但保留软件包（不卸载软件）</span>
</span></span><span style=display:flex><span>./infra.yml -i conf/mynginx.yml    <span style=color:#8f5902;font-style:italic># 使用另外一个位置的配置文件</span>
</span></span></code></pre></div><hr><h2 id=限制主机>限制主机</h2><p>剧本的 <strong>执行目标</strong> 可以通过 <code>-l|--limit &lt;selector></code> 限制。
当尝试在特定主机/节点或组/集群上运行剧本时，这很方便。
以下是主机限制的一些示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml                              <span style=color:#8f5902;font-style:italic># 在所有主机上运行（危险！）</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-test                   <span style=color:#8f5902;font-style:italic># 在 pg-test 集群上运行</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.10               <span style=color:#8f5902;font-style:italic># 在单个主机 10.10.10.10 上运行</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-*                      <span style=color:#8f5902;font-style:italic># 在匹配 glob 模式 `pg-*` 的主机/组上运行</span>
</span></span><span style=display:flex><span>./pgsql.yml -l <span style=color:#4e9a06>&#39;10.10.10.11,&amp;pg-test&#39;</span>    <span style=color:#8f5902;font-style:italic># 在 pg-test 组的 10.10.10.11 上运行</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l <span style=color:#4e9a06>&#39;pg-test,!10.10.10.11&#39;</span> <span style=color:#8f5902;font-style:italic># 在 pg-test 上运行，除了 10.10.10.11</span>
</span></span></code></pre></div><p>查看 Ansible 文档中的所有详细信息：<a href=https://docs.ansible.com/ansible/latest/inventory_guide/intro_patterns.html>Patterns: targeting hosts and groups</a></p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>谨慎运行没有主机限制的剧本！</div><p>在大多数时候，缺少这个值可能会有危险，因为大多数剧本将在 <code>all</code> 主机上执行。<strong>请谨慎使用</strong>。</p></div><hr><h2 id=限制任务>限制任务</h2><p><strong>执行任务</strong> 可以通过 <code>-t|--tags &lt;tags></code> 控制。
如果指定，将只执行具有给定标签的任务，而不是整个剧本。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t repo          <span style=color:#8f5902;font-style:italic># 创建仓库</span>
</span></span><span style=display:flex><span>./node.yml  -t node_pkg      <span style=color:#8f5902;font-style:italic># 安装节点包</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_install    <span style=color:#8f5902;font-style:italic># 安装 PG 包和扩展</span>
</span></span><span style=display:flex><span>./etcd.yml  -t etcd_purge    <span style=color:#8f5902;font-style:italic># 销毁 ETCD 集群</span>
</span></span><span style=display:flex><span>./minio.yml -t minio_alias   <span style=color:#8f5902;font-style:italic># 写入 MinIO CLI 配置</span>
</span></span></code></pre></div><p>要运行多个任务，指定多个标签并用逗号分隔 <code>-t tag1,tag2</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml  -t node_repo,node_pkg   <span style=color:#8f5902;font-style:italic># 添加仓库，然后安装包</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_hba,pg_reload     <span style=color:#8f5902;font-style:italic># 配置，然后重新加载 pg hba 规则</span>
</span></span></code></pre></div><hr><h2 id=额外变量>额外变量</h2><p>您可以使用 CLI 参数在运行时覆盖配置参数，它具有 <a href=https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html#understanding-variable-precedence><strong>最高优先级</strong></a>。</p><p>额外的命令行参数可以通过 <code>-e|--extra-vars KEY=VALUE</code> 传递，可以多次使用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用另一个管理员用户创建管理员</span>
</span></span><span style=display:flex><span>./node.yml -e <span style=color:#000>ansible_user</span><span style=color:#ce5c00;font-weight:700>=</span>admin -k -K -t node_admin
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 初始化一个特定的 Redis 实例：10.10.10.11:6379</span>
</span></span><span style=display:flex><span>./redis.yml -l 10.10.10.10 -e <span style=color:#000>redis_port</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>6379</span> -t redis
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 删除 PostgreSQL，但保留软件包和数据</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_pkg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> -e <span style=color:#000>pg_rm_data</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span></code></pre></div><p>对于复杂参数，可以使用 JSON 字符串，一次传递多个复杂参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 添加仓库并安装包</span>
</span></span><span style=display:flex><span>./node.yml -t node_install -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;infra&#34;,&#34;node_packages&#34;:[&#34;duckdb&#34;]}&#39;</span>
</span></span></code></pre></div><hr><h2 id=指定清单>指定清单</h2><p>默认配置文件是 Pigsty 主目录中的 <code>pigsty.yml</code>。
您可以使用 <code>-i &lt;path></code> 参数指定不同的 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 文件路径。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -i conf/rich.yml            <span style=color:#8f5902;font-style:italic># 根据 rich 配置初始化一个下载了所有扩展的单节点</span>
</span></span><span style=display:flex><span>./pgsql.yml -i conf/ha/full.yml         <span style=color:#8f5902;font-style:italic># 根据 full 配置初始化一个 4 节点集群</span>
</span></span><span style=display:flex><span>./pgsql.yml -i conf/app/supa.yml        <span style=color:#8f5902;font-style:italic># 根据 supa.yml 配置初始化一个 1 节点 Supabase 部署</span>
</span></span></code></pre></div><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>更改默认清单文件</div><p>要永久更改 <strong>默认</strong> 配置文件，请修改 <a href=https://github.com/pgsty/pigsty/blob/main/ansible.cfg#L6><code>ansible.cfg</code></a> 中的 <code>inventory</code> 参数。</p></div><hr><h2 id=便捷脚本>便捷脚本</h2><p>Pigsty 提供了一系列便捷脚本来简化常见操作，这些脚本位于 <code>bin/</code> 目录下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add   &lt;cls&gt;            <span style=color:#8f5902;font-style:italic># 将节点纳入 Pigsty 管理：./node.yml -l &lt;cls&gt;</span>
</span></span><span style=display:flex><span>bin/node-rm    &lt;cls&gt;            <span style=color:#8f5902;font-style:italic># 从 Pigsty 移除节点：./node-rm.yml -l &lt;cls&gt;</span>
</span></span><span style=display:flex><span>bin/pgsql-add  &lt;cls&gt;            <span style=color:#8f5902;font-style:italic># 初始化 PG 集群：./pgsql.yml -l &lt;cls&gt;</span>
</span></span><span style=display:flex><span>bin/pgsql-rm   &lt;cls&gt;            <span style=color:#8f5902;font-style:italic># 移除 PG 集群：./pgsql-rm.yml -l &lt;cls&gt;</span>
</span></span><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt; <span style=color:#8f5902;font-style:italic># 添加业务用户：./pgsql-user.yml -l &lt;cls&gt; -e username=&lt;user&gt;</span>
</span></span><span style=display:flex><span>bin/pgsql-db   &lt;cls&gt; &lt;dbname&gt;   <span style=color:#8f5902;font-style:italic># 添加业务数据库：./pgsql-db.yml -l &lt;cls&gt; -e dbname=&lt;db&gt;</span>
</span></span><span style=display:flex><span>bin/redis-add  &lt;cls&gt;            <span style=color:#8f5902;font-style:italic># 初始化 Redis 集群：./redis.yml -l &lt;cls&gt;</span>
</span></span><span style=display:flex><span>bin/redis-rm   &lt;cls&gt;            <span style=color:#8f5902;font-style:italic># 移除 Redis 集群：./redis-rm.yml -l &lt;cls&gt;</span>
</span></span></code></pre></div><p>这些脚本是对 Ansible 剧本的简单封装，让您可以更方便地执行常见操作。</p><hr><h2 id=剧本列表>剧本列表</h2><p>以下是 Pigsty 中的 <a href=/docs/ref/playbook><strong>内置剧本</strong></a>，您也轻松添加自己的剧本，或者按需定制修改剧本的实现逻辑。</p><table class=full-width><thead><tr><th style=text-align:center>模块</th><th>Playbook</th><th>功能</th></tr></thead><tbody><tr><td style=text-align:center><a href=/docs/infra/playbook/><strong>INFRA</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/deploy.yml><strong><code>deploy.yml</code></strong></a></td><td>在当前节点上一键部署 Pigsty</td></tr><tr><td style=text-align:center><a href=/docs/infra/playbook/><strong>INFRA</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/infra.yml><strong><code>infra.yml</code></strong></a></td><td>在基础设施节点上初始化 Pigsty 基础设施</td></tr><tr><td style=text-align:center><a href=/docs/infra/playbook/><strong>INFRA</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/infra-rm.yml><strong><code>infra-rm.yml</code></strong></a></td><td>从基础设施节点移除基础设施组件</td></tr><tr><td style=text-align:center><a href=/docs/infra/playbook/><strong>INFRA</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/cache.yml><strong><code>cache.yml</code></strong></a></td><td>从目标节点制作离线安装包</td></tr><tr><td style=text-align:center><a href=/docs/infra/playbook/><strong>INFRA</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/cert.yml><strong><code>cert.yml</code></strong></a></td><td>使用 Pigsty 自签名 CA 颁发证书</td></tr><tr><td style=text-align:center><a href=/docs/node/playbook/><strong>NODE</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/node.yml><strong><code>node.yml</code></strong></a></td><td>初始化节点，将节点调整到所需状态</td></tr><tr><td style=text-align:center><a href=/docs/node/playbook/><strong>NODE</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/node-rm.yml><strong><code>node-rm.yml</code></strong></a></td><td>从 Pigsty 移除节点</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/playbook/><strong>PGSQL</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/pgsql.yml><strong><code>pgsql.yml</code></strong></a></td><td>初始化 HA PostgreSQL 集群，或添加新副本</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/playbook/><strong>PGSQL</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/pgsql-rm.yml><strong><code>pgsql-rm.yml</code></strong></a></td><td>移除 PostgreSQL 集群，或移除副本</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/playbook/><strong>PGSQL</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/pgsql-db.yml><strong><code>pgsql-db.yml</code></strong></a></td><td>向现有 PostgreSQL 集群添加新业务数据库</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/playbook/><strong>PGSQL</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/pgsql-user.yml><strong><code>pgsql-user.yml</code></strong></a></td><td>向现有 PostgreSQL 集群添加新业务用户</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/playbook/><strong>PGSQL</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/pgsql-pitr.yml><strong><code>pgsql-pitr.yml</code></strong></a></td><td>在现有 PostgreSQL 集群上执行时间点恢复</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/playbook/><strong>PGSQL</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/pgsql-monitor.yml><strong><code>pgsql-monitor.yml</code></strong></a></td><td>使用本地导出器监控远程 PostgreSQL 实例</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/playbook/><strong>PGSQL</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/pgsql-migration.yml><strong><code>pgsql-migration.yml</code></strong></a></td><td>为现有 PostgreSQL 生成迁移手册和脚本</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/playbook/><strong>PGSQL</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/slim.yml><strong><code>slim.yml</code></strong></a></td><td>安装最小组件的 Pigsty</td></tr><tr><td style=text-align:center><a href=/docs/redis/playbook/><strong>REDIS</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/redis.yml><strong><code>redis.yml</code></strong></a></td><td>初始化 Redis 集群/节点/实例</td></tr><tr><td style=text-align:center><a href=/docs/redis/playbook/><strong>REDIS</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/redis-rm.yml><strong><code>redis-rm.yml</code></strong></a></td><td>移除 Redis 集群/节点/实例</td></tr><tr><td style=text-align:center><a href=/docs/etcd/playbook/><strong>ETCD</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/etcd.yml><strong><code>etcd.yml</code></strong></a></td><td>初始化 ETCD 集群，或扩容新成员</td></tr><tr><td style=text-align:center><a href=/docs/etcd/playbook/><strong>ETCD</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/etcd-rm.yml><strong><code>etcd-rm.yml</code></strong></a></td><td>移除 ETCD 集群与数据，或移除现有成员缩容</td></tr><tr><td style=text-align:center><a href=/docs/minio/playbook/><strong>MINIO</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/minio.yml><strong><code>minio.yml</code></strong></a></td><td>初始化 MinIO 集群（pgBackRest 仓库可选）</td></tr><tr><td style=text-align:center><a href=/docs/minio/playbook/><strong>MINIO</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/minio-rm.yml><strong><code>minio-rm.yml</code></strong></a></td><td>移除 MinIO 集群与数据</td></tr><tr><td style=text-align:center><a href=/docs/docker/playbook/><strong>DOCKER</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/docker.yml><strong><code>docker.yml</code></strong></a></td><td>在节点上安装 Docker</td></tr><tr><td style=text-align:center><a href=/docs/docker/playbook/><strong>DOCKER</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/app.yml><strong><code>app.yml</code></strong></a></td><td>使用 Docker Compose 安装应用程序</td></tr><tr><td style=text-align:center><a href=/docs/ferret/playbook><strong>FERRET</strong></a></td><td><a href=https://github.com/pgsty/pigsty/blob/main/mongo.yml><strong><code>mongo.yml</code></strong></a></td><td>在节点上安装 Mongo/FerretDB</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-01b2a33b37e8e7124df9aa116794fa36>7 - 离线安装</h1><div class=lead>在没有互联网访问的环境中，使用离线安装包安装 Pigsty</div><p>Pigsty 默认从互联网上游 <a href=/docs/setup/install/><strong>安装</strong></a> 所需软件包，但有些环境与互联网隔离。
为了解决这个问题，Pigsty 支持使用 <a href=#%E7%A6%BB%E7%BA%BF%E8%BD%AF%E4%BB%B6%E5%8C%85><strong>离线软件包</strong></a> 进行离线安装。
您可以将其视作 Linux-原生版本的 Docker 镜像。</p><hr><h2 id=概览>概览</h2><p><strong>离线软件包</strong> 打包了所有需要的 RPM/DEB 软件包及其依赖；它是常规 <a href=/docs/setup/install/><strong>安装</strong></a> 后的本地 APT / YUM 仓库的快照。</p><p>在 <a href=/docs/deploy><strong>严肃的生产环境部署</strong></a> 中，我们 <strong>强烈推荐</strong> 您使用离线安装包进行安装。
它可以确保后续所有新节点的软件版本与现有环境保持一致，
并且可以避免上游变动导致的在线安装失败（相当常见！）
确保您能独立自主运行它至地老天荒。</p><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>使用离线软件包的优点</div><ul><li>可以简单方便的在互联网隔离的环境中交付实施。</li><li>一次性预下载所有软件包，可以有效加速安装过程。</li><li>无需担心上游依赖项的变动导致依赖错漏/安装失败。</li><li>如果有多个节点，那么所有软件包只需要下载一次，节省带宽资源。</li><li>可以通过本地仓库确保所有节点的软件版本一致，实行统一版本管理</div></li></ul><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>使用离线软件包的缺点</div><ul><li>离线安装包针对 <strong>特定的操作系统小版本制作</strong>，通常不能跨版本使用</li><li>仅为制作时刻的快照，可能不包含最新的更新和操作系统安全补丁。</li><li>离线安装包通常约 1GB 左右，而在线安装则是按需下载，更节省空间。</li></ul></div><hr><h2 id=离线软件包>离线软件包</h2><p>我们通常为以下 <a href=/docs/ref/linux/><strong>Linux 发行版</strong></a> 发布离线软件包，使用较新的操作系统次要版本。</p><table class=full-width><thead><tr><th style=text-align:left>Linux 发行版</th><th style=text-align:left>系统代码</th><th style=text-align:left>小版本</th><th style=text-align:left>软件包</th></tr></thead><tbody><tr><td style=text-align:left>RockyLinux 8 x86_64</td><td style=text-align:left><code>el8.x86_64</code></td><td style=text-align:left><code>8.10</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.el8.x86_64.tgz><strong><code>pigsty-pkg-v4.1.0.el8.x86_64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>RockyLinux 8 aarch64</td><td style=text-align:left><code>el8.aarch64</code></td><td style=text-align:left><code>8.10</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.el8.aarch64.tgz><strong><code>pigsty-pkg-v4.1.0.el8.aarch64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>RockyLinux 9 x86_64</td><td style=text-align:left><code>el9.x86_64</code></td><td style=text-align:left><code>9.7</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.el9.x86_64.tgz><strong><code>pigsty-pkg-v4.1.0.el9.x86_64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>RockyLinux 9 aarch64</td><td style=text-align:left><code>el9.aarch64</code></td><td style=text-align:left><code>9.7</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.el9.aarch64.tgz><strong><code>pigsty-pkg-v4.1.0.el9.aarch64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>RockyLinux 10 x86_64</td><td style=text-align:left><code>el10.x86_64</code></td><td style=text-align:left><code>10.1</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.el10.x86_64.tgz><strong><code>pigsty-pkg-v4.1.0.el10.x86_64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>RockyLinux 10 aarch64</td><td style=text-align:left><code>el10.aarch64</code></td><td style=text-align:left><code>10.1</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.el10.aarch64.tgz><strong><code>pigsty-pkg-v4.1.0.el10.aarch64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>Debian 12 x86_64</td><td style=text-align:left><code>d12.x86_64</code></td><td style=text-align:left><code>12.13</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.d12.x86_64.tgz><strong><code>pigsty-pkg-v4.1.0.d12.x86_64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>Debian 12 aarch64</td><td style=text-align:left><code>d12.aarch64</code></td><td style=text-align:left><code>12.13</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.d12.aarch64.tgz><strong><code>pigsty-pkg-v4.1.0.d12.aarch64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>Debian 13 x86_64</td><td style=text-align:left><code>d13.x86_64</code></td><td style=text-align:left><code>13.3</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.d13.x86_64.tgz><strong><code>pigsty-pkg-v4.1.0.d13.x86_64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>Debian 13 aarch64</td><td style=text-align:left><code>d13.aarch64</code></td><td style=text-align:left><code>13.3</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.d13.aarch64.tgz><strong><code>pigsty-pkg-v4.1.0.d13.aarch64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>Ubuntu 24.04 x86_64</td><td style=text-align:left><code>u24.x86_64</code></td><td style=text-align:left><code>24.04.2</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.u24.x86_64.tgz><strong><code>pigsty-pkg-v4.1.0.u24.x86_64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>Ubuntu 24.04 aarch64</td><td style=text-align:left><code>u24.aarch64</code></td><td style=text-align:left><code>24.04.2</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.u24.aarch64.tgz><strong><code>pigsty-pkg-v4.1.0.u24.aarch64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>Ubuntu 22.04 x86_64</td><td style=text-align:left><code>u22.x86_64</code></td><td style=text-align:left><code>22.04.5</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.u22.x86_64.tgz><strong><code>pigsty-pkg-v4.1.0.u22.x86_64.tgz</code></strong></a></td></tr><tr><td style=text-align:left>Ubuntu 22.04 aarch64</td><td style=text-align:left><code>u22.aarch64</code></td><td style=text-align:left><code>22.04.5</code></td><td style=text-align:left><a href=https://github.com/pgsty/pigsty/releases/download/v4.1.0/pigsty-pkg-v4.1.0.u22.aarch64.tgz><strong><code>pigsty-pkg-v4.1.0.u22.aarch64.tgz</code></strong></a></td></tr></tbody></table><p>如果您使用的是上述列表中给出的操作系统（精确匹配的小版本），那么建议使用离线软件包。
Pigsty 为这些系统提供了开箱即用的预制离线软件包，在 GitHub 上提供免费下载。</p><p>您可以从 <a href=https://github.com/pgsty/pigsty/releases/tag/v4.1.0><strong>GitHub 发布页面</strong></a> 找到这些软件包：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>da10de99d819421630f430d01bc9de62  pigsty-pkg-v4.1.0.d12.aarch64.tgz
</span></span><span style=display:flex><span>e1f2ed2da0d6b8c360f9fa2faaa7e175  pigsty-pkg-v4.1.0.d12.x86_64.tgz
</span></span><span style=display:flex><span>382bb38a81c138b1b3e7c194211c2138  pigsty-pkg-v4.1.0.d13.aarch64.tgz
</span></span><span style=display:flex><span>13ceaa728901cc4202687f03d25f1479  pigsty-pkg-v4.1.0.d13.x86_64.tgz
</span></span><span style=display:flex><span>92d061de4d495d05d42f91e4283e7502  pigsty-pkg-v4.1.0.el10.aarch64.tgz
</span></span><span style=display:flex><span>be629ea91adf86bbd7e1c59b659d0069  pigsty-pkg-v4.1.0.el10.x86_64.tgz
</span></span><span style=display:flex><span>c14be706119ba33dd06c71dda6c02298  pigsty-pkg-v4.1.0.el8.aarch64.tgz
</span></span><span style=display:flex><span>0c8b6952ffc00e3b169896129ea39184  pigsty-pkg-v4.1.0.el8.x86_64.tgz
</span></span><span style=display:flex><span>cfcc63b9ecc525165674f58f9365aa19  pigsty-pkg-v4.1.0.el9.aarch64.tgz
</span></span><span style=display:flex><span>34f733080bfa9c8515d1573c35f3e870  pigsty-pkg-v4.1.0.el9.x86_64.tgz
</span></span><span style=display:flex><span>ad52ce9bf25e4d834e55873b3f9ada51  pigsty-pkg-v4.1.0.u22.aarch64.tgz
</span></span><span style=display:flex><span>300b2185c61a03ea7733248e526f3342  pigsty-pkg-v4.1.0.u22.x86_64.tgz
</span></span><span style=display:flex><span>2e561e6ae9abb14796872059d2f694a8  pigsty-pkg-v4.1.0.u24.aarch64.tgz
</span></span><span style=display:flex><span>c462bb4cb2359e771ffcad006888fbd4  pigsty-pkg-v4.1.0.u24.x86_64.tgz
</span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>离线软件包是为特定的 Linux 操作系统小版本制作的</div><p>当操作系统小版本不匹配时，有概率能用，也有概率失败，我们建议你不要冒险尝试。</p><p>请务必注意，Pigsty 提供的 EL9/EL10 安装包基于 9.7 / 10.1 制作，Debian 安装包基于 12.13 / 13.3 制作。
跨操作系统小版本可能因 OpenSSL 或系统库版本变化导致安装失败。
您需要在安装相同操作系统的环境中执行在线安装后制作离线安装包，或联系我们定制离线软件包。</p></div><hr><h2 id=使用离线软件包>使用离线软件包</h2><p><strong>离线安装的步骤</strong>：</p><ol><li>下载 Pigsty 离线软件包，将其放到 <strong><code>/tmp/pkg.tgz</code></strong></li><li>下载 Pigsty 源码包，解压并进入目录（假设解压到家目录：<strong><code>cd ~/pigsty</code></strong>）</li><li><a href=#bootstrap><strong><code>./bootstrap</code></strong></a>，它将解压软件包并配置使用本地仓库（并从中离线安装 <a href=/docs/setup/playbook><strong><code>ansible</code></strong></a> ）</li><li><strong><code>./configure -g -c rich</code></strong>，您可以直接使用配置好离线安装的模板 <a href=/docs/conf/rich><strong><code>rich</code></strong></a>，或者自行配置</li><li>照常运行 <strong><code>./deploy.yml</code></strong>，它将从本地仓库安装所有内容</li></ol><div id=asciinema-0c702eafa8d25429ae93129af859ec22 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-0c702eafa8d25429ae93129af859ec22",o="/demo/install-offline.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[0,"上传软件包"],[55,"解压与使用"],[66,"配置"],[80,"部署"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><p>如果您想要在自己的配置中，使用已经解包配置好的离线软件包，请修改并确保以下配置项：</p><ul><li><a href=/docs/infra/param#repo_enabled><strong><code>repo_enabled</code></strong></a>：将此参数打开，设置为 <strong><code>true</code></strong>，则会构建本地软件源（在大部份配置中被显式关闭）</li><li><a href=/docs/node/param#node_repo_modules><strong><code>node_repo_modules</code></strong></a>：将此参数设置为 <strong><code>local</code></strong>，则环境中所有节点都从本地软件仓库安装<ul><li>在大部份模板中，此参数被显式配置为：<code>node,infra,pgsql</code>，即直接从这些上游软件仓库安装。</li><li>将其设置为 <code>local</code>，则会使用本地软件仓库安装所有软件包，速度最快，没有其他仓库的变数干扰。</li><li>如果你想同时使用本地软件仓库和上游软件仓库，可以将其设置为 <code>local,node,infra,pgsql</code></li></ul></li></ul><p>第一个参数如果打开，Pigsty 会创建 <strong>本地软件仓库</strong>，第二个参数如果包含 <code>local</code>，则环境中的所有节点会使用这个本地软件仓库。
如果只包含 <code>local</code>，那么它会成为所有节点的唯一软件源，如果你还想要从其他上游软件仓库继续安装其他软件包，可以将其他仓库模块名称也添加进去，例如 <code>local,node,infra,pgsql</code>。</p><p><strong>混合安装模式</strong></p><p>如果您的环境有互联网访问，那么有一种混合方法可以融合离线安装与在线安装的优点。
您可以可以使用离线软件包作为基础，并在线补足不匹配的增量软件包。</p><p>例如，假设您使用的是 RockyLinux 9.6，但官方离线软件包是为 RockyLinux 9.7 制作的。
您可以使用 <code>el9</code> 离线软件包（虽然是针对 9.7 制作的），然后在执行正式安装前，执行 <code>make repo-build</code> 重新下载 9.6 对应的缺失软件包，
Pigsty 将从上游仓库重新下载所需的 <strong>增量</strong>。</p><hr><h2 id=制作离线软件包>制作离线软件包</h2><p>如果您选择的操作系统不在默认列表中，您可以使用内置的 <a href=https://github.com/pgsty/pigsty/blob/main/cache.yml><strong><code>cache.yml</code></strong></a> 剧本制作自己的离线软件包：</p><ol><li>找到一台运行完全相同操作系统版本，且可以访问互联网的节点</li><li>使用 <a href=/docs/conf/rich><strong><code>rich</code></strong></a> 配置模板执行 <a href=/docs/setup/install/><strong>在线安装</strong></a>（<code>configure -c rich</code>）</li><li><code>cd ~/pigsty; ./cache.yml</code>：制作并获取离线软件包到 <code>~/pigsty/dist/${version}/</code></li><li>将离线软件包复制到没有互联网访问的环境中（ftp、scp、usb 等），通过 <code>bootstrap</code> 解包使用</li></ol><p>我们提供 <a href=/docs/about/service/><strong>付费服务</strong></a>，提供经过测试的预制 Linux 主版本.次版本制作离线软件包（<strong>¥200</strong>）。</p><hr><h2 id=bootstrap>Bootstrap</h2><p>Pigsty 依赖 ansible 执行剧本，这个脚本负责用各种方式来确保 ansible 正确安装。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./bootstrap       <span style=color:#8f5902;font-style:italic># 确保 ansible 正确安装（如果有离线包，优先使用离线安装并解包使用）</span>
</span></span></code></pre></div><p>通常在两种情况下，你需要运行这个脚本：</p><ul><li>你不是通过 <a href=/docs/setup/install#%E5%AE%89%E8%A3%85><strong>安装脚本</strong></a> 来安装 Pigsty 的，而是通过下载，<code>git clone</code> 源码包的方式安装的，因此没有安装 ansible。</li><li>你准备通过离线软件包来安装 Pigsty，需要使用这个脚本来从离线软件包中安装 ansible。</li></ul><p><code>bootstrap</code> 脚本将自动检测离线软件包是否存在（<code>-p</code> 指定，默认为 <code>/tmp/pkg.tgz</code>）。
如果存在则解压使用它，然后从里面安装 ansible。
如果离线包不存在，它会尝试从互联网安装 ansible。如果还是不行，那你就要自己想办法了！</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>我的 yum/apt 仓库文件跑到哪里去了？</div><p>引导程序默认会 <strong>移走</strong> 现有软件源配置，以确保只有所需的仓库被启用。
您可以在 <code>/etc/yum.repos.d/backup</code> (EL) 或 <code>/etc/apt/backup</code> (Debian / Ubuntu) 中找回它们。</p><p>如果您想在 <code>bootstrap</code> 过程中保留现有软件源配置，请使用 <code>-k|--keep</code> 参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./bootstrap -k <span style=color:#8f5902;font-style:italic># 或 --keep</span>
</span></span></code></pre></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c38b3e7bce8cb65ffd26ccafa496eb5e>8 - 精简安装</h1><div class=lead>只安装高可用 PostgreSQL 集群及其最小依赖的精简安装模式</div><p>如果您只想要高可用 PostgreSQL 数据库集群本身，而不需要监控、基础设施等功能，请考虑 <strong>精简安装</strong>。</p><p>精简安装没有 <a href=/docs/infra/><strong><code>INFRA</code></strong></a> 模块，没有监控，没有 <a href=/docs/setup/offline/><strong>本地仓库</strong></a>，只有 <a href=/docs/etcd/><strong><code>ETCD</code></strong></a> 和 <a href=/docs/pgsql/><strong><code>PGSQL</code></strong></a> 以及部分 <a href=/docs/node/><strong><code>NODE</code></strong></a> 功能。</p><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>精简安装适合以下场景</div><ul><li>只需要 PostgreSQL 数据库本身，不需要可观测性基础设施。</li><li>资源极度受限的环境，不愿意承担基础设施开销（单机约 0.2 vCPU / 500MB 开销）</li><li>已有外部监控系统，希望统一使用自己的监控管理体系。</li><li>不需要 Grafana 可视化看板组件。</div></li></ul><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>精简安装的局限性</div><ul><li>没有 <a href=/docs/infra><strong>基础设施模块</strong></a>，无法使用 WebUI 和本地软件仓库功能。</li><li><a href=/docs/setup/offline><strong>离线安装</strong></a> 仅限单机模式使用，多节点精简安装只能在线安装。</div></li></ul><hr><h2 id=概览>概览</h2><p>使用精简安装，您需要：</p><ol><li>使用 <a href=/docs/conf/slim><strong><code>slim.yml</code></strong></a> 精简安装配置模板（<code>configure -c slim</code>）</li><li>执行 <code>slim.yml</code> 剧本进行部署，而不是默认的 <code>deploy.yml</code></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://repo.pigsty.cc/get <span style=color:#000;font-weight:700>|</span> bash
</span></span><span style=display:flex><span>./configure -g -c slim
</span></span><span style=display:flex><span>./slim.yml
</span></span></code></pre></div><div id=asciinema-652aef58304c00ff1cb585f667a5397b class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-652aef58304c00ff1cb585f667a5397b",o="/demo/install-slim.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[3,"安装"],[13,"配置"],[22,"部署"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=说明>说明</h2><p>精简安装只安装/配置以下组件：</p><table class=full-width><thead><tr><th style=text-align:center>组件</th><th style=text-align:center>必要性</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>patroni</code></strong></td><td style=text-align:center>⚠️ 必需</td><td style=text-align:left>引导高可用 PostgreSQL 集群</td></tr><tr><td style=text-align:center><strong><code>etcd</code></strong></td><td style=text-align:center>⚠️ 必需</td><td style=text-align:left>Patroni 的元数据库依赖（DCS）</td></tr><tr><td style=text-align:center><strong><code>pgbouncer</code></strong></td><td style=text-align:center>✔️ 可选</td><td style=text-align:left>PostgreSQL 连接池</td></tr><tr><td style=text-align:center><strong><code>vip-manager</code></strong></td><td style=text-align:center>✔️ 可选</td><td style=text-align:left>L2 VIP 绑定到 PostgreSQL 集群主节点</td></tr><tr><td style=text-align:center><strong><code>haproxy</code></strong></td><td style=text-align:center>✔️ 可选</td><td style=text-align:left>根据 Patroni 健康检查，自动路由 <a href=/docs/pgsql/service/><strong>服务</strong></a></td></tr><tr><td style=text-align:center><strong><code>chronyd</code></strong></td><td style=text-align:center>✔️ 可选</td><td style=text-align:left>与 NTP 服务器的时间同步</td></tr><tr><td style=text-align:center><strong><code>tuned</code></strong></td><td style=text-align:center>✔️ 可选</td><td style=text-align:left>节点调优模板和内核参数管理</td></tr></tbody></table><p>你可以通过进一步的配置，关闭所有可选组件，只保留必需组件 <code>patroni</code> 和 <code>etcd</code>。</p><p>因为缺少 Infra 模块的 Nginx 提供本地仓库服务，只有单机安装的时候可以进行 <a href=/docs/setup/offline/><strong>离线安装</strong></a>。</p><hr><h2 id=配置>配置</h2><p>精简安装的配置文件示例：<a href=https://github.com/pgsty/pigsty/blob/main/conf/slim.yml><strong><code>conf/slim.yml</code></strong></a>：</p><table class=full-width><thead><tr><th style=text-align:center>ID</th><th style=text-align:center><a href=/docs/node/>NODE</a></th><th style=text-align:center><a href=/docs/pgsql/>PGSQL</a></th><th style=text-align:center><a href=/docs/infra/>INFRA</a></th><th style=text-align:center><a href=/docs/etcd/><strong>ETCD</strong></a></th></tr></thead><tbody><tr><td style=text-align:center>1</td><td style=text-align:center><code>10.10.10.10</code></td><td style=text-align:center><code>pg-meta-1</code></td><td style=text-align:center><strong>不安装基础设施模块</strong></td><td style=text-align:center><code>etcd-1</code></td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># File      :   slim.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Desc      :   Pigsty slim installation config template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ctime     :   2020-05-22</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Mtime     :   2025-12-28</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Docs      :   https://pigsty.io/docs/conf/slim</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># License   :   Apache-2.0 @ https://pigsty.io/docs/about/license/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Copyright :   2018-2026  Ruohang Feng / Vonng (rh@vonng.com)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># This is the config template for slim / minimal installation</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># No monitoring &amp; infra will be installed, just raw postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Usage:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   curl https://repo.pigsty.io/get | bash</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   ./configure -c slim</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   ./slim.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># dcs service for postgres/patroni ha consensus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 1 node for testing, 3 or 5 for production</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># etcd_seq required</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { etcd_seq: 2 }  # assign from 1 ~ n</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.12: { etcd_seq: 3 }  # odd number please</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># cluster level parameter override roles/etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># mark etcd cluster name etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#----------------------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># PostgreSQL Cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#----------------------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { pg_seq: 2, pg_role: replica } # you can add more!</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.12: { pg_seq: 3, pg_role: replica, pg_offline_query: true }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin   ] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta, baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>vector ]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># https://pigsty.io/docs/pgsql/config/hba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: all ,db: all ,addr: intra ,auth: pwd ,title: &#39;everyone intranet access with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>800</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># https://pigsty.io/docs/pgsql/admin/crontab</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>v4.1.0                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pigsty version string</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># admin node ip address</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>region: default                   # upstream mirror region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default,china,europe</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>nodename_overwrite</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># do not overwrite node hostname on single node mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>node,infra,pgsql</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add these repos directly to the singleton node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune: oltp                     # node tuning specs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp,olap,tiny,crit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf: oltp.yml                   # pgsql tuning specs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>oltp,olap,tiny,crit}.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># Default PostgreSQL Major Version is 18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main, pgsql-common ]  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg kernel and common utils</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#pg_extensions: [ pg18-time ,pg18-gis ,pg18-rag ,pg18-fts ,pg18-olap ,pg18-feat ,pg18-lang ,pg18-type ,pg18-util ,pg18-func ,pg18-admin ,pg18-stat ,pg18-sec ,pg18-fdw ,pg18-sim ,pg18-etl]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#----------------------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># PASSWORD : https://pigsty.io/docs/setup/security/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#----------------------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>grafana_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>grafana_view_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Viewer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Patroni.API</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>haproxy_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_secret_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.MinIO</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_root_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Etcd.Root</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>...</span></span></span></code></pre></div><hr><h2 id=部署>部署</h2><p>精简安装需要使用 <a href=https://github.com/pgsty/pigsty/blob/main/slim.yml><code>slim.yml</code></a> 剧本而不是 <a href=https://github.com/pgsty/pigsty/blob/main/deploy.yml><code>deploy.yml</code></a> 剧本进行部署：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./slim.yml
</span></span></code></pre></div><hr><h2 id=高可用集群>高可用集群</h2><p>精简安装模式也可以部署高可用集群，在 <code>etcd</code> 和 <code>pg-meta</code> 分组中添加更多节点即可，一个三节点的部署样例：</p><table class=full-width><thead><tr><th style=text-align:center>ID</th><th style=text-align:center><a href=/docs/node/>NODE</a></th><th style=text-align:center><a href=/docs/pgsql/>PGSQL</a></th><th style=text-align:center><a href=/docs/infra/>INFRA</a></th><th style=text-align:center><a href=/docs/etcd/><strong>ETCD</strong></a></th></tr></thead><tbody><tr><td style=text-align:center>1</td><td style=text-align:center><code>10.10.10.10</code></td><td style=text-align:center><code>pg-meta-1</code></td><td style=text-align:center><strong>不安装基础设施模块</strong></td><td style=text-align:center><code>etcd-1</code></td></tr><tr><td style=text-align:center>2</td><td style=text-align:center><code>10.10.10.11</code></td><td style=text-align:center><code>pg-meta-2</code></td><td style=text-align:center><strong>不安装基础设施模块</strong></td><td style=text-align:center><code>etcd-2</code></td></tr><tr><td style=text-align:center>3</td><td style=text-align:center><code>10.10.10.12</code></td><td style=text-align:center><code>pg-meta-3</code></td><td style=text-align:center><strong>不安装基础设施模块</strong></td><td style=text-align:center><code>etcd-3</code></td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># &lt;-- 新增</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># &lt;-- 新增</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;-- 新增</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;-- 新增</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin   ] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta, baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>vector ]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># make a full backup every 1am</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 省略 ……</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-d6a656f7f8306b7de558a78bf1164ae0>9 - 安全建议</h1><div class=lead>单机部署，快速上手时的三点安全加固建议</div><p>对于单机部署的 Demo/Dev 场景，只要您 <a href=#%E5%AF%86%E7%A0%81><strong>修改了默认密码</strong></a>，Pigsty 的默认配置已经足够安全。</p><p>如果您的部署对互联网开放，可以考虑添加 <a href=#%E9%98%B2%E7%81%AB%E5%A2%99><strong>防火墙</strong></a> 规则，限制端口访问与来源IP，进一步加固安全性。</p><p>除此之外，我们建议您保护好 Pigsty 的 <a href=#%E6%96%87%E4%BB%B6><strong>关键文件</strong></a>（配置文件与 CA 私钥）防止未授权访问并定期备份。</p><p>对于有着严格安全要求的企业级生产环境，请参考 <a href=/docs/deploy/security/><strong>部署-安全加固</strong></a> 文档进行进阶配置。</p><hr><h2 id=密码>密码</h2><p>Pigsty 是一个开源项目，<strong>默认密码众所周知</strong>。如果您的部署面向互联网或者办公网开放，请务必修改所有默认密码！</p><table class=full-width><thead><tr><th style=text-align:center>模块</th><th>参数</th><th>默认值</th></tr></thead><tbody><tr><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><a href=/docs/infra/param#grafana_admin_password><strong><code>grafana_admin_password</code></strong></a></td><td><code>pigsty</code></td></tr><tr><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><a href=/docs/infra/param#grafana_view_password><strong><code>grafana_view_password</code></strong></a></td><td><code>DBUser.Viewer</code></td></tr><tr><td style=text-align:center><a href=/docs/pgsql><strong><code>PGSQL</code></strong></a></td><td><a href=/docs/pgsql/param#pg_admin_password><strong><code>pg_admin_password</code></strong></a></td><td><code>DBUser.DBA</code></td></tr><tr><td style=text-align:center><a href=/docs/pgsql><strong><code>PGSQL</code></strong></a></td><td><a href=/docs/pgsql/param#pg_monitor_password><strong><code>pg_monitor_password</code></strong></a></td><td><code>DBUser.Monitor</code></td></tr><tr><td style=text-align:center><a href=/docs/pgsql><strong><code>PGSQL</code></strong></a></td><td><a href=/docs/pgsql/param#pg_replication_password><strong><code>pg_replication_password</code></strong></a></td><td><code>DBUser.Replicator</code></td></tr><tr><td style=text-align:center><a href=/docs/pgsql><strong><code>PGSQL</code></strong></a></td><td><a href=/docs/pgsql/param#patroni_password><strong><code>patroni_password</code></strong></a></td><td><code>Patroni.API</code></td></tr><tr><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><a href=/docs/node/param#haproxy_admin_password><strong><code>haproxy_admin_password</code></strong></a></td><td><code>pigsty</code></td></tr><tr><td style=text-align:center><a href=/docs/minio><strong><code>MINIO</code></strong></a></td><td><a href=/docs/minio/param#minio_secret_key><strong><code>minio_secret_key</code></strong></a></td><td><code>S3User.MinIO</code></td></tr><tr><td style=text-align:center><a href=/docs/etcd><strong><code>ETCD</code></strong></a></td><td><a href=/docs/etcd/param#etcd_root_password><strong><code>etcd_root_password</code></strong></a></td><td><code>Etcd.Root</code></td></tr></tbody></table><p>为了避免手动修改密码的繁琐，Pigsty 的 <strong>配置向导</strong> 提供了自动生成随机强密码的功能，使用 <code>configure</code> 的 <code>-g</code> 参数即可。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./configure -g
</span></span><span style=display:flex><span>configure pigsty v4.1.0 begin
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>region</span> <span style=color:#ce5c00;font-weight:700>=</span> china
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>kernel</span>  <span style=color:#ce5c00;font-weight:700>=</span> Darwin, can be used as admin node only
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>machine</span> <span style=color:#ce5c00;font-weight:700>=</span> arm64
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>package</span> <span style=color:#ce5c00;font-weight:700>=</span> brew <span style=color:#ce5c00;font-weight:700>(</span>macOS<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>primary_ip</span> <span style=color:#ce5c00;font-weight:700>=</span> default placeholder 10.10.10.10 <span style=color:#ce5c00;font-weight:700>(</span>macOS<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>=</span> meta <span style=color:#ce5c00;font-weight:700>(</span>unknown distro<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>locale</span>  <span style=color:#ce5c00;font-weight:700>=</span> C.UTF-8
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> generating random passwords...
</span></span><span style=display:flex><span>    grafana_admin_password   : CdG0bDcfm3HFT9H2cvFuv9w7
</span></span><span style=display:flex><span>    pg_admin_password        : 86WqSGdokjol7WAU9fUxY8IG
</span></span><span style=display:flex><span>    pg_monitor_password      : 0X7PtgMmLxuCd2FveaaqBuX9
</span></span><span style=display:flex><span>    pg_replication_password  : 4iAjjXgEY32hbRGVUMeFH460
</span></span><span style=display:flex><span>    patroni_password         : DsD38QLTSq36xejzEbKwEqBK
</span></span><span style=display:flex><span>    haproxy_admin_password   : uhdWhepXrQBrFeAhK9sCSUDo
</span></span><span style=display:flex><span>    minio_secret_key         : z6zrYUN1SbdApQTmfRZlyWMT
</span></span><span style=display:flex><span>    etcd_root_password       : Bmny8op1li1wKlzcaAmvPiWc
</span></span><span style=display:flex><span>    DBUser.Meta              : U5v3CmeXICcMdhMNzP9JN3KY
</span></span><span style=display:flex><span>    DBUser.Viewer            : 9cGQF1QMNCtV3KlDn44AEzpw
</span></span><span style=display:flex><span>    S3User.Backup            : 2gjgSCFYNmDs5tOAiviCqM2X
</span></span><span style=display:flex><span>    S3User.Meta              : XfqkAKY6lBtuDMJ2GZezA15T
</span></span><span style=display:flex><span>    S3User.Data              : OygorcpCbV7DpDmqKe3G6UOj
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> random passwords generated, check and save them
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ansible</span> <span style=color:#ce5c00;font-weight:700>=</span> ready
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> pigsty configured
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> don<span style=color:#a40000>&#39;</span>t forget to check it and change passwords!
</span></span><span style=display:flex><span>proceed with ./deploy.yml
</span></span></code></pre></div><p>我们建议在规划部署之前，就修改所有默认密码，确保部署完成后系统即处于安全状态。事后修改密码是一个繁琐的工作：</p><ul><li><a href=/docs/pgsql/admin/user/#%E7%AE%A1%E7%90%86%E9%BB%98%E8%AE%A4%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81><strong>管理 PostgreSQL 默认用户密码</strong></a></li><li><a href=/docs/infra/admin/sop#%E7%AE%A1%E7%90%86-grafana-%E5%AF%86%E7%A0%81><strong>管理 Grafana 密码</strong></a></li><li><a href=/docs/node/admin#%E7%AE%A1%E7%90%86-haproxy-%E5%AF%86%E7%A0%81><strong>管理 Haproxy 密码</strong></a></li><li><a href=/docs/etcd/admin#%E7%AE%A1%E7%90%86-etcd-%E5%AF%86%E7%A0%81><strong>管理 Etcd 密码</strong></a></li><li><a href=/docs/minio/admin#%E7%AE%A1%E7%90%86-minio-%E5%AF%86%E7%A0%81><strong>管理 MinIO 密码</strong></a></li></ul><hr><h2 id=防火墙>防火墙</h2><p>在互联网或者办公网开放的部署场景中，强烈建议配置 <strong>防火墙规则</strong>，限制访问 IP 范围与端口。</p><p>您可以使用云厂商提供的安全组功能，或者使用 Linux 发行版自带的防火墙服务（如 <code>firewalld</code>、<code>ufw</code>、<code>iptables</code> 等）来实现。</p><table class=full-width><thead><tr><th style=text-align:center>方向:</th><th style=text-align:center>协议</th><th>端口</th><th>服务</th><th>说明</th></tr></thead><tbody><tr><td style=text-align:center>入站</td><td style=text-align:center>TCP</td><td><strong>22</strong></td><td>SSH</td><td>允许 ssh 登陆管理</td></tr><tr><td style=text-align:center>入站</td><td style=text-align:center>TCP</td><td><strong>80</strong></td><td>Nginx</td><td>允许 Nginx HTTP 访问</td></tr><tr><td style=text-align:center>入站</td><td style=text-align:center>TCP</td><td><strong>443</strong></td><td>Nginx</td><td>允许 Nginx HTTPS 访问</td></tr><tr><td style=text-align:center>入站</td><td style=text-align:center>TCP</td><td><strong>5432</strong></td><td>PostgreSQL</td><td>远程公网访问数据库，按需启用</td></tr></tbody></table><p>Pigsty 默认支持配置防火墙规则，允许 22/80/443/5432 从外部网络访问，但这并非默认启用。</p><hr><h2 id=文件>文件</h2><p>在 Pigsty 中，您需要特别保护以下文件：</p><ul><li><strong><code>pigsty.yml</code></strong>：Pigsty 主配置文件，包含所有节点的访问信息与密码</li><li><strong><code>files/pki/ca/ca.key</code></strong>：Pigsty 自签名 CA 的私钥，用于签发部署中所有的 SSL 证书（部署时自动生成）</li></ul><p>我们建议您严格控制这两个文件的访问权限，并定期进行备份，将它们存储在一个安全的位置。</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>