<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/etcd/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/etcd/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>模块：ETCD | PIGSTY</title><meta name=description content="Pigsty 可部署 etcd 模块，作为 DCS 为 PostgreSQL 高可用提供可靠的分布式配置存储支持。"><meta property="og:url" content="https://pigsty.cc/docs/etcd/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="模块：ETCD"><meta property="og:description" content="Pigsty 可部署 etcd 模块，作为 DCS 为 PostgreSQL 高可用提供可靠的分布式配置存储支持。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="模块：ETCD"><meta itemprop=description content="Pigsty 可部署 etcd 模块，作为 DCS 为 PostgreSQL 高可用提供可靠的分布式配置存储支持。"><meta itemprop=dateModified content="2026-02-05T14:43:56+08:00"><meta itemprop=wordCount content="106"><meta itemprop=keywords content="参考,ETCD"><meta name=twitter:card content="summary"><meta name=twitter:title content="模块：ETCD"><meta name=twitter:description content="Pigsty 可部署 etcd 模块，作为 DCS 为 PostgreSQL 高可用提供可靠的分布式配置存储支持。"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/etcd/>返回本页常规视图</a>.</p></div><h1 class=title>模块：ETCD</h1><div class=lead>Pigsty 可部署 etcd 模块，作为 DCS 为 PostgreSQL 高可用提供可靠的分布式配置存储支持。</div><ul><li>1: <a href=#pg-b3c7d25a96ae732f6a6be2d1fd4d5ec6>集群配置</a></li><li>2: <a href=#pg-0bac52423651fcf771f1cdaad4f4c67b>参数列表</a></li><li>3: <a href=#pg-e2a09cf50caf28a3c5a85194967a50bc>管理预案</a></li><li>4: <a href=#pg-f7e866452f3057b5647d06b72632819e>预置剧本</a></li><li>5: <a href=#pg-e584a5e6bb1de156a6ab3580a5451148>监控告警</a></li><li>6: <a href=#pg-b4db80f8234d7db0cbf16b40530478bd>指标列表</a></li><li>7: <a href=#pg-bfaeae9f961d15c2f4a30d7af548af0c>常见问题</a></li></ul><div class=content><p>ETCD 是一个分布式的、可靠的键-值存储，用于存放系统中最为关键的配置数据。</p><p>Pigsty 使用 <a href=https://etcd.io/><strong>etcd</strong></a> 作为 <a href=https://patroni.readthedocs.io/en/latest/dcs_failsafe_mode.html><strong>DCS</strong></a>（分布式配置存储），它对于 PostgreSQL 的高可用性与自动故障转移至关重要。</p><p><a href=/docs/etcd><code>ETCD</code></a> 模块依赖 <a href=/docs/node><code>NODE</code></a> 模块，同时被 <a href=/docs/pgsql><code>PGSQL</code></a> 模块依赖。因此在安装 <a href=/docs/etcd><code>ETCD</code></a> 模块之前，您需要安装 <a href=/docs/node><code>NODE</code></a> 模块将节点纳管。
在部署任何 <a href=/docs/pgsql><code>PGSQL</code></a> 集群之前，你必须先部署一套 <a href=/docs/etcd><code>ETCD</code></a> 集群，因为 PostgreSQL 高可用所需的 <code>patroni</code> 和 <code>vip-manager</code> 会依赖 etcd 实现高可用与 L2 VIP 主库绑定。</p><pre class=mermaid>flowchart LR
    subgraph PGSQL [PGSQL]
        patroni[Patroni]
        vip[VIP Manager]
    end
    
    subgraph ETCD [ETCD]
        etcd[DCS 服务]
    end
    
    subgraph NODE [NODE]
        node[软件仓库]
    end
    
    PGSQL --&gt;|依赖| ETCD --&gt;|依赖| NODE
    
    style PGSQL fill:#3E668F,stroke:#2d4a66,color:#fff
    style ETCD fill:#5B9CD5,stroke:#4178a8,color:#fff
    style NODE fill:#FCDB72,stroke:#d4b85e,color:#333
    
    style patroni fill:#2d4a66,stroke:#1e3347,color:#fff
    style vip fill:#2d4a66,stroke:#1e3347,color:#fff
    style etcd fill:#4178a8,stroke:#2d5a7a,color:#fff
    style node fill:#d4b85e,stroke:#b89a4a,color:#333</pre><p>在一套 Pigsty 部署中，只需要一套 etcd 集群。同一套 etcd 集群可以为多套 PostgreSQL 集群提供 DCS 服务支持。
Pigsty 中的 etcd 默认启用 RBAC，不同 PostgreSQL 集群使用独立的用户名与密码访问 etcd，从而实现多租户管理隔离。
管理员使用 etcd root 用户，拥有对所有 PostgreSQL 集群的管理权限。</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b3c7d25a96ae732f6a6be2d1fd4d5ec6>1 - 集群配置</h1><div class=lead>根据需求场景选择合适的 Etcd 集群规模，并对外提供可靠的接入。</div><p>在部署 Etcd 之前，你需要在 <a href=/docs/setup/config>配置清单</a> 中定义一个 Etcd 集群，通常来说，你可以选择：</p><ul><li><a href=#%E5%8D%95%E8%8A%82%E7%82%B9>单节点</a>：没有高可用性，适用于开发、测试、演示，或者依赖外部 S3 备份进行 PITR 的无高可用单机部署</li><li><a href=#%E4%B8%89%E8%8A%82%E7%82%B9>三节点</a>：具有基本的高可用性，可以容忍一个节点的故障，适用于中小规模的生产环境</li><li><a href=#%E4%BA%94%E8%8A%82%E7%82%B9>五节点</a>：具有更好的高可用性，可以容忍两个节点的故障，适用于大规模生产环境</li></ul><p>偶数节点的 Etcd 集群没有意义，超过五节点的 Etcd 集群并不常见，因此通常使用的规格就是单节点、三节点、五节点。</p><table class=full-width><thead><tr><th style=text-align:left>集群规模</th><th style=text-align:left>仲裁数</th><th style=text-align:left>容忍故障数</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:left>1 节点</td><td style=text-align:left>1</td><td style=text-align:left>0</td><td style=text-align:left>开发、测试、演示</td></tr><tr><td style=text-align:left>3 节点</td><td style=text-align:left>2</td><td style=text-align:left>1</td><td style=text-align:left>中小规模生产环境</td></tr><tr><td style=text-align:left>5 节点</td><td style=text-align:left>3</td><td style=text-align:left>2</td><td style=text-align:left>大规模生产环境</td></tr><tr><td style=text-align:left>7 节点</td><td style=text-align:left>4</td><td style=text-align:left>3</td><td style=text-align:left>特殊高可用需求</td></tr></tbody></table><hr><h2 id=单节点>单节点</h2><p>在 Pigsty 中，定义一个单例 Etcd 实例非常简单，只需要一行配置即可：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd } }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>在 Pigsty 提供的所有单机配置模板中，都有这样一项，其中的占位 IP 地址：<code>10.10.10.10</code> 默认会被替换为当前管理节点的 IP。</p><p>除了 IP 地址外，这里唯一必要的参数是 <a href=/docs/etcd/param#etcd_seq><code>etcd_seq</code></a> 和 <a href=/docs/etcd/param#etcd_cluster><code>etcd_cluster</code></a>，它们会唯一标识每一个 Etcd 实例。</p><hr><h2 id=三节点>三节点</h2><p>三节点的 Etcd 集群最为常见，它可以容忍一个节点的故障，适用于中小规模的生产环境。</p><p>例如，Pigsty 的三节点模板：<a href=/docs/conf/trio><code>trio</code></a> 和 <a href=/docs/conf/safe><code>safe</code></a> 就使用了三节点的 Etcd 集群，如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># etcd_seq （etcd实例号）是必须指定的身份参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 实例号是正整数，一般从 0 或 1 开始依次分配</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 实例号应当终生不可变，一旦分配就不再回收使用。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 集群层面的参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认情况下，etcd 集群名就叫 etcd， 除非您想要部署多套 etcd 集群，否则不要改这个名字</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 是否打开 etcd 的防误删安全保险？ 在生产环境初始化完成后，可以考虑打开这个选项，避免误删。</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=五节点>五节点</h2><p>五节点的 Etcd 集群可以容忍两个节点的故障，适用于大规模生产环境。</p><p>例如，Pigsty 的生产仿真模板：<a href=/docs/conf/pro><code>prod</code></a> 中就使用了一个五节点的 Etcd 集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.21 </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.22 </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.23 </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.24 </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.25 </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd    }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=使用-etcd-的服务>使用 etcd 的服务</h2><p>目前 Pigsty 中使用 etcd 的服务有：</p><table class=full-width><thead><tr><th style=text-align:left>服务</th><th style=text-align:left>用途</th><th style=text-align:left>配置文件</th></tr></thead><tbody><tr><td style=text-align:left><strong>Patroni</strong></td><td style=text-align:left>PostgreSQL 高可用，存储集群状态和配置</td><td style=text-align:left><code>/etc/patroni/patroni.yml</code></td></tr><tr><td style=text-align:left><strong>VIP-Manager</strong></td><td style=text-align:left>在 PostgreSQL 集群上绑定 L2 VIP</td><td style=text-align:left><code>/etc/default/vip-manager.yml</code></td></tr></tbody></table><p>当 etcd 集群的成员信息发生永久性变更时，您应当 <a href=/docs/etcd/admin#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE>重载相关服务的配置</a>，以确保服务能够正确访问 Etcd 集群。</p><p><strong>更新 Patroni 的 etcd 端点引用</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_conf                            <span style=color:#8f5902;font-style:italic># 重新生成 patroni 配置</span>
</span></span><span style=display:flex><span>ansible all -f <span style=color:#0000cf;font-weight:700>1</span> -b -a <span style=color:#4e9a06>&#39;systemctl reload patroni&#39;</span> <span style=color:#8f5902;font-style:italic># 重新加载 patroni 配置</span>
</span></span></code></pre></div><p><strong>更新 VIP-Manager 的 etcd 端点引用</strong>（仅当使用 PGSQL L2 VIP 时需要）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_vip_config                           <span style=color:#8f5902;font-style:italic># 重新生成 vip-manager 配置</span>
</span></span><span style=display:flex><span>ansible all -f <span style=color:#0000cf;font-weight:700>1</span> -b -a <span style=color:#4e9a06>&#39;systemctl restart vip-manager&#39;</span> <span style=color:#8f5902;font-style:italic># 重启 vip-manager</span>
</span></span></code></pre></div><hr><h2 id=rbac-认证配置>RBAC 认证配置</h2><p>Pigsty v4.0 默认启用 etcd 的 RBAC 认证机制。相关配置参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>说明</th><th style=text-align:left>默认值</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/etcd/param#etcd_root_password><code>etcd_root_password</code></a></td><td style=text-align:left>etcd root 用户密码</td><td style=text-align:left><code>Etcd.Root</code></td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_etcd_password><code>pg_etcd_password</code></a></td><td style=text-align:left>Patroni 连接 etcd 的密码</td><td style=text-align:left>空（使用集群名）</td></tr></tbody></table><p><strong>生产环境建议</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_root_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;YourSecureEtcdPassword&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 修改默认密码</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 生产环境开启防误删保护</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=文件系统布局>文件系统布局</h2><p>etcd 模块在目标主机上创建以下目录和文件：</p><table class=full-width><thead><tr><th style=text-align:left>路径</th><th style=text-align:left>用途</th><th style=text-align:left>权限</th></tr></thead><tbody><tr><td style=text-align:left><code>/etc/etcd/</code></td><td style=text-align:left>配置目录</td><td style=text-align:left>0750, etcd:etcd</td></tr><tr><td style=text-align:left><code>/etc/etcd/etcd.conf</code></td><td style=text-align:left>主配置文件</td><td style=text-align:left>0644, etcd:etcd</td></tr><tr><td style=text-align:left><code>/etc/etcd/etcd.pass</code></td><td style=text-align:left>root 密码文件</td><td style=text-align:left>0640, root:etcd</td></tr><tr><td style=text-align:left><code>/etc/etcd/ca.crt</code></td><td style=text-align:left>CA 证书</td><td style=text-align:left>0644, etcd:etcd</td></tr><tr><td style=text-align:left><code>/etc/etcd/server.crt</code></td><td style=text-align:left>服务器证书</td><td style=text-align:left>0644, etcd:etcd</td></tr><tr><td style=text-align:left><code>/etc/etcd/server.key</code></td><td style=text-align:left>服务器私钥</td><td style=text-align:left>0600, etcd:etcd</td></tr><tr><td style=text-align:left><code>/var/lib/etcd/</code></td><td style=text-align:left>备用数据目录</td><td style=text-align:left>0770, etcd:etcd</td></tr><tr><td style=text-align:left><code>/data/etcd/</code></td><td style=text-align:left>主数据目录（可配置）</td><td style=text-align:left>0700, etcd:etcd</td></tr><tr><td style=text-align:left><code>/etc/profile.d/etcdctl.sh</code></td><td style=text-align:left>客户端环境变量</td><td style=text-align:left>0755, root:root</td></tr><tr><td style=text-align:left><code>/usr/lib/systemd/system/etcd.service</code> 或 <code>/lib/systemd/system/etcd.service</code></td><td style=text-align:left>Systemd 服务</td><td style=text-align:left>0644, root:root</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-0bac52423651fcf771f1cdaad4f4c67b>2 - 参数列表</h1><div class=lead>ETCD 模块提供了 13 个配置参数，用于精细控制集群的行为表现。</div><p>ETCD 模块的参数列表，共有 <strong>13</strong> 个参数，分为两个部分：</p><ul><li><a href=#etcd><strong><code>ETCD</code></strong></a>：10 个参数，用于 etcd 集群的部署与配置</li><li><a href=#etcd_remove><strong><code>ETCD_REMOVE</code></strong></a>：3 个参数，控制 etcd 集群的移除</li></ul><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>架构变化：Pigsty v3.6+</div><p>自 Pigsty v3.6 起，<code>etcd.yml</code> 剧本不再包含移除功能，移除相关参数已迁移至独立的 <code>etcd_remove</code> 角色。v4.0 起默认启用 RBAC 认证，新增 <code>etcd_root_password</code> 参数。</p></div><hr><h2 id=参数概览>参数概览</h2><p><a href=#etcd><code>ETCD</code></a> 参数组用于 etcd 集群的部署与配置，包括实例标识、集群名称、数据目录、端口以及认证密码。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#etcd_seq><code>etcd_seq</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>etcd 实例标识符，必填</td></tr><tr><td style=text-align:left><a href=#etcd_cluster><code>etcd_cluster</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>etcd 集群名，默认固定为 etcd</td></tr><tr><td style=text-align:left><a href=#etcd_learner><code>etcd_learner</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>I/A</code></td><td style=text-align:left>是否以 learner 模式初始化 etcd 实例？</td></tr><tr><td style=text-align:left><a href=#etcd_data><code>etcd_data</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>etcd 数据目录，默认为 /data/etcd</td></tr><tr><td style=text-align:left><a href=#etcd_port><code>etcd_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>etcd 客户端端口，默认为 2379</td></tr><tr><td style=text-align:left><a href=#etcd_peer_port><code>etcd_peer_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>etcd 同伴端口，默认为 2380</td></tr><tr><td style=text-align:left><a href=#etcd_init><code>etcd_init</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>etcd 初始集群状态，新建或已存在</td></tr><tr><td style=text-align:left><a href=#etcd_election_timeout><code>etcd_election_timeout</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>etcd 选举超时，默认为 1000ms</td></tr><tr><td style=text-align:left><a href=#etcd_heartbeat_interval><code>etcd_heartbeat_interval</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>etcd 心跳间隔，默认为 100ms</td></tr><tr><td style=text-align:left><a href=#etcd_root_password><code>etcd_root_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>etcd root 用户密码，用于 RBAC 认证</td></tr></tbody></table><p><a href=#etcd_remove><code>ETCD_REMOVE</code></a> 参数组控制 etcd 集群的移除行为，包括防误删保险、数据清理以及软件包卸载。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#etcd_safeguard><code>etcd_safeguard</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>etcd 防误删保险，阻止清除正在运行的 etcd 实例？</td></tr><tr><td style=text-align:left><a href=#etcd_rm_data><code>etcd_rm_data</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>移除时是否删除 etcd 数据？默认为 true</td></tr><tr><td style=text-align:left><a href=#etcd_rm_pkg><code>etcd_rm_pkg</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>移除时是否卸载 etcd 软件包？默认为 false</td></tr></tbody></table><hr><h2 id=etcd><code>ETCD</code></h2><p>本节包含 <a href=https://github.com/pgsty/pigsty/blob/main/roles/etcd/defaults/main.yml><code>etcd</code></a> 角色的参数，
这些是 <a href=/docs/etcd/playbook#etcdyml><code>etcd.yml</code></a> 剧本使用的操作标志参数。</p><p>相关参数定义于 <a href=https://github.com/pgsty/pigsty/blob/main/roles/etcd/defaults/main.yml><code>roles/etcd/defaults/main.yml</code></a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#etcd_seq: 1                      # etcd 实例标识符，需要显式指定（必填）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># etcd 集群和组名称，默认为 etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_learner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># etcd 实例是否以 learner 模式运行？默认为 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/data/etcd            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># etcd 数据目录，默认为 /data/etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2379</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># etcd 客户端端口，默认为 2379</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_peer_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2380</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># etcd 对等端口，默认为 2380</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_init</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>new                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># etcd 初始集群状态，new 或 existing</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_election_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># etcd 选举超时，默认为 1000ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_heartbeat_interval</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># etcd 心跳间隔，默认为 100ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_root_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Etcd.Root    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># etcd root 用户密码，用于 RBAC 认证（请修改！）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=etcd_seq><code>etcd_seq</code></h3><p>参数名称： <code>etcd_seq</code>， 类型： <code>int</code>， 层次：<code>I</code></p><p>etcd 实例标号， 这是必选参数，必须为每一个 etcd 实例指定一个唯一的标号。</p><p>以下是一个3节点etcd集群的示例，分配了 1 ～ 3 三个标号。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># dcs service for postgres/patroni ha consensus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 1 node for testing, 3 or 5 for production</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># etcd_seq required</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># assign from 1 ~ n</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># use odd numbers</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># cluster level parameter override roles/etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># mark etcd cluster name etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># safeguard against purging</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=etcd_cluster><code>etcd_cluster</code></h3><p>参数名称： <code>etcd_cluster</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>etcd 集群 & 分组名称，默认值为硬编码值 <code>etcd</code>。</p><p>当您想要部署另外的 etcd 集群备用时，可以修改此参数并使用其他集群名。</p><h3 id=etcd_learner><code>etcd_learner</code></h3><p>参数名称： <code>etcd_learner</code>， 类型： <code>bool</code>， 层次：<code>I/A</code></p><p>是否以 learner 模式初始化 etcd 实例？默认值为 <code>false</code>。</p><p>当设置为 <code>true</code> 时，etcd 实例将以 learner（学习者）模式初始化，这意味着该实例不能在 etcd 集群中参与投票选举。</p><p><strong>使用场景</strong>：</p><ul><li><strong>集群扩容</strong>：向现有集群添加新成员时，使用 learner 模式可以避免在数据同步完成前影响集群的仲裁</li><li><strong>安全迁移</strong>：在滚动升级或迁移场景中，先以 learner 模式加入，确认数据同步完成后再提升</li></ul><p><strong>操作流程</strong>：</p><ol><li>设置 <code>etcd_learner: true</code>，以 learner 模式初始化新成员</li><li>等待数据同步完成（通过 <code>etcdctl endpoint status</code> 检查）</li><li>使用 <code>etcdctl member promote &lt;member_id></code> 将其提升为正式成员</li></ol><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>注意</div><p>Learner 实例不计入集群仲裁成员数。例如，3 节点集群中有 1 个 learner，实际投票成员数为 2，不能容忍任何节点故障。</p></div><h3 id=etcd_data><code>etcd_data</code></h3><p>参数名称： <code>etcd_data</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>etcd 数据目录，默认为<code>/data/etcd</code> 。</p><h3 id=etcd_port><code>etcd_port</code></h3><p>参数名称： <code>etcd_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p><p>etcd 客户端端口号，默认为<code>2379</code>。</p><h3 id=etcd_peer_port><code>etcd_peer_port</code></h3><p>参数名称： <code>etcd_peer_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p><p>etcd peer 端口，默认为 <code>2380</code> 。</p><h3 id=etcd_init><code>etcd_init</code></h3><p>参数名称： <code>etcd_init</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>etcd 初始集群状态，可以是 <code>new</code> 或 <code>existing</code>，默认值：<code>new</code>。</p><p><strong>可选值说明</strong>：</p><table class=full-width><thead><tr><th style=text-align:left>值</th><th style=text-align:left>说明</th><th style=text-align:left>使用场景</th></tr></thead><tbody><tr><td style=text-align:left><code>new</code></td><td style=text-align:left>创建新的 etcd 集群</td><td style=text-align:left>首次部署、集群重建</td></tr><tr><td style=text-align:left><code>existing</code></td><td style=text-align:left>加入现有 etcd 集群</td><td style=text-align:left>集群扩容、添加新成员</td></tr></tbody></table><p><strong>重要说明</strong>：</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>扩容时必须使用 existing</div><p>向现有 etcd 集群添加新成员时，<strong>必须</strong>设置 <code>etcd_init=existing</code>。否则新实例会尝试创建独立的新集群，导致脑裂或初始化失败。</p></div><p><strong>使用示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建新集群（默认行为）</span>
</span></span><span style=display:flex><span>./etcd.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 向现有集群添加新成员</span>
</span></span><span style=display:flex><span>./etcd.yml -l &lt;new_ip&gt; -e <span style=color:#000>etcd_init</span><span style=color:#ce5c00;font-weight:700>=</span>existing
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或使用便捷脚本（自动设置 etcd_init=existing）</span>
</span></span><span style=display:flex><span>bin/etcd-add &lt;new_ip&gt;
</span></span></code></pre></div><h3 id=etcd_election_timeout><code>etcd_election_timeout</code></h3><p>参数名称： <code>etcd_election_timeout</code>， 类型： <code>int</code>， 层次：<code>C</code></p><p>etcd 选举超时，默认为 <code>1000</code> (毫秒)，也就是 1 秒。</p><h3 id=etcd_heartbeat_interval><code>etcd_heartbeat_interval</code></h3><p>参数名称： <code>etcd_heartbeat_interval</code>， 类型： <code>int</code>， 层次：<code>C</code></p><p>etcd心跳间隔，默认为 <code>100</code> (毫秒)。</p><h3 id=etcd_root_password><code>etcd_root_password</code></h3><p>参数名称： <code>etcd_root_password</code>， 类型： <code>password</code>， 层次：<code>G</code></p><p>etcd root 用户密码，用于 RBAC 认证，默认值为 <code>Etcd.Root</code>。</p><p>Pigsty v4.0 默认启用 etcd 的 RBAC（基于角色的访问控制）认证机制。在集群初始化时，<code>etcd_auth</code> 任务会自动创建 root 用户并启用认证。</p><p><strong>密码存储位置</strong>：</p><ul><li>密码存储在 <code>/etc/etcd/etcd.pass</code> 文件中</li><li>文件权限为 <code>0640</code>（root 所有，etcd 组可读）</li><li>etcdctl 环境变量脚本 <code>/etc/profile.d/etcdctl.sh</code> 会自动读取此文件</li></ul><p><strong>与其他组件的配合</strong>：</p><ul><li>Patroni 通过 <a href=/docs/pgsql/param#pg_etcd_password><code>pg_etcd_password</code></a> 参数配置连接 etcd 的密码</li><li>如果 <code>pg_etcd_password</code> 为空，Patroni 会使用集群名称作为密码（不推荐）</li><li>VIP-Manager 也需要使用相同的认证信息连接 etcd</li></ul><p><strong>安全建议</strong>：</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>生产环境安全</div><p>在生产环境中，<strong>强烈建议修改默认密码</strong> <code>Etcd.Root</code>。可以在全局配置或集群配置中设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_root_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;YourSecurePassword&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用 <code>configure -g</code> 参数可以自动生成并替换 <code>etcd_root_password</code></p></div><hr><h2 id=etcd_remove><code>ETCD_REMOVE</code></h2><p>本节包含 <a href=https://github.com/pgsty/pigsty/blob/main/roles/etcd_remove/defaults/main.yml><code>etcd_remove</code></a> 角色的参数，
这些是 <a href=/docs/etcd/playbook#etcd-rmyml><code>etcd-rm.yml</code></a> 剧本使用的操作标志参数。</p><p>相关参数定义于 <a href=https://github.com/pgsty/pigsty/blob/main/roles/etcd_remove/defaults/main.yml><code>roles/etcd_remove/defaults/main.yml</code></a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 防误删保险，阻止移除正在运行的 etcd 实例？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_rm_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 移除时是否删除 etcd 数据和配置文件？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd_rm_pkg</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 移除时是否卸载 etcd 软件包？</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=etcd_safeguard><code>etcd_safeguard</code></h3><p>参数名称： <code>etcd_safeguard</code>， 类型： <code>bool</code>， 层次：<code>G/C/A</code></p><p>防误删保险参数，防止清除正在运行的 etcd 实例？默认值为 <code>false</code>。</p><p>如果启用安全保险，<a href=/docs/etcd/playbook#etcd-rmyml><code>etcd-rm.yml</code></a> 剧本会在执行开始时直接中止，从而避免意外删除正在使用的 etcd 集群。需要显式使用命令行参数 <code>-e etcd_safeguard=false</code> 才能覆盖。</p><p><strong>使用建议</strong>：</p><table class=full-width><thead><tr><th style=text-align:left>环境</th><th style=text-align:left>建议值</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>开发/测试</td><td style=text-align:left><code>false</code></td><td style=text-align:left>方便快速重建和测试</td></tr><tr><td style=text-align:left>生产环境</td><td style=text-align:left><code>true</code></td><td style=text-align:left>防止误操作导致服务中断</td></tr></tbody></table><p>紧急情况下，可以使用命令行参数覆盖配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd-rm.yml -e <span style=color:#000>etcd_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span></code></pre></div><h3 id=etcd_rm_data><code>etcd_rm_data</code></h3><p>参数名称： <code>etcd_rm_data</code>， 类型： <code>bool</code>， 层次：<code>G/C/A</code></p><p>移除时是否删除 etcd 数据和配置文件？默认值为 <code>true</code>。</p><p>启用此选项后，<a href=/docs/etcd/playbook#etcd-rmyml><code>etcd-rm.yml</code></a> 剧本在移除集群或成员时会同时删除以下内容：</p><ul><li><code>/etc/etcd/</code> - 配置目录（包括证书和密码文件）</li><li><code>/var/lib/etcd/</code> - 备用数据目录</li><li><code>{{ etcd_data }}</code> - 主数据目录（默认 <code>/data/etcd</code>）</li><li><code>{{ systemd_dir }}/etcd.service</code> - Systemd 服务单元文件</li><li><code>/etc/profile.d/etcdctl.sh</code> - 客户端环境变量脚本</li><li><code>/etc/vector/etcd.yaml</code> - Vector 日志采集配置</li></ul><p><strong>使用场景</strong>：</p><table class=full-width><thead><tr><th style=text-align:left>场景</th><th style=text-align:left>建议值</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>彻底移除</td><td style=text-align:left><code>true</code>（默认）</td><td style=text-align:left>完全清理，释放磁盘空间</td></tr><tr><td style=text-align:left>仅停止服务</td><td style=text-align:left><code>false</code></td><td style=text-align:left>保留数据，便于故障排查或恢复</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 仅停止服务，保留数据</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -e <span style=color:#000>etcd_rm_data</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span></code></pre></div><h3 id=etcd_rm_pkg><code>etcd_rm_pkg</code></h3><p>参数名称： <code>etcd_rm_pkg</code>， 类型： <code>bool</code>， 层次：<code>G/C/A</code></p><p>移除时是否卸载 etcd 软件包？默认值为 <code>false</code>。</p><p>启用此选项后，<a href=/docs/etcd/playbook#etcd-rmyml><code>etcd-rm.yml</code></a> 剧本在移除集群或成员时会同时卸载 etcd 软件包。</p><p><strong>使用场景</strong>：</p><table class=full-width><thead><tr><th style=text-align:left>场景</th><th style=text-align:left>建议值</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>常规移除</td><td style=text-align:left><code>false</code>（默认）</td><td style=text-align:left>保留软件包，便于快速重建</td></tr><tr><td style=text-align:left>彻底清理</td><td style=text-align:left><code>true</code></td><td style=text-align:left>完全卸载，节省磁盘空间</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 移除时同时卸载软件包</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -e <span style=color:#000>etcd_rm_pkg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>提示</div><p>通常不需要卸载 etcd 软件包。保留软件包可以加快后续的重新部署速度，因为不需要重新下载和安装。</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-e2a09cf50caf28a3c5a85194967a50bc>3 - 管理预案</h1><div class=lead>etcd 集群管理 SOP：创建，销毁，扩缩容，更新配置，RBAC 配置的详细说明。</div><p>以下是一些常见的 etcd 管理任务 SOP（预案）：</p><ul><li><a href=#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4>创建集群</a>：如何初始化 etcd 集群？</li><li><a href=#%E9%94%80%E6%AF%81%E9%9B%86%E7%BE%A4>销毁集群</a>：如何销毁 etcd 集群？</li><li><a href=#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F>环境变量</a>：如何配置 etcd 客户端，以访问 etcd 服务器集群？</li><li><a href=#rbac-%E8%AE%A4%E8%AF%81>RBAC 认证</a>：如何使用 etcd 的 RBAC 认证？</li><li><a href=#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE>重载配置</a>：如何更新客户端使用的 etcd 服务器成员列表？</li><li><a href=#%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98>添加成员</a>：如何向现有 etcd 集群添加新成员？</li><li><a href=#%E7%A7%BB%E9%99%A4%E6%88%90%E5%91%98>移除成员</a>：如何从 etcd 集群移除老成员？</li><li><a href=#%E4%BE%BF%E6%8D%B7%E8%84%9A%E6%9C%AC>便捷脚本</a>：使用 <code>bin/etcd-add</code> 和 <code>bin/etcd-rm</code> 简化操作</li></ul><p>更多问题请参考 <a href=/docs/etcd/faq/>FAQ：ETCD</a>。</p><hr><h2 id=创建集群>创建集群</h2><p>要创建一个集群，首先需要在 <a href=/docs/setup/config/><strong>配置清单</strong></a> 中定义 <code>etcd</code> 集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>执行 <a href=/docs/etcd/playbook#etcdyml><code>etcd.yml</code></a> 剧本即可。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml  <span style=color:#8f5902;font-style:italic># 初始化 etcd 集群</span>
</span></span></code></pre></div><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>架构变化：Pigsty v3.6+</div><p>自 Pigsty v3.6 起，<code>etcd.yml</code> 剧本专注于集群安装和成员添加，不再包含移除功能。所有移除操作请使用独立的 <code>etcd-rm.yml</code> 剧本。</p></div><p>对于已初始化的生产环境 etcd 集群，可以打开防误删保护 <a href=/docs/etcd/param#etcd_safeguard><code>etcd_safeguard</code></a>，避免误删现有的 etcd 实例。</p><hr><h2 id=销毁集群>销毁集群</h2><p>要销毁一个 etcd 集群，请使用独立的 <a href=/docs/etcd/playbook#etcd-rmyml><code>etcd-rm.yml</code></a> 剧本。执行此命令前请务必三思！</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd-rm.yml                         <span style=color:#8f5902;font-style:italic># 移除整个 etcd 集群</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -e <span style=color:#000>etcd_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> <span style=color:#8f5902;font-style:italic># 强制覆盖防误删保险</span>
</span></span></code></pre></div><p>或使用便捷脚本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/etcd-rm                           <span style=color:#8f5902;font-style:italic># 移除整个 etcd 集群</span>
</span></span></code></pre></div><p>移除剧本会尊重 <a href=/docs/etcd/param#etcd_safeguard><code>etcd_safeguard</code></a> 防误删保险的配置。如果该参数设置为 <code>true</code>，剧本将中止执行以防止误删。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>注意</div><p>在移除 etcd 集群之前，请确保没有 PostgreSQL 集群正在使用该 etcd 作为 DCS 服务。否则会导致 PostgreSQL 高可用功能失效。</p></div><hr><h2 id=环境变量>环境变量</h2><p>Pigsty 默认使用 etcd v3 API（v3.6+ 已移除 v2 API 支持）。Pigsty 会在 etcd 节点上自动配置环境变量脚本 <code>/etc/profile.d/etcdctl.sh</code>，登录后会自动加载。</p><p>以下是 etcd 客户端配置环境变量的示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>alias</span> <span style=color:#000>e</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;etcdctl&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>alias</span> <span style=color:#000>em</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;etcdctl member&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_ENDPOINTS</span><span style=color:#ce5c00;font-weight:700>=</span>https://10.10.10.10:2379
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_CACERT</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/etcd/ca.crt
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_CERT</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/etcd/server.crt
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_KEY</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/etcd/server.key
</span></span></code></pre></div><p>Pigsty v4.0 默认启用 RBAC 认证，因此还需要配置用户认证：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root:</span><span style=color:#204a87;font-weight:700>$(</span>cat /etc/etcd/etcd.pass<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span></code></pre></div><p>配置好客户端环境变量后，你可以使用以下命令进行 etcd CRUD 操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>e put a <span style=color:#0000cf;font-weight:700>10</span> <span style=color:#000;font-weight:700>;</span> e get a<span style=color:#000;font-weight:700>;</span> e del a   <span style=color:#8f5902;font-style:italic># 基本 KV 操作</span>
</span></span><span style=display:flex><span>e member list                    <span style=color:#8f5902;font-style:italic># 列出集群成员</span>
</span></span><span style=display:flex><span>e endpoint health                <span style=color:#8f5902;font-style:italic># 检查端点健康状态</span>
</span></span><span style=display:flex><span>e endpoint status                <span style=color:#8f5902;font-style:italic># 查看端点状态</span>
</span></span></code></pre></div><hr><h2 id=rbac-认证>RBAC 认证</h2><p>Pigsty v4.0 默认启用 etcd 的 RBAC（基于角色的访问控制）认证机制。在集群初始化时，<code>etcd_auth</code> 任务会自动创建 root 用户并启用认证。</p><p><strong>root 用户密码</strong>由 <a href=/docs/etcd/param#etcd_root_password><code>etcd_root_password</code></a> 参数指定，默认值为 <code>Etcd.Root</code>。密码存储在 <code>/etc/etcd/etcd.pass</code> 文件中，权限为 <code>0640</code>（root 所有，etcd 组可读）。</p><p><strong>在生产环境中，强烈建议修改默认密码</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_root_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;YourSecurePassword&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 修改默认密码</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>客户端认证方式</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 方式一：使用环境变量（推荐，已自动配置在 /etc/profile.d/etcdctl.sh）</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root:</span><span style=color:#204a87;font-weight:700>$(</span>cat /etc/etcd/etcd.pass<span style=color:#204a87;font-weight:700>)</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 方式二：在命令行中指定</span>
</span></span><span style=display:flex><span>etcdctl --user root:YourSecurePassword member list
</span></span></code></pre></div><hr><h2 id=重载配置>重载配置</h2><p>如果 etcd 集群的成员发生变化（添加或移除成员），我们需要刷新对 etcd 服务端点的引用。目前 Pigsty 中有以下几处 etcd 引用需要更新：</p><table class=full-width><thead><tr><th style=text-align:left>配置位置</th><th style=text-align:left>配置文件</th><th style=text-align:left>更新方式</th></tr></thead><tbody><tr><td style=text-align:left>etcd 成员配置</td><td style=text-align:left><code>/etc/etcd/etcd.conf</code></td><td style=text-align:left><code>./etcd.yml -t etcd_conf</code></td></tr><tr><td style=text-align:left>etcdctl 环境变量</td><td style=text-align:left><code>/etc/profile.d/etcdctl.sh</code></td><td style=text-align:left><code>./etcd.yml -t etcd_config</code></td></tr><tr><td style=text-align:left>Patroni DCS 配置</td><td style=text-align:left><code>/etc/patroni/patroni.yml</code></td><td style=text-align:left><code>./pgsql.yml -t pg_conf</code></td></tr><tr><td style=text-align:left>VIP-Manager 配置</td><td style=text-align:left><code>/etc/default/vip-manager.yml</code></td><td style=text-align:left><code>./pgsql.yml -t pg_vip_config</code></td></tr></tbody></table><p><strong>刷新 etcd 成员配置文件</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml -t etcd_conf                           <span style=color:#8f5902;font-style:italic># 刷新 /etc/etcd/etcd.conf</span>
</span></span><span style=display:flex><span>ansible etcd -f <span style=color:#0000cf;font-weight:700>1</span> -b -a <span style=color:#4e9a06>&#39;systemctl restart etcd&#39;</span>  <span style=color:#8f5902;font-style:italic># 可选：逐一重启 etcd 实例</span>
</span></span></code></pre></div><p><strong>刷新 etcdctl 客户端环境变量</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml -t etcd_config                         <span style=color:#8f5902;font-style:italic># 刷新 /etc/profile.d/etcdctl.sh</span>
</span></span></code></pre></div><p><strong>更新 Patroni DCS 端点配置</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_conf                            <span style=color:#8f5902;font-style:italic># 重新生成 patroni 配置</span>
</span></span><span style=display:flex><span>ansible all -f <span style=color:#0000cf;font-weight:700>1</span> -b -a <span style=color:#4e9a06>&#39;systemctl reload patroni&#39;</span> <span style=color:#8f5902;font-style:italic># 重新加载 patroni 配置</span>
</span></span></code></pre></div><p><strong>更新 VIP-Manager 端点配置</strong>（仅当使用 PGSQL L2 VIP 时需要）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_vip_config                           <span style=color:#8f5902;font-style:italic># 重新生成 vip-manager 配置</span>
</span></span><span style=display:flex><span>ansible all -f <span style=color:#0000cf;font-weight:700>1</span> -b -a <span style=color:#4e9a06>&#39;systemctl restart vip-manager&#39;</span> <span style=color:#8f5902;font-style:italic># 重启 vip-manager</span>
</span></span></code></pre></div><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>提示</div><p>使用 <code>bin/etcd-add</code> 和 <code>bin/etcd-rm</code> 便捷脚本时，脚本会在操作完成后提示您需要执行的配置刷新命令。</p></div><hr><h2 id=添加成员>添加成员</h2><p>ETCD 参考: <a href=https://etcd.io/docs/v3.6/op-guide/runtime-configuration/#add-a-new-member>添加成员</a></p><h3 id=推荐方式使用便捷脚本>推荐方式：使用便捷脚本</h3><p>使用 <code>bin/etcd-add</code> 脚本是向现有 etcd 集群添加新成员的<strong>推荐方式</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 首先在配置清单中添加新成员定义，然后执行：</span>
</span></span><span style=display:flex><span>bin/etcd-add &lt;ip&gt;              <span style=color:#8f5902;font-style:italic># 添加单个新成员</span>
</span></span><span style=display:flex><span>bin/etcd-add &lt;ip1&gt; &lt;ip2&gt; ...   <span style=color:#8f5902;font-style:italic># 添加多个新成员</span>
</span></span></code></pre></div><p>脚本会自动完成以下操作：</p><ul><li>验证 IP 地址有效性</li><li>执行 <code>etcd.yml</code> 剧本（自动设置 <code>etcd_init=existing</code>）</li><li>提供安全警告和倒计时</li><li>操作完成后提示配置刷新命令</li></ul><h3 id=手动方式分步操作>手动方式：分步操作</h3><p>向现有的 etcd 集群添加新成员需要以下步骤：</p><ol><li><strong>更新配置清单</strong>：将新实例添加到 <code>etcd</code> 组</li><li><strong>通知集群</strong>：执行 <code>etcdctl member add</code> 命令（可选，剧本会自动执行）</li><li><strong>初始化新成员</strong>：使用 <code>etcd_init=existing</code> 参数运行剧本</li><li><strong>提升成员</strong>：将学习者提升为正式成员（可选，使用 <code>etcd_learner=true</code> 时需要）</li><li><strong>重载配置</strong>：更新所有客户端的 etcd 端点引用</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 配置清单更新后，初始化新成员</span>
</span></span><span style=display:flex><span>./etcd.yml -l &lt;new_ins_ip&gt; -e <span style=color:#000>etcd_init</span><span style=color:#ce5c00;font-weight:700>=</span>existing
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 如果使用 learner 模式，需要手动提升</span>
</span></span><span style=display:flex><span>etcdctl member promote &lt;new_ins_server_id&gt;
</span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>重要</div><p>添加新成员时必须使用 <code>etcd_init=existing</code> 参数，否则新实例会尝试创建新集群而非加入现有集群。</p></div><details><summary>详细步骤：向etcd集群添加成员</summary><p>下面是具体操作的详细细节，让我们从一个单实例 etcd 集群开始：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 集群中原本存在的唯一实例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 将此新成员定义添加到清单中</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用便捷脚本添加新成员（推荐）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bin/etcd-add 10.10.10.11
</span></span></code></pre></div><p>或者手动操作。首先使用 <code>etcdctl member add</code> 向现有 etcd 集群宣告新的学习者实例 <code>etcd-2</code> 即将到来：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ etcdctl member add etcd-2 --learner<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --peer-urls<span style=color:#ce5c00;font-weight:700>=</span>https://10.10.10.11:2380
</span></span><span style=display:flex><span>Member 33631ba6ced84cf8 added to cluster 6646fbcf5debc68f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;etcd-2&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_INITIAL_CLUSTER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;etcd-2=https://10.10.10.11:2380,etcd-1=https://10.10.10.10:2380&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_INITIAL_ADVERTISE_PEER_URLS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;https://10.10.10.11:2380&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_INITIAL_CLUSTER_STATE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;existing&#34;</span>
</span></span></code></pre></div><p>使用 <code>etcdctl member list</code>（或 <code>em list</code>）检查成员列表，我们可以看到一个 <code>unstarted</code> 新成员：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>33631ba6ced84cf8, unstarted, , https://10.10.10.11:2380, , <span style=color:#204a87>true</span>       <span style=color:#8f5902;font-style:italic># 这里有一个未启动的新成员</span>
</span></span><span style=display:flex><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, <span style=color:#204a87>false</span>
</span></span></code></pre></div><p>接下来使用 <code>etcd.yml</code> 剧本初始化新的 etcd 实例 <code>etcd-2</code>，完成后，我们可以看到新成员已经启动：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./etcd.yml -l 10.10.10.11 -e <span style=color:#000>etcd_init</span><span style=color:#ce5c00;font-weight:700>=</span>existing    <span style=color:#8f5902;font-style:italic># 一定要添加 existing 参数</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>33631ba6ced84cf8, started, etcd-2, https://10.10.10.11:2380, https://10.10.10.11:2379, <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, <span style=color:#204a87>false</span>
</span></span></code></pre></div><p>新成员初始化完成并稳定运行后，可以将新成员从学习者提升为追随者：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ etcdctl member promote 33631ba6ced84cf8   <span style=color:#8f5902;font-style:italic># 将学习者提升为追随者</span>
</span></span><span style=display:flex><span>Member 33631ba6ced84cf8 promoted in cluster 6646fbcf5debc68f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ em list                <span style=color:#8f5902;font-style:italic># 再次检查，新成员已提升为正式成员</span>
</span></span><span style=display:flex><span>33631ba6ced84cf8, started, etcd-2, https://10.10.10.11:2380, https://10.10.10.11:2379, <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, <span style=color:#204a87>false</span>
</span></span></code></pre></div><p>新成员添加完成，请不要忘记 <a href=#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE>重载配置</a> ，让所有客户端也知道新成员的存在。</p><p>重复以上步骤，可以添加更多成员。记住，生产环境中至少要使用 3 个成员。</p></details><hr><h2 id=移除成员>移除成员</h2><h3 id=推荐方式使用便捷脚本-1>推荐方式：使用便捷脚本</h3><p>使用 <code>bin/etcd-rm</code> 脚本是从 etcd 集群移除成员的<strong>推荐方式</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/etcd-rm &lt;ip&gt;              <span style=color:#8f5902;font-style:italic># 移除指定成员</span>
</span></span><span style=display:flex><span>bin/etcd-rm &lt;ip1&gt; &lt;ip2&gt; ...   <span style=color:#8f5902;font-style:italic># 移除多个成员</span>
</span></span><span style=display:flex><span>bin/etcd-rm                   <span style=color:#8f5902;font-style:italic># 移除整个 etcd 集群</span>
</span></span></code></pre></div><p>脚本会自动完成以下操作：</p><ul><li>从集群中优雅地移除成员</li><li>停止并禁用 etcd 服务</li><li>清理数据和配置文件</li><li>从监控系统中注销</li></ul><h3 id=手动方式分步操作-1>手动方式：分步操作</h3><p>要从 etcd 集群中删除一个成员实例，通常需要以下步骤：</p><ol><li><strong>从配置清单中移除</strong>：注释或删除该实例，并 <a href=#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE>重载配置</a></li><li><strong>从集群中踢除</strong>：使用 <code>etcdctl member remove</code> 命令</li><li><strong>清理实例</strong>：使用 <code>etcd-rm.yml</code> 剧本清理实例</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用专用移除剧本（推荐）</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -l &lt;ip&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或者手动操作</span>
</span></span><span style=display:flex><span>etcdctl member remove &lt;server_id&gt;      <span style=color:#8f5902;font-style:italic># 从集群中踢除</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -l &lt;ip&gt;                  <span style=color:#8f5902;font-style:italic># 清理实例</span>
</span></span></code></pre></div><details><summary>详细步骤：从etcd集群移除成员</summary><p>让我们以一个 3 节点的 etcd 集群为例，从中移除 3 号实例。</p><p><strong>方法一：使用便捷脚本（推荐）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bin/etcd-rm 10.10.10.12
</span></span></code></pre></div><p>脚本会自动完成所有操作，包括从集群中移除成员、停止服务、清理数据。</p><p><strong>方法二：手动操作</strong></p><p>首先，为了刷新配置，您需要 <strong>注释</strong> 待删除的成员，然后 <a href=#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE>重载配置</a>，让所有客户端都不要再使用此实例。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 10.10.10.12: { etcd_seq: 3 }   # &lt;---- 注释掉这个成员</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>然后，使用移除剧本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./etcd-rm.yml -l 10.10.10.12
</span></span></code></pre></div><p>剧本会自动执行以下操作：</p><ol><li>获取成员列表并找到对应的成员 ID</li><li>执行 <code>etcdctl member remove</code> 从集群中踢除</li><li>停止 etcd 服务</li><li>清理数据和配置文件</li></ol><p>如果需要手动操作，可以这样做：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ etcdctl member list
</span></span><span style=display:flex><span>429ee12c7fbab5c1, started, etcd-1, https://10.10.10.10:2380, https://10.10.10.10:2379, <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>33631ba6ced84cf8, started, etcd-2, https://10.10.10.11:2380, https://10.10.10.11:2379, <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>93fcf23b220473fb, started, etcd-3, https://10.10.10.12:2380, https://10.10.10.12:2379, <span style=color:#204a87>false</span>  <span style=color:#8f5902;font-style:italic># &lt;--- 移除这个</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ etcdctl member remove 93fcf23b220473fb  <span style=color:#8f5902;font-style:italic># 从集群中踢除</span>
</span></span><span style=display:flex><span>Member 93fcf23b220473fb removed from cluster 6646fbcf5debc68f
</span></span></code></pre></div><p>执行完毕后，您可以将其从配置清单中永久删除，移除成员至此完成。</p><p>重复以上步骤，可以移除更多成员，与 <a href=#%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98>添加成员</a> 配合使用，可以对 etcd 集群进行滚动升级搬迁。</p></details><hr><h2 id=便捷脚本>便捷脚本</h2><p>Pigsty v3.6+ 提供了便捷脚本简化 etcd 集群的扩容和缩容操作：</p><h3 id=binetcd-add><code>bin/etcd-add</code></h3><p>向现有 etcd 集群添加新成员：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/etcd-add &lt;ip&gt;              <span style=color:#8f5902;font-style:italic># 添加单个新成员</span>
</span></span><span style=display:flex><span>bin/etcd-add &lt;ip1&gt; &lt;ip2&gt; ...   <span style=color:#8f5902;font-style:italic># 添加多个新成员</span>
</span></span></code></pre></div><p>脚本功能：</p><ul><li>验证 IP 地址格式</li><li>自动设置 <code>etcd_init=existing</code> 参数</li><li>执行 <code>etcd.yml</code> 剧本完成成员添加</li><li>操作完成后提示配置刷新命令</li></ul><h3 id=binetcd-rm><code>bin/etcd-rm</code></h3><p>从 etcd 集群移除成员或整个集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/etcd-rm &lt;ip&gt;              <span style=color:#8f5902;font-style:italic># 移除指定成员</span>
</span></span><span style=display:flex><span>bin/etcd-rm &lt;ip1&gt; &lt;ip2&gt; ...   <span style=color:#8f5902;font-style:italic># 移除多个成员</span>
</span></span><span style=display:flex><span>bin/etcd-rm                   <span style=color:#8f5902;font-style:italic># 移除整个 etcd 集群</span>
</span></span></code></pre></div><p>脚本功能：</p><ul><li>提供安全警告和确认倒计时</li><li>自动执行 <code>etcd-rm.yml</code> 剧本</li><li>优雅地从集群中移除成员</li><li>清理数据和配置文件</li></ul><hr><h2 id=管理-etcd-密码>管理 Etcd 密码</h2><p><a href=/docs/etcd/param#etcd_root_password><strong><code>etcd_root_password</code></strong></a> 参数定义了 etcd 集群的 root 用户密码。</p><p>要修改此密码，你需要访问到 etcd 端点，例如在 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a> 与 <a href=/docs/concept/arch/node#etcd%E8%8A%82%E7%82%B9><strong>ETCD节点</strong></a> 上使用 <a href=/docs/deploy/admin><strong>管理用户</strong></a> 执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>e user passwd root  <span style=color:#8f5902;font-style:italic># 修改 etcd root 用户密码</span>
</span></span></code></pre></div><p>然后你应该刷新所有对 etcd root 密码的引用，包括 INFRA 节点上的 Patroni 客户端配置与 etcdctl 客户端环境变量：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t env_patroni    <span style=color:#8f5902;font-style:italic># 刷新 /infra/conf/patronictl.yml 对 etcd root 密码的引用</span>
</span></span><span style=display:flex><span>./etcd.yml  -t etcd_conf      <span style=color:#8f5902;font-style:italic># 刷新 /etc/etcd/etcd.pass 与 /etc/profile.d/etcdctl.sh</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f7e866452f3057b5647d06b72632819e>4 - 预置剧本</h1><div class=lead>如何使用预置的 ansible 剧本来管理 Etcd 集群，常用管理命令速查。</div><p>Etcd 模块提供了两个核心剧本：<a href=#etcdyml><code>etcd.yml</code></a> 用于安装与配置 Etcd 集群，<a href=#etcd-rmyml><code>etcd-rm.yml</code></a> 用于移除 Etcd 集群或成员。</p><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>架构变化：Pigsty v3.6+</div><p>自 Pigsty v3.6 起，<code>etcd.yml</code> 剧本专注于集群安装和成员添加，所有移除操作已迁移至独立的 <code>etcd-rm.yml</code> 剧本和 <code>etcd_remove</code> 角色。</p></div><hr><h2 id=etcdyml><code>etcd.yml</code></h2><p>剧本原始文件：<a href=https://github.com/pgsty/pigsty/blob/main/etcd.yml><code>etcd.yml</code></a></p><p>执行本剧本，将会在硬编码的固定分组 <code>etcd</code> 上安装配置 Etcd 集群，并启动 etcd 服务。</p><p>在 <a href=https://github.com/pgsty/pigsty/blob/main/etcd.yml><code>etcd.yml</code></a> 中，提供了以下是可用的任务子集：</p><ul><li><code>etcd_assert</code> ：验证 etcd 身份参数（<code>etcd_seq</code> 必须定义且为非负整数）</li><li><code>etcd_install</code> ：安装 etcd 软件包</li><li><code>etcd_dir</code> ：创建 etcd 数据和配置目录</li><li><code>etcd_config</code> ：生成 etcd 配置<ul><li><code>etcd_conf</code> ：生成 etcd 主配置文件 <code>/etc/etcd/etcd.conf</code></li><li><code>etcd_cert</code> ：生成 etcd TLS 证书（CA、服务器证书、私钥）</li></ul></li><li><code>etcd_member</code> ：将新成员添加到现有集群（仅当 <code>etcd_init=existing</code> 时执行）</li><li><code>etcd_launch</code> ：启动 etcd 服务</li><li><code>etcd_auth</code> ：启用 RBAC 认证（创建 root 用户并启用认证）</li><li><code>etcd_register</code> ：将 etcd 注册到 VictoriaMetrics/Prometheus 监控</li></ul><hr><h2 id=etcd-rmyml><code>etcd-rm.yml</code></h2><p>剧本原始文件：<a href=https://github.com/pgsty/pigsty/blob/main/etcd-rm.yml><code>etcd-rm.yml</code></a></p><p>用于移除 Etcd 集群或单个成员的专用剧本。在 <a href=https://github.com/pgsty/pigsty/blob/main/etcd-rm.yml><code>etcd-rm.yml</code></a> 中，提供了以下可用的任务子集：</p><ul><li><code>etcd_safeguard</code> ：检查防误删保险，如果启用则中止执行</li><li><code>etcd_pause</code> ：暂停 3 秒，允许用户使用 Ctrl-C 中止执行</li><li><code>etcd_deregister</code> ：从 VictoriaMetrics 监控目标中移除 etcd 注册</li><li><code>etcd_leave</code> ：在清理前尝试优雅地离开 etcd 集群</li><li><code>etcd_svc</code> ：使用 systemd 停止并禁用 etcd 服务</li><li><code>etcd_data</code> ：移除 etcd 数据（可通过 <code>etcd_rm_data=false</code> 禁用）</li><li><code>etcd_pkg</code> ：卸载 etcd 软件包（需通过 <code>etcd_rm_pkg=true</code> 显式启用）</li></ul><p>移除剧本使用 <a href=https://github.com/pgsty/pigsty/blob/main/roles/etcd_remove><code>etcd_remove</code></a> 角色，支持以下可配置参数：</p><ul><li><a href=/docs/etcd/param#etcd_safeguard><code>etcd_safeguard</code></a>：设置为 <code>true</code> 时阻止意外移除</li><li><a href=/docs/etcd/param#etcd_rm_data><code>etcd_rm_data</code></a>：控制是否删除 ETCD 数据（默认：<code>true</code>）</li><li><a href=/docs/etcd/param#etcd_rm_pkg><code>etcd_rm_pkg</code></a>：控制是否卸载 ETCD 软件包（默认：<code>false</code>）</li></ul><hr><h2 id=执行演示>执行演示</h2><p><a href=https://asciinema.org/a/566414><img src=https://asciinema.org/a/566414.svg alt=asciicast></a></p><hr><h2 id=命令速查>命令速查</h2><p><strong>Etcd 安装与配置：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml                                      <span style=color:#8f5902;font-style:italic># 初始化 etcd 集群</span>
</span></span><span style=display:flex><span>./etcd.yml -t etcd_launch                       <span style=color:#8f5902;font-style:italic># 重启整个 etcd 集群</span>
</span></span><span style=display:flex><span>./etcd.yml -t etcd_conf                         <span style=color:#8f5902;font-style:italic># 使用最新状态刷新 /etc/etcd/etcd.conf</span>
</span></span><span style=display:flex><span>./etcd.yml -t etcd_cert                         <span style=color:#8f5902;font-style:italic># 重新生成 etcd TLS 证书</span>
</span></span><span style=display:flex><span>./etcd.yml -l 10.10.10.12 -e <span style=color:#000>etcd_init</span><span style=color:#ce5c00;font-weight:700>=</span>existing <span style=color:#8f5902;font-style:italic># 扩容节点：添加新成员到现有集群</span>
</span></span></code></pre></div><p><strong>Etcd 移除与清理：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd-rm.yml                                   <span style=color:#8f5902;font-style:italic># 移除整个 etcd 集群</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -l 10.10.10.12                    <span style=color:#8f5902;font-style:italic># 移除单个 etcd 成员</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -e <span style=color:#000>etcd_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>           <span style=color:#8f5902;font-style:italic># 覆盖防误删保险强制移除</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -e <span style=color:#000>etcd_rm_data</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>             <span style=color:#8f5902;font-style:italic># 仅停止服务，保留数据</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -e <span style=color:#000>etcd_rm_pkg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>               <span style=color:#8f5902;font-style:italic># 同时卸载 etcd 软件包</span>
</span></span></code></pre></div><p><strong>便捷脚本：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/etcd-add &lt;ip&gt;                               <span style=color:#8f5902;font-style:italic># 向现有集群添加新成员（推荐）</span>
</span></span><span style=display:flex><span>bin/etcd-rm &lt;ip&gt;                                <span style=color:#8f5902;font-style:italic># 从集群中移除指定成员（推荐）</span>
</span></span><span style=display:flex><span>bin/etcd-rm                                     <span style=color:#8f5902;font-style:italic># 移除整个 etcd 集群</span>
</span></span></code></pre></div><hr><h2 id=保护机制>保护机制</h2><p>出于防止误删的目的，Pigsty 的 ETCD 模块提供了防误删保险，由 <a href=/docs/etcd/param#etcd_safeguard><code>etcd_safeguard</code></a> 参数控制，默认为 <code>false</code>，即默认不打开防误删保护。</p><p>对于生产环境已经初始化好的 etcd 集群，建议打开防误删保护，避免误删现有的 etcd 实例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 打开防误删保护</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>当 <code>etcd_safeguard</code> 设置为 <code>true</code> 时，<code>etcd-rm.yml</code> 剧本会检测到存活的 etcd 实例并主动中止，避免误删。您可以使用命令行参数来覆盖这一行为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd-rm.yml -e <span style=color:#000>etcd_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>  <span style=color:#8f5902;font-style:italic># 强制覆盖防误删保险</span>
</span></span></code></pre></div><p>除非您清楚地知道自己在做什么，我们并不建议用户随意清理 Etcd 集群。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e584a5e6bb1de156a6ab3580a5451148>5 - 监控告警</h1><div class=lead>etcd 监控面板，指标，以及告警规则。</div><hr><h2 id=监控面板>监控面板</h2><p>ETCD 模块提供了一个监控面板：Etcd Overview。</p><h3 id=etcd-overview-dashboard>ETCD Overview Dashboard</h3><p><a href=https://demo.pigsty.cc/d/etcd-overview>ETCD Overview</a>：ETCD 集群概览</p><p>这个监控面板提供了 ETCD 状态的关键信息：最值得关注的是 ETCD Aliveness，它显示了 ETCD 集群整体的服务状态。</p><p>红色的条带标识着实例不可用的时间段，而底下蓝灰色的条带标识着整个集群处于不可用的时间段。</p><p><a href=https://demo.pigsty.cc/d/etcd-overview><img src=/img/dashboard/etcd-overview.jpg alt=etcd-overview.jpg></a></p><hr><h2 id=告警规则>告警规则</h2><p>Pigsty 针对 Etcd 提供了以下五条预置告警规则，定义于 <a href=https://github.com/pgsty/pigsty/blob/main/files/victoria/rules/etcd.yml><code>files/victoria/rules/etcd.yml</code></a></p><ul><li><code>EtcdServerDown</code>：Etcd 节点宕机，严重警报</li><li><code>EtcdNoLeader</code>：Etcd 集群没有领导者，严重警报</li><li><code>EtcdQuotaFull</code>：Etcd 配额使用超过 90%，警告</li><li><code>EtcdNetworkPeerRTSlow</code>：Etcd 网络时延缓慢，提醒</li><li><code>EtcdWalFsyncSlow</code>：Etcd 磁盘刷盘缓慢，提醒</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                         Aliveness                            #</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># etcd server instance down</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>alert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>EtcdServerDown</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd_up &lt; 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>level: 0, severity: CRIT, category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>summary</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;CRIT EtcdServerDown {{ $labels.ins }}@{{ $labels.instance }}&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      etcd_up[ins={{ $labels.ins }}, instance={{ $labels.instance }}] = {{ $value }} &lt; 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      /ui/d/etcd-overview</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                         Error                                #</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Etcd no Leader triggers a P0 alert immediately</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># if dcs_failsafe mode is not enabled, this may lead to global outage</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>alert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>EtcdNoLeader</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>min(etcd_server_has_leader) by (cls) &lt; 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>15s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>level: 0, severity: CRIT, category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>summary</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;CRIT EtcdNoLeader: {{ $labels.cls }} {{ $value }}&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      etcd_server_has_leader[cls={{ $labels.cls }}] = {{ $value }} &lt; 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      /ui/d/etcd-overview?from=now-5m&amp;to=now&amp;var-cls={{$labels.cls}}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                        Saturation                            #</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>alert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>EtcdQuotaFull</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd:cls:quota_usage &gt; 0.90</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>level: 1, severity: WARN, category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>summary</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;WARN EtcdQuotaFull: {{ $labels.cls }}&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      etcd:cls:quota_usage[cls={{ $labels.cls }}] = {{ $value | printf &#34;%.3f&#34; }} &gt; 90%</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                         Latency                              #</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># etcd network peer rt p95 &gt; 200ms for 1m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>alert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>EtcdNetworkPeerRTSlow</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd:ins:network_peer_rt_p95_5m &gt; 0.200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>level: 2, severity: INFO, category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>summary</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;INFO EtcdNetworkPeerRTSlow: {{ $labels.cls }} {{ $labels.ins }}&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      etcd:ins:network_peer_rt_p95_5m[cls={{ $labels.cls }}, ins={{ $labels.ins }}] = {{ $value }} &gt; 200ms
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      /ui/d/etcd-instance?from=now-10m&amp;to=now&amp;var-cls={{ $labels.cls }}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Etcd wal fsync rt p95 &gt; 50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>alert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>EtcdWalFsyncSlow</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd:ins:wal_fsync_rt_p95_5m &gt; 0.050</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>level: 2, severity: INFO, category</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>summary</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;INFO EtcdWalFsyncSlow: {{ $labels.cls }} {{ $labels.ins }}&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      etcd:ins:wal_fsync_rt_p95_5m[cls={{ $labels.cls }}, ins={{ $labels.ins }}] = {{ $value }} &gt; 50ms
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      /ui/d/etcd-instance?from=now-10m&amp;to=now&amp;var-cls={{ $labels.cls }}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-b4db80f8234d7db0cbf16b40530478bd>6 - 指标列表</h1><div class=lead>Pigsty ETCD 模块提供的完整监控指标列表与释义</div><p><a href=/docs/etcd><strong><code>ETCD</code></strong></a> 模块包含有 177 类可用监控指标。</p><table class=full-width><thead><tr><th>Metric Name</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody><tr><td>etcd:ins:backend_commit_rt_p95_5m</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd:ins:wal_fsync_rt_p95_5m</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd:ins:network_peer_rt_p95_5m</td><td>Unknown</td><td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_cluster_version</td><td>gauge</td><td><code>cls</code>, <code>cluster_version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Which version is running. 1 for &lsquo;cluster_version&rsquo; label with current cluster version</td></tr><tr><td>etcd_debugging_auth_revision</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The current revision of auth store.</td></tr><tr><td>etcd_debugging_disk_backend_commit_rebalance_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_disk_backend_commit_rebalance_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_disk_backend_commit_rebalance_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_disk_backend_commit_spill_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_disk_backend_commit_spill_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_disk_backend_commit_spill_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_disk_backend_commit_write_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_disk_backend_commit_write_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_disk_backend_commit_write_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_lease_granted_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of granted leases.</td></tr><tr><td>etcd_debugging_lease_renewed_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The number of renewed leases seen by the leader.</td></tr><tr><td>etcd_debugging_lease_revoked_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of revoked leases.</td></tr><tr><td>etcd_debugging_lease_ttl_total_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_lease_ttl_total_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_lease_ttl_total_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_compact_revision</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The revision of the last compaction in store.</td></tr><tr><td>etcd_debugging_mvcc_current_revision</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The current revision of store.</td></tr><tr><td>etcd_debugging_mvcc_db_compaction_keys_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of db keys compacted.</td></tr><tr><td>etcd_debugging_mvcc_db_compaction_last</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The unix time of the last db compaction. Resets to 0 on start.</td></tr><tr><td>etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_db_compaction_pause_duration_milliseconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_db_compaction_total_duration_milliseconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_db_compaction_total_duration_milliseconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_db_compaction_total_duration_milliseconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_events_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of events sent by this member.</td></tr><tr><td>etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_index_compaction_pause_duration_milliseconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_mvcc_keys_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of keys.</td></tr><tr><td>etcd_debugging_mvcc_pending_events_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of pending events to be sent.</td></tr><tr><td>etcd_debugging_mvcc_range_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of ranges seen by this member.</td></tr><tr><td>etcd_debugging_mvcc_slow_watcher_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of unsynced slow watchers.</td></tr><tr><td>etcd_debugging_mvcc_total_put_size_in_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total size of put kv pairs seen by this member.</td></tr><tr><td>etcd_debugging_mvcc_watch_stream_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of watch streams.</td></tr><tr><td>etcd_debugging_mvcc_watcher_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of watchers.</td></tr><tr><td>etcd_debugging_server_lease_expired_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of expired leases.</td></tr><tr><td>etcd_debugging_snap_save_marshalling_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_snap_save_marshalling_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_snap_save_marshalling_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_snap_save_total_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_snap_save_total_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_snap_save_total_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_debugging_store_expires_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of expired keys.</td></tr><tr><td>etcd_debugging_store_reads_total</td><td>counter</td><td><code>cls</code>, <code>action</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of reads action by (get/getRecursive), local to this member.</td></tr><tr><td>etcd_debugging_store_watch_requests_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of incoming watch requests (new or reestablished).</td></tr><tr><td>etcd_debugging_store_watchers</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Count of currently active watchers.</td></tr><tr><td>etcd_debugging_store_writes_total</td><td>counter</td><td><code>cls</code>, <code>action</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of writes (e.g. set/compareAndDelete) seen by this member.</td></tr><tr><td>etcd_disk_backend_commit_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_backend_commit_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_backend_commit_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_backend_defrag_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_backend_defrag_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_backend_defrag_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_backend_snapshot_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_backend_snapshot_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_backend_snapshot_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_defrag_inflight</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Whether or not defrag is active on the member. 1 means active, 0 means not.</td></tr><tr><td>etcd_disk_wal_fsync_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_wal_fsync_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_wal_fsync_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_disk_wal_write_bytes_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of bytes written in WAL.</td></tr><tr><td>etcd_grpc_proxy_cache_hits_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of cache hits</td></tr><tr><td>etcd_grpc_proxy_cache_keys_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of keys/ranges cached</td></tr><tr><td>etcd_grpc_proxy_cache_misses_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of cache misses</td></tr><tr><td>etcd_grpc_proxy_events_coalescing_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of events coalescing</td></tr><tr><td>etcd_grpc_proxy_watchers_coalescing_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of current watchers coalescing</td></tr><tr><td>etcd_mvcc_db_open_read_transactions</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The number of currently open read transactions</td></tr><tr><td>etcd_mvcc_db_total_size_in_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total size of the underlying database physically allocated in bytes.</td></tr><tr><td>etcd_mvcc_db_total_size_in_use_in_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total size of the underlying database logically in use in bytes.</td></tr><tr><td>etcd_mvcc_delete_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of deletes seen by this member.</td></tr><tr><td>etcd_mvcc_hash_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_mvcc_hash_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_mvcc_hash_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_mvcc_hash_rev_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_mvcc_hash_rev_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_mvcc_hash_rev_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_mvcc_put_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of puts seen by this member.</td></tr><tr><td>etcd_mvcc_range_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of ranges seen by this member.</td></tr><tr><td>etcd_mvcc_txn_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of txns seen by this member.</td></tr><tr><td>etcd_network_active_peers</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>Local</code>, <code>instance</code>, <code>job</code>, <code>ip</code>, <code>Remote</code></td><td>The current number of active peer connections.</td></tr><tr><td>etcd_network_client_grpc_received_bytes_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of bytes received from grpc clients.</td></tr><tr><td>etcd_network_client_grpc_sent_bytes_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of bytes sent to grpc clients.</td></tr><tr><td>etcd_network_peer_received_bytes_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code>, <code>From</code></td><td>The total number of bytes received from peers.</td></tr><tr><td>etcd_network_peer_round_trip_time_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_network_peer_round_trip_time_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_network_peer_round_trip_time_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_network_peer_sent_bytes_total</td><td>counter</td><td><code>cls</code>, <code>To</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of bytes sent to peers.</td></tr><tr><td>etcd_server_apply_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>success</code>, <code>ip</code>, <code>op</code></td><td>N/A</td></tr><tr><td>etcd_server_apply_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>success</code>, <code>ip</code>, <code>op</code></td><td>N/A</td></tr><tr><td>etcd_server_apply_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>success</code>, <code>ip</code>, <code>op</code></td><td>N/A</td></tr><tr><td>etcd_server_client_requests_total</td><td>counter</td><td><code>client_api_version</code>, <code>cls</code>, <code>ins</code>, <code>instance</code>, <code>type</code>, <code>job</code>, <code>ip</code></td><td>The total number of client requests per client version.</td></tr><tr><td>etcd_server_go_version</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>server_go_version</code>, <code>ip</code></td><td>Which Go version server is running with. 1 for &lsquo;server_go_version&rsquo; label with current version.</td></tr><tr><td>etcd_server_has_leader</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Whether or not a leader exists. 1 is existence, 0 is not.</td></tr><tr><td>etcd_server_health_failures</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of failed health checks</td></tr><tr><td>etcd_server_health_success</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of successful health checks</td></tr><tr><td>etcd_server_heartbeat_send_failures_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of leader heartbeat send failures (likely overloaded from slow disk).</td></tr><tr><td>etcd_server_id</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>server_id</code>, <code>ip</code></td><td>Server or member ID in hexadecimal format. 1 for &lsquo;server_id&rsquo; label with current ID.</td></tr><tr><td>etcd_server_is_leader</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Whether or not this member is a leader. 1 if is, 0 otherwise.</td></tr><tr><td>etcd_server_is_learner</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Whether or not this member is a learner. 1 if is, 0 otherwise.</td></tr><tr><td>etcd_server_leader_changes_seen_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The number of leader changes seen.</td></tr><tr><td>etcd_server_learner_promote_successes</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of successful learner promotions while this member is leader.</td></tr><tr><td>etcd_server_proposals_applied_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of consensus proposals applied.</td></tr><tr><td>etcd_server_proposals_committed_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of consensus proposals committed.</td></tr><tr><td>etcd_server_proposals_failed_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of failed proposals seen.</td></tr><tr><td>etcd_server_proposals_pending</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The current number of pending proposals to commit.</td></tr><tr><td>etcd_server_quota_backend_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Current backend storage quota size in bytes.</td></tr><tr><td>etcd_server_read_indexes_failed_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of failed read indexes seen.</td></tr><tr><td>etcd_server_slow_apply_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of slow apply requests (likely overloaded from slow disk).</td></tr><tr><td>etcd_server_slow_read_indexes_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The total number of pending read indexes not in sync with leader&rsquo;s or timed out read index requests.</td></tr><tr><td>etcd_server_snapshot_apply_in_progress_total</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>1 if the server is applying the incoming snapshot. 0 if none.</td></tr><tr><td>etcd_server_version</td><td>gauge</td><td><code>cls</code>, <code>server_version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Which version is running. 1 for &lsquo;server_version&rsquo; label with current version.</td></tr><tr><td>etcd_snap_db_fsync_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_snap_db_fsync_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_snap_db_fsync_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_snap_db_save_total_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_snap_db_save_total_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_snap_db_save_total_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_snap_fsync_duration_seconds_bucket</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>le</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_snap_fsync_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_snap_fsync_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>etcd_up</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>go_gc_duration_seconds</td><td>summary</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>quantile</code>, <code>job</code>, <code>ip</code></td><td>A summary of the pause duration of garbage collection cycles.</td></tr><tr><td>go_gc_duration_seconds_count</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>go_gc_duration_seconds_sum</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>go_goroutines</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of goroutines that currently exist.</td></tr><tr><td>go_info</td><td>gauge</td><td><code>cls</code>, <code>version</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Information about the Go environment.</td></tr><tr><td>go_memstats_alloc_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes allocated and still in use.</td></tr><tr><td>go_memstats_alloc_bytes_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of bytes allocated, even if freed.</td></tr><tr><td>go_memstats_buck_hash_sys_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes used by the profiling bucket hash table.</td></tr><tr><td>go_memstats_frees_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of frees.</td></tr><tr><td>go_memstats_gc_cpu_fraction</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The fraction of this program&rsquo;s available CPU time used by the GC since the program started.</td></tr><tr><td>go_memstats_gc_sys_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes used for garbage collection system metadata.</td></tr><tr><td>go_memstats_heap_alloc_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of heap bytes allocated and still in use.</td></tr><tr><td>go_memstats_heap_idle_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of heap bytes waiting to be used.</td></tr><tr><td>go_memstats_heap_inuse_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of heap bytes that are in use.</td></tr><tr><td>go_memstats_heap_objects</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of allocated objects.</td></tr><tr><td>go_memstats_heap_released_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of heap bytes released to OS.</td></tr><tr><td>go_memstats_heap_sys_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of heap bytes obtained from system.</td></tr><tr><td>go_memstats_last_gc_time_seconds</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of seconds since 1970 of last garbage collection.</td></tr><tr><td>go_memstats_lookups_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of pointer lookups.</td></tr><tr><td>go_memstats_mallocs_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total number of mallocs.</td></tr><tr><td>go_memstats_mcache_inuse_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes in use by mcache structures.</td></tr><tr><td>go_memstats_mcache_sys_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes used for mcache structures obtained from system.</td></tr><tr><td>go_memstats_mspan_inuse_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes in use by mspan structures.</td></tr><tr><td>go_memstats_mspan_sys_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes used for mspan structures obtained from system.</td></tr><tr><td>go_memstats_next_gc_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of heap bytes when next garbage collection will take place.</td></tr><tr><td>go_memstats_other_sys_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes used for other system allocations.</td></tr><tr><td>go_memstats_stack_inuse_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes in use by the stack allocator.</td></tr><tr><td>go_memstats_stack_sys_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes obtained from system for stack allocator.</td></tr><tr><td>go_memstats_sys_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of bytes obtained from system.</td></tr><tr><td>go_threads</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of OS threads created.</td></tr><tr><td>grpc_server_handled_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>grpc_code</code>, <code>job</code>, <code>grpc_method</code>, <code>grpc_type</code>, <code>ip</code>, <code>grpc_service</code></td><td>Total number of RPCs completed on the server, regardless of success or failure.</td></tr><tr><td>grpc_server_msg_received_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>grpc_type</code>, <code>grpc_method</code>, <code>ip</code>, <code>grpc_service</code></td><td>Total number of RPC stream messages received on the server.</td></tr><tr><td>grpc_server_msg_sent_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>grpc_type</code>, <code>grpc_method</code>, <code>ip</code>, <code>grpc_service</code></td><td>Total number of gRPC stream messages sent by the server.</td></tr><tr><td>grpc_server_started_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>grpc_type</code>, <code>grpc_method</code>, <code>ip</code>, <code>grpc_service</code></td><td>Total number of RPCs started on the server.</td></tr><tr><td>os_fd_limit</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The file descriptor limit.</td></tr><tr><td>os_fd_used</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>The number of used file descriptors.</td></tr><tr><td>process_cpu_seconds_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Total user and system CPU time spent in seconds.</td></tr><tr><td>process_max_fds</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Maximum number of open file descriptors.</td></tr><tr><td>process_open_fds</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Number of open file descriptors.</td></tr><tr><td>process_resident_memory_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Resident memory size in bytes.</td></tr><tr><td>process_start_time_seconds</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Start time of the process since unix epoch in seconds.</td></tr><tr><td>process_virtual_memory_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Virtual memory size in bytes.</td></tr><tr><td>process_virtual_memory_max_bytes</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Maximum amount of virtual memory available in bytes.</td></tr><tr><td>promhttp_metric_handler_requests_in_flight</td><td>gauge</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>Current number of scrapes being served.</td></tr><tr><td>promhttp_metric_handler_requests_total</td><td>counter</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code>, <code>code</code></td><td>Total number of scrapes by HTTP status code.</td></tr><tr><td>scrape_duration_seconds</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>scrape_samples_post_metric_relabeling</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>scrape_samples_scraped</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>scrape_series_added</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr><tr><td>up</td><td>Unknown</td><td><code>cls</code>, <code>ins</code>, <code>instance</code>, <code>job</code>, <code>ip</code></td><td>N/A</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-bfaeae9f961d15c2f4a30d7af548af0c>7 - 常见问题</h1><div class=lead>Pigsty etcd 模块常见问题答疑</div><hr><h2 id=etcd集群起什么作用>etcd集群起什么作用？</h2><p>etcd 是一个分布式的、可靠的键-值存储，用于存放系统中最为关键的数据，Pigsty 使用 etcd 作为 Patroni 的 DCS（分布式配置存储）服务，用于存储 PostgreSQL 集群的高可用状态信息。</p><p>Patroni 将通过 etcd，实现集群故障检测、自动故障转移、主从切换，集群配置管理等功能。</p><p>etcd 对于 PostgreSQL 集群的高可用至关重要，而 etcd 本身的可用性与容灾，是通过使用多个分布式的节点来保证的。</p><hr><h2 id=etcd集群使用多大规模合适>etcd集群使用多大规模合适？</h2><p>如果超过集群成员数一半（包括正好一半）的 etcd 实例不可用，那么 etcd 集群将进入不可用状态，拒绝对外提供服务。</p><p>例如：使用 3 节点的 etcd 集群允许最多一个节点宕机，而其他两个节点仍然可以正常工作；而使用 5 节点的 etcd 集群则可以容忍 2 节点失效。</p><p>请注意，etcd 集群中的 <strong>学习者</strong>（Learner）实例不计入成员数，因此在 3 节点 etcd 集群中，如果有一个学习者实例，那么实际上成员数量为 2，不能容忍任一节点失效。</p><p>在生产环境中，我们建议使用奇数个 etcd 实例，对于生产环境，建议使用 3 节点或 5 节点的 etcd 集群部署以确保足够的可靠性。</p><hr><h2 id=etcd集群不可用会有什么影响>etcd集群不可用会有什么影响？</h2><p>如果 etcd 集群不可用，那么会影响 PostgreSQL 的管控平面，但不会影响数据平面 —— 现有的 PostgreSQL 集群将继续运行，但通过 Patroni 进行的管理操作将无法执行。</p><p>etcd 故障期间，PostgreSQL 高可用将无法实现自动故障转移，您也无法使用 <code>patronictl</code> 对 PostgreSQL 集群发起管理操作，例如修改配置，执行手动故障转移等。
通过 Ansible 发起的管理命令不受 etcd 故障影响：例如创建数据库，创建用户，刷新 HBA 与 Service 配置等，etcd 故障期间，您依然可以直接操作 PostgreSQL 集群来实现这些功能。</p><p>请注意，以上描述的行为仅适用于较新版本的 Patroni (>=3.0，对应 Pigsty >= 2.0)。如果您使用的是较老版本的 Patroni (&lt;3.0，对应 Pigsty 版本为 1.x)，则 etcd / consul 故障会引发极为严重的全局性影响：
所有 PostgreSQL 集群将发生降级：主库将降级为从库，拒绝写请求，etcd 故障将放大为全局性 PostgreSQL 故障。在 Patroni 3.0 引入 DCS Failsafe 功能后，这种情况得到了显著改善。</p><hr><h2 id=etcd集群中存储着什么数据>etcd集群中存储着什么数据？</h2><p>在 Pigsty 中，etcd 仅用于 PostgreSQL 高可用，并不会用于存储任何其他配置或状态数据。</p><p>而 PG 高可用组件 Patroni 会自动生成并管理 etcd 中的数据，当这些数据在 etcd 中丢失时，Patroni 会自动重建。</p><p>因此默认情况下，Pigsty 中的 <strong>etcd</strong> 可以视作 “无状态服务”，可以进行销毁与重建，这为维护工作带来了极大的便利。</p><p>如果您将 etcd 用于其他目的，例如作为 Kubernetes 的元数据存储，或自行存储其他数据，那么您需要自行备份 etcd 数据，并在 etcd 集群恢复后进行数据恢复。</p><hr><h2 id=如何从etcd故障中恢复>如何从etcd故障中恢复？</h2><p>因为 Pigsty 中的 etcd 只用于 PostgreSQL 高可用，本质上是可销毁、可重建的 “无状态服务”，因此在出现故障时，您可以通过 “重启” / “重置” 来进行快速止血。</p><p>要 <strong>重启</strong> etcd 集群，您可以使用以下 Ansible 命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml -t etcd_launch
</span></span></code></pre></div><p>要 <strong>重置/重建</strong> etcd 集群，建议先清理再重建：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd-rm.yml  <span style=color:#8f5902;font-style:italic># 清理 etcd 集群（默认删除数据）</span>
</span></span><span style=display:flex><span>./etcd.yml     <span style=color:#8f5902;font-style:italic># 按清单重新部署 etcd 集群</span>
</span></span></code></pre></div><p>如果您自行使用 etcd 存储了其他数据，那么通常需要备份 etcd 数据，并在 etcd 集群恢复后进行数据恢复。</p><hr><h2 id=维护etcd有什么注意事项>维护etcd有什么注意事项？</h2><p>简单的版本是：<strong>不要写爆 etcd 就好</strong>。</p><p>Pigsty v2.6+ 默认启用了 etcd 自动压实（Auto Compact）和 16GB 的后端存储配额，通常无需担心写满 etcd 的问题。</p><p>etcd 的 <a href=https://etcd.io/docs/v3.5/learning/data_model/>数据模型</a> 使得每一次写入都会产生一个新的版本。
因此如果您的 etcd 集群频繁写入，即使只有极个别的 Key，etcd 数据库的大小也可能会不断增长。
当达到容量上限时，etcd 将会拒绝写入请求，这可能导致依赖 etcd 的 PostgreSQL 高可用机制无法正常工作。</p><p>Pigsty 默认的 etcd 配置已包含以下优化：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto-compaction-mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>periodic     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 周期性自动压缩</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto-compaction-retention</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;24h&#34;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 保留 24 小时历史</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>quota-backend-bytes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17179869184</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 16 GiB 配额</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>更多维护细节请阅读 etcd <a href=https://etcd.io/docs/v3.5/op-guide/maintenance/>官方文档维护指南</a>。</p><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>提示</div><p>对于 Pigsty v2.6 之前的版本，请参照下面的说明手动启用 etcd 自动垃圾回收。</p></div><hr><h2 id=如何启动etcd自动垃圾回收>如何启动etcd自动垃圾回收？</h2><p>如果您使用的早先版本的 Pigsty （v2.0 - v2.5），我们强烈建议您通过以下步骤，在生产环境中启用 etcd 的自动压实功能，从而避免 etcd 容量配额写满导致的 etcd 不可用故障。</p><p>在 Pigsty 源码目录中，编辑 etcd 配置文件模板：<a href=https://github.com/pgsty/pigsty/blob/main/roles/etcd/templates/etcd.conf#L29><code>roles/etcd/templates/etcd.conf</code></a>，添加以下三条配置项：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto-compaction-mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>periodic</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto-compaction-retention</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;24h&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>quota-backend-bytes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17179869184</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>然后将所有相关 PostgreSQL 集群设置为 <a href=/docs/pgsql/admin/patroni#%E6%9A%82%E5%81%9C%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2><strong>维护模式</strong></a> 后，重新使用 <code>./etcd.yml</code> 覆盖部署 etcd 集群即可。</p><p>该配置会将 etcd 默认的容量配额从 2 GiB 提高到 16 GiB，并确保只保留最近一天的写入历史版本，从而避免了 etcd 数据库大小的无限增长。</p><hr><h2 id=etcd中的postgresql高可用数据存储在哪里>etcd中的PostgreSQL高可用数据存储在哪里？</h2><p>默认情况下，Patroni 使用 <a href=/docs/pgsql/param#pg_namespace><strong><code>pg_namespace</code></strong></a> 指定的前缀（默认为 <code>/pg</code>）作为所有元数据键的前缀，随后是 PostgreSQL 集群名称。
例如，名为 <code>pg-meta</code> 的 PG 集群，其元数据键将存储在 <code>/pg/pg-meta</code> 下。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl get /pg/pg-meta --prefix
</span></span></code></pre></div><p>其中的数据样本如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/pg/pg-meta/config
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;ttl&#34;</span>:30,<span style=color:#4e9a06>&#34;loop_wait&#34;</span>:10,<span style=color:#4e9a06>&#34;retry_timeout&#34;</span>:10,<span style=color:#4e9a06>&#34;primary_start_timeout&#34;</span>:10,<span style=color:#4e9a06>&#34;maximum_lag_on_failover&#34;</span>:1048576,<span style=color:#4e9a06>&#34;maximum_lag_on_syncnode&#34;</span>:-1,<span style=color:#4e9a06>&#34;primary_stop_timeout&#34;</span>:30,<span style=color:#4e9a06>&#34;synchronous_mode&#34;</span>:false,<span style=color:#4e9a06>&#34;synchronous_mode_strict&#34;</span>:false,<span style=color:#4e9a06>&#34;failsafe_mode&#34;</span>:true,<span style=color:#4e9a06>&#34;pg_version&#34;</span>:16,<span style=color:#4e9a06>&#34;pg_cluster&#34;</span>:<span style=color:#4e9a06>&#34;pg-meta&#34;</span>,<span style=color:#4e9a06>&#34;pg_shard&#34;</span>:<span style=color:#4e9a06>&#34;pg-meta&#34;</span>,<span style=color:#4e9a06>&#34;pg_group&#34;</span>:0,<span style=color:#4e9a06>&#34;postgresql&#34;</span>:<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;use_slots&#34;</span>:true,<span style=color:#4e9a06>&#34;use_pg_rewind&#34;</span>:true,<span style=color:#4e9a06>&#34;remove_data_directory_on_rewind_failure&#34;</span>:true,<span style=color:#4e9a06>&#34;parameters&#34;</span>:<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;max_connections&#34;</span>:100,<span style=color:#4e9a06>&#34;superuser_reserved_connections&#34;</span>:10,<span style=color:#4e9a06>&#34;max_locks_per_transaction&#34;</span>:200,<span style=color:#4e9a06>&#34;max_prepared_transactions&#34;</span>:0,<span style=color:#4e9a06>&#34;track_commit_timestamp&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;wal_level&#34;</span>:<span style=color:#4e9a06>&#34;logical&#34;</span>,<span style=color:#4e9a06>&#34;wal_log_hints&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;max_worker_processes&#34;</span>:16,<span style=color:#4e9a06>&#34;max_wal_senders&#34;</span>:50,<span style=color:#4e9a06>&#34;max_replication_slots&#34;</span>:50,<span style=color:#4e9a06>&#34;password_encryption&#34;</span>:<span style=color:#4e9a06>&#34;scram-sha-256&#34;</span>,<span style=color:#4e9a06>&#34;ssl&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;ssl_cert_file&#34;</span>:<span style=color:#4e9a06>&#34;/pg/cert/server.crt&#34;</span>,<span style=color:#4e9a06>&#34;ssl_key_file&#34;</span>:<span style=color:#4e9a06>&#34;/pg/cert/server.key&#34;</span>,<span style=color:#4e9a06>&#34;ssl_ca_file&#34;</span>:<span style=color:#4e9a06>&#34;/pg/cert/ca.crt&#34;</span>,<span style=color:#4e9a06>&#34;shared_buffers&#34;</span>:<span style=color:#4e9a06>&#34;7969MB&#34;</span>,<span style=color:#4e9a06>&#34;maintenance_work_mem&#34;</span>:<span style=color:#4e9a06>&#34;1993MB&#34;</span>,<span style=color:#4e9a06>&#34;work_mem&#34;</span>:<span style=color:#4e9a06>&#34;79MB&#34;</span>,<span style=color:#4e9a06>&#34;max_parallel_workers&#34;</span>:8,<span style=color:#4e9a06>&#34;max_parallel_maintenance_workers&#34;</span>:2,<span style=color:#4e9a06>&#34;max_parallel_workers_per_gather&#34;</span>:0,<span style=color:#4e9a06>&#34;hash_mem_multiplier&#34;</span>:8.0,<span style=color:#4e9a06>&#34;huge_pages&#34;</span>:<span style=color:#4e9a06>&#34;try&#34;</span>,<span style=color:#4e9a06>&#34;temp_file_limit&#34;</span>:<span style=color:#4e9a06>&#34;7GB&#34;</span>,<span style=color:#4e9a06>&#34;vacuum_cost_delay&#34;</span>:<span style=color:#4e9a06>&#34;20ms&#34;</span>,<span style=color:#4e9a06>&#34;vacuum_cost_limit&#34;</span>:2000,<span style=color:#4e9a06>&#34;bgwriter_delay&#34;</span>:<span style=color:#4e9a06>&#34;10ms&#34;</span>,<span style=color:#4e9a06>&#34;bgwriter_lru_maxpages&#34;</span>:800,<span style=color:#4e9a06>&#34;bgwriter_lru_multiplier&#34;</span>:5.0,<span style=color:#4e9a06>&#34;min_wal_size&#34;</span>:<span style=color:#4e9a06>&#34;7GB&#34;</span>,<span style=color:#4e9a06>&#34;max_wal_size&#34;</span>:<span style=color:#4e9a06>&#34;28GB&#34;</span>,<span style=color:#4e9a06>&#34;max_slot_wal_keep_size&#34;</span>:<span style=color:#4e9a06>&#34;42GB&#34;</span>,<span style=color:#4e9a06>&#34;wal_buffers&#34;</span>:<span style=color:#4e9a06>&#34;16MB&#34;</span>,<span style=color:#4e9a06>&#34;wal_writer_delay&#34;</span>:<span style=color:#4e9a06>&#34;20ms&#34;</span>,<span style=color:#4e9a06>&#34;wal_writer_flush_after&#34;</span>:<span style=color:#4e9a06>&#34;1MB&#34;</span>,<span style=color:#4e9a06>&#34;commit_delay&#34;</span>:20,<span style=color:#4e9a06>&#34;commit_siblings&#34;</span>:10,<span style=color:#4e9a06>&#34;checkpoint_timeout&#34;</span>:<span style=color:#4e9a06>&#34;15min&#34;</span>,<span style=color:#4e9a06>&#34;checkpoint_completion_target&#34;</span>:0.8,<span style=color:#4e9a06>&#34;archive_mode&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;archive_timeout&#34;</span>:300,<span style=color:#4e9a06>&#34;archive_command&#34;</span>:<span style=color:#4e9a06>&#34;pgbackrest --stanza=pg-meta archive-push %p&#34;</span>,<span style=color:#4e9a06>&#34;max_standby_archive_delay&#34;</span>:<span style=color:#4e9a06>&#34;10min&#34;</span>,<span style=color:#4e9a06>&#34;max_standby_streaming_delay&#34;</span>:<span style=color:#4e9a06>&#34;3min&#34;</span>,<span style=color:#4e9a06>&#34;wal_receiver_status_interval&#34;</span>:<span style=color:#4e9a06>&#34;1s&#34;</span>,<span style=color:#4e9a06>&#34;hot_standby_feedback&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;wal_receiver_timeout&#34;</span>:<span style=color:#4e9a06>&#34;60s&#34;</span>,<span style=color:#4e9a06>&#34;max_logical_replication_workers&#34;</span>:8,<span style=color:#4e9a06>&#34;max_sync_workers_per_subscription&#34;</span>:6,<span style=color:#4e9a06>&#34;random_page_cost&#34;</span>:1.1,<span style=color:#4e9a06>&#34;effective_io_concurrency&#34;</span>:1000,<span style=color:#4e9a06>&#34;effective_cache_size&#34;</span>:<span style=color:#4e9a06>&#34;23907MB&#34;</span>,<span style=color:#4e9a06>&#34;default_statistics_target&#34;</span>:200,<span style=color:#4e9a06>&#34;log_destination&#34;</span>:<span style=color:#4e9a06>&#34;csvlog&#34;</span>,<span style=color:#4e9a06>&#34;logging_collector&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;log_directory&#34;</span>:<span style=color:#4e9a06>&#34;/pg/log/postgres&#34;</span>,<span style=color:#4e9a06>&#34;log_filename&#34;</span>:<span style=color:#4e9a06>&#34;postgresql-%Y-%m-%d.log&#34;</span>,<span style=color:#4e9a06>&#34;log_checkpoints&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;log_lock_waits&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;log_replication_commands&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;log_statement&#34;</span>:<span style=color:#4e9a06>&#34;ddl&#34;</span>,<span style=color:#4e9a06>&#34;log_min_duration_statement&#34;</span>:100,<span style=color:#4e9a06>&#34;track_io_timing&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;track_functions&#34;</span>:<span style=color:#4e9a06>&#34;all&#34;</span>,<span style=color:#4e9a06>&#34;track_activity_query_size&#34;</span>:8192,<span style=color:#4e9a06>&#34;log_autovacuum_min_duration&#34;</span>:<span style=color:#4e9a06>&#34;1s&#34;</span>,<span style=color:#4e9a06>&#34;autovacuum_max_workers&#34;</span>:2,<span style=color:#4e9a06>&#34;autovacuum_naptime&#34;</span>:<span style=color:#4e9a06>&#34;1min&#34;</span>,<span style=color:#4e9a06>&#34;autovacuum_vacuum_cost_delay&#34;</span>:-1,<span style=color:#4e9a06>&#34;autovacuum_vacuum_cost_limit&#34;</span>:-1,<span style=color:#4e9a06>&#34;autovacuum_freeze_max_age&#34;</span>:1000000000,<span style=color:#4e9a06>&#34;deadlock_timeout&#34;</span>:<span style=color:#4e9a06>&#34;50ms&#34;</span>,<span style=color:#4e9a06>&#34;idle_in_transaction_session_timeout&#34;</span>:<span style=color:#4e9a06>&#34;10min&#34;</span>,<span style=color:#4e9a06>&#34;shared_preload_libraries&#34;</span>:<span style=color:#4e9a06>&#34;timescaledb, pg_stat_statements, auto_explain&#34;</span>,<span style=color:#4e9a06>&#34;auto_explain.log_min_duration&#34;</span>:<span style=color:#4e9a06>&#34;1s&#34;</span>,<span style=color:#4e9a06>&#34;auto_explain.log_analyze&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;auto_explain.log_verbose&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;auto_explain.log_timing&#34;</span>:<span style=color:#4e9a06>&#34;on&#34;</span>,<span style=color:#4e9a06>&#34;auto_explain.log_nested_statements&#34;</span>:true,<span style=color:#4e9a06>&#34;pg_stat_statements.max&#34;</span>:5000,<span style=color:#4e9a06>&#34;pg_stat_statements.track&#34;</span>:<span style=color:#4e9a06>&#34;all&#34;</span>,<span style=color:#4e9a06>&#34;pg_stat_statements.track_utility&#34;</span>:<span style=color:#4e9a06>&#34;off&#34;</span>,<span style=color:#4e9a06>&#34;pg_stat_statements.track_planning&#34;</span>:<span style=color:#4e9a06>&#34;off&#34;</span>,<span style=color:#4e9a06>&#34;timescaledb.telemetry_level&#34;</span>:<span style=color:#4e9a06>&#34;off&#34;</span>,<span style=color:#4e9a06>&#34;timescaledb.max_background_workers&#34;</span>:8,<span style=color:#4e9a06>&#34;citus.node_conninfo&#34;</span>:<span style=color:#4e9a06>&#34;sslm
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ode=prefer&#34;</span><span style=color:#ce5c00;font-weight:700>}}}</span>
</span></span><span style=display:flex><span>/pg/pg-meta/failsafe
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;pg-meta-2&#34;</span>:<span style=color:#4e9a06>&#34;http://10.10.10.11:8008/patroni&#34;</span>,<span style=color:#4e9a06>&#34;pg-meta-1&#34;</span>:<span style=color:#4e9a06>&#34;http://10.10.10.10:8008/patroni&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>/pg/pg-meta/initialize
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>7418384210787662172</span>
</span></span><span style=display:flex><span>/pg/pg-meta/leader
</span></span><span style=display:flex><span>pg-meta-1
</span></span><span style=display:flex><span>/pg/pg-meta/members/pg-meta-1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;conn_url&#34;</span>:<span style=color:#4e9a06>&#34;postgres://10.10.10.10:5432/postgres&#34;</span>,<span style=color:#4e9a06>&#34;api_url&#34;</span>:<span style=color:#4e9a06>&#34;http://10.10.10.10:8008/patroni&#34;</span>,<span style=color:#4e9a06>&#34;state&#34;</span>:<span style=color:#4e9a06>&#34;running&#34;</span>,<span style=color:#4e9a06>&#34;role&#34;</span>:<span style=color:#4e9a06>&#34;primary&#34;</span>,<span style=color:#4e9a06>&#34;version&#34;</span>:<span style=color:#4e9a06>&#34;4.0.1&#34;</span>,<span style=color:#4e9a06>&#34;tags&#34;</span>:<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;clonefrom&#34;</span>:true,<span style=color:#4e9a06>&#34;version&#34;</span>:<span style=color:#4e9a06>&#34;16&#34;</span>,<span style=color:#4e9a06>&#34;spec&#34;</span>:<span style=color:#4e9a06>&#34;8C.32G.125G&#34;</span>,<span style=color:#4e9a06>&#34;conf&#34;</span>:<span style=color:#4e9a06>&#34;tiny.yml&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>,<span style=color:#4e9a06>&#34;xlog_location&#34;</span>:184549376,<span style=color:#4e9a06>&#34;timeline&#34;</span>:1<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>/pg/pg-meta/members/pg-meta-2
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;conn_url&#34;</span>:<span style=color:#4e9a06>&#34;postgres://10.10.10.11:5432/postgres&#34;</span>,<span style=color:#4e9a06>&#34;api_url&#34;</span>:<span style=color:#4e9a06>&#34;http://10.10.10.11:8008/patroni&#34;</span>,<span style=color:#4e9a06>&#34;state&#34;</span>:<span style=color:#4e9a06>&#34;running&#34;</span>,<span style=color:#4e9a06>&#34;role&#34;</span>:<span style=color:#4e9a06>&#34;replica&#34;</span>,<span style=color:#4e9a06>&#34;version&#34;</span>:<span style=color:#4e9a06>&#34;4.0.1&#34;</span>,<span style=color:#4e9a06>&#34;tags&#34;</span>:<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;clonefrom&#34;</span>:true,<span style=color:#4e9a06>&#34;version&#34;</span>:<span style=color:#4e9a06>&#34;16&#34;</span>,<span style=color:#4e9a06>&#34;spec&#34;</span>:<span style=color:#4e9a06>&#34;8C.32G.125G&#34;</span>,<span style=color:#4e9a06>&#34;conf&#34;</span>:<span style=color:#4e9a06>&#34;tiny.yml&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>,<span style=color:#4e9a06>&#34;xlog_location&#34;</span>:184549376,<span style=color:#4e9a06>&#34;replication_state&#34;</span>:<span style=color:#4e9a06>&#34;streaming&#34;</span>,<span style=color:#4e9a06>&#34;timeline&#34;</span>:1<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>/pg/pg-meta/status
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;optime&#34;</span>:184549376,<span style=color:#4e9a06>&#34;slots&#34;</span>:<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;pg_meta_2&#34;</span>:184549376,<span style=color:#4e9a06>&#34;pg_meta_1&#34;</span>:184549376<span style=color:#ce5c00;font-weight:700>}</span>,<span style=color:#4e9a06>&#34;retain_slots&#34;</span>:<span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#34;pg_meta_1&#34;</span>,<span style=color:#4e9a06>&#34;pg_meta_2&#34;</span><span style=color:#ce5c00;font-weight:700>]}</span>
</span></span></code></pre></div><hr><h2 id=如何使用一个外部的已经存在的-etcd-集群>如何使用一个外部的已经存在的 etcd 集群？</h2><p>配置清单中硬编码了所使用 etcd 的分组名为 <code>etcd</code>，这个分组里的成员将被用作 PGSQL 的 DCS 服务器。您可以使用 <code>etcd.yml</code> 对它们进行初始化，或直接假设它是一个已存在的外部 etcd 集群。</p><p>要使用现有的外部 etcd 集群，只要像往常一样定义它们即可，您可以跳过 <code>etcd.yml</code> 剧本的执行，因为集群已经存在，不需要部署。</p><p>但用户必须确保 <strong>现有 etcd 集群证书是由 Pigsty 使用的相同 CA 签名颁发的</strong>。否则客户端无法使用 Pigsty 自签名 CA 颁发的证书来访问外部的 etcd 集群。</p><hr><h2 id=如何向现有etcd集群添加新的成员>如何向现有etcd集群添加新的成员？</h2><blockquote><p>详细过程，请参考 <a href=/docs/etcd/admin#%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98>向 etcd 集群添加成员</a></p></blockquote><p><strong>推荐方式：使用便捷脚本</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 首先在配置清单中添加新成员定义，然后执行：</span>
</span></span><span style=display:flex><span>bin/etcd-add &lt;ip&gt;      <span style=color:#8f5902;font-style:italic># 添加单个新成员</span>
</span></span><span style=display:flex><span>bin/etcd-add &lt;ip1&gt;     <span style=color:#8f5902;font-style:italic># 添加多个新成员</span>
</span></span></code></pre></div><p><strong>手动方式：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl member add &lt;etcd-?&gt; --learner<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --peer-urls<span style=color:#ce5c00;font-weight:700>=</span>https://&lt;new_ins_ip&gt;:2380 <span style=color:#8f5902;font-style:italic># 宣告新成员加入</span>
</span></span><span style=display:flex><span>./etcd.yml -l &lt;new_ins_ip&gt; -e <span style=color:#000>etcd_init</span><span style=color:#ce5c00;font-weight:700>=</span>existing                                 <span style=color:#8f5902;font-style:italic># 初始化新成员</span>
</span></span><span style=display:flex><span>etcdctl member promote &lt;new_ins_server_id&gt;                                       <span style=color:#8f5902;font-style:italic># 提升为正式成员</span>
</span></span></code></pre></div><p>请注意，我们建议一次只添加一个新成员。</p><hr><h2 id=如何从现有etcd集群中移除成员>如何从现有etcd集群中移除成员？</h2><blockquote><p>详细过程，请参考 <a href=/docs/etcd/admin#%E7%A7%BB%E9%99%A4%E6%88%90%E5%91%98>从 etcd 集群中移除成员</a></p></blockquote><p><strong>推荐方式：使用便捷脚本</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/etcd-rm &lt;ip&gt;              <span style=color:#8f5902;font-style:italic># 移除指定成员</span>
</span></span><span style=display:flex><span>bin/etcd-rm                   <span style=color:#8f5902;font-style:italic># 移除整个 etcd 集群</span>
</span></span></code></pre></div><p><strong>手动方式：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd-rm.yml -l &lt;ins_ip&gt;                    <span style=color:#8f5902;font-style:italic># 使用专用移除剧本</span>
</span></span><span style=display:flex><span>etcdctl member remove &lt;etcd_server_id&gt;       <span style=color:#8f5902;font-style:italic># 从集群中踢出成员</span>
</span></span><span style=display:flex><span>./etcd-rm.yml -l &lt;ins_ip&gt;                    <span style=color:#8f5902;font-style:italic># 清理实例</span>
</span></span></code></pre></div><hr><h2 id=如何配置-etcd-rbac-认证>如何配置 etcd RBAC 认证？</h2><p>Pigsty v4.0 默认启用 etcd 的 RBAC 认证。root 用户密码由 <a href=/docs/etcd/param#etcd_root_password><code>etcd_root_password</code></a> 参数控制，默认值为 <code>Etcd.Root</code>。</p><p><strong>在生产环境中，强烈建议修改默认密码</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_root_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;YourSecurePassword&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>客户端认证</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在 etcd 节点上，环境变量已自动配置</span>
</span></span><span style=display:flex><span><span style=color:#204a87>source</span> /etc/profile.d/etcdctl.sh
</span></span><span style=display:flex><span>etcdctl member list
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 手动配置认证</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_USER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;root:YourSecurePassword&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_CACERT</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/etcd/ca.crt
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_CERT</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/etcd/server.crt
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>ETCDCTL_KEY</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/etcd/server.key
</span></span></code></pre></div><p>更多详情请参考 <a href=/docs/etcd/admin#rbac-%E8%AE%A4%E8%AF%81>RBAC 认证</a>。</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script type=module async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@latest\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>