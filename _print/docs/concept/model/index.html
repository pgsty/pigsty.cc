<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/concept/model/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/concept/model/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>集群模型图 | PIGSTY</title><meta name=description content="Pigsty 是如何将不同种类的功能抽象成为模块的，以及这些模块的逻辑模型，实体关系图。"><meta property="og:url" content="https://pigsty.cc/docs/concept/model/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="集群模型图"><meta property="og:description" content="Pigsty 是如何将不同种类的功能抽象成为模块的，以及这些模块的逻辑模型，实体关系图。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="集群模型图"><meta itemprop=description content="Pigsty 是如何将不同种类的功能抽象成为模块的，以及这些模块的逻辑模型，实体关系图。"><meta itemprop=dateModified content="2026-01-10T21:35:32+08:00"><meta itemprop=wordCount content="30"><meta itemprop=keywords content="概念,PIGSTY"><meta name=twitter:card content="summary"><meta name=twitter:title content="集群模型图"><meta name=twitter:description content="Pigsty 是如何将不同种类的功能抽象成为模块的，以及这些模块的逻辑模型，实体关系图。"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/concept/model/>返回本页常规视图</a>.</p></div><h1 class=title>集群模型图</h1><div class=lead>Pigsty 是如何将不同种类的功能抽象成为模块的，以及这些模块的逻辑模型，实体关系图。</div><ul><li>1: <a href=#pg-97ed05d79e93eabb25565a36bc328883>PGSQL 集群模型</a></li><li>2: <a href=#pg-5a875c30b5ea163b13415e0cf143a46f>ETCD 集群模型</a></li><li>3: <a href=#pg-c495cfba1010bd7cf73164bea4ebc4f3>MINIO 集群模型</a></li><li>4: <a href=#pg-0de22cd0f8c383fe4e1ef5a4eb6b5440>REDIS 集群模型</a></li><li>5: <a href=#pg-2ad10e50acca12cdeaaf406b2cf23f3b>INFRA 集群模型</a></li></ul><div class=content><p>在 Pigsty 中最大的实体概念叫做 <strong>部署（Deployment）</strong>，一套部署中的主要实体与关系（E-R 图）如下所示：</p><p><img src=/img/pigsty/er-full.svg alt></p><p>一套部署也可以理解为一个 <strong>环境（Environment）</strong>。例如，生产环境（Prod），用户测试环境（UTA），预发环境（Staging），测试环境（Testing），开发环境（Devbox），等等。
每个环境中，都对应着一份 Pigsty <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a>，描述了环境中的所有实体与属性。</p><p>通常来说，一套环境中也会带有一套共用的基础设施（<a href=/docs/infra><strong><code>INFRA</code></strong></a>），广义的基础设施还包括 <a href=/docs/etcd><strong><code>ETCD</code></strong></a>（高可用 DCS）以及 <a href=/docs/minio><strong><code>MINIO</code></strong></a>（集中式备份仓库），
同时供环境中的多套 PostgreSQL 数据库集群（以及其他数据库模块组件）使用。（例外：也有 <a href=/docs/setup/slim><strong>不带基础设施的部署</strong></a>）</p><p>在 Pigsty 中，几乎所有数据库模块都是以 &ldquo;<strong>集群</strong>"（Cluster）的方式组织起来的。每一个集群都是一个 Ansible 分组，包含有若干节点资源。
例如 PostgreSQL 高可用数据库集群，Redis，Etcd / MinIO 这些数据库都是以集群的形式存在。一套环境中可以包含多个集群。</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-97ed05d79e93eabb25565a36bc328883>1 - PGSQL 集群模型</h1><div class=lead>介绍 Pigsty 中 PostgreSQL 集群的实体-关系模型，E-R 关系图，实体释义与命名规范。</div><p>PGSQL模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组由<strong>主-备</strong>关联的数据库<strong>实例</strong>组成的<strong>逻辑实体</strong>。</p><p>每个集群都是一个<strong>自治</strong>的业务单元，由至少一个 <strong>主库实例</strong> 组成，并通过服务向外暴露能力。</p><p>在 Pigsty 的PGSQL模块中有四种核心实体：</p><ul><li><strong>集群</strong>（Cluster）：自治的 PostgreSQL 业务单元，用作其他实体的顶级命名空间。</li><li><strong>服务</strong>（Service）：对外暴露能力的命名抽象，路由流量，并使用节点端口暴露服务。</li><li><strong>实例</strong>（Instance）：由在单个节点上的运行进程和数据库文件组成的单一 PostgreSQL 服务器。</li><li><strong>节点</strong>（Node）：运行 Linux + Systemd 环境的硬件资源抽象，可以是裸机、VM、容器或 Pod。</li></ul><p>辅以“数据库”“角色”两个业务实体，共同组成完整的逻辑视图。如下图所示：</p><p><img src=/img/pigsty/er-pgsql.svg alt=er-pgsql></p><hr><h2 id=具体样例>具体样例</h2><p>让我们来看两个具体的例子，以四节点的 Pigsty <a href=/docs/deploy/sandbox><strong>沙箱环境</strong></a> 为例，在这个环境中，有一套三节点的 <code>pg-test</code> 集群。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上面的配置片段定义了一个如下所示的 <a href=/docs/concept/ha/><strong>高可用</strong></a> PostgreSQL 集群，该集群中的相关实体包括：</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>pg-test</code></strong></td><td>PostgreSQL 3 节点高可用集群</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>pg-test-1</code></strong></td><td>1 号 PostgreSQL 实例，默认为主库</td></tr><tr><td style=text-align:center><strong><code>pg-test-2</code></strong></td><td>2 号 PostgreSQL 实例，初始为从库</td></tr><tr><td style=text-align:center><strong><code>pg-test-3</code></strong></td><td>3 号 PostgreSQL 实例，初始为从库</td></tr><tr><td style=text-align:center><span class=text-info><strong>服务</strong></span></td><td><span class=text-info><strong>Service</strong></span></td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#primary%E6%9C%8D%E5%8A%A1><strong><code>pg-test-primary</code></strong></a></td><td>读写服务（路由到主库 pgbouncer）</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#replica%E6%9C%8D%E5%8A%A1><strong><code>pg-test-replica</code></strong></a></td><td>只读服务（路由到从库 pgbouncer）</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#default%E6%9C%8D%E5%8A%A1><strong><code>pg-test-default</code></strong></a></td><td>直连读写服务（路由到主库 postgres）</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#offline%E6%9C%8D%E5%8A%A1><strong><code>pg-test-offline</code></strong></a></td><td>离线读取服务（路由到专用 postgres）</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>node-1</code></strong></td><td><code>10.10.10.11</code> 1 号节点，对应 <code>pg-test-1</code> PG 实例</td></tr><tr><td style=text-align:center><strong><code>node-2</code></strong></td><td><code>10.10.10.12</code> 2 号节点，对应 <code>pg-test-2</code> PG 实例</td></tr><tr><td style=text-align:center><strong><code>node-3</code></strong></td><td><code>10.10.10.13</code> 3 号节点，对应 <code>pg-test-3</code> PG 实例</td></tr></tbody></table><p><img src=/img/pigsty/ha.png alt=ha></p><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/pgsql/param#pg_id><strong><code>PG_ID</code></strong></a> 参数组为 PGSQL 模块的每个实体赋予确定的身份。以下三项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_cluster><strong><code>pg_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>集群</td><td style=text-align:left>PG 集群名称，必选身份参数</td><td>有效的 DNS 名称，满足正则表达式 <code>[a-zA-Z0-9-]+</code></td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_seq><strong><code>pg_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>实例</td><td style=text-align:left>PG 实例编号，必选身份参数</td><td>自然数，可从 0 或 1 开始分配，集群内不重复</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_role><strong><code>pg_role</code></strong></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center>实例</td><td style=text-align:left>PG 实例角色，必选身份参数</td><td>枚举值，可为 <code>primary</code>，<code>replica</code>，<code>offline</code></td></tr></tbody></table><p>只要在集群层面定义了集群名称，实例层面分配了实例编号与角色，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th>生成规则</th><th>示例</th></tr></thead><tbody><tr><td><strong>实例</strong></td><td><code>{{ pg_cluster }}-{{ pg_seq }}</code></td><td><code>pg-test-1</code>，<code>pg-test-2</code>，<code>pg-test-3</code></td></tr><tr><td><strong>服务</strong></td><td><code>{{ pg_cluster }}-{{ pg_role }}</code></td><td><code>pg-test-primary</code>，<code>pg-test-replica</code>，<code>pg-test-offline</code></td></tr><tr><td><strong>节点</strong></td><td>显示指定覆盖，或自动从 PG 实例借用</td><td><code>pg-test-1</code>，<code>pg-test-2</code>，<code>pg-test-3</code></td></tr></tbody></table><p>因为 Pigsty 采用节点与 PG 实例 1:1 的独占部署模型，因此默认情况下，主机节点的标识符会直接借用 PG 实例的标识符（<a href=/docs/node/param#node_id_from_pg><strong><code>node_id_from_pg</code></strong></a> ）。
当然您也可以显式指定 <a href=/docs/node/param#nodename><strong><code>nodename</code></strong></a> 进行覆盖，或者关闭 <a href=/docs/node/param#nodename_overwrite><strong><code>nodename_overwrite</code></strong></a>，直接使用当前默认值。</p><hr><h2 id=分片身份参数>分片身份参数</h2><p>当你使用多套 PostgreSQL （<strong>分片</strong> / Sharding）集群服务同一业务时，还会使用到另外两个身份参数：<a href=/docs/pgsql/param#pg_shard><strong><code>pg_shard</code></strong></a> 与 <a href=/docs/pgsql/param#pg_group><strong><code>pg_group</code></strong></a>。</p><p>在这种情况下，这一组 PostgreSQL 集群将拥有相同的 <code>pg_shard</code> 名称，以及各自的 <code>pg_group</code> 编号，例如下面的 <a href=/docs/pgsql/config/cluster#citus%E9%9B%86%E7%BE%A4><strong>Citus 集群</strong></a>：</p><p>在这种情况下，<code>pg_cluster</code> 集群名通常由：<code>{{ pg_shard }}{{ pg_group }}</code> 组合而成，例如 <code>pg-citus0</code>、<code>pg-citus1</code> 等。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 0号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 1号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 2号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 3号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 专门为水平分片集群提供专门的监控面板，便于对比各分片的性能与负载情况，但这需要您使用上述实体命名规则。</p><p>还有一些其他的身份参数，可能在特殊场景会使用到，例如，指定备份集群/级联复制上游的 <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a>，指定 Greenplum 集群身份的 <a href=/docs/pgsql/param#gp_role><code>gp_role</code></a> ，
指定外部监控实例的 <a href=/docs/pgsql/param#pg_exporters><code>pg_exporters</code></a> ，指定实例为离线查询库的 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> 等，请参考 <a href=/docs/pgsql/param#pg_id><strong><code>PG_ID</code> 参数文档</strong></a>。</p><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 提供了一套开箱即用的监控系统，在这个系统中使用上面的 <a href=#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 来标识各个 PostgreSQL 实体对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-1&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;pgsql&#34;}
</span></span><span style=display:flex><span>pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-2&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;pgsql&#34;}
</span></span><span style=display:flex><span>pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-3&#34;, ip=&#34;10.10.10.13&#34;, job=&#34;pgsql&#34;}
</span></span></code></pre></div><p>例如，上面的 <code>cls</code>，<code>ins</code>，<code>ip</code> 三个标签，分别对应集群名、实例名与节点 IP，这三个核心实体的标识符。
它们与 <code>job</code> 标签，在 <strong>所有</strong> <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a> 采集的原生监控指标，以及 <a href=/docs/concept/arch/infra#victorialogs><strong>VictoriaLogs</strong></a> 日志流中都会出现并可用。</p><p>采集 PostgreSQL 指标的 <code>job</code> 名固定为 <code>pgsql</code>；
用于监控远程 PG 实例的 <code>job</code> 名固定为 <code>pgrds</code>。
采集 PostgreSQL CSV 日志的 <code>job</code> 名固定为 <code>postgres</code>；
采集 pgbackrest 日志的 <code>job</code> 名固定为 <code>pgbackrest</code>，其余 PG 组件通过 <code>job: syslog</code> 采集日志。</p><p>此外，还有一些普通实体身份标签，会在实体相关的特定监控指标中出现，例如：</p><ul><li><code>datname</code>： 数据库名，如果一个监控指标属于某个具体的数据库，则会带上这个标签。</li><li><code>relname</code>： 表名，如果一个监控指标属于某个具体的表，则会带上这个标签。</li><li><code>idxname</code>： 索引名，如果一个监控指标属于某个具体的索引，则会带上这个标签。</li><li><code>funcname</code>： 函数名，如果一个监控指标属于某个具体的函数，则会带上这个标签。</li><li><code>seqname</code>： 序列名，如果一个监控指标属于某个具体的序列，则会带上这个标签。</li><li><code>query</code>： 查询指纹，如果一个监控指标属于某个具体的查询，则会带上这个标签。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5a875c30b5ea163b13415e0cf143a46f>2 - ETCD 集群模型</h1><div class=lead>介绍 Pigsty 中 ETCD 集群的实体-关系模型，E-R 关系图，实体释义与命名规范。</div><p>ETCD 模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组通过 <strong>Raft</strong> 共识协议关联的 ETCD <strong>实例</strong>组成的<strong>逻辑实体</strong>。</p><p>每个集群都是一个<strong>自治</strong>的分布式键值存储单元，由至少一个 <strong>ETCD 实例</strong> 组成，通过客户端端口向外暴露服务能力。</p><p>在 Pigsty 的 ETCD 模块中有三种核心实体：</p><ul><li><strong>集群</strong>（Cluster）：自治的 ETCD 服务单元，用作其他实体的顶级命名空间。</li><li><strong>实例</strong>（Instance）：单个 ETCD 服务器进程，在节点上运行，参与 Raft 共识。</li><li><strong>节点</strong>（Node）：运行 Linux + Systemd 环境的硬件资源抽象，隐含式声明。</li></ul><p>相比于 PostgreSQL 集群，ETCD 集群模型更为简单，没有服务（Service）和复杂的角色（Role）区分。
所有 ETCD 实例在功能上是对等的，通过 Raft 协议选举出 Leader，其余为 Follower。
在扩容的中间状态，还允许不参与投票的 Learner 实例成员存在。</p><hr><h2 id=具体样例>具体样例</h2><p>让我们来看一个具体的例子，以三节点的 ETCD 集群为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上面的配置片段定义了一个如下所示的三节点 ETCD 集群，该集群中的相关实体包括：</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>etcd</code></strong></td><td>ETCD 三节点高可用集群</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>etcd-1</code></strong></td><td>1 号 ETCD 实例</td></tr><tr><td style=text-align:center><strong><code>etcd-2</code></strong></td><td>2 号 ETCD 实例</td></tr><tr><td style=text-align:center><strong><code>etcd-3</code></strong></td><td>3 号 ETCD 实例</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>10.10.10.10</code></strong></td><td>1 号节点，对应 <code>etcd-1</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.11</code></strong></td><td>2 号节点，对应 <code>etcd-2</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.12</code></strong></td><td>3 号节点，对应 <code>etcd-3</code> 实例</td></tr></tbody></table><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/etcd/param#etcd><strong><code>ETCD</code></strong></a> 参数组为 ETCD 模块的每个实体赋予确定的身份。以下两项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th style=text-align:left>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/etcd/param#etcd_cluster><strong><code>etcd_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>集群</td><td style=text-align:left>ETCD 集群名称，必选身份参数</td><td style=text-align:left>有效的 DNS 名称，默认为固定值 <code>etcd</code></td></tr><tr><td style=text-align:left><a href=/docs/etcd/param#etcd_seq><strong><code>etcd_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>实例</td><td style=text-align:left>ETCD 实例编号，必选身份参数</td><td style=text-align:left>自然数，从 1 开始分配，集群内不重复</td></tr></tbody></table><p>只要在集群层面定义了集群名称，实例层面分配了实例编号，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th style=text-align:left>生成规则</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td><strong>实例</strong></td><td style=text-align:left><code>{{ etcd_cluster }}-{{ etcd_seq }}</code></td><td style=text-align:left><code>etcd-1</code>，<code>etcd-2</code>，<code>etcd-3</code></td></tr></tbody></table><p>ETCD 模块不会为主机节点赋予额外的身份标识，节点使用其原有的主机名或 IP 地址进行标识。</p><hr><h2 id=端口协议>端口协议</h2><p>每个 ETCD 实例会监听以下两个端口：</p><table class=full-width><thead><tr><th style=text-align:left>端口</th><th style=text-align:left>参数</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><strong>2379</strong></td><td style=text-align:left><a href=/docs/etcd/param#etcd_port><strong><code>etcd_port</code></strong></a></td><td style=text-align:left>客户端端口，供 Patroni、vip-manager 等客户端访问</td></tr><tr><td style=text-align:left><strong>2380</strong></td><td style=text-align:left><a href=/docs/etcd/param#etcd_peer_port><strong><code>etcd_peer_port</code></strong></a></td><td style=text-align:left>节点间通信端口，用于 Raft 共识协议</td></tr></tbody></table><p>ETCD 集群默认启用 TLS 加密通信，并使用 RBAC 认证机制。客户端需要使用正确的证书和密码才能访问 ETCD 服务。</p><hr><h2 id=集群规模>集群规模</h2><p>ETCD 作为分布式协调服务，集群规模直接影响其可用性，需要有超过半数（仲裁数）的节点存活才能维持服务。</p><table class=full-width><thead><tr><th style=text-align:center>集群规模</th><th style=text-align:center>仲裁数</th><th style=text-align:center>容忍故障数</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:center>1 节点</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:left>开发、测试、演示</td></tr><tr><td style=text-align:center>3 节点</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:left>中小规模生产环境</td></tr><tr><td style=text-align:center>5 节点</td><td style=text-align:center>3</td><td style=text-align:center>2</td><td style=text-align:left>大规模生产环境</td></tr></tbody></table><p>因此，偶数节点的 ETCD 集群没有意义，超过五节点的 ETCD 集群并不常见，因此通常使用的规格就是单节点、三节点、五节点。</p><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 提供了一套开箱即用的监控系统，在这个系统中使用上面的 <a href=#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 来标识各个 ETCD 实体对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>etcd_up{cls=&#34;etcd&#34;, ins=&#34;etcd-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;etcd&#34;}
</span></span><span style=display:flex><span>etcd_up{cls=&#34;etcd&#34;, ins=&#34;etcd-2&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;etcd&#34;}
</span></span><span style=display:flex><span>etcd_up{cls=&#34;etcd&#34;, ins=&#34;etcd-3&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;etcd&#34;}
</span></span></code></pre></div><p>例如，上面的 <code>cls</code>，<code>ins</code>，<code>ip</code> 三个标签，分别对应集群名、实例名与节点 IP，这三个核心实体的标识符。
它们与 <code>job</code> 标签，在 <strong>所有</strong> <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a> 采集的 ETCD 监控指标中都会出现并可用。
采集 ETCD 指标的 <code>job</code> 名固定为 <code>etcd</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c495cfba1010bd7cf73164bea4ebc4f3>3 - MINIO 集群模型</h1><div class=lead>介绍 Pigsty 中 MinIO 集群的实体-关系模型，E-R 关系图，实体释义与命名规范。</div><p>MinIO 模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组分布式 MinIO <strong>实例</strong>组成的<strong>逻辑实体</strong>，共同提供高可用的对象存储服务。</p><p>每个集群都是一个<strong>自治</strong>的 S3 兼容对象存储单元，由至少一个 <strong>MinIO 实例</strong> 组成，通过 S3 API 端口向外暴露服务能力。</p><p>在 Pigsty 的 MinIO 模块中有三种核心实体：</p><ul><li><strong>集群</strong>（Cluster）：自治的 MinIO 服务单元，用作其他实体的顶级命名空间。</li><li><strong>实例</strong>（Instance）：单个 MinIO 服务器进程，在节点上运行，管理本地磁盘存储。</li><li><strong>节点</strong>（Node）：运行 Linux + Systemd 环境的硬件资源抽象，隐含式声明。</li></ul><p>此外，MinIO 还有 <a href=/docs/minio/config#%E5%A4%9A%E6%B1%A0%E9%83%A8%E7%BD%B2><strong>存储池</strong></a>（Pool）的概念，用于集群平滑扩容。
一个集群可以包含多个存储池，每个存储池由一组节点和磁盘组成。</p><hr><h2 id=部署模式>部署模式</h2><p>MinIO 支持三种主要部署模式，适用于不同的场景：</p><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center>代号</th><th style=text-align:left>说明</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:center><a href=/docs/minio/config#%E5%8D%95%E6%9C%BA%E5%8D%95%E7%9B%98><strong>单机单盘</strong></a></td><td style=text-align:center><strong>SNSD</strong></td><td style=text-align:left>单节点，单个数据目录，或单块磁盘</td><td style=text-align:left>开发、测试、演示</td></tr><tr><td style=text-align:center><a href=/docs/minio/config#%E5%8D%95%E6%9C%BA%E5%A4%9A%E7%9B%98><strong>单机多盘</strong></a></td><td style=text-align:center><strong>SNMD</strong></td><td style=text-align:left>单节点，使用多块磁盘，通常至少 4 块盘</td><td style=text-align:left>资源受限的小规模部署</td></tr><tr><td style=text-align:center><a href=/docs/minio/config#%E5%A4%9A%E6%9C%BA%E5%A4%9A%E7%9B%98><strong>多机多盘</strong></a></td><td style=text-align:center><strong>MNMD</strong></td><td style=text-align:left>多节点，每节点多块磁盘</td><td style=text-align:left><strong>生产环境推荐</strong></td></tr></tbody></table><p>单机单盘模式可以使用任意目录作为存储，适合快速体验；单机多盘和多机多盘模式需要使用真实的磁盘挂载点，否则会拒绝启动。</p><hr><h2 id=具体样例>具体样例</h2><p>让我们来看一个多机多盘模式的具体例子，以四节点的 MinIO 集群为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data{1...4}&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${minio_cluster}-${minio_seq}.pigsty&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上面的配置片段定义了一个四节点的 MinIO 集群，每个节点使用四块磁盘，该集群中的相关实体包括：</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>minio</code></strong></td><td>MinIO 四节点高可用集群</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>minio-1</code></strong></td><td>1 号 MinIO 实例，管理 4 块磁盘</td></tr><tr><td style=text-align:center><strong><code>minio-2</code></strong></td><td>2 号 MinIO 实例，管理 4 块磁盘</td></tr><tr><td style=text-align:center><strong><code>minio-3</code></strong></td><td>3 号 MinIO 实例，管理 4 块磁盘</td></tr><tr><td style=text-align:center><strong><code>minio-4</code></strong></td><td>4 号 MinIO 实例，管理 4 块磁盘</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>10.10.10.10</code></strong></td><td>1 号节点，对应 <code>minio-1</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.11</code></strong></td><td>2 号节点，对应 <code>minio-2</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.12</code></strong></td><td>3 号节点，对应 <code>minio-3</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.13</code></strong></td><td>4 号节点，对应 <code>minio-4</code> 实例</td></tr></tbody></table><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/minio/param#minio><strong><code>MINIO</code></strong></a> 参数组为 MinIO 模块的每个实体赋予确定的身份。以下两项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th style=text-align:left>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/minio/param#minio_cluster><strong><code>minio_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>集群</td><td style=text-align:left>MinIO 集群名称，必选身份参数</td><td style=text-align:left>有效的 DNS 名称，默认为 <code>minio</code></td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio_seq><strong><code>minio_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>实例</td><td style=text-align:left>MinIO 实例编号，必选身份参数</td><td style=text-align:left>自然数，从 1 开始分配，集群内不重复</td></tr></tbody></table><p>只要在集群层面定义了集群名称，实例层面分配了实例编号，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th style=text-align:left>生成规则</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td><strong>实例</strong></td><td style=text-align:left><code>{{ minio_cluster }}-{{ minio_seq }}</code></td><td style=text-align:left><code>minio-1</code>，<code>minio-2</code>，<code>minio-3</code>，<code>minio-4</code></td></tr></tbody></table><p>MinIO 模块不会为主机节点赋予额外的身份标识，节点使用其原有的主机名或 IP 地址进行标识。
<a href=/docs/minio/param#minio_node><strong><code>minio_node</code></strong></a> 参数用于生成 MinIO 集群内部的节点名称（写入 <code>/etc/hosts</code> 供集群发现使用），而非主机节点的身份。</p><hr><h2 id=核心配置参数>核心配置参数</h2><p>除身份参数外，以下参数对 MinIO 集群配置至关重要：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/minio/param#minio_data><strong><code>minio_data</code></strong></a></td><td style=text-align:center><code>path</code></td><td style=text-align:left>数据目录，使用 <code>{x...y}</code> 指定多盘</td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio_node><strong><code>minio_node</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:left>节点名模式，用于多节点部署</td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio_domain><strong><code>minio_domain</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:left>服务域名，默认为 <code>sss.pigsty</code></td></tr></tbody></table><p>这些参数共同决定了 MinIO 的核心配置 <code>MINIO_VOLUMES</code>：</p><ul><li><strong>单机单盘</strong>：直接使用 <code>minio_data</code> 的值，如 <code>/data/minio</code></li><li><strong>单机多盘</strong>：使用 <code>minio_data</code> 展开的多个目录，如 <code>/data{1...4}</code></li><li><strong>多机多盘</strong>：组合 <code>minio_node</code> 与 <code>minio_data</code>，如 <code>https://minio-{1...4}.pigsty:9000/data{1...4}</code></li></ul><hr><h2 id=端口与服务>端口与服务</h2><p>每个 MinIO 实例会监听以下端口：</p><table class=full-width><thead><tr><th style=text-align:left>端口</th><th style=text-align:left>参数</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left>9000</td><td style=text-align:left><a href=/docs/minio/param#minio_port><strong><code>minio_port</code></strong></a></td><td style=text-align:left>S3 API 服务端口</td></tr><tr><td style=text-align:left>9001</td><td style=text-align:left><a href=/docs/minio/param#minio_admin_port><strong><code>minio_admin_port</code></strong></a></td><td style=text-align:left>Web 管理控制台端口</td></tr></tbody></table><p>MinIO 默认启用 HTTPS 加密通信（由 <a href=/docs/minio/param#minio_https><strong><code>minio_https</code></strong></a> 控制）。这对于 pgBackREST 等备份工具访问 MinIO 是必需的。</p><p>多节点 MinIO 集群可以通过访问 <strong>任意一个节点</strong> 来访问其服务。最佳实践是使用负载均衡器（如 HAProxy + VIP）统一接入点。</p><hr><h2 id=资源置备>资源置备</h2><p>MinIO 集群部署后，Pigsty 会自动创建以下资源（由 <a href=/docs/minio/param#minio_provision><strong><code>minio_provision</code></strong></a> 控制）：</p><p><strong>默认存储桶</strong>（由 <a href=/docs/minio/param#minio_buckets><strong><code>minio_buckets</code></strong></a> 定义）：</p><table class=full-width><thead><tr><th style=text-align:left>存储桶</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><code>pgsql</code></td><td style=text-align:left>PostgreSQL pgBackREST 备份存储</td></tr><tr><td style=text-align:left><code>meta</code></td><td style=text-align:left>元数据存储，启用版本控制</td></tr><tr><td style=text-align:left><code>data</code></td><td style=text-align:left>通用数据存储</td></tr></tbody></table><p><strong>默认用户</strong>（由 <a href=/docs/minio/param#minio_users><strong><code>minio_users</code></strong></a> 定义）：</p><table class=full-width><thead><tr><th style=text-align:left>用户</th><th style=text-align:left>默认密码</th><th style=text-align:left>策略</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><code>pgbackrest</code></td><td style=text-align:left><code>S3User.Backup</code></td><td style=text-align:left><code>pgsql</code></td><td style=text-align:left>PostgreSQL 备份专用用户</td></tr><tr><td style=text-align:left><code>s3user_meta</code></td><td style=text-align:left><code>S3User.Meta</code></td><td style=text-align:left><code>meta</code></td><td style=text-align:left>访问 <code>meta</code> 存储桶</td></tr><tr><td style=text-align:left><code>s3user_data</code></td><td style=text-align:left><code>S3User.Data</code></td><td style=text-align:left><code>data</code></td><td style=text-align:left>访问 <code>data</code> 存储桶</td></tr></tbody></table><p><code>pgbackrest</code> 是 PostgreSQL 集群备份时使用的用户，<code>s3user_meta</code> 和 <code>s3user_data</code> 是未实际使用的保留用户。</p><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 提供了一套开箱即用的监控系统，在这个系统中使用上面的 <a href=#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 来标识各个 MinIO 实体对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;minio&#34;}
</span></span><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-2&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;minio&#34;}
</span></span><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-3&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;minio&#34;}
</span></span><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-4&#34;, ip=&#34;10.10.10.13&#34;, job=&#34;minio&#34;}
</span></span></code></pre></div><p>例如，上面的 <code>cls</code>，<code>ins</code>，<code>ip</code> 三个标签，分别对应集群名、实例名与节点 IP，这三个核心实体的标识符。
它们与 <code>job</code> 标签，在 <strong>所有</strong> <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a> 采集的 MinIO 监控指标中都会出现并可用。
采集 MinIO 指标的 <code>job</code> 名固定为 <code>minio</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0de22cd0f8c383fe4e1ef5a4eb6b5440>4 - REDIS 集群模型</h1><div class=lead>介绍 Pigsty 中 Redis 集群的实体-关系模型，E-R 关系图，实体释义与命名规范。</div><p>Redis 模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组 Redis <strong>实例</strong>组成的<strong>逻辑实体</strong>，部署在一个或多个<strong>节点</strong>上。</p><p>每个集群都是一个<strong>自治</strong>的高性能缓存/存储单元，由至少一个 <strong>Redis 实例</strong> 组成，通过端口向外暴露服务能力。</p><p>在 Pigsty 的 Redis 模块中有三种核心实体：</p><ul><li><strong>集群</strong>（Cluster）：自治的 Redis 服务单元，用作其他实体的顶级命名空间。</li><li><strong>实例</strong>（Instance）：单个 Redis 服务器进程，在节点上的特定端口运行。</li><li><strong>节点</strong>（Node）：运行 Linux + Systemd 环境的硬件资源抽象，可以承载多个 Redis 实例，隐含式声明。</li></ul><p>与 PostgreSQL 不同，Redis 采用 <strong>单机多实例</strong> 的部署模型：一个物理/虚拟机节点上通常会部署 <strong>多个</strong> Redis 实例，
以充分利用多核 CPU。因此，节点与实例是 <strong>1:N</strong> 的关系。此外，生产中通常不建议设置单个内存规模大于 12GB 的 Redis 实例。</p><hr><h2 id=工作模式>工作模式</h2><p>Redis 有三种不同的工作模式，由 <a href=/docs/redis/param#redis_mode><strong><code>redis_mode</code></strong></a> 参数指定：</p><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center>代号</th><th style=text-align:left>说明</th><th style=text-align:left>高可用机制</th></tr></thead><tbody><tr><td style=text-align:center><a href=#%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4><strong>主从模式</strong></a></td><td style=text-align:center><code>standalone</code></td><td style=text-align:left>经典主从复制，<strong>默认模式</strong></td><td style=text-align:left>需配合 Sentinel 实现</td></tr><tr><td style=text-align:center><a href=#%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4><strong>哨兵模式</strong></a></td><td style=text-align:center><code>sentinel</code></td><td style=text-align:left>为主从模式提供高可用监控与自动故障转移</td><td style=text-align:left>本身的多节点仲裁</td></tr><tr><td style=text-align:center><a href=#%E5%8E%9F%E7%94%9F%E9%9B%86%E7%BE%A4><strong>原生集群模式</strong></a></td><td style=text-align:center><code>cluster</code></td><td style=text-align:left>Redis 原生分布式集群，无需哨兵即可高可用</td><td style=text-align:left>内置自动故障转移</td></tr></tbody></table><ul><li><strong>主从模式</strong>：默认模式，通过 <code>replica_of</code> 参数设置主从复制关系。需要额外的 Sentinel 集群提供高可用。</li><li><strong>哨兵模式</strong>：不存储业务数据，专门用于监控主从模式的 Redis 集群，实现自动故障转移，本身多节点即可高可用。</li><li><strong>原生集群模式</strong>：数据自动分片到多个主节点，每个主节点可以有多个从节点，内置高可用能力，无需哨兵支持。</li></ul><hr><h2 id=具体样例>具体样例</h2><p>让我们来看三种模式的具体例子：</p><h3 id=主从集群>主从集群</h3><p>一个节点上部署一主一从的经典主从集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-ms</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.ms&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>redis-ms</code></strong></td><td>Redis 主从集群</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-ms-1</code></strong></td><td><code>10.10.10.10</code> 1 号节点，承载 2 个实例</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-ms-1-6379</code></strong></td><td>主库实例，监听 6379 端口</td></tr><tr><td style=text-align:center><strong><code>redis-ms-1-6380</code></strong></td><td>从库实例，监听 6380 端口，复制自 6379</td></tr></tbody></table><h3 id=哨兵集群>哨兵集群</h3><p>一个节点上部署三个哨兵实例，用于监控主从集群。哨兵集群通过 <a href=/docs/redis/param#redis_sentinel_monitor><strong><code>redis_sentinel_monitor</code></strong></a> 参数指定要监控的主从集群列表：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-sentinel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>26379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 26380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 26381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.sentinel&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_sentinel_monitor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: redis-ms, host: 10.10.10.10, port: 6379, password: redis.ms, quorum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=原生集群>原生集群</h3><p>下面的配置片段定义了由两个节点，六个实例组成的 Redis 原生分布式集群（最小规格，3主3从）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1, redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 2, redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>该配置将创建一个 <strong>3 主 3 从</strong> 的原生 Redis 集群。</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>redis-test</code></strong></td><td>Redis 原生集群（3 主 3 从）</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-test-1-6379</code></strong></td><td>节点 1 上的实例，监听 6379 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-1-6380</code></strong></td><td>节点 1 上的实例，监听 6380 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-1-6381</code></strong></td><td>节点 1 上的实例，监听 6381 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-2-6379</code></strong></td><td>节点 2 上的实例，监听 6379 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-2-6380</code></strong></td><td>节点 2 上的实例，监听 6380 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-2-6381</code></strong></td><td>节点 2 上的实例，监听 6381 端口</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-test-1</code></strong></td><td><code>10.10.10.12</code> 1 号节点，承载 3 个实例</td></tr><tr><td style=text-align:center><strong><code>redis-test-2</code></strong></td><td><code>10.10.10.13</code> 2 号节点，承载 3 个实例</td></tr></tbody></table><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/redis/param#redis><strong><code>REDIS</code></strong></a> 参数组为 Redis 模块的每个实体赋予确定的身份。以下三项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th style=text-align:left>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/redis/param#redis_cluster><strong><code>redis_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>集群</td><td style=text-align:left>Redis 集群名称，必选身份参数</td><td style=text-align:left>有效的 DNS 名称，满足 <code>[a-z][a-z0-9-]*</code></td></tr><tr><td style=text-align:left><a href=/docs/redis/param#redis_node><strong><code>redis_node</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>节点</td><td style=text-align:left>Redis 节点编号，必选身份参数</td><td style=text-align:left>自然数，从 1 开始分配，集群内不重复</td></tr><tr><td style=text-align:left><a href=/docs/redis/param#redis_instances><strong><code>redis_instances</code></strong></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center>节点</td><td style=text-align:left>Redis 实例定义，必选身份参数</td><td style=text-align:left>JSON 对象，Key 为端口号，Value 为实例配置</td></tr></tbody></table><p>只要在集群层面定义了集群名称，节点层面分配了节点编号与实例定义，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th style=text-align:left>生成规则</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td><strong>实例</strong></td><td style=text-align:left><code>{{ redis_cluster }}-{{ redis_node }}-{{ port }}</code></td><td style=text-align:left><code>redis-ms-1-6379</code>，<code>redis-ms-1-6380</code></td></tr></tbody></table><p>Redis 模块不会为主机节点赋予额外的身份标识，节点使用其原有的主机名或 IP 地址进行标识。
<a href=/docs/redis/param#redis_node><strong><code>redis_node</code></strong></a> 参数用于实例命名，而非主机节点的身份。</p><hr><h2 id=实例定义>实例定义</h2><p><a href=/docs/redis/param#redis_instances><strong><code>redis_instances</code></strong></a> 是一个 JSON 对象，Key 为 <strong>端口号</strong>，Value 为该实例的 <strong>配置项</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>                                      </span><span style=color:#8f5902;font-style:italic># 主库实例，无需额外配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 从库实例，指定上游主库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 从库实例，指定上游主库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个 Redis 实例会监听一个唯一的端口，端口在节点上唯一不重复，您可以任意选择端口号，
但请不要使用系统保留端口（小于 1024），或者与 <a href=/docs/ref/port/><strong>Pigsty 使用的端口</strong></a> 冲突。
实例配置中的 <code>replica_of</code> 参数用于在主从模式下设置复制关系，格式为 <code>'&lt;ip> &lt;port>'</code>，用于指定一个 Redis 从库的上游主库地址与端口。</p><p>此外，每个 Redis 节点上会运行一个 Redis Exporter，用于汇总采集当前节点上 <strong>所有本地实例</strong> 的监控指标：</p><table class=full-width><thead><tr><th style=text-align:left>端口</th><th style=text-align:left>参数</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left>9121</td><td style=text-align:left><a href=/docs/redis/param#redis_exporter_port><strong><code>redis_exporter_port</code></strong></a></td><td style=text-align:left>Redis Exporter 端口</td></tr></tbody></table><p>Redis 模块的单机多实例部署模型带有一些一些局限性：</p><ul><li><strong>节点独占</strong>：一个节点只能属于一个 Redis 集群，不能同时分配给不同的 Redis 集群。</li><li><strong>端口唯一</strong>：同一节点上的 Redis 实例必须使用不同的端口号，避免端口冲突。</li><li><strong>密码共享</strong>：同一节点上的多个 Redis 实例无法设置不同的密码（受 redis_exporter 限制）。</li><li><strong>手动高可用</strong>：主从模式的 Redis 集群需要额外配置 Sentinel 才能实现自动故障转移。</li></ul><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 提供了一套开箱即用的监控系统，在这个系统中使用上面的 <a href=#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 来标识各个 Redis 实体对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>redis_up{cls=&#34;redis-ms&#34;, ins=&#34;redis-ms-1-6379&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;redis&#34;}
</span></span><span style=display:flex><span>redis_up{cls=&#34;redis-ms&#34;, ins=&#34;redis-ms-1-6380&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;redis&#34;}
</span></span></code></pre></div><p>例如，上面的 <code>cls</code>，<code>ins</code>，<code>ip</code> 三个标签，分别对应集群名、实例名与节点 IP，这三个核心实体的标识符。
它们与 <code>job</code> 标签，在 <strong>所有</strong> <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a> 采集的 Redis 监控指标中都会出现并可用。
采集 Redis 指标的 <code>job</code> 名固定为 <code>redis</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2ad10e50acca12cdeaaf406b2cf23f3b>5 - INFRA 集群模型</h1><div class=lead>介绍 Pigsty 中 INFRA 基础设施节点的实体-关系模型，组件构成与命名规范。</div><p>INFRA 模块在 Pigsty 中承担着特殊的角色：它不是传统意义上的"集群"，而是由一组 <strong>基础设施节点</strong> 构成的管理中枢，为整个 Pigsty 部署提供核心服务。
每个 INFRA 节点都是一个<strong>自治</strong>的基础设施服务单元，运行着 Nginx、Grafana、VictoriaMetrics 等核心组件，共同为纳管的数据库集群提供可观测性与管理能力。</p><p>在 Pigsty 的 INFRA 模块中有两种核心实体：</p><ul><li><strong>节点</strong>（Node）：运行基础设施组件的服务器，可以是裸机、VM、容器或 Pod。</li><li><strong>组件</strong>（Component）：在节点上运行的各类基础设施服务，如 Nginx、Grafana、VictoriaMetrics 等。</li></ul><p>INFRA 节点通常承担管理节点（Admin Node）的角色，是 Pigsty 的控制平面所在。</p><hr><h2 id=组件构成>组件构成</h2><p>每个 INFRA 节点上运行着以下核心组件：</p><table class=full-width><thead><tr><th style=text-align:left>组件</th><th style=text-align:left>端口</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/concept/arch/infra#nginx><strong>Nginx</strong></a></td><td style=text-align:left><code>80/443</code></td><td style=text-align:left>Web 服务门户，本地软件仓库，统一反向代理入口</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#grafana><strong>Grafana</strong></a></td><td style=text-align:left><code>3000</code></td><td style=text-align:left>可视化平台，监控大屏，巡检与数据应用</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a></td><td style=text-align:left><code>8428</code></td><td style=text-align:left>时序数据库，兼容 Prometheus API</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#victorialogs><strong>VictoriaLogs</strong></a></td><td style=text-align:left><code>9428</code></td><td style=text-align:left>日志数据库，接收 Vector 推送的结构化日志</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#victoriatraces><strong>VictoriaTraces</strong></a></td><td style=text-align:left><code>10428</code></td><td style=text-align:left>链路追踪存储，用于慢 SQL / 请求追踪</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#vmalert><strong>VMAlert</strong></a></td><td style=text-align:left><code>8880</code></td><td style=text-align:left>告警规则评估器，基于 VictoriaMetrics 触发告警</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#alertmanager><strong>Alertmanager</strong></a></td><td style=text-align:left><code>9059</code></td><td style=text-align:left>告警聚合与分发</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#blackboxexporter><strong>Blackbox Exporter</strong></a></td><td style=text-align:left><code>9115</code></td><td style=text-align:left>ICMP/TCP/HTTP 黑盒探测</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#dnsmasq><strong>DNSMASQ</strong></a></td><td style=text-align:left><code>53</code></td><td style=text-align:left>DNS 服务器，提供内部域名解析</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#chronyd><strong>Chronyd</strong></a></td><td style=text-align:left><code>123</code></td><td style=text-align:left>NTP 时间服务器</td></tr></tbody></table><p>这些组件共同构成了 Pigsty 的可观测性基础设施。</p><hr><h2 id=具体样例>具体样例</h2><p>让我们来看一个具体的例子，以双节点的 INFRA 部署为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上面的配置片段定义了一个双节点的 INFRA 部署：</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>分组</strong></span></th><th><span class=text-secondary><strong>Group</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>infra</code></strong></td><td>INFRA 基础设施节点分组</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>infra-1</code></strong></td><td><code>10.10.10.10</code> 1 号 INFRA 节点</td></tr><tr><td style=text-align:center><strong><code>infra-2</code></strong></td><td><code>10.10.10.11</code> 2 号 INFRA 节点</td></tr></tbody></table><p>在生产环境中，建议部署至少两个 INFRA 节点，以实现基础设施组件的冗余。</p><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/infra/param#infra_id><strong><code>INFRA_ID</code></strong></a> 参数组为 INFRA 模块的每个实体赋予确定的身份。以下一项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th style=text-align:left>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/infra/param#infra_seq><strong><code>infra_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>节点</td><td style=text-align:left>INFRA 节点序号，必选身份参数</td><td style=text-align:left>自然数，从 1 开始分配，分组内不重复</td></tr></tbody></table><p>只要在节点层面分配了节点序号，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th style=text-align:left>生成规则</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td><strong>节点</strong></td><td style=text-align:left><code>infra-{{ infra_seq }}</code></td><td style=text-align:left><code>infra-1</code>，<code>infra-2</code></td></tr></tbody></table><p>INFRA 模块会为节点赋予 <code>infra-N</code> 形式的标识，用于监控系统中区分多个基础设施节点。
但这并不改变节点本身的主机名或系统身份，节点仍然使用其原有的主机名或 IP 地址进行标识。</p><hr><h2 id=服务门户>服务门户</h2><p>INFRA 节点通过 Nginx 提供统一的 Web 服务入口。<a href=/docs/infra/param#infra_portal><strong><code>infra_portal</code></strong></a> 参数定义了通过 Nginx 暴露的服务列表。</p><p>默认配置只定义了首页服务器：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 会自动为启用的组件（如 Grafana、VictoriaMetrics、AlertManager 等）配置反向代理端点。如果需要通过独立域名访问这些服务，可以显式添加配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home         </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>grafana      </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: g.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:3000&#34;</span><span style=color:#204a87;font-weight:700>, websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>prometheus   </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: p.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:8428&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># VMUI</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>alertmanager </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: a.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:9059&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:left>域名</th><th style=text-align:left>服务</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>i.pigsty</code></td><td style=text-align:left>Home</td><td style=text-align:left>Pigsty 首页</td></tr><tr><td style=text-align:left><code>g.pigsty</code></td><td style=text-align:left>Grafana</td><td style=text-align:left>监控可视化平台</td></tr><tr><td style=text-align:left><code>p.pigsty</code></td><td style=text-align:left>VictoriaMetrics</td><td style=text-align:left>时序数据库 Web UI</td></tr><tr><td style=text-align:left><code>a.pigsty</code></td><td style=text-align:left>Alertmanager</td><td style=text-align:left>告警管理界面</td></tr></tbody></table><p>建议通过域名访问 Pigsty 服务，而不是直接使用 IP + 端口的方式。</p><hr><h2 id=部署规模>部署规模</h2><p>INFRA 节点的数量取决于部署规模和高可用需求：</p><table class=full-width><thead><tr><th style=text-align:left>部署规模</th><th style=text-align:left>INFRA 节点数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>开发测试</td><td style=text-align:left>1</td><td style=text-align:left>单节点部署，所有组件在同一节点</td></tr><tr><td style=text-align:left>小规模生产</td><td style=text-align:left>1-2</td><td style=text-align:left>单节点或双节点，可与其他服务共用节点</td></tr><tr><td style=text-align:left>中规模生产</td><td style=text-align:left>2-3</td><td style=text-align:left>独立的 INFRA 节点，组件冗余部署</td></tr><tr><td style=text-align:left>大规模生产</td><td style=text-align:left>3+</td><td style=text-align:left>多 INFRA 节点，可根据组件分离部署</td></tr></tbody></table><p><a href=/docs/setup/install><strong>单机部署</strong></a> 时，INFRA 组件与 PGSQL、ETCD 等模块共用同一个节点。
通常在小规模部署中，INFRA 节点通常还承担着 “<a href=/docs/concept/arch/node#admin%E8%8A%82%E7%82%B9><strong>管理节点</strong></a>” / “备用管理节点”，以及本地软件仓库（<code>/www/pigsty</code>）的角色。
在更大规模的部署中，这些职责可以剥离至专用节点。</p><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 的监控系统会采集 INFRA 组件自身的指标。与数据库模块不同，INFRA 模块的每个<strong>组件</strong>都被视为独立的监控对象，通过 <code>cls</code>（类）标签区分不同组件类型。</p><table class=full-width><thead><tr><th style=text-align:left>标签</th><th style=text-align:left>说明</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td style=text-align:left><code>cls</code></td><td style=text-align:left>组件类型，每种组件各自构成一个"类"</td><td style=text-align:left><code>nginx</code></td></tr><tr><td style=text-align:left><code>ins</code></td><td style=text-align:left>实例名，格式为 <code>{组件类型}-{infra_seq}</code></td><td style=text-align:left><code>nginx-1</code></td></tr><tr><td style=text-align:left><code>ip</code></td><td style=text-align:left>运行该组件的 INFRA 节点 IP 地址</td><td style=text-align:left><code>10.10.10.10</code></td></tr><tr><td style=text-align:left><code>job</code></td><td style=text-align:left>VictoriaMetrics 采集任务名，固定为 <code>infra</code></td><td style=text-align:left><code>infra</code></td></tr></tbody></table><p>以双节点 INFRA 部署（<code>infra_seq: 1</code> 和 <code>infra_seq: 2</code>）为例，各组件的监控标签如下：</p><table class=full-width><thead><tr><th style=text-align:left>组件</th><th style=text-align:left><code>cls</code></th><th style=text-align:left><code>ins</code> 示例</th><th style=text-align:left>端口</th></tr></thead><tbody><tr><td style=text-align:left><strong>Nginx</strong></td><td style=text-align:left><code>nginx</code></td><td style=text-align:left><code>nginx-1</code>，<code>nginx-2</code></td><td style=text-align:left><code>9113</code></td></tr><tr><td style=text-align:left><strong>Grafana</strong></td><td style=text-align:left><code>grafana</code></td><td style=text-align:left><code>grafana-1</code>，<code>grafana-2</code></td><td style=text-align:left><code>3000</code></td></tr><tr><td style=text-align:left><strong>VictoriaMetrics</strong></td><td style=text-align:left><code>vmetrics</code></td><td style=text-align:left><code>vmetrics-1</code>，<code>vmetrics-2</code></td><td style=text-align:left><code>8428</code></td></tr><tr><td style=text-align:left><strong>VictoriaLogs</strong></td><td style=text-align:left><code>vlogs</code></td><td style=text-align:left><code>vlogs-1</code>，<code>vlogs-2</code></td><td style=text-align:left><code>9428</code></td></tr><tr><td style=text-align:left><strong>VictoriaTraces</strong></td><td style=text-align:left><code>vtraces</code></td><td style=text-align:left><code>vtraces-1</code>，<code>vtraces-2</code></td><td style=text-align:left><code>10428</code></td></tr><tr><td style=text-align:left><strong>VMAlert</strong></td><td style=text-align:left><code>vmalert</code></td><td style=text-align:left><code>vmalert-1</code>，<code>vmalert-2</code></td><td style=text-align:left><code>8880</code></td></tr><tr><td style=text-align:left><strong>Alertmanager</strong></td><td style=text-align:left><code>alertmanager</code></td><td style=text-align:left><code>alertmanager-1</code>，<code>alertmanager-2</code></td><td style=text-align:left><code>9059</code></td></tr><tr><td style=text-align:left><strong>Blackbox</strong></td><td style=text-align:left><code>blackbox</code></td><td style=text-align:left><code>blackbox-1</code>，<code>blackbox-2</code></td><td style=text-align:left><code>9115</code></td></tr></tbody></table><p>所有 INFRA 组件的监控指标都使用统一的 <code>job="infra"</code> 标签，通过 <code>cls</code> 标签区分组件类型：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>nginx_up{cls=&#34;nginx&#34;, ins=&#34;nginx-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>grafana_info{cls=&#34;grafana&#34;, ins=&#34;grafana-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>vm_app_version{cls=&#34;vmetrics&#34;, ins=&#34;vmetrics-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>vlogs_rows_ingested_total{cls=&#34;vlogs&#34;, ins=&#34;vlogs-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>alertmanager_alerts{cls=&#34;alertmanager&#34;, ins=&#34;alertmanager-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span></code></pre></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>