<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/concept/sec/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/concept/sec/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>安全合规 | PIGSTY</title><meta name=description content="认证、授权、加密、审计与合规基线，覆盖数据库与基础设施安全。"><meta property="og:url" content="https://pigsty.cc/docs/concept/sec/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="安全合规"><meta property="og:description" content="认证、授权、加密、审计与合规基线，覆盖数据库与基础设施安全。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="安全合规"><meta itemprop=description content="认证、授权、加密、审计与合规基线，覆盖数据库与基础设施安全。"><meta itemprop=dateModified content="2026-02-08T16:14:56+08:00"><meta itemprop=wordCount content="103"><meta itemprop=keywords content="概念,PIGSTY,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="安全合规"><meta name=twitter:description content="认证、授权、加密、审计与合规基线，覆盖数据库与基础设施安全。"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/concept/sec/>返回本页常规视图</a>.</p></div><h1 class=title>安全合规</h1><div class=lead>认证、授权、加密、审计与合规基线，覆盖数据库与基础设施安全。</div><ul><li>1: <a href=#pg-42af3045c7ebee43d7c66fbe8a4cd267>七层安全模型</a></li><li>2: <a href=#pg-e262c3c798800d9c25e91d199755245e>身份认证</a></li><li>3: <a href=#pg-6a3742ed82b65fb5a722f76337bf835d>访问控制</a></li><li>4: <a href=#pg-8b790153f8312a89aef83b802d30c481>加密通信与本地 CA</a></li><li>5: <a href=#pg-7e0ac5f31c46a7de87a54fa692c7e8f1>数据安全</a></li><li>6: <a href=#pg-d273c15ad260463dcc3b8ed6fad3a323>合规清单</a></li></ul><div class=content><p>Pigsty 的安全目标是 <strong>CIA 三元组</strong>：</p><ul><li><strong>机密性</strong>：防止未授权访问与泄露</li><li><strong>完整性</strong>：防止数据被篡改或静默损坏</li><li><strong>可用性</strong>：防止故障导致业务中断</li></ul><p>Pigsty 的安全理念：</p><ul><li><strong>默认安全</strong>：开箱即用的安全基线，配置少、覆盖广。</li><li><strong>纵深防御</strong>：多层保护叠加，单点失守不致系统失守。</li><li><strong>最小权限</strong>：角色与权限模型贯彻最小授权原则。</li><li><strong>可合规</strong>：安全能力与流程结合即可通过合规检查。</li></ul><hr><h2 id=默认安全基线解决什么问题>默认安全基线（解决什么问题）</h2><table class=full-width><thead><tr><th style=text-align:left>安全选项</th><th style=text-align:left>默认值</th><th style=text-align:left>解决的问题</th></tr></thead><tbody><tr><td style=text-align:left>密码加密</td><td style=text-align:left><code>pg_pwd_enc: scram-sha-256</code></td><td style=text-align:left>防止弱哈希与明文泄露</td></tr><tr><td style=text-align:left>数据校验</td><td style=text-align:left><code>pg_checksum: true</code></td><td style=text-align:left>检测静默数据损坏</td></tr><tr><td style=text-align:left>HBA 分层</td><td style=text-align:left>管理员外网必须 <code>ssl</code></td><td style=text-align:left>防止外网明文访问</td></tr><tr><td style=text-align:left>本地 CA</td><td style=text-align:left><code>ca_create: true</code></td><td style=text-align:left>统一证书信任链</td></tr><tr><td style=text-align:left>备份恢复</td><td style=text-align:left><code>pgbackrest_enabled: true</code></td><td style=text-align:left>防止误删误改不可恢复</td></tr><tr><td style=text-align:left>Nginx HTTPS</td><td style=text-align:left><code>nginx_sslmode: enable</code></td><td style=text-align:left>防止 Web 入口明文泄露</td></tr><tr><td style=text-align:left>MinIO HTTPS</td><td style=text-align:left><code>minio_https: true</code></td><td style=text-align:left>防止备份链路窃听</td></tr><tr><td style=text-align:left>OS 基线</td><td style=text-align:left>SELinux <code>permissive</code></td><td style=text-align:left>为强制模式预留基础</td></tr></tbody></table><blockquote><p>默认配置以“可用、可扩展”为先，生产环境应根据合规要求加固。</p></blockquote><hr><h2 id=加固路线图>加固路线图</h2><p>Pigsty 提供安全增强模板 <code>conf/ha/safe.yml</code>，可快速将默认基线升级到更高安全级别：</p><ul><li>强制 SSL 与证书认证</li><li>密码强度与过期策略</li><li>连接与断开日志</li><li>防火墙与 SELinux 加固</li></ul><hr><h2 id=本章内容>本章内容</h2><table class=full-width><thead><tr><th style=text-align:left>章节</th><th style=text-align:left>说明</th><th style=text-align:left>核心问题</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/concept/sec/level><strong>纵深防御</strong></a></td><td style=text-align:left>七层安全模型与基线</td><td style=text-align:left>安全体系整体如何落地？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/auth><strong>身份认证</strong></a></td><td style=text-align:left>HBA 规则、密码策略、证书认证</td><td style=text-align:left>如何验证用户身份？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/ac><strong>访问控制</strong></a></td><td style=text-align:left>角色系统、权限模型、数据库隔离</td><td style=text-align:left>如何控制用户权限？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/ca><strong>加密通信</strong></a></td><td style=text-align:left>TLS、本地 CA、证书管理</td><td style=text-align:left>如何保护传输与证书？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/data><strong>数据安全</strong></a></td><td style=text-align:left>校验和、备份、加密与恢复</td><td style=text-align:left>数据如何完整可恢复？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/compliance><strong>合规清单</strong></a></td><td style=text-align:left>等保三级与 SOC2 对照</td><td style=text-align:left>如何满足合规要求？</td></tr></tbody></table><hr><h2 id=相关话题>相关话题</h2><ul><li>♾️ <a href=/docs/concept/ha/><strong>高可用</strong></a>：业务连续性保障</li><li>⏰ <a href=/docs/concept/pitr/><strong>备份恢复</strong></a>：PITR 与灾难恢复</li><li>📊 <a href=/docs/concept/monitor/><strong>可观测性</strong></a>：安全事件监控</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-42af3045c7ebee43d7c66fbe8a4cd267>1 - 七层安全模型</h1><div class=lead>Pigsty 的纵深防御模型：从物理到用户的多层安全基线。</div><p>安全不是一道墙，而是一座城。Pigsty 采用<strong>纵深防御</strong>策略，在七个层次上构建多重保护，即使某一层被突破，仍有其他层提供保护。</p><p>这种分层思路解决三类核心风险：</p><ul><li><strong>边界被突破</strong>：降低“单点失守导致全盘失守”的概率。</li><li><strong>内部滥用</strong>：即使内部账号被盗，也能通过最小权限限制破坏范围。</li><li><strong>不可预期故障</strong>：硬件、软件、人为错误都能被“多层兜底”。</li></ul><hr><h2 id=概览>概览</h2><div id=infographic-296a28376e55bf0bd7d2bce937b065d7 class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-296a28376e55bf0bd7d2bce937b065d7",s=`\`\`\`\`
infographic sequence-pyramid-simple
data
  title 七层安全模型
  desc Pigsty 纵深防御体系：从物理到用户的多层保护
  items
    - label 物理与介质
      value 100
      desc 数据校验和 · 介质盗取防护
      time L1
      icon mingcute/building-4-fill
      illus server-cluster
    - label 网络安全
      value 95
      desc 防火墙 · 监听收敛 · TLS
      time L2
      icon mingcute/earth-2-fill
      illus secure-server
    - label 边界安全
      value 90
      desc HAProxy · Nginx · 统一入口
      time L3
      icon mingcute/shield-fill
      illus firewall-protection
    - label 主机安全
      value 85
      desc SELinux · 最小权限 · 系统加固
      time L4
      icon mingcute/computer-fill
      illus server-status
    - label 应用安全
      value 80
      desc HBA · SCRAM · 密码策略
      time L5
      icon mingcute/safe-box-fill
      illus database-security
    - label 数据安全
      value 75
      desc 备份加密 · PITR · 审计
      time L6
      icon mingcute/lock-fill
      illus data-encryption
    - label 用户安全
      value 70
      desc RBAC · 默认权限 · 隔离
      time L7
      icon mingcute/user-security-fill
      illus user-flow
theme light
  palette pigsty
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=l1-物理与介质安全>L1 物理与介质安全</h2><blockquote><p>物理层失守时，唯一的对抗手段是数据本身的自我保护。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>硬件故障导致静默数据损坏</li><li>介质被盗导致数据泄露</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>数据校验和</strong>：默认开启 <code>pg_checksum: true</code>，可发现坏块/内存错误导致的数据损坏。</li><li><strong>可选透明加密</strong>：通过 <code>pg_tde</code> 等扩展实现数据静态加密，防止介质泄露。</li></ul><hr><h2 id=l2-网络安全>L2 网络安全</h2><blockquote><p>控制“谁能接触到服务”，降低攻击面。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>未授权网络访问</li><li>明文传输被窃听/篡改</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>防火墙分区</strong>：<code>node_firewall_mode</code> 可启用 <code>zone</code>，内网信任、公网受限。</li><li><strong>监听收敛</strong>：<code>pg_listen</code> 可限制监听地址，避免全网暴露。</li><li><strong>TLS 能力</strong>：HBA 支持 <code>ssl</code>/<code>cert</code>，保证连接加密与身份校验。</li></ul><hr><h2 id=l3-边界安全>L3 边界安全</h2><blockquote><p>“统一入口”是可审计、可控制、可封禁的基础。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>多入口难以管控</li><li>外部系统无处统一加固</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>HAProxy 入口</strong>：数据库流量统一入口，便于封禁/限流/切换。</li><li><strong>Nginx 网关</strong>：基础设施服务统一 HTTPS 入口（<code>nginx_sslmode</code>）。</li><li><strong>集中管理口令</strong>：HAProxy 管理口令、Grafana 管理口令统一在配置中声明。</li></ul><hr><h2 id=l4-主机安全>L4 主机安全</h2><blockquote><p>数据库安全的地基：最小权限、访问隔离、系统加固。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>主机被入侵导致全盘失守</li><li>管理权限过度扩散</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>SELinux 模式</strong>：<code>node_selinux_mode</code> 可切换 <code>enforcing</code> 强制模式。</li><li><strong>最小权限管理员</strong>：<code>node_admin_sudo</code> 支持 <code>limit</code> 限制 sudo 命令集。</li><li><strong>敏感文件权限</strong>：CA 私钥目录默认 0700，私钥文件 0600。</li></ul><hr><h2 id=l5-应用安全>L5 应用安全</h2><blockquote><p>认证是所有数据库安全的“第一道闸门”。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>弱密码或明文认证导致账号泄露</li><li>错误放行导致越权访问</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>HBA 分层控制</strong>：默认规则按来源与角色分层，管理员外网访问必须 <code>ssl</code>。</li><li><strong>SCRAM 密码哈希</strong>：<code>pg_pwd_enc: scram-sha-256</code> 默认启用。</li><li><strong>密码强度检查</strong>：<code>passwordcheck/credcheck</code> 可启用，阻止弱口令。</li><li><strong>证书认证</strong>：<code>auth: cert</code> 支持客户端证书认证。</li></ul><hr><h2 id=l6-数据安全>L6 数据安全</h2><blockquote><p>保障数据在“可用、可恢复、可追责”。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>人为误操作与逻辑错误</li><li>黑客入侵后数据被篡改或删除</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>pgBackRest 备份</strong>：默认启用，支持本地与 MinIO 仓库。</li><li><strong>备份加密</strong>：MinIO 仓库支持 AES-256-CBC（<code>cipher_type</code>）。</li><li><strong>PITR 恢复</strong>：结合归档可恢复到任意时间点。</li><li><strong>审计日志</strong>：模板启用 DDL/连接/慢查询日志，可选 <code>pgaudit</code>。</li></ul><hr><h2 id=l7-用户安全>L7 用户安全</h2><blockquote><p>最小权限不是口号，而是默认行为。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>业务账号拥有过高权限</li><li>数据库之间相互“穿透”</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>四层 RBAC</strong>：<code>dbrole_readonly/readwrite/admin/offline</code>。</li><li><strong>默认权限策略</strong>：对象创建即自动授予正确权限。</li><li><strong>数据库隔离</strong>：<code>revokeconn: true</code> 可隔离跨库访问。</li><li><strong>公共权限收敛</strong>：撤销 <code>public</code> 模式 <code>CREATE</code> 权限。</li></ul><hr><h2 id=安全加固路径>安全加固路径</h2><p>Pigsty 提供安全增强模板：<code>conf/ha/safe.yml</code>。它将常见加固项集中封装：</p><ul><li>强制 SSL、证书认证</li><li>密码强度与过期策略</li><li>连接与断开日志</li><li>防火墙与 SELinux 加固</li></ul><p>这条路径可以作为“从默认到合规”的快速升级方案。</p><hr><h2 id=接下来>接下来</h2><ul><li>🔑 <a href=/docs/concept/sec/auth><strong>身份认证</strong></a>：HBA 规则与密码策略</li><li>👤 <a href=/docs/concept/sec/ac><strong>访问控制</strong></a>：角色系统与权限模型</li><li>🔐 <a href=/docs/concept/sec/ca><strong>加密通信</strong></a>：TLS 与证书管理</li><li>🔒 <a href=/docs/concept/sec/data><strong>数据安全</strong></a>：备份与加密</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：等保与 SOC2 对照</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e262c3c798800d9c25e91d199755245e>2 - 身份认证</h1><div class=lead>HBA 规则、密码策略与证书认证，回答“谁能连进来、如何证明身份”。</div><p>身份认证解决三个核心问题：</p><ul><li><strong>你是谁</strong>：身份是否唯一可识别？</li><li><strong>你怎么证明</strong>：密码/证书是否足够安全？</li><li><strong>你从哪里来</strong>：来源是否受控？</li></ul><p>Pigsty 使用 <strong>HBA 规则 + 密码/证书</strong> 完成身份认证，并以 SCRAM 为默认密码哈希方案。</p><hr><h2 id=认证链路>认证链路</h2><pre class=mermaid>flowchart LR
  C[客户端] --&gt; HBA[HBA 规则]
  HBA --&gt; A1[密码 SCRAM]
  HBA --&gt; A2[证书认证]
  HBA --&gt; A3[本地 ident/peer]
  A1 --&gt; RBAC[角色与权限]
  A2 --&gt; RBAC
  A3 --&gt; RBAC</pre><p>HBA 决定“<strong>谁能从哪里来</strong>”，认证方式决定“<strong>如何证明身份</strong>”。</p><hr><h2 id=hba-分层模型>HBA 分层模型</h2><p>Pigsty 默认 HBA 规则已经分层：</p><ul><li><strong>本地</strong>使用 <code>ident/peer</code>，最安全。</li><li><strong>内网</strong>使用 <code>scram</code> 密码认证。</li><li><strong>外网管理员</strong>必须走 <code>ssl</code>。</li></ul><p>这解决了“<strong>同一个用户在不同来源使用不同认证强度</strong>”的问题。</p><p><strong>HBA 规则的关键能力</strong></p><ul><li><strong>顺序优先</strong>：支持 <code>order</code> 排序，数值越小优先级越高。</li><li><strong>地址别名</strong>：<code>local</code> / <code>localhost</code> / <code>intra</code> / <code>world</code> 等。</li><li><strong>角色条件</strong>：<code>primary/replica/offline</code> 可精细化控制。</li></ul><hr><h2 id=密码认证>密码认证</h2><p>默认密码哈希算法：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pwd_enc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>解决的问题</strong></p><ul><li>明文密码存储风险</li><li>弱哈希被离线破解</li></ul><p><strong>兼容性</strong></p><p>如需兼容老客户端可使用 <code>md5</code>，但会降低安全性。</p><hr><h2 id=密码强度与轮换>密码强度与轮换</h2><p>Pigsty 支持启用密码强度检查扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;$libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>passwordcheck, credcheck ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>通过 <code>expire_in</code> 控制账号过期时间：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_app, password: &#39;StrongPwd&#39;, expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>365</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>解决的问题</strong></p><ul><li>弱口令与口令复用</li><li>长期不轮换的账号风险</li></ul><hr><h2 id=证书认证>证书认证</h2><p>证书认证解决“<strong>密码被钓鱼/被拷贝</strong>”的风险。</p><ul><li>HBA <code>auth: cert</code> 要求客户端证书。</li><li>证书 <code>CN</code> 通常对应数据库用户名。</li><li>Pigsty 内置 <code>cert.yml</code> 用于签发客户端证书。</li></ul><hr><h2 id=pgbouncer-认证>PgBouncer 认证</h2><p>PgBouncer 使用独立 HBA 规则与 TLS 设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disable  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认关闭，可设为 require/verify-full</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>...]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 独立规则</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这解决了“连接池入口与数据库入口不同步”的问题。</p><hr><h2 id=默认账号与风险>默认账号与风险</h2><table class=full-width><thead><tr><th>用户</th><th>默认密码</th><th>风险</th></tr></thead><tbody><tr><td><code>dbuser_dba</code></td><td><code>DBUser.DBA</code></td><td>管理账号默认密码</td></tr><tr><td><code>dbuser_monitor</code></td><td><code>DBUser.Monitor</code></td><td>监控账号易被滥用</td></tr><tr><td><code>replicator</code></td><td><code>DBUser.Replicator</code></td><td>复制账号被滥用可导致数据外泄</td></tr></tbody></table><p>生产环境必须修改默认密码。</p><hr><h2 id=安全建议>安全建议</h2><ul><li>对外入口全部启用 <code>ssl/cert</code>。</li><li>内网用户使用 <code>scram</code>，避免 <code>md5</code>。</li><li>启用 <code>passwordcheck</code> 强制复杂度。</li><li>定期轮换口令（<code>expire_in</code>）。</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>👤 <a href=/docs/concept/sec/ac><strong>访问控制</strong></a>：角色与权限模型</li><li>🔐 <a href=/docs/concept/sec/ca><strong>加密通信</strong></a>：TLS 与证书管理</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：等保与 SOC2 对照</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6a3742ed82b65fb5a722f76337bf835d>3 - 访问控制</h1><div class=lead>Pigsty 提供开箱即用的角色与权限模型，贯彻最小权限原则。</div><p>访问控制解决两个核心问题：</p><ul><li><strong>你能做什么</strong>：读/写/DDL 的权限边界</li><li><strong>你能访问哪些数据</strong>：跨库、跨模式的隔离边界</li></ul><p>Pigsty 通过 <strong>RBAC 角色体系 + 默认权限策略</strong> 将“最小权限”落实为默认行为。</p><hr><h2 id=四层角色模型>四层角色模型</h2><pre class=mermaid>flowchart TB
    subgraph Admin[&#34;dbrole_admin（管理员）&#34;]
        A1[&#34;可执行 DDL / CREATE / ALTER&#34;]
        A2[&#34;继承 dbrole_readwrite&#34;]
    end
    subgraph RW[&#34;dbrole_readwrite（读写）&#34;]
        RW1[&#34;可 INSERT/UPDATE/DELETE&#34;]
        RW2[&#34;继承 dbrole_readonly&#34;]
    end
    subgraph RO[&#34;dbrole_readonly（只读）&#34;]
        RO1[&#34;可 SELECT 所有表&#34;]
    end
    subgraph Offline[&#34;dbrole_offline（离线）&#34;]
        OFF1[&#34;仅离线实例可用&#34;]
    end

    Admin --&gt; RW --&gt; RO</pre><p><strong>解决的问题</strong></p><ul><li>生产账号天然拥有过高权限</li><li>DDL 与 DML 不分离导致误操作风险</li></ul><hr><h2 id=默认角色与系统用户>默认角色与系统用户</h2><p>Pigsty 默认提供四个角色与四个系统用户（来自源码默认值）：</p><table class=full-width><thead><tr><th>角色/用户</th><th>属性</th><th>继承/角色</th><th>描述</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td>-</td><td>全局只读访问</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td>-</td><td>受限只读（离线实例）</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td><code>dbrole_readonly</code></td><td>全局读写访问</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td><code>pg_monitor, dbrole_readwrite</code></td><td>管理员 / 对象创建</td></tr><tr><td><code>postgres</code></td><td><code>SUPERUSER</code></td><td>-</td><td>系统超级用户</td></tr><tr><td><code>replicator</code></td><td><code>REPLICATION</code></td><td><code>pg_monitor, dbrole_readonly</code></td><td>复制用户</td></tr><tr><td><code>dbuser_dba</code></td><td><code>SUPERUSER</code></td><td><code>dbrole_admin</code></td><td>管理员用户</td></tr><tr><td><code>dbuser_monitor</code></td><td>-</td><td><code>pg_monitor, dbrole_readonly</code></td><td>监控用户</td></tr></tbody></table><p>这套默认角色可以覆盖绝大多数业务场景。</p><hr><h2 id=默认权限策略>默认权限策略</h2><p>Pigsty 在初始化时写入默认权限（<code>pg_default_privileges</code>），确保新建对象自动具备合理权限。</p><p><strong>解决的问题</strong></p><ul><li>新建对象未授权导致应用不可用</li><li>误授权给 <code>PUBLIC</code> 导致全库暴露</li></ul><p><strong>思路</strong></p><ul><li>只读角色：<code>SELECT/EXECUTE</code></li><li>读写角色：<code>INSERT/UPDATE/DELETE</code></li><li>管理员角色：<code>DDL</code> 权限</li></ul><hr><h2 id=对象所有权与-ddl-规范>对象所有权与 DDL 规范</h2><p>默认权限仅对“<strong>管理员角色创建的对象</strong>”自动生效。</p><p>这意味着：</p><ul><li>必须使用 <code>dbuser_dba</code>/<code>postgres</code> 执行 DDL</li><li>或业务管理员先 <code>SET ROLE dbrole_admin</code></li></ul><p>否则新对象会脱离默认权限体系，破坏最小权限原则。</p><hr><h2 id=数据库隔离>数据库隔离</h2><p>数据库级别支持 <code>revokeconn</code>，可做到跨库隔离：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: appdb, owner: dbuser_app, revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>解决的问题</strong></p><ul><li>一个账号可以“穿透”访问所有数据库</li><li>多租户数据库缺乏边界</li></ul><hr><h2 id=公共权限收敛>公共权限收敛</h2><p>Pigsty 初始化时撤销 <code>public</code> 模式的 <code>CREATE</code> 权限：</p><pre tabindex=0><code>REVOKE CREATE ON SCHEMA public FROM PUBLIC;
</code></pre><p><strong>解决的问题</strong></p><ul><li>非授权用户随意创建对象</li><li>“影子表/影子函数”带来的安全风险</li></ul><hr><h2 id=离线角色的作用>离线角色的作用</h2><p><code>dbrole_offline</code> 只能访问离线实例（<code>pg_role=offline</code> 或 <code>pg_offline_query=true</code>）。</p><p><strong>解决的问题</strong></p><ul><li>ETL/分析任务影响生产性能</li><li>个人账号在主库执行高危查询</li></ul><hr><h2 id=最佳实践>最佳实践</h2><ul><li>业务账号默认使用 <code>dbrole_readwrite</code> 或 <code>dbrole_readonly</code>。</li><li>生产 DDL 必须经由管理员角色。</li><li>多租户业务启用 <code>revokeconn</code> 隔离。</li><li>报表/ETL 使用 <code>dbrole_offline</code>。</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>🔑 <a href=/docs/concept/sec/auth><strong>身份认证</strong></a>：HBA 规则与密码策略</li><li>🔐 <a href=/docs/concept/sec/ca><strong>加密通信</strong></a>：TLS 与证书管理</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：等保与 SOC2 对照</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8b790153f8312a89aef83b802d30c481>4 - 加密通信与本地 CA</h1><div class=lead>Pigsty 内置自签 CA，签发 TLS 证书并加密通信流量。</div><p>加密通信解决三个问题：</p><ul><li><strong>窃听</strong>：防止明文流量被监听</li><li><strong>篡改</strong>：防止中间人修改数据</li><li><strong>冒充</strong>：防止服务端/客户端被伪造</li></ul><p>Pigsty 通过 <strong>本地 CA + TLS</strong> 为数据库与基础设施组件提供统一的信任根。</p><hr><h2 id=本地-ca-的作用>本地 CA 的作用</h2><p>Pigsty 默认会在管理节点生成自签 CA：</p><pre tabindex=0><code>files/pki/ca/ca.key   # CA 私钥（必须严格保护）
files/pki/ca/ca.crt   # CA 根证书（可分发）
</code></pre><p>源码默认值：</p><ul><li><code>ca_create: true</code>：找不到 CA 时自动生成。</li><li><code>ca_cn: pigsty-ca</code>：CA 证书 CN 固定为 <code>pigsty-ca</code>。</li><li>根证书有效期约 100 年（自签）。</li><li>由 CA 签发的服务器/客户端证书有效期 <code>cert_validity: 7300d</code>（20 年）。</li></ul><hr><h2 id=证书覆盖范围>证书覆盖范围</h2><p>本地 CA 会签发多种组件证书，统一信任链：</p><table class=full-width><thead><tr><th>组件</th><th>目的</th><th>典型路径</th></tr></thead><tbody><tr><td>PostgreSQL / PgBouncer</td><td>连接加密</td><td><code>/pg/cert/</code></td></tr><tr><td>Patroni</td><td>API 通信</td><td><code>/pg/cert/</code></td></tr><tr><td>etcd</td><td>DCS 加密</td><td><code>/etc/etcd/</code></td></tr><tr><td>MinIO</td><td>对象存储 HTTPS</td><td><code>~minio/.minio/certs/</code></td></tr><tr><td>Nginx</td><td>Web 入口 HTTPS</td><td><code>/etc/nginx/conf.d/cert/</code></td></tr></tbody></table><p><strong>解决的问题</strong>：不同组件自建证书会产生信任碎片，统一 CA 可以一次分发，多处复用。</p><hr><h2 id=信任分发>信任分发</h2><p>Pigsty 安装时会将 <code>ca.crt</code> 分发到所有节点并加入系统信任：</p><ul><li>证书路径：<code>/etc/pki/ca.crt</code></li><li>EL 系列：<code>/etc/pki/ca-trust/source/anchors/</code></li><li>Debian/Ubuntu：<code>/usr/local/share/ca-certificates/</code></li></ul><p>这样可以让系统内的客户端自动信任 Pigsty 签发的证书。</p><hr><h2 id=使用外部-ca>使用外部 CA</h2><p>如果你已有企业 CA，可以直接替换：</p><pre tabindex=0><code>files/pki/ca/ca.key
files/pki/ca/ca.crt
</code></pre><p>建议设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>ca_create</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>解决的问题</strong>：防止系统误生成新的自签 CA，导致证书信任链混乱。</p><hr><h2 id=客户端证书认证>客户端证书认证</h2><p>证书认证可以替代或增强密码认证：</p><ul><li>避免密码被钓鱼或泄露</li><li>证书可绑定设备与账号</li></ul><p>Pigsty 自带 <code>cert.yml</code> 用于签发客户端证书：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_dba
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_monitor
</span></span></code></pre></div><p>默认生成在：</p><pre tabindex=0><code>files/pki/misc/&lt;cn&gt;.key
files/pki/misc/&lt;cn&gt;.crt
</code></pre><hr><h2 id=密钥保护与轮换>密钥保护与轮换</h2><ul><li>CA 私钥默认 0600 权限，并在 0700 目录中保存。</li><li>一旦 CA 私钥泄露，必须重新生成 CA 并重签所有证书。</li><li>建议在重大升级或密钥泄露事件后进行证书轮换。</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>🔑 <a href=/docs/concept/sec/auth><strong>身份认证</strong></a>：HBA 与证书认证</li><li>👤 <a href=/docs/concept/sec/ac><strong>访问控制</strong></a>：角色与权限模型</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：合规要求与证据准备</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7e0ac5f31c46a7de87a54fa692c7e8f1>5 - 数据安全</h1><div class=lead>数据完整性、备份与恢复、加密与审计。</div><p>数据安全关注三件事：<strong>完整性、可恢复性、保密性</strong>。Pigsty 在默认配置中已启用关键能力，并支持按需加固。</p><hr><h2 id=数据完整性>数据完整性</h2><p><strong>解决的问题</strong></p><ul><li>磁盘坏块、内存错误导致的静默损坏</li><li>意外写入导致的数据污染</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>数据校验和</strong>：默认 <code>pg_checksum: true</code>，初始化时启用 <code>data-checksums</code>。</li><li><strong>副本兜底</strong>：主库坏块可从从库恢复（与 HA 配合使用）。</li></ul><hr><h2 id=可恢复性备份与-pitr>可恢复性（备份与 PITR）</h2><p><strong>解决的问题</strong></p><ul><li>误删误改</li><li>灾难性故障导致数据丢失</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>pgBackRest 默认启用</strong>：<code>pgbackrest_enabled: true</code>。</li><li><strong>本地仓库</strong>：默认保留 2 份完整备份。</li><li><strong>远程仓库</strong>：可接入 MinIO，支持对象存储与多副本。</li><li><strong>PITR</strong>：结合 WAL 归档进行任意时间点恢复。</li></ul><hr><h2 id=数据保密性>数据保密性</h2><p><strong>解决的问题</strong></p><ul><li>备份被窃导致数据外泄</li><li>介质被盗导致明文数据泄露</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>备份加密</strong>：MinIO 仓库支持 AES-256-CBC（<code>cipher_type</code>）。</li><li><strong>透明加密（可选）</strong>：通过 <code>pg_tde</code> 等扩展实现数据静态加密。</li><li><strong>密钥隔离</strong>：建议将 <code>cipher_pass</code> 与 CA 私钥分离管理。</li></ul><hr><h2 id=审计与可追溯>审计与可追溯</h2><p><strong>解决的问题</strong></p><ul><li>无法追责与还原操作</li><li>合规审计缺少证据</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>日志收集</strong>：模板默认启用 <code>logging_collector</code>。</li><li><strong>DDL 审计</strong>：<code>log_statement: ddl</code>。</li><li><strong>慢查询</strong>：<code>log_min_duration_statement</code>。</li><li><strong>连接日志</strong>：<code>log_connections</code>（PG18+）。</li><li><strong>审计扩展</strong>：<code>pgaudit</code>、<code>pgauditlogtofile</code> 可选。</li></ul><hr><h2 id=加固建议>加固建议</h2><ul><li>对远程备份强制加密与专用密钥。</li><li>定期演练 PITR，验证恢复链路。</li><li>对关键业务启用 <code>pgaudit</code>。</li><li>结合 <a href=/docs/concept/ha/>高可用</a> 形成“备份 + 副本”双层兜底。</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>🔐 <a href=/docs/concept/sec/ca><strong>加密通信</strong></a>：证书管理与 TLS</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：审计与合规要求</li><li>⏰ <a href=/docs/concept/pitr/><strong>备份恢复</strong></a>：PITR 机制与实践</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d273c15ad260463dcc3b8ed6fad3a323>6 - 合规清单</h1><div class=lead>以 SOC2 与等保三级为切入点，映射 Pigsty 安全能力与证据准备。</div><p>合规不是“开关”，而是 <strong>配置 + 流程 + 证据</strong> 的组合：</p><ul><li><strong>配置</strong>：安全能力是否启用（HBA/TLS/审计/备份）</li><li><strong>流程</strong>：是否有权限管理、变更、备份演练等制度</li><li><strong>证据</strong>：日志、配置快照、备份报告、监控告警</li></ul><p>本页以 SOC2 与等保三级为切入点，说明 Pigsty 的安全能力与合规映射。</p><hr><h2 id=默认凭证清单必须修改>默认凭证清单（必须修改）</h2><p>来自源码默认值：</p><table class=full-width><thead><tr><th>组件</th><th>默认用户名</th><th>默认密码</th></tr></thead><tbody><tr><td>PostgreSQL 管理员</td><td><code>dbuser_dba</code></td><td><code>DBUser.DBA</code></td></tr><tr><td>PostgreSQL 监控</td><td><code>dbuser_monitor</code></td><td><code>DBUser.Monitor</code></td></tr><tr><td>PostgreSQL 复制</td><td><code>replicator</code></td><td><code>DBUser.Replicator</code></td></tr><tr><td>Patroni API</td><td><code>postgres</code></td><td><code>Patroni.API</code></td></tr><tr><td>HAProxy 管理</td><td><code>admin</code></td><td><code>pigsty</code></td></tr><tr><td>Grafana 管理</td><td><code>admin</code></td><td><code>pigsty</code></td></tr><tr><td>MinIO Root</td><td><code>minioadmin</code></td><td><code>S3User.MinIO</code></td></tr><tr><td>etcd Root</td><td><code>root</code></td><td><code>Etcd.Root</code></td></tr></tbody></table><p>生产环境必须修改。</p><hr><h2 id=证据准备建议>证据准备（建议）</h2><table class=full-width><thead><tr><th>证据类型</th><th>说明</th><th>Pigsty 支持</th></tr></thead><tbody><tr><td>配置快照</td><td>HBA、角色、TLS、备份策略</td><td><code>pigsty.yml</code> / inventory 配置</td></tr><tr><td>访问控制</td><td>角色与权限</td><td><code>pg_default_roles</code> / <code>pg_default_privileges</code></td></tr><tr><td>连接审计</td><td>连接、断开、DDL</td><td><code>log_connections</code> / <code>log_statement</code></td></tr><tr><td>备份报告</td><td>完整备份与恢复记录</td><td>pgBackRest 日志与任务</td></tr><tr><td>监控告警</td><td>异常事件记录</td><td>Prometheus + Grafana</td></tr><tr><td>证书管理</td><td>CA/证书分发记录</td><td><code>files/pki/</code> / <code>/etc/pki/ca.crt</code></td></tr></tbody></table><hr><h2 id=soc2-视角示例映射>SOC2 视角（示例映射）</h2><p>SOC2 的核心是 <strong>安全、可用性、机密性</strong>。以下为常见控制点的概念映射：</p><table class=full-width><thead><tr><th>控制点（SOC2）</th><th>解决的问题</th><th>Pigsty 能力</th><th>需要流程</th></tr></thead><tbody><tr><td>CC6 逻辑访问控制</td><td>未授权访问</td><td>HBA + RBAC + 默认权限</td><td>权限审批与定期审计</td></tr><tr><td>CC6 认证强度</td><td>弱口令/复用</td><td>SCRAM + <code>passwordcheck</code></td><td>密码轮换策略</td></tr><tr><td>CC6 传输加密</td><td>明文传输</td><td>TLS/CA、<code>ssl</code>/<code>cert</code></td><td>强制 TLS 政策</td></tr><tr><td>CC7 系统监控</td><td>异常未发现</td><td>Prometheus/Grafana</td><td>告警处理流程</td></tr><tr><td>CC7 审计追踪</td><td>无法追责</td><td>连接/DDL/慢查日志、<code>pgaudit</code></td><td>日志留存与审查</td></tr><tr><td>CC9 业务连续性</td><td>数据不可恢复</td><td>pgBackRest + PITR</td><td>定期恢复演练</td></tr></tbody></table><blockquote><p>以上为概念映射，实际 SOC2 需要配合组织制度与审计证据。</p></blockquote><hr><h2 id=等保三级gbt-22239-2019映射>等保三级（GB/T 22239-2019）映射</h2><p>等保三级关注“身份鉴别、访问控制、审计、数据安全、通信安全、主机安全、网络边界”等。以下为核心控制点与 Pigsty 能力的对应关系：</p><table class=full-width><thead><tr><th>控制点</th><th>解决的问题</th><th>Pigsty 能力</th><th>需要配置/流程</th></tr></thead><tbody><tr><td>身份鉴别唯一性</td><td>账号混用</td><td>唯一用户 + SCRAM</td><td>账号管理流程</td></tr><tr><td>口令复杂度</td><td>弱口令</td><td><code>passwordcheck</code>/<code>credcheck</code></td><td>启用扩展</td></tr><tr><td>口令定期更换</td><td>长期风险</td><td><code>expire_in</code></td><td>密码轮换制度</td></tr><tr><td>访问控制</td><td>越权访问</td><td>RBAC + 默认权限</td><td>权限审批</td></tr><tr><td>最小权限</td><td>权限膨胀</td><td>四层角色模型</td><td>账号分级</td></tr><tr><td>通信保密性</td><td>明文泄露</td><td>TLS/CA、HBA <code>ssl/cert</code></td><td>强制 TLS</td></tr><tr><td>安全审计</td><td>无法追责</td><td>连接/DDL/慢查日志 + <code>pgaudit</code></td><td>日志留存</td></tr><tr><td>数据完整性</td><td>静默损坏</td><td><code>pg_checksum: true</code></td><td>-</td></tr><tr><td>数据备份恢复</td><td>数据丢失</td><td>pgBackRest + PITR</td><td>演练与验收</td></tr><tr><td>主机安全</td><td>主机被攻破</td><td>SELinux/防火墙</td><td>加固策略</td></tr><tr><td>边界安全</td><td>暴露入口</td><td>HAProxy/Nginx 统一入口</td><td>网络分区</td></tr><tr><td>安全管理制度</td><td>缺乏流程</td><td>-</td><td>制度与审批</td></tr></tbody></table><p><strong>提示</strong>：等保三级不仅是技术问题，还需要完善的制度与运维流程支撑。</p><hr><h2 id=合规加固配置片段>合规加固配置片段</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 强制 SSL / 证书</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;, db: all, addr: intra, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_dba, db: all, addr: world, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cert }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 密码强度</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;$libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>passwordcheck, credcheck ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PgBouncer / Patroni TLS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>require</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_ssl_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 操作系统安全</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_firewall_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zone</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_selinux_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>enforcing</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=合规检查清单>合规检查清单</h2><h3 id=部署前>部署前</h3><ul><li><input disabled type=checkbox> 网络分区与可信 CIDR 明确</li><li><input disabled type=checkbox> 证书策略确定（自签/企业 CA）</li><li><input disabled type=checkbox> 账号权限分级方案明确</li></ul><h3 id=部署后必做>部署后（必做）</h3><ul><li><input disabled type=checkbox> 修改所有默认密码</li><li><input disabled type=checkbox> 验证 HBA 规则符合预期</li><li><input disabled type=checkbox> 启用并验证 TLS</li><li><input disabled type=checkbox> 配置审计与日志留存策略</li></ul><h3 id=定期维护>定期维护</h3><ul><li><input disabled type=checkbox> 权限审计与账号清理</li><li><input disabled type=checkbox> 证书轮换</li><li><input disabled type=checkbox> 备份恢复演练</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>🔑 <a href=/docs/concept/sec/auth><strong>身份认证</strong></a>：HBA 与密码策略</li><li>🔒 <a href=/docs/concept/sec/data><strong>数据安全</strong></a>：备份与加密</li><li>♾️ <a href=/docs/concept/ha/><strong>高可用</strong></a>：业务连续性</li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>