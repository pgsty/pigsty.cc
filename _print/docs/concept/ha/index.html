<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/concept/ha/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/concept/ha/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>PG 高可用 | PIGSTY</title><meta name=description content="Pigsty 使用 Patroni 实现了 PostgreSQL 的高可用，确保主库不可用时自动进行故障转移，由从库接管。"><meta property="og:url" content="https://pigsty.cc/docs/concept/ha/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="PG 高可用"><meta property="og:description" content="Pigsty 使用 Patroni 实现了 PostgreSQL 的高可用，确保主库不可用时自动进行故障转移，由从库接管。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="PG 高可用"><meta itemprop=description content="Pigsty 使用 Patroni 实现了 PostgreSQL 的高可用，确保主库不可用时自动进行故障转移，由从库接管。"><meta itemprop=dateModified content="2026-02-09T18:41:01+08:00"><meta itemprop=wordCount content="173"><meta itemprop=keywords content="概念,PIGSTY,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="PG 高可用"><meta name=twitter:description content="Pigsty 使用 Patroni 实现了 PostgreSQL 的高可用，确保主库不可用时自动进行故障转移，由从库接管。"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/concept/ha/>返回本页常规视图</a>.</p></div><h1 class=title>PG 高可用</h1><div class=lead>Pigsty 使用 Patroni 实现了 PostgreSQL 的高可用，确保主库不可用时自动进行故障转移，由从库接管。</div><ul><li>1: <a href=#pg-928294eb73615de574523762c3a1ab07>RPO 利弊权衡</a></li><li>2: <a href=#pg-95882b9440d286103890671f368774b6>RTO 利弊权衡</a></li><li>3: <a href=#pg-439a629138018b9fe8b5a1c8323745be>故障切换模型</a></li><ul><li>3.1: <a href=#pg-358e309cdbb4cb46571e2cba4875ac34>被动故障切换</a></li><li>3.2: <a href=#pg-42b7950723c66bacccc650303281acc3>主动故障检测</a></li></ul><li>4: <a href=#pg-895a94576239d65b824c6e6ae06deb76>服务接入</a></li></ul><div class=content><hr><h2 id=概览>概览</h2><p>Pigsty 的 PostgreSQL 集群带有开箱即用的高可用方案，由 <a href=https://patroni.readthedocs.io/en/latest/><strong>Patroni</strong></a>、<a href=https://etcd.io/><strong>Etcd</strong></a> 和 <a href=http://www.haproxy.org/><strong>HAProxy</strong></a> 强力驱动。</p><p>当您的 PostgreSQL 集群含有两个或更多实例时，您无需任何配置即拥有了硬件故障自愈的数据库高可用能力 —— 只要集群中有任意实例存活，集群就可以对外提供完整的服务，而客户端只要连接至集群中的任意节点，即可获得完整的服务，而无需关心主从拓扑变化。</p><p>在默认配置下，主库故障恢复时间目标 RTO ≈ 45s，数据恢复点目标 RPO &lt; 1MB；从库故障 RPO = 0，RTO ≈ 0 (闪断)；在一致性优先模式下，可确保故障切换数据零损失：
RPO = 0。以上指标均可通过参数，根据您的实际硬件条件与可靠性要求 <a href=/docs/concept/ha/rto><strong>按需配置</strong></a>。</p><p>Pigsty 内置了 HAProxy 负载均衡器用于自动流量切换，提供 DNS/VIP/LVS 等多种接入方式供客户端选用。故障切换与主动切换对业务侧除零星闪断外几乎无感知，应用不需要修改连接串重启。
极小的维护窗口需求带来了极大的灵活便利：您完全可以在无需应用配合的情况下滚动维护升级整个集群。硬件故障可以等到第二天再抽空善后处置的特性，让研发，运维与 DBA 都能在故障时安心睡个好觉。</p><p><del><img src=/img/pigsty/ha.png alt=pigsty-ha></del></p><p>许多大型组织与核心机构已经在生产环境中长时间使用 Pigsty ，最大的部署有 25K CPU 核心与 220+ PostgreSQL 超大规格实例（64c / 512g / 3TB NVMe SSD）；在这一部署案例中，五年内经历了数十次硬件故障与各类事故，但依然可以保持高于 <strong>99.999%</strong> 的总体可用性战绩。</p><hr><p><strong>高可用（High-Availability）解决什么问题？</strong></p><ul><li>将数据安全C/IA中的可用性提高到一个新高度：RPO ≈ 0, RTO &lt; 45s。</li><li>获得无缝滚动维护的能力，最小化维护窗口需求，带来极大便利。</li><li>硬件故障可以立即自愈，无需人工介入，运维DBA可以睡个好觉。</li><li>从库可以用于承载只读请求，分担主库负载，让资源得以充分利用。</li></ul><p><strong>高可用有什么代价？</strong></p><ul><li>基础设施依赖：高可用需要依赖 DCS (etcd/zk/consul) 提供共识。</li><li>起步门槛增加：一个有意义的高可用部署环境至少需要 <strong>三个节点</strong>。</li><li>额外的资源消耗：一个新从库就要消耗一份额外资源，不算大问题。</li><li>复杂度代价显著升高：备份成本显著加大，需要使用工具压制复杂度。</li></ul><p><strong>高可用的局限性</strong></p><p>因为复制实时进⾏，所有变更被⽴即应⽤⾄从库。因此基于流复制的高可用方案⽆法应对⼈为错误与软件缺陷导致的数据误删误改。（例如：<code>DROP TABLE</code>，或 <code>DELETE</code> 数据）
此类故障需要使用 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4><strong>延迟集群</strong></a>，或使用先前的基础备份与 WAL 归档进行 <a href=/docs/concept/pitr><strong>时间点恢复</strong></a>。</p><table><thead><tr><th style=text-align:left>配置策略</th><th>RTO</th><th style=text-align:left>RPO</th></tr></thead><tbody><tr><td style=text-align:left>单机 + <i class="fa-solid fa-music text-danger"></i> 什么也不做</td><td><i class="fas fa-circle-xmark text-danger"></i> <strong>数据永久丢失，无法恢复</strong></td><td style=text-align:left><i class="fas fa-circle-xmark text-danger"></i> <strong>数据全部丢失</strong></td></tr><tr><td style=text-align:left>单机 + <i class="fa-solid fa-copy text-secondary"></i> 基础备份</td><td><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 取决于备份大小与带宽（几小时）</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 丢失上一次备份后的数据（几个小时到几天）</td></tr><tr><td style=text-align:left>单机 + <i class="fa-solid fa-copy text-primary"></i> 基础备份 + <i class="fa-solid fa-clock-rotate-left text-primary"></i> WAL归档</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> 取决于备份大小与带宽（几小时）</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-primary"></i> 丢失最后尚未归档的数据（几十MB）</td></tr><tr><td style=text-align:left>主从 + <i class="fa-solid fa-wrench text-secondary"></i> 手工故障切换</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> 十分钟</td><td style=text-align:left><i class="fa-solid fa-circle-check text-primary"></i> 丢失复制延迟中的数据（约百KB）</td></tr><tr><td style=text-align:left>主从 + <i class="fa-solid fa-infinity text-primary"></i> 自动故障切换</td><td><i class="fa-solid fa-circle-check text-primary"></i> 一分钟内</td><td style=text-align:left><i class="fa-solid fa-circle-check text-primary"></i> 丢失复制延迟中的数据（约百KB）</td></tr><tr><td style=text-align:left>主从 + <i class="fa-solid fa-infinity text-primary"></i> 自动故障切换 + <i class="fa-solid fa-rotate text-success"></i> 同步提交</td><td><i class="fa-solid fa-circle-check text-success"></i> 一分钟内</td><td style=text-align:left><i class="fa-solid fa-circle-check text-success"></i> 无数据丢失</td></tr></tbody></table><hr><h2 id=原理>原理</h2><p>在 Pigsty 中，高可用架构的实现原理如下：</p><ul><li>PostgreSQL 使⽤标准流复制搭建物理从库，主库故障时由从库接管。</li><li>Patroni 负责管理 PostgreSQL 服务器进程，处理高可用相关事宜。</li><li>Etcd 提供分布式配置存储（DCS）能力，并用于故障后的领导者选举</li><li>Patroni 依赖 Etcd 达成集群领导者共识，并对外提供健康检查接口。</li><li>HAProxy 对外暴露集群服务，并利⽤ Patroni 健康检查接口，自动分发流量至健康节点。</li><li>vip-manager 提供一个可选的二层 VIP，从 Etcd 中获取领导者信息，并将 VIP 绑定在集群主库所在节点上。</li></ul><p>当主库故障时，将触发新一轮领导者竞选，集群中最为健康的从库将胜出（LSN位点最高，数据损失最小者），并被提升为新的主库。 胜选从库提升后，读写流量将立即路由至新的主库。
主库故障影响是 <strong>写服务短暂不可用</strong>：从主库故障到新主库提升期间，写入请求将被阻塞或直接失败，不可用时长通常在 15秒 ～ 30秒，通常不会超过 1 分钟。</p><p>当从库故障时，只读流量将路由至其他从库，如果所有从库都故障，只读流量才会最终由主库承载。
从库故障的影响是 <strong>部分只读查询闪断</strong>：当前从库上正在运行查询将由于连接重置而中止，并立即由其他可用从库接管。</p><p>故障检测由 Patroni 和 Etcd 共同完成，集群领导者将持有一个租约，
如果集群领导者因为故障而没有及时续租（10s），租约将会被释放，并触发 <strong>故障切换</strong>（Failover） 与新一轮集群选举。</p><p>即使没有出现任何故障，您依然可以主动通过 <a href=/docs/pgsql/admin/patroni#%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2><strong>主动切换</strong></a>（Switchover）变更集群的主库。
在这种情况下，主库上的写入查询将会闪断，并立即路由至新主库执行。这一操作通常可用于滚动维护/升级数据库服务器。</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-928294eb73615de574523762c3a1ab07>1 - RPO 利弊权衡</h1><div class=lead>针对 RPO （Recovery Point Objective）进行利弊权衡，在可用性与数据损失之间找到最佳平衡点。</div><p><strong>RPO</strong>（Recovery Point Objective，恢复点目标）定义了在主库发生故障时，<strong>允许丢失的最大数据量</strong>。</p><p>对于金融交易这类数据完整性至关重要的场景，通常要求 RPO = 0，即不允许任何数据丢失；</p><p>然而更为严格的 RPO 指标是有代价的，它会引入更高的写入延迟，降低系统吞吐量，并且存在从库故障导致主库不可用的风险。
因此对于常规场景，通常可以接受一定量的数据丢失（例如允许丢失不超过 1MB 的数据），以换取更高的可用性与性能。</p><hr><h2 id=利弊权衡>利弊权衡</h2><p>通常在异步复制场景下，从库和主库之间会存在一定的复制延迟（取决于网络和吞吐量，正常在 10KB-100KB / 100µs-10ms 的数量级），
这意味着当主库发生故障时，从库可能还没有完全同步主库的最新数据。这时候如果出现故障切换，新的主库可能会丢失一些尚未复制的数据。</p><p>潜在数据丢失量的上限由 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> 参数控制，默认为 <code>1048576</code> （<code>1MB</code>），这意味着在故障转移期间最多可以容忍 1MiB 的数据丢失。</p><p>当集群主库宕机时，如果有任何一个从库的复制延迟在这个值以内，Pigsty 将自动提升该从库为新的主库。
然而当所有从库副本的复制延迟都超出这个阈值时，Pigsty 将拒绝进行 [<strong>自动故障切换</strong>] 以避免数据丢失。
此时需要人工介入进行决策 —— 等待主库恢复（可能永远也不会恢复），还是接受数据损失并强制提升一个从库为新的主库。</p><p>您需要根据业务的需求偏好配置这个值，在 <strong>可用性</strong> 和 <strong>一致性</strong> 之间进行 <strong>利弊权衡</strong>。
增大这个值可以提高自动故障切换的成功率，但也会增加潜在的数据丢失量上限。</p><p>当您指定 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> = 0 时，Pigsty 将启用 <strong>同步复制</strong>，确保主库在确认至少一个从库持久化数据后才返回写入成功。
这种配置能确保没有复制延迟，但会带来显著的写入延迟，并降低整体的吞吐量。</p><pre class=mermaid>flowchart LR
    A([主库故障]) --&gt; B{同步复制?}

    B --&gt;|否| C{延迟 &lt; RPO?}
    B --&gt;|是| D{同步从库&lt;br/&gt;可用?}

    C --&gt;|是| E[有损自动故障切换&lt;br/&gt;RPO &lt; 1MB]
    C --&gt;|否| F[拒绝自动切换&lt;br/&gt;等待主库恢复&lt;br/&gt;或人工介入决策]

    D --&gt;|是| G[无损自动故障切换&lt;br/&gt;RPO = 0]
    D --&gt;|否| H{严格模式?}

    H --&gt;|否| C
    H --&gt;|是| F

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#F0AD4E,stroke:#146c43,color:#fff
    style G fill:#198754,stroke:#146c43,color:#fff
    style F fill:#BE002F,stroke:#565e64,color:#fff</pre><hr><h2 id=保护模式>保护模式</h2><p>Pigsty 提供三种保护模式，以帮助用户在不同的 RPO 要求下进行利弊权衡，类似于 <a href=https://docs.oracle.com/en/database/oracle/oracle-database/21/sbydb/oracle-data-guard-protection-modes.html><strong>Oracle Data Guard</strong></a> 的数据保护模式。</p><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>最大性能（Maximum Performance）</div><ul><li><strong>默认模式</strong>，异步复制，事务提交仅需本地 WAL 持久化，无需等待从库，从库故障对主库完全透明，不影响服务</li><li>主库故障时可能丢失尚未发送/接收的 WAL（通常 &lt; 1MB，正常网络条件通常在 10ms/100ms，10KB/100KB 量级）</li><li>针对性能优化，适用于常规业务场景，容许在故障时损失少量数据。</li></ul></div><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>最大可用性（Maximum Availability）</div><ul><li>配置有 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo = 0</code></strong></a>，启用 Patroni 同步提交模式： <code>synchronous_mode: true</code></li><li>正常情况下等待至少一个从库确认，实现零数据丢失。当 <strong>所有</strong> 同步从库故障时，<strong>自动降级为异步模式继续服务</strong></li><li>兼顾数据安全与服务可用性，是生产环境 <strong>核心业务</strong> 的推荐配置</li></ul></div><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>最大保护（Maximum Protection）</div><ul><li>使用 <code>crit.yml</code> 模板，启用 Patroni 严格同步模式：<code>synchronous_mode: true</code> / <code>synchronous_mode_strict: true</code></li><li>当所有同步从库故障时，<strong>主库将拒绝写入</strong>以防止数据丢失，事务必须在至少一个从库持久化后才返回成功。</li><li>适用于金融交易、医疗记录等对数据完整性要求极高的场景</li></ul></div><table class=full-width><thead><tr><th style=text-align:left><strong>名称</strong></th><th style=text-align:center><strong>最大性能</strong> Performance</th><th style=text-align:center><strong>最大可用</strong> Availability</th><th style=text-align:center><strong>最大保护</strong> Protection</th></tr></thead><tbody><tr><td style=text-align:left><strong>复制方式</strong></td><td style=text-align:center><strong>异步复制</strong></td><td style=text-align:center><strong>同步复制</strong></td><td style=text-align:center><strong>严格同步复制</strong></td></tr><tr><td style=text-align:left><strong>数据丢失</strong></td><td style=text-align:center><span class=text-danger><strong>可能丢失</strong></span>（复制延迟量）</td><td style=text-align:center><span class=text-primary><strong>正常零丢失，降级少量丢失</strong></span></td><td style=text-align:center><span class=text-success><strong>零丢失</strong></span></td></tr><tr><td style=text-align:left><strong>主库写延迟</strong></td><td style=text-align:center><span class=text-success><strong>最低</strong></span></td><td style=text-align:center><span class=text-warning><strong>中等</strong></span>（+1 次网络往返）</td><td style=text-align:center><span class=text-warning><strong>中等</strong></span>（+1 次网络往返）</td></tr><tr><td style=text-align:left><strong>吞吐量</strong></td><td style=text-align:center><span class=text-success><strong>最高</strong></span></td><td style=text-align:center><span class=text-warning><strong>降低</strong></span></td><td style=text-align:center><span class=text-warning><strong>降低</strong></span></td></tr><tr><td style=text-align:left><strong>从库故障影响</strong></td><td style=text-align:center><span class=text-success><strong>无影响</strong></span></td><td style=text-align:center><span class=text-primary><strong>自动降级，继续服务</strong></span></td><td style=text-align:center><span class=text-danger><strong>主库停写</strong></span></td></tr><tr><td style=text-align:left><strong>RPO</strong></td><td style=text-align:center><span class=text-warning><strong>&lt; 1MB</strong></span></td><td style=text-align:center><span class=text-primary><strong>= 0（正常）/ &lt; 1MB（降级）</strong></span></td><td style=text-align:center><span class=text-success><strong>= 0</strong></span></td></tr><tr><td style=text-align:left><strong>适用场景</strong></td><td style=text-align:center>常规业务、性能优先</td><td style=text-align:center>重要业务、安全优先</td><td style=text-align:center>金融核心、安全合规第一</td></tr><tr><td style=text-align:left><strong>配置方法</strong></td><td style=text-align:center>默认配置</td><td style=text-align:center><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> = <code>0</code></td><td style=text-align:center><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>: <code>crit.yml</code></td></tr></tbody></table><hr><h2 id=实现原理>实现原理</h2><p>三种保护模式的区别在于 <strong>Patroni</strong> 的两个核心参数：<a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-mode><strong><code>synchronous_mode</code></strong></a> 与 <a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-mode><strong><code>synchronous_mode_strict</code></strong></a> 如何配置：</p><ul><li><strong><code>synchronous_mode</code></strong>：Patroni 是否启用同步复制，如果启用，再看 <strong><code>synchronous_mode_strict</code></strong> 是否启用严格同步模式。</li><li><strong><code>synchronous_mode_strict = false</code></strong>，默认配置，允许当从库故障时降级为异步模式，<strong>主库继续服务</strong>（最大可用性）</li><li><strong><code>synchronous_mode_strict = true</code></strong>，禁止降级，<strong>主库停止写入</strong>直到同步从库恢复（最大保护）</li></ul><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center><strong><code>synchronous_mode</code></strong></th><th style=text-align:center><strong><code>synchronous_mode_strict</code></strong></th><th>复制模式</th><th style=text-align:left>从库故障行为</th></tr></thead><tbody><tr><td style=text-align:center><strong>最大性能</strong></td><td style=text-align:center><span class=text-danger><strong><code>false</code></strong></span></td><td style=text-align:center>-</td><td><strong>异步复制</strong></td><td style=text-align:left><span class=text-success><strong>无影响</strong></span></td></tr><tr><td style=text-align:center><strong>最大可用</strong></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td style=text-align:center><span class=text-danger><strong><code>false</code></strong></span></td><td><strong>同步复制</strong></td><td style=text-align:left><span class=text-primary><strong>自动降级为异步</strong></span></td></tr><tr><td style=text-align:center><strong>最大保护</strong></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td><strong>严格同步复制</strong></td><td style=text-align:left><span class=text-danger><strong>主库拒绝写入</strong></span></td></tr></tbody></table><p>通常情况下，您只需要将 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> 参数设置为 <code>0</code>，即可打开 <code>synchronous_mode</code> 开关，启用 <strong>最大可用性模式</strong>。
如果您使用 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <a href=/docs/pgsql/template/crit><strong><code>crit.yml</code></strong></a> 模板，则会同时额外打开 <code>synchronous_mode_strict</code> 严格模式开关，启用 <strong>最大保护模式</strong>。
此外，您可以启用 <a href=/docs/pgsql/param#patroni_watchdog_mode><strong>watchdog</strong></a>，在节点/Patroni 假死场景下直接 Fencing 主库而不是降级，实现与 Oracle 最大保护模式相同的行为表现</p><p>当然，您可以直接按需 <a href=/docs/pgsql/admin/patroni#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong>配置</strong></a> 这些 Patroni 参数，您还可以参阅 Patroni 与 PostgreSQL 文档，通过配置实现更强的数据保护，例如：</p><ul><li>可以指定指定 <a href=/docs/pgsql/config/cluster#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4><strong>同步从库列表</strong></a>，配置更多同步从库以提高容灾能力，使用法定人数同步，甚至要求所有从库都执行同步提交。</li><li>您可以 <a href=/docs/pgsql/admin/patroni#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong>配置</strong></a> <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT><strong><code>synchronous_commit</code></strong></a>: <code>'remote_apply'</code>，严格确保主从读写一致性。（Oracle 最大保护模式相当于 <code>remote_write</code>）</li></ul><hr><h2 id=配置建议>配置建议</h2><p><strong>最大性能模式</strong>（异步复制）是 Pigsty 默认使用的模式，对于绝大多数业务来说已经足够使用。
容许故障时丢失少量数据（正常在 几KB - 几百KB 的数量级），换来更大的性能吞吐量与服务可用性水平，是常规业务场景的推荐配置。
在这种情况下，您可以通过 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> 参数调整允许的最大数据丢失量，以适应不同的业务需求。</p><p><strong>最大可用性模式</strong>（同步复制）适用于对据完整性要求高的场景，不允许数据丢失。
在这种模式下，最少需要一主一从的两节点 PostgreSQL 集群才有意义。
将 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> 设置为 0 即可启用该模式。</p><p><strong>最大保护模式</strong> （严格同步复制） 适用于金融交易、医疗记录等对数据完整性要求极高的场景，我们建议至少使用一主二从的三节点集群，
因为两节点的情况下，只要从库故障，主库就会停止写入，导致业务不可用，这会降低系统的整体可靠性。而三节点的规格下，如果只有一个从库故障，主库仍然可以继续服务。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-95882b9440d286103890671f368774b6>2 - RTO 利弊权衡</h1><div class=lead>针对 RTO （Recovery Time Objective）进行利弊权衡，在故障恢复速度与误切风险之间找到最佳平衡点。</div><p><strong>RTO</strong>（Recovery Time Objective，恢复时间目标）定义了在主库发生故障时，<strong>系统恢复写入能力所需的最长时间</strong>。</p><p>对于核心交易系统这类可用性至关重要的场景，通常要求 RTO 尽可能短，例如一分钟内。</p><p>然而更短的 RTO 指标是有代价的，它会增加误切风险：网络抖动可能被误判为故障，导致不必要的故障切换。
因此对于跨机房/跨地域部署的场景，通常需要放宽 RTO 要求（例如 1-2 分钟），以降低误切风险。</p><hr><h2 id=利弊权衡>利弊权衡</h2><p>故障切换时的不可用时长上限由 <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> 参数控制。Pigsty 提供了四种预设的 RTO 模式：
<code>fast</code>、<code>norm</code>、<code>safe</code>、<code>wide</code>，分别针对不同的网络条件与部署场景进行了优化，默认使用 <code>norm</code> 模式（约 45 秒）。
您也可以使用秒数直接指定 RTO 上限，系统会自动映射到最接近的模式。</p><p>当主库发生故障时，整个恢复流程涉及多个阶段：Patroni 检测故障、DCS 锁过期、新主选举、执行 promote、HAProxy 感知新主。
减小 RTO 意味着缩短各阶段的超时时间，这会使集群对网络抖动更加敏感，从而增加误切风险。</p><p>您需要根据实际网络条件选择合适的模式，在 <strong>恢复速度</strong> 与 <strong>误切风险</strong> 之间取得平衡。
网络质量越差，越应该选择保守的模式；网络质量越好，越可以选择激进的模式。</p><pre class=mermaid>flowchart LR
    A([主库故障]) --&gt; B{Patroni&lt;br/&gt;检测到?}

    B --&gt;|PG崩溃| C[尝试本地重启]
    B --&gt;|节点宕机| D[等待 TTL 过期]

    C --&gt;|成功| E([本地恢复])
    C --&gt;|失败/超时| F[释放 Leader 锁]

    D --&gt; F
    F --&gt; G[从库竞选]
    G --&gt; H[执行 Promote]
    H --&gt; I[HAProxy 感知]
    I --&gt; J([服务恢复])

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#198754,stroke:#146c43,color:#fff
    style J fill:#198754,stroke:#146c43,color:#fff</pre><hr><h2 id=四种模式>四种模式</h2><p>Pigsty 提供四种 RTO 模式，以帮助用户在不同的网络条件下进行利弊权衡。</p><table class=full-width><thead><tr><th style=text-align:left><strong>名称</strong></th><th style=text-align:center><strong>fast</strong></th><th style=text-align:center><strong>norm</strong></th><th style=text-align:center><strong>safe</strong></th><th style=text-align:center><strong>wide</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>适用场景</strong></td><td style=text-align:center>同机柜</td><td style=text-align:center>同机房内（默认）</td><td style=text-align:center>同省跨机房</td><td style=text-align:center>跨地域/跨洲</td></tr><tr><td style=text-align:left><strong>网络条件</strong></td><td style=text-align:center>&lt; 1ms，极稳定</td><td style=text-align:center>1-5ms，正常</td><td style=text-align:center>10-50ms，跨机房</td><td style=text-align:center>100-200ms，公网</td></tr><tr><td style=text-align:left><strong>目标 RTO</strong></td><td style=text-align:center><span class=text-success><strong>30s</strong></span></td><td style=text-align:center><span class=text-primary><strong>45s</strong></span></td><td style=text-align:center><span class=text-warning><strong>90s</strong></span></td><td style=text-align:center><span class=text-danger><strong>150s</strong></span></td></tr><tr><td style=text-align:left><strong>误切风险</strong></td><td style=text-align:center><span class=text-secondary><strong>较高</strong></span></td><td style=text-align:center><span class=text-primary><strong>中等</strong></span></td><td style=text-align:center><span class=text-success><strong>较低</strong></span></td><td style=text-align:center><span class=text-success><strong>极低</strong></span></td></tr><tr><td style=text-align:left><strong>配置方法</strong></td><td style=text-align:center><code>pg_rto: fast</code></td><td style=text-align:center><code>pg_rto: norm</code></td><td style=text-align:center><code>pg_rto: safe</code></td><td style=text-align:center><code>pg_rto: wide</code></td></tr></tbody></table><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>fast：同机柜/同交换机</div><ul><li>适用于网络延迟极低（&lt; 1ms）且非常稳定的场景，例如同机柜或同交换机部署</li><li>平均 RTO: <strong>14s</strong>，最坏情况: <strong>29s</strong>，TTL 仅 20s，检测间隔 5s</li><li>对网络质量要求最高，任何抖动都可能触发切换，<strong>误切风险较高</strong></li></ul></div><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>norm：同机房（默认）</div><ul><li><strong>默认模式</strong>，适用于同机房部署，网络延迟 1-5ms，质量正常，丢包率合理</li><li>平均 RTO: <strong>21s</strong>，最坏情况: <strong>43s</strong>，TTL 为 30s，提供合理的容错窗口</li><li>平衡了恢复速度与稳定性，适合绝大多数生产环境</li></ul></div><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>safe：同省跨机房</div><ul><li>适用于同省/同区域跨机房部署，网络延迟 10-50ms，可能存在偶发抖动</li><li>平均 RTO: <strong>43s</strong>，最坏情况: <strong>91s</strong>，TTL 为 60s，更长的容错窗口</li><li>主库重启等待时间较长（60s），给予更多本地恢复机会，<strong>误切风险较低</strong></li></ul></div><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>wide：跨地域/跨洲</div><ul><li>适用于跨地域甚至跨大洲部署，网络延迟 100-200ms，可能有公网级别的丢包率</li><li>平均 RTO: <strong>92s</strong>，最坏情况: <strong>207s</strong>，TTL 为 120s，极宽的容错窗口</li><li>牺牲恢复速度换取极低的误切率，适合异地容灾场景</li></ul></div><hr><h2 id=rto时序图>RTO时序图</h2><p>Patroni / PG HA 有两条关键故障路径：<strong>主动故障检测</strong>（PG崩溃后 Patroni 检测到并尝试重启）与 <strong>被动租约过期</strong>（节点宕机后等待 TTL 过期触发选举）。</p><div id=echarts-f7a37f58f1c9d1582ba355a860f3971a class="echarts-container td-max-width-on-larger-screens" style=height:820px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-f7a37f58f1c9d1582ba355a860f3971a");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:110,right:24,top:40},legend:{data:["租约过期","故障检测","重启超时","从库检测","抢锁提拔","健康检查"],itemGap:10,top:0},series:[{barWidth:16,data:[120,110,100,"-","-","-","-",60,55,50,"-","-","-","-",30,27,25,"-","-","-","-",20,17,15,"-","-","-"],emphasis:{focus:"series"},itemStyle:{color:"#e15759"},name:"租约过期",stack:"main",type:"bar",z:2},{data:["-","-","-",20,10,0,"-","-","-","-",10,5,0,"-","-","-","-",5,3,0,"-","-","-","-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#b07aa1"},name:"故障检测",stack:"main",type:"bar",z:2},{data:["-","-","-",95,95,0,"-","-","-","-",45,45,0,"-","-","-","-",25,25,0,"-","-","-","-",15,15,0],emphasis:{focus:"series"},itemStyle:{color:"#f28e2c"},name:"重启超时",stack:"main",type:"bar",z:2},{data:[20,10,0,20,10,0,"-",10,5,0,10,5,0,"-",5,3,0,5,3,0,"-",5,3,0,5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"从库检测",stack:"main",type:"bar",z:2},{data:[2,1,0,2,1,0,"-",2,1,0,2,1,0,"-",2,1,0,2,1,0,"-",2,1,0,2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"抢锁提拔",stack:"main",type:"bar",z:2},{data:[8,6,4,8,6,4,"-",6,5,3,6,5,3,"-",4,3,2,4,3,2,"-",2,2,1,2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"健康检查",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:16,data:[150,127,104,145,122,4,"-",78,66,53,73,61,3,"-",41,34,27,41,35,2,"-",29,23,16,29,24,1],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO总计",type:"bar",z:1},{barGap:"-100%",barWidth:16,data:[150,150,150,150,150,150,"-",90,90,90,90,90,90,"-",45,45,45,45,45,45,"-",30,30,30,30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO预算",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"秒",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:9},axisLine:{show:!0},axisTick:{show:!0},data:["wide-passive-max","wide-passive-avg","wide-passive-min","wide-active-max","wide-active-avg","wide-active-min","","safe-passive-max","safe-passive-avg","safe-passive-min","safe-active-max","safe-active-avg","safe-active-min","","norm-passive-max","norm-passive-avg","norm-passive-min","norm-active-max","norm-active-avg","norm-active-min","","fast-passive-max","fast-passive-avg","fast-passive-min","fast-active-max","fast-active-avg","fast-active-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=实现原理>实现原理</h2><p>四种 RTO 模式的区别在于以下 10 个 <strong>Patroni</strong> 与 <strong>HAProxy</strong> HA 相关参数如何配置。</p><table class=full-width><thead><tr><th style=text-align:center>组件</th><th style=text-align:center>参数</th><th style=text-align:center><strong>fast</strong></th><th style=text-align:center><strong>norm</strong></th><th style=text-align:center><strong>safe</strong></th><th style=text-align:center><strong>wide</strong></th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>patroni</code></strong></td><td style=text-align:center><strong><code>ttl</code></strong></td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:center>60</td><td style=text-align:center>120</td><td style=text-align:left>Leader 锁生存时间（秒）</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>loop_wait</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>20</td><td style=text-align:left>HA 循环检查间隔（秒）</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>retry_timeout</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:left>DCS 操作重试超时（秒）</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>primary_start_timeout</code></strong></td><td style=text-align:center>15</td><td style=text-align:center>25</td><td style=text-align:center>45</td><td style=text-align:center>95</td><td style=text-align:left>主库重启等待时间（秒）</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>safety_margin</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>15</td><td style=text-align:left>Watchdog 安全边际（秒）</td></tr><tr><td style=text-align:center><strong><code>haproxy</code></strong></td><td style=text-align:center><strong><code>inter</code></strong></td><td style=text-align:center>1s</td><td style=text-align:center>2s</td><td style=text-align:center>3s</td><td style=text-align:center>4s</td><td style=text-align:left>正常状态检查间隔</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>fastinter</code></strong></td><td style=text-align:center>0.5s</td><td style=text-align:center>1s</td><td style=text-align:center>1.5s</td><td style=text-align:center>2s</td><td style=text-align:left>状态变化期检查间隔</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>downinter</code></strong></td><td style=text-align:center>1s</td><td style=text-align:center>2s</td><td style=text-align:center>3s</td><td style=text-align:center>4s</td><td style=text-align:left>DOWN 状态检查间隔</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>rise</code></strong></td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:left>标记 UP 所需连续成功次数</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>fall</code></strong></td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:left>标记 DOWN 所需连续失败次数</td></tr></tbody></table><h3 id=patroni-参数>Patroni 参数</h3><ul><li><strong><code>ttl</code></strong>：Leader 锁生存时间，主库须在此时间内续租，否则锁过期触发选举，直接决定被动故障的检测延迟。</li><li><strong><code>loop_wait</code></strong>：Patroni 主循环间隔，每个循环执行一次健康检查与状态同步，影响故障发现的及时性。</li><li><strong><code>retry_timeout</code></strong>：DCS 操作重试超时，网络分区时 Patroni 在此期间持续重试，超时后主库主动降级防止脑裂。</li><li><strong><code>primary_start_timeout</code></strong>：PG 崩溃后 Patroni 尝试本地重启的等待时间，超时后释放 Leader 锁触发切换。</li><li><strong><code>safety_margin</code></strong>：Watchdog 安全边际，确保故障时有足够时间触发系统重启，避免脑裂。</li></ul><h3 id=haproxy-参数>HAProxy 参数</h3><ul><li><strong><code>inter</code></strong>：正常状态下的健康检查间隔，服务状态稳定时使用。</li><li><strong><code>fastinter</code></strong>：状态变化期的检查间隔，检测到状态变化时使用更短间隔加速确认。</li><li><strong><code>downinter</code></strong>：DOWN 状态下的检查间隔，服务标记为 DOWN 后使用此间隔探测恢复。</li><li><strong><code>rise</code></strong>：标记 UP 所需连续成功次数，新主上线后需连续通过 <code>rise</code> 次检查才能接收流量。</li><li><strong><code>fall</code></strong>：标记 DOWN 所需连续失败次数，服务需连续失败 <code>fall</code> 次才会被标记为 DOWN。</li></ul><h3 id=关键约束>关键约束</h3><p><strong>Patroni 核心约束</strong>：确保主库能在 TTL 过期前完成降级，防止脑裂。</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi><mo>+</mo><mn>2</mn><mo>×</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>r</mi><mi>y</mi><mi mathvariant="normal">_</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mo>≤</mo><mi>t</mi><mi>t</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">loop\_wait + 2 \times retry\_timeout \leq ttl</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0044em;vertical-align:-.31em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord style=margin-right:.02778em>_</span><span class="mord mathnormal" style=margin-right:.02691em>w</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.9695em;vertical-align:-.31em></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.03588em>ry</span><span class=mord style=margin-right:.02778em>_</span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">eo</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≤</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6944em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span></span></span></span></span><hr><h2 id=数据汇总>数据汇总</h2><hr><h2 id=配置建议>配置建议</h2><p><strong>fast 模式</strong> 适用于对 RTO 要求极高的场景，但需要确保网络质量足够好（延迟 &lt; 1ms，极低丢包率）。
建议仅在同机柜或同交换机部署时使用，并在生产环境充分测试后再启用。</p><p><strong>norm 模式</strong>（<strong>默认</strong>）是 Pigsty 默认使用的配置，对于绝大多数同机房部署的业务来说已经足够使用。
平均 21 秒的恢复时间在可接受范围内，同时提供了合理的容错窗口，避免网络抖动导致的误切。</p><p><strong>safe 模式</strong> 适用于同城跨机房部署，网络延迟较高或存在偶发抖动的场景。
更长的容错窗口可以有效避免网络抖动导致的误切，是跨机房容灾的推荐配置。</p><p><strong>wide 模式</strong> 适用于跨地域甚至跨大洲部署，网络延迟高且可能存在公网级别的丢包率。
这种场景下，稳定性比恢复速度更重要，因此使用极宽的容错窗口来确保极低的误切率。</p><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center>目标RTO</th><th style=text-align:center>被动检测 RTO</th><th style=text-align:center>主动检测 RTO</th><th style=text-align:left>场景</th></tr></thead><tbody><tr><td style=text-align:center><code>fast</code></td><td style=text-align:center><code>30</code></td><td style=text-align:center><code>16</code> / <code>23</code> / <code>29</code></td><td style=text-align:center><code>1</code> / <code>24</code> / <code>29</code></td><td style=text-align:left>同交换机，高质量网络</td></tr><tr><td style=text-align:center><code>norm</code></td><td style=text-align:center><code>45</code></td><td style=text-align:center><code>27</code> / <code>34</code> / <code>41</code></td><td style=text-align:center><code>2</code> / <code>35</code> / <code>41</code></td><td style=text-align:left>默认，同机房，标准网络</td></tr><tr><td style=text-align:center><code>safe</code></td><td style=text-align:center><code>90</code></td><td style=text-align:center><code>53</code> / <code>66</code> / <code>78</code></td><td style=text-align:center><code>3</code> / <code>61</code> / <code>73</code></td><td style=text-align:left>同城双活 / 跨机房容灾</td></tr><tr><td style=text-align:center><code>wide</code></td><td style=text-align:center><code>150</code></td><td style=text-align:center><code>104</code> / <code>127</code> / <code>150</code></td><td style=text-align:center><code>4</code> / <code>122</code> / <code>145</code></td><td style=text-align:left>异地容灾 / 跨国部署</td></tr><tr><td style=text-align:center><code>default</code></td><td style=text-align:center><code>326</code></td><td style=text-align:center><code>22</code> / <code>34</code> / <code>46</code></td><td style=text-align:center><code>2</code> / <code>314</code> / <code>326</code></td><td style=text-align:left>Patroni 默认参数</td></tr></tbody></table><p>通常只需将 <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> 设为模式名称，Pigsty 会自动配置 Patroni 与 HAProxy 参数。
为了保持向后兼容性，Pigsty 仍然支持直接使用秒数配置 RTO，但效果相当于指定 <code>norm</code> 模式。</p><p>配置模式实际上是从 <a href=/docs/pgsql/param#pg_rto_plan><strong><code>pg_rto_plan</code></strong></a> 中加载对应参数集，您可以修改或覆盖此配置以实现自定义 RTO 策略。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-439a629138018b9fe8b5a1c8323745be>3 - 故障切换模型</h1><div class=lead>详细分析三种经典故障检测/恢复路径下，最差，最优，平均 RTO 的计算逻辑与结果</div><p>Patroni 故障按故障对象分类可以分为以下 10 类，按照检测路径不同，可以进一步归纳为五类，在本节内详细展开。</p><table class=full-width><thead><tr><th>#</th><th>故障场景</th><th>描述</th><th>最终走哪条路径</th></tr></thead><tbody><tr><td>1</td><td>PG 进程崩溃</td><td>crash、OOM killed</td><td><strong>主动检测</strong></td></tr><tr><td>2</td><td>PG 拒绝连接</td><td>max_connections</td><td><strong>主动检测</strong></td></tr><tr><td>3</td><td>PG 假活</td><td>进程在但无响应</td><td><strong>主动检测</strong> (检测超时)</td></tr><tr><td>4</td><td>Patroni 进程崩溃</td><td>kill -9、OOM</td><td><strong>被动检测</strong></td></tr><tr><td>5</td><td>Patroni 假活</td><td>进程在但卡住</td><td><strong>Watchdog</strong></td></tr><tr><td>6</td><td>节点宕机</td><td>断电、硬件故障</td><td><strong>被动检测</strong></td></tr><tr><td>7</td><td>节点假活</td><td>IO hang、CPU 饥饿</td><td><strong>Watchdog</strong></td></tr><tr><td>8</td><td>主库 ↔ DCS 网络中断</td><td>防火墙、交换机故障</td><td><strong>网络分区</strong></td></tr><tr><td>9</td><td>存储故障</td><td>磁盘坏、磁盘满、挂载失败</td><td><strong>主动检测</strong> 或 <strong>Watchdog</strong></td></tr><tr><td>10</td><td>手动切换</td><td>Switchover/Failover</td><td><strong>手动触发</strong></td></tr></tbody></table><p>但是在 RTO 计算上，最终所有故障都会收敛到两条路径上，本节深入探讨了这两种情况下的 RTO 上下限与均值。</p><ul><li><a href=/docs/concept/ha/failure/passive><strong>Patroni 失联后被动触发选举</strong></a>：</li><li><a href=/docs/concept/ha/failure/active><strong>Patroni 主动检测故障并切换</strong></a>:</li></ul><pre class=mermaid>flowchart LR
    A([主库故障]) --&gt; B{Patroni&lt;br/&gt;检测到?}

    B --&gt;|PG崩溃| C[尝试本地重启]
    B --&gt;|节点宕机| D[等待 TTL 过期]

    C --&gt;|成功| E([本地恢复])
    C --&gt;|失败/超时| F[释放 Leader 锁]

    D --&gt; F
    F --&gt; G[从库竞选]
    G --&gt; H[执行 Promote]
    H --&gt; I[HAProxy 感知]
    I --&gt; J([服务恢复])

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#198754,stroke:#146c43,color:#fff
    style J fill:#198754,stroke:#146c43,color:#fff</pre></div><div class=td-content style=page-break-before:always><h1 id=pg-358e309cdbb4cb46571e2cba4875ac34>3.1 - 被动故障切换</h1><div class=lead>节点宕机，导致领导者租约过期触发集群领导竞选的故障路径</div><div id=infographic-537dd2226714fc6c5830057e9f044ea1 class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-537dd2226714fc6c5830057e9f044ea1",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  title 租约过期故障切换流程
  desc 当整个节点宕机，Patroni 无法主动释放租约，只能等待 TTL 过期
  items
    - label 租约过期
      desc Patroni 失联，被动等待主库租约 TTL 过期
      icon mingcute/close-circle-fill
    - label 从库检测
      desc 从库从循环中醒来后发现租约过期，开始竞选
      icon mingcute/key-2-fill
    - label 抢锁提拔
      desc 从库相互比较并抢锁，胜利者提升自己的PG
      icon mingcute/radar-fill
    - label 健康检查
      desc HAPROXY 健康检查发现新主上线，分配流量
      icon mingcute/arrow-up-circle-fill
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-时序图>RTO 时序图</h2><div id=echarts-44d24210b099c2088232bbd8c2371226 class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-44d24210b099c2088232bbd8c2371226");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["租约过期","从库检测","抢锁提拔","健康检查"],itemGap:12,top:0},series:[{barWidth:20,data:[120,110,100,"-",60,55,50,"-",30,27,25,"-",20,17,15],emphasis:{focus:"series"},itemStyle:{color:"#e15759"},name:"租约过期",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"从库检测",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"抢锁提拔",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"健康检查",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[150,127,104,"-",78,66,53,"-",41,34,27,"-",29,23,16],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO总计",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO预算",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"秒",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=故障模型>故障模型</h2><table class=full-width><thead><tr><th style=text-align:center>项目</th><th style=text-align:center>最好</th><th style=text-align:center>最坏</th><th style=text-align:center>平均</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong>租约过期</strong></td><td style=text-align:center><code>ttl - loop</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:center><code>ttl - loop/2</code></td><td style=text-align:left>最好：即将刷新时宕机<br>最坏：刚刷新完就宕机</td></tr><tr><td style=text-align:center><strong>从库检测</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop / 2</code></td><td style=text-align:left>最好：恰好在检测点<br>最坏：刚错过检测点</td></tr><tr><td style=text-align:center><strong>抢锁提拔</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>最好：直接抢锁提升<br>最坏：API超时+Promote</td></tr><tr><td style=text-align:center><strong>健康检查</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>最好：检查前状态变化<br>最坏：检查后瞬间状态变化</td></tr></tbody></table><p><strong>被动故障与主动故障的核心区别</strong>：</p><table class=full-width><thead><tr><th style=text-align:center>场景</th><th style=text-align:center>Patroni 状态</th><th style=text-align:center>租约处理</th><th style=text-align:center>主要等待时间</th></tr></thead><tbody><tr><td style=text-align:center><strong>主动故障</strong>（PG崩溃）</td><td style=text-align:center>存活，健康</td><td style=text-align:center>主动尝试重启 PG，超时后释放租约</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>被动故障</strong>（节点宕机）</td><td style=text-align:center>随节点一起死亡</td><td style=text-align:center>无法主动释放，只能等待 TTL 过期</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>在被动故障场景中，Patroni 随节点一起宕机，<strong>无法主动释放 Leader Key</strong>。
DCS 中的租约只能等待 TTL 自然过期后触发集群选举。</p><hr><h2 id=时序分析>时序分析</h2><h3 id=阶段-1租约过期>阶段 1：租约过期</h3><p>Patroni 主库会在每个 <code>loop_wait</code> 周期刷新 Leader Key，将 TTL 重置为配置值。</p><pre tabindex=0><code>时间线：
     t-loop        t          t+ttl-loop    t+ttl
       |           |              |           |
    上次刷新    故障发生        最好情况      最坏情况
       |←── loop ──→|              |           |
       |←──────────── ttl ─────────────────────→|
</code></pre><ul><li><strong>最好情况</strong>：故障发生在即将刷新租约之前（距上次刷新已过 <code>loop</code>），剩余 TTL = <code>ttl - loop</code></li><li><strong>最坏情况</strong>：故障发生在刚刷新租约之后，需等待完整 <code>ttl</code></li><li><strong>平均情况</strong>：<code>ttl - loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mi>i</mi><mi>r</mi><mi>e</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{expire} = \begin{cases}
ttl - loop &amp; \text{最好} \\
ttl - loop/2 &amp; \text{平均} \\
ttl &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-2从库检测>阶段 2：从库检测</h3><p>从库在 <code>loop_wait</code> 周期醒来后检查 DCS 中的 Leader Key 状态。</p><pre tabindex=0><code>时间线：
    租约过期      从库醒来
       |            |
       |←── 0~loop ─→|
</code></pre><ul><li><strong>最好情况</strong>：租约过期时从库恰好醒来，等待 <code>0</code></li><li><strong>最坏情况</strong>：租约过期后从库刚进入睡眠，等待 <code>loop</code></li><li><strong>平均情况</strong>：<code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{最好} \\
loop/2 &amp; \text{平均} \\
loop &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-3抢锁提拔>阶段 3：抢锁提拔</h3><p>从库发现 Leader Key 过期后，开始竞选过程，获得 Leader Key 的从库执行 <code>pg_ctl promote</code>，将自己提升为新主库。</p><ol><li>通过 Rest API，并行发起查询，查询各从库的复制位置，通常 10ms，硬编码 2 秒超时。</li><li>比较 WAL 位置，确定最优候选，各从库尝试创建 Leader Key（CAS 原子操作）</li><li>执行 <code>pg_ctl promote</code> 提升自己为主库（很快，通常忽略不计）</li></ol><pre tabindex=0><code>选举流程：
  从库A ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 成功
  从库B ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 失败
</code></pre><ul><li><strong>最好情况</strong>：单从库或直接抢到锁并提升，常数开销 <code>0.1s</code></li><li><strong>最坏情况</strong>：DCS API 调用超时：<code>2s</code></li><li><strong>平均情况</strong>：<code>1s</code> 常数开销</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{最好} \\
1 &amp; \text{平均} \\
2 &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-4健康检查>阶段 4：健康检查</h3><p>HAProxy 检测新主库上线，需要连续 <code>rise</code> 次健康检查成功。</p><pre tabindex=0><code>检测时序：
  新主提升    首次检查    第二次检查   第三次检查（UP）
     |          |           |           |
     |←─ 0~inter ─→|←─ fast ─→|←─ fast ─→|
</code></pre><ul><li><strong>最好情况</strong>：新主提升时恰好赶上检查，<code>(rise-1) × fastinter</code></li><li><strong>最坏情况</strong>：新主提升后刚错过检查，<code>(rise-1) × fastinter + inter</code></li><li><strong>平均情况</strong>：<code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{最好} \\
(rise-1) \times fastinter + inter/2 &amp; \text{平均} \\
(rise-1) \times fastinter + inter &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-公式>RTO 公式</h2><p>将各阶段时间相加，得到总 RTO：</p><p><strong>最好情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = ttl - loop + 0.1 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>平均情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = ttl + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>最坏情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = ttl + loop + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=模型计算>模型计算</h2><p>将四种 RTO 模型的参数带入上面的公式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>四种模式计算结果</strong>（单位：秒，格式：min / avg / max）</p><table class=full-width><thead><tr><th style=text-align:center>阶段</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>租约过期</td><td style=text-align:center><code>15</code> / <code>17</code> / <code>20</code></td><td style=text-align:center><code>25</code> / <code>27</code> / <code>30</code></td><td style=text-align:center><code>50</code> / <code>55</code> / <code>60</code></td><td style=text-align:center><code>100</code> / <code>110</code> / <code>120</code></td></tr><tr><td style=text-align:center>从库检测</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>抢锁提拔</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>健康检查</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>总计</strong></td><td style=text-align:center><code>16</code> / <code>23</code> / <code>29</code></td><td style=text-align:center><code>27</code> / <code>34</code> / <code>41</code></td><td style=text-align:center><code>53</code> / <code>66</code> / <code>78</code></td><td style=text-align:center><code>104</code> / <code>127</code> / <code>150</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-42b7950723c66bacccc650303281acc3>3.2 - 主动故障检测</h1><div class=lead>PostgreSQL 主库进程崩溃，Patroni 存活并尝试重启，超时后触发故障切换的路径</div><div id=infographic-5a27087cd19651a30e413fd22489ae1b class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-5a27087cd19651a30e413fd22489ae1b",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  title 崩溃故障切换流程
  desc 当 Patroni 健康，但 PostgreSQL 因故崩溃时的故障切换流程
  items
    - label 故障检测
      desc Patroni 在循环中检测到 PG 崩溃
      icon mingcute/close-circle-fill
    - label 重启超时
      desc Patroni 尝试重启 PG，超时后释放租约
      icon mingcute/refresh-2-fill
    - label 从库检测
      desc 从库从循环中醒来发现租约释放，开始竞选
      icon mingcute/key-2-fill
    - label 抢锁提拔
      desc 从库相互比较并抢锁，胜利者提升自己的 PG
      icon mingcute/radar-fill
    - label 健康检查
      desc HAProxy 健康检查发现新主上线，分配流量
      icon mingcute/arrow-up-circle-fill
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-时序图>RTO 时序图</h2><div id=echarts-7566178edd3ee3c0901186f67235867f class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-7566178edd3ee3c0901186f67235867f");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["故障检测","重启超时","从库检测","抢锁提拔","健康检查"],itemGap:12,top:0},series:[{barWidth:20,data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#b07aa1"},name:"故障检测",stack:"main",type:"bar",z:2},{data:[95,95,0,"-",45,45,0,"-",25,25,0,"-",15,15,0],emphasis:{focus:"series"},itemStyle:{color:"#f28e2c"},name:"重启超时",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"从库检测",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"抢锁提拔",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"健康检查",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[145,122,4,"-",73,61,3,"-",41,35,2,"-",29,24,1],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO总计",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO预算",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"秒",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=故障模型>故障模型</h2><table class=full-width><thead><tr><th style=text-align:center>项目</th><th style=text-align:center>最好</th><th style=text-align:center>最坏</th><th style=text-align:center>平均</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong>故障检测</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>最好：PG 恰好在检测前崩溃<br>最坏：PG 刚检测完就崩溃</td></tr><tr><td style=text-align:center><strong>重启超时</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>start</code></td><td style=text-align:left>最好：PG 瞬间自愈<br>最坏：等满 start 超时才释放租约</td></tr><tr><td style=text-align:center><strong>从库检测</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>最好：恰好在检测点<br>最坏：刚错过检测点</td></tr><tr><td style=text-align:center><strong>抢锁提拔</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>最好：直接抢锁提升<br>最坏：API 超时 + Promote</td></tr><tr><td style=text-align:center><strong>健康检查</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>最好：检查前状态变化<br>最坏：检查后瞬间状态变化</td></tr></tbody></table><p><strong>主动故障与被动故障的核心区别</strong>：</p><table class=full-width><thead><tr><th style=text-align:center>场景</th><th style=text-align:center>Patroni 状态</th><th style=text-align:center>租约处理</th><th style=text-align:center>主要等待时间</th></tr></thead><tbody><tr><td style=text-align:center><strong>主动故障</strong>（PG 崩溃）</td><td style=text-align:center>存活，健康</td><td style=text-align:center>主动尝试重启 PG，超时后释放租约</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>被动故障</strong>（节点宕机）</td><td style=text-align:center>随节点一起死亡</td><td style=text-align:center>无法主动释放，只能等待 TTL 过期</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>在主动故障场景中，Patroni 仍然存活，能够<strong>主动检测到 PG 崩溃并尝试重启</strong>。
如果重启成功，服务自愈；如果超时仍未恢复，Patroni 会<strong>主动释放 Leader Key</strong>，触发集群选举。</p><hr><h2 id=时序分析>时序分析</h2><h3 id=阶段-1故障检测>阶段 1：故障检测</h3><p>Patroni 在每个 <code>loop_wait</code> 周期检查 PostgreSQL 状态（通过 <code>pg_isready</code> 或检查进程）。</p><pre tabindex=0><code>时间线：
    上次检测      PG崩溃      下次检测
       |           |           |
       |←── 0~loop ─→|          |
</code></pre><ul><li><strong>最好情况</strong>：PG 恰好在 Patroni 检测前崩溃，立即被发现，等待 <code>0</code></li><li><strong>最坏情况</strong>：PG 刚检测完就崩溃，需等待下一个周期，等待 <code>loop</code></li><li><strong>平均情况</strong>：<code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{最好} \\
loop/2 &amp; \text{平均} \\
loop &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-2重启超时>阶段 2：重启超时</h3><p>Patroni 检测到 PG 崩溃后，会尝试重启 PostgreSQL。此阶段有两种可能的结果：</p><pre tabindex=0><code>时间线：
  检测到崩溃     尝试重启     重启成功/超时
      |           |             |
      |←──── 0 ~ start ────────→|
</code></pre><p><strong>路径 A：自愈成功</strong>（最好情况）</p><ul><li>PG 成功重启，服务恢复</li><li>不触发故障切换，RTO 极短</li><li>等待时间：<code>0</code>（相对于 Failover 路径）</li></ul><p><strong>路径 B：需要 Failover</strong>（平均/最坏情况）</p><ul><li>等待 <code>primary_start_timeout</code> 超时后 PG 仍未恢复</li><li>Patroni 主动释放 Leader Key</li><li>等待时间：<code>start</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好（自愈成功）</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均（需要 Failover）</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{restart} = \begin{cases}
0 &amp; \text{最好（自愈成功）} \\
start &amp; \text{平均（需要 Failover）} \\
start &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.2806em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">res</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.02778em>r</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好（自愈成功）</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均（需要</span><span class=mord> Failover</span><span class="mord cjk_fallback">）</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><blockquote><p><strong>注意</strong>：平均情况假设需要进行故障切换。如果 PG 能够快速自愈，则整体 RTO 会大幅降低。</p></blockquote><h3 id=阶段-3从库检测>阶段 3：从库检测</h3><p>从库在 <code>loop_wait</code> 周期醒来后检查 DCS 中的 Leader Key 状态。当主库 Patroni 释放 Leader Key 后，从库发现后开始竞选。</p><pre tabindex=0><code>时间线：
    租约释放      从库醒来
       |            |
       |←── 0~loop ─→|
</code></pre><ul><li><strong>最好情况</strong>：租约释放时从库恰好醒来，等待 <code>0</code></li><li><strong>最坏情况</strong>：租约释放后从库刚进入睡眠，等待 <code>loop</code></li><li><strong>平均情况</strong>：<code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>b</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{standby} = \begin{cases}
0 &amp; \text{最好} \\
loop/2 &amp; \text{平均} \\
loop &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">an</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-4抢锁提拔>阶段 4：抢锁提拔</h3><p>从库发现 Leader Key 空缺后，开始竞选过程，获得 Leader Key 的从库执行 <code>pg_ctl promote</code>，将自己提升为新主库。</p><ol><li>通过 Rest API，并行发起查询，查询各从库的复制位置，通常 10ms，硬编码 2 秒超时。</li><li>比较 WAL 位置，确定最优候选，各从库尝试创建 Leader Key（CAS 原子操作）</li><li>执行 <code>pg_ctl promote</code> 提升自己为主库（很快，通常忽略不计）</li></ol><pre tabindex=0><code>选举流程：
  从库A ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 成功
  从库B ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 失败
</code></pre><ul><li><strong>最好情况</strong>：单从库或直接抢到锁并提升，常数开销 <code>0.1s</code></li><li><strong>最坏情况</strong>：DCS API 调用超时：<code>2s</code></li><li><strong>平均情况</strong>：<code>1s</code> 常数开销</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{最好} \\
1 &amp; \text{平均} \\
2 &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-5健康检查>阶段 5：健康检查</h3><p>HAProxy 检测新主库上线，需要连续 <code>rise</code> 次健康检查成功。</p><pre tabindex=0><code>检测时序：
  新主提升    首次检查    第二次检查   第三次检查（UP）
     |          |           |           |
     |←─ 0~inter ─→|←─ fast ─→|←─ fast ─→|
</code></pre><ul><li><strong>最好情况</strong>：新主提升时恰好赶上检查，<code>(rise-1) × fastinter</code></li><li><strong>最坏情况</strong>：新主提升后刚错过检查，<code>(rise-1) × fastinter + inter</code></li><li><strong>平均情况</strong>：<code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{最好} \\
(rise-1) \times fastinter + inter/2 &amp; \text{平均} \\
(rise-1) \times fastinter + inter &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-公式>RTO 公式</h2><p>将各阶段时间相加，得到总 RTO：</p><p><strong>最好情况</strong>（PG 瞬间自愈）</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>≈</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = 0 + 0 + 0 + 0.1 + (rise-1) \times fastinter \approx (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>平均情况</strong>（需要 Failover）</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = loop + start + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>最坏情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>×</mo><mn>2</mn><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = loop \times 2 + start + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=模型计算>模型计算</h2><p>将四种 RTO 模型的参数带入上面的公式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>四种模式计算结果</strong>（单位：秒，格式：min / avg / max）</p><table class=full-width><thead><tr><th style=text-align:center>阶段</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>故障检测</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>重启超时</td><td style=text-align:center><code>0</code> / <code>15</code> / <code>15</code></td><td style=text-align:center><code>0</code> / <code>25</code> / <code>25</code></td><td style=text-align:center><code>0</code> / <code>45</code> / <code>45</code></td><td style=text-align:center><code>0</code> / <code>95</code> / <code>95</code></td></tr><tr><td style=text-align:center>从库检测</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>抢锁提拔</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>健康检查</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>总计</strong></td><td style=text-align:center><code>1</code> / <code>24</code> / <code>29</code></td><td style=text-align:center><code>2</code> / <code>35</code> / <code>41</code></td><td style=text-align:center><code>3</code> / <code>61</code> / <code>73</code></td><td style=text-align:center><code>4</code> / <code>122</code> / <code>145</code></td></tr></tbody></table><hr><h2 id=与被动故障对比>与被动故障对比</h2><table class=full-width><thead><tr><th style=text-align:center>阶段</th><th style=text-align:center>主动故障（PG 崩溃）</th><th style=text-align:center>被动故障（节点宕机）</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center>检测机制</td><td style=text-align:center>Patroni 主动检测</td><td style=text-align:center>TTL 被动过期</td><td style=text-align:left>主动检测更快发现故障</td></tr><tr><td style=text-align:center>核心等待</td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:left>start 通常小于 ttl，但需要额外的故障检测时间</td></tr><tr><td style=text-align:center>租约处理</td><td style=text-align:center>主动释放</td><td style=text-align:center>被动过期</td><td style=text-align:left>主动释放更及时</td></tr><tr><td style=text-align:center>自愈可能</td><td style=text-align:center>✅ 有</td><td style=text-align:center>❌ 无</td><td style=text-align:left>主动检测可尝试本地恢复</td></tr></tbody></table><p><strong>RTO 对比</strong>（平均情况）：</p><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center>主动故障（PG 崩溃）</th><th style=text-align:center>被动故障（节点宕机）</th><th style=text-align:left>差异</th></tr></thead><tbody><tr><td style=text-align:center>fast</td><td style=text-align:center>24s</td><td style=text-align:center>23s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>norm</td><td style=text-align:center>35s</td><td style=text-align:center>34s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>safe</td><td style=text-align:center>61s</td><td style=text-align:center>66s</td><td style=text-align:left>-5s</td></tr><tr><td style=text-align:center>wide</td><td style=text-align:center>122s</td><td style=text-align:center>127s</td><td style=text-align:left>-5s</td></tr></tbody></table><blockquote><p><strong>分析</strong>：在 <code>fast</code> 和 <code>norm</code> 模式下，主动故障的 RTO 略高于被动故障，因为需要等待 <code>primary_start_timeout</code>（<code>start</code>）；
但在 <code>safe</code> 和 <code>wide</code> 模式下，由于 <code>start &lt; ttl - loop</code>，主动故障反而更快。
不过主动故障有自愈的可能性，最好情况下 RTO 可以极短。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-895a94576239d65b824c6e6ae06deb76>4 - 服务接入</h1><div class=lead>Pigsty 使用 HAProxy 提供服务接入，并提供可选的 pgBouncer 池化连接，以及可选的 L2 VIP 与 DNS 接入。</div><blockquote><p>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</p></blockquote><p><a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>服务</a> 是一种抽象：它是数据库集群对外提供能力的形式，并封装了底层集群的细节。</p><p>服务对于生产环境中的 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>稳定接入</a> 至关重要，在 <a href=/docs/concept/ha>高可用</a> 集群自动故障时方显其价值，<a href=#%E5%8D%95%E6%9C%BA%E7%94%A8%E6%88%B7>单机用户</a> 通常不需要操心这个概念。</p><hr><h2 id=单机用户>单机用户</h2><p>“服务” 的概念是给生产环境用的，个人用户/单机集群可以不折腾，直接拿实例名/IP地址访问数据库。</p><p>例如，Pigsty 默认的单节点 <code>pg-meta</code>.<code>meta</code> 数据库，就可以直接用下面三个不同的用户连接上去。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># 直接用 DBA 超级用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># 用默认的业务管理员用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># 用默认的只读用户走实例域名连上去</span>
</span></span></code></pre></div><hr><h2 id=服务概述>服务概述</h2><p>在真实世界生产环境中，我们会使用基于复制的主从数据库集群。集群中有且仅有一个实例作为领导者（<a href=/docs/pgsql/config/cluster#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93>主库</a>）可以接受写入。
而其他实例（<a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>从库</a>）则会从持续从集群领导者获取变更日志，与领导者保持一致。同时，从库还可以承载只读请求，在读多写少的场景下可以显著分担主库的负担，
因此对集群的写入请求与只读请求进行区分，是一种十分常见的实践。</p><p>此外对于高频短连接的生产环境，我们还会通过连接池中间件（Pgbouncer）对请求进行池化，减少连接与后端进程的创建开销。但对于ETL与变更执行等场景，我们又需要绕过连接池，直接访问数据库。
同时，高可用集群在故障时会出现故障切换（Failover），故障切换会导致集群的领导者出现变更。因此高可用的数据库方案要求写入流量可以自动适配集群的领导者变化。
这些不同的访问需求（读写分离，池化与直连，故障切换自动适配）最终抽象出 <strong>服务</strong> （Service）的概念。</p><p>通常来说，数据库集群都必须提供这种最基础的服务：</p><ul><li><strong>读写服务（primary）</strong> ：可以读写数据库</li></ul><p>对于生产数据库集群，至少应当提供这两种服务：</p><ul><li><strong>读写服务（primary）</strong> ：写入数据：只能由主库所承载。</li><li><strong>只读服务（replica）</strong> ：读取数据：可以由从库承载，没有从库时也可由主库承载</li></ul><p>此外，根据具体的业务场景，可能还会有其他的服务，例如：</p><ul><li><strong>默认直连服务（default）</strong> ：允许（管理）用户，绕过连接池直接访问数据库的服务</li><li><strong>离线从库服务（offline）</strong> ：不承接线上只读流量的专用从库，用于ETL与分析查询</li><li><strong>同步从库服务（standby）</strong> ：没有复制延迟的只读服务，由 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a> /主库处理只读查询</li><li><strong>延迟从库服务（delayed）</strong> ：访问同一个集群在一段时间之前的旧数据，由 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟从库</a> 来处理</li></ul><hr><h2 id=接入服务>接入服务</h2><p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器。</p><p>典型的做法是使用 DNS 或 VIP 接入，将其绑定在集群所有或任意数量的负载均衡器上。</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>你可以使用不同的 主机 & 端口 组合，它们以不同的方式提供 PostgreSQL 服务。</p><p><strong>主机</strong></p><table class=full-width><thead><tr><th>类型</th><th>样例</th><th>描述</th></tr></thead><tbody><tr><td>集群域名</td><td><code>pg-test</code></td><td>通过集群域名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>集群 VIP 地址</td><td><code>10.10.10.3</code></td><td>通过由 <code>vip-manager</code> 管理的 L2 VIP 地址访问，绑定到主节点</td></tr><tr><td>实例主机名</td><td><code>pg-test-1</code></td><td>通过任何实例主机名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>实例 IP 地址</td><td><code>10.10.10.11</code></td><td>访问任何实例的 IP 地址</td></tr></tbody></table><p><strong>端口</strong></p><p>Pigsty 使用不同的 <strong>端口</strong> 来区分 <a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>pg services</a></p><table class=full-width><thead><tr><th>端口</th><th>服务</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>数据库</td><td>直接访问 postgres 服务器</td></tr><tr><td>6432</td><td>pgbouncer</td><td>中间件</td><td>访问 postgres 前先通过连接池中间件</td></tr><tr><td>5433</td><td>primary</td><td>服务</td><td>访问主 pgbouncer (或 postgres)</td></tr><tr><td>5434</td><td>replica</td><td>服务</td><td>访问备份 pgbouncer (或 postgres)</td></tr><tr><td>5436</td><td>default</td><td>服务</td><td>访问主 postgres</td></tr><tr><td>5438</td><td>offline</td><td>服务</td><td>访问离线 postgres</td></tr></tbody></table><p><strong>组合</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群域名访问</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主直接连接</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群 VIP 直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例名</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 数据库实例直接连接 (单例访问)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库离线读/写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例 IP 访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># 数据库实例直接连接 (直接指定实例, 没有自动流量分配)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库离线读-写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 智能客户端：通过URL读写分离</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>