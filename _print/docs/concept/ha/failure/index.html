<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/concept/ha/failure/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/concept/ha/failure/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>故障切换模型 | PIGSTY</title><meta name=description content="详细分析三种经典故障检测/恢复路径下，最差，最优，平均 RTO 的计算逻辑与结果"><meta property="og:url" content="https://pigsty.cc/docs/concept/ha/failure/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="故障切换模型"><meta property="og:description" content="详细分析三种经典故障检测/恢复路径下，最差，最优，平均 RTO 的计算逻辑与结果"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="故障切换模型"><meta itemprop=description content="详细分析三种经典故障检测/恢复路径下，最差，最优，平均 RTO 的计算逻辑与结果"><meta itemprop=dateModified content="2026-01-14T23:33:58+08:00"><meta itemprop=wordCount content="119"><meta itemprop=keywords content="概念,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="故障切换模型"><meta name=twitter:description content="详细分析三种经典故障检测/恢复路径下，最差，最优，平均 RTO 的计算逻辑与结果"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/concept/ha/failure/>返回本页常规视图</a>.</p></div><h1 class=title>故障切换模型</h1><div class=lead>详细分析三种经典故障检测/恢复路径下，最差，最优，平均 RTO 的计算逻辑与结果</div><ul><li>1: <a href=#pg-358e309cdbb4cb46571e2cba4875ac34>被动故障切换</a></li><li>2: <a href=#pg-42b7950723c66bacccc650303281acc3>主动故障检测</a></li></ul><div class=content><p>Patroni 故障按故障对象分类可以分为以下 10 类，按照检测路径不同，可以进一步归纳为五类，在本节内详细展开。</p><table class=full-width><thead><tr><th>#</th><th>故障场景</th><th>描述</th><th>最终走哪条路径</th></tr></thead><tbody><tr><td>1</td><td>PG 进程崩溃</td><td>crash、OOM killed</td><td><strong>主动检测</strong></td></tr><tr><td>2</td><td>PG 拒绝连接</td><td>max_connections</td><td><strong>主动检测</strong></td></tr><tr><td>3</td><td>PG 假活</td><td>进程在但无响应</td><td><strong>主动检测</strong> (检测超时)</td></tr><tr><td>4</td><td>Patroni 进程崩溃</td><td>kill -9、OOM</td><td><strong>被动检测</strong></td></tr><tr><td>5</td><td>Patroni 假活</td><td>进程在但卡住</td><td><strong>Watchdog</strong></td></tr><tr><td>6</td><td>节点宕机</td><td>断电、硬件故障</td><td><strong>被动检测</strong></td></tr><tr><td>7</td><td>节点假活</td><td>IO hang、CPU 饥饿</td><td><strong>Watchdog</strong></td></tr><tr><td>8</td><td>主库 ↔ DCS 网络中断</td><td>防火墙、交换机故障</td><td><strong>网络分区</strong></td></tr><tr><td>9</td><td>存储故障</td><td>磁盘坏、磁盘满、挂载失败</td><td><strong>主动检测</strong> 或 <strong>Watchdog</strong></td></tr><tr><td>10</td><td>手动切换</td><td>Switchover/Failover</td><td><strong>手动触发</strong></td></tr></tbody></table><p>但是在 RTO 计算上，最终所有故障都会收敛到两条路径上，本节深入探讨了这两种情况下的 RTO 上下限与均值。</p><ul><li><a href=/docs/concept/ha/failure/passive><strong>Patroni 失联后被动触发选举</strong></a>：</li><li><a href=/docs/concept/ha/failure/active><strong>Patroni 主动检测故障并切换</strong></a>:</li></ul><pre class=mermaid>flowchart LR
    A([主库故障]) --&gt; B{Patroni&lt;br/&gt;检测到?}

    B --&gt;|PG崩溃| C[尝试本地重启]
    B --&gt;|节点宕机| D[等待 TTL 过期]

    C --&gt;|成功| E([本地恢复])
    C --&gt;|失败/超时| F[释放 Leader 锁]

    D --&gt; F
    F --&gt; G[从库竞选]
    G --&gt; H[执行 Promote]
    H --&gt; I[HAProxy 感知]
    I --&gt; J([服务恢复])

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#198754,stroke:#146c43,color:#fff
    style J fill:#198754,stroke:#146c43,color:#fff</pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-358e309cdbb4cb46571e2cba4875ac34>1 - 被动故障切换</h1><div class=lead>节点宕机，导致领导者租约过期触发集群领导竞选的故障路径</div><div id=infographic-537dd2226714fc6c5830057e9f044ea1 class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-537dd2226714fc6c5830057e9f044ea1",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  title 租约过期故障切换流程
  desc 当整个节点宕机，Patroni 无法主动释放租约，只能等待 TTL 过期
  items
    - label 租约过期
      desc Patroni 失联，被动等待主库租约 TTL 过期
      icon mingcute/close-circle-fill
    - label 从库检测
      desc 从库从循环中醒来后发现租约过期，开始竞选
      icon mingcute/key-2-fill
    - label 抢锁提拔
      desc 从库相互比较并抢锁，胜利者提升自己的PG
      icon mingcute/radar-fill
    - label 健康检查
      desc HAPROXY 健康检查发现新主上线，分配流量
      icon mingcute/arrow-up-circle-fill
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-时序图>RTO 时序图</h2><div id=echarts-44d24210b099c2088232bbd8c2371226 class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-44d24210b099c2088232bbd8c2371226");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["租约过期","从库检测","抢锁提拔","健康检查"],itemGap:12,top:0},series:[{barWidth:20,data:[120,110,100,"-",60,55,50,"-",30,27,25,"-",20,17,15],emphasis:{focus:"series"},itemStyle:{color:"#e15759"},name:"租约过期",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"从库检测",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"抢锁提拔",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"健康检查",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[150,127,104,"-",78,66,53,"-",41,34,27,"-",29,23,16],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO总计",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO预算",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"秒",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=故障模型>故障模型</h2><table class=full-width><thead><tr><th style=text-align:center>项目</th><th style=text-align:center>最好</th><th style=text-align:center>最坏</th><th style=text-align:center>平均</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong>租约过期</strong></td><td style=text-align:center><code>ttl - loop</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:center><code>ttl - loop/2</code></td><td style=text-align:left>最好：即将刷新时宕机<br>最坏：刚刷新完就宕机</td></tr><tr><td style=text-align:center><strong>从库检测</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop / 2</code></td><td style=text-align:left>最好：恰好在检测点<br>最坏：刚错过检测点</td></tr><tr><td style=text-align:center><strong>抢锁提拔</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>最好：直接抢锁提升<br>最坏：API超时+Promote</td></tr><tr><td style=text-align:center><strong>健康检查</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>最好：检查前状态变化<br>最坏：检查后瞬间状态变化</td></tr></tbody></table><p><strong>被动故障与主动故障的核心区别</strong>：</p><table class=full-width><thead><tr><th style=text-align:center>场景</th><th style=text-align:center>Patroni 状态</th><th style=text-align:center>租约处理</th><th style=text-align:center>主要等待时间</th></tr></thead><tbody><tr><td style=text-align:center><strong>主动故障</strong>（PG崩溃）</td><td style=text-align:center>存活，健康</td><td style=text-align:center>主动尝试重启 PG，超时后释放租约</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>被动故障</strong>（节点宕机）</td><td style=text-align:center>随节点一起死亡</td><td style=text-align:center>无法主动释放，只能等待 TTL 过期</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>在被动故障场景中，Patroni 随节点一起宕机，<strong>无法主动释放 Leader Key</strong>。
DCS 中的租约只能等待 TTL 自然过期后触发集群选举。</p><hr><h2 id=时序分析>时序分析</h2><h3 id=阶段-1租约过期>阶段 1：租约过期</h3><p>Patroni 主库会在每个 <code>loop_wait</code> 周期刷新 Leader Key，将 TTL 重置为配置值。</p><pre tabindex=0><code>时间线：
     t-loop        t          t+ttl-loop    t+ttl
       |           |              |           |
    上次刷新    故障发生        最好情况      最坏情况
       |←── loop ──→|              |           |
       |←──────────── ttl ─────────────────────→|
</code></pre><ul><li><strong>最好情况</strong>：故障发生在即将刷新租约之前（距上次刷新已过 <code>loop</code>），剩余 TTL = <code>ttl - loop</code></li><li><strong>最坏情况</strong>：故障发生在刚刷新租约之后，需等待完整 <code>ttl</code></li><li><strong>平均情况</strong>：<code>ttl - loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mi>i</mi><mi>r</mi><mi>e</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{expire} = \begin{cases}
ttl - loop &amp; \text{最好} \\
ttl - loop/2 &amp; \text{平均} \\
ttl &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-2从库检测>阶段 2：从库检测</h3><p>从库在 <code>loop_wait</code> 周期醒来后检查 DCS 中的 Leader Key 状态。</p><pre tabindex=0><code>时间线：
    租约过期      从库醒来
       |            |
       |←── 0~loop ─→|
</code></pre><ul><li><strong>最好情况</strong>：租约过期时从库恰好醒来，等待 <code>0</code></li><li><strong>最坏情况</strong>：租约过期后从库刚进入睡眠，等待 <code>loop</code></li><li><strong>平均情况</strong>：<code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{最好} \\
loop/2 &amp; \text{平均} \\
loop &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-3抢锁提拔>阶段 3：抢锁提拔</h3><p>从库发现 Leader Key 过期后，开始竞选过程，获得 Leader Key 的从库执行 <code>pg_ctl promote</code>，将自己提升为新主库。</p><ol><li>通过 Rest API，并行发起查询，查询各从库的复制位置，通常 10ms，硬编码 2 秒超时。</li><li>比较 WAL 位置，确定最优候选，各从库尝试创建 Leader Key（CAS 原子操作）</li><li>执行 <code>pg_ctl promote</code> 提升自己为主库（很快，通常忽略不计）</li></ol><pre tabindex=0><code>选举流程：
  从库A ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 成功
  从库B ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 失败
</code></pre><ul><li><strong>最好情况</strong>：单从库或直接抢到锁并提升，常数开销 <code>0.1s</code></li><li><strong>最坏情况</strong>：DCS API 调用超时：<code>2s</code></li><li><strong>平均情况</strong>：<code>1s</code> 常数开销</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{最好} \\
1 &amp; \text{平均} \\
2 &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-4健康检查>阶段 4：健康检查</h3><p>HAProxy 检测新主库上线，需要连续 <code>rise</code> 次健康检查成功。</p><pre tabindex=0><code>检测时序：
  新主提升    首次检查    第二次检查   第三次检查（UP）
     |          |           |           |
     |←─ 0~inter ─→|←─ fast ─→|←─ fast ─→|
</code></pre><ul><li><strong>最好情况</strong>：新主提升时恰好赶上检查，<code>(rise-1) × fastinter</code></li><li><strong>最坏情况</strong>：新主提升后刚错过检查，<code>(rise-1) × fastinter + inter</code></li><li><strong>平均情况</strong>：<code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{最好} \\
(rise-1) \times fastinter + inter/2 &amp; \text{平均} \\
(rise-1) \times fastinter + inter &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-公式>RTO 公式</h2><p>将各阶段时间相加，得到总 RTO：</p><p><strong>最好情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = ttl - loop + 0.1 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>平均情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = ttl + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>最坏情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = ttl + loop + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=模型计算>模型计算</h2><p>将四种 RTO 模型的参数带入上面的公式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>四种模式计算结果</strong>（单位：秒，格式：min / avg / max）</p><table class=full-width><thead><tr><th style=text-align:center>阶段</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>租约过期</td><td style=text-align:center><code>15</code> / <code>17</code> / <code>20</code></td><td style=text-align:center><code>25</code> / <code>27</code> / <code>30</code></td><td style=text-align:center><code>50</code> / <code>55</code> / <code>60</code></td><td style=text-align:center><code>100</code> / <code>110</code> / <code>120</code></td></tr><tr><td style=text-align:center>从库检测</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>抢锁提拔</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>健康检查</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>总计</strong></td><td style=text-align:center><code>16</code> / <code>23</code> / <code>29</code></td><td style=text-align:center><code>27</code> / <code>34</code> / <code>41</code></td><td style=text-align:center><code>53</code> / <code>66</code> / <code>78</code></td><td style=text-align:center><code>104</code> / <code>127</code> / <code>150</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-42b7950723c66bacccc650303281acc3>2 - 主动故障检测</h1><div class=lead>PostgreSQL 主库进程崩溃，Patroni 存活并尝试重启，超时后触发故障切换的路径</div><div id=infographic-5a27087cd19651a30e413fd22489ae1b class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-5a27087cd19651a30e413fd22489ae1b",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  title 崩溃故障切换流程
  desc 当 Patroni 健康，但 PostgreSQL 因故崩溃时的故障切换流程
  items
    - label 故障检测
      desc Patroni 在循环中检测到 PG 崩溃
      icon mingcute/close-circle-fill
    - label 重启超时
      desc Patroni 尝试重启 PG，超时后释放租约
      icon mingcute/refresh-2-fill
    - label 从库检测
      desc 从库从循环中醒来发现租约释放，开始竞选
      icon mingcute/key-2-fill
    - label 抢锁提拔
      desc 从库相互比较并抢锁，胜利者提升自己的 PG
      icon mingcute/radar-fill
    - label 健康检查
      desc HAProxy 健康检查发现新主上线，分配流量
      icon mingcute/arrow-up-circle-fill
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-时序图>RTO 时序图</h2><div id=echarts-7566178edd3ee3c0901186f67235867f class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-7566178edd3ee3c0901186f67235867f");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["故障检测","重启超时","从库检测","抢锁提拔","健康检查"],itemGap:12,top:0},series:[{barWidth:20,data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#b07aa1"},name:"故障检测",stack:"main",type:"bar",z:2},{data:[95,95,0,"-",45,45,0,"-",25,25,0,"-",15,15,0],emphasis:{focus:"series"},itemStyle:{color:"#f28e2c"},name:"重启超时",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"从库检测",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"抢锁提拔",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"健康检查",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[145,122,4,"-",73,61,3,"-",41,35,2,"-",29,24,1],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO总计",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO预算",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"秒",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=故障模型>故障模型</h2><table class=full-width><thead><tr><th style=text-align:center>项目</th><th style=text-align:center>最好</th><th style=text-align:center>最坏</th><th style=text-align:center>平均</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong>故障检测</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>最好：PG 恰好在检测前崩溃<br>最坏：PG 刚检测完就崩溃</td></tr><tr><td style=text-align:center><strong>重启超时</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>start</code></td><td style=text-align:left>最好：PG 瞬间自愈<br>最坏：等满 start 超时才释放租约</td></tr><tr><td style=text-align:center><strong>从库检测</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>最好：恰好在检测点<br>最坏：刚错过检测点</td></tr><tr><td style=text-align:center><strong>抢锁提拔</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>最好：直接抢锁提升<br>最坏：API 超时 + Promote</td></tr><tr><td style=text-align:center><strong>健康检查</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>最好：检查前状态变化<br>最坏：检查后瞬间状态变化</td></tr></tbody></table><p><strong>主动故障与被动故障的核心区别</strong>：</p><table class=full-width><thead><tr><th style=text-align:center>场景</th><th style=text-align:center>Patroni 状态</th><th style=text-align:center>租约处理</th><th style=text-align:center>主要等待时间</th></tr></thead><tbody><tr><td style=text-align:center><strong>主动故障</strong>（PG 崩溃）</td><td style=text-align:center>存活，健康</td><td style=text-align:center>主动尝试重启 PG，超时后释放租约</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>被动故障</strong>（节点宕机）</td><td style=text-align:center>随节点一起死亡</td><td style=text-align:center>无法主动释放，只能等待 TTL 过期</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>在主动故障场景中，Patroni 仍然存活，能够<strong>主动检测到 PG 崩溃并尝试重启</strong>。
如果重启成功，服务自愈；如果超时仍未恢复，Patroni 会<strong>主动释放 Leader Key</strong>，触发集群选举。</p><hr><h2 id=时序分析>时序分析</h2><h3 id=阶段-1故障检测>阶段 1：故障检测</h3><p>Patroni 在每个 <code>loop_wait</code> 周期检查 PostgreSQL 状态（通过 <code>pg_isready</code> 或检查进程）。</p><pre tabindex=0><code>时间线：
    上次检测      PG崩溃      下次检测
       |           |           |
       |←── 0~loop ─→|          |
</code></pre><ul><li><strong>最好情况</strong>：PG 恰好在 Patroni 检测前崩溃，立即被发现，等待 <code>0</code></li><li><strong>最坏情况</strong>：PG 刚检测完就崩溃，需等待下一个周期，等待 <code>loop</code></li><li><strong>平均情况</strong>：<code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{最好} \\
loop/2 &amp; \text{平均} \\
loop &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-2重启超时>阶段 2：重启超时</h3><p>Patroni 检测到 PG 崩溃后，会尝试重启 PostgreSQL。此阶段有两种可能的结果：</p><pre tabindex=0><code>时间线：
  检测到崩溃     尝试重启     重启成功/超时
      |           |             |
      |←──── 0 ~ start ────────→|
</code></pre><p><strong>路径 A：自愈成功</strong>（最好情况）</p><ul><li>PG 成功重启，服务恢复</li><li>不触发故障切换，RTO 极短</li><li>等待时间：<code>0</code>（相对于 Failover 路径）</li></ul><p><strong>路径 B：需要 Failover</strong>（平均/最坏情况）</p><ul><li>等待 <code>primary_start_timeout</code> 超时后 PG 仍未恢复</li><li>Patroni 主动释放 Leader Key</li><li>等待时间：<code>start</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好（自愈成功）</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均（需要 Failover）</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{restart} = \begin{cases}
0 &amp; \text{最好（自愈成功）} \\
start &amp; \text{平均（需要 Failover）} \\
start &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.2806em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">res</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.02778em>r</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好（自愈成功）</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均（需要</span><span class=mord> Failover</span><span class="mord cjk_fallback">）</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><blockquote><p><strong>注意</strong>：平均情况假设需要进行故障切换。如果 PG 能够快速自愈，则整体 RTO 会大幅降低。</p></blockquote><h3 id=阶段-3从库检测>阶段 3：从库检测</h3><p>从库在 <code>loop_wait</code> 周期醒来后检查 DCS 中的 Leader Key 状态。当主库 Patroni 释放 Leader Key 后，从库发现后开始竞选。</p><pre tabindex=0><code>时间线：
    租约释放      从库醒来
       |            |
       |←── 0~loop ─→|
</code></pre><ul><li><strong>最好情况</strong>：租约释放时从库恰好醒来，等待 <code>0</code></li><li><strong>最坏情况</strong>：租约释放后从库刚进入睡眠，等待 <code>loop</code></li><li><strong>平均情况</strong>：<code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>b</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{standby} = \begin{cases}
0 &amp; \text{最好} \\
loop/2 &amp; \text{平均} \\
loop &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">an</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-4抢锁提拔>阶段 4：抢锁提拔</h3><p>从库发现 Leader Key 空缺后，开始竞选过程，获得 Leader Key 的从库执行 <code>pg_ctl promote</code>，将自己提升为新主库。</p><ol><li>通过 Rest API，并行发起查询，查询各从库的复制位置，通常 10ms，硬编码 2 秒超时。</li><li>比较 WAL 位置，确定最优候选，各从库尝试创建 Leader Key（CAS 原子操作）</li><li>执行 <code>pg_ctl promote</code> 提升自己为主库（很快，通常忽略不计）</li></ol><pre tabindex=0><code>选举流程：
  从库A ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 成功
  从库B ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 失败
</code></pre><ul><li><strong>最好情况</strong>：单从库或直接抢到锁并提升，常数开销 <code>0.1s</code></li><li><strong>最坏情况</strong>：DCS API 调用超时：<code>2s</code></li><li><strong>平均情况</strong>：<code>1s</code> 常数开销</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{最好} \\
1 &amp; \text{平均} \\
2 &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-5健康检查>阶段 5：健康检查</h3><p>HAProxy 检测新主库上线，需要连续 <code>rise</code> 次健康检查成功。</p><pre tabindex=0><code>检测时序：
  新主提升    首次检查    第二次检查   第三次检查（UP）
     |          |           |           |
     |←─ 0~inter ─→|←─ fast ─→|←─ fast ─→|
</code></pre><ul><li><strong>最好情况</strong>：新主提升时恰好赶上检查，<code>(rise-1) × fastinter</code></li><li><strong>最坏情况</strong>：新主提升后刚错过检查，<code>(rise-1) × fastinter + inter</code></li><li><strong>平均情况</strong>：<code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{最好} \\
(rise-1) \times fastinter + inter/2 &amp; \text{平均} \\
(rise-1) \times fastinter + inter &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-公式>RTO 公式</h2><p>将各阶段时间相加，得到总 RTO：</p><p><strong>最好情况</strong>（PG 瞬间自愈）</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>≈</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = 0 + 0 + 0 + 0.1 + (rise-1) \times fastinter \approx (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>平均情况</strong>（需要 Failover）</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = loop + start + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>最坏情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>×</mo><mn>2</mn><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = loop \times 2 + start + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=模型计算>模型计算</h2><p>将四种 RTO 模型的参数带入上面的公式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>四种模式计算结果</strong>（单位：秒，格式：min / avg / max）</p><table class=full-width><thead><tr><th style=text-align:center>阶段</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>故障检测</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>重启超时</td><td style=text-align:center><code>0</code> / <code>15</code> / <code>15</code></td><td style=text-align:center><code>0</code> / <code>25</code> / <code>25</code></td><td style=text-align:center><code>0</code> / <code>45</code> / <code>45</code></td><td style=text-align:center><code>0</code> / <code>95</code> / <code>95</code></td></tr><tr><td style=text-align:center>从库检测</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>抢锁提拔</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>健康检查</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>总计</strong></td><td style=text-align:center><code>1</code> / <code>24</code> / <code>29</code></td><td style=text-align:center><code>2</code> / <code>35</code> / <code>41</code></td><td style=text-align:center><code>3</code> / <code>61</code> / <code>73</code></td><td style=text-align:center><code>4</code> / <code>122</code> / <code>145</code></td></tr></tbody></table><hr><h2 id=与被动故障对比>与被动故障对比</h2><table class=full-width><thead><tr><th style=text-align:center>阶段</th><th style=text-align:center>主动故障（PG 崩溃）</th><th style=text-align:center>被动故障（节点宕机）</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center>检测机制</td><td style=text-align:center>Patroni 主动检测</td><td style=text-align:center>TTL 被动过期</td><td style=text-align:left>主动检测更快发现故障</td></tr><tr><td style=text-align:center>核心等待</td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:left>start 通常小于 ttl，但需要额外的故障检测时间</td></tr><tr><td style=text-align:center>租约处理</td><td style=text-align:center>主动释放</td><td style=text-align:center>被动过期</td><td style=text-align:left>主动释放更及时</td></tr><tr><td style=text-align:center>自愈可能</td><td style=text-align:center>✅ 有</td><td style=text-align:center>❌ 无</td><td style=text-align:left>主动检测可尝试本地恢复</td></tr></tbody></table><p><strong>RTO 对比</strong>（平均情况）：</p><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center>主动故障（PG 崩溃）</th><th style=text-align:center>被动故障（节点宕机）</th><th style=text-align:left>差异</th></tr></thead><tbody><tr><td style=text-align:center>fast</td><td style=text-align:center>24s</td><td style=text-align:center>23s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>norm</td><td style=text-align:center>35s</td><td style=text-align:center>34s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>safe</td><td style=text-align:center>61s</td><td style=text-align:center>66s</td><td style=text-align:left>-5s</td></tr><tr><td style=text-align:center>wide</td><td style=text-align:center>122s</td><td style=text-align:center>127s</td><td style=text-align:left>-5s</td></tr></tbody></table><blockquote><p><strong>分析</strong>：在 <code>fast</code> 和 <code>norm</code> 模式下，主动故障的 RTO 略高于被动故障，因为需要等待 <code>primary_start_timeout</code>（<code>start</code>）；
但在 <code>safe</code> 和 <code>wide</code> 模式下，由于 <code>start &lt; ttl - loop</code>，主动故障反而更快。
不过主动故障有自愈的可能性，最好情况下 RTO 可以极短。</p></blockquote></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script type=module async>
  import mermaid from "https:\/\/cdn.jsdelivr.net\/npm\/mermaid@latest\/dist\/mermaid.esm.min.mjs";

  (function ($) {
    if ($('.mermaid').length == 0) {
      mermaid.initialize({ startOnLoad: false });
      return;
    }

    var params = {};

    
    
    var norm = function (defaultConfig, params) {
      var result = {};
      for (const key in defaultConfig) {
        const keyLower = key.toLowerCase();
        if (defaultConfig.hasOwnProperty(key) && params.hasOwnProperty(keyLower)) {
          if (typeof defaultConfig[key] === "object") {
            result[key] = norm(defaultConfig[key], params[keyLower]);
          } else {
            result[key] = params[keyLower];
          }
        }
      }
      return result;
    };

    var settings = norm(mermaid.mermaidAPI.defaultConfig, params);
    settings.startOnLoad = true;
    if ($('html[data-bs-theme="dark"]').length) {
      settings.theme = 'dark';
    }
    mermaid.initialize(settings);

    
    const lightDarkModeThemeChangeHandler = function (mutationsList, observer) {
      for (const mutation of mutationsList) {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-bs-theme') {
          
          
          
          location.reload();
        }
      }
    };

    const observer = new MutationObserver(lightDarkModeThemeChangeHandler);
    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ['data-bs-theme']
    });
    

  })(jQuery);
</script><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>