<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/concept/pitr/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/concept/pitr/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>时间点恢复 | PIGSTY</title><meta name=description content="Pigsty 使用 pgBackRest 实现了 PostgreSQL 时间点恢复，允许用户回滚至备份策略容许范围内的任意时间点。"><meta property="og:url" content="https://pigsty.cc/docs/concept/pitr/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="时间点恢复"><meta property="og:description" content="Pigsty 使用 pgBackRest 实现了 PostgreSQL 时间点恢复，允许用户回滚至备份策略容许范围内的任意时间点。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="时间点恢复"><meta itemprop=description content="Pigsty 使用 pgBackRest 实现了 PostgreSQL 时间点恢复，允许用户回滚至备份策略容许范围内的任意时间点。"><meta itemprop=dateModified content="2026-02-09T18:41:01+08:00"><meta itemprop=wordCount content="534"><meta itemprop=keywords content="概念,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="时间点恢复"><meta name=twitter:description content="Pigsty 使用 pgBackRest 实现了 PostgreSQL 时间点恢复，允许用户回滚至备份策略容许范围内的任意时间点。"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/concept/pitr/>返回本页常规视图</a>.</p></div><h1 class=title>时间点恢复</h1><div class=lead>Pigsty 使用 pgBackRest 实现了 PostgreSQL 时间点恢复，允许用户回滚至备份策略容许范围内的任意时间点。</div><ul><li>1: <a href=#pg-38cea9754a736f991ef94b09725db17e>时间点恢复的工作原理</a></li><li>2: <a href=#pg-0f1a78edbba6d0b4ce0cad98c98b549c>时间点恢复的实现架构</a></li><li>3: <a href=#pg-73a2e369df3734218f99f90230b96257>时间点恢复的策略权衡</a></li><li>4: <a href=#pg-03fae0025a6c17d88ae21f91a462fbe6>时间点恢复的典型场景</a></li></ul><div class=content><blockquote><p>当您不小心删除了数据、表、甚至整个数据库时，PITR 能力让您回到过去任意时刻，避免软件缺陷与人为失误导致的数据损失。</p><p>—— 这个曾经只有资深 DBA 才能施展的『魔法』，现在对所有用户都可以轻松做到零配置开箱即用。</p></blockquote><hr><h2 id=概览>概览</h2><p>Pigsty 的 PostgreSQL 集群带有自动配置的时间点恢复（PITR）方案，基于 <a href=https://pgbackrest.org/><strong>pgBackRest</strong></a> 与可选的对象存储仓库 <a href=https://min.io/><strong>MinIO</strong></a> 提供。</p><p><a href=/docs/concept/ha><strong>高可用方案</strong></a> 可以解决硬件故障，但却对软件缺陷与人为失误导致的数据删除/覆盖写入/删库等问题却无能为力。
对于这种情况，Pigsty 提供了开箱即用的 <strong>时间点恢复</strong>（Point in Time Recovery, PITR）能力，无需额外配置即默认启用。</p><p>Pigsty 为您提供了基础备份与 WAL 归档的默认配置，您可以使用本地目录与磁盘，亦或专用的 MinIO 集群或 S3 对象存储服务来存储备份并实现异地容灾。
当您使用本地磁盘时，默认保留恢复至过去一天内的任意时间点的能力。当您使用 MinIO 或 S3 时，默认保留恢复至过去一周内的任意时间点的能力。
只要存储空间管够，您尽可保留任意长地可恢复时间段，丰俭由人。</p><hr><h3 id=时间点恢复解决什么问题>时间点恢复解决什么问题？</h3><ul><li>容灾能⼒增强：<strong>RPO</strong> 从 ∞ 降⾄ ⼗⼏MB， <strong>RTO</strong> 从 ∞ 降⾄ ⼏⼩时/⼏刻钟。</li><li>确保数据安全：C/I/A 中的 <strong>数据完整性</strong>：避免误删导致的数据⼀致性问题。</li><li>确保数据安全：C/I/A 中的 <strong>数据可⽤性</strong>：提供对“永久不可⽤”这种灾难情况的兜底</li></ul><table class=full-width><thead><tr><th>单实例配置策略</th><th style=text-align:center>事件</th><th>RTO</th><th style=text-align:left>RPO</th></tr></thead><tbody><tr><td><i class="fa-solid fa-music text-danger"></i> 什么也不做</td><td style=text-align:center>宕机</td><td><i class="fas fa-circle-xmark text-danger"></i> <strong>永久丢失</strong></td><td style=text-align:left><i class="fas fa-circle-xmark text-danger"></i> <strong>全部丢失</strong></td></tr><tr><td><i class="fa-solid fa-copy text-secondary"></i> 基础备份</td><td style=text-align:center>宕机</td><td><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 取决于备份大小与带宽（几小时）</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 丢失上一次备份后的数据（几个小时到几天）</td></tr><tr><td><i class="fa-solid fa-copy text-primary"></i> 基础备份 + <i class="fa-solid fa-clock-rotate-left text-primary"></i> WAL归档</td><td style=text-align:center>宕机</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> 取决于备份大小与带宽（几小时）</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-primary"></i> 丢失最后尚未归档的数据（几十MB）</td></tr></tbody></table><h3 id=时间点恢复有什么代价>时间点恢复有什么代价？</h3><ul><li>降低数据安全中的 C：<strong>机密性</strong>，产生额外泄漏点，需要额外对备份进⾏保护。</li><li>额外的资源消耗：本地存储或⽹络流量 / 带宽开销，通常并不是⼀个问题。</li><li>复杂度代价升⾼：⽤户需要付出备份管理成本。</li></ul><h3 id=时间点恢复的局限性>时间点恢复的局限性</h3><p>如果只有 PITR 用于故障恢复，则 RTO 与 RPO 指标相比 <a href=/docs/concept/ha/><strong>高可用方案</strong></a> 更为逊色，通常应两者组合使用。</p><ul><li><strong>RTO</strong>：如果只有单机 + PITR，恢复时长取决于备份大小与网络/磁盘带宽，从十几分钟到几小时，几天不等。</li><li><strong>RPO</strong>：如果只有单机 + PITR，宕机时可能丢失少量数据，一个或几个 WAL 日志段文件可能尚未归档，损失 16 MB 到⼏⼗ MB 不等的数据。</li></ul><p>除了 <a href=/docs/concept/pitr><strong>PITR</strong></a> 之外，您还可以在 Pigsty 中使用 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4><strong>延迟集群</strong></a> 来解决人为失误或软件缺陷导致的数据误删误改问题。</p><hr><h2 id=原理>原理</h2><p>时间点恢复允许您将集群恢复回滚至过去的“任意时刻”，避免软件缺陷与人为失误导致的数据损失。要做到这一点，首先需要做好两样准备工作：<a href=#%E5%9F%BA%E7%A1%80%E5%A4%87%E4%BB%BD><strong>基础备份</strong></a> 与 <a href=#wal%E5%BD%92%E6%A1%A3><strong>WAL归档</strong></a>。
拥有 <strong>基础备份</strong>，允许用户将数据库恢复至备份时的状态，而同时拥有从某个基础备份开始的 <strong>WAL归档</strong>，允许用户将数据库恢复至基础备份时刻之后的任意时间点。</p><p>详细原理，请参阅：<a href=/blog/pg/backup-overview/><strong>基础备份与时间点恢复</strong></a>；具体操作，请参考 <a href=/docs/pgsql/backup/><strong>PGSQL管理：备份恢复</strong></a>。</p><h3 id=基础备份>基础备份</h3><p>Pigsty 使用 pgbackrest 管理 PostgreSQL 备份。pgBackRest 将在所有集群实例上初始化空仓库，但只会在集群主库上实际使用仓库。</p><p>pgBackRest 支持三种备份模式：<strong>全量备份</strong>，<strong>增量备份</strong>，差异备份，其中前两者最为常用。
全量备份将对数据库集群取一个当前时刻的全量物理快照，增量备份会记录当前数据库集群与上一次全量备份之间的差异。</p><p>Pigsty 为备份提供了封装命令：<code>/pg/bin/pg-backup [full|incr]</code>。您可以通过 Crontab 或任何其他任务调度系统，按需定期制作基础备份。</p><h3 id=wal归档>WAL归档</h3><p>Pigsty 默认在集群主库上启⽤了 WAL 归档，并使⽤ <code>pgbackrest</code> 命令行工具持续推送 WAL 段⽂件至备份仓库。</p><p>pgBackRest 会⾃动管理所需的 WAL ⽂件，并根据备份的保留策略及时清理过期的备份，与其对应的 WAL 归档⽂件。</p><p>如果您不需要 PITR 功能，可以通过 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4><strong>配置集群</strong></a>： <code>archive_mode: off</code> 来关闭 WAL 归档，移除 <a href=/docs/node/param#node_crontab><code>node_crontab</code></a> 来停止定期备份任务。</p><hr><h2 id=实现>实现</h2><p>默认情况下，Pigsty提供了两种预置 <a href=/docs/pgsql/backup/policy>备份策略</a>：默认使用本地文件系统备份仓库，在这种情况下每天进行一次全量备份，确保用户任何时候都能回滚至一天内的任意时间点。备选策略使用专用的 MinIO 集群或S3存储备份，每周一全备，每天一增备，默认保留两周的备份与WAL归档。</p><p>Pigsty 使用 pgBackRest 管理备份，接收 WAL 归档，执行 PITR。备份仓库可以进行灵活配置（<a href=/docs/pgsql/param#pgbackrest_repo><code>pgbackrest_repo</code></a>）：默认使用主库本地文件系统（<code>local</code>），但也可以使用其他磁盘路径，或使用自带的可选 <a href=/docs/minio>MinIO</a> 服务（<code>minio</code>）与云上 S3 服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 在 pgsql 主机上启用 pgBackRest 吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_clean</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 初始化时删除 pg 备份数据？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/pgbackrest</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 日志目录，默认为 `/pg/log/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 仓库方法：local, minio, [用户定义...]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># pgbackrest 仓库：https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 默认使用本地 posix 文件系统的 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按计数保留完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，最多保留 3 个完整备份，至少保留 2 个</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># pgbackrest 的可选 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 是与 s3 兼容的，所以使用 s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认为 us-east-1，对 minio 无效</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名称，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户秘密密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 对 minio 使用路径风格的 uri，而不是主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认为 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio ca 文件路径，默认为 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成一个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 在 minio 仓库上按时间保留完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留过去 14 天的完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 您还可以添加其他的可选备份仓库，例如 S3，用于异地容灾</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 参数 <a href=/docs/pgsql/param#pgbackrest_repo><code>pgbackrest_repo</code></a> 中的目标仓库会被转换为 <code>/etc/pgbackrest/pgbackrest.conf</code> 配置文件中的仓库定义。
例如，如果您定义了一个美西区的 S3 仓库用于存储冷备份，可以使用下面的参考配置。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>s3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ------&gt; /etc/pgbackrest/pgbackrest.conf</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-type=s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-west-1                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-region=us-west-1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3-us-west-1.amazonaws.com   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-endpoint=s3-us-west-1.amazonaws.com</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&lt;your_access_key&gt;&#39;</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-key=&lt;your_access_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-key-secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&lt;your_secret_key&gt;&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-key-secret=&lt;your_secret_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql                          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-bucket=pgsql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-uri-style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>host                        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-uri-style=host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest                         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-path=/pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                                  </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-bundle=y</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-cipher-type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-cipher-type=aes-256-cbc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-cipher-pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-cipher-pass=pgBackRest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-retention-full-type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-retention-full-type=time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-retention-full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-retention-full=90</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=恢复>恢复</h2><p>您可以直接使用以下封装命令可以用于 PostgreSQL 数据库集群的 <a href=https://pgbackrest.org/command.html#command-restore>时间点恢复</a>。</p><p>Pigsty 默认使用增量差分并行恢复，允许您以最快速度恢复到指定时间点。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr                                 <span style=color:#8f5902;font-style:italic># 恢复到WAL存档流的结束位置（例如在整个数据中心故障的情况下使用）</span>
</span></span><span style=display:flex><span>pg-pitr -i                              <span style=color:#8f5902;font-style:italic># 恢复到最近备份完成的时间（不常用）</span>
</span></span><span style=display:flex><span>pg-pitr --time<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2022-12-30 14:44:44+08&#34;</span> <span style=color:#8f5902;font-style:italic># 恢复到指定的时间点（在删除数据库或表的情况下使用）</span>
</span></span><span style=display:flex><span>pg-pitr --name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;my-restore-point&#34;</span>       <span style=color:#8f5902;font-style:italic># 恢复到使用 pg_create_restore_point 创建的命名恢复点</span>
</span></span><span style=display:flex><span>pg-pitr --lsn<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span> -X            <span style=color:#8f5902;font-style:italic># 在LSN之前立即恢复</span>
</span></span><span style=display:flex><span>pg-pitr --xid<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1234567&#34;</span> -X -P           <span style=color:#8f5902;font-style:italic># 在指定的事务ID之前立即恢复，然后将集群直接提升为主库</span>
</span></span><span style=display:flex><span>pg-pitr --backup<span style=color:#ce5c00;font-weight:700>=</span>latest                 <span style=color:#8f5902;font-style:italic># 恢复到最新的备份集</span>
</span></span><span style=display:flex><span>pg-pitr --backup<span style=color:#ce5c00;font-weight:700>=</span>20221108-105325        <span style=color:#8f5902;font-style:italic># 恢复到特定备份集，备份集可以使用 pgbackrest info 列出</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg-pitr                                 <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta restore</span>
</span></span><span style=display:flex><span>pg-pitr -i                              <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=immediate restore</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2022-12-30 14:44:44+08&#34;</span>     <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=time --target=&#34;2022-12-30 14:44:44+08&#34; restore</span>
</span></span><span style=display:flex><span>pg-pitr -n <span style=color:#4e9a06>&#34;my-restore-point&#34;</span>           <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=name --target=my-restore-point restore</span>
</span></span><span style=display:flex><span>pg-pitr -b 20221108-105325F             <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=name --set=20221230-120101F restore</span>
</span></span><span style=display:flex><span>pg-pitr -l <span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span> -X               <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=lsn --target=&#34;0/7C82CB8&#34; --target-exclusive restore</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>1234567</span> -X -P                <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=xid --target=&#34;0/7C82CB8&#34; --target-exclusive --target-action=promote restore</span>
</span></span></code></pre></div><p>在执行 PITR 时，您可以使用 Pigsty 监控系统观察集群 LSN 位点状态，判断是否成功恢复到指定的时间点，事务点，LSN位点，或其他点位。</p><p><img src=/img/docs/concept/pitr.png alt=pitr></p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-38cea9754a736f991ef94b09725db17e>1 - 时间点恢复的工作原理</h1><div class=lead>本文解释 PITR 的工作机制，帮助您建立正确的心智模型：基础备份、WAL 归档、恢复窗口与事务边界</div><p>时间点恢复（PITR）的核心原理是：<strong>基础备份 + WAL 归档 = 任意时间点恢复能力</strong>。
在 Pigsty 中，这一能力由 <strong>pgBackRest</strong> 实现，并通过 <strong>定时备份 + WAL 归档</strong> 自动运行。</p><hr><h2 id=三要素>三要素</h2><table class=full-width><thead><tr><th style=text-align:left>要素</th><th style=text-align:left>作用</th><th style=text-align:left>Pigsty 实现</th></tr></thead><tbody><tr><td style=text-align:left><strong>基础备份</strong></td><td style=text-align:left>提供一致的物理快照，决定恢复起点</td><td style=text-align:left><code>pg-backup</code> + <code>pgbackrest</code> + <a href=/docs/pgsql/param#pg_crontab><code>pg_crontab</code></a></td></tr><tr><td style=text-align:left><strong>WAL 归档</strong></td><td style=text-align:left>记录备份后的所有变更，决定恢复路径</td><td style=text-align:left><code>archive_mode=on</code> + <code>archive_command=pgbackrest ... archive-push</code></td></tr><tr><td style=text-align:left><strong>恢复目标</strong></td><td style=text-align:left>指定恢复停止位置</td><td style=text-align:left><code>pg_pitr</code> 参数 / <code>pg-pitr</code> 脚本 / <code>pgbackrest restore</code></td></tr></tbody></table><hr><h2 id=基础备份>基础备份</h2><p><strong>基础备份</strong>是数据库在某一时刻的物理快照，是 PITR 的恢复起点。Pigsty 通过 <code>pgBackRest</code> 生成基础备份，并提供 <code>pg-backup</code> 脚本封装常用操作。</p><h3 id=备份类型>备份类型</h3><table class=full-width><thead><tr><th style=text-align:left>类型</th><th style=text-align:left>说明</th><th style=text-align:left>恢复开销</th></tr></thead><tbody><tr><td style=text-align:left><strong>全量备份</strong>（Full）</td><td style=text-align:left>复制全部数据文件</td><td style=text-align:left>恢复最快，空间占用最大</td></tr><tr><td style=text-align:left><strong>差异备份</strong>（Differential）</td><td style=text-align:left>相对最近一次全量备份的变化</td><td style=text-align:left>恢复需要全量 + 差异</td></tr><tr><td style=text-align:left><strong>增量备份</strong>（Incremental）</td><td style=text-align:left>相对最近一次任意备份的变化</td><td style=text-align:left>空间最省，恢复需要完整链路</td></tr></tbody></table><h3 id=pigsty-的默认行为>Pigsty 的默认行为</h3><ul><li><code>pg-backup</code> <strong>默认执行增量备份</strong>，若不存在全量备份会自动补一次全量。</li><li>备份任务通过 <a href=/docs/pgsql/param#pg_crontab><code>pg_crontab</code></a> 配置，写入 <code>postgres</code> 用户的 crontab。</li><li>脚本会自动识别节点角色，<strong>只有主库实际执行</strong>，从库会直接退出。</li></ul><p>备份频率越高，需要重放的 WAL 越少，恢复速度越快。
更多细节请参阅 <a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a> 与 <a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a>。</p><hr><h2 id=wal-归档>WAL 归档</h2><p><strong>WAL</strong>（Write-Ahead Log）记录了数据库的每一次变更。PITR 通过持续归档 WAL，确保能够把数据库从基础备份重放到指定时刻。</p><h3 id=pigsty-的归档链路>Pigsty 的归档链路</h3><p>Pigsty 默认开启 WAL 归档，并将归档动作交给 pgBackRest：</p><ul><li><code>archive_mode = on</code></li><li><code>archive_command = pgbackrest --stanza=&lt;cluster> archive-push %p</code></li></ul><p>pgBackRest 会持续接收 WAL 段文件，并依据保留策略自动清理过期归档。
恢复时，pgBackRest 负责通过 <code>archive-get</code> 拉取所需 WAL。</p><h3 id=关键影响>关键影响</h3><ul><li><strong>归档延迟</strong>会缩短恢复窗口的右边界。</li><li><strong>仓库不可用</strong>会导致归档中断，直接影响 PITR 能力。</li></ul><p>更多细节请参阅 <a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a> 与 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p><hr><h2 id=恢复目标与事务边界>恢复目标与事务边界</h2><p>PITR 的恢复目标由 PostgreSQL 的 <code>recovery_target_*</code> 系列参数定义，Pigsty 通过 <code>pg_pitr</code> 或 <code>pg-pitr</code> 进行封装。</p><h3 id=目标类型>目标类型</h3><table class=full-width><thead><tr><th style=text-align:left>目标类型</th><th style=text-align:left>参数</th><th style=text-align:left>说明</th><th style=text-align:left>常见场景</th></tr></thead><tbody><tr><td style=text-align:left><strong>latest</strong></td><td style=text-align:left>无</td><td style=text-align:left>恢复到 WAL 归档流末尾</td><td style=text-align:left>机房灾难后的最新恢复</td></tr><tr><td style=text-align:left><strong>time</strong></td><td style=text-align:left><code>time</code></td><td style=text-align:left>恢复到指定时间点</td><td style=text-align:left>误删数据</td></tr><tr><td style=text-align:left><strong>xid</strong></td><td style=text-align:left><code>xid</code></td><td style=text-align:left>恢复到指定事务 ID</td><td style=text-align:left>错误事务回滚</td></tr><tr><td style=text-align:left><strong>lsn</strong></td><td style=text-align:left><code>lsn</code></td><td style=text-align:left>恢复到指定 LSN</td><td style=text-align:left>精确回退</td></tr><tr><td style=text-align:left><strong>name</strong></td><td style=text-align:left><code>name</code></td><td style=text-align:left>恢复到命名恢复点</td><td style=text-align:left>预设检查点</td></tr><tr><td style=text-align:left><strong>immediate</strong></td><td style=text-align:left><code>type: immediate</code></td><td style=text-align:left>第一一致点停止</td><td style=text-align:left>最快恢复</td></tr></tbody></table><h3 id=包含与排除>包含与排除</h3><p>恢复目标默认是<strong>包含</strong>（inclusive）的。
若要回退到目标点<strong>之前</strong>，在 <code>pg_pitr</code> 中设置 <code>exclusive: true</code>，对应 PostgreSQL 的 <code>recovery_target_inclusive = false</code>。</p><h3 id=事务边界>事务边界</h3><p>PITR 会保留目标点前的<strong>已提交事务</strong>，并回滚未提交事务。</p><pre class=mermaid>gantt
    title 事务边界与恢复目标
    dateFormat X
    axisFormat %s
    section 事务 A
    BEGIN → COMMIT (已提交) :done, a1, 0, 2
    section 事务 B
    BEGIN → 未提交 :active, b1, 1, 4
    section 恢复
    恢复目标点 :milestone, m1, 2, 0</pre><p>更多操作细节请参阅 <a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a>。</p><hr><h2 id=恢复窗口>恢复窗口</h2><p><strong>恢复窗口</strong>由两个边界决定：</p><ul><li><strong>左边界</strong>：最早可用的基础备份</li><li><strong>右边界</strong>：最新已归档的 WAL</li></ul><p><img src=/img/pigsty/pitr-scope.png alt=pitr-scope></p><p>窗口长短取决于备份频率、备份保留与 WAL 归档保留策略：</p><ul><li><code>local</code> 仓库默认保留 <strong>2 个全量备份</strong>，窗口通常为 <strong>24～48 小时</strong>。</li><li><code>minio</code> 仓库默认按时间保留 <strong>14 天</strong>备份，窗口通常为 <strong>1～2 周</strong>。</li></ul><p>具体策略配置请参阅 <a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a> 与 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p><hr><h2 id=时间线>时间线</h2><p><strong>时间线</strong>（Timeline）用于区分不同历史分支。以下操作会生成新时间线：</p><ol><li>PITR 恢复</li><li>从库提升（Promote）</li><li>故障切换（Failover）</li></ol><pre class=mermaid>gitGraph
    commit id: &#34;初始状态&#34;
    commit id: &#34;写入数据&#34;
    commit id: &#34;继续写入&#34;
    branch Timeline-2
    checkout Timeline-2
    commit id: &#34;PITR 恢复点1&#34;
    commit id: &#34;新写入&#34;
    branch Timeline-3
    checkout Timeline-3
    commit id: &#34;PITR 恢复点2&#34;
    commit id: &#34;继续运行&#34;
    checkout main
    commit id: &#34;原时间线继续&#34;</pre><p>当仓库存在多个时间线时，可通过 <code>timeline</code> 指定目标；Pigsty 默认使用 <code>latest</code>。
更多细节请参阅 <a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0f1a78edbba6d0b4ce0cad98c98b549c>2 - 时间点恢复的实现架构</h1><div class=lead>Pigsty PITR 的实现架构：pgBackRest、备份仓库与执行机制</div><p>Pigsty 使用 <a href=https://pgbackrest.org/><strong>pgBackRest</strong></a> 作为 PostgreSQL 备份与恢复引擎，提供开箱即用的时间点恢复（PITR）能力。</p><p>本文从架构层面说明：<strong>备份由谁执行、数据流向哪里、仓库如何组织、故障切换后如何保持连续性</strong>。</p><hr><h2 id=概览>概览</h2><p>PITR 架构由三条主线构成：<strong>备份执行链路</strong>、<strong>WAL 归档链路</strong>、<strong>恢复执行链路</strong>。</p><table class=full-width><thead><tr><th style=text-align:left>链路</th><th style=text-align:left>入口</th><th style=text-align:left>引擎</th><th style=text-align:left>终点</th></tr></thead><tbody><tr><td style=text-align:left>备份</td><td style=text-align:left><code>pg-backup</code> + <code>pg_crontab</code></td><td style=text-align:left><code>pgbackrest backup</code></td><td style=text-align:left>备份仓库 <code>backup/</code></td></tr><tr><td style=text-align:left>WAL 归档</td><td style=text-align:left>PostgreSQL <code>archive_command</code></td><td style=text-align:left><code>pgbackrest archive-push</code></td><td style=text-align:left>备份仓库 <code>archive/</code></td></tr><tr><td style=text-align:left>恢复</td><td style=text-align:left><code>pg_pitr</code> / <code>pg-pitr</code> / <code>pgsql-pitr.yml</code></td><td style=text-align:left><code>pgbackrest restore</code></td><td style=text-align:left>目标数据目录</td></tr></tbody></table><p>更多执行细节见 <a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a> 与 <a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a>。</p><hr><h2 id=组件与职责>组件与职责</h2><table class=full-width><thead><tr><th style=text-align:left>组件</th><th style=text-align:left>角色</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left><strong>PostgreSQL</strong></td><td style=text-align:left>数据源</td><td style=text-align:left>产生数据文件与 WAL 归档流</td></tr><tr><td style=text-align:left><strong>pgBackRest</strong></td><td style=text-align:left>备份引擎</td><td style=text-align:left>执行备份、接收/拉取 WAL、执行恢复</td></tr><tr><td style=text-align:left><strong>pg-backup</strong></td><td style=text-align:left>备份入口</td><td style=text-align:left>Pigsty 封装脚本，执行 <code>pgbackrest backup</code></td></tr><tr><td style=text-align:left><strong>pg_pitr / pg-pitr</strong></td><td style=text-align:left>恢复入口</td><td style=text-align:left>Pigsty 封装参数/脚本，执行 <code>pgbackrest restore</code></td></tr><tr><td style=text-align:left><strong>备份仓库</strong></td><td style=text-align:left>存储后端</td><td style=text-align:left>保存 <code>backup/</code> 与 <code>archive/</code>，支持 <code>local</code> / <code>minio</code> / <code>s3</code> 等仓库</td></tr><tr><td style=text-align:left><strong>pgbackrest_exporter</strong></td><td style=text-align:left>监控输出</td><td style=text-align:left>导出备份状态指标，默认监听 <code>9854</code> 端口</td></tr></tbody></table><hr><h2 id=数据流>数据流</h2><pre class=mermaid>flowchart TB
    subgraph cluster[&#34;PostgreSQL 集群&#34;]
        direction TB
        primary[&#34;Primary&lt;br/&gt;PostgreSQL&#34;]
        pb[&#34;pgBackRest&#34;]
        cron[&#34;pg-backup / pg_crontab&#34;]
    end
    repo[&#34;备份仓库&lt;br/&gt;local / minio / s3&#34;]
    restore[&#34;恢复目标数据目录&#34;]

    cron --&gt; pb
    primary --&gt;|base backup| pb
    primary --&gt;|WAL archive| pb
    pb --&gt;|backup/archive| repo
    repo --&gt;|restore/archive-get| pb
    pb --&gt;|restore| restore</pre><p>要点：</p><ul><li><strong>备份</strong> 由 <code>pg-backup</code> 触发，执行 <code>pgbackrest backup</code> 将基础备份写入仓库。</li><li><strong>归档</strong> 由 PostgreSQL 的 <code>archive_command</code> 触发，持续将 WAL 段写入仓库。</li><li><strong>恢复</strong> 从仓库读取备份与 WAL，通过 <code>pgbackrest restore</code> 重建数据目录。</li></ul><hr><h2 id=部署与角色>部署与角色</h2><p>pgBackRest 安装在 <strong>所有 PostgreSQL 节点</strong> 上，但只有 <strong>主库</strong> 实际执行备份：</p><ul><li><code>pg-backup</code> 会自动检测节点角色，从库执行时直接退出。</li><li>发生 <strong>故障切换</strong> 后，新主库自动接管备份与归档，备份连续性不受影响。</li></ul><p>这使得备份链路与高可用拓扑解耦，避免因主从切换导致备份中断。</p><hr><h2 id=仓库与隔离>仓库与隔离</h2><h3 id=stanza集群标识>Stanza（集群标识）</h3><p>pgBackRest 使用 <strong>stanza</strong> 隔离不同集群的备份，Pigsty 将其映射为 <code>pg_cluster</code>：</p><pre tabindex=0><code>备份仓库
├── pg-meta/
│   ├── backup/
│   └── archive/
└── pg-test/
    ├── backup/
    └── archive/
</code></pre><h3 id=仓库类型>仓库类型</h3><p>Pigsty 通过 <a href=/docs/pgsql/param#pgbackrest_method><code>pgbackrest_method</code></a> 选择仓库，通过
<a href=/docs/pgsql/param#pgbackrest_repo><code>pgbackrest_repo</code></a> 定义仓库参数：</p><table class=full-width><thead><tr><th style=text-align:left>类型</th><th style=text-align:left>特点</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:left><strong>local</strong></td><td style=text-align:left>本地磁盘，恢复最快</td><td style=text-align:left>开发/测试、单机部署</td></tr><tr><td style=text-align:left><strong>minio</strong></td><td style=text-align:left>对象存储，集中式备份</td><td style=text-align:left>生产环境、异地容灾</td></tr><tr><td style=text-align:left><strong>s3</strong></td><td style=text-align:left>云对象存储</td><td style=text-align:left>云上部署、跨区域容灾</td></tr></tbody></table><p>生产环境建议使用远程仓库（MinIO/S3），以避免主机故障导致 <strong>数据与备份同时丢失</strong>。
详见 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p><hr><h2 id=配置映射>配置映射</h2><p>Pigsty 会将 <code>pgbackrest_repo</code> 定义渲染为 <code>/etc/pgbackrest/pgbackrest.conf</code>。
备份日志位于 <code>/pg/log/pgbackrest/</code>，恢复过程生成临时配置并记录恢复日志。</p><p>更多细节请参阅 <a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a>。</p><hr><h2 id=可观测性>可观测性</h2><p><code>pgbackrest_exporter</code> 会导出备份状态指标（最近备份时间、类型、大小等），默认启用，监听端口 <code>9854</code>。
您可以通过 <a href=/docs/pgsql/param#pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></a> 控制该组件。</p><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a></li><li><a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a></li><li><a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a></li><li><a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-73a2e369df3734218f99f90230b96257>3 - 时间点恢复的策略权衡</h1><div class=lead>PITR 策略设计中的利弊权衡：仓库选择、空间规划与策略推荐</div><p>设计 PITR 策略时，最核心的权衡来自三个维度：
<strong>备份仓库位置</strong>、<strong>恢复窗口长度</strong>、<strong>恢复速度与空间成本</strong>。</p><p>本文帮助您在这些维度之间做出可操作的选择。</p><hr><h2 id=本地-vs-远程>本地 vs 远程</h2><p>备份仓库的位置是 PITR 策略设计的第一步。</p><h3 id=本地仓库>本地仓库</h3><p>将备份存储在主库本地磁盘（<code>pgbackrest_method = local</code>）：</p><p><strong>优势</strong></p><ul><li>配置简单，开箱即用</li><li>恢复速度快（本地 I/O）</li><li>无外部依赖</li></ul><p><strong>劣势</strong></p><ul><li>无异地容灾能力，主机故障时备份可能一同丢失</li><li>受限于本地磁盘容量</li><li>备份与生产数据位于同一故障域</li></ul><h3 id=远程仓库>远程仓库</h3><p>将备份存储到 MinIO / S3 等对象存储（<code>pgbackrest_method = minio|s3</code>）：</p><p><strong>优势</strong></p><ul><li>异地容灾，备份独立于数据库主机</li><li>容量几乎无限，多集群可共享</li><li>可配合加密、版本控制等安全策略</li></ul><p><strong>劣势</strong></p><ul><li>恢复速度受网络带宽影响</li><li>依赖对象存储的可用性</li><li>部署与运维成本更高</li></ul><h3 id=如何选择>如何选择</h3><table class=full-width><thead><tr><th style=text-align:left>场景</th><th style=text-align:left>推荐仓库</th><th style=text-align:left>理由</th></tr></thead><tbody><tr><td style=text-align:left>开发测试</td><td style=text-align:left>local</td><td style=text-align:left>简单够用，容灾要求低</td></tr><tr><td style=text-align:left>单机生产</td><td style=text-align:left>minio / s3</td><td style=text-align:left>主机故障仍可恢复</td></tr><tr><td style=text-align:left>集群生产</td><td style=text-align:left>local + minio</td><td style=text-align:left>兼顾恢复速度与异地容灾</td></tr><tr><td style=text-align:left>关键业务</td><td style=text-align:left>多远程仓库</td><td style=text-align:left>多地容灾，最高保护</td></tr></tbody></table><p>仓库配置细节请参阅 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p><hr><h2 id=空间-vs-窗口>空间 vs 窗口</h2><p>恢复窗口越长，所需存储空间越大。窗口长度由 <strong>备份保留策略 + WAL 归档保留</strong> 决定。</p><h3 id=影响因素>影响因素</h3><table class=full-width><thead><tr><th style=text-align:left>因素</th><th style=text-align:left>影响</th></tr></thead><tbody><tr><td style=text-align:left><strong>数据库规模</strong></td><td style=text-align:left>决定全量备份基准空间</td></tr><tr><td style=text-align:left><strong>变更速率</strong></td><td style=text-align:left>影响增量备份与 WAL 归档大小</td></tr><tr><td style=text-align:left><strong>备份频率</strong></td><td style=text-align:left>频率越高，恢复越快，但空间增长更快</td></tr><tr><td style=text-align:left><strong>保留时间</strong></td><td style=text-align:left>保留越久，恢复窗口越长，空间需求越大</td></tr></tbody></table><h3 id=直观示例>直观示例</h3><p>假设数据库 100GB，每天变更 10GB：</p><p><strong>每日全量备份（保留 2 份）</strong></p><p><img src=/img/pigsty/pitr-space.png alt=pitr-space></p><ul><li>全量备份：100GB × 2 ≈ 200GB</li><li>WAL 归档：10GB × 2 ≈ 20GB</li><li>总计：约 2～3 倍数据库空间</li></ul><p><strong>周全量 + 每日增量（保留 14 天）</strong></p><p><img src=/img/pigsty/pitr-space2.png alt=pitr-space2></p><ul><li>全量备份：100GB × 2 ≈ 200GB</li><li>增量备份：约 10GB × 12 ≈ 120GB</li><li>WAL 归档：10GB × 14 ≈ 140GB</li><li>总计：约 4～5 倍数据库空间</li></ul><p>空间与窗口的关系是刚性约束，无法通过配置“同时更长窗口 + 更少空间”。</p><hr><h2 id=策略选择>策略选择</h2><h3 id=每日全量备份>每日全量备份</h3><p><strong>最简单可靠的策略</strong>，也是 Pigsty 本地仓库的默认思路：</p><ul><li>每天一次全量备份</li><li>保留 2 份备份</li><li>恢复窗口约 24～48 小时</li></ul><p>适用场景：</p><ul><li>数据库规模中小（&lt; 500GB）</li><li>备份窗口充足</li><li>对存储空间不敏感</li></ul><h3 id=全量--增量备份>全量 + 增量备份</h3><p><strong>空间优化策略</strong>，适合大库或需要更长恢复窗口：</p><ul><li>每周一次全量备份</li><li>其他日期执行增量备份</li><li>保留 14 天</li></ul><p>适用场景：</p><ul><li>数据库规模较大</li><li>使用对象存储</li><li>需要 1～2 周恢复窗口</li></ul><pre class=mermaid>flowchart TD
    A{&#34;数据库大小&lt;br/&gt;&lt; 100GB？&#34;} --&gt;|是| B[&#34;每日全量备份&#34;]
    A --&gt;|否| C{&#34;数据库大小&lt;br/&gt;&lt; 500GB？&#34;}
    C --&gt;|否| D[&#34;全量 &#43; 增量备份&#34;]
    C --&gt;|是| E{&#34;备份窗口&lt;br/&gt;充足？&#34;}
    E --&gt;|是| F[&#34;每日全量备份&#34;]
    E --&gt;|否| G[&#34;全量 &#43; 增量备份&#34;]</pre><hr><h2 id=推荐配置>推荐配置</h2><h3 id=开发测试环境>开发测试环境</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>恢复窗口：24～48 小时</li><li>特点：配置最简，成本最低</li></ul><h3 id=生产集群>生产集群</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1 /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>恢复窗口：7～14 天</li><li>特点：异地容灾，适合生产环境</li></ul><h3 id=关键业务>关键业务</h3><p><strong>双仓库策略</strong>（本地 + 远程）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>path: /pg/backup, retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>type: s3, retention_full_type: time, retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>本地仓库用于快速恢复</li><li>远程仓库用于异地容灾</li></ul><p>更多配置细节请参阅 <a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a> 与 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-03fae0025a6c17d88ae21f91a462fbe6>4 - 时间点恢复的典型场景</h1><div class=lead>PITR 的典型应用场景：误删数据、误删表/库、批量错误、分支恢复与机房级灾难</div><p>PITR 的价值不在于“回滚数据库”本身，而在于<strong>把不可逆的人为/软件错误变回可恢复的问题</strong>。
它覆盖的场景从“误删一张表”到“整个机房不可用”，本质上解决的是<strong>逻辑错误与灾难恢复</strong>。</p><hr><h2 id=整体认知overview>整体认知（Overview）</h2><p>PITR 解决以下问题：</p><table class=full-width><thead><tr><th style=text-align:left>场景类型</th><th style=text-align:left>典型问题</th><th style=text-align:left>推荐策略</th><th style=text-align:left>恢复目标</th></tr></thead><tbody><tr><td style=text-align:left>误删/误更新数据（DML）</td><td style=text-align:left><code>DELETE/UPDATE</code> 无条件执行，脚本误操作</td><td style=text-align:left>分支恢复优先</td><td style=text-align:left><code>time</code> / <code>xid</code></td></tr><tr><td style=text-align:left>误删表/库/Schema（DDL）</td><td style=text-align:left><code>DROP TABLE/DATABASE</code>、错误迁移</td><td style=text-align:left>分支恢复</td><td style=text-align:left><code>time</code> / <code>name</code></td></tr><tr><td style=text-align:left>批量错误/发布事故</td><td style=text-align:left>Bug 批量污染数据，修复脚本失败</td><td style=text-align:left>分支恢复 + 验证</td><td style=text-align:left><code>time</code> / <code>xid</code></td></tr><tr><td style=text-align:left>数据审计/问题复盘</td><td style=text-align:left>需要查看历史状态，核对差异</td><td style=text-align:left>分支恢复（只读）</td><td style=text-align:left><code>time</code> / <code>lsn</code></td></tr><tr><td style=text-align:left>机房级灾难/全量丢失</td><td style=text-align:left>硬件故障、勒索、机房断电</td><td style=text-align:left>原地恢复或重建集群</td><td style=text-align:left><code>latest</code> / <code>time</code></td></tr></tbody></table><h3 id=一个简单的判断原则>一个简单的判断原则</h3><ul><li><strong>只要写入已经造成业务错误，就应该考虑 PITR</strong>。</li><li><strong>需要在线验证或只恢复部分数据 → 分支恢复</strong>。</li><li><strong>必须尽快恢复服务 → 原地恢复</strong>（可接受停机）。</li></ul><pre class=mermaid>flowchart TD
    A[&#34;发现问题&#34;] --&gt; B{&#34;能否停机？&#34;}
    B --&gt;|能| C[&#34;原地恢复&lt;br/&gt;最短恢复路径&#34;]
    B --&gt;|不能| D[&#34;分支恢复&lt;br/&gt;先验证后切换&#34;]
    C --&gt; E[&#34;恢复成功后重建备份&#34;]
    D --&gt; F[&#34;验证/导出/切流量&#34;]</pre><hr><h2 id=场景详情>场景详情</h2><h3 id=误删误更新数据dml>误删/误更新数据（DML）</h3><p><strong>典型问题</strong>：</p><ul><li><code>DELETE</code> 缺少 <code>WHERE</code></li><li>错误的 <code>UPDATE</code> 覆盖关键字段</li><li>批处理脚本逻辑错误导致脏数据扩散</li></ul><p><strong>处理思路</strong>：</p><ol><li><strong>止损</strong>：暂停相关应用或写入作业，防止数据继续被污染。</li><li><strong>定位时间点</strong>：结合日志、监控、业务反馈，确定错误发生时间。</li><li><strong>选择策略</strong>：<ul><li>能停机：原地恢复到错误之前</li><li>不能停机：分支恢复，导出正确数据再合并回主库</li></ul></li></ol><p><strong>恢复目标建议</strong>：</p><ul><li>有明确事务：<code>xid</code> + <code>exclusive: true</code></li><li>仅知道时间：<code>time</code> + <code>exclusive: true</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;250000&#34;</span><span style=color:#204a87;font-weight:700>, exclusive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-15 14:30:00+08&#34;</span><span style=color:#204a87;font-weight:700>, exclusive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h3 id=误删表--误删库ddl>误删表 / 误删库（DDL）</h3><p><strong>典型问题</strong>：</p><ul><li><code>DROP TABLE</code> / <code>DROP DATABASE</code></li><li>执行了错误迁移脚本</li><li>清理测试数据时误删生产对象</li></ul><p><strong>为何推荐分支恢复</strong>：</p><p>DDL 操作不可逆，<strong>原地恢复意味着全库回滚</strong>，风险高。
分支恢复可将误删对象导出并导回原库，影响最小。</p><p><strong>推荐流程</strong>：</p><ol><li>创建分支集群并 PITR 到误删前</li><li>校验表结构/数据正确性</li><li><code>pg_dump</code> 导出目标对象</li><li>导回生产库</li></ol><pre class=mermaid>sequenceDiagram
    participant O as 原集群
    participant B as 分支集群
    O-&gt;&gt;B: 创建分支集群
    Note over B: PITR 到误删之前
    B-&gt;&gt;O: 导出表/库并导回
    Note over B: 验证完成后销毁分支</pre><hr><h3 id=批量错误--发布事故>批量错误 / 发布事故</h3><p><strong>典型问题</strong>：</p><ul><li>某次版本发布写入错误数据</li><li>ETL 或批处理作业造成全量污染</li><li>修复脚本执行失败或影响范围不清晰</li></ul><p><strong>处理原则</strong>：</p><ul><li><strong>优先分支恢复</strong>：先验证恢复点，再决定是否切流量</li><li>对比原库与分支库数据差异，确认影响范围</li></ul><p><strong>建议流程</strong>：</p><ol><li>确定错误发布的时间窗口</li><li>分支恢复到“错误发生前”</li><li>校验关键业务表</li><li>决定导回部分数据，或整体切流量</li></ol><p>这个场景通常需要结合业务复盘，因此分支恢复更安全、更可控。</p><hr><h3 id=数据审计--问题复盘>数据审计 / 问题复盘</h3><p><strong>典型问题</strong>：</p><ul><li>需要查看某一时刻的数据状态</li><li>排查“历史正确状态”以比对差异</li></ul><p><strong>推荐方式</strong>：分支恢复（只读）</p><p><strong>优点</strong>：</p><ul><li>不影响生产</li><li>可多次尝试不同时间点</li><li>适合审计、核对与取证</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-15 10:00:00+08&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 创建只读分支</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h3 id=机房级灾难--全量丢失>机房级灾难 / 全量丢失</h3><p>这是 <strong>PITR 的终极兜底场景</strong>。当高可用无法应对时（主从同时不可用、机房断电、勒索攻击），PITR 是最后防线。</p><p><strong>关键前提</strong>：</p><blockquote><p><strong>必须使用远程仓库（MinIO/S3）</strong>。</p></blockquote><p>本地仓库在主机故障时会与数据一同丢失，无法恢复。</p><p><strong>恢复流程</strong>：</p><ol><li>准备新主机或新机房资源</li><li>还原集群配置并指向远程仓库</li><li>执行 PITR 恢复（通常 <code>latest</code>）</li><li>验证数据后恢复服务</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta   <span style=color:#8f5902;font-style:italic># 恢复到 WAL 归档末尾</span>
</span></span></code></pre></div><hr><h2 id=原地恢复-vs-分支恢复>原地恢复 vs 分支恢复</h2><table class=full-width><thead><tr><th style=text-align:left>维度</th><th style=text-align:left>原地恢复</th><th style=text-align:left>分支恢复</th></tr></thead><tbody><tr><td style=text-align:left>是否停机</td><td style=text-align:left>需要停机</td><td style=text-align:left>无需停机</td></tr><tr><td style=text-align:left>风险</td><td style=text-align:left>高（直接影响生产）</td><td style=text-align:left>低（可验证后操作）</td></tr><tr><td style=text-align:left>复杂度</td><td style=text-align:left>低</td><td style=text-align:left>中（需要新集群与数据导出）</td></tr><tr><td style=text-align:left>推荐场景</td><td style=text-align:left>快速恢复服务、容灾</td><td style=text-align:left>误操作恢复、审计、复杂场景</td></tr></tbody></table><p>对于绝大多数生产场景，<strong>分支恢复是默认推荐策略</strong>。
只有在 <strong>必须尽快恢复服务</strong> 时，才建议原地恢复。</p><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a></li><li><a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a></li><li><a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a></li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>