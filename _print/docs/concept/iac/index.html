<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/concept/iac/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/concept/iac/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>声明式配置 —— 基础设施即代码（IaC） | PIGSTY</title><meta name=description content="Pigsty 使用基础设施即代码（IaC）的理念管理所有组件，针对大规模集群提供声明式管理能力。"><meta property="og:url" content="https://pigsty.cc/docs/concept/iac/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="声明式配置 —— 基础设施即代码（IaC）"><meta property="og:description" content="Pigsty 使用基础设施即代码（IaC）的理念管理所有组件，针对大规模集群提供声明式管理能力。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="声明式配置 —— 基础设施即代码（IaC）"><meta itemprop=description content="Pigsty 使用基础设施即代码（IaC）的理念管理所有组件，针对大规模集群提供声明式管理能力。"><meta itemprop=dateModified content="2026-02-13T00:25:21+08:00"><meta itemprop=wordCount content="2505"><meta itemprop=keywords content="概念,PIGSTY"><meta name=twitter:card content="summary"><meta name=twitter:title content="声明式配置 —— 基础设施即代码（IaC）"><meta name=twitter:description content="Pigsty 使用基础设施即代码（IaC）的理念管理所有组件，针对大规模集群提供声明式管理能力。"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/concept/iac/>返回本页常规视图</a>.</p></div><h1 class=title>声明式配置 —— 基础设施即代码（IaC）</h1><div class=lead>Pigsty 使用基础设施即代码（IaC）的理念管理所有组件，针对大规模集群提供声明式管理能力。</div><ul><li>1: <a href=#pg-6b8b3debf71b9a47be1364eba07a65ae>配置清单</a></li><li>2: <a href=#pg-c48a7025a948ffe27199cd10986e517a>配置向导</a></li><li>3: <a href=#pg-e42d80439da940091a403ada6ca968af>配置参数</a></li><li>4: <a href=#pg-a71a0b133f9617fabea630bbd56757f4>配置模板</a></li><li>5: <a href=#pg-4f710b6522c00bd4a1ee261283a935b7>元数据库</a></li></ul><div class=content><p>Pigsty 遵循 IaC 与 GitOPS 的理念：使用声明式的 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 描述整个环境，并通过 <a href=/docs/setup/playbook><strong>幂等剧本</strong></a> 来实现。</p><p>用户用声明的方式通过 <a href=/docs/ref/param><strong>参数</strong></a> 来描述自己期望的状态，而剧本则以幂等的方式调整目标节点以达到这个状态。
这类似于 Kubernetes 的 CRD & Operator，然而 Pigsty 在裸机和虚拟机上，通过 Ansible 实现了这样的功能。</p><p>Pigsty 诞生之初是为了解决超大规模 PostgreSQL 集群的运维管理问题，背后的想法很简单 —— 我们需要有在十分钟内在就绪的服务器上复刻整套基础设施（100+数据库集群 + PG/Redis + 可观测性）的能力。
任何 GUI + ClickOps 都无法在如此短的时间内完成如此复杂的任务，这让 CLI + IaC 成为唯一的选择 —— 它提供了精确，高效的控制能力。</p><p><a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> <strong><code>pigsty.yml</code></strong> 文件描述了整个部署的状态，无论是 生产环境（prod），预发环境（staging）， 测试环境（test），还是 开发环境（devbox），
基础设施的区别仅在于配置清单的不同，而部署交付的逻辑则是完全相同的。</p><p>您可以使用 git 对这份部署的 “种子/基因” 进行版本控制与审计，而且，Pigsty 甚至支持将配置清单以数据库表的形式存储在 PostgreSQL <a href=/docs/concept/iac/cmdb><strong>CMDB</strong></a> 中，
更进一步从 Infra as Code 升级为 Infra as Data，无缝与您现有的工作流程集成与对接。</p><p>IaC 面向专业用户与企业场景而设计，但也针对个人开发者，SMB 进行了深度优化。
即使您并非专业 DBA，也无需了解这几百个调节开关与旋钮，所有参数都带有表现良好的默认值，
您完全可以在 <strong>零配置</strong> 的情况下，获得一个开箱即用的单机数据库节点；
简单地再添加两行 IP 地址，就能获得一套企业级的高可用的 PostgreSQL 集群。</p><hr><h2 id=声明模块>声明模块</h2><p>以下面的默认配置片段为例，这段配置描述了一个节点 <code>10.10.10.10</code>，其上安装了 <a href=/docs/infra><strong><code>INFRA</code></strong></a>、<a href=/docs/node><strong><code>NODE</code></strong></a>、<a href=/docs/etcd><strong><code>ETCD</code></strong></a> 和 <a href=/docs/pgsql><strong><code>PGSQL</code></strong></a> 模块。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 监控、告警、DNS、NTP 等基础设施集群...</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># minio 集群，兼容 s3 的对象存储</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># etcd 集群，用作 PostgreSQL 高可用所需的 DCS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL 示例集群: pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>要真正安装这些模块，执行以下剧本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># 在节点 10.10.10.10 上初始化 infra 模块</span>
</span></span><span style=display:flex><span>./etcd.yml  -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># 在节点 10.10.10.10 上初始化 etcd 模块</span>
</span></span><span style=display:flex><span>./minio.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># 在节点 10.10.10.10 上初始化 minio 模块</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># 在节点 10.10.10.10 上初始化 pgsql 模块</span>
</span></span></code></pre></div><hr><h2 id=声明集群>声明集群</h2><p>您可以声明 PostgreSQL 数据库集群，在多个节点上安装 <a href=/docs/pgsql/><strong><code>PGSQL</code></strong></a> 模块，并使其成为一个服务单元：</p><p>例如，要在以下三个已被 Pigsty 纳管的节点上，部署一个使用流复制组建的三节点高可用 PostgreSQL 集群，
您可以在配置文件 <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><code>pigsty.yml</code></a> 的 <code>all.children</code> 中添加以下定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>定义完后，可以使用 <a href=/docs/setup/playbook/><strong>剧本</strong></a> 将集群创建：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># 创建 pg-test 集群 </span>
</span></span></code></pre></div><p><img src=/img/pigsty/iac.jpg alt=pigsty-iac.jpg></p><p>你可以使用不同的实例角色，例如 <a href=/docs/pgsql/config/cluster#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93><strong>主库</strong></a>（primary），<a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93><strong>从库</strong></a>（replica），<a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93><strong>离线从库</strong></a>（offline），<a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4><strong>延迟从库</strong></a>（delayed），<a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93><strong>同步备库</strong></a>（sync standby）；
以及不同的集群：例如 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4><strong>备份集群</strong></a>（Standby Cluster），<a href=/docs/pgsql/config/cluster#citus%E9%9B%86%E7%BE%A4><strong>Citus 集群</strong></a>，甚至是 <a href=/docs/redis><strong>Redis</strong></a> / <a href=/docs/minio><strong>MinIO</strong></a> / <a href=/docs/etcd><strong>Etcd</strong></a> 集群</p><hr><h2 id=定制集群内容>定制集群内容</h2><p>您不仅可以使用声明式的方式定义集群，还可以定义集群中的数据库、用户、服务、HBA 规则等内容，例如，下面的配置文件对默认的 <code>pg-meta</code> 单节点数据库集群的内容进行了深度定制：</p><p>包括：声明了六个业务数据库与七个业务用户，添加了一个额外的 <code>standby</code> 服务（同步备库，提供无复制延迟的读取能力），定义了一些额外的 <code>pg_hba</code> 规则，一个指向集群主库的 L2 VIP 地址，与自定义的备份策略。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># define business databases on this cluster, array of database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database sql baseline path, (relative path among ansible search path, e.g files/)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this database to pgbouncer database list? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, additional schemas to be created, array of schema names</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions:                     # optional, additional extensions to be installed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>array of `{name[,schema]}`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database owner, postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, which template to use, template1 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database encoding, UTF8 by default. (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database locale, C by default.  (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database collate, C by default. (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database ctype, C by default.   (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, default tablespace, &#39;pg_default&#39; by default.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, allow connection, true by default. false will disable connect at all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, revoke public connection privilege. false by default. (leave connect with grant option to owner)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># optional, register this database to grafana datasources? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, database connection limit, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, all connection to this pgbouncer database will be authenticated by this user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at database level, default transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size at database level, default 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size reserve at database level, default 32</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size min at database level, default 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># optional, max database connections at database level, default 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># define business users/roles on this cluster, array of user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, password, can be a scram-sha-256 hash string or plain text</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># optional, can log in, true by default  (new biz ROLE should be false)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, is superuser? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, can create database? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, can create role? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, can this role use inherited privileges? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, can this role do replication? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, can this role bypass row level security? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this user to pgbouncer user-list? false by default (production user should be true explicitly)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, user connection limit, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, now + n days when this role is expired (OVERWRITE expire_at)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># optional, YYYY-MM-DD &#39;timestamp&#39; when this role is expired  (OVERWRITTEN by expire_in)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this user/role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>roles: [dbrole_admin]           # optional, belonged roles. default roles are</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_{admin,readonly,readwrite,offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, role level parameters with `ALTER ROLE SET`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at user level, transaction by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, max database connections at user level, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service      }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                        </span><span style=color:#8f5902;font-style:italic># extra services in addition to pg_default_services, array of service definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># standby service will route {ip|name}:5435 to sync replica&#39;s pgbouncer (5435-&gt;6432 standby)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name: standby                   # required, service name, the actual svc name will be prefixed with `pg_cluster`, e.g</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># required, service exposed port (work as kubernetes service node port mode)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># optional, service bind ip address, `*` for all ip by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># required, service member selector, use JMESPath to filter inventory</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, destination port, default|postgres|pgbouncer|&lt;port_number&gt;, &#39;default&#39; by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>check</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, health check url path, / by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># backup server selector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, max allowed front-end connection</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>balance: roundrobin             # optional, haproxy load balance algorithm (roundrobin by default, other</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>leastconn)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.2</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># make a full backup 1 am everyday</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=声明访问控制>声明访问控制</h2><p>您还可以通过声明式的配置，深度定制 Pigsty 的访问控制能力。例如下面的配置文件对 <code>pg-meta</code> 集群进行了深度安全定制：</p><p>使用三节点核心集群模板：<code>crit.yml</code>，确保数据一致性有限，故障切换数据零丢失。
启用了 L2 VIP，并将数据库与连接池的监听地址限制在了本地环回 IP + 内网 IP + VIP 三个特定地址。
模板强制启用了 Patroni 的 SSL API，与 Pgbouncer 的 SSL，并在 HBA 规则中强制要求使用 SSL 访问数据库集群。
同时还在 <code>pg_libs</code> 中启用了 <code>$libdir/passwordcheck</code> 扩展，来强制执行密码强度安全策略。</p><p>最后，还单独声明了一个 <code>pg-meta-delay</code> 集群，作为 <code>pg-meta</code> 在一个小时前的延迟镜像从库，用于紧急数据误删恢复。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 3 instance postgres cluster `pg-meta`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta , password: DBUser.Meta   , pgbouncer: true , roles: [ dbrole_admin ] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view , password: DBUser.Viewer , pgbouncer: true , roles: [ dbrole_readonly ] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: standby ,src_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,port: 5435 , dest: default ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.2</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_listen</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${ip},${vip},${lo}&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_ssl_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>require</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, $libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add passwordcheck extension to enforce strong password</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly]               ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite]  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,expire_in: 7300                        ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,expire_in: 7300 ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,expire_in: 7300 ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,expire_in: 7300 ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres host-based auth rules by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: cert  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; cert&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer host-based authentication rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu local admin access with os ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user local access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor access via intranet with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other monitor access addr&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin access via intranet with pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other admin access addr&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user intra access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># OPTIONAL delayed cluster for pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta-delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># delayed instance for pg-meta (1 hour ago)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_upstream: 10.10.10.10, pg_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1h } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-delay }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=citus-分布式集群>Citus 分布式集群</h2><p>下面是一个四节点的 Citus 分布式集群的声明式配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus coordinator, pg_group = 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 3, with an extra replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.14</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># global parameters for all citus clusters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                    # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_citus_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus distributed database name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=redis-集群>Redis 集群</h2><p>下面给出了 Redis 主从集群、哨兵集群、以及 Redis Cluster 的声明配置样例</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-ms</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># redis classic primary &amp; replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 , redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_cluster: redis-ms ,redis_password: &#39;redis.ms&#39; ,redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MB }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># redis sentinel x 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 , redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>26379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,26380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,26381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_sentinel_monitor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary list for redis sentinel, use cls as name, primary ip:port</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: redis-ms, host: 10.10.10.10, port: 6379 ,password: redis.ms, quorum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-test: # redis native cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>3m x 3s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 ,redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 2 ,redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_cluster: redis-test ,redis_password: &#39;redis.test&#39; ,redis_mode: cluster, redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=etcd-集群>ETCD 集群</h2><p>下面给出了一个三节点的 Etcd 集群声明式配置样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># dcs service for postgres/patroni ha consensus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 1 node for testing, 3 or 5 for production</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># etcd_seq required</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># assign from 1 ~ n</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># odd number please</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># cluster level parameter override roles/etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># mark etcd cluster name etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># safeguard against purging</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_clean</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># purge etcd during init process</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=minio-集群>MinIO 集群</h2><p>下面给出了一个三节点的 MinIO 集群声明式配置样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data{1...2}&#39;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 每个节点使用两块磁盘</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${minio_cluster}-${minio_seq}.pigsty&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 节点名称的模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>haproxy_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># [必选] 服务名称，需要唯一</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9002</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># [必选] 服务端口，需要唯一</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>http-check send meth OPTIONS uri /minio/health/live</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>servers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-1 ,ip: 10.10.10.10 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-2 ,ip: 10.10.10.11 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-3 ,ip: 10.10.10.12 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6b8b3debf71b9a47be1364eba07a65ae>1 - 配置清单</h1><div class=lead>使用声明式的配置文件描述你需要的基础设施与集群</div><p>每一套 Pigsty 部署都对应着一份 <strong>配置清单</strong> （Inventory），描述了基础设施与数据库集群的关键属性。</p><hr><h2 id=配置文件>配置文件</h2><p>Pigsty 默认使用 <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html><strong>Ansible YAML 配置格式</strong></a>，
使用一个单一 YAML 配置文件 <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><strong><code>pigsty.yml</code></strong></a> 作为配置清单。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/pigsty
</span></span><span style=display:flex><span>  ^---- pigsty.yml   <span style=color:#8f5902;font-style:italic># &lt;---- 默认配置文件</span>
</span></span></code></pre></div><p>您可以直接修改该配置文件来定制您的部署，或者使用 Pigsty 提供的 <a href=/docs/concept/iac/configure><strong>配置向导</strong></a> <strong><code>configure</code></strong> 脚本自动生成合适的配置文件。</p><hr><h2 id=配置结构>配置结构</h2><p>配置清单使用标准的 <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html><strong>Ansible YAML 配置格式</strong></a>，由两部分组成：<strong>全局参数</strong> （<code>all.vars</code>）和多个 <strong>组</strong>（<code>all.children</code>）。</p><p>您可以在 <code>all.children</code> 中定义新集群，并使用全局变量描述基础设施：<code>all.vars</code>，它看起来像这样：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># 顶级对象：all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 全局参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 组定义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组成员：&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span>{<span style=color:#000>...}       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组参数：&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#000>...}   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;etcd&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;pg-meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;pg-test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;redis-test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=集群定义>集群定义</h2><p>每个 Ansible 组可能代表一个集群，可以是节点集群、PostgreSQL 集群、Redis 集群、Etcd 集群或 MinIO 集群等…</p><p>集群定义由两部分组成：<strong>集群成员</strong> （<strong><code>hosts</code></strong>）与 <strong>集群参数</strong>（<strong><code>vars</code></strong>）。
您可以在 <code>&lt;cls>.hosts</code> 中定义集群成员，并在 <code>&lt;cls>.vars</code> 中使用 <a href=/docs/concept/iac/parameter><strong>配置参数</strong></a> 描述集群。
下面是一个 3 节点高可用 PostgreSQL 集群的定义示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ansible 组列表</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># ansible 组名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># ansible 组内实例（集群成员）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主机 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主机 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主机 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ansible 组变量（集群参数）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>集群级别的 <code>vars</code> （集群参数）将覆盖全局参数，实例级别的 <code>vars</code> 将覆盖集群参数和全局参数。</p><hr><h2 id=拆分配置>拆分配置</h2><p>如果您的部署规模较大，或者希望更好地组织配置文件，
可以将配置清单 <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html#id18><strong>拆分为多个文件</strong></a>，便于管理与维护。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>inventory/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>├── hosts.yml             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主机和集群定义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>├── group_vars/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── all.yml           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 全局默认变量 (对应 all.vars)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── infra.yml         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># infra 组变量</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── etcd.yml          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># etcd 组变量</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   └── pg-meta.yml       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg-meta 集群变量</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>└── host_vars/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>├── 10.10.10.10.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 特定主机变量</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>└── 10.10.10.11.yml</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您可以将集群成员定义放在 <code>hosts.yml</code> 文件中，将集群层面的 <a href=/docs/concept/iac/parameter#%E5%8F%82%E6%95%B0%E4%BC%98%E5%85%88%E7%BA%A7><strong>配置参数</strong></a> 放在 <code>group_vars</code> 目录下的对应文件中。</p><hr><h2 id=切换配置>切换配置</h2><p>您可以在执行剧本的时候，通过 <code>-i</code> 参数，临时指定另外的配置清单文件。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -i another_config.yml
</span></span><span style=display:flex><span>./infra.yml -i nginx_config.yml
</span></span></code></pre></div><p>此外，Ansible 支持多种配置方式，您可以使用本地 <code>yaml|ini</code> 配置文件，或者是 CMDB 与任意的动态配置脚本作为配置源。</p><p>在 Pigsty 中，我们通过 Pigsty 主目录中的 <a href=https://github.com/pgsty/pigsty/blob/main/ansible.cfg#L6><strong><code>ansible.cfg</code></strong></a>
指定同目录下的 <strong><code>pigsty.yml</code></strong> 作为默认的 <strong>配置清单</strong>，您可按需修改。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[defaults]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>inventory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pigsty.yml</span>
</span></span></code></pre></div><p>此外，Pigsty 还支持使用 <a href=/docs/concept/iac/cmdb><strong>CMDB 元数据库</strong></a> 来存储配置清单，便于与现有系统对接整合。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c48a7025a948ffe27199cd10986e517a>2 - 配置向导</h1><div class=lead>使用 configure 脚本根据当前环境自动生成推荐的配置文件。</div><p>Pigsty 提供了一个 <strong><code>configure</code></strong> 脚本作为 <strong>配置向导</strong>，它能根据当前环境，自动生成合适的 <code>pigsty.yml</code> 配置文件。</p><p>这是一个 <strong>可选</strong> 的脚本：如果您已经了解了如何配置 Pigsty，大可以直接编辑 <code>pigsty.yml</code> 配置文件，跳过向导。</p><hr><h2 id=快速开始>快速开始</h2><p>进入 pigsty 源码家目录中，执行 <code>./configure</code> 即可自动运行配置向导。不带任何参数时，默认使用 <a href=/docs/conf/meta><strong><code>meta</code></strong></a> 单节点配置模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty
</span></span><span style=display:flex><span>./configure          <span style=color:#8f5902;font-style:italic># 交互式配置向导，自动检测环境并生成配置</span>
</span></span></code></pre></div><p>该命令会以选定的模板为基础，检测当前节点的 IP 地址与区域，并生成适合当前环境的 <code>pigsty.yml</code> 配置文件。</p><div id=asciinema-faf4cf8e717f5b9f582b3cede024d31c class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-faf4cf8e717f5b9f582b3cede024d31c",o="/demo/configure.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[3,"默认配置"],[7,"指定IP"],[14,"随机密码"],[17,"rich模板"],[20,"app/odoo模板"],[26,"china区域"],[33,"ha/full模板"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><h2 id=功能说明>功能说明</h2><p><strong><code>configure</code></strong> 脚本会根据环境与输入执行以下调整，并在当前目录下生成 <code>pigsty.yml</code> 配置文件。</p><ul><li>检测当前节点 IP 地址，如果有多个 IP，则要求用户输入一个 <strong>首要的 IP 地址</strong> 作为当前节点的身份标识</li><li>使用 IP 地址替换配置模板中的占位符 <strong><code>10.10.10.10</code></strong>，并将其配置为 <a href=/docs/infra/param#admin_ip><strong><code>admin_ip</code></strong></a> 参数的值。</li><li>检测当前区域，将 <a href=/docs/infra/param#region><strong><code>region</code></strong></a> 设置为 <strong><code>default</code></strong> （全球默认仓库）或 <strong><code>china</code></strong> （使用中国镜像仓库）</li><li>针对小微实例（vCPU &lt; 4），为 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> 和 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数使用 <strong><code>tiny</code></strong> 参数模板，优化资源使用。</li><li>如果指定了 <strong><code>-v</code></strong> PG 大版本，将 <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a> 以及所有 PG 别名参数设置为对应大版本。</li><li>如果指定了 <strong><code>-g</code></strong> 参数，将所有默认密码替换为随机生成的强密码，提升安全性。（<strong>强烈推荐</strong>）</li><li>当 PG 大版本 ≥ 17 时优先使用内置的 <strong><code>C.UTF-8</code></strong> Locale，次选由操作系统支持的 <strong><code>C.UTF-8</code></strong> 。</li><li>检测当前环境中，用于执行部署的核心依赖 <strong><code>ansible</code></strong> 是否可用</li><li>同时检测部署目标节点是否 ssh 可达，并可以使用 sudo 执行命令。（<strong><code>-s</code></strong> 跳过）</li></ul><hr><h2 id=使用示例>使用示例</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 基本用法</span>
</span></span><span style=display:flex><span>./configure                       <span style=color:#8f5902;font-style:italic># 交互式配置向导</span>
</span></span><span style=display:flex><span>./configure -i 10.10.10.10        <span style=color:#8f5902;font-style:italic># 指定主 IP 地址</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指定配置模板</span>
</span></span><span style=display:flex><span>./configure -c meta               <span style=color:#8f5902;font-style:italic># 使用默认单节点模板（默认）</span>
</span></span><span style=display:flex><span>./configure -c rich               <span style=color:#8f5902;font-style:italic># 使用功能丰富的单节点模板</span>
</span></span><span style=display:flex><span>./configure -c slim               <span style=color:#8f5902;font-style:italic># 使用精简模板（仅 PGSQL + ETCD）</span>
</span></span><span style=display:flex><span>./configure -c ha/full            <span style=color:#8f5902;font-style:italic># 使用 4 节点高可用沙箱模板</span>
</span></span><span style=display:flex><span>./configure -c ha/trio            <span style=color:#8f5902;font-style:italic># 使用 3 节点高可用模板</span>
</span></span><span style=display:flex><span>./configure -c app/supa           <span style=color:#8f5902;font-style:italic># 使用 Supabase 自托管模板</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指定 PostgreSQL 版本</span>
</span></span><span style=display:flex><span>./configure -v <span style=color:#0000cf;font-weight:700>17</span>                 <span style=color:#8f5902;font-style:italic># 使用 PostgreSQL 17</span>
</span></span><span style=display:flex><span>./configure -v <span style=color:#0000cf;font-weight:700>16</span>                 <span style=color:#8f5902;font-style:italic># 使用 PostgreSQL 16</span>
</span></span><span style=display:flex><span>./configure -c rich -v <span style=color:#0000cf;font-weight:700>16</span>         <span style=color:#8f5902;font-style:italic># rich 模板 + PG 16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 区域与代理</span>
</span></span><span style=display:flex><span>./configure -r china              <span style=color:#8f5902;font-style:italic># 使用中国镜像源</span>
</span></span><span style=display:flex><span>./configure -r europe             <span style=color:#8f5902;font-style:italic># 使用欧洲镜像源</span>
</span></span><span style=display:flex><span>./configure -x                    <span style=color:#8f5902;font-style:italic># 导入当前代理环境变量</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 跳过与自动化</span>
</span></span><span style=display:flex><span>./configure -s                    <span style=color:#8f5902;font-style:italic># 跳过 IP 探测，保留占位符</span>
</span></span><span style=display:flex><span>./configure -n -i 10.10.10.10     <span style=color:#8f5902;font-style:italic># 非交互模式，指定 IP</span>
</span></span><span style=display:flex><span>./configure -c ha/full -s         <span style=color:#8f5902;font-style:italic># 4 节点模板，跳过 IP 替换</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 安全增强</span>
</span></span><span style=display:flex><span>./configure -g                    <span style=color:#8f5902;font-style:italic># 生成随机密码</span>
</span></span><span style=display:flex><span>./configure -c meta -g -i 10.10.10.10  <span style=color:#8f5902;font-style:italic># 完整生产配置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指定输出与 SSH 端口</span>
</span></span><span style=display:flex><span>./configure -o prod.yml           <span style=color:#8f5902;font-style:italic># 输出到 prod.yml</span>
</span></span><span style=display:flex><span>./configure -p <span style=color:#0000cf;font-weight:700>2222</span>               <span style=color:#8f5902;font-style:italic># 使用 SSH 端口 2222</span>
</span></span></code></pre></div><hr><h2 id=命令参数>命令参数</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-c<span style=color:#000;font-weight:700>|</span>--conf &lt;template&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># 配置模板名称（meta|rich|slim|ha/full|...）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-i<span style=color:#000;font-weight:700>|</span>--ip &lt;ipaddr&gt;<span style=color:#ce5c00;font-weight:700>]</span>          <span style=color:#8f5902;font-style:italic># 指定主 IP 地址</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-v<span style=color:#000;font-weight:700>|</span>--version &lt;pgver&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># PostgreSQL 大版本号（13|14|15|16|17|18）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-r<span style=color:#000;font-weight:700>|</span>--region &lt;region&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># 上游软件仓库区域（default|china|europe）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-o<span style=color:#000;font-weight:700>|</span>--output &lt;file&gt;<span style=color:#ce5c00;font-weight:700>]</span>        <span style=color:#8f5902;font-style:italic># 输出配置文件路径（默认：pigsty.yml）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-s<span style=color:#000;font-weight:700>|</span>--skip<span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#8f5902;font-style:italic># 跳过 IP 地址探测与替换</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-x<span style=color:#000;font-weight:700>|</span>--proxy<span style=color:#ce5c00;font-weight:700>]</span>                <span style=color:#8f5902;font-style:italic># 从环境变量导入代理设置</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-n<span style=color:#000;font-weight:700>|</span>--non-interactive<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># 非交互模式（不询问任何问题）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-p<span style=color:#000;font-weight:700>|</span>--port &lt;port&gt;<span style=color:#ce5c00;font-weight:700>]</span>          <span style=color:#8f5902;font-style:italic># 指定 SSH 端口</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-g<span style=color:#000;font-weight:700>|</span>--generate<span style=color:#ce5c00;font-weight:700>]</span>             <span style=color:#8f5902;font-style:italic># 生成随机密码</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-h<span style=color:#000;font-weight:700>|</span>--help<span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#8f5902;font-style:italic># 显示帮助信息</span>
</span></span></code></pre></div><h3 id=参数详解>参数详解</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>-c, --conf</code></td><td style=text-align:left>从 <code>conf/&lt;template>.yml</code> 生成配置文件，支持子目录如 <code>ha/full</code></td></tr><tr><td style=text-align:left><code>-i, --ip</code></td><td style=text-align:left>用指定 IP 替换配置模板中的占位符 <code>10.10.10.10</code></td></tr><tr><td style=text-align:left><code>-v, --version</code></td><td style=text-align:left>指定 PostgreSQL 大版本号（13-18），不指定时保持模板默认值</td></tr><tr><td style=text-align:left><code>-r, --region</code></td><td style=text-align:left>设置软件仓库镜像区域：<code>default</code>（默认）、<code>china</code>（中国镜像）、<code>europe</code>（欧洲镜像）</td></tr><tr><td style=text-align:left><code>-o, --output</code></td><td style=text-align:left>指定输出文件路径，默认为 <code>pigsty.yml</code></td></tr><tr><td style=text-align:left><code>-s, --skip</code></td><td style=text-align:left>跳过 IP 地址探测与替换，保留模板中的 <code>10.10.10.10</code> 占位符</td></tr><tr><td style=text-align:left><code>-x, --proxy</code></td><td style=text-align:left>将当前环境的代理变量（<code>HTTP_PROXY</code>、<code>HTTPS_PROXY</code>、<code>ALL_PROXY</code>、<code>NO_PROXY</code>）写入配置</td></tr><tr><td style=text-align:left><code>-n, --non-interactive</code></td><td style=text-align:left>非交互模式，不询问任何问题（需配合 <code>-i</code> 指定 IP）</td></tr><tr><td style=text-align:left><code>-p, --port</code></td><td style=text-align:left>指定 SSH 端口（非默认 22 端口时使用）</td></tr><tr><td style=text-align:left><code>-g, --generate</code></td><td style=text-align:left><strong>为配置文件中的密码生成随机值，提高安全性（强烈推荐）</strong></td></tr></tbody></table><hr><h2 id=执行流程>执行流程</h2><p><code>configure</code> 脚本按照以下顺序执行检测与配置：</p><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────┐
│                    configure 执行流程                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. check_region          检测网络区域（GFW 检测）              │
│         ↓                                                   │
│  2. check_version         验证 PostgreSQL 版本号              │
│         ↓                                                   │
│  3. check_kernel          检测操作系统内核（Linux/Darwin）       │
│         ↓                                                   │
│  4. check_machine         检测 CPU 架构（x86_64/aarch64）      │
│         ↓                                                   │
│  5. check_package_manager 检测包管理器（dnf/yum/apt）           │
│         ↓                                                   │
│  6. check_vendor_version  检测 OS 发行版与版本                  │
│         ↓                                                   │
│  7. check_sudo            检测免密 sudo 权限                   │
│         ↓                                                   │
│  8. check_ssh             检测免密 SSH 到本机                   │
│         ↓                                                   │
│  9. check_proxy           处理代理环境变量                      │
│         ↓                                                   │
│ 10. check_ipaddr          探测/输入主 IP 地址                   │
│         ↓                                                   │
│ 11. check_admin           验证管理员 SSH + Sudo 权限            │
│         ↓                                                   │
│ 12. check_conf            选择配置模板                         │
│         ↓                                                   │
│ 13. check_config          生成配置文件                         │
│         ↓                                                   │
│ 14. check_utils           检测 Ansible 等工具是否安装           │
│         ↓                                                   │
│     ✓ 配置完成，输出 pigsty.yml                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre><hr><h2 id=自动化行为>自动化行为</h2><h3 id=区域检测>区域检测</h3><p>脚本会自动检测网络环境，判断是否在中国大陆（GFW 内）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过访问 Google 判断网络环境</span>
</span></span><span style=display:flex><span>curl -I -s --connect-timeout <span style=color:#0000cf;font-weight:700>1</span> www.google.com
</span></span></code></pre></div><ul><li>如果无法访问 Google，自动设置 <code>region: china</code> 使用国内镜像</li><li>如果可以访问，使用 <code>region: default</code> 默认镜像</li><li>可通过 <code>-r</code> 参数手动指定区域</li></ul><h3 id=ip-地址处理>IP 地址处理</h3><p>脚本按以下优先级确定主 IP 地址：</p><ol><li><strong>命令行参数</strong>：如果通过 <code>-i</code> 指定了 IP，直接使用</li><li><strong>单 IP 探测</strong>：如果当前节点只有一个 IP，自动使用</li><li><strong>演示 IP 检测</strong>：如果检测到 <code>10.10.10.10</code>，自动选择（用于沙箱环境）</li><li><strong>交互式输入</strong>：多个 IP 时，提示用户选择或输入</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> Multiple IP address candidates found:
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span> 192.168.1.100   inet 192.168.1.100/24 scope global eth0
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> 10.10.10.10     inet 10.10.10.10/24 scope global eth1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> IN <span style=color:#ce5c00;font-weight:700>]</span> INPUT primary_ip address <span style=color:#ce5c00;font-weight:700>(</span>of current meta node, e.g 10.10.10.10<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>=</span>&gt; 10.10.10.10
</span></span></code></pre></div><h3 id=低端硬件优化>低端硬件优化</h3><p>当检测到 CPU 核心数 ≤ 4 时，脚本会自动调整配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> replace oltp template with tiny due to cpu &lt; <span style=color:#0000cf;font-weight:700>4</span>
</span></span></code></pre></div><ul><li>将 <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a> 从 <code>oltp.yml</code> 改为 <code>tiny.yml</code></li><li>将 <a href=/docs/node/param#node_tune><code>node_tune</code></a> 从 <code>oltp</code> 改为 <code>tiny</code></li></ul><p>这样可以确保在低配虚拟机上也能顺利运行。</p><h3 id=locale-设置>Locale 设置</h3><p>脚本会在以下情况自动启用 <code>C.UTF-8</code> 作为默认 Locale：</p><ul><li>PostgreSQL 版本 ≥ 17（内置 Locale Provider 支持）</li><li><strong>或者</strong> 当前系统支持 <code>C.UTF-8</code> / <code>C.utf8</code> Locale</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=中国区特殊处理>中国区特殊处理</h3><p>当区域设置为 <code>china</code> 时，脚本会自动：</p><ul><li>启用 <code>docker_registry_mirrors</code> Docker 镜像加速</li><li>启用 <code>PIP_MIRROR_URL</code> Python 镜像加速</li></ul><h3 id=密码生成>密码生成</h3><p>使用 <code>-g</code> 参数时，脚本会为以下密码生成 24 位随机字符串：</p><table><thead><tr><th style=text-align:center>密码参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>grafana_admin_password</code></td><td style=text-align:left>Grafana 管理员密码</td></tr><tr><td style=text-align:center><code>pg_admin_password</code></td><td style=text-align:left>PostgreSQL 管理员密码</td></tr><tr><td style=text-align:center><code>pg_monitor_password</code></td><td style=text-align:left>PostgreSQL 监控用户密码</td></tr><tr><td style=text-align:center><code>pg_replication_password</code></td><td style=text-align:left>PostgreSQL 复制用户密码</td></tr><tr><td style=text-align:center><code>patroni_password</code></td><td style=text-align:left>Patroni API 密码</td></tr><tr><td style=text-align:center><code>haproxy_admin_password</code></td><td style=text-align:left>HAProxy 管理密码</td></tr><tr><td style=text-align:center><code>minio_secret_key</code></td><td style=text-align:left>MinIO Secret Key</td></tr><tr><td style=text-align:center><code>etcd_root_password</code></td><td style=text-align:left>ETCD Root 密码</td></tr></tbody></table><p>同时还会替换以下占位符密码：</p><ul><li><code>DBUser.Meta</code> → 随机密码</li><li><code>DBUser.Viewer</code> → 随机密码</li><li><code>S3User.Backup</code> → 随机密码</li><li><code>S3User.Meta</code> → 随机密码</li><li><code>S3User.Data</code> → 随机密码</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./configure -g
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> generating random passwords...
</span></span><span style=display:flex><span>    grafana_admin_password   : xK9mL2nP4qR7sT1vW3yZ5bD8
</span></span><span style=display:flex><span>    pg_admin_password        : aB3cD5eF7gH9iJ1kL2mN4oP6
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> random passwords generated, check and save them
</span></span></code></pre></div><hr><h2 id=配置模板>配置模板</h2><p>脚本从 <code>conf/</code> 目录读取配置模板，支持以下模板：</p><h3 id=核心模板>核心模板</h3><table class=full-width><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>meta</code></td><td style=text-align:left><strong>默认模板</strong>：单节点安装，包含 INFRA + NODE + ETCD + PGSQL</td></tr><tr><td style=text-align:center><code>rich</code></td><td style=text-align:left>功能丰富版：包含几乎所有扩展、MinIO、本地仓库</td></tr><tr><td style=text-align:center><code>slim</code></td><td style=text-align:left>精简版：仅 PostgreSQL + ETCD，无监控基础设施</td></tr><tr><td style=text-align:center><code>fat</code></td><td style=text-align:left>完整版：rich 基础上安装更多扩展</td></tr><tr><td style=text-align:center><code>pgsql</code></td><td style=text-align:left>纯 PostgreSQL 模板</td></tr><tr><td style=text-align:center><code>infra</code></td><td style=text-align:left>纯基础设施模板</td></tr></tbody></table><h3 id=高可用模板-ha>高可用模板 (<code>ha/</code>)</h3><table class=full-width><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>ha/dual</code></td><td style=text-align:left>2 节点高可用集群</td></tr><tr><td style=text-align:center><code>ha/trio</code></td><td style=text-align:left>3 节点高可用集群</td></tr><tr><td style=text-align:center><code>ha/full</code></td><td style=text-align:left>4 节点完整沙箱环境</td></tr><tr><td style=text-align:center><code>ha/safe</code></td><td style=text-align:left>安全加固版高可用配置</td></tr><tr><td style=text-align:center><code>ha/simu</code></td><td style=text-align:left>42 节点大规模仿真环境</td></tr></tbody></table><h3 id=应用模板-app>应用模板 (<code>app/</code>)</h3><table class=full-width><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>supabase</code></td><td style=text-align:left>Supabase 自托管配置</td></tr><tr><td style=text-align:center><code>app/dify</code></td><td style=text-align:left>Dify AI 平台配置</td></tr><tr><td style=text-align:center><code>app/odoo</code></td><td style=text-align:left>Odoo ERP 配置</td></tr><tr><td style=text-align:center><code>app/teable</code></td><td style=text-align:left>Teable 表格数据库配置</td></tr><tr><td style=text-align:center><code>app/registry</code></td><td style=text-align:left>Docker Registry 配置</td></tr></tbody></table><h3 id=特殊内核模板>特殊内核模板</h3><table class=full-width><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>ivory</code></td><td style=text-align:left>IvorySQL：Oracle 兼容 PostgreSQL</td></tr><tr><td style=text-align:center><code>mssql</code></td><td style=text-align:left>Babelfish：SQL Server 兼容 PostgreSQL</td></tr><tr><td style=text-align:center><code>polar</code></td><td style=text-align:left>PolarDB：阿里云开源分布式 PostgreSQL</td></tr><tr><td style=text-align:center><code>citus</code></td><td style=text-align:left>Citus：分布式 PostgreSQL</td></tr><tr><td style=text-align:center><code>oriole</code></td><td style=text-align:left>OrioleDB：新一代存储引擎</td></tr></tbody></table><h3 id=演示模板-demo>演示模板 (<code>demo/</code>)</h3><table><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>demo/demo</code></td><td style=text-align:left>演示环境配置</td></tr><tr><td style=text-align:center><code>demo/redis</code></td><td style=text-align:left>Redis 集群演示</td></tr><tr><td style=text-align:center><code>demo/minio</code></td><td style=text-align:left>MinIO 集群演示</td></tr></tbody></table><hr><h2 id=输出示例>输出示例</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./configure
</span></span><span style=display:flex><span>configure pigsty v4.0.0 begin
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>region</span> <span style=color:#ce5c00;font-weight:700>=</span> china
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>kernel</span>  <span style=color:#ce5c00;font-weight:700>=</span> Linux
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>machine</span> <span style=color:#ce5c00;font-weight:700>=</span> x86_64
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>package</span> <span style=color:#ce5c00;font-weight:700>=</span> rpm,dnf
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>vendor</span>  <span style=color:#ce5c00;font-weight:700>=</span> rocky <span style=color:#ce5c00;font-weight:700>(</span>Rocky Linux<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#ce5c00;font-weight:700>(</span>9.5<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>sudo</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ssh</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@127.0.0.1 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> Multiple IP address candidates found:
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span> 192.168.121.193	    inet 192.168.121.193/24 brd 192.168.121.255 scope global dynamic noprefixroute eth0
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> 10.10.10.10	    inet 10.10.10.10/24 brd 10.10.10.255 scope global noprefixroute eth1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>primary_ip</span> <span style=color:#ce5c00;font-weight:700>=</span> 10.10.10.10 <span style=color:#ce5c00;font-weight:700>(</span>from demo<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>admin</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@10.10.10.10 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>=</span> meta <span style=color:#ce5c00;font-weight:700>(</span>el9<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>locale</span>  <span style=color:#ce5c00;font-weight:700>=</span> C.UTF-8
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ansible</span> <span style=color:#ce5c00;font-weight:700>=</span> ready
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> pigsty configured
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> don<span style=color:#a40000>&#39;</span>t forget to check it and change passwords!
</span></span><span style=display:flex><span>proceed with ./deploy.yml
</span></span></code></pre></div><hr><h2 id=环境变量>环境变量</h2><p>脚本支持以下环境变量：</p><table class=full-width><thead><tr><th style=text-align:center>环境变量</th><th style=text-align:left>说明</th><th style=text-align:center>默认值</th></tr></thead><tbody><tr><td style=text-align:center><code>PIGSTY_HOME</code></td><td style=text-align:left>Pigsty 安装目录</td><td style=text-align:center><code>~/pigsty</code></td></tr><tr><td style=text-align:center><code>METADB_URL</code></td><td style=text-align:left>元数据库连接 URL</td><td style=text-align:center><code>service=meta</code></td></tr><tr><td style=text-align:center><code>HTTP_PROXY</code></td><td style=text-align:left>HTTP 代理</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>HTTPS_PROXY</code></td><td style=text-align:left>HTTPS 代理</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>ALL_PROXY</code></td><td style=text-align:left>通用代理</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>NO_PROXY</code></td><td style=text-align:left>代理白名单</td><td style=text-align:center>内置默认值</td></tr></tbody></table><hr><h2 id=注意事项>注意事项</h2><ol><li><p><strong>免密访问</strong>：运行 <code>configure</code> 前，确保当前用户具有免密 sudo 权限和免密 SSH 到本机的能力。可以通过 <code>bootstrap</code> 脚本自动配置。</p></li><li><p><strong>IP 地址选择</strong>：请选择<strong>内网 IP</strong> 作为主 IP 地址，不要使用公网 IP 或 <code>127.0.0.1</code>。</p></li><li><p><strong>密码安全</strong>：生产环境<strong>务必</strong>修改配置文件中的默认密码，或使用 <code>-g</code> 参数生成随机密码。</p></li><li><p><strong>配置检查</strong>：脚本执行完成后，建议检查生成的 <code>pigsty.yml</code> 文件，确认配置符合预期。</p></li><li><p><strong>多次执行</strong>：可以多次运行 <code>configure</code> 重新生成配置，每次会覆盖现有的 <code>pigsty.yml</code>。</p></li><li><p><strong>macOS 限制</strong>：在 macOS 上运行时，脚本会跳过部分 Linux 特有的检测，并使用占位符 IP <code>10.10.10.10</code>。macOS 只能作为管理节点使用。</p></li></ol><hr><h2 id=常见问题>常见问题</h2><h3 id=如何使用自定义配置模板>如何使用自定义配置模板？</h3><p>将您的配置文件放到 <code>conf/</code> 目录下，然后使用 <code>-c</code> 参数指定：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp my-config.yml ~/pigsty/conf/myconf.yml
</span></span><span style=display:flex><span>./configure -c myconf
</span></span></code></pre></div><h3 id=如何为多集群生成不同配置>如何为多集群生成不同配置？</h3><p>使用 <code>-o</code> 参数指定不同的输出文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c ha/full -o cluster-a.yml
</span></span><span style=display:flex><span>./configure -c ha/trio -o cluster-b.yml
</span></span></code></pre></div><p>然后在执行剧本时指定配置文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy.yml -i cluster-a.yml
</span></span></code></pre></div><h3 id=非交互模式下如何处理多-ip>非交互模式下如何处理多 IP？</h3><p>必须使用 <code>-i</code> 参数明确指定 IP 地址：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -n -i 10.10.10.10
</span></span></code></pre></div><h3 id=如何保留模板中的占位符-ip>如何保留模板中的占位符 IP？</h3><p>使用 <code>-s</code> 参数跳过 IP 替换：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c ha/full -s   <span style=color:#8f5902;font-style:italic># 保留 10.10.10.10 占位符</span>
</span></span></code></pre></div><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/concept/iac/inventory/><strong>配置清单</strong></a>：了解 Ansible 配置清单的结构</li><li><a href=/docs/concept/iac/parameter/><strong>配置参数</strong></a>：了解 Pigsty 参数的层级与优先级</li><li><a href=/docs/conf/><strong>配置模板</strong></a>：查看所有可用的配置模板</li><li><a href=/docs/setup/install/><strong>安装部署</strong></a>：了解完整的安装流程</li><li><a href=/docs/concept/iac/cmdb/><strong>元数据库</strong></a>：使用 PostgreSQL 作为动态配置源</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e42d80439da940091a403ada6ca968af>3 - 配置参数</h1><div class=lead>使用配置参数对 Pigsty 进行精细化定制</div><p>在 <strong>配置清单</strong> 中，您可以使用各种参数对 Pigsty 进行精细化定制。这些参数涵盖了从基础设施设置到数据库配置的各个方面。</p><hr><h2 id=参数列表>参数列表</h2><p>Pigsty 提供了约 <strong>380+</strong> 个配置参数，分布在 8 个默认模块中，用于精细控制系统的各个方面，完整列表见 <a href=/docs/ref/param><strong>参考-参数列表</strong></a> 。</p><table class=stretch-last><thead><tr><th style=text-align:left>模块</th><th style=text-align:center>参数组</th><th style=text-align:center>参数数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param><strong>PGSQL</strong></a></td><td style=text-align:center>9</td><td style=text-align:center>123</td><td style=text-align:left>PostgreSQL 数据库集群的核心配置</td></tr><tr><td style=text-align:left><a href=/docs/infra/param><strong>INFRA</strong></a></td><td style=text-align:center>10</td><td style=text-align:center>82</td><td style=text-align:left>基础设施组件：软件源、Nginx、DNS、监控、Grafana 等</td></tr><tr><td style=text-align:left><a href=/docs/node/param><strong>NODE</strong></a></td><td style=text-align:center>11</td><td style=text-align:center>83</td><td style=text-align:left>主机节点调优：身份、DNS、包、调优、安全、管理员、时间、VIP等</td></tr><tr><td style=text-align:left><a href=/docs/etcd/param><strong>ETCD</strong></a></td><td style=text-align:center>2</td><td style=text-align:center>13</td><td style=text-align:left>分布式配置存储与服务发现</td></tr><tr><td style=text-align:left><a href=/docs/redis/param><strong>REDIS</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>21</td><td style=text-align:left>Redis 缓存与数据结构服务器</td></tr><tr><td style=text-align:left><a href=/docs/minio/param><strong>MINIO</strong></a></td><td style=text-align:center>2</td><td style=text-align:center>21</td><td style=text-align:left>S3 兼容对象存储服务</td></tr><tr><td style=text-align:left><a href=/docs/ferret/param><strong>FERRET</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>9</td><td style=text-align:left>MongoDB 兼容数据库 FerretDB</td></tr><tr><td style=text-align:left><a href=/docs/docker/param><strong>DOCKER</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>8</td><td style=text-align:left>Docker 容器引擎</td></tr></tbody></table><hr><h2 id=参数形式>参数形式</h2><p><strong>参数</strong> 是用于描述实体的 <strong>键值对</strong>。<strong>键</strong>（Key）是字符串，<strong>值</strong>（Value）可以是五种类型之一：布尔值、字符串、数字、数组或对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># &lt;------- 顶级对象：all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># &lt;------- 全局配置参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># &lt;------- pg-meta 分组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;------- 集群级别参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># &lt;------- 主机节点 IP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;------- 实例级别参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  
</span></span></span></code></pre></div><hr><h2 id=参数优先级>参数优先级</h2><p>参数可以在不同级别设置，具有以下优先级：</p><table><thead><tr><th style=text-align:left>级别</th><th style=text-align:left>位置</th><th style=text-align:left>描述</th><th style=text-align:left>优先级</th></tr></thead><tbody><tr><td style=text-align:left><strong>命令行</strong></td><td style=text-align:left><code>-e</code> 命令行参数</td><td style=text-align:left>通过命令行传入</td><td style=text-align:left>最高 (5)</td></tr><tr><td style=text-align:left><strong>主机/实例</strong></td><td style=text-align:left><code>&lt;group>.hosts.&lt;host></code></td><td style=text-align:left>特定于单个主机的参数</td><td style=text-align:left>较高 (4)</td></tr><tr><td style=text-align:left><strong>分组/集群</strong></td><td style=text-align:left><code>&lt;group>.vars</code></td><td style=text-align:left>组/集群中主机共享的参数</td><td style=text-align:left>中等 (3)</td></tr><tr><td style=text-align:left><strong>全局</strong></td><td style=text-align:left><code>all.vars</code></td><td style=text-align:left>所有主机共享的参数</td><td style=text-align:left>较低 (2)</td></tr><tr><td style=text-align:left><strong>默认</strong></td><td style=text-align:left><code>&lt;roles>/default/main.yml</code></td><td style=text-align:left>角色实现默认值</td><td style=text-align:left>最低 (1)</td></tr></tbody></table><p>以下是关于参数优先级的一些示例：</p><ul><li>执行剧本时，使用命令行参数 <a href=/docs/infra/param#grafana_clean><strong><code>-e grafana_clean=true</code></strong></a> 来抹除 Grafana 数据</li><li>使用主机变量上的实例级别参数 <code>pg_role</code> 覆盖 pg 实例角色</li><li>使用组变量上的集群级别参数 <code>pg_cluster</code> 覆盖 pg 集群名称。</li><li>使用全局变量上的全局参数 <code>node_ntp_servers</code> 指定全局 NTP 服务器</li><li>如果没有设置 <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a>，Pigsty 将使用 <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/defaults/main.yml#L42><strong><code>pgsql</code></strong></a> 角色实现的默认值（默认为 <code>18</code>）</li></ul><p>除了<strong>身份参数</strong> 外，每个参数都有适当的默认值，因此无需显式设置。</p><hr><h2 id=身份参数>身份参数</h2><p>身份参数是特殊的参数，它们会作为实体的 ID 标识符，因此 <strong>没有默认值</strong>，必须 <strong>显式设置</strong>。</p><table><thead><tr><th style=text-align:left>模块</th><th style=text-align:left>身份参数</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_id><strong><code>PGSQL</code></strong></a></td><td style=text-align:left><code>pg_cluster</code>, <code>pg_seq</code>, <code>pg_role</code>, &mldr;</td></tr><tr><td style=text-align:left><a href=/docs/node/param#node_id><strong><code>NODE</code></strong></a></td><td style=text-align:left><code>nodename</code>, <code>node_cluster</code></td></tr><tr><td style=text-align:left><a href=/docs/etcd/param#etcd><strong><code>ETCD</code></strong></a></td><td style=text-align:left><code>etcd_cluster</code>, <code>etcd_seq</code></td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio><strong><code>MINIO</code></strong></a></td><td style=text-align:left><code>minio_cluster</code>, <code>minio_seq</code></td></tr><tr><td style=text-align:left><a href=/docs/redis/param/><strong><code>REDIS</code></strong></a></td><td style=text-align:left><code>redis_cluster</code>, <code>redis_node</code>, <code>redis_instances</code></td></tr><tr><td style=text-align:left><a href=/docs/infra/param#infra_id><strong><code>INFRA</code></strong></a></td><td style=text-align:left><code>infra_seq</code></td></tr></tbody></table><p>例外是，<a href=/docs/etcd/param#etcd_cluster><strong><code>etcd_cluster</code></strong></a> 与 <a href=/docs/minio/param#minio_cluster><strong><code>minio_cluster</code></strong></a> 有默认值。
它假设每套部署只有一套 etcd 集群用于 DCS，和一套可选 MinIO 集群用于集中备份存储，因此为其分配了默认的集群名称 <code>etcd</code> 与 <code>minio</code>。
但您依然可以使用其他名称部署多套 etcd 或 MinIO 集群。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a71a0b133f9617fabea630bbd56757f4>4 - 配置模板</h1><div class=lead>使用预制的配置模板，快速生成适配当前环境的配置文件</div><p>在 Pigsty 中，部署的蓝图细节由 <a href=/docs/setup/config/><strong>配置清单</strong></a> 所定义，也就是 <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><strong><code>pigsty.yml</code></strong></a> 配置文件，您可以通过声明式配置进行定制。</p><p>然而，直接编写配置文件可能会让新用户望而生畏。为此，我们提供了一些开箱即用的配置模板，涵盖了常见的使用场景。</p><p>每一个模板都是一个预定义的 <code>pigsty.yml</code> 配置文件，包含了适用于特定场景的合理默认值。</p><p>您可以根据自己的需要，选择一个模板作为定制起点，然后根据需要进行修改，以满足您的具体需求。</p><hr><h2 id=使用模板>使用模板</h2><p>Pigsty 提供了 <a href=https://github.com/pgsty/pigsty/blob/main/configure><strong><code>configure</code></strong></a> 脚本作为可选的配置向导，它将根据您的环境和输入，生成具有良好默认值的 <a href=/docs/setup/config/><strong>配置清单</strong></a>。</p><p>使用 <code>./configure -c &lt;conf></code> 指定配置模板，其中 <code>&lt;conf></code> 是相对于 <code>conf</code> 目录的路径（可省略 <code>.yml</code> 后缀）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure                     <span style=color:#8f5902;font-style:italic># 默认使用 meta.yml 配置模板</span>
</span></span><span style=display:flex><span>./configure -c meta             <span style=color:#8f5902;font-style:italic># 显式指定使用 meta.yml 单节点模板</span>
</span></span><span style=display:flex><span>./configure -c rich             <span style=color:#8f5902;font-style:italic># 使用包含全部扩展与 MinIO 的富功能模板</span>
</span></span><span style=display:flex><span>./configure -c slim             <span style=color:#8f5902;font-style:italic># 使用最小化的单节点模板</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用不同的数据库内核</span>
</span></span><span style=display:flex><span>./configure -c pgsql            <span style=color:#8f5902;font-style:italic># 原生 PostgreSQL 内核，基础功能 (13~18)</span>
</span></span><span style=display:flex><span>./configure -c citus            <span style=color:#8f5902;font-style:italic># Citus 分布式高可用 PostgreSQL (14~17)</span>
</span></span><span style=display:flex><span>./configure -c mssql            <span style=color:#8f5902;font-style:italic># Babelfish 内核，兼容 SQL Server 协议 (15)</span>
</span></span><span style=display:flex><span>./configure -c polar            <span style=color:#8f5902;font-style:italic># PolarDB PG 内核，Aurora/RAC 风格 (15)</span>
</span></span><span style=display:flex><span>./configure -c ivory            <span style=color:#8f5902;font-style:italic># IvorySQL 内核，兼容 Oracle 语法 (18)</span>
</span></span><span style=display:flex><span>./configure -c mysql            <span style=color:#8f5902;font-style:italic># OpenHalo 内核，兼容 MySQL (14)</span>
</span></span><span style=display:flex><span>./configure -c pgtde            <span style=color:#8f5902;font-style:italic># Percona PostgreSQL Server 透明加密 (18)</span>
</span></span><span style=display:flex><span>./configure -c oriole           <span style=color:#8f5902;font-style:italic># OrioleDB 内核，OLTP 增强 (17)</span>
</span></span><span style=display:flex><span>./configure -c supabase         <span style=color:#8f5902;font-style:italic># Supabase 自托管配置 (15~18)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用多节点高可用模板</span>
</span></span><span style=display:flex><span>./configure -c ha/dual          <span style=color:#8f5902;font-style:italic># 使用 2 节点高可用模板</span>
</span></span><span style=display:flex><span>./configure -c ha/trio          <span style=color:#8f5902;font-style:italic># 使用 3 节点高可用模板</span>
</span></span><span style=display:flex><span>./configure -c ha/full          <span style=color:#8f5902;font-style:italic># 使用 4 节点高可用模板</span>
</span></span></code></pre></div><p>如果不指定模板，Pigsty 默认使用 <code>meta.yml</code> 单节点配置模板。</p><hr><h2 id=模板列表>模板列表</h2><h3 id=主要模板>主要模板</h3><p>以下是单节点配置模板，可用于在单台服务器上安装 Pigsty：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/meta/><strong><code>meta.yml</code></strong></a></td><td><strong>默认模板</strong>，单节点 PostgreSQL 在线安装</td></tr><tr><td><a href=/docs/conf/rich/><strong><code>rich.yml</code></strong></a></td><td>富功能模板，包含本地软件源、MinIO 及更多示例</td></tr><tr><td><a href=/docs/conf/slim/><strong><code>slim.yml</code></strong></a></td><td>精简模板，仅安装 PostgreSQL，不含监控与基础设施</td></tr></tbody></table><h3 id=数据库内核模板>数据库内核模板</h3><p>适用于各类数据库管理系统与内核的模板：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/pgsql/><strong><code>pgsql.yml</code></strong></a></td><td>原生 PostgreSQL 内核，基础功能 (13~18)</td></tr><tr><td><a href=/docs/conf/citus/><strong><code>citus.yml</code></strong></a></td><td>Citus 分布式高可用 PostgreSQL (14~17)</td></tr><tr><td><a href=/docs/conf/mssql/><strong><code>mssql.yml</code></strong></a></td><td>Babelfish 内核，兼容 SQL Server 协议 (15)</td></tr><tr><td><a href=/docs/conf/polar/><strong><code>polar.yml</code></strong></a></td><td>PolarDB PG 内核，Aurora/RAC 风格 (15)</td></tr><tr><td><a href=/docs/conf/ivory/><strong><code>ivory.yml</code></strong></a></td><td>IvorySQL 内核，兼容 Oracle 语法 (17)</td></tr><tr><td><a href=/docs/conf/mysql/><strong><code>mysql.yml</code></strong></a></td><td>OpenHalo 内核，兼容 MySQL (14)</td></tr><tr><td><a href=/docs/conf/pgtde/><strong><code>pgtde.yml</code></strong></a></td><td>Percona PostgreSQL Server 透明加密 (17)</td></tr><tr><td><a href=/docs/conf/oriole/><strong><code>oriole.yml</code></strong></a></td><td>OrioleDB 内核，OLTP 增强 (17，Debian 包暂缺)</td></tr><tr><td><a href=/docs/conf/supabase/><strong><code>supabase.yml</code></strong></a></td><td>Supabase 自托管配置 (15~17)</td></tr></tbody></table><p>您可以后续添加更多节点，或使用 <a href=#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%A8%A1%E6%9D%BF>高可用模板</a> 在一开始就规划好集群。</p><hr><h3 id=高可用模板>高可用模板</h3><p>您可以配置 Pigsty 在多节点上运行，组成高可用（HA）集群：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/dual/><strong><code>dual.yml</code></strong></a></td><td>2 节点半高可用部署</td></tr><tr><td><a href=/docs/conf/trio/><strong><code>trio.yml</code></strong></a></td><td>3 节点标准高可用部署</td></tr><tr><td><a href=/docs/conf/full/><strong><code>full.yml</code></strong></a></td><td>4 节点标准部署</td></tr><tr><td><a href=/docs/conf/safe/><strong><code>safe.yml</code></strong></a></td><td>4 节点安全增强部署，含延迟从库</td></tr><tr><td><a href=/docs/conf/simu/><strong><code>simu.yml</code></strong></a></td><td>20 节点生产环境模拟</td></tr></tbody></table><hr><h3 id=应用模板>应用模板</h3><p>您可以使用以下模板运行 Docker 应用/软件：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/supabase/><strong><code>supa.yml</code></strong></a></td><td>启动单节点 Supabase</td></tr><tr><td><a href=/docs/conf/odoo/><strong><code>odoo.yml</code></strong></a></td><td>启动 Odoo ERP 系统</td></tr><tr><td><a href=/docs/conf/dify/><strong><code>dify.yml</code></strong></a></td><td>启动 Dify AI 工作流系统</td></tr><tr><td><a href=/docs/conf/electric/><strong><code>electric.yml</code></strong></a></td><td>启动 Electric 同步引擎</td></tr></tbody></table><hr><h3 id=演示模板>演示模板</h3><p>除主要模板外，Pigsty 还提供了一组面向不同场景的演示模板：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/el/><strong><code>el.yml</code></strong></a></td><td>EL 8/9 系统的全参数配置文件</td></tr><tr><td><a href=/docs/conf/debian/><strong><code>debian.yml</code></strong></a></td><td>Debian/Ubuntu 系统的全参数配置文件</td></tr><tr><td><strong><code>remote.yml</code></strong></td><td>监控远程 PostgreSQL 集群或 RDS 的示例配置</td></tr><tr><td><strong><code>redis.yml</code></strong></td><td>Redis 集群示例配置</td></tr><tr><td><a href=/docs/conf/minio/><strong><code>minio.yml</code></strong></a></td><td>3 节点 MinIO 集群示例配置</td></tr><tr><td><a href=/docs/conf/demo/><strong><code>demo.yml</code></strong></a></td><td>Pigsty <a href=https://demo.pigsty.cc>公开演示站</a> 的配置文件</td></tr></tbody></table><hr><h3 id=构建模板>构建模板</h3><p>以下配置模板用于开发和测试目的：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><strong><code>build.yml</code></strong></td><td>EL 9/10、Debian 12/13、Ubuntu 22.04/24.04 开源构建配置</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-4f710b6522c00bd4a1ee261283a935b7>5 - 元数据库</h1><div class=lead>使用 PostgreSQL 作为 CMDB 元数据库，存储 Ansible 配置清单。</div><p>Pigsty 允许您使用 PostgreSQL <strong>元数据库</strong> 作为动态配置源，取代静态的 YAML 配置文件，实现更强大的配置管理能力。</p><hr><h2 id=概览>概览</h2><p><strong>CMDB</strong>（Configuration Management Database，配置管理数据库）是一种将配置信息存储在数据库中进行管理的方式。</p><p>在 Pigsty 中，默认的配置源是一个静态 YAML 文件 <code>pigsty.yml</code>，
它作为 Ansible 的 <a href=/docs/concept/iac/inventory/><strong>配置清单</strong></a> 使用。</p><p>这种方式简单直接，但当基础设施规模扩大、需要复杂精细的管理与外部集成时，单一的静态文件难以满足需求。</p><table class=full-width><thead><tr><th style=text-align:center>特性</th><th style=text-align:left>静态 YAML 文件</th><th style=text-align:left>CMDB 元数据库</th></tr></thead><tbody><tr><td style=text-align:center><strong>查询能力</strong></td><td style=text-align:left>手工搜索/grep</td><td style=text-align:left>SQL 任意条件查询，聚合分析</td></tr><tr><td style=text-align:center><strong>版本控制</strong></td><td style=text-align:left>依赖 Git 或手工备份</td><td style=text-align:left>数据库事务，审计日志，时间旅行快照</td></tr><tr><td style=text-align:center><strong>权限控制</strong></td><td style=text-align:left>文件系统权限，粗粒度</td><td style=text-align:left>PostgreSQL 数据库精细访问控制</td></tr><tr><td style=text-align:center><strong>并发编辑</strong></td><td style=text-align:left>需要锁文件或合并冲突</td><td style=text-align:left>数据库事务天然支持并发</td></tr><tr><td style=text-align:center><strong>外部集成</strong></td><td style=text-align:left>需要解析 YAML</td><td style=text-align:left>标准 SQL 接口，任意语言轻松对接</td></tr><tr><td style=text-align:center><strong>规模扩展</strong></td><td style=text-align:left>文件过大时难以维护</td><td style=text-align:left>管理规模伸缩至物理极限</td></tr><tr><td style=text-align:center><strong>动态生成</strong></td><td style=text-align:left>静态文件，修改后需手动应用</td><td style=text-align:left>即时生效，实时反映配置变更</td></tr></tbody></table><p>Pigsty 在样板数据库 <a href=https://github.com/pgsty/pigsty/blob/main/conf/meta.yml#L52><strong><code>pg-meta.meta</code></strong></a> 的模式基线定义中，提供了 Pigsty CMDB 的数据库模式。</p><hr><h2 id=工作原理>工作原理</h2><p>CMDB 的核心思想是用一个 <strong>动态脚本</strong> 替换静态配置文件。
Ansible 支持使用可执行脚本作为配置清单，只要脚本输出符合 JSON 格式的清单数据即可。
当您启用 CMDB 后，Pigsty 会创建一个名为 <code>inventory.sh</code> 的动态清单脚本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span>psql <span style=color:#4e9a06>${</span><span style=color:#000>METADB_URL</span><span style=color:#4e9a06>}</span> -AXtwc <span style=color:#4e9a06>&#39;SELECT text FROM pigsty.inventory;&#39;</span>
</span></span></code></pre></div><p>这个脚本的作用很简单：每次 Ansible 需要读取配置清单时，它会从 PostgreSQL 数据库的 <code>pigsty.inventory</code> 视图中查询配置数据，并以 JSON 格式返回。</p><p>整体架构如下：</p><pre class=mermaid>flowchart LR
    conf[&#34;bin/inventory_conf&#34;]
    tocmdb[&#34;bin/inventory_cmdb&#34;]
    load[&#34;bin/inventory_load&#34;]
    ansible[&#34;🚀 Ansible&#34;]

    subgraph static[&#34;📄 静态配置模式&#34;]
        yml[(&#34;pigsty.yml&#34;)]
    end

    subgraph dynamic[&#34;🗄️ CMDB 动态模式&#34;]
        sh[&#34;inventory.sh&#34;]
        cmdb[(&#34;PostgreSQL CMDB&#34;)]
    end

    conf --&gt;|&#34;切换&#34;| yml
    yml --&gt;|&#34;加载配置&#34;| load
    load --&gt;|&#34;写入&#34;| cmdb
    tocmdb --&gt;|&#34;切换&#34;| sh
    sh --&gt; cmdb

    yml --&gt; ansible
    cmdb --&gt; ansible</pre><hr><h2 id=数据模型>数据模型</h2><p>CMDB 的数据库模式定义在 <a href=https://github.com/pgsty/pigsty/blob/main/files/cmdb.sql><code>files/cmdb.sql</code></a> 文件中，所有对象都位于 <code>pigsty</code> 模式下。</p><h3 id=核心数据表>核心数据表</h3><table class=full-width><thead><tr><th style=text-align:center>表名</th><th style=text-align:left>说明</th><th style=text-align:center>主键</th></tr></thead><tbody><tr><td style=text-align:center><code>pigsty.group</code></td><td style=text-align:left>集群/分组定义，对应 Ansible 的 group</td><td style=text-align:center><code>cls</code></td></tr><tr><td style=text-align:center><code>pigsty.host</code></td><td style=text-align:left>主机定义，属于某个分组</td><td style=text-align:center><code>(cls, ip)</code></td></tr><tr><td style=text-align:center><code>pigsty.global_var</code></td><td style=text-align:left>全局变量，对应 <code>all.vars</code></td><td style=text-align:center><code>key</code></td></tr><tr><td style=text-align:center><code>pigsty.group_var</code></td><td style=text-align:left>分组变量，对应 <code>all.children.&lt;cls>.vars</code></td><td style=text-align:center><code>(cls, key)</code></td></tr><tr><td style=text-align:center><code>pigsty.host_var</code></td><td style=text-align:left>主机变量，对应主机级别的变量</td><td style=text-align:center><code>(cls, ip, key)</code></td></tr><tr><td style=text-align:center><code>pigsty.default_var</code></td><td style=text-align:left>默认变量定义，存储参数的元信息</td><td style=text-align:center><code>key</code></td></tr><tr><td style=text-align:center><code>pigsty.job</code></td><td style=text-align:left>作业记录表，记录执行的任务</td><td style=text-align:center><code>id</code></td></tr></tbody></table><h3 id=表结构详解>表结构详解</h3><p><strong>集群表 <code>pigsty.group</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>     </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- 集群名称，主键
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ctime</span><span style=color:#f8f8f8>   </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>-- 创建时间
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8>   </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- 修改时间
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>主机表 <code>pigsty.host</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>    </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- 所属集群
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ip</span><span style=color:#f8f8f8>     </span><span style=color:#000>INET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic>-- 主机 IP 地址
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ctime</span><span style=color:#f8f8f8>  </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8>  </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>全局变量表 <code>pigsty.global_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 变量名
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic>-- 变量值（JSON 格式）
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- 修改时间
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>分组变量表 <code>pigsty.group_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>主机变量表 <code>pigsty.host_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>host_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ip</span><span style=color:#f8f8f8>    </span><span style=color:#000>INET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>FOREIGN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=核心视图>核心视图</h3><p>CMDB 提供了一系列视图，用于查询和展示配置数据：</p><table class=full-width><thead><tr><th style=text-align:center>视图名</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>pigsty.inventory</code></td><td style=text-align:left><strong>核心视图</strong>：生成 Ansible 动态清单 JSON</td></tr><tr><td style=text-align:center><code>pigsty.raw_config</code></td><td style=text-align:left>原始配置的 JSON 格式展示</td></tr><tr><td style=text-align:center><code>pigsty.global_config</code></td><td style=text-align:left>全局配置视图，合并默认值和全局变量</td></tr><tr><td style=text-align:center><code>pigsty.group_config</code></td><td style=text-align:left>分组配置视图，包含主机列表和分组变量</td></tr><tr><td style=text-align:center><code>pigsty.host_config</code></td><td style=text-align:left>主机配置视图，合并分组和主机级别变量</td></tr><tr><td style=text-align:center><code>pigsty.pg_cluster</code></td><td style=text-align:left>PostgreSQL 集群视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_instance</code></td><td style=text-align:left>PostgreSQL 实例视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_database</code></td><td style=text-align:left>PostgreSQL 数据库定义视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_users</code></td><td style=text-align:left>PostgreSQL 用户定义视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_service</code></td><td style=text-align:left>PostgreSQL 服务定义视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_hba</code></td><td style=text-align:left>PostgreSQL HBA 规则视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_remote</code></td><td style=text-align:left>远程 PostgreSQL 实例视图</td></tr></tbody></table><p><strong><code>pigsty.inventory</code></strong> 是最核心的视图，它将数据库中的配置数据转换为 Ansible 所需的 JSON 格式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87>text</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inventory</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=工具脚本>工具脚本</h2><p>Pigsty 提供了三个便利脚本来管理 CMDB：</p><table class=full-width><thead><tr><th style=text-align:center>脚本</th><th style=text-align:left>功能</th></tr></thead><tbody><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_load><code>bin/inventory_load</code></a></td><td style=text-align:left>将 YAML 配置文件加载到 PostgreSQL 数据库中</td></tr><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_cmdb><code>bin/inventory_cmdb</code></a></td><td style=text-align:left>切换配置源为 CMDB（动态清单脚本）</td></tr><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_conf><code>bin/inventory_conf</code></a></td><td style=text-align:left>切换配置源为静态配置文件 <code>pigsty.yml</code></td></tr></tbody></table><h3 id=inventory_load>inventory_load</h3><p>将 YAML 配置文件解析并导入到 CMDB 中：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_load                     <span style=color:#8f5902;font-style:italic># 加载默认的 pigsty.yml 到默认 CMDB</span>
</span></span><span style=display:flex><span>bin/inventory_load -p /path/to/conf.yml  <span style=color:#8f5902;font-style:italic># 指定配置文件路径</span>
</span></span><span style=display:flex><span>bin/inventory_load -d <span style=color:#4e9a06>&#34;postgres://...&#34;</span>   <span style=color:#8f5902;font-style:italic># 指定数据库连接 URL</span>
</span></span><span style=display:flex><span>bin/inventory_load -n myconfig           <span style=color:#8f5902;font-style:italic># 指定配置名称</span>
</span></span></code></pre></div><p>脚本会执行以下操作：</p><ol><li>清空 <code>pigsty</code> 模式中的现有数据</li><li>解析 YAML 配置文件</li><li>将全局变量写入 <code>global_var</code> 表</li><li>将集群定义写入 <code>group</code> 表</li><li>将集群变量写入 <code>group_var</code> 表</li><li>将主机定义写入 <code>host</code> 表</li><li>将主机变量写入 <code>host_var</code> 表</li></ol><p><strong>环境变量</strong></p><ul><li><code>PIGSTY_HOME</code>：Pigsty 安装目录，默认为 <code>~/pigsty</code></li><li><code>METADB_URL</code>：数据库连接 URL，默认为 <code>service=meta</code></li></ul><h3 id=inventory_cmdb>inventory_cmdb</h3><p>切换 Ansible 使用 CMDB 作为配置源：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_cmdb
</span></span></code></pre></div><p>脚本会执行以下操作：</p><ol><li>创建动态清单脚本 <code>${PIGSTY_HOME}/inventory.sh</code></li><li>修改 <code>ansible.cfg</code> 将 <code>inventory</code> 设置为 <code>inventory.sh</code></li></ol><p>生成的 <code>inventory.sh</code> 内容如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span>psql <span style=color:#4e9a06>${</span><span style=color:#000>METADB_URL</span><span style=color:#4e9a06>}</span> -AXtwc <span style=color:#4e9a06>&#39;SELECT text FROM pigsty.inventory;&#39;</span>
</span></span></code></pre></div><h3 id=inventory_conf>inventory_conf</h3><p>切换回使用静态 YAML 配置文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_conf
</span></span></code></pre></div><p>脚本会修改 <code>ansible.cfg</code> 将 <code>inventory</code> 设置回 <code>pigsty.yml</code>。</p><hr><h2 id=使用流程>使用流程</h2><h3 id=首次启用-cmdb>首次启用 CMDB</h3><ol><li><strong>初始化 CMDB 模式</strong>（通常在安装 Pigsty 时已自动完成）：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -f ~/pigsty/files/cmdb.sql
</span></span></code></pre></div><ol start=2><li><strong>加载配置到数据库</strong>：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_load
</span></span></code></pre></div><ol start=3><li><strong>切换到 CMDB 模式</strong>：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_cmdb
</span></span></code></pre></div><ol start=4><li><strong>验证配置</strong>：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible all --list-hosts          <span style=color:#8f5902;font-style:italic># 列出所有主机</span>
</span></span><span style=display:flex><span>ansible-inventory --list          <span style=color:#8f5902;font-style:italic># 查看完整清单</span>
</span></span></code></pre></div><h3 id=查询配置>查询配置</h3><p>启用 CMDB 后，您可以使用 SQL 灵活查询配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有集群
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看某集群的所有主机
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看全局变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看某集群的变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有 PostgreSQL 集群
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_databases</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_users</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_cluster</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有 PostgreSQL 实例
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ins</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>seq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_instance</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有数据库定义
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_database</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有用户定义
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>login</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>superuser</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_users</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=修改配置>修改配置</h3><p>您可以直接通过 SQL 修改配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 添加新集群
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 添加集群变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_cluster&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;pg-new&#34;&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 添加主机
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 添加主机变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>host_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_seq&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;1&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_role&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;primary&#34;&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 修改全局变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;new-value&#34;&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;some_param&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 删除集群（级联删除主机和变量）
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DELETE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-old&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>修改后立即生效，无需重新加载或重启任何服务。</p><h3 id=切换回静态配置>切换回静态配置</h3><p>如需切换回静态配置文件模式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_conf
</span></span></code></pre></div><hr><h2 id=高级用法>高级用法</h2><h3 id=配置导出>配置导出</h3><p>将 CMDB 中的配置导出为 YAML 格式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>=</span>meta -AXtwc <span style=color:#4e9a06>&#34;SELECT jsonb_pretty(jsonb_build_object(&#39;all&#39;, jsonb_build_object(&#39;children&#39;, children, &#39;vars&#39;, vars))) FROM pigsty.raw_config;&#34;</span>
</span></span></code></pre></div><p>或者使用 <code>ansible-inventory</code> 命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-inventory --list --yaml &gt; exported_config.yml
</span></span></code></pre></div><h3 id=配置审计>配置审计</h3><p>利用 <code>mtime</code> 字段追踪配置变更：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看最近修改的全局变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看某时间点之后的变更
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-01-01&#39;</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>timestamptz</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=与外部系统集成>与外部系统集成</h3><p>CMDB 使用标准 PostgreSQL，可以轻松与其他系统集成：</p><ul><li><strong>Web 管理界面</strong>：通过 REST API（如 PostgREST）暴露配置数据</li><li><strong>CI/CD 流水线</strong>：在部署脚本中直接读写数据库</li><li><strong>监控告警</strong>：基于配置数据生成监控规则</li><li><strong>ITSM 系统</strong>：与企业 CMDB 系统同步</li></ul><hr><h2 id=注意事项>注意事项</h2><ol><li><p><strong>数据一致性</strong>：修改配置后，需要重新执行相应的 Ansible 剧本才能将变更应用到实际环境</p></li><li><p><strong>备份</strong>：CMDB 中的配置数据非常重要，请确保定期备份</p></li><li><p><strong>权限</strong>：建议为 CMDB 配置适当的数据库访问权限，避免误操作</p></li><li><p><strong>事务</strong>：批量修改配置时，建议在事务中进行，以便出错时回滚</p></li><li><p><strong>连接池</strong>：<code>inventory.sh</code> 脚本每次执行都会建立新连接，如果 Ansible 执行频繁，建议考虑使用连接池</p></li></ol><hr><h2 id=小结>小结</h2><p>CMDB 是 Pigsty 配置管理的高级方案，适用于需要管理大量集群、复杂查询、外部集成或精细权限控制的场景。通过将配置数据存储在 PostgreSQL 中，您可以充分利用数据库的强大能力来管理基础设施配置。</p><table class=full-width><thead><tr><th style=text-align:center>功能</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong>数据存储</strong></td><td style=text-align:center>PostgreSQL <code>pigsty</code> 模式</td></tr><tr><td style=text-align:center><strong>动态清单</strong></td><td style=text-align:center><code>inventory.sh</code> 脚本</td></tr><tr><td style=text-align:center><strong>配置加载</strong></td><td style=text-align:center><code>bin/inventory_load</code></td></tr><tr><td style=text-align:center><strong>切换到 CMDB</strong></td><td style=text-align:center><code>bin/inventory_cmdb</code></td></tr><tr><td style=text-align:center><strong>切换到 YAML</strong></td><td style=text-align:center><code>bin/inventory_conf</code></td></tr><tr><td style=text-align:center><strong>核心视图</strong></td><td style=text-align:center><code>pigsty.inventory</code></td></tr></tbody></table></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>