<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/concept/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/concept/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>概念 | PIGSTY</title><meta name=description content="理解 Pigsty 的核心概念、架构设计与设计理念，掌握高可用、备份恢复、安全合规等关键能力。"><meta property="og:url" content="https://pigsty.cc/docs/concept/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="概念"><meta property="og:description" content="理解 Pigsty 的核心概念、架构设计与设计理念，掌握高可用、备份恢复、安全合规等关键能力。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="概念"><meta itemprop=description content="理解 Pigsty 的核心概念、架构设计与设计理念，掌握高可用、备份恢复、安全合规等关键能力。"><meta itemprop=dateModified content="2026-01-29T10:51:53+08:00"><meta itemprop=wordCount content="258"><meta itemprop=keywords content="概念,PIGSTY"><meta name=twitter:card content="summary"><meta name=twitter:title content="概念"><meta name=twitter:description content="理解 Pigsty 的核心概念、架构设计与设计理念，掌握高可用、备份恢复、安全合规等关键能力。"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/concept/>返回本页常规视图</a>.</p></div><h1 class=title>概念</h1><div class=lead>理解 Pigsty 的核心概念、架构设计与设计理念，掌握高可用、备份恢复、安全合规等关键能力。</div><ul><li>1: <a href=#pg-5f0248151627a7f914932011cbe64c98>积木式架构</a></li><ul><li>1.1: <a href=#pg-66767bf2f054756113e02343d62b9774>节点</a></li><li>1.2: <a href=#pg-d65561d0ed395a21fc6b7dd2654dc081>INFRA 架构</a></li><li>1.3: <a href=#pg-c777ff17702df77ebc33dadeb81e4174>PGSQL 架构</a></li></ul><li>2: <a href=#pg-d1b03f22fc5f90cf6ddcf42073d7603d>集群模型图</a></li><ul><li>2.1: <a href=#pg-97ed05d79e93eabb25565a36bc328883>PGSQL 集群模型</a></li><li>2.2: <a href=#pg-5a875c30b5ea163b13415e0cf143a46f>ETCD 集群模型</a></li><li>2.3: <a href=#pg-c495cfba1010bd7cf73164bea4ebc4f3>MINIO 集群模型</a></li><li>2.4: <a href=#pg-0de22cd0f8c383fe4e1ef5a4eb6b5440>REDIS 集群模型</a></li><li>2.5: <a href=#pg-2ad10e50acca12cdeaaf406b2cf23f3b>INFRA 集群模型</a></li></ul><li>3: <a href=#pg-d1070a4639ccf6fd6d12d222bf92c497>声明式配置 —— 基础设施即代码（IaC）</a></li><ul><li>3.1: <a href=#pg-6b8b3debf71b9a47be1364eba07a65ae>配置清单</a></li><li>3.2: <a href=#pg-c48a7025a948ffe27199cd10986e517a>配置向导</a></li><li>3.3: <a href=#pg-e42d80439da940091a403ada6ca968af>配置参数</a></li><li>3.4: <a href=#pg-a71a0b133f9617fabea630bbd56757f4>配置模板</a></li><li>3.5: <a href=#pg-4f710b6522c00bd4a1ee261283a935b7>元数据库</a></li></ul><li>4: <a href=#pg-611f3486b406a3e3cb452cbc6af4b548>PG 高可用</a></li><ul><li>4.1: <a href=#pg-928294eb73615de574523762c3a1ab07>RPO 利弊权衡</a></li><li>4.2: <a href=#pg-95882b9440d286103890671f368774b6>RTO 利弊权衡</a></li><li>4.3: <a href=#pg-439a629138018b9fe8b5a1c8323745be>故障切换模型</a></li><ul><li>4.3.1: <a href=#pg-358e309cdbb4cb46571e2cba4875ac34>被动故障切换</a></li><li>4.3.2: <a href=#pg-42b7950723c66bacccc650303281acc3>主动故障检测</a></li></ul><li>4.4: <a href=#pg-895a94576239d65b824c6e6ae06deb76>服务接入</a></li></ul><li>5: <a href=#pg-89cc2a8924ee8ac9c638f7a0a941f56b>时间点恢复</a></li><ul><li>5.1: <a href=#pg-38cea9754a736f991ef94b09725db17e>时间点恢复的工作原理</a></li><li>5.2: <a href=#pg-0f1a78edbba6d0b4ce0cad98c98b549c>时间点恢复的实现架构</a></li><li>5.3: <a href=#pg-73a2e369df3734218f99f90230b96257>时间点恢复的策略权衡</a></li><li>5.4: <a href=#pg-03fae0025a6c17d88ae21f91a462fbe6>时间点恢复的典型场景</a></li></ul><li>6: <a href=#pg-640213fc983ef0aae5180ea5bbbfb2d3>监控系统</a></li><li>7: <a href=#pg-7ed29cc39a1f06050bef0386106a93cc>安全合规</a></li><ul><li>7.1: <a href=#pg-42af3045c7ebee43d7c66fbe8a4cd267>七层安全模型</a></li><li>7.2: <a href=#pg-e262c3c798800d9c25e91d199755245e>身份认证</a></li><li>7.3: <a href=#pg-6a3742ed82b65fb5a722f76337bf835d>访问控制</a></li><li>7.4: <a href=#pg-8b790153f8312a89aef83b802d30c481>加密通信与本地 CA</a></li><li>7.5: <a href=#pg-7e0ac5f31c46a7de87a54fa692c7e8f1>数据安全</a></li><li>7.6: <a href=#pg-d273c15ad260463dcc3b8ed6fad3a323>合规清单</a></li></ul></ul><div class=content><p>Pigsty 是一个可移植、可扩展的开源 PostgreSQL 发行版，用于在本地环境中构建生产级数据库服务，方便进行声明式配置和自动化。它拥有庞大的生态系统，提供了一整套工具、脚本和最佳实践，让 PostgreSQL 真正达到企业级 RDS 的服务水准。</p><p>Pigsty 名字源自 <strong>P</strong>ostgreSQL <strong>I</strong>n <strong>G</strong>reat <strong>STY</strong>le，也可理解为 <strong>P</strong>ostgres， <strong>I</strong>nfras， <strong>G</strong>raphics， <strong>S</strong>ervice， <strong>T</strong>oolbox， it&rsquo;s all <strong>Y</strong>ours —— 属于您的 PostgreSQL 图形化自建工具箱。您可以在 <a href=https://github.com/Vonng/pigsty><strong>GitHub</strong></a> 上找到源代码，访问 <a href=https://pigsty.io><strong>官方文档</strong></a> 了解更多信息，或在 <a href=https://demo.pigsty.cc><strong>在线演示</strong></a> 中体验 <a href=/docs/setup/webui><strong>Web 界面</strong></a>。</p><p><a href=https://pigsty.cc><img src=/img/pigsty/banner.png alt=pigsty-banner></a></p><hr><h2 id=为什么需要-pigsty它能做什么>为什么需要 Pigsty，它能做什么？</h2><p>PostgreSQL 是一个足够完美的数据库内核，但它需要更多工具与系统的配合才能成为一个足够好的数据库服务。在生产环境中，您需要管理数据库的方方面面：高可用、备份恢复、监控告警、访问控制、参数调优、扩展安装、连接池化、负载均衡……</p><p>如果这些复杂的运维工作都能自动化处理，是不是会更容易一些？这正是 Pigsty 诞生的原因。</p><p>Pigsty 为您提供：</p><ul><li><p><strong>开箱即用的 PostgreSQL 发行版</strong></p><p>Pigsty 深度整合了 PostgreSQL 生态中的 <a href=https://pgext.cloud/zh/list><strong>444 扩展插件</strong></a>，为您提供开箱即用的分布式、时序、地理、空间、图、向量、搜索等多模态数据库能力。从内核到 RDS 发行版，在 EL/Debian/Ubuntu 下提供 13-18 版本的生产级数据库服务。</p></li><li><p><strong>故障自愈的高可用架构</strong></p><p>基于 Patroni、Etcd 和 HAProxy 打造的 <a href=/docs/concept/ha><strong>高可用架构</strong></a>，让硬件故障自动切换，流量无缝衔接。主库故障恢复时间 RTO &lt; 45s，数据恢复点 RPO ≈ 0。您可以在无需应用配合的情况下滚动维护升级整个集群。</p></li><li><p><strong>完整的时间点恢复能力</strong></p><p>基于 pgBackRest 与可选的 MinIO 集群，提供开箱即用的 <a href=/docs/concept/pitr><strong>PITR 时间点恢复</strong></a> 能力。让您拥有快速回到过去任意时间点的能力，为软件缺陷与人为删库兜底。</p></li><li><p><strong>灵活的服务接入与流量管理</strong></p><p>通过 HAProxy、Pgbouncer、VIP 提供灵活的 <a href=/docs/pgsql/misc/svc><strong>服务接入</strong></a> 模式，实现读写分离、连接池化、自动路由。交付稳定可靠、自动路由、事务池化的高性能数据库服务。</p></li><li><p><strong>惊艳的可观测性</strong></p><p>基于 Prometheus 与 Grafana 的现代可观测性技术栈，提供无与伦比的 <a href=/docs/concept/monitor><strong>监控最佳实践</strong></a>。超过三千类监控指标描述系统的方方面面，从全局大盘到单个对象的增删改查都能一览无余。</p></li><li><p><strong>声明式的配置管理</strong></p><p>遵循 <a href=/docs/concept/iac><strong>基础设施即代码</strong></a> 的理念，使用声明式配置描述整个环境。您只需告诉 Pigsty &ldquo;想要什么样的数据库集群&rdquo;，无需操心具体如何实现，系统会自动调整到期望状态。</p></li><li><p><strong>模块化的架构设计</strong></p><p>采用模块化 <a href=/docs/concept/arch><strong>架构</strong></a> 设计，可自由组合以适应不同场景。除了核心的 PostgreSQL 模块外，还提供 Redis、MinIO、Etcd、FerretDB 等可选模块，以及对多种 PG 兼容内核的支持。</p></li><li><p><strong>扎实的安全最佳实践</strong></p><p>采用业界领先的安全最佳实践：自签名 CA 签发证书加密通信，AES 加密备份，scram-sha-256 加密密码，开箱即用的 ACL 模型，遵循最小权限原则的 HBA 规则集，确保数据安全。</p></li><li><p><strong>简单易用的部署方案</strong></p><p>所有依赖被预先打包，可在无互联网访问的环境中一键安装。本地沙箱环境可运行在 1核2G 的微型虚拟机中，提供与生产环境完全一致的功能模拟。提供基于 Vagrant 的本地沙箱与基于 Terraform 的云端部署方案。</p></li></ul><hr><h2 id=pigsty-不是什么>Pigsty 不是什么</h2><p>Pigsty 并不是传统的、包罗万象的 PaaS（平台即服务）系统。</p><ul><li><p><strong>Pigsty 不提供基础硬件资源</strong>。它运行在您提供的节点之上，无论是裸金属、虚拟机还是云主机，但它本身不创建或管理这些资源（尽管提供了 Terraform 模板来简化云资源的准备）。</p></li><li><p><strong>Pigsty 不是容器编排系统</strong>。它直接运行在操作系统之上，不需要 Kubernetes 或 Docker 作为基础设施。当然，它可以与这些系统共存，并提供 Docker 模块来运行无状态应用。</p></li><li><p><strong>Pigsty 不是通用的数据库管理工具</strong>。它专注于 PostgreSQL 及其生态，虽然也支持 Redis、Etcd、MinIO 等周边组件，但核心始终是围绕 PostgreSQL 构建的。</p></li><li><p><strong>Pigsty 不会锁定您</strong>。它基于开源组件构建，不修改 PostgreSQL 内核，不引入专有协议。您随时可以脱离 Pigsty 继续使用管理好的 PostgreSQL 集群。</p></li></ul><p>Pigsty 不限制您应该或不应该如何构建数据库服务。例如:</p><ul><li>Pigsty 为您提供了良好的参数默认值和配置模板，但您可以覆盖任何参数。</li><li>Pigsty 提供了声明式 API，但您依然可以使用底层工具（Ansible、Patroni、pgBackRest 等）进行手动管理。</li><li>Pigsty 可以管理完整的生命周期，也可以只使用其中的监控系统来观测现有的数据库实例或 RDS。</li></ul><p>Pigsty 提供的抽象层次不同于硬件层面，它工作在数据库服务层面，聚焦于如何让 PostgreSQL 以最佳状态交付价值，而不是重新发明轮子。</p><hr><h2 id=postgresql-部署方式的演进>PostgreSQL 部署方式的演进</h2><p>要理解 Pigsty 的价值，让我们回顾一下 PostgreSQL 部署方式的演进历程。</p><h3 id=手工部署时代>手工部署时代</h3><p>在传统的部署方式中，DBA 需要手工安装配置 PostgreSQL，手工设置复制，手工配置监控，手工处理故障。这种方式的问题显而易见：</p><ul><li><strong>效率低下</strong>：每个实例都需要重复大量手工操作，容易出错。</li><li><strong>缺乏标准化</strong>：不同 DBA 配置的数据库可能千差万别，难以维护。</li><li><strong>可靠性差</strong>：故障处理依赖人工介入，恢复时间长，容易出现人为失误。</li><li><strong>观测性弱</strong>：缺乏统一的监控体系，问题发现和定位困难。</li></ul><h3 id=托管数据库时代>托管数据库时代</h3><p>为了解决这些问题，云厂商提供了托管数据库服务（RDS）。云 RDS 确实解决了部分运维问题，但也带来了新的挑战：</p><ul><li><strong>成本高昂</strong>：托管服务通常收取硬件成本数倍到十几倍的"服务费"。</li><li><strong>供应商锁定</strong>：迁移困难，受制于特定云平台。</li><li><strong>功能受限</strong>：无法使用某些高级特性，扩展插件受限，参数调整受限。</li><li><strong>数据主权</strong>：数据存储在云端，自主可控性降低。</li></ul><h3 id=本地-rds-时代>本地 RDS 时代</h3><p>Pigsty 代表了第三种方式：在本地环境中构建媲美甚至超越云 RDS 的数据库服务。</p><p>Pigsty 结合了前两种方式的优点：</p><ul><li><strong>自动化程度高</strong>：一键部署，自动配置，故障自愈，像云 RDS 一样便捷。</li><li><strong>完全自主可控</strong>：运行在您自己的基础设施上，数据完全掌握在自己手中。</li><li><strong>成本极低</strong>：以接近纯硬件的成本运行企业级数据库服务。</li><li><strong>功能完整</strong>：无限制地使用 PostgreSQL 的全部能力和生态扩展。</li><li><strong>开放架构</strong>：基于开源组件，无供应商锁定，可随时迁移。</li></ul><p>这种方式特别适合：</p><ul><li><strong>私有云与混合云</strong>：需要在本地环境中运行数据库的企业。</li><li><strong>成本敏感型用户</strong>：希望降低数据库 TCO 的组织。</li><li><strong>高安全要求场景</strong>：需要完全自主可控的关键数据。</li><li><strong>PostgreSQL 深度用户</strong>：需要使用高级特性和丰富扩展的场景。</li><li><strong>开发与测试</strong>：需要在本地快速搭建与生产环境一致的数据库。</li></ul><hr><h2 id=接下来>接下来</h2><p>现在您已经了解了 Pigsty 的基本概念，可以:</p><ul><li>查看 <a href=/docs/concept/arch><strong>系统架构</strong></a> 了解 Pigsty 的模块化设计</li><li>了解 <a href=/docs/concept/model><strong>集群模型</strong></a> 理解 Pigsty 如何组织数据库集群</li><li>学习 <a href=/docs/concept/ha><strong>高可用</strong></a> 机制掌握故障自愈的原理</li><li>探索 <a href=/docs/concept/pitr><strong>时间点恢复</strong></a> 了解如何应对数据误删</li><li>研究 <a href=/docs/pgsql/misc/svc><strong>服务接入</strong></a> 理解如何稳定交付数据库服务</li><li>体验 <a href=/docs/concept/iac><strong>基础设施即代码</strong></a> 感受声明式配置的魅力</li><li>或直接开始 <a href=/docs/setup/install><strong>快速上手</strong></a> 在几分钟内部署您的第一个 Pigsty 环境</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5f0248151627a7f914932011cbe64c98>1 - 积木式架构</h1><div class=lead>Pigsty 的模块化架构介绍 —— 声明式组合，按需定制，自由部署。</div><p>Pigsty 使用 <strong>模块化架构</strong> 与 <strong>声明式接口</strong>，您可以像 <a href=/docs/deploy/planning#%E5%B8%B8%E8%A7%81%E6%96%B9%E6%A1%88><strong>搭积木一样自由按需组合模块</strong></a>。</p><ul><li>Pigsty 采用 <a href=/docs/deploy/planning><strong>模块化设计</strong></a>，可自由组合，按需使用（Use one or all），以适应不同场景的需求。</li><li>Pigsty 使用 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 和 <a href=/docs/concept/iac/parameter><strong>配置参数</strong></a> 描述整套部署环境，并通过 <a href=/docs/setup/playbook><strong>Ansible 剧本</strong></a> 实现部署与调整。</li><li>Pigsty 在可以在任意 <a href=/docs/concept/arch/node><strong>节点</strong></a> 上运行，无论是物理裸机还是虚拟机，只要运行 <a href=/docs/ref/linux><strong>兼容的操作系统</strong></a> 即可。</li></ul><hr><h2 id=模块>模块</h2><p>Pigsty 采用模块化设计，有六个主要的默认模块：<a href=/docs/pgsql><code>PGSQL</code></a>、<a href=/docs/infra><code>INFRA</code></a>、<a href=/docs/node><code>NODE</code></a>、<a href=/docs/etcd><code>ETCD</code></a>、<a href=/docs/redis><code>REDIS</code></a> 和 <a href=/docs/minio><code>MINIO</code></a>。</p><ul><li><a href=/docs/pgsql><strong><code>PGSQL</code></strong></a>：由 Patroni、Pgbouncer、HAproxy、PgBackrest 等驱动的自治高可用 Postgres 集群。</li><li><a href=/docs/infra><strong><code>INFRA</code></strong></a>：本地软件仓库、Nginx、Grafana、Victoria、AlertManager、Blackbox Exporter 可观测性全家桶。</li><li><a href=/docs/node><strong><code>NODE</code></strong></a>：调整节点到所需状态、名称、时区、NTP、ssh、sudo、haproxy、docker、vector、keepalived</li><li><a href=/docs/etcd><strong><code>ETCD</code></strong></a>：分布式键值存储，用作高可用 Postgres 集群的 DCS：共识选主/配置管理/服务发现。</li><li><a href=/docs/redis><strong><code>REDIS</code></strong></a>：Redis 服务器，支持独立主从、哨兵、集群模式，并带有完整的监控支持。</li><li><a href=/docs/minio><strong><code>MINIO</code></strong></a>：与 S3 兼容的简单对象存储服务器，可作为 PG数据库备份的可选目的地。</li></ul><p>你可以声明式地自由组合它们。如果你想要主机监控，在基础设施节点上安装 <a href=/docs/infra><code>INFRA</code></a> 模块，并在纳管节点上安装 <a href=/docs/node><code>NODE</code></a> 模块就足够了。
<a href=/docs/etcd><code>ETCD</code></a> 和 <a href=/docs/pgsql><code>PGSQL</code></a> 模块用于搭建高可用 PG 集群，将模块安装在多个节点上，可以自动形成一个高可用的数据库集群。
您可以复用 Pigsty 基础架构并开发您自己的模块，<a href=/docs/redis><code>REDIS</code></a> 和 <a href=/docs/minio><code>MINIO</code></a> 可以作为一个样例。后续还会有更多的模块加入，例如对 Mongo 与 MySQL 的初步支持已经提上了日程。</p><p>请注意，所有模块都强依赖 <code>NODE</code> 模块：在 Pigsty 中节点必须先安装 <code>NODE</code> 模块，被 Pigsty 纳管后方可部署其他模块。
当节点（默认）使用本地软件源进行安装时，<code>NODE</code> 模块对 <code>INFRA</code> 模块有弱依赖。因此安装 <code>INFRA</code> 模块的管理节点/基础设施节点会在 <a href=/docs/setup/playbook><code>deploy.yml</code></a> 剧本中完成 Bootstrap 过程，解决循环依赖。</p><p><a href=/docs/deploy/sandbox><img src=/img/pigsty/sandbox.png alt=pigsty-sandbox></a></p><hr><h2 id=单机安装>单机安装</h2><p>默认情况下，Pigsty 将在单个 <strong>节点</strong> (物理机/虚拟机) 上安装。<a href=https://github.com/pgsty/pigsty/blob/main/deploy.yml><code>deploy.yml</code></a> 剧本将在<strong>当前</strong>节点上安装 <a href=/docs/infra><code>INFRA</code></a>、<a href=/docs/etcd><code>ETCD</code></a>、<a href=/docs/pgsql><code>PGSQL</code></a> 和可选的 <a href=/docs/minio><code>MINIO</code></a> 模块，
这将为你提供一个功能完备的可观测性技术栈全家桶 (Prometheus、Grafana、Loki、AlertManager、PushGateway、BlackboxExporter 等) ，以及一个内置的 PostgreSQL 单机实例作为 CMDB，也可以开箱即用。 (集群名 <code>pg-meta</code>，库名为 <code>meta</code>)。</p><p>这个节点现在会有完整的自我监控系统、可视化工具集，以及一个自动配置有 PITR 的 Postgres 数据库（HA不可用，因为你只有一个节点）。你可以使用此节点作为开发箱、测试、运行演示以及进行数据可视化和分析。或者，还可以把这个节点当作管理节点，部署纳管更多的节点！</p><p><a href=/docs/infra/><img src=/img/pigsty/arch.png alt=pigsty-arch></a></p><hr><h2 id=监控>监控</h2><p>安装的 <a href=#%E5%8D%95%E6%9C%BA%E5%AE%89%E8%A3%85>单机元节点</a> 可用作<strong>管理节点</strong>和<strong>监控中心</strong>，以将更多节点和数据库服务器置于其监视和控制之下。</p><p>Pigsty 的监控系统可以独立使用，如果你想安装 Prometheus / Grafana 可观测性全家桶，Pigsty 为你提供了最佳实践！
它为 <a href=https://demo.pigsty.cc/d/node-overview>主机节点</a> 和 <a href=https://demo.pigsty.cc/d/pgsql-overview>PostgreSQL数据库</a> 提供了丰富的仪表盘。
无论这些节点或 PostgreSQL 服务器是否由 Pigsty 管理，只需简单的配置，你就可以立即拥有生产级的监控和告警系统，并将现有的主机与PostgreSQL纳入监管。</p><p><a href=/docs/pgsql/dashboard/><img src=/img/pigsty/dashboard.jpg alt=pigsty-dashboard.jpg></a></p><hr><h2 id=高可用pg集群>高可用PG集群</h2><p>Pigsty 帮助您在任何地方 <strong>拥有</strong> 您自己的生产级高可用 PostgreSQL RDS 服务。</p><p>要创建这样一个高可用 PostgreSQL 集群/RDS服务，你只需用简短的配置来描述它，并运行剧本来创建即可：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ bin/pgsql-add pg-test  <span style=color:#8f5902;font-style:italic># 初始化集群 &#39;pg-test&#39;</span>
</span></span></code></pre></div><p>不到10分钟，您将拥有一个服务接入，监控，备份PITR，高可用配置齐全的 PostgreSQL 数据库集群。</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>硬件故障由 patroni、etcd 和 haproxy 提供的自愈高可用架构来兜底，在主库故障的情况下，默认会在 45 秒内执行自动故障转移（Failover）。
客户端无需修改配置重启应用：Haproxy 利用 patroni 健康检查进行流量分发，读写请求会自动分发到新的集群主库中，并避免脑裂的问题。
这一过程十分丝滑，例如在从库故障，或主动切换（switchover）的情况下，客户端只有一瞬间的当前查询闪断，</p><p>软件故障、人为错误和 数据中心级灾难由 pgbackrest 和可选的 <a href=/docs/minio>MinIO</a> 集群来兜底。这为您提供了本地/云端的 PITR 能力，并在数据中心失效的情况下提供了跨地理区域复制，与异地容灾功能。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-66767bf2f054756113e02343d62b9774>1.1 - 节点</h1><div class=lead>节点（node）是对硬件资源/操作系统的抽象，可以是物理机，裸金属、虚拟机、或者容器与 pods。</div><p><strong>节点（node）</strong> 是对硬件资源/操作系统的抽象，可以是物理机，裸金属、虚拟机、或者容器与 pods。</p><p>只要装着 <a href=/docs/ref/linux><strong>Linux 操作系统</strong></a>（以及 systemd 守护进程），能使用 CPU/内存/磁盘/网络 等标准资源，即可视作节点。</p><p>节点上可以安装 <a href=/docs/ref/module><strong>模块</strong></a>，Pigsty 中存在几种不同类型节点，主要区别就在于安装了不同的模块。</p><table class=full-width><thead><tr><th style=text-align:center>类型</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><a href=#%E6%99%AE%E9%80%9A%E8%8A%82%E7%82%B9><strong>普通节点</strong></a></td><td style=text-align:left>被 Pigsty 管理的节点</td></tr><tr><td style=text-align:center><a href=#admin%E8%8A%82%E7%82%B9><strong>ADMIN 节点</strong></a></td><td style=text-align:left>使用 Ansible 发出管理指令的节点</td></tr><tr><td style=text-align:center><a href=#infra%E8%8A%82%E7%82%B9><strong>INFRA 节点</strong></a></td><td style=text-align:left>安装 <a href=/docs/infra/><strong>INFRA</strong></a> 模块的基础设施节点</td></tr><tr><td style=text-align:center><a href=#etcd%E8%8A%82%E7%82%B9><strong>ETCD 节点</strong></a></td><td style=text-align:left>安装 <a href=/docs/etcd/><strong>ETCD</strong></a> 模块的分布式共识节点</td></tr><tr><td style=text-align:center><a href=#minio%E8%8A%82%E7%82%B9><strong>MINIO 节点</strong></a></td><td style=text-align:left>安装 <a href=/docs/minio/><strong>MINIO</strong></a> 模块的对象存储节点</td></tr><tr><td style=text-align:center><a href=#pgsql%E8%8A%82%E7%82%B9><strong>PGSQL 节点</strong></a></td><td style=text-align:left>安装 <a href=/docs/pgsql/><strong>PGSQL</strong></a> 模块的数据库节点</td></tr><tr><td style=text-align:center>……</td><td style=text-align:left>安装了其他各类模块的节点……</td></tr></tbody></table><p>在 <a href=/docs/setup/install><strong>单机部署</strong></a> Pigsty 时，多者合而为一，当前节点将同时作为普通节点，管理节点、基础设施节点、ETCD 节点，以及数据库节点。</p><hr><h2 id=普通节点>普通节点</h2><p>使用 Pigsty 管理节点，可在其上安装模块。<a href=/docs/node/playbook#nodeyml><strong><code>node.yml</code></strong></a> 剧本将调整节点至所需状态。
普通节点上可能会运行以下服务：</p><table class=full-width><thead><tr><th style=text-align:center>组件</th><th style=text-align:center>端口</th><th>描述</th><th>状态</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>node_exporter</code></strong></td><td style=text-align:center><code>9100</code></td><td>节点监控指标导出器</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>haproxy</code></strong></td><td style=text-align:center><code>9101</code></td><td>HAProxy 负载均衡器（管理端口）</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>vector</code></strong></td><td style=text-align:center><code>9598</code></td><td>日志收集代理</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>docker</code></strong></td><td style=text-align:center><code>9323</code></td><td>启用容器支持</td><td>⚠️ 按需启用</td></tr><tr><td style=text-align:center><strong><code>keepalived</code></strong></td><td style=text-align:center><code>n/a</code></td><td>管理节点集群 L2 VIP</td><td>⚠️ 按需启用</td></tr><tr><td style=text-align:center><strong><code>keepalived_exporter</code></strong></td><td style=text-align:center><code>9650</code></td><td>监控 Keepalived 状态</td><td>⚠️ 按需启用</td></tr></tbody></table><p>这里，<code>node_exporter</code> 会向监控系统暴露主机上的各类监控指标，<code>vector</code> 会向日志收集系统发送日志，<code>haproxy</code> 则提供负载均衡功能，对外暴露服务。
这三项服务默认开启。而 <a href=/docs/docker><strong>Docker</strong></a>，<code>keepalived</code> 及 <code>keepalived_exporter</code> 这三项服务作为可选项，可按需启用。</p><hr><h2 id=admin节点>ADMIN节点</h2><p>一套 Pigsty 部署中有且只有一个 <strong>管理节点</strong>，管理节点是执行 Ansible 剧本，发起控制/部署命令的节点。</p><p>该节点拥有对所有其他节点的 <code>ssh/sudo</code> 访问权限。管理节点的安全至关重要，请确保它的访问受到严格控制。</p><p>在 <a href=/docs/setup/install><strong>单机安装</strong></a> 的 <a href=/docs/concept/iac/configure><strong>配置过程</strong></a> 中，当前安装节点就是管理节点。
但也有其他的可能，例如，如果你的笔记本可以 ssh 访问所有被管理节点，并且安装了 Ansible，那么在这种情况下，
您的笔记本电脑就可以作为一个管理节点 —— 尽管这对于生产环境来说不太合适。</p><p>例如，您使用自己的笔记本电脑，管理一台云端上部署了 Pigsty 的虚拟机，这时候，您的笔记本电脑就是管理节点。</p><p>在严肃的生产环境中，管理节点通常是 1-2 台 DBA 专用的 <strong>管控机</strong>。在资源受限的环境中，则通常会复用 <a href=#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a> 作为管理节点。
因为所有的 INFRA 节点上都默认安装了 Ansible，可以作为额外的备用的管理节点。</p><hr><h2 id=infra节点>INFRA节点</h2><p>一套 Pigsty 部署可能有 <strong>1</strong> 个或多个 INFRA 节点，大型生产环境可能有 <strong>2-3</strong> 个。</p><p>配置清单中的 <strong><code>infra</code></strong> 分组指定哪些节点是 INFRA节点，这些节点上会部署 <a href=/docs/infra/><strong>INFRA</strong></a> 模块，包含下列组件：</p><table class=full-width><thead><tr><th style=text-align:center>组件</th><th style=text-align:center>端口</th><th>描述</th></tr></thead><tbody><tr><td style=text-align:center><code>nginx</code></td><td style=text-align:center><code>80/443</code></td><td>Web 图形界面，本地软件仓库</td></tr><tr><td style=text-align:center><code>grafana</code></td><td style=text-align:center><code>3000</code></td><td>可视化平台</td></tr><tr><td style=text-align:center><code>victoriaMetrics</code></td><td style=text-align:center><code>8428</code></td><td>时序数据库（收存监控指标）</td></tr><tr><td style=text-align:center><code>victoriaLogs</code></td><td style=text-align:center><code>9428</code></td><td>日志收集服务器</td></tr><tr><td style=text-align:center><code>victoriaTraces</code></td><td style=text-align:center><code>10428</code></td><td>链路追踪收集服务器</td></tr><tr><td style=text-align:center><code>vmalert</code></td><td style=text-align:center><code>8880</code></td><td>告警与衍生指标计算规则</td></tr><tr><td style=text-align:center><code>alertmanager</code></td><td style=text-align:center><code>9059</code></td><td>告警聚合分发/屏蔽管理</td></tr><tr><td style=text-align:center><code>blackbox_exporter</code></td><td style=text-align:center><code>9115</code></td><td>黑盒探测，ping 节点 / vip</td></tr><tr><td style=text-align:center><code>dnsmasq</code></td><td style=text-align:center><code>53</code></td><td>内部 DNS 域名解析</td></tr><tr><td style=text-align:center><code>chronyd</code></td><td style=text-align:center><code>123</code></td><td>NTP 时间服务器</td></tr><tr><td style=text-align:center><code>ansible</code></td><td style=text-align:center><code>-</code></td><td>执行剧本，发起管理</td></tr></tbody></table><p>其中，Nginx 作为当前模块的入口，提供 Web 图形界面和本地软件仓库服务。
如果你部署多个 INFRA 节点，每个 Infra 节点上的服务是相互独立的。
但你确实可以从任意一个 Infra 节点上的 Grafana 访问所有的监控数据源。</p><p>Pigsty 使用 <a href=/docs/about/license><strong>Apache-2.0</strong></a> 许可证开源，但请注意其中的 Grafana 组件使用 AGPLv3 许可证。</p><hr><h2 id=etcd节点>ETCD节点</h2><p><a href=/docs/etcd><strong>ETCD</strong></a> 模块为 PostgreSQL 高可用提供分布式共识服务（DCS）。</p><p><a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中的 <strong><code>etcd</code></strong> 分组指定哪些节点是 ETCD 节点，ETCD 节点上运行着 etcd 服务器，监听以下两个端口：</p><table class=full-width><thead><tr><th style=text-align:center>组件</th><th style=text-align:center>端口</th><th>描述</th></tr></thead><tbody><tr><td style=text-align:center><code>etcd</code></td><td style=text-align:center><code>2379</code></td><td>ETCD 分布式键值存储（客户端端口）</td></tr><tr><td style=text-align:center><code>etcd</code></td><td style=text-align:center><code>2380</code></td><td>ETCD 集群 Peer 通信端口</td></tr></tbody></table><hr><h2 id=minio节点>MINIO节点</h2><p><a href=/docs/minio><strong>MINIOn</strong></a> 模块为 PostgreSQL 提供了一个可选的 <a href=/docs/pgsql/backup/repository><strong>备份存储仓库</strong></a>。</p><p>配置清单中的 <strong><code>minio</code></strong> 分组指定哪些节点是 MinIO 节点，这些节点上会运行 MinIO 服务器，监听以下端口：</p><table class=full-width><thead><tr><th style=text-align:center>组件</th><th style=text-align:center>端口</th><th>描述</th></tr></thead><tbody><tr><td style=text-align:center><code>minio</code></td><td style=text-align:center><code>9000</code></td><td>MinIO S3 API 服务端口</td></tr><tr><td style=text-align:center><code>minio</code></td><td style=text-align:center><code>9001</code></td><td>MinIO 管理控制台端口</td></tr></tbody></table><hr><h2 id=pgsql节点>PGSQL节点</h2><p>安装了 <a href=/docs/pgsql/><strong>PGSQL</strong></a> 模块的节点被称为 PGSQL 节点。节点与 PostgreSQL 实例为 1:1 部署，也就是每个节点上只运行一个 PG 实例。</p><p>PGSQL 节点可从相应 PostgreSQL 实例借用 <strong>身份</strong> —— 由 <a href=/docs/node/param/#node_id_from_pg><code>node_id_from_pg</code></a> 控制，默认为 <code>true</code>，即节点名会被设置为 PG 实例名。</p><p>PGSQL节点在 <a href=#%E6%99%AE%E9%80%9A%E8%8A%82%E7%82%B9><strong>普通节点</strong></a> 的基础上，还会额外运行以下组件：</p><table class=full-width><thead><tr><th style=text-align:center>组件</th><th style=text-align:center>端口</th><th>描述</th><th>状态</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>postgres</code></strong></td><td style=text-align:center><code>5432</code></td><td>PostgreSQL 数据库服务器</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>pgbouncer</code></strong></td><td style=text-align:center><code>6432</code></td><td>Pgbouncer 连接池</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>patroni</code></strong></td><td style=text-align:center><code>8008</code></td><td>Patroni 高可用管理组件</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>pg_exporter</code></strong></td><td style=text-align:center><code>9630</code></td><td>Postgres 监控指标导出器</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>pgbouncer_exporter</code></strong></td><td style=text-align:center><code>9631</code></td><td>PGBouncer 监控指标导出器</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>pgbackrest_exporter</code></strong></td><td style=text-align:center><code>9854</code></td><td>Pgbackrest 监控指标导出器</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>vip-manager</code></strong></td><td style=text-align:center><code>n/a</code></td><td>将 L2 VIP 绑定在集群主库节点上</td><td>⚠️ 按需启用</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-primary</code></strong></td><td style=text-align:center><code>5433</code></td><td>通过 <code>haproxy</code> 对外暴露数据库服务：主连接池：读/写服务</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-replica</code></strong></td><td style=text-align:center><code>5434</code></td><td>通过 <code>haproxy</code> 对外暴露数据库服务：副本连接池：只读服务</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-default</code></strong></td><td style=text-align:center><code>5436</code></td><td>通过 <code>haproxy</code> 对外暴露数据库服务：主直连服务</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-offline</code></strong></td><td style=text-align:center><code>5438</code></td><td>通过 <code>haproxy</code> 对外暴露数据库服务：离线直连：离线读服务</td><td>✅ 默认启用</td></tr><tr><td style=text-align:center><strong><code>{{ pg_cluster }}-&lt;service></code></strong></td><td style=text-align:center><code>543x</code></td><td>通过 <code>haproxy</code> 对外暴露数据库服务：PostgreSQL 定制服务</td><td>⚠️按需定制</td></tr></tbody></table><p>其中，<code>vip-manager</code> 只有当用户配置了 <strong>PG VIP</strong> 时才会启用。
在 <a href=/docs/pgsql/service><strong><code>pg_services</code></strong></a> 中可以定义更多的 <a href=/docs/pgsql/service#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1><strong>自定义服务</strong></a>，这些服务会被 <code>haproxy</code> 对外暴露，并使用更多的服务端口。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-d65561d0ed395a21fc6b7dd2654dc081>1.2 - INFRA 架构</h1><div class=lead>Pigsty 中基础设施模块的架构，组件与功能详解。</div><p>运行生产级别高可用 PostgreSQL 集群，通常需要一套完善的基础设施服务（底座）来支撑，例如监控告警、日志收集、时间同步、DNS 解析，本地软件仓库等。
Pigsty 提供了 <a href=/docs/infra><strong>INFRA 模块</strong></a> 来解决这个问题 —— 这是一个 <strong>可选模块</strong>，但我们强烈推荐启用它。</p><hr><h2 id=概览>概览</h2><p>下图是 <a href=/docs/setup/install><strong>单机部署</strong></a> 时的架构示意图，图中右半部分即为 <a href=/docs/infra><strong>INFRA 模块</strong></a> 所包含的组件，其中包括：</p><table><thead><tr><th style=text-align:left>组件</th><th>种类</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left><a href=#nginx><strong>Nginx</strong></a></td><td>Web服务器</td><td style=text-align:left><a href=/docs/setup/webui><strong>Web 界面</strong></a> 的统一入口，<a href=#repo><strong>本地软件仓库</strong></a>，内部服务的反向代理</td></tr><tr><td style=text-align:left><a href=#repo><strong>Repo</strong></a></td><td>软件仓库</td><td style=text-align:left>APT / DNF 仓库，下载有所有部署需要的 RPM/DEB 包及其依赖</td></tr><tr><td style=text-align:left><a href=#grafana><strong>Grafana</strong></a></td><td>可视化平台</td><td style=text-align:left>呈现监控指标、日志与链路追踪，承载监控大屏、巡检报表以及自定义数据应用。</td></tr><tr><td style=text-align:left><a href=#victoriametrics><strong>VictoriaMetrics</strong></a></td><td>时序数据库</td><td style=text-align:left>拉取全部监控指标，兼容 Prometheus API，并通过 VMUI 提供查询界面。</td></tr><tr><td style=text-align:left><a href=#victorialogs><strong>VictoriaLogs</strong></a></td><td>日志平台</td><td style=text-align:left>集中收集存储日志，所有节点默认运行 Vector，将系统日志与数据库日志推送到此。</td></tr><tr><td style=text-align:left><a href=#victoriatraces><strong>VictoriaTraces</strong></a></td><td>链路追踪</td><td style=text-align:left>收集慢 SQL、服务链路等追踪数据。</td></tr><tr><td style=text-align:left><a href=#vmalert><strong>VMAlert</strong></a></td><td>告警计算</td><td style=text-align:left>评估告警规则，将事件推送至 Alertmanager。</td></tr><tr><td style=text-align:left><a href=#alertmanager><strong>AlertManager</strong></a></td><td>告警管理</td><td style=text-align:left>聚合告警事件，分发告警通知，支持邮件、Webhook 等渠道。</td></tr><tr><td style=text-align:left><a href=#blackboxexporter><strong>BlackboxExporter</strong></a></td><td>黑盒探测</td><td style=text-align:left>探测各个 IP/VIP/URL 的可达性。</td></tr><tr><td style=text-align:left><a href=#dnsmasq><strong>DNSMASQ</strong></a></td><td>DNS解析</td><td style=text-align:left>提供 DNS 解析服务，解析 Pigsty 内部使用到的域名。【可选】</td></tr><tr><td style=text-align:left><a href=#chronyd><strong>Chronyd</strong></a></td><td>时间同步</td><td style=text-align:left>提供 NTP 时间同步服务，确保所有节点时间一致。 【可选】</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/ca><strong>CA</strong></a></td><td>证书签发</td><td style=text-align:left>签发环境内的加密证书</td></tr><tr><td style=text-align:left><a href=/docs/setup/playbook><strong>Ansible</strong></a></td><td>发起管理</td><td style=text-align:left>批量，声明式，无 Agent 管理大量服务器的工具</td></tr></tbody></table><p><a href=/docs/infra/><img src=/img/pigsty/arch.png alt=pigsty-arch></a></p><hr><h2 id=nginx>Nginx</h2><p><strong>Nginx</strong> 是 Pigsty 所有 WebUI 类服务的访问入口，默认使用 <a href=/docs/infra/param#nginx_port><strong><code>80</code></strong></a> / <a href=/docs/infra/param#nginx_ssl_port><strong><code>443</code></strong></a> 端口对外提供 HTTP / HTTPS 服务。<a href=https://demo.pigsty.cc/><strong>在线演示</strong></a></p><table class=full-width><thead><tr><th style=text-align:center>IP访问（替换）</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>公开演示</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10><strong><code>http://10.10.10.10</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/zh><strong><code>http://i.pigsty</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/zh><strong><code>https://i.pigsty</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/zh><strong><code>https://demo.pigsty.cc</code></strong></a></td><td></td></tr></tbody></table><p>带有 WebUI 的基础设施组件可以通过 <strong>Nginx</strong> 统一对外暴露服务，例如 <strong>Grafana</strong>、<strong>VictoriaMetrics</strong>（VMUI）、<strong>AlertManager</strong>，
以及 <strong>HAProxy</strong> 控制台，此外，<strong>本地软件仓库</strong> 等静态文件资源也通过 <strong>Nginx</strong> 对内外提供服务。</p><p><strong>Nginx</strong> 会根据 <a href=/docs/infra/param/#infra_portal><strong><code>infra_portal</code></strong></a> 中的定义，配置本地 Web 服务器或反向代理服务器。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>默认情况下将对外暴露 Pigsty 的管理首页：<code>i.pigsty</code>，上面不同的端点挂载代理了不同的组件：</p><table class=full-width><thead><tr><th style=text-align:left>端点</th><th style=text-align:left>组件</th><th style=text-align:left>原生端口</th><th style=text-align:left>备注</th><th>公开演示</th></tr></thead><tbody><tr><td style=text-align:left><code>/</code></td><td style=text-align:left><a href=/docs/infra/><strong>Nginx</strong></a></td><td style=text-align:left><code>80/443</code></td><td style=text-align:left>首页、本地仓库、文件服务</td><td><a href=https://demo.pigsty.cc/zh/><code>demo.pigsty.cc/zh/</code></a></td></tr><tr><td style=text-align:left><code>/ui/</code></td><td style=text-align:left><a href=#grafana><strong>Grafana</strong></a></td><td style=text-align:left><code>3000</code></td><td style=text-align:left>Grafana 仪表盘入口</td><td><a href=https://demo.pigsty.cc/ui/><code>demo.pigsty.cc/ui/</code></a></td></tr><tr><td style=text-align:left><code>/vmetrics/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VictoriaMetrics</strong></a></td><td style=text-align:left><code>8428</code></td><td style=text-align:left>时序数据库 Web UI</td><td><a href=https://demo.pigsty.cc/vmetrics/><code>demo.pigsty.cc/vmetrics/</code></a></td></tr><tr><td style=text-align:left><code>/vlogs/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VictoriaLogs</strong></a></td><td style=text-align:left><code>9428</code></td><td style=text-align:left>日志数据库 Web UI</td><td><a href=https://demo.pigsty.cc/vlogs/><code>demo.pigsty.cc/vlogs/</code></a></td></tr><tr><td style=text-align:left><code>/vtraces/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VictoriaTraces</strong></a></td><td style=text-align:left><code>10428</code></td><td style=text-align:left>链路追踪 Web UI</td><td><a href=https://demo.pigsty.cc/vtraces/><code>demo.pigsty.cc/vtraces/</code></a></td></tr><tr><td style=text-align:left><code>/vmalert/</code></td><td style=text-align:left><a href=/docs/infra/><strong>VMAlert</strong></a></td><td style=text-align:left><code>8880</code></td><td style=text-align:left>告警规则管理</td><td><a href=https://demo.pigsty.cc/vmalert/><code>demo.pigsty.cc/vmalert/</code></a></td></tr><tr><td style=text-align:left><code>/alertmgr/</code></td><td style=text-align:left><a href=/docs/infra/><strong>AlertManager</strong></a></td><td style=text-align:left><code>9059</code></td><td style=text-align:left>告警管理 Web UI</td><td><a href=https://demo.pigsty.cc/alertmgr/><code>demo.pigsty.cc/alertmgr/</code></a></td></tr><tr><td style=text-align:left><code>/blackbox/</code></td><td style=text-align:left><a href=/docs/infra/><strong>Blackbox</strong></a></td><td style=text-align:left><code>9115</code></td><td style=text-align:left>黑盒探测器</td><td></td></tr></tbody></table><p><a href=https://demo.pigsty.cc/zh><img src=/img/pigsty/home.png alt></a></p><p>Pigsty 允许对 <strong>Nginx</strong> 进行丰富的定制，将其作为本地文件服务器，或者反向代理服务器，配置自签名或者真正的 HTTPS 证书。</p><p>更多信息，请参阅：<a href=/docs/infra/admin/portal/><strong>教程：Nginx：向外代理暴露Web服务</strong></a> 与 <a href=/docs/infra/admin/cert><strong>教程：Certbot：申请与更新HTTPS证书</strong></a></p><hr><h2 id=repo>Repo</h2><p>Pigsty 会在安装时，默认在 Infra 节点上创建一个 <strong>本地软件仓库</strong>，以加速后续软件安装。<a href=https://demo.pigsty.cc/pigsty/><strong>在线演示</strong></a></p><p>该软件仓库默认位于 <a href=/docs/infra/param#repo_home><strong><code>/www/pigsty</code></strong></a> 目录，
由 <strong>Nginx</strong> 对外提供服务，挂载在 <code>/pigsty</code> 路径上：</p><table class=full-width><thead><tr><th style=text-align:center>IP访问（替换）</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>公开演示</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/pigsty><strong><code>http://10.10.10.10/pigsty</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/pigsty><strong><code>http://i.pigsty/pigsty</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/pigsty><strong><code>https://i.pigsty/pigsty</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/pigsty><strong><code>https://demo.pigsty.cc/pigsty</code></strong></a></td><td></td></tr></tbody></table><p>Pigsty 支持 <a href=/docs/setup/offline><strong>离线安装</strong></a>，实质上是将做好的本地软件仓库提前复制到目标环境中。
当 Pigsty 执行生产部署，需要创建本地软件仓库时，如果发现本地已经存在 <strong><code>/www/pigsty/repo_complete</code></strong> 标记文件，则会跳过从上游下载软件包的步骤，直接使用已有的软件包，避免联网下载。</p><p><a href=https://demo.pigsty.cc/pigsty/><img src=/img/pigsty/repo.webp alt=repo></a></p><p>更多信息，请参阅：<a href=/docs/infra/param/#repo><strong>配置：INFRA - REPO</strong></a></p><hr><h2 id=grafana>Grafana</h2><p><strong>Grafana</strong> 是 Pigsty 监控系统的核心组件，用于可视化展示监控指标、日志与各种信息。<a href=https://demo.pigsty.cc/ui/><strong>在线演示</strong></a></p><p><strong>Grafana</strong> 默认监听 <code>3000</code> 端口，挂载于 <strong>Nginx</strong> <code>/ui</code> 路径点上代理访问：</p><table class=full-width><thead><tr><th style=text-align:center>IP访问（替换）</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>公开演示</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/ui><strong><code>http://10.10.10.10/ui</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/ui><strong><code>http://i.pigsty/ui</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/ui><strong><code>https://i.pigsty/ui</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/ui><strong><code>https://demo.pigsty.cc/ui</code></strong></a></td><td></td></tr></tbody></table><p>Pigsty 预置了基于 <strong>VictoriaMetrics</strong> / <strong>Logs</strong> / <strong>Traces</strong> 的大量监控面板，并通过 URL 跳转实现一键下钻上卷，帮助快速定位故障。</p><p><strong>Grafana</strong> 亦可作为低代码可视化平台使用，因此默认安装 <strong>ECharts</strong>、victoriametrics-datasource、victorialogs-datasource 等插件，
同时将 <strong>Vector</strong> / <strong>Victoria</strong> 数据源统一注册为 <code>vmetrics-*</code>、<code>vlogs-*</code>、<code>vtraces-*</code>，方便扩展自定义仪表板。</p><p><img src=/img/dashboard/pigsty.jpg alt=dashboard></p><p>更多信息请参阅：<a href=/docs/infra/param/#grafana><strong>配置：INFRA - GRAFANA</strong></a>。</p><hr><h2 id=victoriametrics>VictoriaMetrics</h2><p><strong>VictoriaMetrics</strong> 是 Pigsty 的时序数据库，负责拉取并存储所有监控指标。<a href=https://demo.pigsty.cc/vmetrics/><strong>在线演示</strong></a></p><p>默认监听 <code>8428</code> 端口，挂载于 <strong>Nginx</strong> <code>/vmetrics</code> 路径上，亦可通过 <code>p.pigsty</code> 域名直接访问：</p><table class=full-width><thead><tr><th style=text-align:center>IP访问（替换）</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>公开演示</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/vmetrics><strong><code>http://10.10.10.10/vmetrics</code></strong></a></td><td style=text-align:center><a href=http://p.pigsty><strong><code>http://p.pigsty</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/vmetrics><strong><code>https://i.pigsty/vmetrics</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/vmetrics><strong><code>https://demo.pigsty.cc/vmetrics</code></strong></a></td><td></td></tr></tbody></table><p><strong>VictoriaMetrics</strong> 完全兼容 <strong>Prometheus</strong> API，支持 PromQL 查询、远程读写协议以及 Alertmanager API。
内置的 <strong>VMUI</strong> 提供即席查询界面，可直接探索指标数据，也可作为 <strong>Grafana</strong> 的数据源使用。</p><p><a href=https://demo.pigsty.cc/vmetrics/vmui><img src=/img/pigsty/vmetrics.webp alt=vmetrics></a></p><p>更多信息请参阅：<a href=/docs/infra/param/#vmetrics_enabled><strong>配置：INFRA - VMETRICS</strong></a></p><hr><h2 id=victorialogs>VictoriaLogs</h2><p><strong>VictoriaLogs</strong> 是 Pigsty 的日志平台，集中存储来自所有节点的结构化日志。<a href=https://demo.pigsty.cc/vlogs/><strong>在线演示</strong></a></p><p>默认监听 <code>9428</code> 端口，挂载于 <strong>Nginx</strong> <code>/vlogs</code> 路径上：</p><table class=full-width><thead><tr><th style=text-align:center>IP访问（替换）</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>公开演示</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/vlogs><strong><code>http://10.10.10.10/vlogs</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/vlogs><strong><code>http://i.pigsty/vlogs</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/vlogs><strong><code>https://i.pigsty/vlogs</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/vlogs><strong><code>https://demo.pigsty.cc/vlogs</code></strong></a></td><td></td></tr></tbody></table><p>所有纳管节点默认运行 <strong>Vector</strong> Agent，负责收集系统日志、PostgreSQL 日志、Patroni 日志、Pgbouncer 日志等，结构化处理后推送至 <strong>VictoriaLogs</strong>。
内置 Web UI 支持日志检索与过滤，也可配合 <strong>Grafana</strong> 的 victorialogs-datasource 插件进行可视化分析。</p><p><a href=https://demo.pigsty.cc/vlogs/select/vmui><img src=/img/pigsty/vmlogs.webp alt=vlogs></a></p><p>更多信息请参阅：<a href=/docs/infra/param/#vlogs_enabled><strong>配置：INFRA - VLOGS</strong></a></p><hr><h2 id=victoriatraces>VictoriaTraces</h2><p><strong>VictoriaTraces</strong> 用于收集链路追踪数据与慢 SQL 记录。<a href=https://demo.pigsty.cc/vtraces/><strong>在线演示</strong></a></p><p>默认监听 <code>10428</code> 端口，挂载于 <strong>Nginx</strong> <code>/vtraces</code> 路径上：</p><table class=full-width><thead><tr><th style=text-align:center>IP访问（替换）</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>公开演示</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/vtraces><strong><code>http://10.10.10.10/vtraces</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/vtraces><strong><code>http://i.pigsty/vtraces</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/vtraces><strong><code>https://i.pigsty/vtraces</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/vtraces><strong><code>https://demo.pigsty.cc/vtraces</code></strong></a></td><td></td></tr></tbody></table><p><strong>VictoriaTraces</strong> 提供 <strong>Jaeger</strong> 兼容接口，可用于分析服务调用链路与数据库慢查询。
结合 <strong>Grafana</strong> 面板，能够快速定位性能瓶颈，追溯问题根因。</p><p>更多信息请参阅：<a href=/docs/infra/param/#vtraces_enabled><strong>配置：INFRA - VTRACES</strong></a></p><hr><h2 id=vmalert>VMAlert</h2><p><strong>VMAlert</strong> 是告警规则计算引擎，负责评估告警规则并将触发的事件推送至 <strong>Alertmanager</strong>。<a href=https://demo.pigsty.cc/vmalert/><strong>在线演示</strong></a></p><p>默认监听 <code>8880</code> 端口，挂载于 <strong>Nginx</strong> <code>/vmalert</code> 路径上：</p><table class=full-width><thead><tr><th style=text-align:center>IP访问（替换）</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>公开演示</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/vmalert><strong><code>http://10.10.10.10/vmalert</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/vmalert><strong><code>http://i.pigsty/vmalert</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/vmalert><strong><code>https://i.pigsty/vmalert</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/vmalert><strong><code>https://demo.pigsty.cc/vmalert</code></strong></a></td><td></td></tr></tbody></table><p><strong>VMAlert</strong> 从 <strong>VictoriaMetrics</strong> 读取指标数据，周期性执行告警规则评估。
Pigsty 预置了 PGSQL、NODE、REDIS 等模块的告警规则，覆盖常见故障场景，开箱即用。</p><p><a href=https://demo.pigsty.cc/vmalert/vmalert/groups><img src=/img/pigsty/vmalert.webp alt=vmalert></a></p><p>更多信息请参阅：<a href=/docs/infra/param/#vmalert_enabled><strong>配置：INFRA - VMALERT</strong></a></p><hr><h2 id=alertmanager>AlertManager</h2><p><strong>AlertManager</strong> 负责告警事件的聚合、去重、分组与分发。<a href=https://demo.pigsty.cc/alertmgr/><strong>在线演示</strong></a></p><p>默认监听 <code>9059</code> 端口，挂载于 <strong>Nginx</strong> <code>/alertmgr</code> 路径上，亦可通过 <code>a.pigsty</code> 域名直接访问：</p><table class=full-width><thead><tr><th style=text-align:center>IP访问（替换）</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>公开演示</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/alertmgr><strong><code>http://10.10.10.10/alertmgr</code></strong></a></td><td style=text-align:center><a href=http://a.pigsty><strong><code>http://a.pigsty</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/alertmgr><strong><code>https://i.pigsty/alertmgr</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/alertmgr><strong><code>https://demo.pigsty.cc/alertmgr</code></strong></a></td><td></td></tr></tbody></table><p><strong>AlertManager</strong> 支持多种通知渠道：邮件、Webhook、Slack、PagerDuty、企业微信等。
通过配置告警路由规则，可实现按严重程度、模块类型进行差异化分发，支持静默、抑制等高级功能。</p><p><a href=https://demo.pigsty.cc/alertmgr/><img src=/img/pigsty/alertmanager.webp alt=alertmanager></a></p><p>更多信息请参阅：<a href=/docs/infra/param/#alertmanager_enabled><strong>配置：INFRA - AlertManager</strong></a></p><hr><h2 id=blackboxexporter>BlackboxExporter</h2><p><strong>Blackbox Exporter</strong> 用于主动探测目标的可达性，实现黑盒监控。</p><p>默认监听 <code>9115</code> 端口，挂载于 <strong>Nginx</strong> <code>/blackbox</code> 路径上：</p><table class=full-width><thead><tr><th style=text-align:center>IP访问（替换）</th><th style=text-align:center>域名（HTTP）</th><th style=text-align:center>域名（HTTPS）</th><th style=text-align:center>公开演示</th><th></th></tr></thead><tbody><tr><td style=text-align:center><a href=http://10.10.10.10/blackbox><strong><code>http://10.10.10.10/blackbox</code></strong></a></td><td style=text-align:center><a href=http://i.pigsty/blackbox><strong><code>http://i.pigsty/blackbox</code></strong></a></td><td style=text-align:center><a href=https://i.pigsty/blackbox><strong><code>https://i.pigsty/blackbox</code></strong></a></td><td style=text-align:center><a href=https://demo.pigsty.cc/blackbox><strong><code>https://demo.pigsty.cc/blackbox</code></strong></a></td><td></td></tr></tbody></table><p>支持 ICMP Ping、TCP 端口、HTTP/HTTPS 端点等多种探测方式。
可用于监控 VIP 可达性、服务端口存活、外部依赖健康状态等场景，是判断故障影响范围的重要手段。</p><p><a href=https://demo.pigsty.cc/blackbox/><img src=/img/pigsty/blackbox.webp alt=blackbox></a></p><p>更多信息请参阅：<a href=/docs/infra/param#blackbox_enabled><strong>配置：INFRA - BLACKBOX</strong></a></p><hr><h2 id=ansible>Ansible</h2><p><strong>Ansible</strong> 是 Pigsty 的核心编排工具，所有部署、配置、管理操作均通过 Ansible Playbook 完成。</p><p>Pigsty 在安装时会自动在管理节点（Infra 节点）上安装 <strong>Ansible</strong>。
它采用声明式配置风格与幂等剧本设计：同一剧本可重复执行，系统会自动收敛至期望状态，无需担心副作用。</p><p><strong>Ansible</strong> 的核心优势：</p><ul><li><strong>无 Agent</strong>：通过 SSH 远程执行，无需在目标节点安装额外软件。</li><li><strong>声明式</strong>：描述期望状态，而非执行步骤，配置即文档。</li><li><strong>幂等性</strong>：多次执行结果一致，支持部分失败后重试。</li></ul><p>更多信息请参阅：<a href=/docs/setup/playbook><strong>剧本：Pigsty Playbook</strong></a></p><hr><h2 id=dnsmasq>DNSMASQ</h2><p><strong>DNSMASQ</strong> 在 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a> 上提供环境内的 DNS 解析服务，将域名解析到对应 IP 地址。</p><p>DNSMASQ 默认监听 <code>53</code> 端口（UDP/TCP），为环境内所有节点提供 DNS 解析服务，解析记录位于 的 <code>/infra/hosts</code> 目录中。</p><p>其他模块在部署时会自动将域名注册到 INFRA 节点的 <strong>DNSMASQ</strong> 服务中，您可以按需使用。
DNS 是完全可选的模块，<strong>Pigsty 本身不依赖它即可正常运行</strong>。
客户端节点可将 INFRA 节点配置为 DNS 服务器，即可通过域名访问各服务，无需记忆 IP 地址。</p><ul><li><a href=/docs/infra/param/#dns_records><strong><code>dns_records</code></strong></a> : 写入 INFRA 节点的默认解析记录</li><li><a href=/docs/node/param/#node_dns_servers><strong><code>node_dns_servers</code></strong></a> ：为节点配置 DNS 服务器，默认通过 <a href=/docs/infra/param/#admin_ip><strong><code>admin_ip</code></strong></a> 指向 INFRA 节点。（也可以 <a href=/docs/node/param#node_dns_method><strong>不配置</strong></a>）</li></ul><p>更多信息请参阅：<a href=/docs/infra/param/#dns><strong>配置：INFRA - DNS</strong></a> 与 <a href=/docs/infra/admin/domain><strong>教程：DNS：配置域名解析</strong></a></p><hr><h2 id=chronyd>Chronyd</h2><p><strong>Chronyd</strong> 提供 NTP 时间同步服务，确保环境内所有节点时钟一致。默认监听 <code>123</code> 端口（UDP），作为环境内的时间源。</p><p>时间同步对分布式系统至关重要：日志排查需要时间戳对齐，证书校验依赖时钟准确，<strong>PostgreSQL</strong> 流复制也对时钟偏移敏感。
在隔离网络环境中，INFRA 节点可作为内部 NTP 服务器，其他节点同步至此。</p><p>在 Pigsty 中，默认所有节点都会启动 chonyd 服务用于时间同步。默认使用 <a href=/docs/node/param#node_ntp_servers><strong><code>pool.ntp.org</code></strong></a> 公共 NTP 服务器作为上游时间源。
Chronyd 本质上归属 <a href=/docs/node><strong>Node 模块</strong></a> 管理，但在网络隔离的环境中，你使用 <a href=/docs/infra/param/#admin_ip><strong><code>admin_ip</code></strong></a> 指向 INFRA 节点上的 Chronyd 服务作为内部时间源。
此时 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a> 上的 Chronyd 服务将充当内部时间同步基础设施的角色。
更多信息请参阅：<a href=/docs/node/param/#node_time><strong>配置：NODE - TIME</strong></a></p><hr><h2 id=infra节点与普通节点>INFRA节点与普通节点</h2><p>在 Pigsty 中，节点与基础设施的关系是 <strong>弱循环依赖</strong>：node_monitor → infra → node</p><p><a href=/docs/node><strong>NODE模块</strong></a> 本身不依赖 <a href=/docs/infra><strong>INFRA模块</strong></a>，但节点模块中的监控功能（node_monitor）需要依赖基础设施模块提供的监控平台与服务。</p><p>因此，在 <a href=/docs/infra/playbook#infrayml><strong><code>infra.yml</code></strong></a> 和 <a href=/docs/setup/playbook><strong><code>deploy</code></strong></a> 剧本中，
采用了一种 “交织部署” 的技术：</p><ul><li>首先初始化所有 <a href=/docs/concept/arch/node#%E6%99%AE%E9%80%9A%E8%8A%82%E7%82%B9><strong>普通节点</strong></a> 上的 <a href=/docs/node><strong>NODE模块</strong></a>，但是不配置监控，因为基础设施服务尚未部署完成。</li><li>然后初始化 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a> 上的 <a href=/docs/infra><strong>INFRA模块</strong></a>，此时监控已经可用</li><li>然后回过头来，重新配置所有 <a href=/docs/concept/arch/node#%E6%99%AE%E9%80%9A%E8%8A%82%E7%82%B9><strong>普通节点</strong></a> 上的监控功能，连接到已经部署完成的监控平台</li></ul><p>如果您不追求 “一次性” 部署所有节点，也可以采用 <a href=/docs/setup/config#%E5%8A%A0%E5%85%A5%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD><strong>分阶段部署</strong></a> 的方式，先初始化 INFRA 节点，然后再初始化其他普通节点即可。</p><h3 id=节点与基础设施是如何耦合的>节点与基础设施是如何耦合的？</h3><p>普通节点会通过 <a href=/docs/infra/param/#admin_ip><strong><code>admin_ip</code></strong></a> 参数来引用某个 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a> 作为它们的基础设施提供者。</p><p>例如，当你配置了全局的 <code>admin_ip = 10.10.10.10</code>，那么通常意味着所有节点都会使用这个 IP 上的基础设施服务。</p><p>这样的设计允许你快速，批量的切换节点的基础设施提供者 —— 以下是 <strong>可能</strong> 引用 <code>${admin_ip}</code> 的配置参数列表：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>模块</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/infra/param/#repo_endpoint><strong><code>repo_endpoint</code></strong></a></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>http://${admin_ip}:80</code></td><td>软件仓库访问地址</td></tr><tr><td style=text-align:left><a href=/docs/infra/param/#repo_upstream><strong><code>repo_upstream</code></strong></a><code>.baseurl</code></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>http://${admin_ip}/pigsty</code></td><td>本地软件源 baseurl</td></tr><tr><td style=text-align:left><a href=/docs/infra/param/#infra_portal><strong><code>infra_portal</code></strong></a><code>.endpoint</code></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>${admin_ip}:&lt;port></code></td><td>Nginx 反向代理后端地址</td></tr><tr><td style=text-align:left><a href=/docs/infra/param/#dns_records><strong><code>dns_records</code></strong></a></td><td style=text-align:center><a href=/docs/infra><strong><code>INFRA</code></strong></a></td><td><code>["${admin_ip} i.pigsty", ...]</code></td><td>DNS 解析记录</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_default_etc_hosts><strong><code>node_default_etc_hosts</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>["${admin_ip} i.pigsty"]</code></td><td>默认静态 DNS 记录</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_etc_hosts><strong><code>node_etc_hosts</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>[]</code></td><td>自定义静态 DNS 记录</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_dns_servers><strong><code>node_dns_servers</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>["${admin_ip}"]</code></td><td>动态 DNS 服务器地址</td></tr><tr><td style=text-align:left><a href=/docs/node/param/#node_ntp_servers><strong><code>node_ntp_servers</code></strong></a></td><td style=text-align:center><a href=/docs/node><strong><code>NODE</code></strong></a></td><td><code>["pool pool.ntp.org iburst"]</code></td><td>NTP 时间服务器（可选）</td></tr></tbody></table><p>例如，当节点安装软件的时候，<code>local</code> 仓库指向的就是 <code>admin_ip:80/pigsty</code> 上的 Nginx 本地软件仓库。DNS 服务器指向的也是 <code>admin_ip:53</code> 上的 <a href=#dnsmasq><strong>DNSMASQ</strong></a>。
但这并不是强制要求的，例如，节点完全可以忽略并不使用 <code>local</code> 仓库，直接从互联网上游源安装（大部分单机配置模板）；DNS 服务器也完全可以不配置与不使用，Pigsty 本身并无对 DNS 服务器的依赖。</p><hr><h2 id=infra节点与admin节点>INFRA节点与ADMIN节点</h2><p>通常发起管理的 <a href=/docs/concept/arch/node#admin%E8%8A%82%E7%82%B9><strong>ADMIN节点</strong></a> 会与基础设施节点（<a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a>）重合。
在 <a href=/docs/setup/install><strong>单机部署</strong></a> 就是这样的。在多节点部署中，如果有多个 INFRA 节点，管理节点通常是 <code>infra</code> 分组中的第一个，其余作为备用。
不过，也有例外存在。您可能会出于各种原因，将两者分离开来：</p><p>例如在 <a href=/docs/deploy><strong>大规模生产环境部署</strong></a> 中，一种经典模式是使用 1-2 台归属于 DBA 组的专用管理主机（微型虚拟机即可），
作为整个环境的控制中枢，并使用 2-3 台高配置的物理机（或者更多！），作为整个环境的监控基础设施。这时候管理节点就与基础设施节点分离开来了。
这时候，你在配置文件中填入的 <a href=/docs/infra/param/#admin_ip><strong>admin_ip</strong></a> 应该指向某个 INFRA 节点的 IP 地址，而不是当前 ADMIN 节点的 IP 地址。
这是因为历史遗留原因：Pigsty 设计之初，ADMIN 节点 与 INFRA 节点 是强绑定的概念，后来才逐渐演化出分离的能力，因此参数名称未做修改。</p><p>另一种常见的情况是 <a href=/docs/setup><strong>本地管理云节点</strong></a>，例如，您可以在自己的笔记本上安装 Ansible，然后填入你的云节点作为 “被管理对象”。
在这种情况下，您的笔记本充当 ADMIN 节点，而云服务器充当 INFRA 节点。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq: 1 , ansible_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>your_ssh_alias } } } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 利用 ansible_host 指向云节点（填入 ssh 别名）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd } }   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ssh 连接会使用 ssh your_ssh_alias</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>v4.1.0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=多个-infra-节点>多个 INFRA 节点</h2><p>默认情况下，Pigsty 只需要一个 INFRA 节点即可满足大部分需求。INFRA 模块挂了，也不会影响其他节点上的数据库服务。</p><p>但是，在一些对监控与告警要求极高的生产环境中，您可能希望部署多个 INFRA 节点，来提升基础设施的可用性。
一种常见的部署是使用两个 Infra 节点，提供一份冗余副本，并互相监控对方…
或者使用更多，部署分布式的 Victoria 集群实现无限水平扩展。</p><p>每个 Infra 节点都是 <strong>独立</strong> 的，Nginx 指向的都是本机上的服务。
VictoriaMetrics 也是独立抓取环境中所有服务的监控指标，
日志会默认推送到所有 VictoriaLogs 日志采集端点上。
唯一的例外是 Grafana，每一个 Grafana 中都会注册所有的 VictoriaMetrics / Logs / Traces / PostgreSQL 实例作为数据源。
因此每一个 Grafana 实例都能看到完整的监控数据。</p><p>如果您对 Grafana 进行修改，例如添加新的仪表板，或者修改数据源配置，这些变更只会影响当前节点上的 Grafana 实例。
如果您希望所有节点上的 Grafana 保持一致，可以使用一个 PostgreSQL 数据库作为共享存储，详情参考 <a href=/docs/infra/admin/grafana><strong>教程：配置 Grafana 高可用</strong></a>。</p><p><a href=https://demo.pigsty.cc/ui/d/infra-overview><img src=/img/dashboard/infra-overview.webp alt></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c777ff17702df77ebc33dadeb81e4174>1.3 - PGSQL 架构</h1><div class=lead>PostgreSQL 模块的组件交互与数据流。</div><p>PGSQL 模块在生产环境中以 <strong>集群</strong> 的形式组织，这些 <strong>集群</strong> 是由一组通过 <strong>主-备</strong> 关联的数据库 <strong>实例</strong> 组成的 <strong>逻辑实体</strong>。</p><hr><h2 id=概览>概览</h2><p><a href=/docs/pgsql><strong>PGSQL 模块</strong></a> 包含下列组件，协同提供生产级 PostgreSQL 高可用集群服务：</p><table class=full-width><thead><tr><th style=text-align:left>组件</th><th>简介</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left><a href=#postgresql><strong><code>postgres</code></strong></a></td><td>数据库</td><td style=text-align:left>世界上最先进的开源关系型数据库，PGSQL 模块的核心。</td></tr><tr><td style=text-align:left><a href=#patroni><strong><code>patroni</code></strong></a></td><td>高可用</td><td style=text-align:left>托管 PostgreSQL 进程，协调故障转移、选主、配置变更。</td></tr><tr><td style=text-align:left><a href=#pgbouncer><strong><code>pgbouncer</code></strong></a></td><td>连接池</td><td style=text-align:left>轻量级连接池中间件，复用连接、降低开销、提供额外灵活性。</td></tr><tr><td style=text-align:left><a href=#pgbackrest><strong><code>pgbackrest</code></strong></a></td><td>备份恢复</td><td style=text-align:left>全量/增量备份与 WAL 归档，支持本地与对象存储。</td></tr><tr><td style=text-align:left><a href=#pg_exporter><strong><code>pg_exporter</code></strong></a></td><td>指标导出</td><td style=text-align:left>导出 PostgreSQL 监控指标供 Prometheus 抓取。</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter><strong><code>pgbouncer_exporter</code></strong></a></td><td>指标导出</td><td style=text-align:left>导出 <a href=#pgbouncer><strong>Pgbouncer</strong></a> 连接池指标。</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter><strong><code>pgbackrest_exporter</code></strong></a></td><td>指标导出</td><td style=text-align:left>导出 <a href=#pgbackrest><strong>pgBackrest</strong></a> 备份状态指标。</td></tr><tr><td style=text-align:left><a href=#vip-manager><strong><code>vip-manager</code></strong></a></td><td>VIP管理</td><td style=text-align:left>将 L2 VIP 绑定到当前主库节点，实现透明漂移。【可选】</td></tr></tbody></table><p>其中 <a href=#vip-manager><strong><code>vip-manager</code></strong></a> 为按需启用的组件。此外，PGSQL 还会使用到其他模块中的组件：</p><table class=full-width><thead><tr><th>组件</th><th style=text-align:left>模块</th><th>简介</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td><a href=#haproxy><strong><code>haproxy</code></strong></a></td><td style=text-align:left><a href=/docs/node><strong>NODE</strong></a></td><td>负载均衡</td><td style=text-align:left>对外暴露服务端口，根据角色分发流量至主库或从库。</td></tr><tr><td><a href=#vector><strong><code>vector</code></strong></a></td><td style=text-align:left><a href=/docs/node><strong>NODE</strong></a></td><td>日志采集</td><td style=text-align:left>收集 PostgreSQL、<a href=#patroni>Patroni</a>、<a href=#pgbouncer>Pgbouncer</a> 等日志推送至中心。</td></tr><tr><td><a href=#etcd><strong><code>etcd</code></strong></a></td><td style=text-align:left><a href=/docs/etcd><strong>ETCD</strong></a></td><td>DCS</td><td style=text-align:left>分布式一致性存储，用于保存集群元数据与领导者信息。</td></tr></tbody></table><p>如果用类比来形容，<a href=#postgresql>PostgreSQL</a> 数据库内核就是 CPU，而整个 PGSQL 模块将其封装为一台完整的计算机。
<a href=#patroni>Patroni</a> 与 <a href=#etcd>Etcd</a> 组成 <a href=#%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AD%90%E7%B3%BB%E7%BB%9F>高可用子系统</a>，<a href=#pgbackrest>pgBackRest</a> 与 MinIO 组成 <a href=#%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E5%AD%90%E7%B3%BB%E7%BB%9F>备份恢复子系统</a>。
<a href=#haproxy>HAProxy</a> 与 <a href=#pgbouncer>Pgbouncer</a>、<a href=#vip-manager>vip-manager</a> 组成 <a href=#%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%85%A5%E5%AD%90%E7%B3%BB%E7%BB%9F>接入子系统</a>。
各种 Exporter 与 <a href=#vector>Vector</a> 构成 <a href=#%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E5%AD%90%E7%B3%BB%E7%BB%9F>可观测性子系统</a>；
最后还可以替换不同的 <a href=/docs/pgsql/kernel><strong>内核 CPU</strong></a> 与 <a href=/docs/pgsql/ext><strong>扩展卡</strong></a>。</p><p><img src=/img/pigsty/motherboard.gif alt></p><table class=full-width><thead><tr><th style=text-align:left>子系统</th><th style=text-align:left>组件</th><th style=text-align:left>功能</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E9%AB%98%E5%8F%AF%E7%94%A8%E5%AD%90%E7%B3%BB%E7%BB%9F><strong>高可用子系统</strong></a></td><td style=text-align:left><a href=#patroni>Patroni</a> + <a href=#etcd>etcd</a></td><td style=text-align:left>故障检测、自动切换、配置管理</td></tr><tr><td style=text-align:left><a href=#%E6%9C%8D%E5%8A%A1%E6%8E%A5%E5%85%A5%E5%AD%90%E7%B3%BB%E7%BB%9F><strong>接入子系统</strong></a></td><td style=text-align:left><a href=#haproxy>HAProxy</a> + <a href=#pgbouncer>Pgbouncer</a> + <a href=#vip-manager>vip-manager</a></td><td style=text-align:left>服务暴露、负载均衡、连接池、VIP</td></tr><tr><td style=text-align:left><a href=#%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E5%AD%90%E7%B3%BB%E7%BB%9F><strong>备份恢复子系统</strong></a></td><td style=text-align:left><a href=#pgbackrest>pgBackRest</a>（+ MinIO）</td><td style=text-align:left>全量/增量备份、WAL归档、PITR</td></tr><tr><td style=text-align:left><a href=#%E5%8F%AF%E8%A7%82%E6%B5%8B%E6%80%A7%E5%AD%90%E7%B3%BB%E7%BB%9F><strong>可观测性子系统</strong></a></td><td style=text-align:left><a href=#pg_exporter>pg_exporter</a> / <a href=#pgbouncer_exporter>pgbouncer_exporter</a> / <a href=#pgbackrest_exporter>pgbackrest_exporter</a> + <a href=#vector>Vector</a></td><td style=text-align:left>指标采集、日志收集</td></tr></tbody></table><hr><h2 id=组件交互>组件交互</h2><p><a href=/docs/infra/><img src=/img/pigsty/arch.png alt=pigsty-arch></a></p><ul><li>集群 DNS 由 infra 节点上的 <a href=/docs/concept/arch/infra#dnsmasq><strong>DNSMASQ</strong></a> 负责解析</li><li>集群 VIP 由 <a href=#vip-manager><strong>vip-manager</strong></a> 组件管理，它负责将 <a href=/docs/pgsql/param#pg_vip_address><code>pg_vip_address</code></a> 绑定到集群主库节点上。<ul><li><a href=#vip-manager>vip-manager</a> 从 <a href=#etcd>etcd</a> 集群获取由 <a href=#patroni>patroni</a> 写入的集群领导者信息</li></ul></li><li>集群服务由节点上的 <a href=#haproxy><strong>HAProxy</strong></a> 对外暴露，不同服务通过节点的不同端口（543x）区分。<ul><li>HAProxy 端口 9101：监控指标 & 统计 & 管理页面</li><li>HAProxy 端口 5433：默认路由至主 <a href=#pgbouncer>pgbouncer</a>：<a href=/docs/pgsql/service/#primary%E6%9C%8D%E5%8A%A1>读写服务</a></li><li>HAProxy 端口 5434：默认路由至从库 <a href=#pgbouncer>pgbouncer</a>：<a href=/docs/pgsql/service/#replica%E6%9C%8D%E5%8A%A1>只读服务</a></li><li>HAProxy 端口 5436：默认路由至主 <a href=#postgresql>postgres</a>：<a href=/docs/pgsql/service/#default%E6%9C%8D%E5%8A%A1>默认服务</a></li><li>HAProxy 端口 5438：默认路由至离线 <a href=#postgresql>postgres</a>：<a href=/docs/pgsql/service/#offline%E6%9C%8D%E5%8A%A1>离线服务</a></li><li><a href=#haproxy>HAProxy</a> 将根据 <a href=#patroni>patroni</a> 提供的健康检查信息路由流量。</li></ul></li><li><a href=#pgbouncer><strong>Pgbouncer</strong></a> 是连接池中间件，默认监听 6432 端口，可以缓冲连接、暴露额外的指标，并提供额外的灵活性。<ul><li><a href=#pgbouncer>Pgbouncer</a> 是无状态的，并通过本地 Unix 套接字以 1:1 的方式与 <a href=#postgresql>Postgres</a> 服务器部署。</li><li>生产流量（主/从）将默认通过 <a href=#pgbouncer>pgbouncer</a>（可以通过 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 指定跳过）</li><li>默认/离线服务将始终绕过 <a href=#pgbouncer>pgbouncer</a>，并直接连接到目标 <a href=#postgresql>Postgres</a>。</li></ul></li><li><a href=#postgresql><strong>PostgreSQL</strong></a> 监听 5432 端口，提供关系型数据库服务<ul><li>在多个节点上安装 PGSQL 模块，并使用同一集群名，将自动基于流式复制组成高可用集群</li><li><a href=#postgresql>PostgreSQL</a> 进程默认由 <a href=#patroni>patroni</a> 管理。</li></ul></li><li><a href=#patroni><strong>Patroni</strong></a> 默认监听端口 8008，监管着 <a href=#postgresql>PostgreSQL</a> 服务器进程<ul><li><a href=#patroni>Patroni</a> 将 <a href=#postgresql>Postgres</a> 服务器作为子进程启动</li><li><a href=#patroni>Patroni</a> 使用 <a href=#etcd>etcd</a> 作为 DCS：存储配置、故障检测和领导者选举。</li><li><a href=#patroni>Patroni</a> 通过健康检查提供 Postgres 信息（比如主/从），<a href=#haproxy>HAProxy</a> 通过健康检查使用该信息分发服务流量</li></ul></li><li><a href=#pg_exporter><strong>pg_exporter</strong></a> 在 9630 端口对外暴露 <a href=#postgresql>postgres</a> 监控指标</li><li><a href=#pgbouncer_exporter><strong>pgbouncer_exporter</strong></a> 在端口 9631 暴露 <a href=#pgbouncer>pgbouncer</a> 指标</li><li><a href=#pgbackrest><strong>pgBackRest</strong></a> 默认使用本地备份仓库 （<code>pgbackrest_method</code> = <code>local</code>）<ul><li>如果使用 <code>local</code>（默认）作为备份仓库，<a href=#pgbackrest>pgBackRest</a> 将在主库节点的 <a href=/docs/pgsql/param#pg_fs_backup><code>pg_fs_backup</code></a> 下创建本地仓库</li><li>如果使用 <code>minio</code> 作为备份仓库，<a href=#pgbackrest>pgBackRest</a> 将在专用的 MinIO 集群上创建备份仓库</li></ul></li><li><a href=#vector><strong>Vector</strong></a> 负责收集 Postgres 相关日志（postgres, pgbouncer, patroni, pgbackrest）<ul><li><a href=#vector>vector</a> 监听 9598 端口，也对 infra 节点上的 VictoriaMetrics 暴露自身的监控指标</li><li><a href=#vector>vector</a> 将日志发送至 infra 节点上的 VictoriaLogs</li></ul></li></ul><hr><h2 id=高可用子系统>高可用子系统</h2><p><a href=/docs/concept/ha><strong>高可用</strong></a> 子系统由 <a href=#patroni><strong>Patroni</strong></a> 与 <a href=#etcd><strong>etcd</strong></a> 组成，负责 PostgreSQL 集群的故障检测、自动切换与配置管理。</p><p><strong>工作原理</strong>：<a href=#patroni>Patroni</a> 在每个节点上运行，托管本地 <a href=#postgresql>PostgreSQL</a> 进程，并将集群状态（领导者、成员、配置）写入 <a href=#etcd>etcd</a>。
当主库故障时，<a href=#patroni>Patroni</a> 通过 <a href=#etcd>etcd</a> 协调选举，选出最健康的从库提升为新主库，整个过程自动完成，RTO 通常在 45 秒内。</p><p><strong>关键交互</strong>：</p><ul><li><strong><a href=#postgresql>PostgreSQL</a></strong>：作为父进程启动、停止、重载 PG，控制其生命周期</li><li><strong><a href=#etcd>etcd</a></strong>：外部依赖，写入/监视领导者键，实现分布式共识与故障检测</li><li><strong><a href=#haproxy>HAProxy</a></strong>：通过 REST API（<code>:8008</code>）提供健康检查，告知实例角色</li><li><strong><a href=#vip-manager>vip-manager</a></strong>：监视 <a href=#etcd>etcd</a> 中的领导者键，自动漂移 VIP</li></ul><p>更多信息请参阅：<a href=/docs/concept/ha/><strong>高可用</strong></a> 与 <a href=/docs/pgsql/param/#pg_bootstrap><strong>配置：PGSQL - PG_BOOTSTRAP</strong></a></p><hr><h2 id=服务接入子系统>服务接入子系统</h2><p>接入子系统由 <a href=#haproxy><strong>HAProxy</strong></a>、<a href=#pgbouncer><strong>Pgbouncer</strong></a> 与 <a href=#vip-manager><strong>vip-manager</strong></a> 组成，负责对外暴露服务、路由流量与连接池化。</p><p>有多种不同的接入方法，一种典型的流量路径是：<code>客户端 → DNS/VIP → HAProxy (543x) → Pgbouncer (6432) → PostgreSQL (5432)</code></p><table class=full-width><thead><tr><th style=text-align:left>层级</th><th style=text-align:left>组件</th><th style=text-align:left>端口</th><th style=text-align:left>职责</th></tr></thead><tbody><tr><td style=text-align:left>L2 VIP</td><td style=text-align:left><a href=#vip-manager>vip-manager</a></td><td style=text-align:left>-</td><td style=text-align:left>将 L2 VIP 绑定到主库节点（可选）</td></tr><tr><td style=text-align:left>L4 负载均衡</td><td style=text-align:left><a href=#haproxy>HAProxy</a></td><td style=text-align:left>543x</td><td style=text-align:left>服务暴露、负载均衡、健康检查</td></tr><tr><td style=text-align:left>L7 连接池</td><td style=text-align:left><a href=#pgbouncer>Pgbouncer</a></td><td style=text-align:left>6432</td><td style=text-align:left>连接复用、会话管理、事务池化</td></tr></tbody></table><p><strong>服务端口</strong>：</p><ul><li><code>5433</code> primary：读写服务，路由至主库 <a href=#pgbouncer>Pgbouncer</a></li><li><code>5434</code> replica：只读服务，路由至从库 <a href=#pgbouncer>Pgbouncer</a></li><li><code>5436</code> default：默认服务，直连主库（绕过连接池）</li><li><code>5438</code> offline：离线服务，直连离线从库（ETL/分析）</li></ul><p><strong>关键特性</strong>：</p><ul><li><a href=#haproxy>HAProxy</a> 通过 <a href=#patroni>Patroni</a> REST API 判断实例角色，自动路由流量</li><li><a href=#pgbouncer>Pgbouncer</a> 采用事务级池化，吸收连接峰值，降低 PG 连接开销</li><li><a href=#vip-manager>vip-manager</a> 监视 <a href=#etcd>etcd</a> 领导者键，故障切换时自动漂移 VIP</li></ul><p>更多信息请参阅：<a href=/docs/pgsql/service/><strong>服务接入</strong></a> 与 <a href=/docs/pgsql/param/#pg_access><strong>配置：PGSQL - PG_ACCESS</strong></a></p><hr><h2 id=备份恢复子系统>备份恢复子系统</h2><p>备份恢复子系统由 <a href=#pgbackrest><strong>pgBackRest</strong></a> 组成（可选配 <strong>MinIO</strong> 作为远程仓库），负责数据备份与时间点恢复（<a href=/docs/concept/pitr><strong>PITR</strong></a>）。</p><p><strong>备份类型</strong>：</p><ul><li><strong>全量备份</strong>：完整的数据库副本</li><li><strong>增量/差异备份</strong>：仅备份变更的数据块</li><li><strong>WAL 归档</strong>：持续归档事务日志，支持任意时间点恢复</li></ul><p><strong>存储后端</strong>：</p><ul><li><code>local</code>（默认）：本地磁盘，备份存储在 <a href=/docs/pgsql/param#pg_fs_backup><code>pg_fs_backup</code></a> 挂载点</li><li><code>minio</code>：S3 兼容对象存储，支持集中化备份管理与异地容灾</li></ul><p><strong>关键交互</strong>：</p><ul><li><strong><a href=#pgbackrest>pgBackRest</a> → <a href=#postgresql>PostgreSQL</a></strong>：执行备份命令，管理 WAL 归档</li><li><strong><a href=#pgbackrest>pgBackRest</a> → <a href=#patroni>Patroni</a></strong>：恢复时可将副本引导为新的主库或备库</li><li><strong><a href=#pgbackrest_exporter>pgbackrest_exporter</a> → Prometheus</strong>：导出备份状态指标，监控备份健康</li></ul><p>更多信息请参阅：<a href=/docs/concept/pitr/><strong>PITR</strong></a>、<a href=/docs/pgsql/backup/><strong>备份恢复</strong></a> 与 <a href=/docs/pgsql/param/#pg_backup><strong>配置：PGSQL - PG_BACKUP</strong></a></p><hr><h2 id=可观测性子系统>可观测性子系统</h2><p>可观测性子系统由三个 <strong>Exporter</strong> 与 <a href=#vector><strong>Vector</strong></a> 组成，负责指标采集与日志收集。</p><table><thead><tr><th style=text-align:left>组件</th><th style=text-align:left>端口</th><th style=text-align:left>采集对象</th><th style=text-align:left>关键指标</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_exporter>pg_exporter</a></td><td style=text-align:left><code>9630</code></td><td style=text-align:left><a href=#postgresql>PostgreSQL</a></td><td style=text-align:left>会话、事务、复制延迟、缓冲命中</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter>pgbouncer_exporter</a></td><td style=text-align:left><code>9631</code></td><td style=text-align:left><a href=#pgbouncer>Pgbouncer</a></td><td style=text-align:left>连接池利用率、等待队列、命中率</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter>pgbackrest_exporter</a></td><td style=text-align:left><code>9854</code></td><td style=text-align:left><a href=#pgbackrest>pgBackRest</a></td><td style=text-align:left>最近备份时间、大小、类型</td></tr><tr><td style=text-align:left><a href=#vector>vector</a></td><td style=text-align:left><code>9598</code></td><td style=text-align:left><a href=#postgresql>postgres</a>/<a href=#patroni>patroni</a>/<a href=#pgbouncer>pgbouncer</a> 日志</td><td style=text-align:left>结构化日志流</td></tr></tbody></table><p><strong>数据流向</strong>：</p><ul><li><strong>指标</strong>：Exporter → VictoriaMetrics（INFRA）→ Grafana 仪表盘</li><li><strong>日志</strong>：<a href=#vector>Vector</a> → VictoriaLogs（INFRA）→ Grafana 日志查询</li></ul><p><a href=#pg_exporter>pg_exporter</a> / <a href=#pgbouncer_exporter>pgbouncer_exporter</a> 通过本地 Unix Socket 连接目标服务，与 HA 拓扑解耦。在 <a href=/docs/setup/slim><strong>精简安装</strong></a> 模式下，可禁用这些组件。</p><p>更多信息请参阅：<a href=/docs/pgsql/param/#pg_monitor><strong>配置：PGSQL - PG_MONITOR</strong></a></p><hr><h2 id=postgresql>PostgreSQL</h2><p><a href=https://www.postgresql.org/><strong>PostgreSQL</strong></a> 是 PGSQL 模块的核心，默认监听 <code>5432</code> 端口提供关系型数据库服务，采用与 <a href=/docs/node><strong>节点</strong></a> 1:1 对应的部署模型。</p><p>Pigsty 目前支持 PostgreSQL 14 - 18（生命周期内的大版本），使用 <a href=/docs/repo/pgdg/><strong>PGDG 官方仓库</strong></a> 提供的二进制包安装。
Pigsty 还允许您使用其他的 <a href=/docs/pgsql/kernel><strong>PG 内核分支</strong></a> 替换默认的 PostgreSQL 内核，
并在 PG 内核上加装多达 <a href=/docs/pgsql/ext><strong>444</strong></a> 个扩展插件。</p><p><strong>PostgreSQL</strong> 进程默认由 <a href=/docs/concept/ha><strong>高可用</strong></a> Agent —— <a href=#patroni><strong>Patroni</strong></a> 托管拉起。
当一个集群中只有一个节点时，该实例即为主库；当集群包含多个节点时，其余实例会自动作为从库加入：
通过物理复制，实时从主库同步数据变更。从库可以承载只读请求，并在主库故障时自动接管。</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>您可以直接访问 PostgreSQL，或者通过 <a href=#haproxy>HAProxy</a> 与 <a href=#pgbouncer>Pgbouncer</a> 连接池来访问。</p><p>更多信息请参阅：<a href=/docs/pgsql/param/#pg_bootstrap><strong>配置：PGSQL - PG_BOOTSTRAP</strong></a></p><hr><h2 id=patroni>Patroni</h2><p><a href=https://patroni.readthedocs.io/><strong>Patroni</strong></a> 是 PostgreSQL 高可用控制组件，默认监听 <code>8008</code> 端口。</p><p><strong>Patroni</strong> 接管 <a href=#postgresql><strong>PostgreSQL</strong></a> 的启动、停止、配置与健康状态，将领导者、成员信息写入 <a href=#etcd><strong>etcd</strong></a>。
它负责自动故障转移、保持复制因子、协调参数变更，并提供 REST API 供 <a href=#haproxy><strong>HAProxy</strong></a>、监控与管理员查询。</p><p><a href=#haproxy><strong>HAProxy</strong></a> 通过 <strong>Patroni</strong> 健康检查端点判断实例角色，将流量路由至正确的主库或从库。
<a href=#vip-manager><strong>vip-manager</strong></a> 监视 <a href=#etcd><strong>etcd</strong></a> 中的领导者键，在主库切换时自动漂移 VIP。</p><p><a href=/docs/concept/ha><img src=/img/dashboard/pgsql-patroni.webp alt=patroni></a></p><p>更多信息请参阅：<a href=/docs/pgsql/param/#patroni_mode><strong>配置：PGSQL - PG_BOOTSTRAP</strong></a></p><hr><h2 id=pgbouncer>Pgbouncer</h2><p><a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> 是轻量级连接池中间件，默认监听 <code>6432</code> 端口，与 <a href=#postgresql>PostgreSQL</a> 数据库与节点保持 1:1 部署。</p><p><strong>Pgbouncer</strong> 以无状态方式运行在每个实例上，通过本地 Unix Socket 连接 <a href=#postgresql><strong>PostgreSQL</strong></a>，默认通过 Transaction Pooling 的方式
对 PG 连接进行池化管理，能够吸收大量客户端的瞬时连接请求，稳定数据库会话，降低锁征用，显著提升高并发状态下的性能表现。</p><p>Pigsty 默认让生产流量（读写服务 <code>5433</code> / 只读服务 <code>5434</code>）经由 <strong>Pgbouncer</strong>，
仅默认服务（<code>5436</code>）与离线服务（<code>5438</code>）绕过连接池直连 <a href=#postgresql><strong>PostgreSQL</strong></a>。</p><p>连接池模式由 <a href=/docs/pgsql/param#pgbouncer_poolmode><code>pgbouncer_poolmode</code></a> 控制，默认为 <code>transaction</code>（事务级复用），可通过 <a href=/docs/pgsql/param#pgbouncer_enabled><code>pgbouncer_enabled</code></a> 关闭连接池。</p><p><a href=https://demo.pigsty.cc/ui/d/pgsql-pgbouncer><img src=/img/dashboard/pgsql-pgbouncer.webp alt=pgbouncer.png></a></p><p>更多信息请参阅：<a href=/docs/pgsql/param/#pg_access><strong>配置：PGSQL - PG_ACCESS</strong></a></p><hr><h2 id=pgbackrest>pgBackRest</h2><p><a href=https://pgbackrest.org/><strong>pgBackRest</strong></a> 是专业的 PostgreSQL 备份恢复工具，也是 PG 生态的最强备份工具之一，支持全量/增量/差异备份与 WAL 归档。</p><p>Pigsty 使用 pgBackRest 实现 PostgreSQL 的 <a href=/docs/concept/pitr><strong>PITR</strong></a> 能力，
您可以在备份保留的时间窗口内，将集群回滚到任意时间点。</p><p><strong>pgBackRest</strong> 与 <a href=#postgresql><strong>PostgreSQL</strong></a> 配合，在主库上创建备份仓库，执行备份与归档任务。
默认使用本地备份仓库（<a href=/docs/pgsql/param#pgbackrest_method><strong><code>pgbackrest_method</code></strong></a> = <code>local</code>），也可配置为 MinIO 等对象存储，实现集中化备份管理。</p><p>初始化完成后可通过 <a href=/docs/pgsql/param#pgbackrest_init_backup><strong><code>pgbackrest_init_backup</code></strong></a> 自动发起首次全量备份。
恢复过程与 <a href=#patroni><strong>Patroni</strong></a> 集成，支持将副本引导为新的主库或备库。</p><p><a href=/docs/concept/pitr><img src=/img/dashboard/pgsql-pitr.webp alt=pgbackrest></a></p><p>更多信息请参阅：<a href=/docs/pgsql/backup/><strong>备份恢复</strong></a> 与 <a href=/docs/pgsql/param/#pg_backup><strong>配置：PGSQL - PG_BACKUP</strong></a></p><hr><h2 id=haproxy>HAProxy</h2><p><a href=http://www.haproxy.org/><strong>HAProxy</strong></a> 是服务入口与负载均衡器，对外暴露多个数据库服务端口。</p><table><thead><tr><th style=text-align:left>端口</th><th style=text-align:left>服务名</th><th style=text-align:left>目标</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>9101</code></td><td style=text-align:left>管理接口</td><td style=text-align:left>-</td><td style=text-align:left>HAProxy 统计与管理页面</td></tr><tr><td style=text-align:left><code>5433</code></td><td style=text-align:left>primary</td><td style=text-align:left>主库 <a href=#pgbouncer>Pgbouncer</a></td><td style=text-align:left>读写服务，路由至主库连接池</td></tr><tr><td style=text-align:left><code>5434</code></td><td style=text-align:left>replica</td><td style=text-align:left>从库 <a href=#pgbouncer>Pgbouncer</a></td><td style=text-align:left>只读服务，路由至从库连接池</td></tr><tr><td style=text-align:left><code>5436</code></td><td style=text-align:left>default</td><td style=text-align:left>主库 <a href=#postgresql>Postgres</a></td><td style=text-align:left>默认服务，直连主库（绕过连接池）</td></tr><tr><td style=text-align:left><code>5438</code></td><td style=text-align:left>offline</td><td style=text-align:left>离线库 <a href=#postgresql>Postgres</a></td><td style=text-align:left>离线服务，直连离线从库（ETL/分析）</td></tr></tbody></table><p><strong>HAProxy</strong> 通过 <a href=#patroni><strong>Patroni</strong></a> REST API 提供的健康检查信息判断实例角色，将流量路由至对应的主库或从库。
服务定义由 <a href=/docs/pgsql/param#pg_default_services><strong><code>pg_default_services</code></strong></a> 与 <a href=/docs/pgsql/param#pg_services><strong><code>pg_services</code></strong></a> 组合而成。</p><p>可通过 <a href=/docs/pgsql/param#pg_service_provider><strong><code>pg_service_provider</code></strong></a> 指定专用的 HAProxy 节点组承载更高流量，
默认使用本地节点上的 <strong>HAProxy</strong> 对外发布服务。</p><p><a href=/docs/concept/ha/svc><img src=/img/dashboard/node-haproxy.webp alt=haproxy></a></p><p>更多信息请参阅：<a href=/docs/pgsql/service/><strong>服务接入</strong></a> 与 <a href=/docs/pgsql/param/#pg_access><strong>配置：PGSQL - PG_ACCESS</strong></a></p><hr><h2 id=vip-manager>vip-manager</h2><p><a href=https://github.com/cybertec-postgresql/vip-manager><strong>vip-manager</strong></a> 负责将 L2 VIP 绑定到当前主库节点，这是一个可选的组件，如果您的网络支持 L2 VIP，可以考虑启用。</p><p><strong>vip-manager</strong> 在每个 PG 节点上运行，监视 <a href=#etcd><strong>etcd</strong></a> 中由 <a href=#patroni><strong>Patroni</strong></a> 写入的领导者键，
将 <a href=/docs/pgsql/param#pg_vip_address><strong><code>pg_vip_address</code></strong></a> 绑定到当前主库节点的网卡上。
当集群发生故障转移时，<strong>vip-manager</strong> 会立即释放旧主机上的 VIP，并在新主机上重新绑定，从而将流量切换到新的主库。</p><p>该组件可选，通过 <a href=/docs/pgsql/param#pg_vip_enabled><strong><code>pg_vip_enabled</code></strong></a> 启用。
启用后需确保所有节点处于同一 VLAN，否则 VIP 无法正确漂移。
通常公有云网络环境不支持 L2 VIP，建议仅在本地自建环境与私有云环境中启用。</p><p><a href=/docs/concept/ha/svc><img src=/img/dashboard/node-vip.webp alt=node-vip></a></p><p>更多信息请参阅：<a href=/docs/pgsql/tutorial/pg-vip/><strong>教程：VIP 配置</strong></a> 与 <a href=/docs/pgsql/param/#pg_access><strong>配置：PGSQL - PG_ACCESS</strong></a></p><hr><h2 id=pg_exporter>pg_exporter</h2><p><a href=https://github.com/Vonng/pg_exporter><strong>pg_exporter</strong></a> 导出 <a href=#postgresql>PostgreSQL</a> 监控指标，默认监听 <code>9630</code> 端口。</p><p><strong>pg_exporter</strong> 运行在每个 PG 节点上，通过本地 Unix Socket 连接 <a href=#postgresql><strong>PostgreSQL</strong></a>，
导出覆盖会话、缓冲命中、复制延迟、事务率等丰富指标，供 INFRA 节点上的 <strong>VictoriaMetrics</strong> 抓取。</p><p>采集配置由 <a href=/docs/pgsql/param#pg_exporter_config><strong><code>pg_exporter_config</code></strong></a> 指定，
支持自动数据库发现（<a href=/docs/pgsql/param#pg_exporter_auto_discovery><strong><code>pg_exporter_auto_discovery</code></strong></a>），
并可通过 <a href=/docs/pgsql/param#pg_exporter_cache_ttls><strong><code>pg_exporter_cache_ttls</code></strong></a> 配置阶梯式缓存策略。</p><p>您可以通过参数禁用这个组件，在 <a href=/docs/setup/slim><strong>精简安装</strong></a> 中，这个组件不会被启用。</p><p><a href=https://demo.pigsty.cc/ui/d/pgsql-exporter><img src=/img/dashboard/pgsql-exporter.webp alt=pg-exporter></a></p><p>更多信息请参阅：<a href=/docs/pgsql/param/#pg_monitor><strong>配置：PGSQL - PG_MONITOR</strong></a></p><hr><h2 id=pgbouncer_exporter>pgbouncer_exporter</h2><p><strong>pgbouncer_exporter</strong> 导出 <a href=#pgbouncer>Pgbouncer</a> 连接池指标，默认监听 <code>9631</code> 端口。</p><p><code>pgbouncer_exporter</code> 使用的同样是 <a href=#pg_exporter><strong>pg_exporter</strong></a> 的二进制程序，但是使用专用的指标配置文件，支持 pgbouncer 1.8 - 1.25+ 。
<strong>pgbouncer_exporter</strong> 读取 <a href=#pgbouncer><strong>Pgbouncer</strong></a> 的统计视图，提供连接池利用率、等待队列与命中率指标。</p><p>若禁用 <a href=#pgbouncer><strong>Pgbouncer</strong></a>，本组件也同时关闭。在 <a href=/docs/setup/slim><strong>精简安装</strong></a> 中，这个组件也不会被启用。</p><p>更多信息请参阅：<a href=/docs/pgsql/param/#pg_monitor><strong>配置：PGSQL - PG_MONITOR</strong></a></p><hr><h2 id=pgbackrest_exporter>pgbackrest_exporter</h2><p><strong>pgbackrest_exporter</strong> 导出备份状态指标，默认监听 <code>9854</code> 端口。</p><p><strong>pgbackrest_exporter</strong> 解析 <a href=#pgbackrest><strong>pgBackRest</strong></a> 状态，生成最近备份时间、大小、类型等指标。结合告警策略可快速发现备份过期或失败，保障数据安全。
请注意，当备份很多，或者使用大型网络存储库时，采集过程开销较大，因此 <strong>pgbackrest_exporter</strong> 默认设置了 2分钟的采集间隔。
最慢情况下，您可能要在一个备份完成后的 2 分钟后，才能在监控系统中看到最新的备份状态。</p><p>更多信息请参阅：<a href=/docs/pgsql/param/#pg_monitor><strong>配置：PGSQL - PG_MONITOR</strong></a></p><hr><h2 id=etcd>etcd</h2><p><a href=/docs/etcd><strong>etcd</strong></a> 是分布式一致性存储（DCS），为 <a href=#patroni><strong>Patroni</strong></a> 提供集群元数据存储与领导者选举能力。</p><p>etcd 由独立的 <a href=/docs/etcd><strong>ETCD 模块</strong></a> 部署管理，不属于 PGSQL 模块本身，但对 PostgreSQL 高可用至关重要。
<a href=#patroni>Patroni</a> 将集群状态、领导者信息、配置参数写入 etcd，所有节点通过 etcd 达成共识。
<a href=#vip-manager>vip-manager</a> 也从 etcd 读取领导者键，实现 VIP 的自动漂移。</p><p>更多信息请参阅：<a href=/docs/etcd/><strong>ETCD 模块</strong></a></p><hr><h2 id=vector>vector</h2><p><a href=https://vector.dev/><strong>Vector</strong></a> 是高性能日志采集组件，由 <a href=/docs/node><strong>NODE 模块</strong></a> 部署，负责收集 PostgreSQL 相关日志。</p><p>Vector 常驻在节点上，跟踪 <a href=#postgresql>PostgreSQL</a>、<a href=#pgbouncer>Pgbouncer</a>、<a href=#patroni>Patroni</a> 与 <a href=#pgbackrest>pgBackRest</a> 的日志目录，
将结构化日志发送至 INFRA 节点上的 VictoriaLogs 进行集中存储与查询。</p><p>更多信息请参阅：<a href=/docs/node/><strong>NODE 模块</strong></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-d1b03f22fc5f90cf6ddcf42073d7603d>2 - 集群模型图</h1><div class=lead>Pigsty 是如何将不同种类的功能抽象成为模块的，以及这些模块的逻辑模型，实体关系图。</div><p>在 Pigsty 中最大的实体概念叫做 <strong>部署（Deployment）</strong>，一套部署中的主要实体与关系（E-R 图）如下所示：</p><p><img src=/img/pigsty/er-full.svg alt></p><p>一套部署也可以理解为一个 <strong>环境（Environment）</strong>。例如，生产环境（Prod），用户测试环境（UTA），预发环境（Staging），测试环境（Testing），开发环境（Devbox），等等。
每个环境中，都对应着一份 Pigsty <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a>，描述了环境中的所有实体与属性。</p><p>通常来说，一套环境中也会带有一套共用的基础设施（<a href=/docs/infra><strong><code>INFRA</code></strong></a>），广义的基础设施还包括 <a href=/docs/etcd><strong><code>ETCD</code></strong></a>（高可用 DCS）以及 <a href=/docs/minio><strong><code>MINIO</code></strong></a>（集中式备份仓库），
同时供环境中的多套 PostgreSQL 数据库集群（以及其他数据库模块组件）使用。（例外：也有 <a href=/docs/setup/slim><strong>不带基础设施的部署</strong></a>）</p><p>在 Pigsty 中，几乎所有数据库模块都是以 &ldquo;<strong>集群</strong>"（Cluster）的方式组织起来的。每一个集群都是一个 Ansible 分组，包含有若干节点资源。
例如 PostgreSQL 高可用数据库集群，Redis，Etcd / MinIO 这些数据库都是以集群的形式存在。一套环境中可以包含多个集群。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-97ed05d79e93eabb25565a36bc328883>2.1 - PGSQL 集群模型</h1><div class=lead>介绍 Pigsty 中 PostgreSQL 集群的实体-关系模型，E-R 关系图，实体释义与命名规范。</div><p>PGSQL模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组由<strong>主-备</strong>关联的数据库<strong>实例</strong>组成的<strong>逻辑实体</strong>。</p><p>每个集群都是一个<strong>自治</strong>的业务单元，由至少一个 <strong>主库实例</strong> 组成，并通过服务向外暴露能力。</p><p>在 Pigsty 的PGSQL模块中有四种核心实体：</p><ul><li><strong>集群</strong>（Cluster）：自治的 PostgreSQL 业务单元，用作其他实体的顶级命名空间。</li><li><strong>服务</strong>（Service）：对外暴露能力的命名抽象，路由流量，并使用节点端口暴露服务。</li><li><strong>实例</strong>（Instance）：由在单个节点上的运行进程和数据库文件组成的单一 PostgreSQL 服务器。</li><li><strong>节点</strong>（Node）：运行 Linux + Systemd 环境的硬件资源抽象，可以是裸机、VM、容器或 Pod。</li></ul><p>辅以“数据库”“角色”两个业务实体，共同组成完整的逻辑视图。如下图所示：</p><p><img src=/img/pigsty/er-pgsql.svg alt=er-pgsql></p><hr><h2 id=具体样例>具体样例</h2><p>让我们来看两个具体的例子，以四节点的 Pigsty <a href=/docs/deploy/sandbox><strong>沙箱环境</strong></a> 为例，在这个环境中，有一套三节点的 <code>pg-test</code> 集群。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上面的配置片段定义了一个如下所示的 <a href=/docs/concept/ha/><strong>高可用</strong></a> PostgreSQL 集群，该集群中的相关实体包括：</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>pg-test</code></strong></td><td>PostgreSQL 3 节点高可用集群</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>pg-test-1</code></strong></td><td>1 号 PostgreSQL 实例，默认为主库</td></tr><tr><td style=text-align:center><strong><code>pg-test-2</code></strong></td><td>2 号 PostgreSQL 实例，初始为从库</td></tr><tr><td style=text-align:center><strong><code>pg-test-3</code></strong></td><td>3 号 PostgreSQL 实例，初始为从库</td></tr><tr><td style=text-align:center><span class=text-info><strong>服务</strong></span></td><td><span class=text-info><strong>Service</strong></span></td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#primary%E6%9C%8D%E5%8A%A1><strong><code>pg-test-primary</code></strong></a></td><td>读写服务（路由到主库 pgbouncer）</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#replica%E6%9C%8D%E5%8A%A1><strong><code>pg-test-replica</code></strong></a></td><td>只读服务（路由到从库 pgbouncer）</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#default%E6%9C%8D%E5%8A%A1><strong><code>pg-test-default</code></strong></a></td><td>直连读写服务（路由到主库 postgres）</td></tr><tr><td style=text-align:center><a href=/docs/pgsql/service/#offline%E6%9C%8D%E5%8A%A1><strong><code>pg-test-offline</code></strong></a></td><td>离线读取服务（路由到专用 postgres）</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>node-1</code></strong></td><td><code>10.10.10.11</code> 1 号节点，对应 <code>pg-test-1</code> PG 实例</td></tr><tr><td style=text-align:center><strong><code>node-2</code></strong></td><td><code>10.10.10.12</code> 2 号节点，对应 <code>pg-test-2</code> PG 实例</td></tr><tr><td style=text-align:center><strong><code>node-3</code></strong></td><td><code>10.10.10.13</code> 3 号节点，对应 <code>pg-test-3</code> PG 实例</td></tr></tbody></table><p><img src=/img/pigsty/ha.png alt=ha></p><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/pgsql/param#pg_id><strong><code>PG_ID</code></strong></a> 参数组为 PGSQL 模块的每个实体赋予确定的身份。以下三项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_cluster><strong><code>pg_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>集群</td><td style=text-align:left>PG 集群名称，必选身份参数</td><td>有效的 DNS 名称，满足正则表达式 <code>[a-zA-Z0-9-]+</code></td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_seq><strong><code>pg_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>实例</td><td style=text-align:left>PG 实例编号，必选身份参数</td><td>自然数，可从 0 或 1 开始分配，集群内不重复</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_role><strong><code>pg_role</code></strong></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center>实例</td><td style=text-align:left>PG 实例角色，必选身份参数</td><td>枚举值，可为 <code>primary</code>，<code>replica</code>，<code>offline</code></td></tr></tbody></table><p>只要在集群层面定义了集群名称，实例层面分配了实例编号与角色，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th>生成规则</th><th>示例</th></tr></thead><tbody><tr><td><strong>实例</strong></td><td><code>{{ pg_cluster }}-{{ pg_seq }}</code></td><td><code>pg-test-1</code>，<code>pg-test-2</code>，<code>pg-test-3</code></td></tr><tr><td><strong>服务</strong></td><td><code>{{ pg_cluster }}-{{ pg_role }}</code></td><td><code>pg-test-primary</code>，<code>pg-test-replica</code>，<code>pg-test-offline</code></td></tr><tr><td><strong>节点</strong></td><td>显示指定覆盖，或自动从 PG 实例借用</td><td><code>pg-test-1</code>，<code>pg-test-2</code>，<code>pg-test-3</code></td></tr></tbody></table><p>因为 Pigsty 采用节点与 PG 实例 1:1 的独占部署模型，因此默认情况下，主机节点的标识符会直接借用 PG 实例的标识符（<a href=/docs/node/param#node_id_from_pg><strong><code>node_id_from_pg</code></strong></a> ）。
当然您也可以显式指定 <a href=/docs/node/param#nodename><strong><code>nodename</code></strong></a> 进行覆盖，或者关闭 <a href=/docs/node/param#nodename_overwrite><strong><code>nodename_overwrite</code></strong></a>，直接使用当前默认值。</p><hr><h2 id=分片身份参数>分片身份参数</h2><p>当你使用多套 PostgreSQL （<strong>分片</strong> / Sharding）集群服务同一业务时，还会使用到另外两个身份参数：<a href=/docs/pgsql/param#pg_shard><strong><code>pg_shard</code></strong></a> 与 <a href=/docs/pgsql/param#pg_group><strong><code>pg_group</code></strong></a>。</p><p>在这种情况下，这一组 PostgreSQL 集群将拥有相同的 <code>pg_shard</code> 名称，以及各自的 <code>pg_group</code> 编号，例如下面的 <a href=/docs/pgsql/config/cluster#citus%E9%9B%86%E7%BE%A4><strong>Citus 集群</strong></a>：</p><p>在这种情况下，<code>pg_cluster</code> 集群名通常由：<code>{{ pg_shard }}{{ pg_group }}</code> 组合而成，例如 <code>pg-citus0</code>、<code>pg-citus1</code> 等。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 0号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 1号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 2号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 3号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 专门为水平分片集群提供专门的监控面板，便于对比各分片的性能与负载情况，但这需要您使用上述实体命名规则。</p><p>还有一些其他的身份参数，可能在特殊场景会使用到，例如，指定备份集群/级联复制上游的 <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a>，指定 Greenplum 集群身份的 <a href=/docs/pgsql/param#gp_role><code>gp_role</code></a> ，
指定外部监控实例的 <a href=/docs/pgsql/param#pg_exporters><code>pg_exporters</code></a> ，指定实例为离线查询库的 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> 等，请参考 <a href=/docs/pgsql/param#pg_id><strong><code>PG_ID</code> 参数文档</strong></a>。</p><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 提供了一套开箱即用的监控系统，在这个系统中使用上面的 <a href=#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 来标识各个 PostgreSQL 实体对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-1&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;pgsql&#34;}
</span></span><span style=display:flex><span>pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-2&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;pgsql&#34;}
</span></span><span style=display:flex><span>pg_up{cls=&#34;pg-test&#34;, ins=&#34;pg-test-3&#34;, ip=&#34;10.10.10.13&#34;, job=&#34;pgsql&#34;}
</span></span></code></pre></div><p>例如，上面的 <code>cls</code>，<code>ins</code>，<code>ip</code> 三个标签，分别对应集群名、实例名与节点 IP，这三个核心实体的标识符。
它们与 <code>job</code> 标签，在 <strong>所有</strong> <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a> 采集的原生监控指标，以及 <a href=/docs/concept/arch/infra#victorialogs><strong>VictoriaLogs</strong></a> 日志流中都会出现并可用。</p><p>采集 PostgreSQL 指标的 <code>job</code> 名固定为 <code>pgsql</code>；
用于监控远程 PG 实例的 <code>job</code> 名固定为 <code>pgrds</code>。
采集 PostgreSQL CSV 日志的 <code>job</code> 名固定为 <code>postgres</code>；
采集 pgbackrest 日志的 <code>job</code> 名固定为 <code>pgbackrest</code>，其余 PG 组件通过 <code>job: syslog</code> 采集日志。</p><p>此外，还有一些普通实体身份标签，会在实体相关的特定监控指标中出现，例如：</p><ul><li><code>datname</code>： 数据库名，如果一个监控指标属于某个具体的数据库，则会带上这个标签。</li><li><code>relname</code>： 表名，如果一个监控指标属于某个具体的表，则会带上这个标签。</li><li><code>idxname</code>： 索引名，如果一个监控指标属于某个具体的索引，则会带上这个标签。</li><li><code>funcname</code>： 函数名，如果一个监控指标属于某个具体的函数，则会带上这个标签。</li><li><code>seqname</code>： 序列名，如果一个监控指标属于某个具体的序列，则会带上这个标签。</li><li><code>query</code>： 查询指纹，如果一个监控指标属于某个具体的查询，则会带上这个标签。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-5a875c30b5ea163b13415e0cf143a46f>2.2 - ETCD 集群模型</h1><div class=lead>介绍 Pigsty 中 ETCD 集群的实体-关系模型，E-R 关系图，实体释义与命名规范。</div><p>ETCD 模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组通过 <strong>Raft</strong> 共识协议关联的 ETCD <strong>实例</strong>组成的<strong>逻辑实体</strong>。</p><p>每个集群都是一个<strong>自治</strong>的分布式键值存储单元，由至少一个 <strong>ETCD 实例</strong> 组成，通过客户端端口向外暴露服务能力。</p><p>在 Pigsty 的 ETCD 模块中有三种核心实体：</p><ul><li><strong>集群</strong>（Cluster）：自治的 ETCD 服务单元，用作其他实体的顶级命名空间。</li><li><strong>实例</strong>（Instance）：单个 ETCD 服务器进程，在节点上运行，参与 Raft 共识。</li><li><strong>节点</strong>（Node）：运行 Linux + Systemd 环境的硬件资源抽象，隐含式声明。</li></ul><p>相比于 PostgreSQL 集群，ETCD 集群模型更为简单，没有服务（Service）和复杂的角色（Role）区分。
所有 ETCD 实例在功能上是对等的，通过 Raft 协议选举出 Leader，其余为 Follower。
在扩容的中间状态，还允许不参与投票的 Learner 实例成员存在。</p><hr><h2 id=具体样例>具体样例</h2><p>让我们来看一个具体的例子，以三节点的 ETCD 集群为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上面的配置片段定义了一个如下所示的三节点 ETCD 集群，该集群中的相关实体包括：</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>etcd</code></strong></td><td>ETCD 三节点高可用集群</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>etcd-1</code></strong></td><td>1 号 ETCD 实例</td></tr><tr><td style=text-align:center><strong><code>etcd-2</code></strong></td><td>2 号 ETCD 实例</td></tr><tr><td style=text-align:center><strong><code>etcd-3</code></strong></td><td>3 号 ETCD 实例</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>10.10.10.10</code></strong></td><td>1 号节点，对应 <code>etcd-1</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.11</code></strong></td><td>2 号节点，对应 <code>etcd-2</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.12</code></strong></td><td>3 号节点，对应 <code>etcd-3</code> 实例</td></tr></tbody></table><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/etcd/param#etcd><strong><code>ETCD</code></strong></a> 参数组为 ETCD 模块的每个实体赋予确定的身份。以下两项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th style=text-align:left>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/etcd/param#etcd_cluster><strong><code>etcd_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>集群</td><td style=text-align:left>ETCD 集群名称，必选身份参数</td><td style=text-align:left>有效的 DNS 名称，默认为固定值 <code>etcd</code></td></tr><tr><td style=text-align:left><a href=/docs/etcd/param#etcd_seq><strong><code>etcd_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>实例</td><td style=text-align:left>ETCD 实例编号，必选身份参数</td><td style=text-align:left>自然数，从 1 开始分配，集群内不重复</td></tr></tbody></table><p>只要在集群层面定义了集群名称，实例层面分配了实例编号，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th style=text-align:left>生成规则</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td><strong>实例</strong></td><td style=text-align:left><code>{{ etcd_cluster }}-{{ etcd_seq }}</code></td><td style=text-align:left><code>etcd-1</code>，<code>etcd-2</code>，<code>etcd-3</code></td></tr></tbody></table><p>ETCD 模块不会为主机节点赋予额外的身份标识，节点使用其原有的主机名或 IP 地址进行标识。</p><hr><h2 id=端口协议>端口协议</h2><p>每个 ETCD 实例会监听以下两个端口：</p><table class=full-width><thead><tr><th style=text-align:left>端口</th><th style=text-align:left>参数</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><strong>2379</strong></td><td style=text-align:left><a href=/docs/etcd/param#etcd_port><strong><code>etcd_port</code></strong></a></td><td style=text-align:left>客户端端口，供 Patroni、vip-manager 等客户端访问</td></tr><tr><td style=text-align:left><strong>2380</strong></td><td style=text-align:left><a href=/docs/etcd/param#etcd_peer_port><strong><code>etcd_peer_port</code></strong></a></td><td style=text-align:left>节点间通信端口，用于 Raft 共识协议</td></tr></tbody></table><p>ETCD 集群默认启用 TLS 加密通信，并使用 RBAC 认证机制。客户端需要使用正确的证书和密码才能访问 ETCD 服务。</p><hr><h2 id=集群规模>集群规模</h2><p>ETCD 作为分布式协调服务，集群规模直接影响其可用性，需要有超过半数（仲裁数）的节点存活才能维持服务。</p><table class=full-width><thead><tr><th style=text-align:center>集群规模</th><th style=text-align:center>仲裁数</th><th style=text-align:center>容忍故障数</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:center>1 节点</td><td style=text-align:center>1</td><td style=text-align:center>0</td><td style=text-align:left>开发、测试、演示</td></tr><tr><td style=text-align:center>3 节点</td><td style=text-align:center>2</td><td style=text-align:center>1</td><td style=text-align:left>中小规模生产环境</td></tr><tr><td style=text-align:center>5 节点</td><td style=text-align:center>3</td><td style=text-align:center>2</td><td style=text-align:left>大规模生产环境</td></tr></tbody></table><p>因此，偶数节点的 ETCD 集群没有意义，超过五节点的 ETCD 集群并不常见，因此通常使用的规格就是单节点、三节点、五节点。</p><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 提供了一套开箱即用的监控系统，在这个系统中使用上面的 <a href=#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 来标识各个 ETCD 实体对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>etcd_up{cls=&#34;etcd&#34;, ins=&#34;etcd-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;etcd&#34;}
</span></span><span style=display:flex><span>etcd_up{cls=&#34;etcd&#34;, ins=&#34;etcd-2&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;etcd&#34;}
</span></span><span style=display:flex><span>etcd_up{cls=&#34;etcd&#34;, ins=&#34;etcd-3&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;etcd&#34;}
</span></span></code></pre></div><p>例如，上面的 <code>cls</code>，<code>ins</code>，<code>ip</code> 三个标签，分别对应集群名、实例名与节点 IP，这三个核心实体的标识符。
它们与 <code>job</code> 标签，在 <strong>所有</strong> <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a> 采集的 ETCD 监控指标中都会出现并可用。
采集 ETCD 指标的 <code>job</code> 名固定为 <code>etcd</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c495cfba1010bd7cf73164bea4ebc4f3>2.3 - MINIO 集群模型</h1><div class=lead>介绍 Pigsty 中 MinIO 集群的实体-关系模型，E-R 关系图，实体释义与命名规范。</div><p>MinIO 模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组分布式 MinIO <strong>实例</strong>组成的<strong>逻辑实体</strong>，共同提供高可用的对象存储服务。</p><p>每个集群都是一个<strong>自治</strong>的 S3 兼容对象存储单元，由至少一个 <strong>MinIO 实例</strong> 组成，通过 S3 API 端口向外暴露服务能力。</p><p>在 Pigsty 的 MinIO 模块中有三种核心实体：</p><ul><li><strong>集群</strong>（Cluster）：自治的 MinIO 服务单元，用作其他实体的顶级命名空间。</li><li><strong>实例</strong>（Instance）：单个 MinIO 服务器进程，在节点上运行，管理本地磁盘存储。</li><li><strong>节点</strong>（Node）：运行 Linux + Systemd 环境的硬件资源抽象，隐含式声明。</li></ul><p>此外，MinIO 还有 <a href=/docs/minio/config#%E5%A4%9A%E6%B1%A0%E9%83%A8%E7%BD%B2><strong>存储池</strong></a>（Pool）的概念，用于集群平滑扩容。
一个集群可以包含多个存储池，每个存储池由一组节点和磁盘组成。</p><hr><h2 id=部署模式>部署模式</h2><p>MinIO 支持三种主要部署模式，适用于不同的场景：</p><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center>代号</th><th style=text-align:left>说明</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:center><a href=/docs/minio/config#%E5%8D%95%E6%9C%BA%E5%8D%95%E7%9B%98><strong>单机单盘</strong></a></td><td style=text-align:center><strong>SNSD</strong></td><td style=text-align:left>单节点，单个数据目录，或单块磁盘</td><td style=text-align:left>开发、测试、演示</td></tr><tr><td style=text-align:center><a href=/docs/minio/config#%E5%8D%95%E6%9C%BA%E5%A4%9A%E7%9B%98><strong>单机多盘</strong></a></td><td style=text-align:center><strong>SNMD</strong></td><td style=text-align:left>单节点，使用多块磁盘，通常至少 4 块盘</td><td style=text-align:left>资源受限的小规模部署</td></tr><tr><td style=text-align:center><a href=/docs/minio/config#%E5%A4%9A%E6%9C%BA%E5%A4%9A%E7%9B%98><strong>多机多盘</strong></a></td><td style=text-align:center><strong>MNMD</strong></td><td style=text-align:left>多节点，每节点多块磁盘</td><td style=text-align:left><strong>生产环境推荐</strong></td></tr></tbody></table><p>单机单盘模式可以使用任意目录作为存储，适合快速体验；单机多盘和多机多盘模式需要使用真实的磁盘挂载点，否则会拒绝启动。</p><hr><h2 id=具体样例>具体样例</h2><p>让我们来看一个多机多盘模式的具体例子，以四节点的 MinIO 集群为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data{1...4}&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${minio_cluster}-${minio_seq}.pigsty&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上面的配置片段定义了一个四节点的 MinIO 集群，每个节点使用四块磁盘，该集群中的相关实体包括：</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>minio</code></strong></td><td>MinIO 四节点高可用集群</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>minio-1</code></strong></td><td>1 号 MinIO 实例，管理 4 块磁盘</td></tr><tr><td style=text-align:center><strong><code>minio-2</code></strong></td><td>2 号 MinIO 实例，管理 4 块磁盘</td></tr><tr><td style=text-align:center><strong><code>minio-3</code></strong></td><td>3 号 MinIO 实例，管理 4 块磁盘</td></tr><tr><td style=text-align:center><strong><code>minio-4</code></strong></td><td>4 号 MinIO 实例，管理 4 块磁盘</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>10.10.10.10</code></strong></td><td>1 号节点，对应 <code>minio-1</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.11</code></strong></td><td>2 号节点，对应 <code>minio-2</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.12</code></strong></td><td>3 号节点，对应 <code>minio-3</code> 实例</td></tr><tr><td style=text-align:center><strong><code>10.10.10.13</code></strong></td><td>4 号节点，对应 <code>minio-4</code> 实例</td></tr></tbody></table><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/minio/param#minio><strong><code>MINIO</code></strong></a> 参数组为 MinIO 模块的每个实体赋予确定的身份。以下两项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th style=text-align:left>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/minio/param#minio_cluster><strong><code>minio_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>集群</td><td style=text-align:left>MinIO 集群名称，必选身份参数</td><td style=text-align:left>有效的 DNS 名称，默认为 <code>minio</code></td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio_seq><strong><code>minio_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>实例</td><td style=text-align:left>MinIO 实例编号，必选身份参数</td><td style=text-align:left>自然数，从 1 开始分配，集群内不重复</td></tr></tbody></table><p>只要在集群层面定义了集群名称，实例层面分配了实例编号，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th style=text-align:left>生成规则</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td><strong>实例</strong></td><td style=text-align:left><code>{{ minio_cluster }}-{{ minio_seq }}</code></td><td style=text-align:left><code>minio-1</code>，<code>minio-2</code>，<code>minio-3</code>，<code>minio-4</code></td></tr></tbody></table><p>MinIO 模块不会为主机节点赋予额外的身份标识，节点使用其原有的主机名或 IP 地址进行标识。
<a href=/docs/minio/param#minio_node><strong><code>minio_node</code></strong></a> 参数用于生成 MinIO 集群内部的节点名称（写入 <code>/etc/hosts</code> 供集群发现使用），而非主机节点的身份。</p><hr><h2 id=核心配置参数>核心配置参数</h2><p>除身份参数外，以下参数对 MinIO 集群配置至关重要：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/minio/param#minio_data><strong><code>minio_data</code></strong></a></td><td style=text-align:center><code>path</code></td><td style=text-align:left>数据目录，使用 <code>{x...y}</code> 指定多盘</td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio_node><strong><code>minio_node</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:left>节点名模式，用于多节点部署</td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio_domain><strong><code>minio_domain</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:left>服务域名，默认为 <code>sss.pigsty</code></td></tr></tbody></table><p>这些参数共同决定了 MinIO 的核心配置 <code>MINIO_VOLUMES</code>：</p><ul><li><strong>单机单盘</strong>：直接使用 <code>minio_data</code> 的值，如 <code>/data/minio</code></li><li><strong>单机多盘</strong>：使用 <code>minio_data</code> 展开的多个目录，如 <code>/data{1...4}</code></li><li><strong>多机多盘</strong>：组合 <code>minio_node</code> 与 <code>minio_data</code>，如 <code>https://minio-{1...4}.pigsty:9000/data{1...4}</code></li></ul><hr><h2 id=端口与服务>端口与服务</h2><p>每个 MinIO 实例会监听以下端口：</p><table class=full-width><thead><tr><th style=text-align:left>端口</th><th style=text-align:left>参数</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left>9000</td><td style=text-align:left><a href=/docs/minio/param#minio_port><strong><code>minio_port</code></strong></a></td><td style=text-align:left>S3 API 服务端口</td></tr><tr><td style=text-align:left>9001</td><td style=text-align:left><a href=/docs/minio/param#minio_admin_port><strong><code>minio_admin_port</code></strong></a></td><td style=text-align:left>Web 管理控制台端口</td></tr></tbody></table><p>MinIO 默认启用 HTTPS 加密通信（由 <a href=/docs/minio/param#minio_https><strong><code>minio_https</code></strong></a> 控制）。这对于 pgBackREST 等备份工具访问 MinIO 是必需的。</p><p>多节点 MinIO 集群可以通过访问 <strong>任意一个节点</strong> 来访问其服务。最佳实践是使用负载均衡器（如 HAProxy + VIP）统一接入点。</p><hr><h2 id=资源置备>资源置备</h2><p>MinIO 集群部署后，Pigsty 会自动创建以下资源（由 <a href=/docs/minio/param#minio_provision><strong><code>minio_provision</code></strong></a> 控制）：</p><p><strong>默认存储桶</strong>（由 <a href=/docs/minio/param#minio_buckets><strong><code>minio_buckets</code></strong></a> 定义）：</p><table class=full-width><thead><tr><th style=text-align:left>存储桶</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><code>pgsql</code></td><td style=text-align:left>PostgreSQL pgBackREST 备份存储</td></tr><tr><td style=text-align:left><code>meta</code></td><td style=text-align:left>元数据存储，启用版本控制</td></tr><tr><td style=text-align:left><code>data</code></td><td style=text-align:left>通用数据存储</td></tr></tbody></table><p><strong>默认用户</strong>（由 <a href=/docs/minio/param#minio_users><strong><code>minio_users</code></strong></a> 定义）：</p><table class=full-width><thead><tr><th style=text-align:left>用户</th><th style=text-align:left>默认密码</th><th style=text-align:left>策略</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><code>pgbackrest</code></td><td style=text-align:left><code>S3User.Backup</code></td><td style=text-align:left><code>pgsql</code></td><td style=text-align:left>PostgreSQL 备份专用用户</td></tr><tr><td style=text-align:left><code>s3user_meta</code></td><td style=text-align:left><code>S3User.Meta</code></td><td style=text-align:left><code>meta</code></td><td style=text-align:left>访问 <code>meta</code> 存储桶</td></tr><tr><td style=text-align:left><code>s3user_data</code></td><td style=text-align:left><code>S3User.Data</code></td><td style=text-align:left><code>data</code></td><td style=text-align:left>访问 <code>data</code> 存储桶</td></tr></tbody></table><p><code>pgbackrest</code> 是 PostgreSQL 集群备份时使用的用户，<code>s3user_meta</code> 和 <code>s3user_data</code> 是未实际使用的保留用户。</p><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 提供了一套开箱即用的监控系统，在这个系统中使用上面的 <a href=#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 来标识各个 MinIO 实体对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;minio&#34;}
</span></span><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-2&#34;, ip=&#34;10.10.10.11&#34;, job=&#34;minio&#34;}
</span></span><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-3&#34;, ip=&#34;10.10.10.12&#34;, job=&#34;minio&#34;}
</span></span><span style=display:flex><span>minio_up{cls=&#34;minio&#34;, ins=&#34;minio-4&#34;, ip=&#34;10.10.10.13&#34;, job=&#34;minio&#34;}
</span></span></code></pre></div><p>例如，上面的 <code>cls</code>，<code>ins</code>，<code>ip</code> 三个标签，分别对应集群名、实例名与节点 IP，这三个核心实体的标识符。
它们与 <code>job</code> 标签，在 <strong>所有</strong> <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a> 采集的 MinIO 监控指标中都会出现并可用。
采集 MinIO 指标的 <code>job</code> 名固定为 <code>minio</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0de22cd0f8c383fe4e1ef5a4eb6b5440>2.4 - REDIS 集群模型</h1><div class=lead>介绍 Pigsty 中 Redis 集群的实体-关系模型，E-R 关系图，实体释义与命名规范。</div><p>Redis 模块在生产环境中以<strong>集群</strong>的形式组织，这些<strong>集群</strong>是由一组 Redis <strong>实例</strong>组成的<strong>逻辑实体</strong>，部署在一个或多个<strong>节点</strong>上。</p><p>每个集群都是一个<strong>自治</strong>的高性能缓存/存储单元，由至少一个 <strong>Redis 实例</strong> 组成，通过端口向外暴露服务能力。</p><p>在 Pigsty 的 Redis 模块中有三种核心实体：</p><ul><li><strong>集群</strong>（Cluster）：自治的 Redis 服务单元，用作其他实体的顶级命名空间。</li><li><strong>实例</strong>（Instance）：单个 Redis 服务器进程，在节点上的特定端口运行。</li><li><strong>节点</strong>（Node）：运行 Linux + Systemd 环境的硬件资源抽象，可以承载多个 Redis 实例，隐含式声明。</li></ul><p>与 PostgreSQL 不同，Redis 采用 <strong>单机多实例</strong> 的部署模型：一个物理/虚拟机节点上通常会部署 <strong>多个</strong> Redis 实例，
以充分利用多核 CPU。因此，节点与实例是 <strong>1:N</strong> 的关系。此外，生产中通常不建议设置单个内存规模大于 12GB 的 Redis 实例。</p><hr><h2 id=工作模式>工作模式</h2><p>Redis 有三种不同的工作模式，由 <a href=/docs/redis/param#redis_mode><strong><code>redis_mode</code></strong></a> 参数指定：</p><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center>代号</th><th style=text-align:left>说明</th><th style=text-align:left>高可用机制</th></tr></thead><tbody><tr><td style=text-align:center><a href=#%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4><strong>主从模式</strong></a></td><td style=text-align:center><code>standalone</code></td><td style=text-align:left>经典主从复制，<strong>默认模式</strong></td><td style=text-align:left>需配合 Sentinel 实现</td></tr><tr><td style=text-align:center><a href=#%E5%93%A8%E5%85%B5%E9%9B%86%E7%BE%A4><strong>哨兵模式</strong></a></td><td style=text-align:center><code>sentinel</code></td><td style=text-align:left>为主从模式提供高可用监控与自动故障转移</td><td style=text-align:left>本身的多节点仲裁</td></tr><tr><td style=text-align:center><a href=#%E5%8E%9F%E7%94%9F%E9%9B%86%E7%BE%A4><strong>原生集群模式</strong></a></td><td style=text-align:center><code>cluster</code></td><td style=text-align:left>Redis 原生分布式集群，无需哨兵即可高可用</td><td style=text-align:left>内置自动故障转移</td></tr></tbody></table><ul><li><strong>主从模式</strong>：默认模式，通过 <code>replica_of</code> 参数设置主从复制关系。需要额外的 Sentinel 集群提供高可用。</li><li><strong>哨兵模式</strong>：不存储业务数据，专门用于监控主从模式的 Redis 集群，实现自动故障转移，本身多节点即可高可用。</li><li><strong>原生集群模式</strong>：数据自动分片到多个主节点，每个主节点可以有多个从节点，内置高可用能力，无需哨兵支持。</li></ul><hr><h2 id=具体样例>具体样例</h2><p>让我们来看三种模式的具体例子：</p><h3 id=主从集群>主从集群</h3><p>一个节点上部署一主一从的经典主从集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-ms</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.ms&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>redis-ms</code></strong></td><td>Redis 主从集群</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-ms-1</code></strong></td><td><code>10.10.10.10</code> 1 号节点，承载 2 个实例</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-ms-1-6379</code></strong></td><td>主库实例，监听 6379 端口</td></tr><tr><td style=text-align:center><strong><code>redis-ms-1-6380</code></strong></td><td>从库实例，监听 6380 端口，复制自 6379</td></tr></tbody></table><h3 id=哨兵集群>哨兵集群</h3><p>一个节点上部署三个哨兵实例，用于监控主从集群。哨兵集群通过 <a href=/docs/redis/param#redis_sentinel_monitor><strong><code>redis_sentinel_monitor</code></strong></a> 参数指定要监控的主从集群列表：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-sentinel</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>26379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 26380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 26381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.sentinel&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_sentinel_monitor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: redis-ms, host: 10.10.10.10, port: 6379, password: redis.ms, quorum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=原生集群>原生集群</h3><p>下面的配置片段定义了由两个节点，六个实例组成的 Redis 原生分布式集群（最小规格，3主3从）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1, redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 2, redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>}, 6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>该配置将创建一个 <strong>3 主 3 从</strong> 的原生 Redis 集群。</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>集群</strong></span></th><th><span class=text-secondary><strong>Cluster</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>redis-test</code></strong></td><td>Redis 原生集群（3 主 3 从）</td></tr><tr><td style=text-align:center><span class=text-success><strong>实例</strong></span></td><td><span class=text-success><strong>Instance</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-test-1-6379</code></strong></td><td>节点 1 上的实例，监听 6379 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-1-6380</code></strong></td><td>节点 1 上的实例，监听 6380 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-1-6381</code></strong></td><td>节点 1 上的实例，监听 6381 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-2-6379</code></strong></td><td>节点 2 上的实例，监听 6379 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-2-6380</code></strong></td><td>节点 2 上的实例，监听 6380 端口</td></tr><tr><td style=text-align:center><strong><code>redis-test-2-6381</code></strong></td><td>节点 2 上的实例，监听 6381 端口</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>redis-test-1</code></strong></td><td><code>10.10.10.12</code> 1 号节点，承载 3 个实例</td></tr><tr><td style=text-align:center><strong><code>redis-test-2</code></strong></td><td><code>10.10.10.13</code> 2 号节点，承载 3 个实例</td></tr></tbody></table><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/redis/param#redis><strong><code>REDIS</code></strong></a> 参数组为 Redis 模块的每个实体赋予确定的身份。以下三项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th style=text-align:left>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/redis/param#redis_cluster><strong><code>redis_cluster</code></strong></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center>集群</td><td style=text-align:left>Redis 集群名称，必选身份参数</td><td style=text-align:left>有效的 DNS 名称，满足 <code>[a-z][a-z0-9-]*</code></td></tr><tr><td style=text-align:left><a href=/docs/redis/param#redis_node><strong><code>redis_node</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>节点</td><td style=text-align:left>Redis 节点编号，必选身份参数</td><td style=text-align:left>自然数，从 1 开始分配，集群内不重复</td></tr><tr><td style=text-align:left><a href=/docs/redis/param#redis_instances><strong><code>redis_instances</code></strong></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center>节点</td><td style=text-align:left>Redis 实例定义，必选身份参数</td><td style=text-align:left>JSON 对象，Key 为端口号，Value 为实例配置</td></tr></tbody></table><p>只要在集群层面定义了集群名称，节点层面分配了节点编号与实例定义，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th style=text-align:left>生成规则</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td><strong>实例</strong></td><td style=text-align:left><code>{{ redis_cluster }}-{{ redis_node }}-{{ port }}</code></td><td style=text-align:left><code>redis-ms-1-6379</code>，<code>redis-ms-1-6380</code></td></tr></tbody></table><p>Redis 模块不会为主机节点赋予额外的身份标识，节点使用其原有的主机名或 IP 地址进行标识。
<a href=/docs/redis/param#redis_node><strong><code>redis_node</code></strong></a> 参数用于实例命名，而非主机节点的身份。</p><hr><h2 id=实例定义>实例定义</h2><p><a href=/docs/redis/param#redis_instances><strong><code>redis_instances</code></strong></a> 是一个 JSON 对象，Key 为 <strong>端口号</strong>，Value 为该实例的 <strong>配置项</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>                                      </span><span style=color:#8f5902;font-style:italic># 主库实例，无需额外配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 从库实例，指定上游主库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 从库实例，指定上游主库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个 Redis 实例会监听一个唯一的端口，端口在节点上唯一不重复，您可以任意选择端口号，
但请不要使用系统保留端口（小于 1024），或者与 <a href=/docs/ref/port/><strong>Pigsty 使用的端口</strong></a> 冲突。
实例配置中的 <code>replica_of</code> 参数用于在主从模式下设置复制关系，格式为 <code>'&lt;ip> &lt;port>'</code>，用于指定一个 Redis 从库的上游主库地址与端口。</p><p>此外，每个 Redis 节点上会运行一个 Redis Exporter，用于汇总采集当前节点上 <strong>所有本地实例</strong> 的监控指标：</p><table class=full-width><thead><tr><th style=text-align:left>端口</th><th style=text-align:left>参数</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left>9121</td><td style=text-align:left><a href=/docs/redis/param#redis_exporter_port><strong><code>redis_exporter_port</code></strong></a></td><td style=text-align:left>Redis Exporter 端口</td></tr></tbody></table><p>Redis 模块的单机多实例部署模型带有一些一些局限性：</p><ul><li><strong>节点独占</strong>：一个节点只能属于一个 Redis 集群，不能同时分配给不同的 Redis 集群。</li><li><strong>端口唯一</strong>：同一节点上的 Redis 实例必须使用不同的端口号，避免端口冲突。</li><li><strong>密码共享</strong>：同一节点上的多个 Redis 实例无法设置不同的密码（受 redis_exporter 限制）。</li><li><strong>手动高可用</strong>：主从模式的 Redis 集群需要额外配置 Sentinel 才能实现自动故障转移。</li></ul><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 提供了一套开箱即用的监控系统，在这个系统中使用上面的 <a href=#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 来标识各个 Redis 实体对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>redis_up{cls=&#34;redis-ms&#34;, ins=&#34;redis-ms-1-6379&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;redis&#34;}
</span></span><span style=display:flex><span>redis_up{cls=&#34;redis-ms&#34;, ins=&#34;redis-ms-1-6380&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;redis&#34;}
</span></span></code></pre></div><p>例如，上面的 <code>cls</code>，<code>ins</code>，<code>ip</code> 三个标签，分别对应集群名、实例名与节点 IP，这三个核心实体的标识符。
它们与 <code>job</code> 标签，在 <strong>所有</strong> <a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a> 采集的 Redis 监控指标中都会出现并可用。
采集 Redis 指标的 <code>job</code> 名固定为 <code>redis</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2ad10e50acca12cdeaaf406b2cf23f3b>2.5 - INFRA 集群模型</h1><div class=lead>介绍 Pigsty 中 INFRA 基础设施节点的实体-关系模型，组件构成与命名规范。</div><p>INFRA 模块在 Pigsty 中承担着特殊的角色：它不是传统意义上的"集群"，而是由一组 <strong>基础设施节点</strong> 构成的管理中枢，为整个 Pigsty 部署提供核心服务。
每个 INFRA 节点都是一个<strong>自治</strong>的基础设施服务单元，运行着 Nginx、Grafana、VictoriaMetrics 等核心组件，共同为纳管的数据库集群提供可观测性与管理能力。</p><p>在 Pigsty 的 INFRA 模块中有两种核心实体：</p><ul><li><strong>节点</strong>（Node）：运行基础设施组件的服务器，可以是裸机、VM、容器或 Pod。</li><li><strong>组件</strong>（Component）：在节点上运行的各类基础设施服务，如 Nginx、Grafana、VictoriaMetrics 等。</li></ul><p>INFRA 节点通常承担管理节点（Admin Node）的角色，是 Pigsty 的控制平面所在。</p><hr><h2 id=组件构成>组件构成</h2><p>每个 INFRA 节点上运行着以下核心组件：</p><table class=full-width><thead><tr><th style=text-align:left>组件</th><th style=text-align:left>端口</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/concept/arch/infra#nginx><strong>Nginx</strong></a></td><td style=text-align:left><code>80/443</code></td><td style=text-align:left>Web 服务门户，本地软件仓库，统一反向代理入口</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#grafana><strong>Grafana</strong></a></td><td style=text-align:left><code>3000</code></td><td style=text-align:left>可视化平台，监控大屏，巡检与数据应用</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#victoriametrics><strong>VictoriaMetrics</strong></a></td><td style=text-align:left><code>8428</code></td><td style=text-align:left>时序数据库，兼容 Prometheus API</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#victorialogs><strong>VictoriaLogs</strong></a></td><td style=text-align:left><code>9428</code></td><td style=text-align:left>日志数据库，接收 Vector 推送的结构化日志</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#victoriatraces><strong>VictoriaTraces</strong></a></td><td style=text-align:left><code>10428</code></td><td style=text-align:left>链路追踪存储，用于慢 SQL / 请求追踪</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#vmalert><strong>VMAlert</strong></a></td><td style=text-align:left><code>8880</code></td><td style=text-align:left>告警规则评估器，基于 VictoriaMetrics 触发告警</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#alertmanager><strong>Alertmanager</strong></a></td><td style=text-align:left><code>9059</code></td><td style=text-align:left>告警聚合与分发</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#blackboxexporter><strong>Blackbox Exporter</strong></a></td><td style=text-align:left><code>9115</code></td><td style=text-align:left>ICMP/TCP/HTTP 黑盒探测</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#dnsmasq><strong>DNSMASQ</strong></a></td><td style=text-align:left><code>53</code></td><td style=text-align:left>DNS 服务器，提供内部域名解析</td></tr><tr><td style=text-align:left><a href=/docs/concept/arch/infra#chronyd><strong>Chronyd</strong></a></td><td style=text-align:left><code>123</code></td><td style=text-align:left>NTP 时间服务器</td></tr></tbody></table><p>这些组件共同构成了 Pigsty 的可观测性基础设施。</p><hr><h2 id=具体样例>具体样例</h2><p>让我们来看一个具体的例子，以双节点的 INFRA 部署为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上面的配置片段定义了一个双节点的 INFRA 部署：</p><table class=full-width><thead><tr><th style=text-align:center><span class=text-secondary><strong>分组</strong></span></th><th><span class=text-secondary><strong>Group</strong></span></th></tr></thead><tbody><tr><td style=text-align:center><strong><code>infra</code></strong></td><td>INFRA 基础设施节点分组</td></tr><tr><td style=text-align:center><span class=text-danger><strong>节点</strong></span></td><td><span class=text-danger><strong>Nodes</strong></span></td></tr><tr><td style=text-align:center><strong><code>infra-1</code></strong></td><td><code>10.10.10.10</code> 1 号 INFRA 节点</td></tr><tr><td style=text-align:center><strong><code>infra-2</code></strong></td><td><code>10.10.10.11</code> 2 号 INFRA 节点</td></tr></tbody></table><p>在生产环境中，建议部署至少两个 INFRA 节点，以实现基础设施组件的冗余。</p><hr><h2 id=身份参数>身份参数</h2><p>Pigsty 使用 <a href=/docs/infra/param#infra_id><strong><code>INFRA_ID</code></strong></a> 参数组为 INFRA 模块的每个实体赋予确定的身份。以下一项为必选参数：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th><th style=text-align:left>形式</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/infra/param#infra_seq><strong><code>infra_seq</code></strong></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center>节点</td><td style=text-align:left>INFRA 节点序号，必选身份参数</td><td style=text-align:left>自然数，从 1 开始分配，分组内不重复</td></tr></tbody></table><p>只要在节点层面分配了节点序号，Pigsty 就能自动根据规则为每个实体生成唯一标识符。</p><table class=full-width><thead><tr><th>实体</th><th style=text-align:left>生成规则</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td><strong>节点</strong></td><td style=text-align:left><code>infra-{{ infra_seq }}</code></td><td style=text-align:left><code>infra-1</code>，<code>infra-2</code></td></tr></tbody></table><p>INFRA 模块会为节点赋予 <code>infra-N</code> 形式的标识，用于监控系统中区分多个基础设施节点。
但这并不改变节点本身的主机名或系统身份，节点仍然使用其原有的主机名或 IP 地址进行标识。</p><hr><h2 id=服务门户>服务门户</h2><p>INFRA 节点通过 Nginx 提供统一的 Web 服务入口。<a href=/docs/infra/param#infra_portal><strong><code>infra_portal</code></strong></a> 参数定义了通过 Nginx 暴露的服务列表。</p><p>默认配置只定义了首页服务器：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 会自动为启用的组件（如 Grafana、VictoriaMetrics、AlertManager 等）配置反向代理端点。如果需要通过独立域名访问这些服务，可以显式添加配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home         </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>grafana      </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: g.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:3000&#34;</span><span style=color:#204a87;font-weight:700>, websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>prometheus   </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: p.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:8428&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># VMUI</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>alertmanager </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: a.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:9059&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:left>域名</th><th style=text-align:left>服务</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>i.pigsty</code></td><td style=text-align:left>Home</td><td style=text-align:left>Pigsty 首页</td></tr><tr><td style=text-align:left><code>g.pigsty</code></td><td style=text-align:left>Grafana</td><td style=text-align:left>监控可视化平台</td></tr><tr><td style=text-align:left><code>p.pigsty</code></td><td style=text-align:left>VictoriaMetrics</td><td style=text-align:left>时序数据库 Web UI</td></tr><tr><td style=text-align:left><code>a.pigsty</code></td><td style=text-align:left>Alertmanager</td><td style=text-align:left>告警管理界面</td></tr></tbody></table><p>建议通过域名访问 Pigsty 服务，而不是直接使用 IP + 端口的方式。</p><hr><h2 id=部署规模>部署规模</h2><p>INFRA 节点的数量取决于部署规模和高可用需求：</p><table class=full-width><thead><tr><th style=text-align:left>部署规模</th><th style=text-align:left>INFRA 节点数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>开发测试</td><td style=text-align:left>1</td><td style=text-align:left>单节点部署，所有组件在同一节点</td></tr><tr><td style=text-align:left>小规模生产</td><td style=text-align:left>1-2</td><td style=text-align:left>单节点或双节点，可与其他服务共用节点</td></tr><tr><td style=text-align:left>中规模生产</td><td style=text-align:left>2-3</td><td style=text-align:left>独立的 INFRA 节点，组件冗余部署</td></tr><tr><td style=text-align:left>大规模生产</td><td style=text-align:left>3+</td><td style=text-align:left>多 INFRA 节点，可根据组件分离部署</td></tr></tbody></table><p><a href=/docs/setup/install><strong>单机部署</strong></a> 时，INFRA 组件与 PGSQL、ETCD 等模块共用同一个节点。
通常在小规模部署中，INFRA 节点通常还承担着 “<a href=/docs/concept/arch/node#admin%E8%8A%82%E7%82%B9><strong>管理节点</strong></a>” / “备用管理节点”，以及本地软件仓库（<code>/www/pigsty</code>）的角色。
在更大规模的部署中，这些职责可以剥离至专用节点。</p><hr><h2 id=监控标签体系>监控标签体系</h2><p>Pigsty 的监控系统会采集 INFRA 组件自身的指标。与数据库模块不同，INFRA 模块的每个<strong>组件</strong>都被视为独立的监控对象，通过 <code>cls</code>（类）标签区分不同组件类型。</p><table class=full-width><thead><tr><th style=text-align:left>标签</th><th style=text-align:left>说明</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td style=text-align:left><code>cls</code></td><td style=text-align:left>组件类型，每种组件各自构成一个"类"</td><td style=text-align:left><code>nginx</code></td></tr><tr><td style=text-align:left><code>ins</code></td><td style=text-align:left>实例名，格式为 <code>{组件类型}-{infra_seq}</code></td><td style=text-align:left><code>nginx-1</code></td></tr><tr><td style=text-align:left><code>ip</code></td><td style=text-align:left>运行该组件的 INFRA 节点 IP 地址</td><td style=text-align:left><code>10.10.10.10</code></td></tr><tr><td style=text-align:left><code>job</code></td><td style=text-align:left>VictoriaMetrics 采集任务名，固定为 <code>infra</code></td><td style=text-align:left><code>infra</code></td></tr></tbody></table><p>以双节点 INFRA 部署（<code>infra_seq: 1</code> 和 <code>infra_seq: 2</code>）为例，各组件的监控标签如下：</p><table class=full-width><thead><tr><th style=text-align:left>组件</th><th style=text-align:left><code>cls</code></th><th style=text-align:left><code>ins</code> 示例</th><th style=text-align:left>端口</th></tr></thead><tbody><tr><td style=text-align:left><strong>Nginx</strong></td><td style=text-align:left><code>nginx</code></td><td style=text-align:left><code>nginx-1</code>，<code>nginx-2</code></td><td style=text-align:left><code>9113</code></td></tr><tr><td style=text-align:left><strong>Grafana</strong></td><td style=text-align:left><code>grafana</code></td><td style=text-align:left><code>grafana-1</code>，<code>grafana-2</code></td><td style=text-align:left><code>3000</code></td></tr><tr><td style=text-align:left><strong>VictoriaMetrics</strong></td><td style=text-align:left><code>vmetrics</code></td><td style=text-align:left><code>vmetrics-1</code>，<code>vmetrics-2</code></td><td style=text-align:left><code>8428</code></td></tr><tr><td style=text-align:left><strong>VictoriaLogs</strong></td><td style=text-align:left><code>vlogs</code></td><td style=text-align:left><code>vlogs-1</code>，<code>vlogs-2</code></td><td style=text-align:left><code>9428</code></td></tr><tr><td style=text-align:left><strong>VictoriaTraces</strong></td><td style=text-align:left><code>vtraces</code></td><td style=text-align:left><code>vtraces-1</code>，<code>vtraces-2</code></td><td style=text-align:left><code>10428</code></td></tr><tr><td style=text-align:left><strong>VMAlert</strong></td><td style=text-align:left><code>vmalert</code></td><td style=text-align:left><code>vmalert-1</code>，<code>vmalert-2</code></td><td style=text-align:left><code>8880</code></td></tr><tr><td style=text-align:left><strong>Alertmanager</strong></td><td style=text-align:left><code>alertmanager</code></td><td style=text-align:left><code>alertmanager-1</code>，<code>alertmanager-2</code></td><td style=text-align:left><code>9059</code></td></tr><tr><td style=text-align:left><strong>Blackbox</strong></td><td style=text-align:left><code>blackbox</code></td><td style=text-align:left><code>blackbox-1</code>，<code>blackbox-2</code></td><td style=text-align:left><code>9115</code></td></tr></tbody></table><p>所有 INFRA 组件的监控指标都使用统一的 <code>job="infra"</code> 标签，通过 <code>cls</code> 标签区分组件类型：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>nginx_up{cls=&#34;nginx&#34;, ins=&#34;nginx-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>grafana_info{cls=&#34;grafana&#34;, ins=&#34;grafana-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>vm_app_version{cls=&#34;vmetrics&#34;, ins=&#34;vmetrics-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>vlogs_rows_ingested_total{cls=&#34;vlogs&#34;, ins=&#34;vlogs-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span><span style=display:flex><span>alertmanager_alerts{cls=&#34;alertmanager&#34;, ins=&#34;alertmanager-1&#34;, ip=&#34;10.10.10.10&#34;, job=&#34;infra&#34;}
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-d1070a4639ccf6fd6d12d222bf92c497>3 - 声明式配置 —— 基础设施即代码（IaC）</h1><div class=lead>Pigsty 使用基础设施即代码（IaC）的理念管理所有组件，针对大规模集群提供声明式管理能力。</div><p>Pigsty 遵循 IaC 与 GitOPS 的理念：使用声明式的 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 描述整个环境，并通过 <a href=/docs/setup/playbook><strong>幂等剧本</strong></a> 来实现。</p><p>用户用声明的方式通过 <a href=/docs/ref/param><strong>参数</strong></a> 来描述自己期望的状态，而剧本则以幂等的方式调整目标节点以达到这个状态。
这类似于 Kubernetes 的 CRD & Operator，然而 Pigsty 在裸机和虚拟机上，通过 Ansible 实现了这样的功能。</p><p>Pigsty 诞生之初是为了解决超大规模 PostgreSQL 集群的运维管理问题，背后的想法很简单 —— 我们需要有在十分钟内在就绪的服务器上复刻整套基础设施（100+数据库集群 + PG/Redis + 可观测性）的能力。
任何 GUI + ClickOps 都无法在如此短的时间内完成如此复杂的任务，这让 CLI + IaC 成为唯一的选择 —— 它提供了精确，高效的控制能力。</p><p><a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> <strong><code>pigsty.yml</code></strong> 文件描述了整个部署的状态，无论是 生产环境（prod），预发环境（staging）， 测试环境（test），还是 开发环境（devbox），
基础设施的区别仅在于配置清单的不同，而部署交付的逻辑则是完全相同的。</p><p>您可以使用 git 对这份部署的 “种子/基因” 进行版本控制与审计，而且，Pigsty 甚至支持将配置清单以数据库表的形式存储在 PostgreSQL <a href=/docs/concept/iac/cmdb><strong>CMDB</strong></a> 中，
更进一步从 Infra as Code 升级为 Infra as Data，无缝与您现有的工作流程集成与对接。</p><p>IaC 面向专业用户与企业场景而设计，但也针对个人开发者，SMB 进行了深度优化。
即使您并非专业 DBA，也无需了解这几百个调节开关与旋钮，所有参数都带有表现良好的默认值，
您完全可以在 <strong>零配置</strong> 的情况下，获得一个开箱即用的单机数据库节点；
简单地再添加两行 IP 地址，就能获得一套企业级的高可用的 PostgreSQL 集群。</p><hr><h2 id=声明模块>声明模块</h2><p>以下面的默认配置片段为例，这段配置描述了一个节点 <code>10.10.10.10</code>，其上安装了 <a href=/docs/infra><strong><code>INFRA</code></strong></a>、<a href=/docs/node><strong><code>NODE</code></strong></a>、<a href=/docs/etcd><strong><code>ETCD</code></strong></a> 和 <a href=/docs/pgsql><strong><code>PGSQL</code></strong></a> 模块。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 监控、告警、DNS、NTP 等基础设施集群...</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># minio 集群，兼容 s3 的对象存储</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># etcd 集群，用作 PostgreSQL 高可用所需的 DCS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq: 1 } }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL 示例集群: pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary }, vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>要真正安装这些模块，执行以下剧本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># 在节点 10.10.10.10 上初始化 infra 模块</span>
</span></span><span style=display:flex><span>./etcd.yml  -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># 在节点 10.10.10.10 上初始化 etcd 模块</span>
</span></span><span style=display:flex><span>./minio.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># 在节点 10.10.10.10 上初始化 minio 模块</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.10  <span style=color:#8f5902;font-style:italic># 在节点 10.10.10.10 上初始化 pgsql 模块</span>
</span></span></code></pre></div><hr><h2 id=声明集群>声明集群</h2><p>您可以声明 PostgreSQL 数据库集群，在多个节点上安装 <a href=/docs/pgsql/><strong><code>PGSQL</code></strong></a> 模块，并使其成为一个服务单元：</p><p>例如，要在以下三个已被 Pigsty 纳管的节点上，部署一个使用流复制组建的三节点高可用 PostgreSQL 集群，
您可以在配置文件 <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><code>pigsty.yml</code></a> 的 <code>all.children</code> 中添加以下定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>定义完后，可以使用 <a href=/docs/setup/playbook/><strong>剧本</strong></a> 将集群创建：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># 创建 pg-test 集群 </span>
</span></span></code></pre></div><p><img src=/img/pigsty/iac.jpg alt=pigsty-iac.jpg></p><p>你可以使用不同的实例角色，例如 <a href=/docs/pgsql/config/cluster#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93><strong>主库</strong></a>（primary），<a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93><strong>从库</strong></a>（replica），<a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93><strong>离线从库</strong></a>（offline），<a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4><strong>延迟从库</strong></a>（delayed），<a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93><strong>同步备库</strong></a>（sync standby）；
以及不同的集群：例如 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4><strong>备份集群</strong></a>（Standby Cluster），<a href=/docs/pgsql/config/cluster#citus%E9%9B%86%E7%BE%A4><strong>Citus 集群</strong></a>，甚至是 <a href=/docs/redis><strong>Redis</strong></a> / <a href=/docs/minio><strong>MinIO</strong></a> / <a href=/docs/etcd><strong>Etcd</strong></a> 集群</p><hr><h2 id=定制集群内容>定制集群内容</h2><p>您不仅可以使用声明式的方式定义集群，还可以定义集群中的数据库、用户、服务、HBA 规则等内容，例如，下面的配置文件对默认的 <code>pg-meta</code> 单节点数据库集群的内容进行了深度定制：</p><p>包括：声明了六个业务数据库与七个业务用户，添加了一个额外的 <code>standby</code> 服务（同步备库，提供无复制延迟的读取能力），定义了一些额外的 <code>pg_hba</code> 规则，一个指向集群主库的 L2 VIP 地址，与自定义的备份策略。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># define business databases on this cluster, array of database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a database definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database sql baseline path, (relative path among ansible search path, e.g files/)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this database to pgbouncer database list? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, additional schemas to be created, array of schema names</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions:                     # optional, additional extensions to be installed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>array of `{name[,schema]}`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database owner, postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, which template to use, template1 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database encoding, UTF8 by default. (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database locale, C by default.  (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database collate, C by default. (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, database ctype, C by default.   (MUST same as template database)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, default tablespace, &#39;pg_default&#39; by default.</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, allow connection, true by default. false will disable connect at all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, revoke public connection privilege. false by default. (leave connect with grant option to owner)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># optional, register this database to grafana datasources? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, database connection limit, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, all connection to this pgbouncer database will be authenticated by this user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at database level, default transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size at database level, default 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size reserve at database level, default 32</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool size min at database level, default 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># optional, max database connections at database level, default 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># define business users/roles on this cluster, array of user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># REQUIRED, `name` is the only mandatory field of a user definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, password, can be a scram-sha-256 hash string or plain text</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># optional, can log in, true by default  (new biz ROLE should be false)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, is superuser? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, can create database? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># optional, can create role? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, can this role use inherited privileges? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, can this role do replication? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># optional, can this role bypass row level security? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, add this user to pgbouncer user-list? false by default (production user should be true explicitly)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, user connection limit, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># optional, now + n days when this role is expired (OVERWRITE expire_at)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># optional, YYYY-MM-DD &#39;timestamp&#39; when this role is expired  (OVERWRITTEN by expire_in)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, comment string for this user/role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>roles: [dbrole_admin]           # optional, belonged roles. default roles are</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_{admin,readonly,readwrite,offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># optional, role level parameters with `ALTER ROLE SET`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, pgbouncer pool mode at user level, transaction by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># optional, max database connections at user level, default -1 disable limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service      }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                        </span><span style=color:#8f5902;font-style:italic># extra services in addition to pg_default_services, array of service definition</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># standby service will route {ip|name}:5435 to sync replica&#39;s pgbouncer (5435-&gt;6432 standby)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name: standby                   # required, service name, the actual svc name will be prefixed with `pg_cluster`, e.g</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># required, service exposed port (work as kubernetes service node port mode)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># optional, service bind ip address, `*` for all ip by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># required, service member selector, use JMESPath to filter inventory</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, destination port, default|postgres|pgbouncer|&lt;port_number&gt;, &#39;default&#39; by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>check</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># optional, health check url path, / by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># backup server selector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># optional, max allowed front-end connection</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>balance: roundrobin             # optional, haproxy load balance algorithm (roundrobin by default, other</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>leastconn)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.2</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># make a full backup 1 am everyday</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=声明访问控制>声明访问控制</h2><p>您还可以通过声明式的配置，深度定制 Pigsty 的访问控制能力。例如下面的配置文件对 <code>pg-meta</code> 集群进行了深度安全定制：</p><p>使用三节点核心集群模板：<code>crit.yml</code>，确保数据一致性有限，故障切换数据零丢失。
启用了 L2 VIP，并将数据库与连接池的监听地址限制在了本地环回 IP + 内网 IP + VIP 三个特定地址。
模板强制启用了 Patroni 的 SSL API，与 Pgbouncer 的 SSL，并在 HBA 规则中强制要求使用 SSL 访问数据库集群。
同时还在 <code>pg_libs</code> 中启用了 <code>$libdir/passwordcheck</code> 扩展，来强制执行密码强度安全策略。</p><p>最后，还单独声明了一个 <code>pg-meta-delay</code> 集群，作为 <code>pg-meta</code> 在一个小时前的延迟镜像从库，用于紧急数据误删恢复。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 3 instance postgres cluster `pg-meta`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta , password: DBUser.Meta   , pgbouncer: true , roles: [ dbrole_admin ] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view , password: DBUser.Viewer , pgbouncer: true , roles: [ dbrole_readonly ] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: standby ,src_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,port: 5435 , dest: default ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.2</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_listen</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${ip},${vip},${lo}&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_ssl_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>require</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, $libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add passwordcheck extension to enforce strong password</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly]               ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite]  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,expire_in: 7300                        ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,expire_in: 7300 ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,expire_in: 7300 ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,expire_in: 7300 ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres host-based auth rules by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: cert  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; cert&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer host-based authentication rules</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu local admin access with os ident&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user local access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor access via intranet with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other monitor access addr&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin access via intranet with pwd&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;reject all other admin access addr&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow all user intra access with pwd&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># OPTIONAL delayed cluster for pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta-delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># delayed instance for pg-meta (1 hour ago)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_upstream: 10.10.10.10, pg_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1h } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-delay }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=citus-分布式集群>Citus 分布式集群</h2><p>下面是一个四节点的 Citus 分布式集群的声明式配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus coordinator, pg_group = 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus data node 3, with an extra replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.14</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># global parameters for all citus clusters</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                    # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_citus_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus distributed database name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=redis-集群>Redis 集群</h2><p>下面给出了 Redis 主从集群、哨兵集群、以及 Redis Cluster 的声明配置样例</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-ms</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># redis classic primary &amp; replica</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 , redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>}, 6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>replica_of</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.10 6379&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_cluster: redis-ms ,redis_password: &#39;redis.ms&#39; ,redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MB }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># redis sentinel x 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 , redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>26379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,26380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,26381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>redis-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;redis.meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sentinel</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis_sentinel_monitor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary list for redis sentinel, use cls as name, primary ip:port</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: redis-ms, host: 10.10.10.10, port: 6379 ,password: redis.ms, quorum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>redis-test: # redis native cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>3m x 3s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 1 ,redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_node: 2 ,redis_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>6379</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6380</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>} ,6381</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>redis_cluster: redis-test ,redis_password: &#39;redis.test&#39; ,redis_mode: cluster, redis_max_memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=etcd-集群>ETCD 集群</h2><p>下面给出了一个三节点的 Etcd 集群声明式配置样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># dcs service for postgres/patroni ha consensus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 1 node for testing, 3 or 5 for production</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># etcd_seq required</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># assign from 1 ~ n</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># odd number please</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># cluster level parameter override roles/etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># mark etcd cluster name etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># safeguard against purging</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd_clean</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># purge etcd during init process</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=minio-集群>MinIO 集群</h2><p>下面给出了一个三节点的 MinIO 集群声明式配置样例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data{1...2}&#39;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 每个节点使用两块磁盘</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio_node</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${minio_cluster}-${minio_seq}.pigsty&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 节点名称的模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>haproxy_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># [必选] 服务名称，需要唯一</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9002</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># [必选] 服务端口，需要唯一</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>http-check send meth OPTIONS uri /minio/health/live</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- <span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>servers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-1 ,ip: 10.10.10.10 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-2 ,ip: 10.10.10.11 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: minio-3 ,ip: 10.10.10.12 , port: 9000 , options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;check-ssl ca-file /etc/pki/ca.crt check port 9000&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6b8b3debf71b9a47be1364eba07a65ae>3.1 - 配置清单</h1><div class=lead>使用声明式的配置文件描述你需要的基础设施与集群</div><p>每一套 Pigsty 部署都对应着一份 <strong>配置清单</strong> （Inventory），描述了基础设施与数据库集群的关键属性。</p><hr><h2 id=配置文件>配置文件</h2><p>Pigsty 默认使用 <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html><strong>Ansible YAML 配置格式</strong></a>，
使用一个单一 YAML 配置文件 <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><strong><code>pigsty.yml</code></strong></a> 作为配置清单。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>~/pigsty
</span></span><span style=display:flex><span>  ^---- pigsty.yml   <span style=color:#8f5902;font-style:italic># &lt;---- 默认配置文件</span>
</span></span></code></pre></div><p>您可以直接修改该配置文件来定制您的部署，或者使用 Pigsty 提供的 <a href=/docs/concept/iac/configure><strong>配置向导</strong></a> <strong><code>configure</code></strong> 脚本自动生成合适的配置文件。</p><hr><h2 id=配置结构>配置结构</h2><p>配置清单使用标准的 <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html><strong>Ansible YAML 配置格式</strong></a>，由两部分组成：<strong>全局参数</strong> （<code>all.vars</code>）和多个 <strong>组</strong>（<code>all.children</code>）。</p><p>您可以在 <code>all.children</code> 中定义新集群，并使用全局变量描述基础设施：<code>all.vars</code>，它看起来像这样：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># 顶级对象：all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 全局参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 组定义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组成员：&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span>{<span style=color:#000>...}       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组参数：&#39;infra&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span>{<span style=color:#000>...}   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;etcd&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;pg-meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;pg-test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>redis-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#000>...}</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 组定义：&#39;redis-test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ...</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=集群定义>集群定义</h2><p>每个 Ansible 组可能代表一个集群，可以是节点集群、PostgreSQL 集群、Redis 集群、Etcd 集群或 MinIO 集群等…</p><p>集群定义由两部分组成：<strong>集群成员</strong> （<strong><code>hosts</code></strong>）与 <strong>集群参数</strong>（<strong><code>vars</code></strong>）。
您可以在 <code>&lt;cls>.hosts</code> 中定义集群成员，并在 <code>&lt;cls>.vars</code> 中使用 <a href=/docs/concept/iac/parameter><strong>配置参数</strong></a> 描述集群。
下面是一个 3 节点高可用 PostgreSQL 集群的定义示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ansible 组列表</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># ansible 组名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># ansible 组内实例（集群成员）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主机 1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主机 2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主机 3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ansible 组变量（集群参数）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>集群级别的 <code>vars</code> （集群参数）将覆盖全局参数，实例级别的 <code>vars</code> 将覆盖集群参数和全局参数。</p><hr><h2 id=拆分配置>拆分配置</h2><p>如果您的部署规模较大，或者希望更好地组织配置文件，
可以将配置清单 <a href=https://docs.ansible.com/projects/ansible/latest/inventory_guide/intro_inventory.html#id18><strong>拆分为多个文件</strong></a>，便于管理与维护。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>inventory/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>├── hosts.yml             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主机和集群定义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>├── group_vars/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── all.yml           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 全局默认变量 (对应 all.vars)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── infra.yml         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># infra 组变量</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   ├── etcd.yml          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># etcd 组变量</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>│   └── pg-meta.yml       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg-meta 集群变量</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>└── host_vars/</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>├── 10.10.10.10.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 特定主机变量</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>└── 10.10.10.11.yml</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您可以将集群成员定义放在 <code>hosts.yml</code> 文件中，将集群层面的 <a href=/docs/concept/iac/parameter#%E5%8F%82%E6%95%B0%E4%BC%98%E5%85%88%E7%BA%A7><strong>配置参数</strong></a> 放在 <code>group_vars</code> 目录下的对应文件中。</p><hr><h2 id=切换配置>切换配置</h2><p>您可以在执行剧本的时候，通过 <code>-i</code> 参数，临时指定另外的配置清单文件。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -i another_config.yml
</span></span><span style=display:flex><span>./infra.yml -i nginx_config.yml
</span></span></code></pre></div><p>此外，Ansible 支持多种配置方式，您可以使用本地 <code>yaml|ini</code> 配置文件，或者是 CMDB 与任意的动态配置脚本作为配置源。</p><p>在 Pigsty 中，我们通过 Pigsty 主目录中的 <a href=https://github.com/pgsty/pigsty/blob/main/ansible.cfg#L6><strong><code>ansible.cfg</code></strong></a>
指定同目录下的 <strong><code>pigsty.yml</code></strong> 作为默认的 <strong>配置清单</strong>，您可按需修改。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[defaults]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>inventory</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pigsty.yml</span>
</span></span></code></pre></div><p>此外，Pigsty 还支持使用 <a href=/docs/concept/iac/cmdb><strong>CMDB 元数据库</strong></a> 来存储配置清单，便于与现有系统对接整合。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-c48a7025a948ffe27199cd10986e517a>3.2 - 配置向导</h1><div class=lead>使用 configure 脚本根据当前环境自动生成推荐的配置文件。</div><p>Pigsty 提供了一个 <strong><code>configure</code></strong> 脚本作为 <strong>配置向导</strong>，它能根据当前环境，自动生成合适的 <code>pigsty.yml</code> 配置文件。</p><p>这是一个 <strong>可选</strong> 的脚本：如果您已经了解了如何配置 Pigsty，大可以直接编辑 <code>pigsty.yml</code> 配置文件，跳过向导。</p><hr><h2 id=快速开始>快速开始</h2><p>进入 pigsty 源码家目录中，执行 <code>./configure</code> 即可自动运行配置向导。不带任何参数时，默认使用 <a href=/docs/conf/meta><strong><code>meta</code></strong></a> 单节点配置模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty
</span></span><span style=display:flex><span>./configure          <span style=color:#8f5902;font-style:italic># 交互式配置向导，自动检测环境并生成配置</span>
</span></span></code></pre></div><p>该命令会以选定的模板为基础，检测当前节点的 IP 地址与区域，并生成适合当前环境的 <code>pigsty.yml</code> 配置文件。</p><div id=asciinema-faf4cf8e717f5b9f582b3cede024d31c class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-faf4cf8e717f5b9f582b3cede024d31c",o="/demo/configure.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[3,"默认配置"],[7,"指定IP"],[14,"随机密码"],[17,"rich模板"],[20,"app/odoo模板"],[26,"china区域"],[33,"ha/full模板"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><h2 id=功能说明>功能说明</h2><p><strong><code>configure</code></strong> 脚本会根据环境与输入执行以下调整，并在当前目录下生成 <code>pigsty.yml</code> 配置文件。</p><ul><li>检测当前节点 IP 地址，如果有多个 IP，则要求用户输入一个 <strong>首要的 IP 地址</strong> 作为当前节点的身份标识</li><li>使用 IP 地址替换配置模板中的占位符 <strong><code>10.10.10.10</code></strong>，并将其配置为 <a href=/docs/infra/param#admin_ip><strong><code>admin_ip</code></strong></a> 参数的值。</li><li>检测当前区域，将 <a href=/docs/infra/param#region><strong><code>region</code></strong></a> 设置为 <strong><code>default</code></strong> （全球默认仓库）或 <strong><code>china</code></strong> （使用中国镜像仓库）</li><li>针对小微实例（vCPU &lt; 4），为 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> 和 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数使用 <strong><code>tiny</code></strong> 参数模板，优化资源使用。</li><li>如果指定了 <strong><code>-v</code></strong> PG 大版本，将 <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a> 以及所有 PG 别名参数设置为对应大版本。</li><li>如果指定了 <strong><code>-g</code></strong> 参数，将所有默认密码替换为随机生成的强密码，提升安全性。（<strong>强烈推荐</strong>）</li><li>当 PG 大版本 ≥ 17 时优先使用内置的 <strong><code>C.UTF-8</code></strong> Locale，次选由操作系统支持的 <strong><code>C.UTF-8</code></strong> 。</li><li>检测当前环境中，用于执行部署的核心依赖 <strong><code>ansible</code></strong> 是否可用</li><li>同时检测部署目标节点是否 ssh 可达，并可以使用 sudo 执行命令。（<strong><code>-s</code></strong> 跳过）</li></ul><hr><h2 id=使用示例>使用示例</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 基本用法</span>
</span></span><span style=display:flex><span>./configure                       <span style=color:#8f5902;font-style:italic># 交互式配置向导</span>
</span></span><span style=display:flex><span>./configure -i 10.10.10.10        <span style=color:#8f5902;font-style:italic># 指定主 IP 地址</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指定配置模板</span>
</span></span><span style=display:flex><span>./configure -c meta               <span style=color:#8f5902;font-style:italic># 使用默认单节点模板（默认）</span>
</span></span><span style=display:flex><span>./configure -c rich               <span style=color:#8f5902;font-style:italic># 使用功能丰富的单节点模板</span>
</span></span><span style=display:flex><span>./configure -c slim               <span style=color:#8f5902;font-style:italic># 使用精简模板（仅 PGSQL + ETCD）</span>
</span></span><span style=display:flex><span>./configure -c ha/full            <span style=color:#8f5902;font-style:italic># 使用 4 节点高可用沙箱模板</span>
</span></span><span style=display:flex><span>./configure -c ha/trio            <span style=color:#8f5902;font-style:italic># 使用 3 节点高可用模板</span>
</span></span><span style=display:flex><span>./configure -c app/supa           <span style=color:#8f5902;font-style:italic># 使用 Supabase 自托管模板</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指定 PostgreSQL 版本</span>
</span></span><span style=display:flex><span>./configure -v <span style=color:#0000cf;font-weight:700>17</span>                 <span style=color:#8f5902;font-style:italic># 使用 PostgreSQL 17</span>
</span></span><span style=display:flex><span>./configure -v <span style=color:#0000cf;font-weight:700>16</span>                 <span style=color:#8f5902;font-style:italic># 使用 PostgreSQL 16</span>
</span></span><span style=display:flex><span>./configure -c rich -v <span style=color:#0000cf;font-weight:700>16</span>         <span style=color:#8f5902;font-style:italic># rich 模板 + PG 16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 区域与代理</span>
</span></span><span style=display:flex><span>./configure -r china              <span style=color:#8f5902;font-style:italic># 使用中国镜像源</span>
</span></span><span style=display:flex><span>./configure -r europe             <span style=color:#8f5902;font-style:italic># 使用欧洲镜像源</span>
</span></span><span style=display:flex><span>./configure -x                    <span style=color:#8f5902;font-style:italic># 导入当前代理环境变量</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 跳过与自动化</span>
</span></span><span style=display:flex><span>./configure -s                    <span style=color:#8f5902;font-style:italic># 跳过 IP 探测，保留占位符</span>
</span></span><span style=display:flex><span>./configure -n -i 10.10.10.10     <span style=color:#8f5902;font-style:italic># 非交互模式，指定 IP</span>
</span></span><span style=display:flex><span>./configure -c ha/full -s         <span style=color:#8f5902;font-style:italic># 4 节点模板，跳过 IP 替换</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 安全增强</span>
</span></span><span style=display:flex><span>./configure -g                    <span style=color:#8f5902;font-style:italic># 生成随机密码</span>
</span></span><span style=display:flex><span>./configure -c meta -g -i 10.10.10.10  <span style=color:#8f5902;font-style:italic># 完整生产配置</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指定输出与 SSH 端口</span>
</span></span><span style=display:flex><span>./configure -o prod.yml           <span style=color:#8f5902;font-style:italic># 输出到 prod.yml</span>
</span></span><span style=display:flex><span>./configure -p <span style=color:#0000cf;font-weight:700>2222</span>               <span style=color:#8f5902;font-style:italic># 使用 SSH 端口 2222</span>
</span></span></code></pre></div><hr><h2 id=命令参数>命令参数</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-c<span style=color:#000;font-weight:700>|</span>--conf &lt;template&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># 配置模板名称（meta|rich|slim|ha/full|...）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-i<span style=color:#000;font-weight:700>|</span>--ip &lt;ipaddr&gt;<span style=color:#ce5c00;font-weight:700>]</span>          <span style=color:#8f5902;font-style:italic># 指定主 IP 地址</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-v<span style=color:#000;font-weight:700>|</span>--version &lt;pgver&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># PostgreSQL 大版本号（13|14|15|16|17|18）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-r<span style=color:#000;font-weight:700>|</span>--region &lt;region&gt;<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># 上游软件仓库区域（default|china|europe）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-o<span style=color:#000;font-weight:700>|</span>--output &lt;file&gt;<span style=color:#ce5c00;font-weight:700>]</span>        <span style=color:#8f5902;font-style:italic># 输出配置文件路径（默认：pigsty.yml）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-s<span style=color:#000;font-weight:700>|</span>--skip<span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#8f5902;font-style:italic># 跳过 IP 地址探测与替换</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-x<span style=color:#000;font-weight:700>|</span>--proxy<span style=color:#ce5c00;font-weight:700>]</span>                <span style=color:#8f5902;font-style:italic># 从环境变量导入代理设置</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-n<span style=color:#000;font-weight:700>|</span>--non-interactive<span style=color:#ce5c00;font-weight:700>]</span>      <span style=color:#8f5902;font-style:italic># 非交互模式（不询问任何问题）</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-p<span style=color:#000;font-weight:700>|</span>--port &lt;port&gt;<span style=color:#ce5c00;font-weight:700>]</span>          <span style=color:#8f5902;font-style:italic># 指定 SSH 端口</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-g<span style=color:#000;font-weight:700>|</span>--generate<span style=color:#ce5c00;font-weight:700>]</span>             <span style=color:#8f5902;font-style:italic># 生成随机密码</span>
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>[</span>-h<span style=color:#000;font-weight:700>|</span>--help<span style=color:#ce5c00;font-weight:700>]</span>                 <span style=color:#8f5902;font-style:italic># 显示帮助信息</span>
</span></span></code></pre></div><h3 id=参数详解>参数详解</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>-c, --conf</code></td><td style=text-align:left>从 <code>conf/&lt;template>.yml</code> 生成配置文件，支持子目录如 <code>ha/full</code></td></tr><tr><td style=text-align:left><code>-i, --ip</code></td><td style=text-align:left>用指定 IP 替换配置模板中的占位符 <code>10.10.10.10</code></td></tr><tr><td style=text-align:left><code>-v, --version</code></td><td style=text-align:left>指定 PostgreSQL 大版本号（13-18），不指定时保持模板默认值</td></tr><tr><td style=text-align:left><code>-r, --region</code></td><td style=text-align:left>设置软件仓库镜像区域：<code>default</code>（默认）、<code>china</code>（中国镜像）、<code>europe</code>（欧洲镜像）</td></tr><tr><td style=text-align:left><code>-o, --output</code></td><td style=text-align:left>指定输出文件路径，默认为 <code>pigsty.yml</code></td></tr><tr><td style=text-align:left><code>-s, --skip</code></td><td style=text-align:left>跳过 IP 地址探测与替换，保留模板中的 <code>10.10.10.10</code> 占位符</td></tr><tr><td style=text-align:left><code>-x, --proxy</code></td><td style=text-align:left>将当前环境的代理变量（<code>HTTP_PROXY</code>、<code>HTTPS_PROXY</code>、<code>ALL_PROXY</code>、<code>NO_PROXY</code>）写入配置</td></tr><tr><td style=text-align:left><code>-n, --non-interactive</code></td><td style=text-align:left>非交互模式，不询问任何问题（需配合 <code>-i</code> 指定 IP）</td></tr><tr><td style=text-align:left><code>-p, --port</code></td><td style=text-align:left>指定 SSH 端口（非默认 22 端口时使用）</td></tr><tr><td style=text-align:left><code>-g, --generate</code></td><td style=text-align:left><strong>为配置文件中的密码生成随机值，提高安全性（强烈推荐）</strong></td></tr></tbody></table><hr><h2 id=执行流程>执行流程</h2><p><code>configure</code> 脚本按照以下顺序执行检测与配置：</p><pre tabindex=0><code>┌─────────────────────────────────────────────────────────────┐
│                    configure 执行流程                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. check_region          检测网络区域（GFW 检测）              │
│         ↓                                                   │
│  2. check_version         验证 PostgreSQL 版本号              │
│         ↓                                                   │
│  3. check_kernel          检测操作系统内核（Linux/Darwin）       │
│         ↓                                                   │
│  4. check_machine         检测 CPU 架构（x86_64/aarch64）      │
│         ↓                                                   │
│  5. check_package_manager 检测包管理器（dnf/yum/apt）           │
│         ↓                                                   │
│  6. check_vendor_version  检测 OS 发行版与版本                  │
│         ↓                                                   │
│  7. check_sudo            检测免密 sudo 权限                   │
│         ↓                                                   │
│  8. check_ssh             检测免密 SSH 到本机                   │
│         ↓                                                   │
│  9. check_proxy           处理代理环境变量                      │
│         ↓                                                   │
│ 10. check_ipaddr          探测/输入主 IP 地址                   │
│         ↓                                                   │
│ 11. check_admin           验证管理员 SSH + Sudo 权限            │
│         ↓                                                   │
│ 12. check_conf            选择配置模板                         │
│         ↓                                                   │
│ 13. check_config          生成配置文件                         │
│         ↓                                                   │
│ 14. check_utils           检测 Ansible 等工具是否安装           │
│         ↓                                                   │
│     ✓ 配置完成，输出 pigsty.yml                                │
│                                                             │
└─────────────────────────────────────────────────────────────┘
</code></pre><hr><h2 id=自动化行为>自动化行为</h2><h3 id=区域检测>区域检测</h3><p>脚本会自动检测网络环境，判断是否在中国大陆（GFW 内）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过访问 Google 判断网络环境</span>
</span></span><span style=display:flex><span>curl -I -s --connect-timeout <span style=color:#0000cf;font-weight:700>1</span> www.google.com
</span></span></code></pre></div><ul><li>如果无法访问 Google，自动设置 <code>region: china</code> 使用国内镜像</li><li>如果可以访问，使用 <code>region: default</code> 默认镜像</li><li>可通过 <code>-r</code> 参数手动指定区域</li></ul><h3 id=ip-地址处理>IP 地址处理</h3><p>脚本按以下优先级确定主 IP 地址：</p><ol><li><strong>命令行参数</strong>：如果通过 <code>-i</code> 指定了 IP，直接使用</li><li><strong>单 IP 探测</strong>：如果当前节点只有一个 IP，自动使用</li><li><strong>演示 IP 检测</strong>：如果检测到 <code>10.10.10.10</code>，自动选择（用于沙箱环境）</li><li><strong>交互式输入</strong>：多个 IP 时，提示用户选择或输入</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> Multiple IP address candidates found:
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span> 192.168.1.100   inet 192.168.1.100/24 scope global eth0
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> 10.10.10.10     inet 10.10.10.10/24 scope global eth1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> IN <span style=color:#ce5c00;font-weight:700>]</span> INPUT primary_ip address <span style=color:#ce5c00;font-weight:700>(</span>of current meta node, e.g 10.10.10.10<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>=</span>&gt; 10.10.10.10
</span></span></code></pre></div><h3 id=低端硬件优化>低端硬件优化</h3><p>当检测到 CPU 核心数 ≤ 4 时，脚本会自动调整配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> replace oltp template with tiny due to cpu &lt; <span style=color:#0000cf;font-weight:700>4</span>
</span></span></code></pre></div><ul><li>将 <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a> 从 <code>oltp.yml</code> 改为 <code>tiny.yml</code></li><li>将 <a href=/docs/node/param#node_tune><code>node_tune</code></a> 从 <code>oltp</code> 改为 <code>tiny</code></li></ul><p>这样可以确保在低配虚拟机上也能顺利运行。</p><h3 id=locale-设置>Locale 设置</h3><p>脚本会在以下情况自动启用 <code>C.UTF-8</code> 作为默认 Locale：</p><ul><li>PostgreSQL 版本 ≥ 17（内置 Locale Provider 支持）</li><li><strong>或者</strong> 当前系统支持 <code>C.UTF-8</code> / <code>C.utf8</code> Locale</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=中国区特殊处理>中国区特殊处理</h3><p>当区域设置为 <code>china</code> 时，脚本会自动：</p><ul><li>启用 <code>docker_registry_mirrors</code> Docker 镜像加速</li><li>启用 <code>PIP_MIRROR_URL</code> Python 镜像加速</li></ul><h3 id=密码生成>密码生成</h3><p>使用 <code>-g</code> 参数时，脚本会为以下密码生成 24 位随机字符串：</p><table><thead><tr><th style=text-align:center>密码参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>grafana_admin_password</code></td><td style=text-align:left>Grafana 管理员密码</td></tr><tr><td style=text-align:center><code>pg_admin_password</code></td><td style=text-align:left>PostgreSQL 管理员密码</td></tr><tr><td style=text-align:center><code>pg_monitor_password</code></td><td style=text-align:left>PostgreSQL 监控用户密码</td></tr><tr><td style=text-align:center><code>pg_replication_password</code></td><td style=text-align:left>PostgreSQL 复制用户密码</td></tr><tr><td style=text-align:center><code>patroni_password</code></td><td style=text-align:left>Patroni API 密码</td></tr><tr><td style=text-align:center><code>haproxy_admin_password</code></td><td style=text-align:left>HAProxy 管理密码</td></tr><tr><td style=text-align:center><code>minio_secret_key</code></td><td style=text-align:left>MinIO Secret Key</td></tr><tr><td style=text-align:center><code>etcd_root_password</code></td><td style=text-align:left>ETCD Root 密码</td></tr></tbody></table><p>同时还会替换以下占位符密码：</p><ul><li><code>DBUser.Meta</code> → 随机密码</li><li><code>DBUser.Viewer</code> → 随机密码</li><li><code>S3User.Backup</code> → 随机密码</li><li><code>S3User.Meta</code> → 随机密码</li><li><code>S3User.Data</code> → 随机密码</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./configure -g
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> generating random passwords...
</span></span><span style=display:flex><span>    grafana_admin_password   : xK9mL2nP4qR7sT1vW3yZ5bD8
</span></span><span style=display:flex><span>    pg_admin_password        : aB3cD5eF7gH9iJ1kL2mN4oP6
</span></span><span style=display:flex><span>    ...
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> random passwords generated, check and save them
</span></span></code></pre></div><hr><h2 id=配置模板>配置模板</h2><p>脚本从 <code>conf/</code> 目录读取配置模板，支持以下模板：</p><h3 id=核心模板>核心模板</h3><table class=full-width><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>meta</code></td><td style=text-align:left><strong>默认模板</strong>：单节点安装，包含 INFRA + NODE + ETCD + PGSQL</td></tr><tr><td style=text-align:center><code>rich</code></td><td style=text-align:left>功能丰富版：包含几乎所有扩展、MinIO、本地仓库</td></tr><tr><td style=text-align:center><code>slim</code></td><td style=text-align:left>精简版：仅 PostgreSQL + ETCD，无监控基础设施</td></tr><tr><td style=text-align:center><code>fat</code></td><td style=text-align:left>完整版：rich 基础上安装更多扩展</td></tr><tr><td style=text-align:center><code>pgsql</code></td><td style=text-align:left>纯 PostgreSQL 模板</td></tr><tr><td style=text-align:center><code>infra</code></td><td style=text-align:left>纯基础设施模板</td></tr></tbody></table><h3 id=高可用模板-ha>高可用模板 (<code>ha/</code>)</h3><table class=full-width><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>ha/dual</code></td><td style=text-align:left>2 节点高可用集群</td></tr><tr><td style=text-align:center><code>ha/trio</code></td><td style=text-align:left>3 节点高可用集群</td></tr><tr><td style=text-align:center><code>ha/full</code></td><td style=text-align:left>4 节点完整沙箱环境</td></tr><tr><td style=text-align:center><code>ha/safe</code></td><td style=text-align:left>安全加固版高可用配置</td></tr><tr><td style=text-align:center><code>ha/simu</code></td><td style=text-align:left>42 节点大规模仿真环境</td></tr></tbody></table><h3 id=应用模板-app>应用模板 (<code>app/</code>)</h3><table class=full-width><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>supabase</code></td><td style=text-align:left>Supabase 自托管配置</td></tr><tr><td style=text-align:center><code>app/dify</code></td><td style=text-align:left>Dify AI 平台配置</td></tr><tr><td style=text-align:center><code>app/odoo</code></td><td style=text-align:left>Odoo ERP 配置</td></tr><tr><td style=text-align:center><code>app/teable</code></td><td style=text-align:left>Teable 表格数据库配置</td></tr><tr><td style=text-align:center><code>app/registry</code></td><td style=text-align:left>Docker Registry 配置</td></tr></tbody></table><h3 id=特殊内核模板>特殊内核模板</h3><table class=full-width><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>ivory</code></td><td style=text-align:left>IvorySQL：Oracle 兼容 PostgreSQL</td></tr><tr><td style=text-align:center><code>mssql</code></td><td style=text-align:left>Babelfish：SQL Server 兼容 PostgreSQL</td></tr><tr><td style=text-align:center><code>polar</code></td><td style=text-align:left>PolarDB：阿里云开源分布式 PostgreSQL</td></tr><tr><td style=text-align:center><code>citus</code></td><td style=text-align:left>Citus：分布式 PostgreSQL</td></tr><tr><td style=text-align:center><code>oriole</code></td><td style=text-align:left>OrioleDB：新一代存储引擎</td></tr></tbody></table><h3 id=演示模板-demo>演示模板 (<code>demo/</code>)</h3><table><thead><tr><th style=text-align:center>模板</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>demo/demo</code></td><td style=text-align:left>演示环境配置</td></tr><tr><td style=text-align:center><code>demo/redis</code></td><td style=text-align:left>Redis 集群演示</td></tr><tr><td style=text-align:center><code>demo/minio</code></td><td style=text-align:left>MinIO 集群演示</td></tr></tbody></table><hr><h2 id=输出示例>输出示例</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./configure
</span></span><span style=display:flex><span>configure pigsty v4.0.0 begin
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>region</span> <span style=color:#ce5c00;font-weight:700>=</span> china
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>kernel</span>  <span style=color:#ce5c00;font-weight:700>=</span> Linux
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>machine</span> <span style=color:#ce5c00;font-weight:700>=</span> x86_64
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>package</span> <span style=color:#ce5c00;font-weight:700>=</span> rpm,dnf
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>vendor</span>  <span style=color:#ce5c00;font-weight:700>=</span> rocky <span style=color:#ce5c00;font-weight:700>(</span>Rocky Linux<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>9</span> <span style=color:#ce5c00;font-weight:700>(</span>9.5<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>sudo</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ssh</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@127.0.0.1 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> Multiple IP address candidates found:
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>1<span style=color:#ce5c00;font-weight:700>)</span> 192.168.121.193	    inet 192.168.121.193/24 brd 192.168.121.255 scope global dynamic noprefixroute eth0
</span></span><span style=display:flex><span>    <span style=color:#ce5c00;font-weight:700>(</span>2<span style=color:#ce5c00;font-weight:700>)</span> 10.10.10.10	    inet 10.10.10.10/24 brd 10.10.10.255 scope global noprefixroute eth1
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>primary_ip</span> <span style=color:#ce5c00;font-weight:700>=</span> 10.10.10.10 <span style=color:#ce5c00;font-weight:700>(</span>from demo<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>admin</span> <span style=color:#ce5c00;font-weight:700>=</span> vagrant@10.10.10.10 ok
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>mode</span> <span style=color:#ce5c00;font-weight:700>=</span> meta <span style=color:#ce5c00;font-weight:700>(</span>el9<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>locale</span>  <span style=color:#ce5c00;font-weight:700>=</span> C.UTF-8
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#000>ansible</span> <span style=color:#ce5c00;font-weight:700>=</span> ready
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span> OK <span style=color:#ce5c00;font-weight:700>]</span> pigsty configured
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>WARN<span style=color:#ce5c00;font-weight:700>]</span> don<span style=color:#a40000>&#39;</span>t forget to check it and change passwords!
</span></span><span style=display:flex><span>proceed with ./deploy.yml
</span></span></code></pre></div><hr><h2 id=环境变量>环境变量</h2><p>脚本支持以下环境变量：</p><table class=full-width><thead><tr><th style=text-align:center>环境变量</th><th style=text-align:left>说明</th><th style=text-align:center>默认值</th></tr></thead><tbody><tr><td style=text-align:center><code>PIGSTY_HOME</code></td><td style=text-align:left>Pigsty 安装目录</td><td style=text-align:center><code>~/pigsty</code></td></tr><tr><td style=text-align:center><code>METADB_URL</code></td><td style=text-align:left>元数据库连接 URL</td><td style=text-align:center><code>service=meta</code></td></tr><tr><td style=text-align:center><code>HTTP_PROXY</code></td><td style=text-align:left>HTTP 代理</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>HTTPS_PROXY</code></td><td style=text-align:left>HTTPS 代理</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>ALL_PROXY</code></td><td style=text-align:left>通用代理</td><td style=text-align:center>-</td></tr><tr><td style=text-align:center><code>NO_PROXY</code></td><td style=text-align:left>代理白名单</td><td style=text-align:center>内置默认值</td></tr></tbody></table><hr><h2 id=注意事项>注意事项</h2><ol><li><p><strong>免密访问</strong>：运行 <code>configure</code> 前，确保当前用户具有免密 sudo 权限和免密 SSH 到本机的能力。可以通过 <code>bootstrap</code> 脚本自动配置。</p></li><li><p><strong>IP 地址选择</strong>：请选择<strong>内网 IP</strong> 作为主 IP 地址，不要使用公网 IP 或 <code>127.0.0.1</code>。</p></li><li><p><strong>密码安全</strong>：生产环境<strong>务必</strong>修改配置文件中的默认密码，或使用 <code>-g</code> 参数生成随机密码。</p></li><li><p><strong>配置检查</strong>：脚本执行完成后，建议检查生成的 <code>pigsty.yml</code> 文件，确认配置符合预期。</p></li><li><p><strong>多次执行</strong>：可以多次运行 <code>configure</code> 重新生成配置，每次会覆盖现有的 <code>pigsty.yml</code>。</p></li><li><p><strong>macOS 限制</strong>：在 macOS 上运行时，脚本会跳过部分 Linux 特有的检测，并使用占位符 IP <code>10.10.10.10</code>。macOS 只能作为管理节点使用。</p></li></ol><hr><h2 id=常见问题>常见问题</h2><h3 id=如何使用自定义配置模板>如何使用自定义配置模板？</h3><p>将您的配置文件放到 <code>conf/</code> 目录下，然后使用 <code>-c</code> 参数指定：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp my-config.yml ~/pigsty/conf/myconf.yml
</span></span><span style=display:flex><span>./configure -c myconf
</span></span></code></pre></div><h3 id=如何为多集群生成不同配置>如何为多集群生成不同配置？</h3><p>使用 <code>-o</code> 参数指定不同的输出文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c ha/full -o cluster-a.yml
</span></span><span style=display:flex><span>./configure -c ha/trio -o cluster-b.yml
</span></span></code></pre></div><p>然后在执行剧本时指定配置文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy.yml -i cluster-a.yml
</span></span></code></pre></div><h3 id=非交互模式下如何处理多-ip>非交互模式下如何处理多 IP？</h3><p>必须使用 <code>-i</code> 参数明确指定 IP 地址：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -n -i 10.10.10.10
</span></span></code></pre></div><h3 id=如何保留模板中的占位符-ip>如何保留模板中的占位符 IP？</h3><p>使用 <code>-s</code> 参数跳过 IP 替换：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c ha/full -s   <span style=color:#8f5902;font-style:italic># 保留 10.10.10.10 占位符</span>
</span></span></code></pre></div><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/concept/iac/inventory/><strong>配置清单</strong></a>：了解 Ansible 配置清单的结构</li><li><a href=/docs/concept/iac/parameter/><strong>配置参数</strong></a>：了解 Pigsty 参数的层级与优先级</li><li><a href=/docs/conf/><strong>配置模板</strong></a>：查看所有可用的配置模板</li><li><a href=/docs/setup/install/><strong>安装部署</strong></a>：了解完整的安装流程</li><li><a href=/docs/concept/iac/cmdb/><strong>元数据库</strong></a>：使用 PostgreSQL 作为动态配置源</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e42d80439da940091a403ada6ca968af>3.3 - 配置参数</h1><div class=lead>使用配置参数对 Pigsty 进行精细化定制</div><p>在 <strong>配置清单</strong> 中，您可以使用各种参数对 Pigsty 进行精细化定制。这些参数涵盖了从基础设施设置到数据库配置的各个方面。</p><hr><h2 id=参数列表>参数列表</h2><p>Pigsty 提供了约 <strong>380+</strong> 个配置参数，分布在 8 个默认模块中，用于精细控制系统的各个方面，完整列表见 <a href=/docs/ref/param><strong>参考-参数列表</strong></a> 。</p><table class=stretch-last><thead><tr><th style=text-align:left>模块</th><th style=text-align:center>参数组</th><th style=text-align:center>参数数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param><strong>PGSQL</strong></a></td><td style=text-align:center>9</td><td style=text-align:center>123</td><td style=text-align:left>PostgreSQL 数据库集群的核心配置</td></tr><tr><td style=text-align:left><a href=/docs/infra/param><strong>INFRA</strong></a></td><td style=text-align:center>10</td><td style=text-align:center>82</td><td style=text-align:left>基础设施组件：软件源、Nginx、DNS、监控、Grafana 等</td></tr><tr><td style=text-align:left><a href=/docs/node/param><strong>NODE</strong></a></td><td style=text-align:center>11</td><td style=text-align:center>83</td><td style=text-align:left>主机节点调优：身份、DNS、包、调优、安全、管理员、时间、VIP等</td></tr><tr><td style=text-align:left><a href=/docs/etcd/param><strong>ETCD</strong></a></td><td style=text-align:center>2</td><td style=text-align:center>13</td><td style=text-align:left>分布式配置存储与服务发现</td></tr><tr><td style=text-align:left><a href=/docs/redis/param><strong>REDIS</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>21</td><td style=text-align:left>Redis 缓存与数据结构服务器</td></tr><tr><td style=text-align:left><a href=/docs/minio/param><strong>MINIO</strong></a></td><td style=text-align:center>2</td><td style=text-align:center>21</td><td style=text-align:left>S3 兼容对象存储服务</td></tr><tr><td style=text-align:left><a href=/docs/ferret/param><strong>FERRET</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>9</td><td style=text-align:left>MongoDB 兼容数据库 FerretDB</td></tr><tr><td style=text-align:left><a href=/docs/docker/param><strong>DOCKER</strong></a></td><td style=text-align:center>1</td><td style=text-align:center>8</td><td style=text-align:left>Docker 容器引擎</td></tr></tbody></table><hr><h2 id=参数形式>参数形式</h2><p><strong>参数</strong> 是用于描述实体的 <strong>键值对</strong>。<strong>键</strong>（Key）是字符串，<strong>值</strong>（Value）可以是五种类型之一：布尔值、字符串、数字、数组或对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># &lt;------- 顶级对象：all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># &lt;------- 全局配置参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># &lt;------- pg-meta 分组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;------- 集群级别参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># &lt;------- 主机节点 IP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;------- 实例级别参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  
</span></span></span></code></pre></div><hr><h2 id=参数优先级>参数优先级</h2><p>参数可以在不同级别设置，具有以下优先级：</p><table><thead><tr><th style=text-align:left>级别</th><th style=text-align:left>位置</th><th style=text-align:left>描述</th><th style=text-align:left>优先级</th></tr></thead><tbody><tr><td style=text-align:left><strong>命令行</strong></td><td style=text-align:left><code>-e</code> 命令行参数</td><td style=text-align:left>通过命令行传入</td><td style=text-align:left>最高 (5)</td></tr><tr><td style=text-align:left><strong>主机/实例</strong></td><td style=text-align:left><code>&lt;group>.hosts.&lt;host></code></td><td style=text-align:left>特定于单个主机的参数</td><td style=text-align:left>较高 (4)</td></tr><tr><td style=text-align:left><strong>分组/集群</strong></td><td style=text-align:left><code>&lt;group>.vars</code></td><td style=text-align:left>组/集群中主机共享的参数</td><td style=text-align:left>中等 (3)</td></tr><tr><td style=text-align:left><strong>全局</strong></td><td style=text-align:left><code>all.vars</code></td><td style=text-align:left>所有主机共享的参数</td><td style=text-align:left>较低 (2)</td></tr><tr><td style=text-align:left><strong>默认</strong></td><td style=text-align:left><code>&lt;roles>/default/main.yml</code></td><td style=text-align:left>角色实现默认值</td><td style=text-align:left>最低 (1)</td></tr></tbody></table><p>以下是关于参数优先级的一些示例：</p><ul><li>执行剧本时，使用命令行参数 <a href=/docs/infra/param#grafana_clean><strong><code>-e grafana_clean=true</code></strong></a> 来抹除 Grafana 数据</li><li>使用主机变量上的实例级别参数 <code>pg_role</code> 覆盖 pg 实例角色</li><li>使用组变量上的集群级别参数 <code>pg_cluster</code> 覆盖 pg 集群名称。</li><li>使用全局变量上的全局参数 <code>node_ntp_servers</code> 指定全局 NTP 服务器</li><li>如果没有设置 <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a>，Pigsty 将使用 <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/defaults/main.yml#L42><strong><code>pgsql</code></strong></a> 角色实现的默认值（默认为 <code>18</code>）</li></ul><p>除了<strong>身份参数</strong> 外，每个参数都有适当的默认值，因此无需显式设置。</p><hr><h2 id=身份参数>身份参数</h2><p>身份参数是特殊的参数，它们会作为实体的 ID 标识符，因此 <strong>没有默认值</strong>，必须 <strong>显式设置</strong>。</p><table><thead><tr><th style=text-align:left>模块</th><th style=text-align:left>身份参数</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_id><strong><code>PGSQL</code></strong></a></td><td style=text-align:left><code>pg_cluster</code>, <code>pg_seq</code>, <code>pg_role</code>, &mldr;</td></tr><tr><td style=text-align:left><a href=/docs/node/param#node_id><strong><code>NODE</code></strong></a></td><td style=text-align:left><code>nodename</code>, <code>node_cluster</code></td></tr><tr><td style=text-align:left><a href=/docs/etcd/param#etcd><strong><code>ETCD</code></strong></a></td><td style=text-align:left><code>etcd_cluster</code>, <code>etcd_seq</code></td></tr><tr><td style=text-align:left><a href=/docs/minio/param#minio><strong><code>MINIO</code></strong></a></td><td style=text-align:left><code>minio_cluster</code>, <code>minio_seq</code></td></tr><tr><td style=text-align:left><a href=/docs/redis/param/><strong><code>REDIS</code></strong></a></td><td style=text-align:left><code>redis_cluster</code>, <code>redis_node</code>, <code>redis_instances</code></td></tr><tr><td style=text-align:left><a href=/docs/infra/param#infra_id><strong><code>INFRA</code></strong></a></td><td style=text-align:left><code>infra_seq</code></td></tr></tbody></table><p>例外是，<a href=/docs/etcd/param#etcd_cluster><strong><code>etcd_cluster</code></strong></a> 与 <a href=/docs/minio/param#minio_cluster><strong><code>minio_cluster</code></strong></a> 有默认值。
它假设每套部署只有一套 etcd 集群用于 DCS，和一套可选 MinIO 集群用于集中备份存储，因此为其分配了默认的集群名称 <code>etcd</code> 与 <code>minio</code>。
但您依然可以使用其他名称部署多套 etcd 或 MinIO 集群。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a71a0b133f9617fabea630bbd56757f4>3.4 - 配置模板</h1><div class=lead>使用预制的配置模板，快速生成适配当前环境的配置文件</div><p>在 Pigsty 中，部署的蓝图细节由 <a href=/docs/setup/config/><strong>配置清单</strong></a> 所定义，也就是 <a href=https://github.com/pgsty/pigsty/blob/main/pigsty.yml><strong><code>pigsty.yml</code></strong></a> 配置文件，您可以通过声明式配置进行定制。</p><p>然而，直接编写配置文件可能会让新用户望而生畏。为此，我们提供了一些开箱即用的配置模板，涵盖了常见的使用场景。</p><p>每一个模板都是一个预定义的 <code>pigsty.yml</code> 配置文件，包含了适用于特定场景的合理默认值。</p><p>您可以根据自己的需要，选择一个模板作为定制起点，然后根据需要进行修改，以满足您的具体需求。</p><hr><h2 id=使用模板>使用模板</h2><p>Pigsty 提供了 <a href=https://github.com/pgsty/pigsty/blob/main/configure><strong><code>configure</code></strong></a> 脚本作为可选的配置向导，它将根据您的环境和输入，生成具有良好默认值的 <a href=/docs/setup/config/><strong>配置清单</strong></a>。</p><p>使用 <code>./configure -c &lt;conf></code> 指定配置模板，其中 <code>&lt;conf></code> 是相对于 <code>conf</code> 目录的路径（可省略 <code>.yml</code> 后缀）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure                     <span style=color:#8f5902;font-style:italic># 默认使用 meta.yml 配置模板</span>
</span></span><span style=display:flex><span>./configure -c meta             <span style=color:#8f5902;font-style:italic># 显式指定使用 meta.yml 单节点模板</span>
</span></span><span style=display:flex><span>./configure -c rich             <span style=color:#8f5902;font-style:italic># 使用包含全部扩展与 MinIO 的富功能模板</span>
</span></span><span style=display:flex><span>./configure -c slim             <span style=color:#8f5902;font-style:italic># 使用最小化的单节点模板</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用不同的数据库内核</span>
</span></span><span style=display:flex><span>./configure -c pgsql            <span style=color:#8f5902;font-style:italic># 原生 PostgreSQL 内核，基础功能 (13~18)</span>
</span></span><span style=display:flex><span>./configure -c citus            <span style=color:#8f5902;font-style:italic># Citus 分布式高可用 PostgreSQL (14~17)</span>
</span></span><span style=display:flex><span>./configure -c mssql            <span style=color:#8f5902;font-style:italic># Babelfish 内核，兼容 SQL Server 协议 (15)</span>
</span></span><span style=display:flex><span>./configure -c polar            <span style=color:#8f5902;font-style:italic># PolarDB PG 内核，Aurora/RAC 风格 (15)</span>
</span></span><span style=display:flex><span>./configure -c ivory            <span style=color:#8f5902;font-style:italic># IvorySQL 内核，兼容 Oracle 语法 (18)</span>
</span></span><span style=display:flex><span>./configure -c mysql            <span style=color:#8f5902;font-style:italic># OpenHalo 内核，兼容 MySQL (14)</span>
</span></span><span style=display:flex><span>./configure -c pgtde            <span style=color:#8f5902;font-style:italic># Percona PostgreSQL Server 透明加密 (18)</span>
</span></span><span style=display:flex><span>./configure -c oriole           <span style=color:#8f5902;font-style:italic># OrioleDB 内核，OLTP 增强 (17)</span>
</span></span><span style=display:flex><span>./configure -c supabase         <span style=color:#8f5902;font-style:italic># Supabase 自托管配置 (15~18)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用多节点高可用模板</span>
</span></span><span style=display:flex><span>./configure -c ha/dual          <span style=color:#8f5902;font-style:italic># 使用 2 节点高可用模板</span>
</span></span><span style=display:flex><span>./configure -c ha/trio          <span style=color:#8f5902;font-style:italic># 使用 3 节点高可用模板</span>
</span></span><span style=display:flex><span>./configure -c ha/full          <span style=color:#8f5902;font-style:italic># 使用 4 节点高可用模板</span>
</span></span></code></pre></div><p>如果不指定模板，Pigsty 默认使用 <code>meta.yml</code> 单节点配置模板。</p><hr><h2 id=模板列表>模板列表</h2><h3 id=主要模板>主要模板</h3><p>以下是单节点配置模板，可用于在单台服务器上安装 Pigsty：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/meta/><strong><code>meta.yml</code></strong></a></td><td><strong>默认模板</strong>，单节点 PostgreSQL 在线安装</td></tr><tr><td><a href=/docs/conf/rich/><strong><code>rich.yml</code></strong></a></td><td>富功能模板，包含本地软件源、MinIO 及更多示例</td></tr><tr><td><a href=/docs/conf/slim/><strong><code>slim.yml</code></strong></a></td><td>精简模板，仅安装 PostgreSQL，不含监控与基础设施</td></tr></tbody></table><h3 id=数据库内核模板>数据库内核模板</h3><p>适用于各类数据库管理系统与内核的模板：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/pgsql/><strong><code>pgsql.yml</code></strong></a></td><td>原生 PostgreSQL 内核，基础功能 (13~18)</td></tr><tr><td><a href=/docs/conf/citus/><strong><code>citus.yml</code></strong></a></td><td>Citus 分布式高可用 PostgreSQL (14~17)</td></tr><tr><td><a href=/docs/conf/mssql/><strong><code>mssql.yml</code></strong></a></td><td>Babelfish 内核，兼容 SQL Server 协议 (15)</td></tr><tr><td><a href=/docs/conf/polar/><strong><code>polar.yml</code></strong></a></td><td>PolarDB PG 内核，Aurora/RAC 风格 (15)</td></tr><tr><td><a href=/docs/conf/ivory/><strong><code>ivory.yml</code></strong></a></td><td>IvorySQL 内核，兼容 Oracle 语法 (17)</td></tr><tr><td><a href=/docs/conf/mysql/><strong><code>mysql.yml</code></strong></a></td><td>OpenHalo 内核，兼容 MySQL (14)</td></tr><tr><td><a href=/docs/conf/pgtde/><strong><code>pgtde.yml</code></strong></a></td><td>Percona PostgreSQL Server 透明加密 (17)</td></tr><tr><td><a href=/docs/conf/oriole/><strong><code>oriole.yml</code></strong></a></td><td>OrioleDB 内核，OLTP 增强 (17，Debian 包暂缺)</td></tr><tr><td><a href=/docs/conf/supabase/><strong><code>supabase.yml</code></strong></a></td><td>Supabase 自托管配置 (15~17)</td></tr></tbody></table><p>您可以后续添加更多节点，或使用 <a href=#%E9%AB%98%E5%8F%AF%E7%94%A8%E6%A8%A1%E6%9D%BF>高可用模板</a> 在一开始就规划好集群。</p><hr><h3 id=高可用模板>高可用模板</h3><p>您可以配置 Pigsty 在多节点上运行，组成高可用（HA）集群：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/dual/><strong><code>dual.yml</code></strong></a></td><td>2 节点半高可用部署</td></tr><tr><td><a href=/docs/conf/trio/><strong><code>trio.yml</code></strong></a></td><td>3 节点标准高可用部署</td></tr><tr><td><a href=/docs/conf/full/><strong><code>full.yml</code></strong></a></td><td>4 节点标准部署</td></tr><tr><td><a href=/docs/conf/safe/><strong><code>safe.yml</code></strong></a></td><td>4 节点安全增强部署，含延迟从库</td></tr><tr><td><a href=/docs/conf/simu/><strong><code>simu.yml</code></strong></a></td><td>20 节点生产环境模拟</td></tr></tbody></table><hr><h3 id=应用模板>应用模板</h3><p>您可以使用以下模板运行 Docker 应用/软件：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/supabase/><strong><code>supa.yml</code></strong></a></td><td>启动单节点 Supabase</td></tr><tr><td><a href=/docs/conf/odoo/><strong><code>odoo.yml</code></strong></a></td><td>启动 Odoo ERP 系统</td></tr><tr><td><a href=/docs/conf/dify/><strong><code>dify.yml</code></strong></a></td><td>启动 Dify AI 工作流系统</td></tr><tr><td><a href=/docs/conf/electric/><strong><code>electric.yml</code></strong></a></td><td>启动 Electric 同步引擎</td></tr></tbody></table><hr><h3 id=演示模板>演示模板</h3><p>除主要模板外，Pigsty 还提供了一组面向不同场景的演示模板：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/conf/el/><strong><code>el.yml</code></strong></a></td><td>EL 8/9 系统的全参数配置文件</td></tr><tr><td><a href=/docs/conf/debian/><strong><code>debian.yml</code></strong></a></td><td>Debian/Ubuntu 系统的全参数配置文件</td></tr><tr><td><strong><code>remote.yml</code></strong></td><td>监控远程 PostgreSQL 集群或 RDS 的示例配置</td></tr><tr><td><strong><code>redis.yml</code></strong></td><td>Redis 集群示例配置</td></tr><tr><td><a href=/docs/conf/minio/><strong><code>minio.yml</code></strong></a></td><td>3 节点 MinIO 集群示例配置</td></tr><tr><td><a href=/docs/conf/demo/><strong><code>demo.yml</code></strong></a></td><td>Pigsty <a href=https://demo.pigsty.cc>公开演示站</a> 的配置文件</td></tr></tbody></table><hr><h3 id=构建模板>构建模板</h3><p>以下配置模板用于开发和测试目的：</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><strong><code>build.yml</code></strong></td><td>EL 9/10、Debian 12/13、Ubuntu 22.04/24.04 开源构建配置</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-4f710b6522c00bd4a1ee261283a935b7>3.5 - 元数据库</h1><div class=lead>使用 PostgreSQL 作为 CMDB 元数据库，存储 Ansible 配置清单。</div><p>Pigsty 允许您使用 PostgreSQL <strong>元数据库</strong> 作为动态配置源，取代静态的 YAML 配置文件，实现更强大的配置管理能力。</p><hr><h2 id=概览>概览</h2><p><strong>CMDB</strong>（Configuration Management Database，配置管理数据库）是一种将配置信息存储在数据库中进行管理的方式。</p><p>在 Pigsty 中，默认的配置源是一个静态 YAML 文件 <code>pigsty.yml</code>，
它作为 Ansible 的 <a href=/docs/concept/iac/inventory/><strong>配置清单</strong></a> 使用。</p><p>这种方式简单直接，但当基础设施规模扩大、需要复杂精细的管理与外部集成时，单一的静态文件难以满足需求。</p><table class=full-width><thead><tr><th style=text-align:center>特性</th><th style=text-align:left>静态 YAML 文件</th><th style=text-align:left>CMDB 元数据库</th></tr></thead><tbody><tr><td style=text-align:center><strong>查询能力</strong></td><td style=text-align:left>手工搜索/grep</td><td style=text-align:left>SQL 任意条件查询，聚合分析</td></tr><tr><td style=text-align:center><strong>版本控制</strong></td><td style=text-align:left>依赖 Git 或手工备份</td><td style=text-align:left>数据库事务，审计日志，时间旅行快照</td></tr><tr><td style=text-align:center><strong>权限控制</strong></td><td style=text-align:left>文件系统权限，粗粒度</td><td style=text-align:left>PostgreSQL 数据库精细访问控制</td></tr><tr><td style=text-align:center><strong>并发编辑</strong></td><td style=text-align:left>需要锁文件或合并冲突</td><td style=text-align:left>数据库事务天然支持并发</td></tr><tr><td style=text-align:center><strong>外部集成</strong></td><td style=text-align:left>需要解析 YAML</td><td style=text-align:left>标准 SQL 接口，任意语言轻松对接</td></tr><tr><td style=text-align:center><strong>规模扩展</strong></td><td style=text-align:left>文件过大时难以维护</td><td style=text-align:left>管理规模伸缩至物理极限</td></tr><tr><td style=text-align:center><strong>动态生成</strong></td><td style=text-align:left>静态文件，修改后需手动应用</td><td style=text-align:left>即时生效，实时反映配置变更</td></tr></tbody></table><p>Pigsty 在样板数据库 <a href=https://github.com/pgsty/pigsty/blob/main/conf/meta.yml#L52><strong><code>pg-meta.meta</code></strong></a> 的模式基线定义中，提供了 Pigsty CMDB 的数据库模式。</p><hr><h2 id=工作原理>工作原理</h2><p>CMDB 的核心思想是用一个 <strong>动态脚本</strong> 替换静态配置文件。
Ansible 支持使用可执行脚本作为配置清单，只要脚本输出符合 JSON 格式的清单数据即可。
当您启用 CMDB 后，Pigsty 会创建一个名为 <code>inventory.sh</code> 的动态清单脚本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span>psql <span style=color:#4e9a06>${</span><span style=color:#000>METADB_URL</span><span style=color:#4e9a06>}</span> -AXtwc <span style=color:#4e9a06>&#39;SELECT text FROM pigsty.inventory;&#39;</span>
</span></span></code></pre></div><p>这个脚本的作用很简单：每次 Ansible 需要读取配置清单时，它会从 PostgreSQL 数据库的 <code>pigsty.inventory</code> 视图中查询配置数据，并以 JSON 格式返回。</p><p>整体架构如下：</p><pre class=mermaid>flowchart LR
    conf[&#34;bin/inventory_conf&#34;]
    tocmdb[&#34;bin/inventory_cmdb&#34;]
    load[&#34;bin/inventory_load&#34;]
    ansible[&#34;🚀 Ansible&#34;]

    subgraph static[&#34;📄 静态配置模式&#34;]
        yml[(&#34;pigsty.yml&#34;)]
    end

    subgraph dynamic[&#34;🗄️ CMDB 动态模式&#34;]
        sh[&#34;inventory.sh&#34;]
        cmdb[(&#34;PostgreSQL CMDB&#34;)]
    end

    conf --&gt;|&#34;切换&#34;| yml
    yml --&gt;|&#34;加载配置&#34;| load
    load --&gt;|&#34;写入&#34;| cmdb
    tocmdb --&gt;|&#34;切换&#34;| sh
    sh --&gt; cmdb

    yml --&gt; ansible
    cmdb --&gt; ansible</pre><hr><h2 id=数据模型>数据模型</h2><p>CMDB 的数据库模式定义在 <a href=https://github.com/pgsty/pigsty/blob/main/files/cmdb.sql><code>files/cmdb.sql</code></a> 文件中，所有对象都位于 <code>pigsty</code> 模式下。</p><h3 id=核心数据表>核心数据表</h3><table class=full-width><thead><tr><th style=text-align:center>表名</th><th style=text-align:left>说明</th><th style=text-align:center>主键</th></tr></thead><tbody><tr><td style=text-align:center><code>pigsty.group</code></td><td style=text-align:left>集群/分组定义，对应 Ansible 的 group</td><td style=text-align:center><code>cls</code></td></tr><tr><td style=text-align:center><code>pigsty.host</code></td><td style=text-align:left>主机定义，属于某个分组</td><td style=text-align:center><code>(cls, ip)</code></td></tr><tr><td style=text-align:center><code>pigsty.global_var</code></td><td style=text-align:left>全局变量，对应 <code>all.vars</code></td><td style=text-align:center><code>key</code></td></tr><tr><td style=text-align:center><code>pigsty.group_var</code></td><td style=text-align:left>分组变量，对应 <code>all.children.&lt;cls>.vars</code></td><td style=text-align:center><code>(cls, key)</code></td></tr><tr><td style=text-align:center><code>pigsty.host_var</code></td><td style=text-align:left>主机变量，对应主机级别的变量</td><td style=text-align:center><code>(cls, ip, key)</code></td></tr><tr><td style=text-align:center><code>pigsty.default_var</code></td><td style=text-align:left>默认变量定义，存储参数的元信息</td><td style=text-align:center><code>key</code></td></tr><tr><td style=text-align:center><code>pigsty.job</code></td><td style=text-align:left>作业记录表，记录执行的任务</td><td style=text-align:center><code>id</code></td></tr></tbody></table><h3 id=表结构详解>表结构详解</h3><p><strong>集群表 <code>pigsty.group</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>     </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- 集群名称，主键
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ctime</span><span style=color:#f8f8f8>   </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>-- 创建时间
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8>   </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- 修改时间
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>主机表 <code>pigsty.host</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>    </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- 所属集群
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ip</span><span style=color:#f8f8f8>     </span><span style=color:#000>INET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic>-- 主机 IP 地址
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ctime</span><span style=color:#f8f8f8>  </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8>  </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>全局变量表 <code>pigsty.global_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 变量名
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic>-- 变量值（JSON 格式）
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- 修改时间
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>分组变量表 <code>pigsty.group_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>主机变量表 <code>pigsty.host_var</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>host_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>cls</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>ip</span><span style=color:#f8f8f8>    </span><span style=color:#000>INET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8>   </span><span style=color:#204a87>TEXT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#000>JSONB</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#000>TIMESTAMPTZ</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>(),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>PRIMARY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>FOREIGN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>KEY</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REFERENCES</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=核心视图>核心视图</h3><p>CMDB 提供了一系列视图，用于查询和展示配置数据：</p><table class=full-width><thead><tr><th style=text-align:center>视图名</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><code>pigsty.inventory</code></td><td style=text-align:left><strong>核心视图</strong>：生成 Ansible 动态清单 JSON</td></tr><tr><td style=text-align:center><code>pigsty.raw_config</code></td><td style=text-align:left>原始配置的 JSON 格式展示</td></tr><tr><td style=text-align:center><code>pigsty.global_config</code></td><td style=text-align:left>全局配置视图，合并默认值和全局变量</td></tr><tr><td style=text-align:center><code>pigsty.group_config</code></td><td style=text-align:left>分组配置视图，包含主机列表和分组变量</td></tr><tr><td style=text-align:center><code>pigsty.host_config</code></td><td style=text-align:left>主机配置视图，合并分组和主机级别变量</td></tr><tr><td style=text-align:center><code>pigsty.pg_cluster</code></td><td style=text-align:left>PostgreSQL 集群视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_instance</code></td><td style=text-align:left>PostgreSQL 实例视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_database</code></td><td style=text-align:left>PostgreSQL 数据库定义视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_users</code></td><td style=text-align:left>PostgreSQL 用户定义视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_service</code></td><td style=text-align:left>PostgreSQL 服务定义视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_hba</code></td><td style=text-align:left>PostgreSQL HBA 规则视图</td></tr><tr><td style=text-align:center><code>pigsty.pg_remote</code></td><td style=text-align:left>远程 PostgreSQL 实例视图</td></tr></tbody></table><p><strong><code>pigsty.inventory</code></strong> 是最核心的视图，它将数据库中的配置数据转换为 Ansible 所需的 JSON 格式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87>text</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inventory</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=工具脚本>工具脚本</h2><p>Pigsty 提供了三个便利脚本来管理 CMDB：</p><table class=full-width><thead><tr><th style=text-align:center>脚本</th><th style=text-align:left>功能</th></tr></thead><tbody><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_load><code>bin/inventory_load</code></a></td><td style=text-align:left>将 YAML 配置文件加载到 PostgreSQL 数据库中</td></tr><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_cmdb><code>bin/inventory_cmdb</code></a></td><td style=text-align:left>切换配置源为 CMDB（动态清单脚本）</td></tr><tr><td style=text-align:center><a href=https://github.com/pgsty/pigsty/blob/main/bin/inventory_conf><code>bin/inventory_conf</code></a></td><td style=text-align:left>切换配置源为静态配置文件 <code>pigsty.yml</code></td></tr></tbody></table><h3 id=inventory_load>inventory_load</h3><p>将 YAML 配置文件解析并导入到 CMDB 中：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_load                     <span style=color:#8f5902;font-style:italic># 加载默认的 pigsty.yml 到默认 CMDB</span>
</span></span><span style=display:flex><span>bin/inventory_load -p /path/to/conf.yml  <span style=color:#8f5902;font-style:italic># 指定配置文件路径</span>
</span></span><span style=display:flex><span>bin/inventory_load -d <span style=color:#4e9a06>&#34;postgres://...&#34;</span>   <span style=color:#8f5902;font-style:italic># 指定数据库连接 URL</span>
</span></span><span style=display:flex><span>bin/inventory_load -n myconfig           <span style=color:#8f5902;font-style:italic># 指定配置名称</span>
</span></span></code></pre></div><p>脚本会执行以下操作：</p><ol><li>清空 <code>pigsty</code> 模式中的现有数据</li><li>解析 YAML 配置文件</li><li>将全局变量写入 <code>global_var</code> 表</li><li>将集群定义写入 <code>group</code> 表</li><li>将集群变量写入 <code>group_var</code> 表</li><li>将主机定义写入 <code>host</code> 表</li><li>将主机变量写入 <code>host_var</code> 表</li></ol><p><strong>环境变量</strong></p><ul><li><code>PIGSTY_HOME</code>：Pigsty 安装目录，默认为 <code>~/pigsty</code></li><li><code>METADB_URL</code>：数据库连接 URL，默认为 <code>service=meta</code></li></ul><h3 id=inventory_cmdb>inventory_cmdb</h3><p>切换 Ansible 使用 CMDB 作为配置源：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_cmdb
</span></span></code></pre></div><p>脚本会执行以下操作：</p><ol><li>创建动态清单脚本 <code>${PIGSTY_HOME}/inventory.sh</code></li><li>修改 <code>ansible.cfg</code> 将 <code>inventory</code> 设置为 <code>inventory.sh</code></li></ol><p>生成的 <code>inventory.sh</code> 内容如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#!/bin/bash
</span></span></span><span style=display:flex><span>psql <span style=color:#4e9a06>${</span><span style=color:#000>METADB_URL</span><span style=color:#4e9a06>}</span> -AXtwc <span style=color:#4e9a06>&#39;SELECT text FROM pigsty.inventory;&#39;</span>
</span></span></code></pre></div><h3 id=inventory_conf>inventory_conf</h3><p>切换回使用静态 YAML 配置文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_conf
</span></span></code></pre></div><p>脚本会修改 <code>ansible.cfg</code> 将 <code>inventory</code> 设置回 <code>pigsty.yml</code>。</p><hr><h2 id=使用流程>使用流程</h2><h3 id=首次启用-cmdb>首次启用 CMDB</h3><ol><li><strong>初始化 CMDB 模式</strong>（通常在安装 Pigsty 时已自动完成）：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -f ~/pigsty/files/cmdb.sql
</span></span></code></pre></div><ol start=2><li><strong>加载配置到数据库</strong>：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_load
</span></span></code></pre></div><ol start=3><li><strong>切换到 CMDB 模式</strong>：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_cmdb
</span></span></code></pre></div><ol start=4><li><strong>验证配置</strong>：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible all --list-hosts          <span style=color:#8f5902;font-style:italic># 列出所有主机</span>
</span></span><span style=display:flex><span>ansible-inventory --list          <span style=color:#8f5902;font-style:italic># 查看完整清单</span>
</span></span></code></pre></div><h3 id=查询配置>查询配置</h3><p>启用 CMDB 后，您可以使用 SQL 灵活查询配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有集群
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看某集群的所有主机
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看全局变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看某集群的变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有 PostgreSQL 集群
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_databases</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_users</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_cluster</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有 PostgreSQL 实例
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ins</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>seq</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_instance</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有数据库定义
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_database</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有用户定义
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>login</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>superuser</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_users</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=修改配置>修改配置</h3><p>您可以直接通过 SQL 修改配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 添加新集群
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 添加集群变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_cluster&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;pg-new&#34;&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 添加主机
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 添加主机变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>host_var</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ip</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VALUES</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_seq&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;1&#39;</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg-new&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10.10.10.20&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_role&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;primary&#34;&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 修改全局变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;new-value&#34;&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;some_param&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 删除集群（级联删除主机和变量）
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DELETE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>group</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>cls</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg-old&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>修改后立即生效，无需重新加载或重启任何服务。</p><h3 id=切换回静态配置>切换回静态配置</h3><p>如需切换回静态配置文件模式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/inventory_conf
</span></span></code></pre></div><hr><h2 id=高级用法>高级用法</h2><h3 id=配置导出>配置导出</h3><p>将 CMDB 中的配置导出为 YAML 格式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#000>service</span><span style=color:#ce5c00;font-weight:700>=</span>meta -AXtwc <span style=color:#4e9a06>&#34;SELECT jsonb_pretty(jsonb_build_object(&#39;all&#39;, jsonb_build_object(&#39;children&#39;, children, &#39;vars&#39;, vars))) FROM pigsty.raw_config;&#34;</span>
</span></span></code></pre></div><p>或者使用 <code>ansible-inventory</code> 命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible-inventory --list --yaml &gt; exported_config.yml
</span></span></code></pre></div><h3 id=配置审计>配置审计</h3><p>利用 <code>mtime</code> 字段追踪配置变更：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看最近修改的全局变量
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>value</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>global_var</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看某时间点之后的变更
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>group_var</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>mtime</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-01-01&#39;</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>timestamptz</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=与外部系统集成>与外部系统集成</h3><p>CMDB 使用标准 PostgreSQL，可以轻松与其他系统集成：</p><ul><li><strong>Web 管理界面</strong>：通过 REST API（如 PostgREST）暴露配置数据</li><li><strong>CI/CD 流水线</strong>：在部署脚本中直接读写数据库</li><li><strong>监控告警</strong>：基于配置数据生成监控规则</li><li><strong>ITSM 系统</strong>：与企业 CMDB 系统同步</li></ul><hr><h2 id=注意事项>注意事项</h2><ol><li><p><strong>数据一致性</strong>：修改配置后，需要重新执行相应的 Ansible 剧本才能将变更应用到实际环境</p></li><li><p><strong>备份</strong>：CMDB 中的配置数据非常重要，请确保定期备份</p></li><li><p><strong>权限</strong>：建议为 CMDB 配置适当的数据库访问权限，避免误操作</p></li><li><p><strong>事务</strong>：批量修改配置时，建议在事务中进行，以便出错时回滚</p></li><li><p><strong>连接池</strong>：<code>inventory.sh</code> 脚本每次执行都会建立新连接，如果 Ansible 执行频繁，建议考虑使用连接池</p></li></ol><hr><h2 id=小结>小结</h2><p>CMDB 是 Pigsty 配置管理的高级方案，适用于需要管理大量集群、复杂查询、外部集成或精细权限控制的场景。通过将配置数据存储在 PostgreSQL 中，您可以充分利用数据库的强大能力来管理基础设施配置。</p><table class=full-width><thead><tr><th style=text-align:center>功能</th><th style=text-align:center>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong>数据存储</strong></td><td style=text-align:center>PostgreSQL <code>pigsty</code> 模式</td></tr><tr><td style=text-align:center><strong>动态清单</strong></td><td style=text-align:center><code>inventory.sh</code> 脚本</td></tr><tr><td style=text-align:center><strong>配置加载</strong></td><td style=text-align:center><code>bin/inventory_load</code></td></tr><tr><td style=text-align:center><strong>切换到 CMDB</strong></td><td style=text-align:center><code>bin/inventory_cmdb</code></td></tr><tr><td style=text-align:center><strong>切换到 YAML</strong></td><td style=text-align:center><code>bin/inventory_conf</code></td></tr><tr><td style=text-align:center><strong>核心视图</strong></td><td style=text-align:center><code>pigsty.inventory</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-611f3486b406a3e3cb452cbc6af4b548>4 - PG 高可用</h1><div class=lead>Pigsty 使用 Patroni 实现了 PostgreSQL 的高可用，确保主库不可用时自动进行故障转移，由从库接管。</div><hr><h2 id=概览>概览</h2><p>Pigsty 的 PostgreSQL 集群带有开箱即用的高可用方案，由 <a href=https://patroni.readthedocs.io/en/latest/><strong>Patroni</strong></a>、<a href=https://etcd.io/><strong>Etcd</strong></a> 和 <a href=http://www.haproxy.org/><strong>HAProxy</strong></a> 强力驱动。</p><p>当您的 PostgreSQL 集群含有两个或更多实例时，您无需任何配置即拥有了硬件故障自愈的数据库高可用能力 —— 只要集群中有任意实例存活，集群就可以对外提供完整的服务，而客户端只要连接至集群中的任意节点，即可获得完整的服务，而无需关心主从拓扑变化。</p><p>在默认配置下，主库故障恢复时间目标 RTO ≈ 45s，数据恢复点目标 RPO &lt; 1MB；从库故障 RPO = 0，RTO ≈ 0 (闪断)；在一致性优先模式下，可确保故障切换数据零损失：
RPO = 0。以上指标均可通过参数，根据您的实际硬件条件与可靠性要求 <a href=/docs/concept/ha/rto><strong>按需配置</strong></a>。</p><p>Pigsty 内置了 HAProxy 负载均衡器用于自动流量切换，提供 DNS/VIP/LVS 等多种接入方式供客户端选用。故障切换与主动切换对业务侧除零星闪断外几乎无感知，应用不需要修改连接串重启。
极小的维护窗口需求带来了极大的灵活便利：您完全可以在无需应用配合的情况下滚动维护升级整个集群。硬件故障可以等到第二天再抽空善后处置的特性，让研发，运维与 DBA 都能在故障时安心睡个好觉。</p><p><del><img src=/img/pigsty/ha.png alt=pigsty-ha></del></p><p>许多大型组织与核心机构已经在生产环境中长时间使用 Pigsty ，最大的部署有 25K CPU 核心与 220+ PostgreSQL 超大规格实例（64c / 512g / 3TB NVMe SSD）；在这一部署案例中，五年内经历了数十次硬件故障与各类事故，但依然可以保持高于 <strong>99.999%</strong> 的总体可用性战绩。</p><hr><p><strong>高可用（High-Availability）解决什么问题？</strong></p><ul><li>将数据安全C/IA中的可用性提高到一个新高度：RPO ≈ 0, RTO &lt; 45s。</li><li>获得无缝滚动维护的能力，最小化维护窗口需求，带来极大便利。</li><li>硬件故障可以立即自愈，无需人工介入，运维DBA可以睡个好觉。</li><li>从库可以用于承载只读请求，分担主库负载，让资源得以充分利用。</li></ul><p><strong>高可用有什么代价？</strong></p><ul><li>基础设施依赖：高可用需要依赖 DCS (etcd/zk/consul) 提供共识。</li><li>起步门槛增加：一个有意义的高可用部署环境至少需要 <strong>三个节点</strong>。</li><li>额外的资源消耗：一个新从库就要消耗一份额外资源，不算大问题。</li><li>复杂度代价显著升高：备份成本显著加大，需要使用工具压制复杂度。</li></ul><p><strong>高可用的局限性</strong></p><p>因为复制实时进⾏，所有变更被⽴即应⽤⾄从库。因此基于流复制的高可用方案⽆法应对⼈为错误与软件缺陷导致的数据误删误改。（例如：<code>DROP TABLE</code>，或 <code>DELETE</code> 数据）
此类故障需要使用 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4><strong>延迟集群</strong></a>，或使用先前的基础备份与 WAL 归档进行 <a href=/docs/concept/pitr><strong>时间点恢复</strong></a>。</p><table><thead><tr><th style=text-align:left>配置策略</th><th>RTO</th><th style=text-align:left>RPO</th></tr></thead><tbody><tr><td style=text-align:left>单机 + <i class="fa-solid fa-music text-danger"></i> 什么也不做</td><td><i class="fas fa-circle-xmark text-danger"></i> <strong>数据永久丢失，无法恢复</strong></td><td style=text-align:left><i class="fas fa-circle-xmark text-danger"></i> <strong>数据全部丢失</strong></td></tr><tr><td style=text-align:left>单机 + <i class="fa-solid fa-copy text-secondary"></i> 基础备份</td><td><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 取决于备份大小与带宽（几小时）</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 丢失上一次备份后的数据（几个小时到几天）</td></tr><tr><td style=text-align:left>单机 + <i class="fa-solid fa-copy text-primary"></i> 基础备份 + <i class="fa-solid fa-clock-rotate-left text-primary"></i> WAL归档</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> 取决于备份大小与带宽（几小时）</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-primary"></i> 丢失最后尚未归档的数据（几十MB）</td></tr><tr><td style=text-align:left>主从 + <i class="fa-solid fa-wrench text-secondary"></i> 手工故障切换</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> 十分钟</td><td style=text-align:left><i class="fa-solid fa-circle-check text-primary"></i> 丢失复制延迟中的数据（约百KB）</td></tr><tr><td style=text-align:left>主从 + <i class="fa-solid fa-infinity text-primary"></i> 自动故障切换</td><td><i class="fa-solid fa-circle-check text-primary"></i> 一分钟内</td><td style=text-align:left><i class="fa-solid fa-circle-check text-primary"></i> 丢失复制延迟中的数据（约百KB）</td></tr><tr><td style=text-align:left>主从 + <i class="fa-solid fa-infinity text-primary"></i> 自动故障切换 + <i class="fa-solid fa-rotate text-success"></i> 同步提交</td><td><i class="fa-solid fa-circle-check text-success"></i> 一分钟内</td><td style=text-align:left><i class="fa-solid fa-circle-check text-success"></i> 无数据丢失</td></tr></tbody></table><hr><h2 id=原理>原理</h2><p>在 Pigsty 中，高可用架构的实现原理如下：</p><ul><li>PostgreSQL 使⽤标准流复制搭建物理从库，主库故障时由从库接管。</li><li>Patroni 负责管理 PostgreSQL 服务器进程，处理高可用相关事宜。</li><li>Etcd 提供分布式配置存储（DCS）能力，并用于故障后的领导者选举</li><li>Patroni 依赖 Etcd 达成集群领导者共识，并对外提供健康检查接口。</li><li>HAProxy 对外暴露集群服务，并利⽤ Patroni 健康检查接口，自动分发流量至健康节点。</li><li>vip-manager 提供一个可选的二层 VIP，从 Etcd 中获取领导者信息，并将 VIP 绑定在集群主库所在节点上。</li></ul><p>当主库故障时，将触发新一轮领导者竞选，集群中最为健康的从库将胜出（LSN位点最高，数据损失最小者），并被提升为新的主库。 胜选从库提升后，读写流量将立即路由至新的主库。
主库故障影响是 <strong>写服务短暂不可用</strong>：从主库故障到新主库提升期间，写入请求将被阻塞或直接失败，不可用时长通常在 15秒 ～ 30秒，通常不会超过 1 分钟。</p><p>当从库故障时，只读流量将路由至其他从库，如果所有从库都故障，只读流量才会最终由主库承载。
从库故障的影响是 <strong>部分只读查询闪断</strong>：当前从库上正在运行查询将由于连接重置而中止，并立即由其他可用从库接管。</p><p>故障检测由 Patroni 和 Etcd 共同完成，集群领导者将持有一个租约，
如果集群领导者因为故障而没有及时续租（10s），租约将会被释放，并触发 <strong>故障切换</strong>（Failover） 与新一轮集群选举。</p><p>即使没有出现任何故障，您依然可以主动通过 <a href=/docs/pgsql/admin/patroni#%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2><strong>主动切换</strong></a>（Switchover）变更集群的主库。
在这种情况下，主库上的写入查询将会闪断，并立即路由至新主库执行。这一操作通常可用于滚动维护/升级数据库服务器。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-928294eb73615de574523762c3a1ab07>4.1 - RPO 利弊权衡</h1><div class=lead>针对 RPO （Recovery Point Objective）进行利弊权衡，在可用性与数据损失之间找到最佳平衡点。</div><p><strong>RPO</strong>（Recovery Point Objective，恢复点目标）定义了在主库发生故障时，<strong>允许丢失的最大数据量</strong>。</p><p>对于金融交易这类数据完整性至关重要的场景，通常要求 RPO = 0，即不允许任何数据丢失；</p><p>然而更为严格的 RPO 指标是有代价的，它会引入更高的写入延迟，降低系统吞吐量，并且存在从库故障导致主库不可用的风险。
因此对于常规场景，通常可以接受一定量的数据丢失（例如允许丢失不超过 1MB 的数据），以换取更高的可用性与性能。</p><hr><h2 id=利弊权衡>利弊权衡</h2><p>通常在异步复制场景下，从库和主库之间会存在一定的复制延迟（取决于网络和吞吐量，正常在 10KB-100KB / 100µs-10ms 的数量级），
这意味着当主库发生故障时，从库可能还没有完全同步主库的最新数据。这时候如果出现故障切换，新的主库可能会丢失一些尚未复制的数据。</p><p>潜在数据丢失量的上限由 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> 参数控制，默认为 <code>1048576</code> （<code>1MB</code>），这意味着在故障转移期间最多可以容忍 1MiB 的数据丢失。</p><p>当集群主库宕机时，如果有任何一个从库的复制延迟在这个值以内，Pigsty 将自动提升该从库为新的主库。
然而当所有从库副本的复制延迟都超出这个阈值时，Pigsty 将拒绝进行 [<strong>自动故障切换</strong>] 以避免数据丢失。
此时需要人工介入进行决策 —— 等待主库恢复（可能永远也不会恢复），还是接受数据损失并强制提升一个从库为新的主库。</p><p>您需要根据业务的需求偏好配置这个值，在 <strong>可用性</strong> 和 <strong>一致性</strong> 之间进行 <strong>利弊权衡</strong>。
增大这个值可以提高自动故障切换的成功率，但也会增加潜在的数据丢失量上限。</p><p>当您指定 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> = 0 时，Pigsty 将启用 <strong>同步复制</strong>，确保主库在确认至少一个从库持久化数据后才返回写入成功。
这种配置能确保没有复制延迟，但会带来显著的写入延迟，并降低整体的吞吐量。</p><pre class=mermaid>flowchart LR
    A([主库故障]) --&gt; B{同步复制?}

    B --&gt;|否| C{延迟 &lt; RPO?}
    B --&gt;|是| D{同步从库&lt;br/&gt;可用?}

    C --&gt;|是| E[有损自动故障切换&lt;br/&gt;RPO &lt; 1MB]
    C --&gt;|否| F[拒绝自动切换&lt;br/&gt;等待主库恢复&lt;br/&gt;或人工介入决策]

    D --&gt;|是| G[无损自动故障切换&lt;br/&gt;RPO = 0]
    D --&gt;|否| H{严格模式?}

    H --&gt;|否| C
    H --&gt;|是| F

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#F0AD4E,stroke:#146c43,color:#fff
    style G fill:#198754,stroke:#146c43,color:#fff
    style F fill:#BE002F,stroke:#565e64,color:#fff</pre><hr><h2 id=保护模式>保护模式</h2><p>Pigsty 提供三种保护模式，以帮助用户在不同的 RPO 要求下进行利弊权衡，类似于 <a href=https://docs.oracle.com/en/database/oracle/oracle-database/21/sbydb/oracle-data-guard-protection-modes.html><strong>Oracle Data Guard</strong></a> 的数据保护模式。</p><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>最大性能（Maximum Performance）</div><ul><li><strong>默认模式</strong>，异步复制，事务提交仅需本地 WAL 持久化，无需等待从库，从库故障对主库完全透明，不影响服务</li><li>主库故障时可能丢失尚未发送/接收的 WAL（通常 &lt; 1MB，正常网络条件通常在 10ms/100ms，10KB/100KB 量级）</li><li>针对性能优化，适用于常规业务场景，容许在故障时损失少量数据。</li></ul></div><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>最大可用性（Maximum Availability）</div><ul><li>配置有 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo = 0</code></strong></a>，启用 Patroni 同步提交模式： <code>synchronous_mode: true</code></li><li>正常情况下等待至少一个从库确认，实现零数据丢失。当 <strong>所有</strong> 同步从库故障时，<strong>自动降级为异步模式继续服务</strong></li><li>兼顾数据安全与服务可用性，是生产环境 <strong>核心业务</strong> 的推荐配置</li></ul></div><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>最大保护（Maximum Protection）</div><ul><li>使用 <code>crit.yml</code> 模板，启用 Patroni 严格同步模式：<code>synchronous_mode: true</code> / <code>synchronous_mode_strict: true</code></li><li>当所有同步从库故障时，<strong>主库将拒绝写入</strong>以防止数据丢失，事务必须在至少一个从库持久化后才返回成功。</li><li>适用于金融交易、医疗记录等对数据完整性要求极高的场景</li></ul></div><table class=full-width><thead><tr><th style=text-align:left><strong>名称</strong></th><th style=text-align:center><strong>最大性能</strong> Performance</th><th style=text-align:center><strong>最大可用</strong> Availability</th><th style=text-align:center><strong>最大保护</strong> Protection</th></tr></thead><tbody><tr><td style=text-align:left><strong>复制方式</strong></td><td style=text-align:center><strong>异步复制</strong></td><td style=text-align:center><strong>同步复制</strong></td><td style=text-align:center><strong>严格同步复制</strong></td></tr><tr><td style=text-align:left><strong>数据丢失</strong></td><td style=text-align:center><span class=text-danger><strong>可能丢失</strong></span>（复制延迟量）</td><td style=text-align:center><span class=text-primary><strong>正常零丢失，降级少量丢失</strong></span></td><td style=text-align:center><span class=text-success><strong>零丢失</strong></span></td></tr><tr><td style=text-align:left><strong>主库写延迟</strong></td><td style=text-align:center><span class=text-success><strong>最低</strong></span></td><td style=text-align:center><span class=text-warning><strong>中等</strong></span>（+1 次网络往返）</td><td style=text-align:center><span class=text-warning><strong>中等</strong></span>（+1 次网络往返）</td></tr><tr><td style=text-align:left><strong>吞吐量</strong></td><td style=text-align:center><span class=text-success><strong>最高</strong></span></td><td style=text-align:center><span class=text-warning><strong>降低</strong></span></td><td style=text-align:center><span class=text-warning><strong>降低</strong></span></td></tr><tr><td style=text-align:left><strong>从库故障影响</strong></td><td style=text-align:center><span class=text-success><strong>无影响</strong></span></td><td style=text-align:center><span class=text-primary><strong>自动降级，继续服务</strong></span></td><td style=text-align:center><span class=text-danger><strong>主库停写</strong></span></td></tr><tr><td style=text-align:left><strong>RPO</strong></td><td style=text-align:center><span class=text-warning><strong>&lt; 1MB</strong></span></td><td style=text-align:center><span class=text-primary><strong>= 0（正常）/ &lt; 1MB（降级）</strong></span></td><td style=text-align:center><span class=text-success><strong>= 0</strong></span></td></tr><tr><td style=text-align:left><strong>适用场景</strong></td><td style=text-align:center>常规业务、性能优先</td><td style=text-align:center>重要业务、安全优先</td><td style=text-align:center>金融核心、安全合规第一</td></tr><tr><td style=text-align:left><strong>配置方法</strong></td><td style=text-align:center>默认配置</td><td style=text-align:center><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> = <code>0</code></td><td style=text-align:center><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>: <code>crit.yml</code></td></tr></tbody></table><hr><h2 id=实现原理>实现原理</h2><p>三种保护模式的区别在于 <strong>Patroni</strong> 的两个核心参数：<a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-mode><strong><code>synchronous_mode</code></strong></a> 与 <a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-mode><strong><code>synchronous_mode_strict</code></strong></a> 如何配置：</p><ul><li><strong><code>synchronous_mode</code></strong>：Patroni 是否启用同步复制，如果启用，再看 <strong><code>synchronous_mode_strict</code></strong> 是否启用严格同步模式。</li><li><strong><code>synchronous_mode_strict = false</code></strong>，默认配置，允许当从库故障时降级为异步模式，<strong>主库继续服务</strong>（最大可用性）</li><li><strong><code>synchronous_mode_strict = true</code></strong>，禁止降级，<strong>主库停止写入</strong>直到同步从库恢复（最大保护）</li></ul><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center><strong><code>synchronous_mode</code></strong></th><th style=text-align:center><strong><code>synchronous_mode_strict</code></strong></th><th>复制模式</th><th style=text-align:left>从库故障行为</th></tr></thead><tbody><tr><td style=text-align:center><strong>最大性能</strong></td><td style=text-align:center><span class=text-danger><strong><code>false</code></strong></span></td><td style=text-align:center>-</td><td><strong>异步复制</strong></td><td style=text-align:left><span class=text-success><strong>无影响</strong></span></td></tr><tr><td style=text-align:center><strong>最大可用</strong></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td style=text-align:center><span class=text-danger><strong><code>false</code></strong></span></td><td><strong>同步复制</strong></td><td style=text-align:left><span class=text-primary><strong>自动降级为异步</strong></span></td></tr><tr><td style=text-align:center><strong>最大保护</strong></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td style=text-align:center><span class=text-success><strong><code>true</code></strong></span></td><td><strong>严格同步复制</strong></td><td style=text-align:left><span class=text-danger><strong>主库拒绝写入</strong></span></td></tr></tbody></table><p>通常情况下，您只需要将 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> 参数设置为 <code>0</code>，即可打开 <code>synchronous_mode</code> 开关，启用 <strong>最大可用性模式</strong>。
如果您使用 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <a href=/docs/pgsql/template/crit><strong><code>crit.yml</code></strong></a> 模板，则会同时额外打开 <code>synchronous_mode_strict</code> 严格模式开关，启用 <strong>最大保护模式</strong>。
此外，您可以启用 <a href=/docs/pgsql/param#patroni_watchdog_mode><strong>watchdog</strong></a>，在节点/Patroni 假死场景下直接 Fencing 主库而不是降级，实现与 Oracle 最大保护模式相同的行为表现</p><p>当然，您可以直接按需 <a href=/docs/pgsql/admin/patroni#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong>配置</strong></a> 这些 Patroni 参数，您还可以参阅 Patroni 与 PostgreSQL 文档，通过配置实现更强的数据保护，例如：</p><ul><li>可以指定指定 <a href=/docs/pgsql/config/cluster#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4><strong>同步从库列表</strong></a>，配置更多同步从库以提高容灾能力，使用法定人数同步，甚至要求所有从库都执行同步提交。</li><li>您可以 <a href=/docs/pgsql/admin/patroni#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong>配置</strong></a> <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#GUC-SYNCHRONOUS-COMMIT><strong><code>synchronous_commit</code></strong></a>: <code>'remote_apply'</code>，严格确保主从读写一致性。（Oracle 最大保护模式相当于 <code>remote_write</code>）</li></ul><hr><h2 id=配置建议>配置建议</h2><p><strong>最大性能模式</strong>（异步复制）是 Pigsty 默认使用的模式，对于绝大多数业务来说已经足够使用。
容许故障时丢失少量数据（正常在 几KB - 几百KB 的数量级），换来更大的性能吞吐量与服务可用性水平，是常规业务场景的推荐配置。
在这种情况下，您可以通过 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> 参数调整允许的最大数据丢失量，以适应不同的业务需求。</p><p><strong>最大可用性模式</strong>（同步复制）适用于对据完整性要求高的场景，不允许数据丢失。
在这种模式下，最少需要一主一从的两节点 PostgreSQL 集群才有意义。
将 <a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a> 设置为 0 即可启用该模式。</p><p><strong>最大保护模式</strong> （严格同步复制） 适用于金融交易、医疗记录等对数据完整性要求极高的场景，我们建议至少使用一主二从的三节点集群，
因为两节点的情况下，只要从库故障，主库就会停止写入，导致业务不可用，这会降低系统的整体可靠性。而三节点的规格下，如果只有一个从库故障，主库仍然可以继续服务。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-95882b9440d286103890671f368774b6>4.2 - RTO 利弊权衡</h1><div class=lead>针对 RTO （Recovery Time Objective）进行利弊权衡，在故障恢复速度与误切风险之间找到最佳平衡点。</div><p><strong>RTO</strong>（Recovery Time Objective，恢复时间目标）定义了在主库发生故障时，<strong>系统恢复写入能力所需的最长时间</strong>。</p><p>对于核心交易系统这类可用性至关重要的场景，通常要求 RTO 尽可能短，例如一分钟内。</p><p>然而更短的 RTO 指标是有代价的，它会增加误切风险：网络抖动可能被误判为故障，导致不必要的故障切换。
因此对于跨机房/跨地域部署的场景，通常需要放宽 RTO 要求（例如 1-2 分钟），以降低误切风险。</p><hr><h2 id=利弊权衡>利弊权衡</h2><p>故障切换时的不可用时长上限由 <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> 参数控制。Pigsty 提供了四种预设的 RTO 模式：
<code>fast</code>、<code>norm</code>、<code>safe</code>、<code>wide</code>，分别针对不同的网络条件与部署场景进行了优化，默认使用 <code>norm</code> 模式（约 45 秒）。
您也可以使用秒数直接指定 RTO 上限，系统会自动映射到最接近的模式。</p><p>当主库发生故障时，整个恢复流程涉及多个阶段：Patroni 检测故障、DCS 锁过期、新主选举、执行 promote、HAProxy 感知新主。
减小 RTO 意味着缩短各阶段的超时时间，这会使集群对网络抖动更加敏感，从而增加误切风险。</p><p>您需要根据实际网络条件选择合适的模式，在 <strong>恢复速度</strong> 与 <strong>误切风险</strong> 之间取得平衡。
网络质量越差，越应该选择保守的模式；网络质量越好，越可以选择激进的模式。</p><pre class=mermaid>flowchart LR
    A([主库故障]) --&gt; B{Patroni&lt;br/&gt;检测到?}

    B --&gt;|PG崩溃| C[尝试本地重启]
    B --&gt;|节点宕机| D[等待 TTL 过期]

    C --&gt;|成功| E([本地恢复])
    C --&gt;|失败/超时| F[释放 Leader 锁]

    D --&gt; F
    F --&gt; G[从库竞选]
    G --&gt; H[执行 Promote]
    H --&gt; I[HAProxy 感知]
    I --&gt; J([服务恢复])

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#198754,stroke:#146c43,color:#fff
    style J fill:#198754,stroke:#146c43,color:#fff</pre><hr><h2 id=四种模式>四种模式</h2><p>Pigsty 提供四种 RTO 模式，以帮助用户在不同的网络条件下进行利弊权衡。</p><table class=full-width><thead><tr><th style=text-align:left><strong>名称</strong></th><th style=text-align:center><strong>fast</strong></th><th style=text-align:center><strong>norm</strong></th><th style=text-align:center><strong>safe</strong></th><th style=text-align:center><strong>wide</strong></th></tr></thead><tbody><tr><td style=text-align:left><strong>适用场景</strong></td><td style=text-align:center>同机柜</td><td style=text-align:center>同机房内（默认）</td><td style=text-align:center>同省跨机房</td><td style=text-align:center>跨地域/跨洲</td></tr><tr><td style=text-align:left><strong>网络条件</strong></td><td style=text-align:center>&lt; 1ms，极稳定</td><td style=text-align:center>1-5ms，正常</td><td style=text-align:center>10-50ms，跨机房</td><td style=text-align:center>100-200ms，公网</td></tr><tr><td style=text-align:left><strong>目标 RTO</strong></td><td style=text-align:center><span class=text-success><strong>30s</strong></span></td><td style=text-align:center><span class=text-primary><strong>45s</strong></span></td><td style=text-align:center><span class=text-warning><strong>90s</strong></span></td><td style=text-align:center><span class=text-danger><strong>150s</strong></span></td></tr><tr><td style=text-align:left><strong>误切风险</strong></td><td style=text-align:center><span class=text-secondary><strong>较高</strong></span></td><td style=text-align:center><span class=text-primary><strong>中等</strong></span></td><td style=text-align:center><span class=text-success><strong>较低</strong></span></td><td style=text-align:center><span class=text-success><strong>极低</strong></span></td></tr><tr><td style=text-align:left><strong>配置方法</strong></td><td style=text-align:center><code>pg_rto: fast</code></td><td style=text-align:center><code>pg_rto: norm</code></td><td style=text-align:center><code>pg_rto: safe</code></td><td style=text-align:center><code>pg_rto: wide</code></td></tr></tbody></table><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>fast：同机柜/同交换机</div><ul><li>适用于网络延迟极低（&lt; 1ms）且非常稳定的场景，例如同机柜或同交换机部署</li><li>平均 RTO: <strong>14s</strong>，最坏情况: <strong>29s</strong>，TTL 仅 20s，检测间隔 5s</li><li>对网络质量要求最高，任何抖动都可能触发切换，<strong>误切风险较高</strong></li></ul></div><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>norm：同机房（默认）</div><ul><li><strong>默认模式</strong>，适用于同机房部署，网络延迟 1-5ms，质量正常，丢包率合理</li><li>平均 RTO: <strong>21s</strong>，最坏情况: <strong>43s</strong>，TTL 为 30s，提供合理的容错窗口</li><li>平衡了恢复速度与稳定性，适合绝大多数生产环境</li></ul></div><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>safe：同省跨机房</div><ul><li>适用于同省/同区域跨机房部署，网络延迟 10-50ms，可能存在偶发抖动</li><li>平均 RTO: <strong>43s</strong>，最坏情况: <strong>91s</strong>，TTL 为 60s，更长的容错窗口</li><li>主库重启等待时间较长（60s），给予更多本地恢复机会，<strong>误切风险较低</strong></li></ul></div><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>wide：跨地域/跨洲</div><ul><li>适用于跨地域甚至跨大洲部署，网络延迟 100-200ms，可能有公网级别的丢包率</li><li>平均 RTO: <strong>92s</strong>，最坏情况: <strong>207s</strong>，TTL 为 120s，极宽的容错窗口</li><li>牺牲恢复速度换取极低的误切率，适合异地容灾场景</li></ul></div><hr><h2 id=rto时序图>RTO时序图</h2><p>Patroni / PG HA 有两条关键故障路径：<strong>主动故障检测</strong>（PG崩溃后 Patroni 检测到并尝试重启）与 <strong>被动租约过期</strong>（节点宕机后等待 TTL 过期触发选举）。</p><div id=echarts-f7a37f58f1c9d1582ba355a860f3971a class="echarts-container td-max-width-on-larger-screens" style=height:820px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-f7a37f58f1c9d1582ba355a860f3971a");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:110,right:24,top:40},legend:{data:["租约过期","故障检测","重启超时","从库检测","抢锁提拔","健康检查"],itemGap:10,top:0},series:[{barWidth:16,data:[120,110,100,"-","-","-","-",60,55,50,"-","-","-","-",30,27,25,"-","-","-","-",20,17,15,"-","-","-"],emphasis:{focus:"series"},itemStyle:{color:"#e15759"},name:"租约过期",stack:"main",type:"bar",z:2},{data:["-","-","-",20,10,0,"-","-","-","-",10,5,0,"-","-","-","-",5,3,0,"-","-","-","-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#b07aa1"},name:"故障检测",stack:"main",type:"bar",z:2},{data:["-","-","-",95,95,0,"-","-","-","-",45,45,0,"-","-","-","-",25,25,0,"-","-","-","-",15,15,0],emphasis:{focus:"series"},itemStyle:{color:"#f28e2c"},name:"重启超时",stack:"main",type:"bar",z:2},{data:[20,10,0,20,10,0,"-",10,5,0,10,5,0,"-",5,3,0,5,3,0,"-",5,3,0,5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"从库检测",stack:"main",type:"bar",z:2},{data:[2,1,0,2,1,0,"-",2,1,0,2,1,0,"-",2,1,0,2,1,0,"-",2,1,0,2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"抢锁提拔",stack:"main",type:"bar",z:2},{data:[8,6,4,8,6,4,"-",6,5,3,6,5,3,"-",4,3,2,4,3,2,"-",2,2,1,2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"健康检查",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:16,data:[150,127,104,145,122,4,"-",78,66,53,73,61,3,"-",41,34,27,41,35,2,"-",29,23,16,29,24,1],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO总计",type:"bar",z:1},{barGap:"-100%",barWidth:16,data:[150,150,150,150,150,150,"-",90,90,90,90,90,90,"-",45,45,45,45,45,45,"-",30,30,30,30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO预算",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"秒",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:9},axisLine:{show:!0},axisTick:{show:!0},data:["wide-passive-max","wide-passive-avg","wide-passive-min","wide-active-max","wide-active-avg","wide-active-min","","safe-passive-max","safe-passive-avg","safe-passive-min","safe-active-max","safe-active-avg","safe-active-min","","norm-passive-max","norm-passive-avg","norm-passive-min","norm-active-max","norm-active-avg","norm-active-min","","fast-passive-max","fast-passive-avg","fast-passive-min","fast-active-max","fast-active-avg","fast-active-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=实现原理>实现原理</h2><p>四种 RTO 模式的区别在于以下 10 个 <strong>Patroni</strong> 与 <strong>HAProxy</strong> HA 相关参数如何配置。</p><table class=full-width><thead><tr><th style=text-align:center>组件</th><th style=text-align:center>参数</th><th style=text-align:center><strong>fast</strong></th><th style=text-align:center><strong>norm</strong></th><th style=text-align:center><strong>safe</strong></th><th style=text-align:center><strong>wide</strong></th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong><code>patroni</code></strong></td><td style=text-align:center><strong><code>ttl</code></strong></td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:center>60</td><td style=text-align:center>120</td><td style=text-align:left>Leader 锁生存时间（秒）</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>loop_wait</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>20</td><td style=text-align:left>HA 循环检查间隔（秒）</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>retry_timeout</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:left>DCS 操作重试超时（秒）</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>primary_start_timeout</code></strong></td><td style=text-align:center>15</td><td style=text-align:center>25</td><td style=text-align:center>45</td><td style=text-align:center>95</td><td style=text-align:left>主库重启等待时间（秒）</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>safety_margin</code></strong></td><td style=text-align:center>5</td><td style=text-align:center>5</td><td style=text-align:center>10</td><td style=text-align:center>15</td><td style=text-align:left>Watchdog 安全边际（秒）</td></tr><tr><td style=text-align:center><strong><code>haproxy</code></strong></td><td style=text-align:center><strong><code>inter</code></strong></td><td style=text-align:center>1s</td><td style=text-align:center>2s</td><td style=text-align:center>3s</td><td style=text-align:center>4s</td><td style=text-align:left>正常状态检查间隔</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>fastinter</code></strong></td><td style=text-align:center>0.5s</td><td style=text-align:center>1s</td><td style=text-align:center>1.5s</td><td style=text-align:center>2s</td><td style=text-align:left>状态变化期检查间隔</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>downinter</code></strong></td><td style=text-align:center>1s</td><td style=text-align:center>2s</td><td style=text-align:center>3s</td><td style=text-align:center>4s</td><td style=text-align:left>DOWN 状态检查间隔</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>rise</code></strong></td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:left>标记 UP 所需连续成功次数</td></tr><tr><td style=text-align:center></td><td style=text-align:center><strong><code>fall</code></strong></td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:center>3</td><td style=text-align:left>标记 DOWN 所需连续失败次数</td></tr></tbody></table><h3 id=patroni-参数>Patroni 参数</h3><ul><li><strong><code>ttl</code></strong>：Leader 锁生存时间，主库须在此时间内续租，否则锁过期触发选举，直接决定被动故障的检测延迟。</li><li><strong><code>loop_wait</code></strong>：Patroni 主循环间隔，每个循环执行一次健康检查与状态同步，影响故障发现的及时性。</li><li><strong><code>retry_timeout</code></strong>：DCS 操作重试超时，网络分区时 Patroni 在此期间持续重试，超时后主库主动降级防止脑裂。</li><li><strong><code>primary_start_timeout</code></strong>：PG 崩溃后 Patroni 尝试本地重启的等待时间，超时后释放 Leader 锁触发切换。</li><li><strong><code>safety_margin</code></strong>：Watchdog 安全边际，确保故障时有足够时间触发系统重启，避免脑裂。</li></ul><h3 id=haproxy-参数>HAProxy 参数</h3><ul><li><strong><code>inter</code></strong>：正常状态下的健康检查间隔，服务状态稳定时使用。</li><li><strong><code>fastinter</code></strong>：状态变化期的检查间隔，检测到状态变化时使用更短间隔加速确认。</li><li><strong><code>downinter</code></strong>：DOWN 状态下的检查间隔，服务标记为 DOWN 后使用此间隔探测恢复。</li><li><strong><code>rise</code></strong>：标记 UP 所需连续成功次数，新主上线后需连续通过 <code>rise</code> 次检查才能接收流量。</li><li><strong><code>fall</code></strong>：标记 DOWN 所需连续失败次数，服务需连续失败 <code>fall</code> 次才会被标记为 DOWN。</li></ul><h3 id=关键约束>关键约束</h3><p><strong>Patroni 核心约束</strong>：确保主库能在 TTL 过期前完成降级，防止脑裂。</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">_</mi><mi>w</mi><mi>a</mi><mi>i</mi><mi>t</mi><mo>+</mo><mn>2</mn><mo>×</mo><mi>r</mi><mi>e</mi><mi>t</mi><mi>r</mi><mi>y</mi><mi mathvariant="normal">_</mi><mi>t</mi><mi>i</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>u</mi><mi>t</mi><mo>≤</mo><mi>t</mi><mi>t</mi><mi>l</mi></mrow><annotation encoding="application/x-tex">loop\_wait + 2 \times retry\_timeout \leq ttl</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:1.0044em;vertical-align:-.31em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord style=margin-right:.02778em>_</span><span class="mord mathnormal" style=margin-right:.02691em>w</span><span class="mord mathnormal">ai</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.9695em;vertical-align:-.31em></span><span class="mord mathnormal">re</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.03588em>ry</span><span class=mord style=margin-right:.02778em>_</span><span class="mord mathnormal">t</span><span class="mord mathnormal">im</span><span class="mord mathnormal">eo</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≤</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.6944em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span></span></span></span></span><hr><h2 id=数据汇总>数据汇总</h2><hr><h2 id=配置建议>配置建议</h2><p><strong>fast 模式</strong> 适用于对 RTO 要求极高的场景，但需要确保网络质量足够好（延迟 &lt; 1ms，极低丢包率）。
建议仅在同机柜或同交换机部署时使用，并在生产环境充分测试后再启用。</p><p><strong>norm 模式</strong>（<strong>默认</strong>）是 Pigsty 默认使用的配置，对于绝大多数同机房部署的业务来说已经足够使用。
平均 21 秒的恢复时间在可接受范围内，同时提供了合理的容错窗口，避免网络抖动导致的误切。</p><p><strong>safe 模式</strong> 适用于同城跨机房部署，网络延迟较高或存在偶发抖动的场景。
更长的容错窗口可以有效避免网络抖动导致的误切，是跨机房容灾的推荐配置。</p><p><strong>wide 模式</strong> 适用于跨地域甚至跨大洲部署，网络延迟高且可能存在公网级别的丢包率。
这种场景下，稳定性比恢复速度更重要，因此使用极宽的容错窗口来确保极低的误切率。</p><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center>目标RTO</th><th style=text-align:center>被动检测 RTO</th><th style=text-align:center>主动检测 RTO</th><th style=text-align:left>场景</th></tr></thead><tbody><tr><td style=text-align:center><code>fast</code></td><td style=text-align:center><code>30</code></td><td style=text-align:center><code>16</code> / <code>23</code> / <code>29</code></td><td style=text-align:center><code>1</code> / <code>24</code> / <code>29</code></td><td style=text-align:left>同交换机，高质量网络</td></tr><tr><td style=text-align:center><code>norm</code></td><td style=text-align:center><code>45</code></td><td style=text-align:center><code>27</code> / <code>34</code> / <code>41</code></td><td style=text-align:center><code>2</code> / <code>35</code> / <code>41</code></td><td style=text-align:left>默认，同机房，标准网络</td></tr><tr><td style=text-align:center><code>safe</code></td><td style=text-align:center><code>90</code></td><td style=text-align:center><code>53</code> / <code>66</code> / <code>78</code></td><td style=text-align:center><code>3</code> / <code>61</code> / <code>73</code></td><td style=text-align:left>同城双活 / 跨机房容灾</td></tr><tr><td style=text-align:center><code>wide</code></td><td style=text-align:center><code>150</code></td><td style=text-align:center><code>104</code> / <code>127</code> / <code>150</code></td><td style=text-align:center><code>4</code> / <code>122</code> / <code>145</code></td><td style=text-align:left>异地容灾 / 跨国部署</td></tr><tr><td style=text-align:center><code>default</code></td><td style=text-align:center><code>326</code></td><td style=text-align:center><code>22</code> / <code>34</code> / <code>46</code></td><td style=text-align:center><code>2</code> / <code>314</code> / <code>326</code></td><td style=text-align:left>Patroni 默认参数</td></tr></tbody></table><p>通常只需将 <a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a> 设为模式名称，Pigsty 会自动配置 Patroni 与 HAProxy 参数。
为了保持向后兼容性，Pigsty 仍然支持直接使用秒数配置 RTO，但效果相当于指定 <code>norm</code> 模式。</p><p>配置模式实际上是从 <a href=/docs/pgsql/param#pg_rto_plan><strong><code>pg_rto_plan</code></strong></a> 中加载对应参数集，您可以修改或覆盖此配置以实现自定义 RTO 策略。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-439a629138018b9fe8b5a1c8323745be>4.3 - 故障切换模型</h1><div class=lead>详细分析三种经典故障检测/恢复路径下，最差，最优，平均 RTO 的计算逻辑与结果</div><p>Patroni 故障按故障对象分类可以分为以下 10 类，按照检测路径不同，可以进一步归纳为五类，在本节内详细展开。</p><table class=full-width><thead><tr><th>#</th><th>故障场景</th><th>描述</th><th>最终走哪条路径</th></tr></thead><tbody><tr><td>1</td><td>PG 进程崩溃</td><td>crash、OOM killed</td><td><strong>主动检测</strong></td></tr><tr><td>2</td><td>PG 拒绝连接</td><td>max_connections</td><td><strong>主动检测</strong></td></tr><tr><td>3</td><td>PG 假活</td><td>进程在但无响应</td><td><strong>主动检测</strong> (检测超时)</td></tr><tr><td>4</td><td>Patroni 进程崩溃</td><td>kill -9、OOM</td><td><strong>被动检测</strong></td></tr><tr><td>5</td><td>Patroni 假活</td><td>进程在但卡住</td><td><strong>Watchdog</strong></td></tr><tr><td>6</td><td>节点宕机</td><td>断电、硬件故障</td><td><strong>被动检测</strong></td></tr><tr><td>7</td><td>节点假活</td><td>IO hang、CPU 饥饿</td><td><strong>Watchdog</strong></td></tr><tr><td>8</td><td>主库 ↔ DCS 网络中断</td><td>防火墙、交换机故障</td><td><strong>网络分区</strong></td></tr><tr><td>9</td><td>存储故障</td><td>磁盘坏、磁盘满、挂载失败</td><td><strong>主动检测</strong> 或 <strong>Watchdog</strong></td></tr><tr><td>10</td><td>手动切换</td><td>Switchover/Failover</td><td><strong>手动触发</strong></td></tr></tbody></table><p>但是在 RTO 计算上，最终所有故障都会收敛到两条路径上，本节深入探讨了这两种情况下的 RTO 上下限与均值。</p><ul><li><a href=/docs/concept/ha/failure/passive><strong>Patroni 失联后被动触发选举</strong></a>：</li><li><a href=/docs/concept/ha/failure/active><strong>Patroni 主动检测故障并切换</strong></a>:</li></ul><pre class=mermaid>flowchart LR
    A([主库故障]) --&gt; B{Patroni&lt;br/&gt;检测到?}

    B --&gt;|PG崩溃| C[尝试本地重启]
    B --&gt;|节点宕机| D[等待 TTL 过期]

    C --&gt;|成功| E([本地恢复])
    C --&gt;|失败/超时| F[释放 Leader 锁]

    D --&gt; F
    F --&gt; G[从库竞选]
    G --&gt; H[执行 Promote]
    H --&gt; I[HAProxy 感知]
    I --&gt; J([服务恢复])

    style A fill:#dc3545,stroke:#b02a37,color:#fff
    style E fill:#198754,stroke:#146c43,color:#fff
    style J fill:#198754,stroke:#146c43,color:#fff</pre></div><div class=td-content style=page-break-before:always><h1 id=pg-358e309cdbb4cb46571e2cba4875ac34>4.3.1 - 被动故障切换</h1><div class=lead>节点宕机，导致领导者租约过期触发集群领导竞选的故障路径</div><div id=infographic-537dd2226714fc6c5830057e9f044ea1 class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-537dd2226714fc6c5830057e9f044ea1",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  title 租约过期故障切换流程
  desc 当整个节点宕机，Patroni 无法主动释放租约，只能等待 TTL 过期
  items
    - label 租约过期
      desc Patroni 失联，被动等待主库租约 TTL 过期
      icon mingcute/close-circle-fill
    - label 从库检测
      desc 从库从循环中醒来后发现租约过期，开始竞选
      icon mingcute/key-2-fill
    - label 抢锁提拔
      desc 从库相互比较并抢锁，胜利者提升自己的PG
      icon mingcute/radar-fill
    - label 健康检查
      desc HAPROXY 健康检查发现新主上线，分配流量
      icon mingcute/arrow-up-circle-fill
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-时序图>RTO 时序图</h2><div id=echarts-44d24210b099c2088232bbd8c2371226 class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-44d24210b099c2088232bbd8c2371226");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["租约过期","从库检测","抢锁提拔","健康检查"],itemGap:12,top:0},series:[{barWidth:20,data:[120,110,100,"-",60,55,50,"-",30,27,25,"-",20,17,15],emphasis:{focus:"series"},itemStyle:{color:"#e15759"},name:"租约过期",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"从库检测",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"抢锁提拔",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"健康检查",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[150,127,104,"-",78,66,53,"-",41,34,27,"-",29,23,16],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO总计",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO预算",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"秒",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=故障模型>故障模型</h2><table class=full-width><thead><tr><th style=text-align:center>项目</th><th style=text-align:center>最好</th><th style=text-align:center>最坏</th><th style=text-align:center>平均</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong>租约过期</strong></td><td style=text-align:center><code>ttl - loop</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:center><code>ttl - loop/2</code></td><td style=text-align:left>最好：即将刷新时宕机<br>最坏：刚刷新完就宕机</td></tr><tr><td style=text-align:center><strong>从库检测</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop / 2</code></td><td style=text-align:left>最好：恰好在检测点<br>最坏：刚错过检测点</td></tr><tr><td style=text-align:center><strong>抢锁提拔</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>最好：直接抢锁提升<br>最坏：API超时+Promote</td></tr><tr><td style=text-align:center><strong>健康检查</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>最好：检查前状态变化<br>最坏：检查后瞬间状态变化</td></tr></tbody></table><p><strong>被动故障与主动故障的核心区别</strong>：</p><table class=full-width><thead><tr><th style=text-align:center>场景</th><th style=text-align:center>Patroni 状态</th><th style=text-align:center>租约处理</th><th style=text-align:center>主要等待时间</th></tr></thead><tbody><tr><td style=text-align:center><strong>主动故障</strong>（PG崩溃）</td><td style=text-align:center>存活，健康</td><td style=text-align:center>主动尝试重启 PG，超时后释放租约</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>被动故障</strong>（节点宕机）</td><td style=text-align:center>随节点一起死亡</td><td style=text-align:center>无法主动释放，只能等待 TTL 过期</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>在被动故障场景中，Patroni 随节点一起宕机，<strong>无法主动释放 Leader Key</strong>。
DCS 中的租约只能等待 TTL 自然过期后触发集群选举。</p><hr><h2 id=时序分析>时序分析</h2><h3 id=阶段-1租约过期>阶段 1：租约过期</h3><p>Patroni 主库会在每个 <code>loop_wait</code> 周期刷新 Leader Key，将 TTL 重置为配置值。</p><pre tabindex=0><code>时间线：
     t-loop        t          t+ttl-loop    t+ttl
       |           |              |           |
    上次刷新    故障发生        最好情况      最坏情况
       |←── loop ──→|              |           |
       |←──────────── ttl ─────────────────────→|
</code></pre><ul><li><strong>最好情况</strong>：故障发生在即将刷新租约之前（距上次刷新已过 <code>loop</code>），剩余 TTL = <code>ttl - loop</code></li><li><strong>最坏情况</strong>：故障发生在刚刷新租约之后，需等待完整 <code>ttl</code></li><li><strong>平均情况</strong>：<code>ttl - loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>x</mi><mi>p</mi><mi>i</mi><mi>r</mi><mi>e</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>t</mi><mi>t</mi><mi>l</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{expire} = \begin{cases}
ttl - loop &amp; \text{最好} \\
ttl - loop/2 &amp; \text{平均} \\
ttl &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">re</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>ttl</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-2从库检测>阶段 2：从库检测</h3><p>从库在 <code>loop_wait</code> 周期醒来后检查 DCS 中的 Leader Key 状态。</p><pre tabindex=0><code>时间线：
    租约过期      从库醒来
       |            |
       |←── 0~loop ─→|
</code></pre><ul><li><strong>最好情况</strong>：租约过期时从库恰好醒来，等待 <code>0</code></li><li><strong>最坏情况</strong>：租约过期后从库刚进入睡眠，等待 <code>loop</code></li><li><strong>平均情况</strong>：<code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{最好} \\
loop/2 &amp; \text{平均} \\
loop &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-3抢锁提拔>阶段 3：抢锁提拔</h3><p>从库发现 Leader Key 过期后，开始竞选过程，获得 Leader Key 的从库执行 <code>pg_ctl promote</code>，将自己提升为新主库。</p><ol><li>通过 Rest API，并行发起查询，查询各从库的复制位置，通常 10ms，硬编码 2 秒超时。</li><li>比较 WAL 位置，确定最优候选，各从库尝试创建 Leader Key（CAS 原子操作）</li><li>执行 <code>pg_ctl promote</code> 提升自己为主库（很快，通常忽略不计）</li></ol><pre tabindex=0><code>选举流程：
  从库A ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 成功
  从库B ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 失败
</code></pre><ul><li><strong>最好情况</strong>：单从库或直接抢到锁并提升，常数开销 <code>0.1s</code></li><li><strong>最坏情况</strong>：DCS API 调用超时：<code>2s</code></li><li><strong>平均情况</strong>：<code>1s</code> 常数开销</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{最好} \\
1 &amp; \text{平均} \\
2 &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-4健康检查>阶段 4：健康检查</h3><p>HAProxy 检测新主库上线，需要连续 <code>rise</code> 次健康检查成功。</p><pre tabindex=0><code>检测时序：
  新主提升    首次检查    第二次检查   第三次检查（UP）
     |          |           |           |
     |←─ 0~inter ─→|←─ fast ─→|←─ fast ─→|
</code></pre><ul><li><strong>最好情况</strong>：新主提升时恰好赶上检查，<code>(rise-1) × fastinter</code></li><li><strong>最坏情况</strong>：新主提升后刚错过检查，<code>(rise-1) × fastinter + inter</code></li><li><strong>平均情况</strong>：<code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{最好} \\
(rise-1) \times fastinter + inter/2 &amp; \text{平均} \\
(rise-1) \times fastinter + inter &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-公式>RTO 公式</h2><p>将各阶段时间相加，得到总 RTO：</p><p><strong>最好情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>−</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = ttl - loop + 0.1 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>平均情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = ttl + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>最坏情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>t</mi><mi>t</mi><mi>l</mi><mo>+</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = ttl + loop + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7778em;vertical-align:-.0833em></span><span class="mord mathnormal" style=margin-right:.01968em>ttl</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=模型计算>模型计算</h2><p>将四种 RTO 模型的参数带入上面的公式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>四种模式计算结果</strong>（单位：秒，格式：min / avg / max）</p><table class=full-width><thead><tr><th style=text-align:center>阶段</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>租约过期</td><td style=text-align:center><code>15</code> / <code>17</code> / <code>20</code></td><td style=text-align:center><code>25</code> / <code>27</code> / <code>30</code></td><td style=text-align:center><code>50</code> / <code>55</code> / <code>60</code></td><td style=text-align:center><code>100</code> / <code>110</code> / <code>120</code></td></tr><tr><td style=text-align:center>从库检测</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>抢锁提拔</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>健康检查</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>总计</strong></td><td style=text-align:center><code>16</code> / <code>23</code> / <code>29</code></td><td style=text-align:center><code>27</code> / <code>34</code> / <code>41</code></td><td style=text-align:center><code>53</code> / <code>66</code> / <code>78</code></td><td style=text-align:center><code>104</code> / <code>127</code> / <code>150</code></td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-42b7950723c66bacccc650303281acc3>4.3.2 - 主动故障检测</h1><div class=lead>PostgreSQL 主库进程崩溃，Patroni 存活并尝试重启，超时后触发故障切换的路径</div><div id=infographic-5a27087cd19651a30e413fd22489ae1b class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-5a27087cd19651a30e413fd22489ae1b",s=`\`\`\`\`
infographic list-row-simple-horizontal-arrow
data
  title 崩溃故障切换流程
  desc 当 Patroni 健康，但 PostgreSQL 因故崩溃时的故障切换流程
  items
    - label 故障检测
      desc Patroni 在循环中检测到 PG 崩溃
      icon mingcute/close-circle-fill
    - label 重启超时
      desc Patroni 尝试重启 PG，超时后释放租约
      icon mingcute/refresh-2-fill
    - label 从库检测
      desc 从库从循环中醒来发现租约释放，开始竞选
      icon mingcute/key-2-fill
    - label 抢锁提拔
      desc 从库相互比较并抢锁，胜利者提升自己的 PG
      icon mingcute/radar-fill
    - label 健康检查
      desc HAProxy 健康检查发现新主上线，分配流量
      icon mingcute/arrow-up-circle-fill
theme light
  palette antv
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=rto-时序图>RTO 时序图</h2><div id=echarts-7566178edd3ee3c0901186f67235867f class="echarts-container td-max-width-on-larger-screens" style=height:520px></div><script>(function(){var e,s,o,i,a,r,t=document.getElementById("echarts-7566178edd3ee3c0901186f67235867f");if(!t)return;window._echartsFns=window._echartsFns||{},o=function(e){return!e||!e.length||e[0].name===""?"":"<b>"+e[0].name+"</b><br/>"+e.filter(e=>e.value!=="-"&&e.value!=null).map(e=>e.marker+" "+e.seriesName+": "+e.value+"s").join("<br/>")},window._echartsFns.fmt=o,i=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,e=echarts.init(t,i),a={grid:{bottom:32,left:64,right:24,top:40},legend:{data:["故障检测","重启超时","从库检测","抢锁提拔","健康检查"],itemGap:12,top:0},series:[{barWidth:20,data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#b07aa1"},name:"故障检测",stack:"main",type:"bar",z:2},{data:[95,95,0,"-",45,45,0,"-",25,25,0,"-",15,15,0],emphasis:{focus:"series"},itemStyle:{color:"#f28e2c"},name:"重启超时",stack:"main",type:"bar",z:2},{data:[20,10,0,"-",10,5,0,"-",5,3,0,"-",5,3,0],emphasis:{focus:"series"},itemStyle:{color:"#edc949"},name:"从库检测",stack:"main",type:"bar",z:2},{data:[2,1,0,"-",2,1,0,"-",2,1,0,"-",2,1,0],emphasis:{focus:"series"},itemStyle:{color:"#59a14f"},name:"抢锁提拔",stack:"main",type:"bar",z:2},{data:[8,6,4,"-",6,5,3,"-",4,3,2,"-",2,2,1],emphasis:{focus:"series"},itemStyle:{color:"#4e79a7"},name:"健康检查",stack:"main",type:"bar",z:2},{barGap:"-100%",barWidth:20,data:[145,122,4,"-",73,61,3,"-",41,35,2,"-",29,24,1],emphasis:{itemStyle:{opacity:0}},itemStyle:{color:"#888",opacity:0},name:"RTO总计",type:"bar",z:1},{barGap:"-100%",barWidth:20,data:[150,150,150,"-",90,90,90,"-",45,45,45,"-",30,30,30],emphasis:{itemStyle:{color:"rgba(0,0,0,0.12)"}},itemStyle:{color:"rgba(0,0,0,0.08)"},name:"RTO预算",type:"bar",z:0}],tooltip:{axisPointer:{type:"shadow"},formatter:"$fn:fmt",trigger:"axis"},xAxis:{axisLine:{show:!0},axisTick:{show:!0},max:160,minorSplitLine:{lineStyle:{opacity:.2,type:"dotted"},show:!0},minorTick:{show:!0,splitNumber:5},name:"秒",nameLocation:"end",splitLine:{lineStyle:{opacity:.5,type:"dashed"},show:!0},type:"value"},yAxis:{axisLabel:{fontFamily:"monospace",fontSize:10},axisLine:{show:!0},axisTick:{show:!0},data:["wide-max","wide-avg","wide-min","","safe-max","safe-avg","safe-min","","norm-max","norm-avg","norm-min","","fast-max","fast-avg","fast-min"],splitLine:{show:!1},type:"category"}};function n(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,s,o=e.substring(4);return window._echartsFns[o]}if(Array.isArray(e))return e.map(n);if(e&&typeof e=="object"){t={};for(s in e)t[s]=n(e[s]);return t}return e}s=n(a),e.setOption(s),window.addEventListener("resize",function(){e.resize()}),r=new MutationObserver(function(n){n.forEach(function(n){if(n.attributeName==="data-bs-theme"){var o=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;e.dispose(),e=echarts.init(t,o),e.setOption(s)}})}),r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=故障模型>故障模型</h2><table class=full-width><thead><tr><th style=text-align:center>项目</th><th style=text-align:center>最好</th><th style=text-align:center>最坏</th><th style=text-align:center>平均</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center><strong>故障检测</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>最好：PG 恰好在检测前崩溃<br>最坏：PG 刚检测完就崩溃</td></tr><tr><td style=text-align:center><strong>重启超时</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>start</code></td><td style=text-align:left>最好：PG 瞬间自愈<br>最坏：等满 start 超时才释放租约</td></tr><tr><td style=text-align:center><strong>从库检测</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>loop</code></td><td style=text-align:center><code>loop/2</code></td><td style=text-align:left>最好：恰好在检测点<br>最坏：刚错过检测点</td></tr><tr><td style=text-align:center><strong>抢锁提拔</strong></td><td style=text-align:center><code>0</code></td><td style=text-align:center><code>2</code></td><td style=text-align:center><code>1</code></td><td style=text-align:left>最好：直接抢锁提升<br>最坏：API 超时 + Promote</td></tr><tr><td style=text-align:center><strong>健康检查</strong></td><td style=text-align:center><code>(rise-1) × fastinter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter</code></td><td style=text-align:center><code>(rise-1) × fastinter + inter/2</code></td><td style=text-align:left>最好：检查前状态变化<br>最坏：检查后瞬间状态变化</td></tr></tbody></table><p><strong>主动故障与被动故障的核心区别</strong>：</p><table class=full-width><thead><tr><th style=text-align:center>场景</th><th style=text-align:center>Patroni 状态</th><th style=text-align:center>租约处理</th><th style=text-align:center>主要等待时间</th></tr></thead><tbody><tr><td style=text-align:center><strong>主动故障</strong>（PG 崩溃）</td><td style=text-align:center>存活，健康</td><td style=text-align:center>主动尝试重启 PG，超时后释放租约</td><td style=text-align:center><code>primary_start_timeout</code></td></tr><tr><td style=text-align:center><strong>被动故障</strong>（节点宕机）</td><td style=text-align:center>随节点一起死亡</td><td style=text-align:center>无法主动释放，只能等待 TTL 过期</td><td style=text-align:center><code>ttl</code></td></tr></tbody></table><p>在主动故障场景中，Patroni 仍然存活，能够<strong>主动检测到 PG 崩溃并尝试重启</strong>。
如果重启成功，服务自愈；如果超时仍未恢复，Patroni 会<strong>主动释放 Leader Key</strong>，触发集群选举。</p><hr><h2 id=时序分析>时序分析</h2><h3 id=阶段-1故障检测>阶段 1：故障检测</h3><p>Patroni 在每个 <code>loop_wait</code> 周期检查 PostgreSQL 状态（通过 <code>pg_isready</code> 或检查进程）。</p><pre tabindex=0><code>时间线：
    上次检测      PG崩溃      下次检测
       |           |           |
       |←── 0~loop ─→|          |
</code></pre><ul><li><strong>最好情况</strong>：PG 恰好在 Patroni 检测前崩溃，立即被发现，等待 <code>0</code></li><li><strong>最坏情况</strong>：PG 刚检测完就崩溃，需等待下一个周期，等待 <code>loop</code></li><li><strong>平均情况</strong>：<code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>d</mi><mi>e</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{detect} = \begin{cases}
0 &amp; \text{最好} \\
loop/2 &amp; \text{平均} \\
loop &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-2重启超时>阶段 2：重启超时</h3><p>Patroni 检测到 PG 崩溃后，会尝试重启 PostgreSQL。此阶段有两种可能的结果：</p><pre tabindex=0><code>时间线：
  检测到崩溃     尝试重启     重启成功/超时
      |           |             |
      |←──── 0 ~ start ────────→|
</code></pre><p><strong>路径 A：自愈成功</strong>（最好情况）</p><ul><li>PG 成功重启，服务恢复</li><li>不触发故障切换，RTO 极短</li><li>等待时间：<code>0</code>（相对于 Failover 路径）</li></ul><p><strong>路径 B：需要 Failover</strong>（平均/最坏情况）</p><ul><li>等待 <code>primary_start_timeout</code> 超时后 PG 仍未恢复</li><li>Patroni 主动释放 Leader Key</li><li>等待时间：<code>start</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>r</mi><mi>e</mi><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好（自愈成功）</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均（需要 Failover）</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{restart} = \begin{cases}
0 &amp; \text{最好（自愈成功）} \\
start &amp; \text{平均（需要 Failover）} \\
start &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.2806em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">res</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.02778em>r</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好（自愈成功）</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均（需要</span><span class=mord> Failover</span><span class="mord cjk_fallback">）</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><blockquote><p><strong>注意</strong>：平均情况假设需要进行故障切换。如果 PG 能够快速自愈，则整体 RTO 会大幅降低。</p></blockquote><h3 id=阶段-3从库检测>阶段 3：从库检测</h3><p>从库在 <code>loop_wait</code> 周期醒来后检查 DCS 中的 Leader Key 状态。当主库 Patroni 释放 Leader Key 后，从库发现后开始竞选。</p><pre tabindex=0><code>时间线：
    租约释放      从库醒来
       |            |
       |←── 0~loop ─→|
</code></pre><ul><li><strong>最好情况</strong>：租约释放时从库恰好醒来，等待 <code>0</code></li><li><strong>最坏情况</strong>：租约释放后从库刚进入睡眠，等待 <code>loop</code></li><li><strong>平均情况</strong>：<code>loop/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>s</mi><mi>t</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi>b</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{standby} = \begin{cases}
0 &amp; \text{最好} \\
loop/2 &amp; \text{平均} \\
loop &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">an</span><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">b</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-4抢锁提拔>阶段 4：抢锁提拔</h3><p>从库发现 Leader Key 空缺后，开始竞选过程，获得 Leader Key 的从库执行 <code>pg_ctl promote</code>，将自己提升为新主库。</p><ol><li>通过 Rest API，并行发起查询，查询各从库的复制位置，通常 10ms，硬编码 2 秒超时。</li><li>比较 WAL 位置，确定最优候选，各从库尝试创建 Leader Key（CAS 原子操作）</li><li>执行 <code>pg_ctl promote</code> 提升自己为主库（很快，通常忽略不计）</li></ol><pre tabindex=0><code>选举流程：
  从库A ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 成功
  从库B ──→ 查询复制位置 ──→ 比较 ──→ 尝试抢锁 ──→ 失败
</code></pre><ul><li><strong>最好情况</strong>：单从库或直接抢到锁并提升，常数开销 <code>0.1s</code></li><li><strong>最坏情况</strong>：DCS API 调用超时：<code>2s</code></li><li><strong>平均情况</strong>：<code>1s</code> 常数开销</li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>e</mi><mi>l</mi><mi>e</mi><mi>c</mi><mi>t</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0.1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>2</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{elect} = \begin{cases}
0.1 &amp; \text{最好} \\
1 &amp; \text{平均} \\
2 &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight" style=margin-right:.01968em>l</span><span class="mord mathnormal mtight">ec</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>0.1</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>1</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mord>2</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><h3 id=阶段-5健康检查>阶段 5：健康检查</h3><p>HAProxy 检测新主库上线，需要连续 <code>rise</code> 次健康检查成功。</p><pre tabindex=0><code>检测时序：
  新主提升    首次检查    第二次检查   第三次检查（UP）
     |          |           |           |
     |←─ 0~inter ─→|←─ fast ─→|←─ fast ─→|
</code></pre><ul><li><strong>最好情况</strong>：新主提升时恰好赶上检查，<code>(rise-1) × fastinter</code></li><li><strong>最坏情况</strong>：新主提升后刚错过检查，<code>(rise-1) × fastinter + inter</code></li><li><strong>平均情况</strong>：<code>(rise-1) × fastinter + inter/2</code></li></ul><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>T</mi><mrow><mi>h</mi><mi>a</mi><mi>p</mi><mi>r</mi><mi>o</mi><mi>x</mi><mi>y</mi></mrow></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最好</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>平均</mtext></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>最坏</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">T_{haproxy} = \begin{cases}
(rise-1) \times fastinter &amp; \text{最好} \\
(rise-1) \times fastinter + inter/2 &amp; \text{平均} \\
(rise-1) \times fastinter + inter &amp; \text{最坏}
\end{cases}</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class=mord><span class="mord mathnormal" style=margin-right:.13889em>T</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3361em><span style=top:-2.55em;margin-left:-.1389em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ha</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">ro</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style=margin-right:.03588em>y</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:4.32em;vertical-align:-1.91em></span><span class=minner><span class=mopen><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.35em><span style=top:-2.2em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style=top:-2.192em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-3.15em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style=top:-4.292em><span class=pstrut style=height:3.15em></span><span style=height:.316em;width:.8889em><svg width=".8889em" height=".316em" style="width:.8889em" viewBox="0 0 888.89 316" preserveAspectRatio="xMinYMin"><path d="M384 0H504V316H384zm0 0H504V316H384z"/></svg></span></span><span style=top:-4.6em><span class=pstrut style=height:3.15em></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.85em><span></span></span></span></span></span></span><span class=mord><span class=mtable><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span><span class=arraycolsep style=width:1em></span><span class=col-align-l><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:2.41em><span style=top:-4.41em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最好</span></span></span></span><span style=top:-2.97em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">平均</span></span></span></span><span style=top:-1.53em><span class=pstrut style=height:3.008em></span><span class=mord><span class="mord text"><span class="mord cjk_fallback">最坏</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:1.91em><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span><hr><h2 id=rto-公式>RTO 公式</h2><p>将各阶段时间相加，得到总 RTO：</p><p><strong>最好情况</strong>（PG 瞬间自愈）</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow></msub><mo>=</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0</mn><mo>+</mo><mn>0.1</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>≈</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{min} = 0 + 0 + 0 + 0.1 + (rise-1) \times fastinter \approx (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.3117em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">min</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>0.1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2778em></span><span class=mrel>≈</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>平均情况</strong>（需要 Failover）</p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>a</mi><mi>v</mi><mi>g</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>1</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mi mathvariant="normal">/</mi><mn>2</mn><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{avg} = loop + start + 1 + inter/2 + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.9694em;vertical-align:-.2861em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight" style=margin-right:.03588em>vg</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.2861em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>1</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mord>/2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><p><strong>最坏情况</strong></p><span class=katex-display><span class=katex><span class=katex-mathml><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>R</mi><mi>T</mi><msub><mi>O</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mo>=</mo><mi>l</mi><mi>o</mi><mi>o</mi><mi>p</mi><mo>×</mo><mn>2</mn><mo>+</mo><mi>s</mi><mi>t</mi><mi>a</mi><mi>r</mi><mi>t</mi><mo>+</mo><mn>2</mn><mo>+</mo><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi><mo>+</mo><mo stretchy="false">(</mo><mi>r</mi><mi>i</mi><mi>s</mi><mi>e</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo><mo>×</mo><mi>f</mi><mi>a</mi><mi>s</mi><mi>t</mi><mi>i</mi><mi>n</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">RTO_{max} = loop \times 2 + start + 2 + inter + (rise-1) \times fastinter</annotation></semantics></math></span><span class=katex-html aria-hidden=true><span class=base><span class=strut style=height:.8333em;vertical-align:-.15em></span><span class="mord mathnormal" style=margin-right:.13889em>RT</span><span class=mord><span class="mord mathnormal" style=margin-right:.02778em>O</span><span class=msupsub><span class="vlist-t vlist-t2"><span class=vlist-r><span class=vlist style=height:.1514em><span style=top:-2.55em;margin-left:-.0278em;margin-right:.05em><span class=pstrut style=height:2.7em></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class=vlist-s>​</span></span><span class=vlist-r><span class=vlist style=height:.15em><span></span></span></span></span></span></span><span class=mspace style=margin-right:.2778em></span><span class=mrel>=</span><span class=mspace style=margin-right:.2778em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.01968em>l</span><span class="mord mathnormal">oo</span><span class="mord mathnormal">p</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.6984em;vertical-align:-.0833em></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">t</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7278em;vertical-align:-.0833em></span><span class=mord>2</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.7429em;vertical-align:-.0833em></span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>+</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mopen>(</span><span class="mord mathnormal" style=margin-right:.02778em>r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">se</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>−</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:1em;vertical-align:-.25em></span><span class=mord>1</span><span class=mclose>)</span><span class=mspace style=margin-right:.2222em></span><span class=mbin>×</span><span class=mspace style=margin-right:.2222em></span></span><span class=base><span class=strut style=height:.8889em;vertical-align:-.1944em></span><span class="mord mathnormal" style=margin-right:.10764em>f</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">in</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style=margin-right:.02778em>er</span></span></span></span></span><hr><h2 id=模型计算>模型计算</h2><p>将四种 RTO 模型的参数带入上面的公式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>四种模式计算结果</strong>（单位：秒，格式：min / avg / max）</p><table class=full-width><thead><tr><th style=text-align:center>阶段</th><th style=text-align:center>fast</th><th style=text-align:center>norm</th><th style=text-align:center>safe</th><th style=text-align:center>wide</th></tr></thead><tbody><tr><td style=text-align:center>故障检测</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>重启超时</td><td style=text-align:center><code>0</code> / <code>15</code> / <code>15</code></td><td style=text-align:center><code>0</code> / <code>25</code> / <code>25</code></td><td style=text-align:center><code>0</code> / <code>45</code> / <code>45</code></td><td style=text-align:center><code>0</code> / <code>95</code> / <code>95</code></td></tr><tr><td style=text-align:center>从库检测</td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>3</code> / <code>5</code></td><td style=text-align:center><code>0</code> / <code>5</code> / <code>10</code></td><td style=text-align:center><code>0</code> / <code>10</code> / <code>20</code></td></tr><tr><td style=text-align:center>抢锁提拔</td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td><td style=text-align:center><code>0</code> / <code>1</code> / <code>2</code></td></tr><tr><td style=text-align:center>健康检查</td><td style=text-align:center><code>1</code> / <code>2</code> / <code>2</code></td><td style=text-align:center><code>2</code> / <code>3</code> / <code>4</code></td><td style=text-align:center><code>3</code> / <code>5</code> / <code>6</code></td><td style=text-align:center><code>4</code> / <code>6</code> / <code>8</code></td></tr><tr><td style=text-align:center><strong>总计</strong></td><td style=text-align:center><code>1</code> / <code>24</code> / <code>29</code></td><td style=text-align:center><code>2</code> / <code>35</code> / <code>41</code></td><td style=text-align:center><code>3</code> / <code>61</code> / <code>73</code></td><td style=text-align:center><code>4</code> / <code>122</code> / <code>145</code></td></tr></tbody></table><hr><h2 id=与被动故障对比>与被动故障对比</h2><table class=full-width><thead><tr><th style=text-align:center>阶段</th><th style=text-align:center>主动故障（PG 崩溃）</th><th style=text-align:center>被动故障（节点宕机）</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center>检测机制</td><td style=text-align:center>Patroni 主动检测</td><td style=text-align:center>TTL 被动过期</td><td style=text-align:left>主动检测更快发现故障</td></tr><tr><td style=text-align:center>核心等待</td><td style=text-align:center><code>start</code></td><td style=text-align:center><code>ttl</code></td><td style=text-align:left>start 通常小于 ttl，但需要额外的故障检测时间</td></tr><tr><td style=text-align:center>租约处理</td><td style=text-align:center>主动释放</td><td style=text-align:center>被动过期</td><td style=text-align:left>主动释放更及时</td></tr><tr><td style=text-align:center>自愈可能</td><td style=text-align:center>✅ 有</td><td style=text-align:center>❌ 无</td><td style=text-align:left>主动检测可尝试本地恢复</td></tr></tbody></table><p><strong>RTO 对比</strong>（平均情况）：</p><table class=full-width><thead><tr><th style=text-align:center>模式</th><th style=text-align:center>主动故障（PG 崩溃）</th><th style=text-align:center>被动故障（节点宕机）</th><th style=text-align:left>差异</th></tr></thead><tbody><tr><td style=text-align:center>fast</td><td style=text-align:center>24s</td><td style=text-align:center>23s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>norm</td><td style=text-align:center>35s</td><td style=text-align:center>34s</td><td style=text-align:left>+1s</td></tr><tr><td style=text-align:center>safe</td><td style=text-align:center>61s</td><td style=text-align:center>66s</td><td style=text-align:left>-5s</td></tr><tr><td style=text-align:center>wide</td><td style=text-align:center>122s</td><td style=text-align:center>127s</td><td style=text-align:left>-5s</td></tr></tbody></table><blockquote><p><strong>分析</strong>：在 <code>fast</code> 和 <code>norm</code> 模式下，主动故障的 RTO 略高于被动故障，因为需要等待 <code>primary_start_timeout</code>（<code>start</code>）；
但在 <code>safe</code> 和 <code>wide</code> 模式下，由于 <code>start &lt; ttl - loop</code>，主动故障反而更快。
不过主动故障有自愈的可能性，最好情况下 RTO 可以极短。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-895a94576239d65b824c6e6ae06deb76>4.4 - 服务接入</h1><div class=lead>Pigsty 使用 HAProxy 提供服务接入，并提供可选的 pgBouncer 池化连接，以及可选的 L2 VIP 与 DNS 接入。</div><blockquote><p>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</p></blockquote><p><a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>服务</a> 是一种抽象：它是数据库集群对外提供能力的形式，并封装了底层集群的细节。</p><p>服务对于生产环境中的 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>稳定接入</a> 至关重要，在 <a href=/docs/concept/ha>高可用</a> 集群自动故障时方显其价值，<a href=#%E5%8D%95%E6%9C%BA%E7%94%A8%E6%88%B7>单机用户</a> 通常不需要操心这个概念。</p><hr><h2 id=单机用户>单机用户</h2><p>“服务” 的概念是给生产环境用的，个人用户/单机集群可以不折腾，直接拿实例名/IP地址访问数据库。</p><p>例如，Pigsty 默认的单节点 <code>pg-meta</code>.<code>meta</code> 数据库，就可以直接用下面三个不同的用户连接上去。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># 直接用 DBA 超级用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># 用默认的业务管理员用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># 用默认的只读用户走实例域名连上去</span>
</span></span></code></pre></div><hr><h2 id=服务概述>服务概述</h2><p>在真实世界生产环境中，我们会使用基于复制的主从数据库集群。集群中有且仅有一个实例作为领导者（<a href=/docs/pgsql/config/cluster#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93>主库</a>）可以接受写入。
而其他实例（<a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>从库</a>）则会从持续从集群领导者获取变更日志，与领导者保持一致。同时，从库还可以承载只读请求，在读多写少的场景下可以显著分担主库的负担，
因此对集群的写入请求与只读请求进行区分，是一种十分常见的实践。</p><p>此外对于高频短连接的生产环境，我们还会通过连接池中间件（Pgbouncer）对请求进行池化，减少连接与后端进程的创建开销。但对于ETL与变更执行等场景，我们又需要绕过连接池，直接访问数据库。
同时，高可用集群在故障时会出现故障切换（Failover），故障切换会导致集群的领导者出现变更。因此高可用的数据库方案要求写入流量可以自动适配集群的领导者变化。
这些不同的访问需求（读写分离，池化与直连，故障切换自动适配）最终抽象出 <strong>服务</strong> （Service）的概念。</p><p>通常来说，数据库集群都必须提供这种最基础的服务：</p><ul><li><strong>读写服务（primary）</strong> ：可以读写数据库</li></ul><p>对于生产数据库集群，至少应当提供这两种服务：</p><ul><li><strong>读写服务（primary）</strong> ：写入数据：只能由主库所承载。</li><li><strong>只读服务（replica）</strong> ：读取数据：可以由从库承载，没有从库时也可由主库承载</li></ul><p>此外，根据具体的业务场景，可能还会有其他的服务，例如：</p><ul><li><strong>默认直连服务（default）</strong> ：允许（管理）用户，绕过连接池直接访问数据库的服务</li><li><strong>离线从库服务（offline）</strong> ：不承接线上只读流量的专用从库，用于ETL与分析查询</li><li><strong>同步从库服务（standby）</strong> ：没有复制延迟的只读服务，由 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a> /主库处理只读查询</li><li><strong>延迟从库服务（delayed）</strong> ：访问同一个集群在一段时间之前的旧数据，由 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟从库</a> 来处理</li></ul><hr><h2 id=接入服务>接入服务</h2><p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器。</p><p>典型的做法是使用 DNS 或 VIP 接入，将其绑定在集群所有或任意数量的负载均衡器上。</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>你可以使用不同的 主机 & 端口 组合，它们以不同的方式提供 PostgreSQL 服务。</p><p><strong>主机</strong></p><table class=full-width><thead><tr><th>类型</th><th>样例</th><th>描述</th></tr></thead><tbody><tr><td>集群域名</td><td><code>pg-test</code></td><td>通过集群域名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>集群 VIP 地址</td><td><code>10.10.10.3</code></td><td>通过由 <code>vip-manager</code> 管理的 L2 VIP 地址访问，绑定到主节点</td></tr><tr><td>实例主机名</td><td><code>pg-test-1</code></td><td>通过任何实例主机名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>实例 IP 地址</td><td><code>10.10.10.11</code></td><td>访问任何实例的 IP 地址</td></tr></tbody></table><p><strong>端口</strong></p><p>Pigsty 使用不同的 <strong>端口</strong> 来区分 <a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>pg services</a></p><table class=full-width><thead><tr><th>端口</th><th>服务</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>数据库</td><td>直接访问 postgres 服务器</td></tr><tr><td>6432</td><td>pgbouncer</td><td>中间件</td><td>访问 postgres 前先通过连接池中间件</td></tr><tr><td>5433</td><td>primary</td><td>服务</td><td>访问主 pgbouncer (或 postgres)</td></tr><tr><td>5434</td><td>replica</td><td>服务</td><td>访问备份 pgbouncer (或 postgres)</td></tr><tr><td>5436</td><td>default</td><td>服务</td><td>访问主 postgres</td></tr><tr><td>5438</td><td>offline</td><td>服务</td><td>访问离线 postgres</td></tr></tbody></table><p><strong>组合</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群域名访问</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主直接连接</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群 VIP 直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例名</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 数据库实例直接连接 (单例访问)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库离线读/写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例 IP 访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># 数据库实例直接连接 (直接指定实例, 没有自动流量分配)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库离线读-写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 智能客户端：通过URL读写分离</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-89cc2a8924ee8ac9c638f7a0a941f56b>5 - 时间点恢复</h1><div class=lead>Pigsty 使用 pgBackRest 实现了 PostgreSQL 时间点恢复，允许用户回滚至备份策略容许范围内的任意时间点。</div><blockquote><p>当您不小心删除了数据、表、甚至整个数据库时，PITR 能力让您回到过去任意时刻，避免软件缺陷与人为失误导致的数据损失。</p><p>—— 这个曾经只有资深 DBA 才能施展的『魔法』，现在对所有用户都可以轻松做到零配置开箱即用。</p></blockquote><hr><h2 id=概览>概览</h2><p>Pigsty 的 PostgreSQL 集群带有自动配置的时间点恢复（PITR）方案，基于 <a href=https://pgbackrest.org/><strong>pgBackRest</strong></a> 与可选的对象存储仓库 <a href=https://min.io/><strong>MinIO</strong></a> 提供。</p><p><a href=/docs/concept/ha><strong>高可用方案</strong></a> 可以解决硬件故障，但却对软件缺陷与人为失误导致的数据删除/覆盖写入/删库等问题却无能为力。
对于这种情况，Pigsty 提供了开箱即用的 <strong>时间点恢复</strong>（Point in Time Recovery, PITR）能力，无需额外配置即默认启用。</p><p>Pigsty 为您提供了基础备份与 WAL 归档的默认配置，您可以使用本地目录与磁盘，亦或专用的 MinIO 集群或 S3 对象存储服务来存储备份并实现异地容灾。
当您使用本地磁盘时，默认保留恢复至过去一天内的任意时间点的能力。当您使用 MinIO 或 S3 时，默认保留恢复至过去一周内的任意时间点的能力。
只要存储空间管够，您尽可保留任意长地可恢复时间段，丰俭由人。</p><hr><h3 id=时间点恢复解决什么问题>时间点恢复解决什么问题？</h3><ul><li>容灾能⼒增强：<strong>RPO</strong> 从 ∞ 降⾄ ⼗⼏MB， <strong>RTO</strong> 从 ∞ 降⾄ ⼏⼩时/⼏刻钟。</li><li>确保数据安全：C/I/A 中的 <strong>数据完整性</strong>：避免误删导致的数据⼀致性问题。</li><li>确保数据安全：C/I/A 中的 <strong>数据可⽤性</strong>：提供对“永久不可⽤”这种灾难情况的兜底</li></ul><table class=full-width><thead><tr><th>单实例配置策略</th><th style=text-align:center>事件</th><th>RTO</th><th style=text-align:left>RPO</th></tr></thead><tbody><tr><td><i class="fa-solid fa-music text-danger"></i> 什么也不做</td><td style=text-align:center>宕机</td><td><i class="fas fa-circle-xmark text-danger"></i> <strong>永久丢失</strong></td><td style=text-align:left><i class="fas fa-circle-xmark text-danger"></i> <strong>全部丢失</strong></td></tr><tr><td><i class="fa-solid fa-copy text-secondary"></i> 基础备份</td><td style=text-align:center>宕机</td><td><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 取决于备份大小与带宽（几小时）</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-secondary"></i> 丢失上一次备份后的数据（几个小时到几天）</td></tr><tr><td><i class="fa-solid fa-copy text-primary"></i> 基础备份 + <i class="fa-solid fa-clock-rotate-left text-primary"></i> WAL归档</td><td style=text-align:center>宕机</td><td><i class="fa-solid fa-triangle-exclamation text-primary"></i> 取决于备份大小与带宽（几小时）</td><td style=text-align:left><i class="fa-solid fa-triangle-exclamation text-primary"></i> 丢失最后尚未归档的数据（几十MB）</td></tr></tbody></table><h3 id=时间点恢复有什么代价>时间点恢复有什么代价？</h3><ul><li>降低数据安全中的 C：<strong>机密性</strong>，产生额外泄漏点，需要额外对备份进⾏保护。</li><li>额外的资源消耗：本地存储或⽹络流量 / 带宽开销，通常并不是⼀个问题。</li><li>复杂度代价升⾼：⽤户需要付出备份管理成本。</li></ul><h3 id=时间点恢复的局限性>时间点恢复的局限性</h3><p>如果只有 PITR 用于故障恢复，则 RTO 与 RPO 指标相比 <a href=/docs/concept/ha/><strong>高可用方案</strong></a> 更为逊色，通常应两者组合使用。</p><ul><li><strong>RTO</strong>：如果只有单机 + PITR，恢复时长取决于备份大小与网络/磁盘带宽，从十几分钟到几小时，几天不等。</li><li><strong>RPO</strong>：如果只有单机 + PITR，宕机时可能丢失少量数据，一个或几个 WAL 日志段文件可能尚未归档，损失 16 MB 到⼏⼗ MB 不等的数据。</li></ul><p>除了 <a href=/docs/concept/pitr><strong>PITR</strong></a> 之外，您还可以在 Pigsty 中使用 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4><strong>延迟集群</strong></a> 来解决人为失误或软件缺陷导致的数据误删误改问题。</p><hr><h2 id=原理>原理</h2><p>时间点恢复允许您将集群恢复回滚至过去的“任意时刻”，避免软件缺陷与人为失误导致的数据损失。要做到这一点，首先需要做好两样准备工作：<a href=#%E5%9F%BA%E7%A1%80%E5%A4%87%E4%BB%BD><strong>基础备份</strong></a> 与 <a href=#wal%E5%BD%92%E6%A1%A3><strong>WAL归档</strong></a>。
拥有 <strong>基础备份</strong>，允许用户将数据库恢复至备份时的状态，而同时拥有从某个基础备份开始的 <strong>WAL归档</strong>，允许用户将数据库恢复至基础备份时刻之后的任意时间点。</p><p>详细原理，请参阅：<a href=/blog/pg/backup-overview/><strong>基础备份与时间点恢复</strong></a>；具体操作，请参考 <a href=/docs/pgsql/backup/><strong>PGSQL管理：备份恢复</strong></a>。</p><h3 id=基础备份>基础备份</h3><p>Pigsty 使用 pgbackrest 管理 PostgreSQL 备份。pgBackRest 将在所有集群实例上初始化空仓库，但只会在集群主库上实际使用仓库。</p><p>pgBackRest 支持三种备份模式：<strong>全量备份</strong>，<strong>增量备份</strong>，差异备份，其中前两者最为常用。
全量备份将对数据库集群取一个当前时刻的全量物理快照，增量备份会记录当前数据库集群与上一次全量备份之间的差异。</p><p>Pigsty 为备份提供了封装命令：<code>/pg/bin/pg-backup [full|incr]</code>。您可以通过 Crontab 或任何其他任务调度系统，按需定期制作基础备份。</p><h3 id=wal归档>WAL归档</h3><p>Pigsty 默认在集群主库上启⽤了 WAL 归档，并使⽤ <code>pgbackrest</code> 命令行工具持续推送 WAL 段⽂件至备份仓库。</p><p>pgBackRest 会⾃动管理所需的 WAL ⽂件，并根据备份的保留策略及时清理过期的备份，与其对应的 WAL 归档⽂件。</p><p>如果您不需要 PITR 功能，可以通过 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4><strong>配置集群</strong></a>： <code>archive_mode: off</code> 来关闭 WAL 归档，移除 <a href=/docs/node/param#node_crontab><code>node_crontab</code></a> 来停止定期备份任务。</p><hr><h2 id=实现>实现</h2><p>默认情况下，Pigsty提供了两种预置 <a href=/docs/pgsql/backup/policy>备份策略</a>：默认使用本地文件系统备份仓库，在这种情况下每天进行一次全量备份，确保用户任何时候都能回滚至一天内的任意时间点。备选策略使用专用的 MinIO 集群或S3存储备份，每周一全备，每天一增备，默认保留两周的备份与WAL归档。</p><p>Pigsty 使用 pgBackRest 管理备份，接收 WAL 归档，执行 PITR。备份仓库可以进行灵活配置（<a href=/docs/pgsql/param#pgbackrest_repo><code>pgbackrest_repo</code></a>）：默认使用主库本地文件系统（<code>local</code>），但也可以使用其他磁盘路径，或使用自带的可选 <a href=/docs/minio>MinIO</a> 服务（<code>minio</code>）与云上 S3 服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 在 pgsql 主机上启用 pgBackRest 吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_clean</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 初始化时删除 pg 备份数据？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/pgbackrest</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 日志目录，默认为 `/pg/log/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 仓库方法：local, minio, [用户定义...]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># pgbackrest 仓库：https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 默认使用本地 posix 文件系统的 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按计数保留完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，最多保留 3 个完整备份，至少保留 2 个</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># pgbackrest 的可选 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 是与 s3 兼容的，所以使用 s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认为 us-east-1，对 minio 无效</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名称，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户秘密密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 对 minio 使用路径风格的 uri，而不是主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认为 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio ca 文件路径，默认为 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成一个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 在 minio 仓库上按时间保留完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留过去 14 天的完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 您还可以添加其他的可选备份仓库，例如 S3，用于异地容灾</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 参数 <a href=/docs/pgsql/param#pgbackrest_repo><code>pgbackrest_repo</code></a> 中的目标仓库会被转换为 <code>/etc/pgbackrest/pgbackrest.conf</code> 配置文件中的仓库定义。
例如，如果您定义了一个美西区的 S3 仓库用于存储冷备份，可以使用下面的参考配置。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>s3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ------&gt; /etc/pgbackrest/pgbackrest.conf</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-type=s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-west-1                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-region=us-west-1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3-us-west-1.amazonaws.com   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-endpoint=s3-us-west-1.amazonaws.com</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&lt;your_access_key&gt;&#39;</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-key=&lt;your_access_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-key-secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&lt;your_secret_key&gt;&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-key-secret=&lt;your_secret_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql                          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-bucket=pgsql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-s3-uri-style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>host                        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-s3-uri-style=host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest                         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-path=/pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                                  </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-bundle=y</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-cipher-type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-cipher-type=aes-256-cbc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-cipher-pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-cipher-pass=pgBackRest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-retention-full-type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-retention-full-type=time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo1-retention-full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># ----&gt; repo1-retention-full=90</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=恢复>恢复</h2><p>您可以直接使用以下封装命令可以用于 PostgreSQL 数据库集群的 <a href=https://pgbackrest.org/command.html#command-restore>时间点恢复</a>。</p><p>Pigsty 默认使用增量差分并行恢复，允许您以最快速度恢复到指定时间点。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr                                 <span style=color:#8f5902;font-style:italic># 恢复到WAL存档流的结束位置（例如在整个数据中心故障的情况下使用）</span>
</span></span><span style=display:flex><span>pg-pitr -i                              <span style=color:#8f5902;font-style:italic># 恢复到最近备份完成的时间（不常用）</span>
</span></span><span style=display:flex><span>pg-pitr --time<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;2022-12-30 14:44:44+08&#34;</span> <span style=color:#8f5902;font-style:italic># 恢复到指定的时间点（在删除数据库或表的情况下使用）</span>
</span></span><span style=display:flex><span>pg-pitr --name<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;my-restore-point&#34;</span>       <span style=color:#8f5902;font-style:italic># 恢复到使用 pg_create_restore_point 创建的命名恢复点</span>
</span></span><span style=display:flex><span>pg-pitr --lsn<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span> -X            <span style=color:#8f5902;font-style:italic># 在LSN之前立即恢复</span>
</span></span><span style=display:flex><span>pg-pitr --xid<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;1234567&#34;</span> -X -P           <span style=color:#8f5902;font-style:italic># 在指定的事务ID之前立即恢复，然后将集群直接提升为主库</span>
</span></span><span style=display:flex><span>pg-pitr --backup<span style=color:#ce5c00;font-weight:700>=</span>latest                 <span style=color:#8f5902;font-style:italic># 恢复到最新的备份集</span>
</span></span><span style=display:flex><span>pg-pitr --backup<span style=color:#ce5c00;font-weight:700>=</span>20221108-105325        <span style=color:#8f5902;font-style:italic># 恢复到特定备份集，备份集可以使用 pgbackrest info 列出</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg-pitr                                 <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta restore</span>
</span></span><span style=display:flex><span>pg-pitr -i                              <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=immediate restore</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2022-12-30 14:44:44+08&#34;</span>     <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=time --target=&#34;2022-12-30 14:44:44+08&#34; restore</span>
</span></span><span style=display:flex><span>pg-pitr -n <span style=color:#4e9a06>&#34;my-restore-point&#34;</span>           <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=name --target=my-restore-point restore</span>
</span></span><span style=display:flex><span>pg-pitr -b 20221108-105325F             <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=name --set=20221230-120101F restore</span>
</span></span><span style=display:flex><span>pg-pitr -l <span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span> -X               <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=lsn --target=&#34;0/7C82CB8&#34; --target-exclusive restore</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>1234567</span> -X -P                <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta --type=xid --target=&#34;0/7C82CB8&#34; --target-exclusive --target-action=promote restore</span>
</span></span></code></pre></div><p>在执行 PITR 时，您可以使用 Pigsty 监控系统观察集群 LSN 位点状态，判断是否成功恢复到指定的时间点，事务点，LSN位点，或其他点位。</p><p><img src=/img/docs/concept/pitr.png alt=pitr></p></div><div class=td-content style=page-break-before:always><h1 id=pg-38cea9754a736f991ef94b09725db17e>5.1 - 时间点恢复的工作原理</h1><div class=lead>本文解释 PITR 的工作机制，帮助您建立正确的心智模型：基础备份、WAL 归档、恢复窗口与事务边界</div><p>时间点恢复（PITR）的核心原理是：<strong>基础备份 + WAL 归档 = 任意时间点恢复能力</strong>。
在 Pigsty 中，这一能力由 <strong>pgBackRest</strong> 实现，并通过 <strong>定时备份 + WAL 归档</strong> 自动运行。</p><hr><h2 id=三要素>三要素</h2><table class=full-width><thead><tr><th style=text-align:left>要素</th><th style=text-align:left>作用</th><th style=text-align:left>Pigsty 实现</th></tr></thead><tbody><tr><td style=text-align:left><strong>基础备份</strong></td><td style=text-align:left>提供一致的物理快照，决定恢复起点</td><td style=text-align:left><code>pg-backup</code> + <code>pgbackrest</code> + <a href=/docs/pgsql/param#pg_crontab><code>pg_crontab</code></a></td></tr><tr><td style=text-align:left><strong>WAL 归档</strong></td><td style=text-align:left>记录备份后的所有变更，决定恢复路径</td><td style=text-align:left><code>archive_mode=on</code> + <code>archive_command=pgbackrest ... archive-push</code></td></tr><tr><td style=text-align:left><strong>恢复目标</strong></td><td style=text-align:left>指定恢复停止位置</td><td style=text-align:left><code>pg_pitr</code> 参数 / <code>pg-pitr</code> 脚本 / <code>pgbackrest restore</code></td></tr></tbody></table><hr><h2 id=基础备份>基础备份</h2><p><strong>基础备份</strong>是数据库在某一时刻的物理快照，是 PITR 的恢复起点。Pigsty 通过 <code>pgBackRest</code> 生成基础备份，并提供 <code>pg-backup</code> 脚本封装常用操作。</p><h3 id=备份类型>备份类型</h3><table class=full-width><thead><tr><th style=text-align:left>类型</th><th style=text-align:left>说明</th><th style=text-align:left>恢复开销</th></tr></thead><tbody><tr><td style=text-align:left><strong>全量备份</strong>（Full）</td><td style=text-align:left>复制全部数据文件</td><td style=text-align:left>恢复最快，空间占用最大</td></tr><tr><td style=text-align:left><strong>差异备份</strong>（Differential）</td><td style=text-align:left>相对最近一次全量备份的变化</td><td style=text-align:left>恢复需要全量 + 差异</td></tr><tr><td style=text-align:left><strong>增量备份</strong>（Incremental）</td><td style=text-align:left>相对最近一次任意备份的变化</td><td style=text-align:left>空间最省，恢复需要完整链路</td></tr></tbody></table><h3 id=pigsty-的默认行为>Pigsty 的默认行为</h3><ul><li><code>pg-backup</code> <strong>默认执行增量备份</strong>，若不存在全量备份会自动补一次全量。</li><li>备份任务通过 <a href=/docs/pgsql/param#pg_crontab><code>pg_crontab</code></a> 配置，写入 <code>postgres</code> 用户的 crontab。</li><li>脚本会自动识别节点角色，<strong>只有主库实际执行</strong>，从库会直接退出。</li></ul><p>备份频率越高，需要重放的 WAL 越少，恢复速度越快。
更多细节请参阅 <a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a> 与 <a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a>。</p><hr><h2 id=wal-归档>WAL 归档</h2><p><strong>WAL</strong>（Write-Ahead Log）记录了数据库的每一次变更。PITR 通过持续归档 WAL，确保能够把数据库从基础备份重放到指定时刻。</p><h3 id=pigsty-的归档链路>Pigsty 的归档链路</h3><p>Pigsty 默认开启 WAL 归档，并将归档动作交给 pgBackRest：</p><ul><li><code>archive_mode = on</code></li><li><code>archive_command = pgbackrest --stanza=&lt;cluster> archive-push %p</code></li></ul><p>pgBackRest 会持续接收 WAL 段文件，并依据保留策略自动清理过期归档。
恢复时，pgBackRest 负责通过 <code>archive-get</code> 拉取所需 WAL。</p><h3 id=关键影响>关键影响</h3><ul><li><strong>归档延迟</strong>会缩短恢复窗口的右边界。</li><li><strong>仓库不可用</strong>会导致归档中断，直接影响 PITR 能力。</li></ul><p>更多细节请参阅 <a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a> 与 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p><hr><h2 id=恢复目标与事务边界>恢复目标与事务边界</h2><p>PITR 的恢复目标由 PostgreSQL 的 <code>recovery_target_*</code> 系列参数定义，Pigsty 通过 <code>pg_pitr</code> 或 <code>pg-pitr</code> 进行封装。</p><h3 id=目标类型>目标类型</h3><table class=full-width><thead><tr><th style=text-align:left>目标类型</th><th style=text-align:left>参数</th><th style=text-align:left>说明</th><th style=text-align:left>常见场景</th></tr></thead><tbody><tr><td style=text-align:left><strong>latest</strong></td><td style=text-align:left>无</td><td style=text-align:left>恢复到 WAL 归档流末尾</td><td style=text-align:left>机房灾难后的最新恢复</td></tr><tr><td style=text-align:left><strong>time</strong></td><td style=text-align:left><code>time</code></td><td style=text-align:left>恢复到指定时间点</td><td style=text-align:left>误删数据</td></tr><tr><td style=text-align:left><strong>xid</strong></td><td style=text-align:left><code>xid</code></td><td style=text-align:left>恢复到指定事务 ID</td><td style=text-align:left>错误事务回滚</td></tr><tr><td style=text-align:left><strong>lsn</strong></td><td style=text-align:left><code>lsn</code></td><td style=text-align:left>恢复到指定 LSN</td><td style=text-align:left>精确回退</td></tr><tr><td style=text-align:left><strong>name</strong></td><td style=text-align:left><code>name</code></td><td style=text-align:left>恢复到命名恢复点</td><td style=text-align:left>预设检查点</td></tr><tr><td style=text-align:left><strong>immediate</strong></td><td style=text-align:left><code>type: immediate</code></td><td style=text-align:left>第一一致点停止</td><td style=text-align:left>最快恢复</td></tr></tbody></table><h3 id=包含与排除>包含与排除</h3><p>恢复目标默认是<strong>包含</strong>（inclusive）的。
若要回退到目标点<strong>之前</strong>，在 <code>pg_pitr</code> 中设置 <code>exclusive: true</code>，对应 PostgreSQL 的 <code>recovery_target_inclusive = false</code>。</p><h3 id=事务边界>事务边界</h3><p>PITR 会保留目标点前的<strong>已提交事务</strong>，并回滚未提交事务。</p><pre class=mermaid>gantt
    title 事务边界与恢复目标
    dateFormat X
    axisFormat %s
    section 事务 A
    BEGIN → COMMIT (已提交) :done, a1, 0, 2
    section 事务 B
    BEGIN → 未提交 :active, b1, 1, 4
    section 恢复
    恢复目标点 :milestone, m1, 2, 0</pre><p>更多操作细节请参阅 <a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a>。</p><hr><h2 id=恢复窗口>恢复窗口</h2><p><strong>恢复窗口</strong>由两个边界决定：</p><ul><li><strong>左边界</strong>：最早可用的基础备份</li><li><strong>右边界</strong>：最新已归档的 WAL</li></ul><p><img src=/img/pigsty/pitr-scope.png alt=pitr-scope></p><p>窗口长短取决于备份频率、备份保留与 WAL 归档保留策略：</p><ul><li><code>local</code> 仓库默认保留 <strong>2 个全量备份</strong>，窗口通常为 <strong>24～48 小时</strong>。</li><li><code>minio</code> 仓库默认按时间保留 <strong>14 天</strong>备份，窗口通常为 <strong>1～2 周</strong>。</li></ul><p>具体策略配置请参阅 <a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a> 与 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p><hr><h2 id=时间线>时间线</h2><p><strong>时间线</strong>（Timeline）用于区分不同历史分支。以下操作会生成新时间线：</p><ol><li>PITR 恢复</li><li>从库提升（Promote）</li><li>故障切换（Failover）</li></ol><pre class=mermaid>gitGraph
    commit id: &#34;初始状态&#34;
    commit id: &#34;写入数据&#34;
    commit id: &#34;继续写入&#34;
    branch Timeline-2
    checkout Timeline-2
    commit id: &#34;PITR 恢复点1&#34;
    commit id: &#34;新写入&#34;
    branch Timeline-3
    checkout Timeline-3
    commit id: &#34;PITR 恢复点2&#34;
    commit id: &#34;继续运行&#34;
    checkout main
    commit id: &#34;原时间线继续&#34;</pre><p>当仓库存在多个时间线时，可通过 <code>timeline</code> 指定目标；Pigsty 默认使用 <code>latest</code>。
更多细节请参阅 <a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0f1a78edbba6d0b4ce0cad98c98b549c>5.2 - 时间点恢复的实现架构</h1><div class=lead>Pigsty PITR 的实现架构：pgBackRest、备份仓库与执行机制</div><p>Pigsty 使用 <a href=https://pgbackrest.org/><strong>pgBackRest</strong></a> 作为 PostgreSQL 备份与恢复引擎，提供开箱即用的时间点恢复（PITR）能力。</p><p>本文从架构层面说明：<strong>备份由谁执行、数据流向哪里、仓库如何组织、故障切换后如何保持连续性</strong>。</p><hr><h2 id=概览>概览</h2><p>PITR 架构由三条主线构成：<strong>备份执行链路</strong>、<strong>WAL 归档链路</strong>、<strong>恢复执行链路</strong>。</p><table class=full-width><thead><tr><th style=text-align:left>链路</th><th style=text-align:left>入口</th><th style=text-align:left>引擎</th><th style=text-align:left>终点</th></tr></thead><tbody><tr><td style=text-align:left>备份</td><td style=text-align:left><code>pg-backup</code> + <code>pg_crontab</code></td><td style=text-align:left><code>pgbackrest backup</code></td><td style=text-align:left>备份仓库 <code>backup/</code></td></tr><tr><td style=text-align:left>WAL 归档</td><td style=text-align:left>PostgreSQL <code>archive_command</code></td><td style=text-align:left><code>pgbackrest archive-push</code></td><td style=text-align:left>备份仓库 <code>archive/</code></td></tr><tr><td style=text-align:left>恢复</td><td style=text-align:left><code>pg_pitr</code> / <code>pg-pitr</code> / <code>pgsql-pitr.yml</code></td><td style=text-align:left><code>pgbackrest restore</code></td><td style=text-align:left>目标数据目录</td></tr></tbody></table><p>更多执行细节见 <a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a> 与 <a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a>。</p><hr><h2 id=组件与职责>组件与职责</h2><table class=full-width><thead><tr><th style=text-align:left>组件</th><th style=text-align:left>角色</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left><strong>PostgreSQL</strong></td><td style=text-align:left>数据源</td><td style=text-align:left>产生数据文件与 WAL 归档流</td></tr><tr><td style=text-align:left><strong>pgBackRest</strong></td><td style=text-align:left>备份引擎</td><td style=text-align:left>执行备份、接收/拉取 WAL、执行恢复</td></tr><tr><td style=text-align:left><strong>pg-backup</strong></td><td style=text-align:left>备份入口</td><td style=text-align:left>Pigsty 封装脚本，执行 <code>pgbackrest backup</code></td></tr><tr><td style=text-align:left><strong>pg_pitr / pg-pitr</strong></td><td style=text-align:left>恢复入口</td><td style=text-align:left>Pigsty 封装参数/脚本，执行 <code>pgbackrest restore</code></td></tr><tr><td style=text-align:left><strong>备份仓库</strong></td><td style=text-align:left>存储后端</td><td style=text-align:left>保存 <code>backup/</code> 与 <code>archive/</code>，支持 <code>local</code> / <code>minio</code> / <code>s3</code> 等仓库</td></tr><tr><td style=text-align:left><strong>pgbackrest_exporter</strong></td><td style=text-align:left>监控输出</td><td style=text-align:left>导出备份状态指标，默认监听 <code>9854</code> 端口</td></tr></tbody></table><hr><h2 id=数据流>数据流</h2><pre class=mermaid>flowchart TB
    subgraph cluster[&#34;PostgreSQL 集群&#34;]
        direction TB
        primary[&#34;Primary&lt;br/&gt;PostgreSQL&#34;]
        pb[&#34;pgBackRest&#34;]
        cron[&#34;pg-backup / pg_crontab&#34;]
    end
    repo[&#34;备份仓库&lt;br/&gt;local / minio / s3&#34;]
    restore[&#34;恢复目标数据目录&#34;]

    cron --&gt; pb
    primary --&gt;|base backup| pb
    primary --&gt;|WAL archive| pb
    pb --&gt;|backup/archive| repo
    repo --&gt;|restore/archive-get| pb
    pb --&gt;|restore| restore</pre><p>要点：</p><ul><li><strong>备份</strong> 由 <code>pg-backup</code> 触发，执行 <code>pgbackrest backup</code> 将基础备份写入仓库。</li><li><strong>归档</strong> 由 PostgreSQL 的 <code>archive_command</code> 触发，持续将 WAL 段写入仓库。</li><li><strong>恢复</strong> 从仓库读取备份与 WAL，通过 <code>pgbackrest restore</code> 重建数据目录。</li></ul><hr><h2 id=部署与角色>部署与角色</h2><p>pgBackRest 安装在 <strong>所有 PostgreSQL 节点</strong> 上，但只有 <strong>主库</strong> 实际执行备份：</p><ul><li><code>pg-backup</code> 会自动检测节点角色，从库执行时直接退出。</li><li>发生 <strong>故障切换</strong> 后，新主库自动接管备份与归档，备份连续性不受影响。</li></ul><p>这使得备份链路与高可用拓扑解耦，避免因主从切换导致备份中断。</p><hr><h2 id=仓库与隔离>仓库与隔离</h2><h3 id=stanza集群标识>Stanza（集群标识）</h3><p>pgBackRest 使用 <strong>stanza</strong> 隔离不同集群的备份，Pigsty 将其映射为 <code>pg_cluster</code>：</p><pre tabindex=0><code>备份仓库
├── pg-meta/
│   ├── backup/
│   └── archive/
└── pg-test/
    ├── backup/
    └── archive/
</code></pre><h3 id=仓库类型>仓库类型</h3><p>Pigsty 通过 <a href=/docs/pgsql/param#pgbackrest_method><code>pgbackrest_method</code></a> 选择仓库，通过
<a href=/docs/pgsql/param#pgbackrest_repo><code>pgbackrest_repo</code></a> 定义仓库参数：</p><table class=full-width><thead><tr><th style=text-align:left>类型</th><th style=text-align:left>特点</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:left><strong>local</strong></td><td style=text-align:left>本地磁盘，恢复最快</td><td style=text-align:left>开发/测试、单机部署</td></tr><tr><td style=text-align:left><strong>minio</strong></td><td style=text-align:left>对象存储，集中式备份</td><td style=text-align:left>生产环境、异地容灾</td></tr><tr><td style=text-align:left><strong>s3</strong></td><td style=text-align:left>云对象存储</td><td style=text-align:left>云上部署、跨区域容灾</td></tr></tbody></table><p>生产环境建议使用远程仓库（MinIO/S3），以避免主机故障导致 <strong>数据与备份同时丢失</strong>。
详见 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p><hr><h2 id=配置映射>配置映射</h2><p>Pigsty 会将 <code>pgbackrest_repo</code> 定义渲染为 <code>/etc/pgbackrest/pgbackrest.conf</code>。
备份日志位于 <code>/pg/log/pgbackrest/</code>，恢复过程生成临时配置并记录恢复日志。</p><p>更多细节请参阅 <a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a>。</p><hr><h2 id=可观测性>可观测性</h2><p><code>pgbackrest_exporter</code> 会导出备份状态指标（最近备份时间、类型、大小等），默认启用，监听端口 <code>9854</code>。
您可以通过 <a href=/docs/pgsql/param#pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></a> 控制该组件。</p><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a></li><li><a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a></li><li><a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a></li><li><a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-73a2e369df3734218f99f90230b96257>5.3 - 时间点恢复的策略权衡</h1><div class=lead>PITR 策略设计中的利弊权衡：仓库选择、空间规划与策略推荐</div><p>设计 PITR 策略时，最核心的权衡来自三个维度：
<strong>备份仓库位置</strong>、<strong>恢复窗口长度</strong>、<strong>恢复速度与空间成本</strong>。</p><p>本文帮助您在这些维度之间做出可操作的选择。</p><hr><h2 id=本地-vs-远程>本地 vs 远程</h2><p>备份仓库的位置是 PITR 策略设计的第一步。</p><h3 id=本地仓库>本地仓库</h3><p>将备份存储在主库本地磁盘（<code>pgbackrest_method = local</code>）：</p><p><strong>优势</strong></p><ul><li>配置简单，开箱即用</li><li>恢复速度快（本地 I/O）</li><li>无外部依赖</li></ul><p><strong>劣势</strong></p><ul><li>无异地容灾能力，主机故障时备份可能一同丢失</li><li>受限于本地磁盘容量</li><li>备份与生产数据位于同一故障域</li></ul><h3 id=远程仓库>远程仓库</h3><p>将备份存储到 MinIO / S3 等对象存储（<code>pgbackrest_method = minio|s3</code>）：</p><p><strong>优势</strong></p><ul><li>异地容灾，备份独立于数据库主机</li><li>容量几乎无限，多集群可共享</li><li>可配合加密、版本控制等安全策略</li></ul><p><strong>劣势</strong></p><ul><li>恢复速度受网络带宽影响</li><li>依赖对象存储的可用性</li><li>部署与运维成本更高</li></ul><h3 id=如何选择>如何选择</h3><table class=full-width><thead><tr><th style=text-align:left>场景</th><th style=text-align:left>推荐仓库</th><th style=text-align:left>理由</th></tr></thead><tbody><tr><td style=text-align:left>开发测试</td><td style=text-align:left>local</td><td style=text-align:left>简单够用，容灾要求低</td></tr><tr><td style=text-align:left>单机生产</td><td style=text-align:left>minio / s3</td><td style=text-align:left>主机故障仍可恢复</td></tr><tr><td style=text-align:left>集群生产</td><td style=text-align:left>local + minio</td><td style=text-align:left>兼顾恢复速度与异地容灾</td></tr><tr><td style=text-align:left>关键业务</td><td style=text-align:left>多远程仓库</td><td style=text-align:left>多地容灾，最高保护</td></tr></tbody></table><p>仓库配置细节请参阅 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p><hr><h2 id=空间-vs-窗口>空间 vs 窗口</h2><p>恢复窗口越长，所需存储空间越大。窗口长度由 <strong>备份保留策略 + WAL 归档保留</strong> 决定。</p><h3 id=影响因素>影响因素</h3><table class=full-width><thead><tr><th style=text-align:left>因素</th><th style=text-align:left>影响</th></tr></thead><tbody><tr><td style=text-align:left><strong>数据库规模</strong></td><td style=text-align:left>决定全量备份基准空间</td></tr><tr><td style=text-align:left><strong>变更速率</strong></td><td style=text-align:left>影响增量备份与 WAL 归档大小</td></tr><tr><td style=text-align:left><strong>备份频率</strong></td><td style=text-align:left>频率越高，恢复越快，但空间增长更快</td></tr><tr><td style=text-align:left><strong>保留时间</strong></td><td style=text-align:left>保留越久，恢复窗口越长，空间需求越大</td></tr></tbody></table><h3 id=直观示例>直观示例</h3><p>假设数据库 100GB，每天变更 10GB：</p><p><strong>每日全量备份（保留 2 份）</strong></p><p><img src=/img/pigsty/pitr-space.png alt=pitr-space></p><ul><li>全量备份：100GB × 2 ≈ 200GB</li><li>WAL 归档：10GB × 2 ≈ 20GB</li><li>总计：约 2～3 倍数据库空间</li></ul><p><strong>周全量 + 每日增量（保留 14 天）</strong></p><p><img src=/img/pigsty/pitr-space2.png alt=pitr-space2></p><ul><li>全量备份：100GB × 2 ≈ 200GB</li><li>增量备份：约 10GB × 12 ≈ 120GB</li><li>WAL 归档：10GB × 14 ≈ 140GB</li><li>总计：约 4～5 倍数据库空间</li></ul><p>空间与窗口的关系是刚性约束，无法通过配置“同时更长窗口 + 更少空间”。</p><hr><h2 id=策略选择>策略选择</h2><h3 id=每日全量备份>每日全量备份</h3><p><strong>最简单可靠的策略</strong>，也是 Pigsty 本地仓库的默认思路：</p><ul><li>每天一次全量备份</li><li>保留 2 份备份</li><li>恢复窗口约 24～48 小时</li></ul><p>适用场景：</p><ul><li>数据库规模中小（&lt; 500GB）</li><li>备份窗口充足</li><li>对存储空间不敏感</li></ul><h3 id=全量--增量备份>全量 + 增量备份</h3><p><strong>空间优化策略</strong>，适合大库或需要更长恢复窗口：</p><ul><li>每周一次全量备份</li><li>其他日期执行增量备份</li><li>保留 14 天</li></ul><p>适用场景：</p><ul><li>数据库规模较大</li><li>使用对象存储</li><li>需要 1～2 周恢复窗口</li></ul><pre class=mermaid>flowchart TD
    A{&#34;数据库大小&lt;br/&gt;&lt; 100GB？&#34;} --&gt;|是| B[&#34;每日全量备份&#34;]
    A --&gt;|否| C{&#34;数据库大小&lt;br/&gt;&lt; 500GB？&#34;}
    C --&gt;|否| D[&#34;全量 &#43; 增量备份&#34;]
    C --&gt;|是| E{&#34;备份窗口&lt;br/&gt;充足？&#34;}
    E --&gt;|是| F[&#34;每日全量备份&#34;]
    E --&gt;|否| G[&#34;全量 &#43; 增量备份&#34;]</pre><hr><h2 id=推荐配置>推荐配置</h2><h3 id=开发测试环境>开发测试环境</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>恢复窗口：24～48 小时</li><li>特点：配置最简，成本最低</li></ul><h3 id=生产集群>生产集群</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1 /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>恢复窗口：7～14 天</li><li>特点：异地容灾，适合生产环境</li></ul><h3 id=关键业务>关键业务</h3><p><strong>双仓库策略</strong>（本地 + 远程）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>path: /pg/backup, retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>type: s3, retention_full_type: time, retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>本地仓库用于快速恢复</li><li>远程仓库用于异地容灾</li></ul><p>更多配置细节请参阅 <a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a> 与 <a href=/docs/pgsql/backup/repository/><strong>备份仓库</strong></a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-03fae0025a6c17d88ae21f91a462fbe6>5.4 - 时间点恢复的典型场景</h1><div class=lead>PITR 的典型应用场景：误删数据、误删表/库、批量错误、分支恢复与机房级灾难</div><p>PITR 的价值不在于“回滚数据库”本身，而在于<strong>把不可逆的人为/软件错误变回可恢复的问题</strong>。
它覆盖的场景从“误删一张表”到“整个机房不可用”，本质上解决的是<strong>逻辑错误与灾难恢复</strong>。</p><hr><h2 id=整体认知overview>整体认知（Overview）</h2><p>PITR 解决以下问题：</p><table class=full-width><thead><tr><th style=text-align:left>场景类型</th><th style=text-align:left>典型问题</th><th style=text-align:left>推荐策略</th><th style=text-align:left>恢复目标</th></tr></thead><tbody><tr><td style=text-align:left>误删/误更新数据（DML）</td><td style=text-align:left><code>DELETE/UPDATE</code> 无条件执行，脚本误操作</td><td style=text-align:left>分支恢复优先</td><td style=text-align:left><code>time</code> / <code>xid</code></td></tr><tr><td style=text-align:left>误删表/库/Schema（DDL）</td><td style=text-align:left><code>DROP TABLE/DATABASE</code>、错误迁移</td><td style=text-align:left>分支恢复</td><td style=text-align:left><code>time</code> / <code>name</code></td></tr><tr><td style=text-align:left>批量错误/发布事故</td><td style=text-align:left>Bug 批量污染数据，修复脚本失败</td><td style=text-align:left>分支恢复 + 验证</td><td style=text-align:left><code>time</code> / <code>xid</code></td></tr><tr><td style=text-align:left>数据审计/问题复盘</td><td style=text-align:left>需要查看历史状态，核对差异</td><td style=text-align:left>分支恢复（只读）</td><td style=text-align:left><code>time</code> / <code>lsn</code></td></tr><tr><td style=text-align:left>机房级灾难/全量丢失</td><td style=text-align:left>硬件故障、勒索、机房断电</td><td style=text-align:left>原地恢复或重建集群</td><td style=text-align:left><code>latest</code> / <code>time</code></td></tr></tbody></table><h3 id=一个简单的判断原则>一个简单的判断原则</h3><ul><li><strong>只要写入已经造成业务错误，就应该考虑 PITR</strong>。</li><li><strong>需要在线验证或只恢复部分数据 → 分支恢复</strong>。</li><li><strong>必须尽快恢复服务 → 原地恢复</strong>（可接受停机）。</li></ul><pre class=mermaid>flowchart TD
    A[&#34;发现问题&#34;] --&gt; B{&#34;能否停机？&#34;}
    B --&gt;|能| C[&#34;原地恢复&lt;br/&gt;最短恢复路径&#34;]
    B --&gt;|不能| D[&#34;分支恢复&lt;br/&gt;先验证后切换&#34;]
    C --&gt; E[&#34;恢复成功后重建备份&#34;]
    D --&gt; F[&#34;验证/导出/切流量&#34;]</pre><hr><h2 id=场景详情>场景详情</h2><h3 id=误删误更新数据dml>误删/误更新数据（DML）</h3><p><strong>典型问题</strong>：</p><ul><li><code>DELETE</code> 缺少 <code>WHERE</code></li><li>错误的 <code>UPDATE</code> 覆盖关键字段</li><li>批处理脚本逻辑错误导致脏数据扩散</li></ul><p><strong>处理思路</strong>：</p><ol><li><strong>止损</strong>：暂停相关应用或写入作业，防止数据继续被污染。</li><li><strong>定位时间点</strong>：结合日志、监控、业务反馈，确定错误发生时间。</li><li><strong>选择策略</strong>：<ul><li>能停机：原地恢复到错误之前</li><li>不能停机：分支恢复，导出正确数据再合并回主库</li></ul></li></ol><p><strong>恢复目标建议</strong>：</p><ul><li>有明确事务：<code>xid</code> + <code>exclusive: true</code></li><li>仅知道时间：<code>time</code> + <code>exclusive: true</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;250000&#34;</span><span style=color:#204a87;font-weight:700>, exclusive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-15 14:30:00+08&#34;</span><span style=color:#204a87;font-weight:700>, exclusive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h3 id=误删表--误删库ddl>误删表 / 误删库（DDL）</h3><p><strong>典型问题</strong>：</p><ul><li><code>DROP TABLE</code> / <code>DROP DATABASE</code></li><li>执行了错误迁移脚本</li><li>清理测试数据时误删生产对象</li></ul><p><strong>为何推荐分支恢复</strong>：</p><p>DDL 操作不可逆，<strong>原地恢复意味着全库回滚</strong>，风险高。
分支恢复可将误删对象导出并导回原库，影响最小。</p><p><strong>推荐流程</strong>：</p><ol><li>创建分支集群并 PITR 到误删前</li><li>校验表结构/数据正确性</li><li><code>pg_dump</code> 导出目标对象</li><li>导回生产库</li></ol><pre class=mermaid>sequenceDiagram
    participant O as 原集群
    participant B as 分支集群
    O-&gt;&gt;B: 创建分支集群
    Note over B: PITR 到误删之前
    B-&gt;&gt;O: 导出表/库并导回
    Note over B: 验证完成后销毁分支</pre><hr><h3 id=批量错误--发布事故>批量错误 / 发布事故</h3><p><strong>典型问题</strong>：</p><ul><li>某次版本发布写入错误数据</li><li>ETL 或批处理作业造成全量污染</li><li>修复脚本执行失败或影响范围不清晰</li></ul><p><strong>处理原则</strong>：</p><ul><li><strong>优先分支恢复</strong>：先验证恢复点，再决定是否切流量</li><li>对比原库与分支库数据差异，确认影响范围</li></ul><p><strong>建议流程</strong>：</p><ol><li>确定错误发布的时间窗口</li><li>分支恢复到“错误发生前”</li><li>校验关键业务表</li><li>决定导回部分数据，或整体切流量</li></ol><p>这个场景通常需要结合业务复盘，因此分支恢复更安全、更可控。</p><hr><h3 id=数据审计--问题复盘>数据审计 / 问题复盘</h3><p><strong>典型问题</strong>：</p><ul><li>需要查看某一时刻的数据状态</li><li>排查“历史正确状态”以比对差异</li></ul><p><strong>推荐方式</strong>：分支恢复（只读）</p><p><strong>优点</strong>：</p><ul><li>不影响生产</li><li>可多次尝试不同时间点</li><li>适合审计、核对与取证</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-15 10:00:00+08&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 创建只读分支</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h3 id=机房级灾难--全量丢失>机房级灾难 / 全量丢失</h3><p>这是 <strong>PITR 的终极兜底场景</strong>。当高可用无法应对时（主从同时不可用、机房断电、勒索攻击），PITR 是最后防线。</p><p><strong>关键前提</strong>：</p><blockquote><p><strong>必须使用远程仓库（MinIO/S3）</strong>。</p></blockquote><p>本地仓库在主机故障时会与数据一同丢失，无法恢复。</p><p><strong>恢复流程</strong>：</p><ol><li>准备新主机或新机房资源</li><li>还原集群配置并指向远程仓库</li><li>执行 PITR 恢复（通常 <code>latest</code>）</li><li>验证数据后恢复服务</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta   <span style=color:#8f5902;font-style:italic># 恢复到 WAL 归档末尾</span>
</span></span></code></pre></div><hr><h2 id=原地恢复-vs-分支恢复>原地恢复 vs 分支恢复</h2><table class=full-width><thead><tr><th style=text-align:left>维度</th><th style=text-align:left>原地恢复</th><th style=text-align:left>分支恢复</th></tr></thead><tbody><tr><td style=text-align:left>是否停机</td><td style=text-align:left>需要停机</td><td style=text-align:left>无需停机</td></tr><tr><td style=text-align:left>风险</td><td style=text-align:left>高（直接影响生产）</td><td style=text-align:left>低（可验证后操作）</td></tr><tr><td style=text-align:left>复杂度</td><td style=text-align:left>低</td><td style=text-align:left>中（需要新集群与数据导出）</td></tr><tr><td style=text-align:left>推荐场景</td><td style=text-align:left>快速恢复服务、容灾</td><td style=text-align:left>误操作恢复、审计、复杂场景</td></tr></tbody></table><p>对于绝大多数生产场景，<strong>分支恢复是默认推荐策略</strong>。
只有在 <strong>必须尽快恢复服务</strong> 时，才建议原地恢复。</p><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/backup/restore/><strong>恢复操作</strong></a></li><li><a href=/docs/pgsql/backup/mechanism/><strong>备份机制</strong></a></li><li><a href=/docs/pgsql/backup/policy/><strong>备份策略</strong></a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-640213fc983ef0aae5180ea5bbbfb2d3>6 - 监控系统</h1><div class=lead>Pigsty 的监控系统是如何架构与实现的，被监控的目标对象又是如何被自动纳入管理的。</div><p>Pigsty 监控系统由指标、日志与告警三部分组成，默认随部署开箱可用。
它既可以监控由 Pigsty 托管的数据库集群，也可以监控已有 PostgreSQL 集群与外部 RDS 服务。</p><hr><h2 id=监控目标>监控目标</h2><p>Pigsty 监控覆盖的核心对象包括：</p><ul><li>PostgreSQL 集群与实例（SQL 性能、连接、复制、事务、检查点、WAL）</li><li>基础设施组件（Grafana、VictoriaMetrics、Alertmanager、Nginx 等）</li><li>宿主机节点（CPU、内存、磁盘、网络、内核）</li><li>关键中间件（ETCD、MINIO、REDIS、FERRET、JUICE、VIBE 等）</li></ul><hr><h2 id=技术栈>技术栈</h2><table class=full-width><thead><tr><th style=text-align:left>组件</th><th style=text-align:left>作用</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/infra/admin/grafana/><strong>Grafana</strong></a></td><td style=text-align:left>可视化监控面板、统一入口、告警视图</td></tr><tr><td style=text-align:left><a href=/docs/infra/><strong>VictoriaMetrics</strong></a></td><td style=text-align:left>时序指标采集、存储与查询</td></tr><tr><td style=text-align:left><a href=/docs/infra/><strong>VictoriaLogs</strong></a></td><td style=text-align:left>结构化日志采集、索引与检索</td></tr><tr><td style=text-align:left><a href=/docs/infra/monitor/><strong>VMAlert + Alertmanager</strong></a></td><td style=text-align:left>告警规则执行与消息通知</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/monitor/><strong>Exporter / Agent</strong></a></td><td style=text-align:left>业务与系统指标暴露、日志转发</td></tr></tbody></table><hr><h2 id=纳管方式>纳管方式</h2><p>Pigsty 支持三种监控纳管方式：</p><table class=full-width><thead><tr><th style=text-align:left>模式</th><th style=text-align:left>适用场景</th><th style=text-align:left>入口</th></tr></thead><tbody><tr><td style=text-align:left><code>FULL</code></td><td style=text-align:left>数据库由 Pigsty 直接部署与托管</td><td style=text-align:left><a href=/docs/pgsql/monitor/>PGSQL 监控系统</a></td></tr><tr><td style=text-align:left><code>MANAGED</code></td><td style=text-align:left>现有 PostgreSQL 集群，节点可 SSH 管理</td><td style=text-align:left><a href=/docs/pgsql/monitor/#%E7%9B%91%E6%8E%A7%E7%8E%B0%E6%9C%89%E9%9B%86%E7%BE%A4>监控现有集群</a></td></tr><tr><td style=text-align:left><code>RDS</code></td><td style=text-align:left>仅能通过连接串访问的云数据库</td><td style=text-align:left><a href=/docs/pgsql/monitor/#%E7%9B%91%E6%8E%A7rds>监控 RDS</a></td></tr></tbody></table><hr><h2 id=继续阅读>继续阅读</h2><ul><li><a href=/docs/pgsql/monitor/><strong>PGSQL 监控系统</strong></a>：数据库指标、日志、告警与面板</li><li><a href=/docs/infra/monitor/><strong>INFRA 监控告警</strong></a>：监控系统自身可用性</li><li><a href=/docs/node/monitor/><strong>NODE 监控告警</strong></a>：主机资源与系统健康状态</li><li><a href=/docs/etcd/monitor/><strong>ETCD 监控告警</strong></a>：一致性与可用性监控</li><li><a href=/docs/minio/monitor/><strong>MINIO 监控告警</strong></a>：对象存储集群监控</li><li><a href=/docs/redis/monitor/><strong>REDIS 监控告警</strong></a>：缓存集群运行状态监控</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7ed29cc39a1f06050bef0386106a93cc>7 - 安全合规</h1><div class=lead>认证、授权、加密、审计与合规基线，覆盖数据库与基础设施安全。</div><p>Pigsty 的安全目标是 <strong>CIA 三元组</strong>：</p><ul><li><strong>机密性</strong>：防止未授权访问与泄露</li><li><strong>完整性</strong>：防止数据被篡改或静默损坏</li><li><strong>可用性</strong>：防止故障导致业务中断</li></ul><p>Pigsty 的安全理念：</p><ul><li><strong>默认安全</strong>：开箱即用的安全基线，配置少、覆盖广。</li><li><strong>纵深防御</strong>：多层保护叠加，单点失守不致系统失守。</li><li><strong>最小权限</strong>：角色与权限模型贯彻最小授权原则。</li><li><strong>可合规</strong>：安全能力与流程结合即可通过合规检查。</li></ul><hr><h2 id=默认安全基线解决什么问题>默认安全基线（解决什么问题）</h2><table class=full-width><thead><tr><th style=text-align:left>安全选项</th><th style=text-align:left>默认值</th><th style=text-align:left>解决的问题</th></tr></thead><tbody><tr><td style=text-align:left>密码加密</td><td style=text-align:left><code>pg_pwd_enc: scram-sha-256</code></td><td style=text-align:left>防止弱哈希与明文泄露</td></tr><tr><td style=text-align:left>数据校验</td><td style=text-align:left><code>pg_checksum: true</code></td><td style=text-align:left>检测静默数据损坏</td></tr><tr><td style=text-align:left>HBA 分层</td><td style=text-align:left>管理员外网必须 <code>ssl</code></td><td style=text-align:left>防止外网明文访问</td></tr><tr><td style=text-align:left>本地 CA</td><td style=text-align:left><code>ca_create: true</code></td><td style=text-align:left>统一证书信任链</td></tr><tr><td style=text-align:left>备份恢复</td><td style=text-align:left><code>pgbackrest_enabled: true</code></td><td style=text-align:left>防止误删误改不可恢复</td></tr><tr><td style=text-align:left>Nginx HTTPS</td><td style=text-align:left><code>nginx_sslmode: enable</code></td><td style=text-align:left>防止 Web 入口明文泄露</td></tr><tr><td style=text-align:left>MinIO HTTPS</td><td style=text-align:left><code>minio_https: true</code></td><td style=text-align:left>防止备份链路窃听</td></tr><tr><td style=text-align:left>OS 基线</td><td style=text-align:left>SELinux <code>permissive</code></td><td style=text-align:left>为强制模式预留基础</td></tr></tbody></table><blockquote><p>默认配置以“可用、可扩展”为先，生产环境应根据合规要求加固。</p></blockquote><hr><h2 id=加固路线图>加固路线图</h2><p>Pigsty 提供安全增强模板 <code>conf/ha/safe.yml</code>，可快速将默认基线升级到更高安全级别：</p><ul><li>强制 SSL 与证书认证</li><li>密码强度与过期策略</li><li>连接与断开日志</li><li>防火墙与 SELinux 加固</li></ul><hr><h2 id=本章内容>本章内容</h2><table class=full-width><thead><tr><th style=text-align:left>章节</th><th style=text-align:left>说明</th><th style=text-align:left>核心问题</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/concept/sec/level><strong>纵深防御</strong></a></td><td style=text-align:left>七层安全模型与基线</td><td style=text-align:left>安全体系整体如何落地？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/auth><strong>身份认证</strong></a></td><td style=text-align:left>HBA 规则、密码策略、证书认证</td><td style=text-align:left>如何验证用户身份？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/ac><strong>访问控制</strong></a></td><td style=text-align:left>角色系统、权限模型、数据库隔离</td><td style=text-align:left>如何控制用户权限？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/ca><strong>加密通信</strong></a></td><td style=text-align:left>TLS、本地 CA、证书管理</td><td style=text-align:left>如何保护传输与证书？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/data><strong>数据安全</strong></a></td><td style=text-align:left>校验和、备份、加密与恢复</td><td style=text-align:left>数据如何完整可恢复？</td></tr><tr><td style=text-align:left><a href=/docs/concept/sec/compliance><strong>合规清单</strong></a></td><td style=text-align:left>等保三级与 SOC2 对照</td><td style=text-align:left>如何满足合规要求？</td></tr></tbody></table><hr><h2 id=相关话题>相关话题</h2><ul><li>♾️ <a href=/docs/concept/ha/><strong>高可用</strong></a>：业务连续性保障</li><li>⏰ <a href=/docs/concept/pitr/><strong>备份恢复</strong></a>：PITR 与灾难恢复</li><li>📊 <a href=/docs/concept/monitor/><strong>可观测性</strong></a>：安全事件监控</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-42af3045c7ebee43d7c66fbe8a4cd267>7.1 - 七层安全模型</h1><div class=lead>Pigsty 的纵深防御模型：从物理到用户的多层安全基线。</div><p>安全不是一道墙，而是一座城。Pigsty 采用<strong>纵深防御</strong>策略，在七个层次上构建多重保护，即使某一层被突破，仍有其他层提供保护。</p><p>这种分层思路解决三类核心风险：</p><ul><li><strong>边界被突破</strong>：降低“单点失守导致全盘失守”的概率。</li><li><strong>内部滥用</strong>：即使内部账号被盗，也能通过最小权限限制破坏范围。</li><li><strong>不可预期故障</strong>：硬件、软件、人为错误都能被“多层兜底”。</li></ul><hr><h2 id=概览>概览</h2><div id=infographic-296a28376e55bf0bd7d2bce937b065d7 class="infographic-container td-max-width-on-larger-screens"></div><script>(function(){var e,t="infographic-296a28376e55bf0bd7d2bce937b065d7",s=`\`\`\`\`
infographic sequence-pyramid-simple
data
  title 七层安全模型
  desc Pigsty 纵深防御体系：从物理到用户的多层保护
  items
    - label 物理与介质
      value 100
      desc 数据校验和 · 介质盗取防护
      time L1
      icon mingcute/building-4-fill
      illus server-cluster
    - label 网络安全
      value 95
      desc 防火墙 · 监听收敛 · TLS
      time L2
      icon mingcute/earth-2-fill
      illus secure-server
    - label 边界安全
      value 90
      desc HAProxy · Nginx · 统一入口
      time L3
      icon mingcute/shield-fill
      illus firewall-protection
    - label 主机安全
      value 85
      desc SELinux · 最小权限 · 系统加固
      time L4
      icon mingcute/computer-fill
      illus server-status
    - label 应用安全
      value 80
      desc HBA · SCRAM · 密码策略
      time L5
      icon mingcute/safe-box-fill
      illus database-security
    - label 数据安全
      value 75
      desc 备份加密 · PITR · 审计
      time L6
      icon mingcute/lock-fill
      illus data-encryption
    - label 用户安全
      value 70
      desc RBAC · 默认权限 · 隔离
      time L7
      icon mingcute/user-security-fill
      illus user-flow
theme light
  palette pigsty
\`\`\`\``;function n(){var n,e=document.getElementById(t);if(!e){console.error("Infographic: container not found:",t);return}try{n=new AntVInfographic.Infographic({container:"#"+t,width:e.offsetWidth||"100%",height:"auto"}),n.render(s)}catch(t){console.error("Infographic render error:",t),e.innerHTML='<pre style="color: red;">Infographic Error: '+t.message+"</pre>"}}typeof AntVInfographic!="undefined"?n():window._infographicLoading?window._infographicCallbacks.push(n):(window._infographicLoading=!0,window._infographicCallbacks=[n],e=document.createElement("script"),e.src="/js/infographic.min.js",e.onload=function(){window._infographicCallbacks.forEach(function(e){e()})},document.head.appendChild(e))})()</script><hr><h2 id=l1-物理与介质安全>L1 物理与介质安全</h2><blockquote><p>物理层失守时，唯一的对抗手段是数据本身的自我保护。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>硬件故障导致静默数据损坏</li><li>介质被盗导致数据泄露</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>数据校验和</strong>：默认开启 <code>pg_checksum: true</code>，可发现坏块/内存错误导致的数据损坏。</li><li><strong>可选透明加密</strong>：通过 <code>pg_tde</code> 等扩展实现数据静态加密，防止介质泄露。</li></ul><hr><h2 id=l2-网络安全>L2 网络安全</h2><blockquote><p>控制“谁能接触到服务”，降低攻击面。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>未授权网络访问</li><li>明文传输被窃听/篡改</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>防火墙分区</strong>：<code>node_firewall_mode</code> 可启用 <code>zone</code>，内网信任、公网受限。</li><li><strong>监听收敛</strong>：<code>pg_listen</code> 可限制监听地址，避免全网暴露。</li><li><strong>TLS 能力</strong>：HBA 支持 <code>ssl</code>/<code>cert</code>，保证连接加密与身份校验。</li></ul><hr><h2 id=l3-边界安全>L3 边界安全</h2><blockquote><p>“统一入口”是可审计、可控制、可封禁的基础。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>多入口难以管控</li><li>外部系统无处统一加固</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>HAProxy 入口</strong>：数据库流量统一入口，便于封禁/限流/切换。</li><li><strong>Nginx 网关</strong>：基础设施服务统一 HTTPS 入口（<code>nginx_sslmode</code>）。</li><li><strong>集中管理口令</strong>：HAProxy 管理口令、Grafana 管理口令统一在配置中声明。</li></ul><hr><h2 id=l4-主机安全>L4 主机安全</h2><blockquote><p>数据库安全的地基：最小权限、访问隔离、系统加固。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>主机被入侵导致全盘失守</li><li>管理权限过度扩散</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>SELinux 模式</strong>：<code>node_selinux_mode</code> 可切换 <code>enforcing</code> 强制模式。</li><li><strong>最小权限管理员</strong>：<code>node_admin_sudo</code> 支持 <code>limit</code> 限制 sudo 命令集。</li><li><strong>敏感文件权限</strong>：CA 私钥目录默认 0700，私钥文件 0600。</li></ul><hr><h2 id=l5-应用安全>L5 应用安全</h2><blockquote><p>认证是所有数据库安全的“第一道闸门”。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>弱密码或明文认证导致账号泄露</li><li>错误放行导致越权访问</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>HBA 分层控制</strong>：默认规则按来源与角色分层，管理员外网访问必须 <code>ssl</code>。</li><li><strong>SCRAM 密码哈希</strong>：<code>pg_pwd_enc: scram-sha-256</code> 默认启用。</li><li><strong>密码强度检查</strong>：<code>passwordcheck/credcheck</code> 可启用，阻止弱口令。</li><li><strong>证书认证</strong>：<code>auth: cert</code> 支持客户端证书认证。</li></ul><hr><h2 id=l6-数据安全>L6 数据安全</h2><blockquote><p>保障数据在“可用、可恢复、可追责”。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>人为误操作与逻辑错误</li><li>黑客入侵后数据被篡改或删除</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>pgBackRest 备份</strong>：默认启用，支持本地与 MinIO 仓库。</li><li><strong>备份加密</strong>：MinIO 仓库支持 AES-256-CBC（<code>cipher_type</code>）。</li><li><strong>PITR 恢复</strong>：结合归档可恢复到任意时间点。</li><li><strong>审计日志</strong>：模板启用 DDL/连接/慢查询日志，可选 <code>pgaudit</code>。</li></ul><hr><h2 id=l7-用户安全>L7 用户安全</h2><blockquote><p>最小权限不是口号，而是默认行为。</p></blockquote><p><strong>解决的问题</strong></p><ul><li>业务账号拥有过高权限</li><li>数据库之间相互“穿透”</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>四层 RBAC</strong>：<code>dbrole_readonly/readwrite/admin/offline</code>。</li><li><strong>默认权限策略</strong>：对象创建即自动授予正确权限。</li><li><strong>数据库隔离</strong>：<code>revokeconn: true</code> 可隔离跨库访问。</li><li><strong>公共权限收敛</strong>：撤销 <code>public</code> 模式 <code>CREATE</code> 权限。</li></ul><hr><h2 id=安全加固路径>安全加固路径</h2><p>Pigsty 提供安全增强模板：<code>conf/ha/safe.yml</code>。它将常见加固项集中封装：</p><ul><li>强制 SSL、证书认证</li><li>密码强度与过期策略</li><li>连接与断开日志</li><li>防火墙与 SELinux 加固</li></ul><p>这条路径可以作为“从默认到合规”的快速升级方案。</p><hr><h2 id=接下来>接下来</h2><ul><li>🔑 <a href=/docs/concept/sec/auth><strong>身份认证</strong></a>：HBA 规则与密码策略</li><li>👤 <a href=/docs/concept/sec/ac><strong>访问控制</strong></a>：角色系统与权限模型</li><li>🔐 <a href=/docs/concept/sec/ca><strong>加密通信</strong></a>：TLS 与证书管理</li><li>🔒 <a href=/docs/concept/sec/data><strong>数据安全</strong></a>：备份与加密</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：等保与 SOC2 对照</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-e262c3c798800d9c25e91d199755245e>7.2 - 身份认证</h1><div class=lead>HBA 规则、密码策略与证书认证，回答“谁能连进来、如何证明身份”。</div><p>身份认证解决三个核心问题：</p><ul><li><strong>你是谁</strong>：身份是否唯一可识别？</li><li><strong>你怎么证明</strong>：密码/证书是否足够安全？</li><li><strong>你从哪里来</strong>：来源是否受控？</li></ul><p>Pigsty 使用 <strong>HBA 规则 + 密码/证书</strong> 完成身份认证，并以 SCRAM 为默认密码哈希方案。</p><hr><h2 id=认证链路>认证链路</h2><pre class=mermaid>flowchart LR
  C[客户端] --&gt; HBA[HBA 规则]
  HBA --&gt; A1[密码 SCRAM]
  HBA --&gt; A2[证书认证]
  HBA --&gt; A3[本地 ident/peer]
  A1 --&gt; RBAC[角色与权限]
  A2 --&gt; RBAC
  A3 --&gt; RBAC</pre><p>HBA 决定“<strong>谁能从哪里来</strong>”，认证方式决定“<strong>如何证明身份</strong>”。</p><hr><h2 id=hba-分层模型>HBA 分层模型</h2><p>Pigsty 默认 HBA 规则已经分层：</p><ul><li><strong>本地</strong>使用 <code>ident/peer</code>，最安全。</li><li><strong>内网</strong>使用 <code>scram</code> 密码认证。</li><li><strong>外网管理员</strong>必须走 <code>ssl</code>。</li></ul><p>这解决了“<strong>同一个用户在不同来源使用不同认证强度</strong>”的问题。</p><p><strong>HBA 规则的关键能力</strong></p><ul><li><strong>顺序优先</strong>：支持 <code>order</code> 排序，数值越小优先级越高。</li><li><strong>地址别名</strong>：<code>local</code> / <code>localhost</code> / <code>intra</code> / <code>world</code> 等。</li><li><strong>角色条件</strong>：<code>primary/replica/offline</code> 可精细化控制。</li></ul><hr><h2 id=密码认证>密码认证</h2><p>默认密码哈希算法：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pwd_enc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>解决的问题</strong></p><ul><li>明文密码存储风险</li><li>弱哈希被离线破解</li></ul><p><strong>兼容性</strong></p><p>如需兼容老客户端可使用 <code>md5</code>，但会降低安全性。</p><hr><h2 id=密码强度与轮换>密码强度与轮换</h2><p>Pigsty 支持启用密码强度检查扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;$libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>passwordcheck, credcheck ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>通过 <code>expire_in</code> 控制账号过期时间：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_app, password: &#39;StrongPwd&#39;, expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>365</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>解决的问题</strong></p><ul><li>弱口令与口令复用</li><li>长期不轮换的账号风险</li></ul><hr><h2 id=证书认证>证书认证</h2><p>证书认证解决“<strong>密码被钓鱼/被拷贝</strong>”的风险。</p><ul><li>HBA <code>auth: cert</code> 要求客户端证书。</li><li>证书 <code>CN</code> 通常对应数据库用户名。</li><li>Pigsty 内置 <code>cert.yml</code> 用于签发客户端证书。</li></ul><hr><h2 id=pgbouncer-认证>PgBouncer 认证</h2><p>PgBouncer 使用独立 HBA 规则与 TLS 设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disable  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认关闭，可设为 require/verify-full</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>...]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 独立规则</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这解决了“连接池入口与数据库入口不同步”的问题。</p><hr><h2 id=默认账号与风险>默认账号与风险</h2><table class=full-width><thead><tr><th>用户</th><th>默认密码</th><th>风险</th></tr></thead><tbody><tr><td><code>dbuser_dba</code></td><td><code>DBUser.DBA</code></td><td>管理账号默认密码</td></tr><tr><td><code>dbuser_monitor</code></td><td><code>DBUser.Monitor</code></td><td>监控账号易被滥用</td></tr><tr><td><code>replicator</code></td><td><code>DBUser.Replicator</code></td><td>复制账号被滥用可导致数据外泄</td></tr></tbody></table><p>生产环境必须修改默认密码。</p><hr><h2 id=安全建议>安全建议</h2><ul><li>对外入口全部启用 <code>ssl/cert</code>。</li><li>内网用户使用 <code>scram</code>，避免 <code>md5</code>。</li><li>启用 <code>passwordcheck</code> 强制复杂度。</li><li>定期轮换口令（<code>expire_in</code>）。</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>👤 <a href=/docs/concept/sec/ac><strong>访问控制</strong></a>：角色与权限模型</li><li>🔐 <a href=/docs/concept/sec/ca><strong>加密通信</strong></a>：TLS 与证书管理</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：等保与 SOC2 对照</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6a3742ed82b65fb5a722f76337bf835d>7.3 - 访问控制</h1><div class=lead>Pigsty 提供开箱即用的角色与权限模型，贯彻最小权限原则。</div><p>访问控制解决两个核心问题：</p><ul><li><strong>你能做什么</strong>：读/写/DDL 的权限边界</li><li><strong>你能访问哪些数据</strong>：跨库、跨模式的隔离边界</li></ul><p>Pigsty 通过 <strong>RBAC 角色体系 + 默认权限策略</strong> 将“最小权限”落实为默认行为。</p><hr><h2 id=四层角色模型>四层角色模型</h2><pre class=mermaid>flowchart TB
    subgraph Admin[&#34;dbrole_admin（管理员）&#34;]
        A1[&#34;可执行 DDL / CREATE / ALTER&#34;]
        A2[&#34;继承 dbrole_readwrite&#34;]
    end
    subgraph RW[&#34;dbrole_readwrite（读写）&#34;]
        RW1[&#34;可 INSERT/UPDATE/DELETE&#34;]
        RW2[&#34;继承 dbrole_readonly&#34;]
    end
    subgraph RO[&#34;dbrole_readonly（只读）&#34;]
        RO1[&#34;可 SELECT 所有表&#34;]
    end
    subgraph Offline[&#34;dbrole_offline（离线）&#34;]
        OFF1[&#34;仅离线实例可用&#34;]
    end

    Admin --&gt; RW --&gt; RO</pre><p><strong>解决的问题</strong></p><ul><li>生产账号天然拥有过高权限</li><li>DDL 与 DML 不分离导致误操作风险</li></ul><hr><h2 id=默认角色与系统用户>默认角色与系统用户</h2><p>Pigsty 默认提供四个角色与四个系统用户（来自源码默认值）：</p><table class=full-width><thead><tr><th>角色/用户</th><th>属性</th><th>继承/角色</th><th>描述</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td>-</td><td>全局只读访问</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td>-</td><td>受限只读（离线实例）</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td><code>dbrole_readonly</code></td><td>全局读写访问</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td><code>pg_monitor, dbrole_readwrite</code></td><td>管理员 / 对象创建</td></tr><tr><td><code>postgres</code></td><td><code>SUPERUSER</code></td><td>-</td><td>系统超级用户</td></tr><tr><td><code>replicator</code></td><td><code>REPLICATION</code></td><td><code>pg_monitor, dbrole_readonly</code></td><td>复制用户</td></tr><tr><td><code>dbuser_dba</code></td><td><code>SUPERUSER</code></td><td><code>dbrole_admin</code></td><td>管理员用户</td></tr><tr><td><code>dbuser_monitor</code></td><td>-</td><td><code>pg_monitor, dbrole_readonly</code></td><td>监控用户</td></tr></tbody></table><p>这套默认角色可以覆盖绝大多数业务场景。</p><hr><h2 id=默认权限策略>默认权限策略</h2><p>Pigsty 在初始化时写入默认权限（<code>pg_default_privileges</code>），确保新建对象自动具备合理权限。</p><p><strong>解决的问题</strong></p><ul><li>新建对象未授权导致应用不可用</li><li>误授权给 <code>PUBLIC</code> 导致全库暴露</li></ul><p><strong>思路</strong></p><ul><li>只读角色：<code>SELECT/EXECUTE</code></li><li>读写角色：<code>INSERT/UPDATE/DELETE</code></li><li>管理员角色：<code>DDL</code> 权限</li></ul><hr><h2 id=对象所有权与-ddl-规范>对象所有权与 DDL 规范</h2><p>默认权限仅对“<strong>管理员角色创建的对象</strong>”自动生效。</p><p>这意味着：</p><ul><li>必须使用 <code>dbuser_dba</code>/<code>postgres</code> 执行 DDL</li><li>或业务管理员先 <code>SET ROLE dbrole_admin</code></li></ul><p>否则新对象会脱离默认权限体系，破坏最小权限原则。</p><hr><h2 id=数据库隔离>数据库隔离</h2><p>数据库级别支持 <code>revokeconn</code>，可做到跨库隔离：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: appdb, owner: dbuser_app, revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>解决的问题</strong></p><ul><li>一个账号可以“穿透”访问所有数据库</li><li>多租户数据库缺乏边界</li></ul><hr><h2 id=公共权限收敛>公共权限收敛</h2><p>Pigsty 初始化时撤销 <code>public</code> 模式的 <code>CREATE</code> 权限：</p><pre tabindex=0><code>REVOKE CREATE ON SCHEMA public FROM PUBLIC;
</code></pre><p><strong>解决的问题</strong></p><ul><li>非授权用户随意创建对象</li><li>“影子表/影子函数”带来的安全风险</li></ul><hr><h2 id=离线角色的作用>离线角色的作用</h2><p><code>dbrole_offline</code> 只能访问离线实例（<code>pg_role=offline</code> 或 <code>pg_offline_query=true</code>）。</p><p><strong>解决的问题</strong></p><ul><li>ETL/分析任务影响生产性能</li><li>个人账号在主库执行高危查询</li></ul><hr><h2 id=最佳实践>最佳实践</h2><ul><li>业务账号默认使用 <code>dbrole_readwrite</code> 或 <code>dbrole_readonly</code>。</li><li>生产 DDL 必须经由管理员角色。</li><li>多租户业务启用 <code>revokeconn</code> 隔离。</li><li>报表/ETL 使用 <code>dbrole_offline</code>。</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>🔑 <a href=/docs/concept/sec/auth><strong>身份认证</strong></a>：HBA 规则与密码策略</li><li>🔐 <a href=/docs/concept/sec/ca><strong>加密通信</strong></a>：TLS 与证书管理</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：等保与 SOC2 对照</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8b790153f8312a89aef83b802d30c481>7.4 - 加密通信与本地 CA</h1><div class=lead>Pigsty 内置自签 CA，签发 TLS 证书并加密通信流量。</div><p>加密通信解决三个问题：</p><ul><li><strong>窃听</strong>：防止明文流量被监听</li><li><strong>篡改</strong>：防止中间人修改数据</li><li><strong>冒充</strong>：防止服务端/客户端被伪造</li></ul><p>Pigsty 通过 <strong>本地 CA + TLS</strong> 为数据库与基础设施组件提供统一的信任根。</p><hr><h2 id=本地-ca-的作用>本地 CA 的作用</h2><p>Pigsty 默认会在管理节点生成自签 CA：</p><pre tabindex=0><code>files/pki/ca/ca.key   # CA 私钥（必须严格保护）
files/pki/ca/ca.crt   # CA 根证书（可分发）
</code></pre><p>源码默认值：</p><ul><li><code>ca_create: true</code>：找不到 CA 时自动生成。</li><li><code>ca_cn: pigsty-ca</code>：CA 证书 CN 固定为 <code>pigsty-ca</code>。</li><li>根证书有效期约 100 年（自签）。</li><li>由 CA 签发的服务器/客户端证书有效期 <code>cert_validity: 7300d</code>（20 年）。</li></ul><hr><h2 id=证书覆盖范围>证书覆盖范围</h2><p>本地 CA 会签发多种组件证书，统一信任链：</p><table class=full-width><thead><tr><th>组件</th><th>目的</th><th>典型路径</th></tr></thead><tbody><tr><td>PostgreSQL / PgBouncer</td><td>连接加密</td><td><code>/pg/cert/</code></td></tr><tr><td>Patroni</td><td>API 通信</td><td><code>/pg/cert/</code></td></tr><tr><td>etcd</td><td>DCS 加密</td><td><code>/etc/etcd/</code></td></tr><tr><td>MinIO</td><td>对象存储 HTTPS</td><td><code>~minio/.minio/certs/</code></td></tr><tr><td>Nginx</td><td>Web 入口 HTTPS</td><td><code>/etc/nginx/conf.d/cert/</code></td></tr></tbody></table><p><strong>解决的问题</strong>：不同组件自建证书会产生信任碎片，统一 CA 可以一次分发，多处复用。</p><hr><h2 id=信任分发>信任分发</h2><p>Pigsty 安装时会将 <code>ca.crt</code> 分发到所有节点并加入系统信任：</p><ul><li>证书路径：<code>/etc/pki/ca.crt</code></li><li>EL 系列：<code>/etc/pki/ca-trust/source/anchors/</code></li><li>Debian/Ubuntu：<code>/usr/local/share/ca-certificates/</code></li></ul><p>这样可以让系统内的客户端自动信任 Pigsty 签发的证书。</p><hr><h2 id=使用外部-ca>使用外部 CA</h2><p>如果你已有企业 CA，可以直接替换：</p><pre tabindex=0><code>files/pki/ca/ca.key
files/pki/ca/ca.crt
</code></pre><p>建议设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>ca_create</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>解决的问题</strong>：防止系统误生成新的自签 CA，导致证书信任链混乱。</p><hr><h2 id=客户端证书认证>客户端证书认证</h2><p>证书认证可以替代或增强密码认证：</p><ul><li>避免密码被钓鱼或泄露</li><li>证书可绑定设备与账号</li></ul><p>Pigsty 自带 <code>cert.yml</code> 用于签发客户端证书：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_dba
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_monitor
</span></span></code></pre></div><p>默认生成在：</p><pre tabindex=0><code>files/pki/misc/&lt;cn&gt;.key
files/pki/misc/&lt;cn&gt;.crt
</code></pre><hr><h2 id=密钥保护与轮换>密钥保护与轮换</h2><ul><li>CA 私钥默认 0600 权限，并在 0700 目录中保存。</li><li>一旦 CA 私钥泄露，必须重新生成 CA 并重签所有证书。</li><li>建议在重大升级或密钥泄露事件后进行证书轮换。</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>🔑 <a href=/docs/concept/sec/auth><strong>身份认证</strong></a>：HBA 与证书认证</li><li>👤 <a href=/docs/concept/sec/ac><strong>访问控制</strong></a>：角色与权限模型</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：合规要求与证据准备</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7e0ac5f31c46a7de87a54fa692c7e8f1>7.5 - 数据安全</h1><div class=lead>数据完整性、备份与恢复、加密与审计。</div><p>数据安全关注三件事：<strong>完整性、可恢复性、保密性</strong>。Pigsty 在默认配置中已启用关键能力，并支持按需加固。</p><hr><h2 id=数据完整性>数据完整性</h2><p><strong>解决的问题</strong></p><ul><li>磁盘坏块、内存错误导致的静默损坏</li><li>意外写入导致的数据污染</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>数据校验和</strong>：默认 <code>pg_checksum: true</code>，初始化时启用 <code>data-checksums</code>。</li><li><strong>副本兜底</strong>：主库坏块可从从库恢复（与 HA 配合使用）。</li></ul><hr><h2 id=可恢复性备份与-pitr>可恢复性（备份与 PITR）</h2><p><strong>解决的问题</strong></p><ul><li>误删误改</li><li>灾难性故障导致数据丢失</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>pgBackRest 默认启用</strong>：<code>pgbackrest_enabled: true</code>。</li><li><strong>本地仓库</strong>：默认保留 2 份完整备份。</li><li><strong>远程仓库</strong>：可接入 MinIO，支持对象存储与多副本。</li><li><strong>PITR</strong>：结合 WAL 归档进行任意时间点恢复。</li></ul><hr><h2 id=数据保密性>数据保密性</h2><p><strong>解决的问题</strong></p><ul><li>备份被窃导致数据外泄</li><li>介质被盗导致明文数据泄露</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>备份加密</strong>：MinIO 仓库支持 AES-256-CBC（<code>cipher_type</code>）。</li><li><strong>透明加密（可选）</strong>：通过 <code>pg_tde</code> 等扩展实现数据静态加密。</li><li><strong>密钥隔离</strong>：建议将 <code>cipher_pass</code> 与 CA 私钥分离管理。</li></ul><hr><h2 id=审计与可追溯>审计与可追溯</h2><p><strong>解决的问题</strong></p><ul><li>无法追责与还原操作</li><li>合规审计缺少证据</li></ul><p><strong>Pigsty 支持</strong></p><ul><li><strong>日志收集</strong>：模板默认启用 <code>logging_collector</code>。</li><li><strong>DDL 审计</strong>：<code>log_statement: ddl</code>。</li><li><strong>慢查询</strong>：<code>log_min_duration_statement</code>。</li><li><strong>连接日志</strong>：<code>log_connections</code>（PG18+）。</li><li><strong>审计扩展</strong>：<code>pgaudit</code>、<code>pgauditlogtofile</code> 可选。</li></ul><hr><h2 id=加固建议>加固建议</h2><ul><li>对远程备份强制加密与专用密钥。</li><li>定期演练 PITR，验证恢复链路。</li><li>对关键业务启用 <code>pgaudit</code>。</li><li>结合 <a href=/docs/concept/ha/>高可用</a> 形成“备份 + 副本”双层兜底。</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>🔐 <a href=/docs/concept/sec/ca><strong>加密通信</strong></a>：证书管理与 TLS</li><li>✅ <a href=/docs/concept/sec/compliance><strong>合规清单</strong></a>：审计与合规要求</li><li>⏰ <a href=/docs/concept/pitr/><strong>备份恢复</strong></a>：PITR 机制与实践</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d273c15ad260463dcc3b8ed6fad3a323>7.6 - 合规清单</h1><div class=lead>以 SOC2 与等保三级为切入点，映射 Pigsty 安全能力与证据准备。</div><p>合规不是“开关”，而是 <strong>配置 + 流程 + 证据</strong> 的组合：</p><ul><li><strong>配置</strong>：安全能力是否启用（HBA/TLS/审计/备份）</li><li><strong>流程</strong>：是否有权限管理、变更、备份演练等制度</li><li><strong>证据</strong>：日志、配置快照、备份报告、监控告警</li></ul><p>本页以 SOC2 与等保三级为切入点，说明 Pigsty 的安全能力与合规映射。</p><hr><h2 id=默认凭证清单必须修改>默认凭证清单（必须修改）</h2><p>来自源码默认值：</p><table class=full-width><thead><tr><th>组件</th><th>默认用户名</th><th>默认密码</th></tr></thead><tbody><tr><td>PostgreSQL 管理员</td><td><code>dbuser_dba</code></td><td><code>DBUser.DBA</code></td></tr><tr><td>PostgreSQL 监控</td><td><code>dbuser_monitor</code></td><td><code>DBUser.Monitor</code></td></tr><tr><td>PostgreSQL 复制</td><td><code>replicator</code></td><td><code>DBUser.Replicator</code></td></tr><tr><td>Patroni API</td><td><code>postgres</code></td><td><code>Patroni.API</code></td></tr><tr><td>HAProxy 管理</td><td><code>admin</code></td><td><code>pigsty</code></td></tr><tr><td>Grafana 管理</td><td><code>admin</code></td><td><code>pigsty</code></td></tr><tr><td>MinIO Root</td><td><code>minioadmin</code></td><td><code>S3User.MinIO</code></td></tr><tr><td>etcd Root</td><td><code>root</code></td><td><code>Etcd.Root</code></td></tr></tbody></table><p>生产环境必须修改。</p><hr><h2 id=证据准备建议>证据准备（建议）</h2><table class=full-width><thead><tr><th>证据类型</th><th>说明</th><th>Pigsty 支持</th></tr></thead><tbody><tr><td>配置快照</td><td>HBA、角色、TLS、备份策略</td><td><code>pigsty.yml</code> / inventory 配置</td></tr><tr><td>访问控制</td><td>角色与权限</td><td><code>pg_default_roles</code> / <code>pg_default_privileges</code></td></tr><tr><td>连接审计</td><td>连接、断开、DDL</td><td><code>log_connections</code> / <code>log_statement</code></td></tr><tr><td>备份报告</td><td>完整备份与恢复记录</td><td>pgBackRest 日志与任务</td></tr><tr><td>监控告警</td><td>异常事件记录</td><td>Prometheus + Grafana</td></tr><tr><td>证书管理</td><td>CA/证书分发记录</td><td><code>files/pki/</code> / <code>/etc/pki/ca.crt</code></td></tr></tbody></table><hr><h2 id=soc2-视角示例映射>SOC2 视角（示例映射）</h2><p>SOC2 的核心是 <strong>安全、可用性、机密性</strong>。以下为常见控制点的概念映射：</p><table class=full-width><thead><tr><th>控制点（SOC2）</th><th>解决的问题</th><th>Pigsty 能力</th><th>需要流程</th></tr></thead><tbody><tr><td>CC6 逻辑访问控制</td><td>未授权访问</td><td>HBA + RBAC + 默认权限</td><td>权限审批与定期审计</td></tr><tr><td>CC6 认证强度</td><td>弱口令/复用</td><td>SCRAM + <code>passwordcheck</code></td><td>密码轮换策略</td></tr><tr><td>CC6 传输加密</td><td>明文传输</td><td>TLS/CA、<code>ssl</code>/<code>cert</code></td><td>强制 TLS 政策</td></tr><tr><td>CC7 系统监控</td><td>异常未发现</td><td>Prometheus/Grafana</td><td>告警处理流程</td></tr><tr><td>CC7 审计追踪</td><td>无法追责</td><td>连接/DDL/慢查日志、<code>pgaudit</code></td><td>日志留存与审查</td></tr><tr><td>CC9 业务连续性</td><td>数据不可恢复</td><td>pgBackRest + PITR</td><td>定期恢复演练</td></tr></tbody></table><blockquote><p>以上为概念映射，实际 SOC2 需要配合组织制度与审计证据。</p></blockquote><hr><h2 id=等保三级gbt-22239-2019映射>等保三级（GB/T 22239-2019）映射</h2><p>等保三级关注“身份鉴别、访问控制、审计、数据安全、通信安全、主机安全、网络边界”等。以下为核心控制点与 Pigsty 能力的对应关系：</p><table class=full-width><thead><tr><th>控制点</th><th>解决的问题</th><th>Pigsty 能力</th><th>需要配置/流程</th></tr></thead><tbody><tr><td>身份鉴别唯一性</td><td>账号混用</td><td>唯一用户 + SCRAM</td><td>账号管理流程</td></tr><tr><td>口令复杂度</td><td>弱口令</td><td><code>passwordcheck</code>/<code>credcheck</code></td><td>启用扩展</td></tr><tr><td>口令定期更换</td><td>长期风险</td><td><code>expire_in</code></td><td>密码轮换制度</td></tr><tr><td>访问控制</td><td>越权访问</td><td>RBAC + 默认权限</td><td>权限审批</td></tr><tr><td>最小权限</td><td>权限膨胀</td><td>四层角色模型</td><td>账号分级</td></tr><tr><td>通信保密性</td><td>明文泄露</td><td>TLS/CA、HBA <code>ssl/cert</code></td><td>强制 TLS</td></tr><tr><td>安全审计</td><td>无法追责</td><td>连接/DDL/慢查日志 + <code>pgaudit</code></td><td>日志留存</td></tr><tr><td>数据完整性</td><td>静默损坏</td><td><code>pg_checksum: true</code></td><td>-</td></tr><tr><td>数据备份恢复</td><td>数据丢失</td><td>pgBackRest + PITR</td><td>演练与验收</td></tr><tr><td>主机安全</td><td>主机被攻破</td><td>SELinux/防火墙</td><td>加固策略</td></tr><tr><td>边界安全</td><td>暴露入口</td><td>HAProxy/Nginx 统一入口</td><td>网络分区</td></tr><tr><td>安全管理制度</td><td>缺乏流程</td><td>-</td><td>制度与审批</td></tr></tbody></table><p><strong>提示</strong>：等保三级不仅是技术问题，还需要完善的制度与运维流程支撑。</p><hr><h2 id=合规加固配置片段>合规加固配置片段</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 强制 SSL / 证书</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;, db: all, addr: intra, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_dba, db: all, addr: world, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cert }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 密码强度</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;$libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>passwordcheck, credcheck ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PgBouncer / Patroni TLS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>require</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_ssl_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 操作系统安全</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_firewall_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zone</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_selinux_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>enforcing</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=合规检查清单>合规检查清单</h2><h3 id=部署前>部署前</h3><ul><li><input disabled type=checkbox> 网络分区与可信 CIDR 明确</li><li><input disabled type=checkbox> 证书策略确定（自签/企业 CA）</li><li><input disabled type=checkbox> 账号权限分级方案明确</li></ul><h3 id=部署后必做>部署后（必做）</h3><ul><li><input disabled type=checkbox> 修改所有默认密码</li><li><input disabled type=checkbox> 验证 HBA 规则符合预期</li><li><input disabled type=checkbox> 启用并验证 TLS</li><li><input disabled type=checkbox> 配置审计与日志留存策略</li></ul><h3 id=定期维护>定期维护</h3><ul><li><input disabled type=checkbox> 权限审计与账号清理</li><li><input disabled type=checkbox> 证书轮换</li><li><input disabled type=checkbox> 备份恢复演练</li></ul><hr><h2 id=接下来>接下来</h2><ul><li>🔑 <a href=/docs/concept/sec/auth><strong>身份认证</strong></a>：HBA 与密码策略</li><li>🔒 <a href=/docs/concept/sec/data><strong>数据安全</strong></a>：备份与加密</li><li>♾️ <a href=/docs/concept/ha/><strong>高可用</strong></a>：业务连续性</li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>