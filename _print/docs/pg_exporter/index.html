<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/pg_exporter/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/pg_exporter/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>PG Exporter | PIGSTY</title><meta name=description content="高级 PostgreSQL 与 PgBouncer 监控指标导出器"><meta property="og:url" content="https://pigsty.cc/docs/pg_exporter/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="PG Exporter"><meta property="og:description" content="高级 PostgreSQL 与 PgBouncer 监控指标导出器"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="PG Exporter"><meta itemprop=description content="高级 PostgreSQL 与 PgBouncer 监控指标导出器"><meta itemprop=dateModified content="2026-02-12T14:04:02+08:00"><meta itemprop=wordCount content="261"><meta name=twitter:card content="summary"><meta name=twitter:title content="PG Exporter"><meta name=twitter:description content="高级 PostgreSQL 与 PgBouncer 监控指标导出器"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/pg_exporter/>返回本页常规视图</a>.</p></div><h1 class=title>PG Exporter</h1><div class=lead>高级 PostgreSQL 与 PgBouncer 监控指标导出器</div><ul><li>1: <a href=#pg-416779b927fdf2fa5bc082ae68cec4fa>快速上手</a></li><li>2: <a href=#pg-b9b6ba4bbd74b45a60bb542f3916c5e9>安装指南</a></li><li>3: <a href=#pg-2f867767b775498210979b35165c4390>配置参考</a></li><li>4: <a href=#pg-675a152e2a26dbcc46c98b2d6b49d625>API 参考</a></li><li>5: <a href=#pg-403a539868ecb0c6cbcc02f03ee09c43>部署指南</a></li><li>6: <a href=#pg-6422ba42493572f811549fcad2c81178>发布注记</a></li></ul><div class=content><p>为 Prometheus / Victoria 打造的极致 PostgreSQL 监控体验：超过 <strong>600+</strong> 监控指标、<strong>声明式配置</strong> 与 <strong>动态规划</strong> 能力。</p><p><a href=/docs/pg_exporter/start><strong>快速上手</strong></a> | <a href=https://github.com/pgsty/pg_exporter><strong>GitHub</strong></a> | <a href=https://g.pgsty.com><strong>在线演示</strong></a></p><hr><h2 id=功能特性>功能特性</h2><table class=full-width><thead><tr><th>特性</th><th>描述</th></tr></thead><tbody><tr><td><strong>全指标覆盖</strong></td><td>监控 PostgreSQL（10-18+）与 pgBouncer（1.8-1.25+），全指标覆盖</td></tr><tr><td><strong>声明式配置</strong></td><td>通过 YAML 配置文件定义自定义指标，精细控制超时、缓存和跳过条件</td></tr><tr><td><strong>采集器定制</strong></td><td>使用声明式 YAML 配置定义自己的指标，支持动态查询规划</td></tr><tr><td><strong>自动发现</strong></td><td>自动发现并监控 PostgreSQL 实例中的多个数据库</td></tr><tr><td><strong>动态规划</strong></td><td>根据 PostgreSQL 版本、扩展和服务器特性自动调整指标采集策略</td></tr><tr><td><strong>生产就绪</strong></td><td>在真实环境中经过 6 年以上、12K+ 核心的实战检验，具备企业级可靠性</td></tr><tr><td><strong>健康检查</strong></td><td>提供全面的 HTTP 端点用于服务健康检查和流量路由，支持主从检测</td></tr><tr><td><strong>智能缓存</strong></td><td>内置缓存机制，可配置 TTL，减少数据库负载并提升性能</td></tr><tr><td><strong>扩展感知</strong></td><td>原生支持 pg_stat_statements、pg_wait_sampling、citus、timescaledb</td></tr></tbody></table><hr><h2 id=版本信息>版本信息</h2><ul><li>当前稳定版本：<a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.2.0><code>v1.2.0</code></a></li><li>默认配置支持：PostgreSQL <strong>10-18+</strong></li><li>Legacy 配置支持：PostgreSQL <strong>9.1-9.6</strong>（使用 <code>legacy/</code> 配置包）</li><li>PgBouncer 支持：<strong>1.8-1.25+</strong></li></ul><p>完整版本历史见 <a href=/docs/pg_exporter/release>发布注记</a>。</p><hr><h2 id=设计逻辑>设计逻辑</h2><p><code>pg_exporter</code> 的核心设计取向是「本地优先 + 可声明 + 可演进」：</p><ul><li>本地优先连接：未显式指定 URL 时默认使用 <code>postgresql:///?sslmode=disable</code>，适配同机部署场景</li><li>声明式采集：指标由 YAML 采集器定义驱动，行为可通过 <code>ttl</code>、<code>timeout</code>、<code>tags</code>、<code>fatal</code> 精细控制</li><li>动态规划：运行时依据版本、角色、扩展与标签自动选择采集器分支</li><li>可持续运行：默认非阻塞启动，目标不可达时也可先启动 HTTP 端点，待数据库恢复后自动恢复采集</li><li>热重载能力：支持 <code>POST/GET /reload</code> 与 <code>SIGHUP</code> 信号重载（非 Windows 额外支持 <code>SIGUSR1</code>）</li><li>健康探针分离：健康端点基于后台探测缓存，避免每次探针请求都阻塞数据库</li></ul><hr><h2 id=快速安装>快速安装</h2><p>PG Exporter 提供多种 <a href=/docs/pg_exporter/install><strong>安装方式</strong></a>，适配各种基础设施：</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
安装</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
Docker</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
YUM</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
APT</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
二进制</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
源码</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d --name pg_exporter -p 9630:9630 -e <span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;postgres://user:pass@host:5432/postgres&#34;</span> pgsty/pg_exporter:latest</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 基于 RPM 的系统</span>
</span></span><span style=display:flex><span>sudo tee /etc/yum.repos.d/pigsty-infra.repo &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[pigsty-infra]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>name=Pigsty Infra for $basearch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>baseurl=https://repo.pigsty.io/yum/infra/$basearch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>enabled = 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>gpgcheck = 0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>module_hotfixes=1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo yum makecache<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>sudo yum install -y pg_exporter</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty-infra.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [trusted=yes] https://repo.pigsty.io/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo apt update<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>sudo apt install -y pg-exporter</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wget https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.linux-amd64.tar.gz
</span></span><span style=display:flex><span>tar -xf pg_exporter-1.2.0.linux-amd64.tar.gz
</span></span><span style=display:flex><span>sudo install pg_exporter-1.2.0.linux-amd64/pg_exporter /usr/bin/
</span></span><span style=display:flex><span>sudo install pg_exporter-1.2.0.linux-amd64/pg_exporter.yml /etc/pg_exporter.yml</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从源码构建</span>
</span></span><span style=display:flex><span>git clone https://github.com/pgsty/pg_exporter.git
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> pg_exporter
</span></span><span style=display:flex><span>make build</span></span></code></pre></div></div></div><hr><h2 id=快速开始>快速开始</h2><p>几分钟内即可启动 PG Exporter，参见 <a href=/docs/pg_exporter/start>快速上手</a>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 最小可用启动（本地优先默认 URL）</span>
</span></span><span style=display:flex><span>pg_exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或显式指定目标</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;postgres://user:pass@localhost:5432/postgres&#39;</span> pg_exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 访问指标</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/metrics
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在线重载配置（推荐 POST）</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:9630/reload
</span></span></code></pre></div><hr><h2 id=在线演示>在线演示</h2><p>通过在线演示环境体验 PG Exporter 的实际效果：<strong><a href=https://g.pgsty.com>https://g.pgsty.com</a></strong></p><p>演示展示了由 PG Exporter 监控的真实 PostgreSQL 集群，包含：</p><ul><li>使用 Grafana 的实时指标可视化</li><li>多个 PostgreSQL 版本和配置</li><li>扩展特定的指标和监控</li><li>由 <a href=https://pigsty.cc>Pigsty</a> 驱动的完整可观测性堆栈</li></ul><hr><h2 id=社区与支持>社区与支持</h2><ul><li><a href=https://github.com/pgsty/pg_exporter><strong>GitHub</strong></a>：源代码、问题反馈与贡献</li><li><a href=https://github.com/pgsty/pg_exporter/discussions><strong>讨论区</strong></a>：提问与分享经验</li><li><a href=https://pigsty.cc><strong>Pigsty</strong></a>：包含 PG Exporter 的完整 PostgreSQL 发行版</li></ul><hr><h2 id=开源协议>开源协议</h2><p>PG Exporter 是基于 <a href=https://github.com/pgsty/pg_exporter/blob/main/LICENSE>Apache License 2.0</a> 许可的开源软件。</p><p>Copyright 2018-2026 © <a href=https://vonng.com/en>冯若航</a> / <a href=mailto:rh@vonng.com>rh@vonng.com</a></p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-416779b927fdf2fa5bc082ae68cec4fa>1 - 快速上手</h1><div class=lead>几分钟内启动并运行 PG Exporter</div><p>PG Exporter 是一款先进的 PostgreSQL 与 pgBouncer 指标导出器，专为 Prometheus 设计。本指南将帮助您快速启动并运行。</p><hr><h2 id=前置条件>前置条件</h2><p>在开始之前，请确保您具备：</p><ul><li>PostgreSQL 10+ 或 pgBouncer 1.8+ 实例用于监控</li><li>具有适当监控权限的用户账户</li><li>Prometheus 兼容系统（用于指标抓取）</li><li>对 PostgreSQL 连接字符串的基本了解</li></ul><hr><h2 id=版本信息>版本信息</h2><ul><li>当前稳定版本：<a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.2.0><code>v1.2.0</code></a></li><li>默认配置支持 PostgreSQL 10-18+；PostgreSQL 9.1-9.6 需使用 <code>legacy/</code> 配置包</li><li>支持 pgBouncer 1.8-1.25+</li></ul><hr><h2 id=设计逻辑>设计逻辑</h2><p><code>pg_exporter</code> 的运行逻辑可以概括为三点：</p><ul><li>本地优先连接：当没有传入 <code>--url</code> / <code>PG_EXPORTER_URL</code> 时，默认回退到 <code>postgresql:///?sslmode=disable</code></li><li>声明式采集：所有业务指标来自 YAML 采集器，运行时按版本/角色/标签动态选择分支</li><li>可持续运行：默认非阻塞启动，目标库暂时不可达时也先启动 HTTP 端点，并在后台持续恢复健康状态</li></ul><hr><h2 id=快速开始>快速开始</h2><p>最快速地启动 PG Exporter：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 示例：Linux amd64 安装（其他平台请替换对应发布文件）</span>
</span></span><span style=display:flex><span>wget https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.linux-amd64.tar.gz
</span></span><span style=display:flex><span>tar -xf pg_exporter-1.2.0.linux-amd64.tar.gz
</span></span><span style=display:flex><span>sudo install pg_exporter-1.2.0.linux-amd64/pg_exporter /usr/bin/
</span></span><span style=display:flex><span>sudo install pg_exporter-1.2.0.linux-amd64/pg_exporter.yml /etc/pg_exporter.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用默认 URL（本地优先）运行</span>
</span></span><span style=display:flex><span>pg_exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或显式指定 PostgreSQL / PgBouncer URL</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;postgres://user:pass@localhost:5432/postgres&#39;</span> pg_exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 验证指标是否可用</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/metrics
</span></span></code></pre></div><hr><h2 id=基本概念>基本概念</h2><h3 id=连接字符串>连接字符串</h3><p>PG Exporter 使用标准的 PostgreSQL 连接 URL：</p><pre tabindex=0><code>postgres://[user][:password]@[host][:port]/[database][?param=value]
</code></pre><p>示例：</p><ul><li>默认回退 URL（未显式指定时）：<code>postgresql:///?sslmode=disable</code></li><li>本地 PostgreSQL：<code>postgres:///postgres</code></li><li>带认证的远程连接：<code>postgres://monitor:password@db.example.com:5432/postgres</code></li><li>使用 SSL：<code>postgres://user:pass@host/db?sslmode=require</code></li><li>pgBouncer：<code>postgres://pgbouncer:password@localhost:6432/pgbouncer</code></li></ul><p>URL 来源优先级（高到低）：</p><ol><li><code>--url</code> 命令行参数</li><li><code>PG_EXPORTER_URL</code> 环境变量</li><li><code>PGURL</code> 环境变量</li><li><code>PG_EXPORTER_URL_FILE</code> 指向文件的内容</li><li>默认 <code>postgresql:///?sslmode=disable</code></li></ol><h3 id=内置指标>内置指标</h3><p>PG Exporter 开箱即用提供以下核心内置指标：</p><table class=full-width><thead><tr><th>指标</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><code>pg_up</code></td><td>Gauge</td><td>如果导出器能够连接到 PostgreSQL 则为 1，否则为 0</td></tr><tr><td><code>pg_version</code></td><td>Gauge</td><td>PostgreSQL 服务器版本号</td></tr><tr><td><code>pg_in_recovery</code></td><td>Gauge</td><td>如果服务器处于恢复模式（从库）则为 1，主库则为 0</td></tr><tr><td><code>pg_exporter_build_info</code></td><td>Gauge</td><td>导出器版本和构建信息</td></tr></tbody></table><p>此外还会暴露 <code>pg_exporter_*</code> 自监控指标（可通过 <code>--disable-intro</code> 关闭）。</p><h3 id=配置文件>配置文件</h3><p>所有其他指标（600+）都在 <code>pg_exporter.yml</code> 配置文件中定义。默认情况下，PG Exporter 会按以下顺序查找此文件：</p><ol><li>通过 <code>--config</code> 标志指定的路径</li><li><code>PG_EXPORTER_CONFIG</code> 环境变量中的路径</li><li>当前目录（<code>./pg_exporter.yml</code>）</li><li>系统配置文件（<code>/etc/pg_exporter.yml</code>）</li><li>系统配置目录（<code>/etc/pg_exporter/</code>）</li></ol><hr><h2 id=首次监控设置>首次监控设置</h2><h3 id=步骤-1创建监控用户>步骤 1：创建监控用户</h3><p>创建一个专用的 PostgreSQL 用户用于监控：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 创建登录用户（示例名：monitor）
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8> </span><span style=color:#000>PASSWORD</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;secure_password&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 授予必要权限
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对于 PostgreSQL 10+，内置 pg_monitor 角色提供监控视图读取权限
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对于更早版本，您可能需要额外的授权
</span></span></span></code></pre></div><h3 id=步骤-2测试连接>步骤 2：测试连接</h3><p>验证导出器能够连接到您的数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 设置连接 URL</span>
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;postgres://monitor:secure_password@localhost:5432/postgres&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 以干运行模式运行以测试配置</span>
</span></span><span style=display:flex><span>pg_exporter --dry-run
</span></span></code></pre></div><h3 id=步骤-3运行导出器>步骤 3：运行导出器</h3><p>启动 PG Exporter：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用默认设置运行</span>
</span></span><span style=display:flex><span>pg_exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或使用自定义标志</span>
</span></span><span style=display:flex><span>pg_exporter <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --url<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;postgres://monitor:secure_password@localhost:5432/postgres&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --web.listen-address<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;:9630&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --log.level<span style=color:#ce5c00;font-weight:700>=</span>info
</span></span></code></pre></div><h3 id=步骤-4配置-prometheus>步骤 4：配置 Prometheus</h3><p>在您的 <code>prometheus.yml</code> 中将 PG Exporter 添加为目标：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>scrape_configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>job_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgresql&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>static_configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>targets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;localhost:9630&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>instance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres-primary&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=步骤-5验证指标>步骤 5：验证指标</h3><p>检查指标是否正在被采集：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看原始指标</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/metrics <span style=color:#000;font-weight:700>|</span> grep pg_
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查导出器统计信息</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/stat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 验证服务器检测</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/explain
</span></span></code></pre></div><hr><h2 id=自动发现模式>自动发现模式</h2><p>PG Exporter 可以自动发现并监控 PostgreSQL 实例中的所有数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 启用自动发现（默认行为）</span>
</span></span><span style=display:flex><span>pg_exporter --auto-discovery
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 排除特定数据库</span>
</span></span><span style=display:flex><span>pg_exporter --auto-discovery <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --exclude-database<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;template0,template1,postgres&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 仅包含特定数据库</span>
</span></span><span style=display:flex><span>pg_exporter --auto-discovery <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --include-database<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;app_db,analytics_db&#34;</span>
</span></span></code></pre></div><p>当启用自动发现时：</p><ul><li>集群级指标（1xx-5xx）每个实例采集一次</li><li>数据库级指标（6xx-8xx）为每个发现的数据库采集</li><li>指标使用 <code>datname</code> 标签来区分不同的数据库</li></ul><hr><h2 id=监控-pgbouncer>监控 pgBouncer</h2><p>要监控 pgBouncer 而不是 PostgreSQL：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 连接到 pgBouncer 管理数据库</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;postgres://pgbouncer:password@localhost:6432/pgbouncer&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>pg_exporter --config<span style=color:#ce5c00;font-weight:700>=</span>/etc/pg_exporter.yml
</span></span></code></pre></div><p>导出器会自动检测 pgBouncer 并：</p><ul><li>使用 <code>pgbouncer</code> 命名空间作为指标前缀</li><li>执行 pgBouncer 专用采集器（9xx 系列）</li><li>提供 pgBouncer 专用的健康检查</li></ul><hr><h2 id=使用-docker>使用 Docker</h2><p>在容器中运行 PG Exporter：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --name pg_exporter <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -p 9630:9630 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;postgres://user:pass@host.docker.internal:5432/postgres&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  pgsty/pg_exporter:latest
</span></span></code></pre></div><p>使用自定义配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --name pg_exporter <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -p 9630:9630 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -v /path/to/pg_exporter.yml:/etc/pg_exporter.yml <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;postgres://user:pass@db:5432/postgres&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  pgsty/pg_exporter:latest
</span></span></code></pre></div><hr><h2 id=健康检查>健康检查</h2><p>PG Exporter 为负载均衡器和编排器提供健康检查端点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 基本健康检查</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/up
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 返回：连接正常返回 200，否则返回 503（响应体通常为 primary/replica/starting/down）</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 主库检测</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/primary
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 返回：主库返回 200，从库返回 404，未知返回 503</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从库检测</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/replica
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 返回：从库返回 200，主库返回 404，未知返回 503</span>
</span></span></code></pre></div><hr><h2 id=热重载>热重载</h2><p><code>pg_exporter</code> 支持在线重载采集器配置，无需重启进程：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 推荐：POST</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:9630/reload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 兼容：GET</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/reload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或使用信号触发（Unix）</span>
</span></span><span style=display:flex><span>pkill -HUP pg_exporter
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 非 Windows 还可以使用</span>
</span></span><span style=display:flex><span>pkill -USR1 pg_exporter
</span></span></code></pre></div><hr><h2 id=故障排查>故障排查</h2><h3 id=连接问题>连接问题</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用详细日志测试</span>
</span></span><span style=display:flex><span>pg_exporter --log.level<span style=color:#ce5c00;font-weight:700>=</span>debug --dry-run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查服务器规划</span>
</span></span><span style=display:flex><span>pg_exporter --explain
</span></span></code></pre></div><h3 id=权限错误>权限错误</h3><p>确保监控用户具有必要的权限：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 检查当前权限
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 如需要，授予额外权限
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USAGE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_catalog</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#000>TABLES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_catalog</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=抓取缓慢>抓取缓慢</h3><p>如果抓取超时：</p><ol><li>检查慢查询：<code>curl http://localhost:9630/stat</code></li><li>在配置中调整采集器超时</li><li>对昂贵的查询使用缓存（在采集器配置中设置 <code>ttl</code>）</li><li>如果不需要，禁用昂贵的采集器</li></ol><hr><h2 id=下一步>下一步</h2><ul><li><a href=/docs/pg_exporter/install/><strong>安装指南</strong></a>：各平台的详细安装说明</li><li><a href=/docs/pg_exporter/config/><strong>配置参考</strong></a>：完整的配置文档</li><li><a href=/docs/pg_exporter/deploy/><strong>部署指南</strong></a>：生产部署最佳实践</li><li><a href=/docs/pg_exporter/api/><strong>API 参考</strong></a>：完整的 API 端点文档</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-b9b6ba4bbd74b45a60bb542f3916c5e9>2 - 安装指南</h1><div class=lead>如何下载和安装 PG Exporter</div><p>PG Exporter 提供多种安装方式以适应不同的部署场景。本指南涵盖了各平台的所有可用安装选项及详细说明。</p><hr><h2 id=pigsty>Pigsty</h2><p>最简单的使用 <code>pg_exporter</code> 的方式是使用 <a href=https://pigsty.cc>Pigsty</a>，这是一个完整的 PostgreSQL 发行版，内置了基于 <code>pg_exporter</code>、Prometheus 和 Grafana 的可观测性最佳实践。您甚至不需要了解 <code>pg_exporter</code> 的任何细节，它会直接为您提供所有指标和仪表盘面板。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div><hr><h2 id=发布版本>发布版本</h2><p>您也可以直接从 <a href=https://github.com/pgsty/pg_exporter/releases/latest>GitHub 发布页面</a> 下载 <code>pg_exporter</code> 软件包（<code>RPM</code>/<code>DEB</code>/Tarball）：</p><p><strong>v1.2.0 发布文件：</strong></p><table class=full-width><thead><tr><th>类型</th><th>文件</th></tr></thead><tbody><tr><td>DEB (amd64)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg-exporter_1.2.0-1_amd64.deb>pg-exporter_1.2.0-1_amd64.deb</a></td></tr><tr><td>DEB (arm64)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg-exporter_1.2.0-1_arm64.deb>pg-exporter_1.2.0-1_arm64.deb</a></td></tr><tr><td>DEB (ppc64le)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg-exporter_1.2.0-1_ppc64le.deb>pg-exporter_1.2.0-1_ppc64le.deb</a></td></tr><tr><td>RPM (aarch64)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0-1.aarch64.rpm>pg_exporter-1.2.0-1.aarch64.rpm</a></td></tr><tr><td>RPM (x86_64)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0-1.x86_64.rpm>pg_exporter-1.2.0-1.x86_64.rpm</a></td></tr><tr><td>RPM (ppc64le)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0-1.ppc64le.rpm>pg_exporter-1.2.0-1.ppc64le.rpm</a></td></tr><tr><td>Tarball (Linux amd64)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.linux-amd64.tar.gz>pg_exporter-1.2.0.linux-amd64.tar.gz</a></td></tr><tr><td>Tarball (Linux arm64)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.linux-arm64.tar.gz>pg_exporter-1.2.0.linux-arm64.tar.gz</a></td></tr><tr><td>Tarball (Linux ppc64le)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.linux-ppc64le.tar.gz>pg_exporter-1.2.0.linux-ppc64le.tar.gz</a></td></tr><tr><td>Tarball (macOS amd64)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.darwin-amd64.tar.gz>pg_exporter-1.2.0.darwin-amd64.tar.gz</a></td></tr><tr><td>Tarball (macOS arm64)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.darwin-arm64.tar.gz>pg_exporter-1.2.0.darwin-arm64.tar.gz</a></td></tr><tr><td>Tarball (Windows amd64)</td><td><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.windows-amd64.tar.gz>pg_exporter-1.2.0.windows-amd64.tar.gz</a></td></tr></tbody></table><p>您可以直接使用操作系统的包管理器（<code>rpm</code>/<code>dpkg</code>）安装，或者将二进制文件放入 <code>$PATH</code> 中。</p><hr><h2 id=软件仓库>软件仓库</h2><p>pg_exporter 软件包也可以在 <a href=https://ext.pgsty.com/repo/infra><code>pigsty-infra</code></a> 仓库中获取。您可以将该仓库添加到系统中，然后使用操作系统包管理器安装：</p><h3 id=yum>YUM</h3><p>适用于 RHEL、RockyLinux、CentOS、Alma Linux、OracleLinux 等 EL 系发行版：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tee /etc/yum.repos.d/pigsty-infra.repo &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>[pigsty-infra]
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>name=Pigsty Infra for $basearch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>baseurl=https://repo.pigsty.io/yum/infra/$basearch
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>enabled = 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>gpgcheck = 0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>module_hotfixes=1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo yum makecache<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>sudo yum install -y pg_exporter
</span></span></code></pre></div><h3 id=apt>APT</h3><p>适用于 Debian、Ubuntu 及兼容的 Linux 发行版：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty-infra.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [trusted=yes] https://repo.pigsty.io/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sudo apt update<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>sudo apt install -y pg-exporter
</span></span></code></pre></div><hr><h2 id=docker>Docker</h2><p>我们在 Docker Hub 上提供了 <code>amd64</code> 和 <code>arm64</code> 架构的预构建镜像：<a href=https://hub.docker.com/r/pgsty/pg_exporter>pgsty/pg_exporter</a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 基本用法</span>
</span></span><span style=display:flex><span>docker run -d <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --name pg_exporter <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -p 9630:9630 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;postgres://user:password@host:5432/postgres&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  pgsty/pg_exporter:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用自定义配置</span>
</span></span><span style=display:flex><span>docker run -d <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --name pg_exporter <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -p 9630:9630 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -v /path/to/pg_exporter.yml:/etc/pg_exporter.yml:ro <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>PG_EXPORTER_CONFIG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/etc/pg_exporter.yml&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;postgres://user:password@host:5432/postgres&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  pgsty/pg_exporter:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 启用自动发现</span>
</span></span><span style=display:flex><span>docker run -d <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --name pg_exporter <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -p 9630:9630 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;postgres://user:password@host:5432/postgres&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>PG_EXPORTER_AUTO_DISCOVERY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;true&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>PG_EXPORTER_EXCLUDE_DATABASE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;template0,template1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  pgsty/pg_exporter:latest
</span></span></code></pre></div><hr><h2 id=二进制安装>二进制安装</h2><p><code>pg_exporter</code> 可以作为独立的二进制文件安装。从发布页面下载适合您平台的 tarball，解压后将二进制文件放入 <code>$PATH</code> 即可使用。</p><hr><h2 id=兼容性>兼容性</h2><p>当前默认配置支持 PostgreSQL 10 及以上版本。
对于 EOL 旧版本 PostgreSQL，可以使用仓库内置的 <code>legacy/</code> 配置包进行兼容监控。</p><table class=full-width><thead><tr><th>PostgreSQL 版本</th><th>支持状态</th></tr></thead><tbody><tr><td>10 ~ 18+</td><td>✅ 完全支持（默认配置）</td></tr><tr><td>9.1 ~ 9.6</td><td>⚠️ 使用 <code>legacy/pg_exporter.yml</code></td></tr><tr><td>9.0 及更早</td><td>❌ 不支持</td></tr></tbody></table><p>启用 Legacy 配置示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make conf9
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_CONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>legacy/pg_exporter.yml pg_exporter
</span></span></code></pre></div><p>pg_exporter 支持 pgBouncer 1.8+（<code>v1.8</code> 是第一个支持 <code>SHOW</code> 命令的版本）。</p><table class=full-width><thead><tr><th>pgBouncer 版本</th><th>支持状态</th></tr></thead><tbody><tr><td>1.8.x ~ 1.25+</td><td>✅ 完全支持</td></tr><tr><td>1.8.x 之前</td><td>⚠️ 无指标</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-2f867767b775498210979b35165c4390>3 - 配置参考</h1><div class=lead>PG Exporter 的配置选项与采集器定义</div><p>PG Exporter 使用强大而灵活的配置系统，允许您定义自定义指标、控制采集行为并优化性能。本指南涵盖了从基础设置到高级自定义的所有配置方面。</p><hr><h2 id=指标采集器>指标采集器</h2><p>PG Exporter 使用声明式的 YAML 配置系统，为指标采集提供极大的灵活性和控制能力。本指南涵盖了为您的特定监控需求配置 PG Exporter 的所有方面。</p><hr><h2 id=配置概述>配置概述</h2><p>PG Exporter 的配置以 <strong>采集器</strong> 为核心 —— 每个采集器是一个独立的指标查询及其关联元数据。配置可以是：</p><ul><li>单一的 YAML 文件（<code>pg_exporter.yml</code>）</li><li>包含多个 YAML 文件的目录（按字母顺序合并）</li><li>通过命令行或环境变量指定的自定义路径</li></ul><hr><h2 id=配置加载>配置加载</h2><p>PG Exporter 按以下顺序搜索配置：</p><ol><li>命令行参数：<code>--config=/path/to/config</code></li><li>环境变量：<code>PG_EXPORTER_CONFIG=/path/to/config</code></li><li>当前目录：<code>./pg_exporter.yml</code></li><li>系统配置文件：<code>/etc/pg_exporter.yml</code></li><li>系统配置目录：<code>/etc/pg_exporter/</code></li></ol><p>目录模式说明：</p><ul><li>仅加载该目录下的 <code>.yml</code> / <code>.yaml</code> 文件（非递归）</li><li>按文件名字典序合并；同名采集器以后加载者覆盖先前定义</li><li>如果目录中有 YAML 文件但全部解析失败，导出器会直接返回错误而不是静默忽略</li></ul><hr><h2 id=采集器结构>采集器结构</h2><p>每个采集器是 YAML 配置中的一个顶级对象，具有唯一名称和多种属性：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>collector_branch_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 此采集器的唯一标识符</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>metric_namespace        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指标前缀（默认为分支名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;采集器描述&#34;</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 人类可读的描述</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>|                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 要执行的 SQL 查询</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>SELECT column1, column2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>FROM table</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 执行控制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>                        </span><span style=color:#8f5902;font-style:italic># 缓存生存时间（秒）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 查询超时（秒）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fatal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 如果为 true，失败将导致整个抓取失败</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>skip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 如果为 true，禁用此采集器</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 版本兼容性</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>min_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 最小 PostgreSQL 版本（包含）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>max_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>999999</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 最大 PostgreSQL 版本（不包含）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 执行标签</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>cluster, primary]      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 执行条件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 谓词查询（可选）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>predicate_queries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;check_function&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>predicate_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        SELECT EXISTS (...)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 指标定义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>column_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>GAUGE            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># GAUGE、COUNTER、LABEL 或 DISCARD</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>rename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>metric_name     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选：重命名指标</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;帮助文本&#34;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 指标描述</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># NULL 时的默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>scale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 值的缩放因子</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>配置校验约束（<code>v1.2.0</code>）：</p><ul><li>每个 <code>metrics</code> 列表项必须且只能定义一个列映射</li><li>每个采集器至少要有一个 <code>GAUGE</code> 或 <code>COUNTER</code> 列</li><li><code>usage</code> 仅支持 <code>GAUGE</code> / <code>COUNTER</code> / <code>LABEL</code> / <code>DISCARD</code></li><li>指标名、标签名会在加载阶段进行 Prometheus 规则校验，非法配置会直接报错</li></ul><hr><h2 id=核心配置元素>核心配置元素</h2><h3 id=采集器分支名称>采集器分支名称</h3><p>顶级键在整个配置中唯一标识一个采集器：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 必须唯一</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_db     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 实际的指标命名空间</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=查询定义>查询定义</h3><p>检索指标的 SQL 查询：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  SELECT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    datname,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    numbackends,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    xact_commit,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    xact_rollback,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    blks_read,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    blks_hit
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  FROM pg_stat_database
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>  WHERE datname NOT IN (&#39;template0&#39;, &#39;template1&#39;)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=指标类型>指标类型</h3><p>查询结果中的每一列必须映射到一个指标类型：</p><table class=full-width><thead><tr><th>用途</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td><code>GAUGE</code></td><td>可上下波动的瞬时值</td><td>当前连接数</td></tr><tr><td><code>COUNTER</code></td><td>只增不减的累计值</td><td>总事务数</td></tr><tr><td><code>LABEL</code></td><td>用作 Prometheus 标签</td><td>数据库名称</td></tr><tr><td><code>DISCARD</code></td><td>忽略此列</td><td>内部值</td></tr></tbody></table><h3 id=缓存控制ttl>缓存控制（TTL）</h3><p><code>ttl</code> 参数控制结果缓存：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 快速查询 - 最小缓存</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_activity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 缓存 1 秒</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 昂贵查询 - 较长缓存</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_table_bloat</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3600</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 缓存 1 小时</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>最佳实践：</p><ul><li>将 TTL 设置为小于您的抓取间隔</li><li>对昂贵的查询使用较长的 TTL</li><li>TTL 为 0 表示禁用缓存</li></ul><h3 id=超时控制>超时控制</h3><p>防止查询运行时间过长：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.1</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 默认 100ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.0</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 复杂查询使用 1 秒</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 禁用超时（不推荐）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=版本兼容性>版本兼容性</h3><p>控制哪些 PostgreSQL 版本可以运行此采集器：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100000</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># PostgreSQL 10.0+</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>140000</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 低于 PostgreSQL 14.0</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>版本号使用 PostgreSQL 内部 <code>server_version_num</code> 规则：</p><ul><li><code>100000</code> 表示 10.0</li><li><code>130200</code> 表示 13.2</li><li><code>160100</code> 表示 16.1</li><li><code>90600</code> 表示 9.6（Legacy 配置场景）</li></ul><hr><h2 id=标签系统>标签系统</h2><p>标签控制采集器的执行时机和位置：</p><h3 id=内置标签>内置标签</h3><table class=full-width><thead><tr><th>标签</th><th>描述</th></tr></thead><tbody><tr><td><code>cluster</code></td><td>每个 PostgreSQL 集群执行一次</td></tr><tr><td><code>primary</code> / <code>master</code></td><td>仅在主服务器上执行</td></tr><tr><td><code>standby</code> / <code>replica</code></td><td>仅在从服务器上执行</td></tr><tr><td><code>pgbouncer</code></td><td>仅用于 pgBouncer 连接</td></tr></tbody></table><h3 id=前缀标签>前缀标签</h3><table class=full-width><thead><tr><th>前缀</th><th>示例</th><th>描述</th></tr></thead><tbody><tr><td><code>dbname:</code></td><td><code>dbname:postgres</code></td><td>仅在特定数据库上执行</td></tr><tr><td><code>username:</code></td><td><code>username:monitor</code></td><td>仅使用特定用户时执行</td></tr><tr><td><code>extension:</code></td><td><code>extension:pg_stat_statements</code></td><td>仅当扩展已安装时执行</td></tr><tr><td><code>schema:</code></td><td><code>schema:public</code></td><td>仅当模式存在时执行</td></tr><tr><td><code>not:</code></td><td><code>not:slow</code></td><td>当导出器没有该标签时执行</td></tr></tbody></table><h3 id=自定义标签>自定义标签</h3><p>向导出器传递自定义标签：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_exporter --tag<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;production,critical&#34;</span>
</span></span></code></pre></div><p>然后在配置中使用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>expensive_metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>critical] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 仅在有 &#39;critical&#39; 标签时运行</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=谓词查询>谓词查询</h2><p>在执行主查询之前进行条件检查：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>predicate_queries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;检查 pg_stat_statements&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>predicate_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      SELECT EXISTS (
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        SELECT 1 FROM pg_extension
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        WHERE extname = &#39;pg_stat_statements&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      )</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>只有当所有谓词返回 <code>true</code> 时，主查询才会执行。</p><hr><h2 id=指标定义>指标定义</h2><h3 id=基本定义>基本定义</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>numbackends</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>GAUGE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;已连接的后端进程数&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=高级选项>高级选项</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>checkpoint_write_time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>COUNTER</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>rename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>write_time       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重命名指标</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>scale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.001</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 将毫秒转换为秒</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>default</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># NULL 时使用 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;检查点写入时间（秒）&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=采集器组织>采集器组织</h2><p>PG Exporter 自带预先组织好的采集器：</p><table class=full-width><thead><tr><th>范围</th><th>类别</th><th>描述</th></tr></thead><tbody><tr><td>0xx</td><td>文档</td><td>示例和文档</td></tr><tr><td>1xx</td><td>基础</td><td>服务器信息、设置、元数据</td></tr><tr><td>2xx</td><td>复制</td><td>复制、槽位、接收器</td></tr><tr><td>3xx</td><td>持久化</td><td>I/O、检查点、WAL</td></tr><tr><td>4xx</td><td>活动</td><td>连接、锁、查询</td></tr><tr><td>5xx</td><td>进度</td><td>Vacuum、索引创建进度</td></tr><tr><td>6xx</td><td>数据库</td><td>每数据库统计</td></tr><tr><td>7xx</td><td>对象</td><td>表、索引、函数</td></tr><tr><td>8xx</td><td>可选</td><td>昂贵/可选指标</td></tr><tr><td>9xx</td><td>pgBouncer</td><td>连接池指标</td></tr><tr><td>10xx+</td><td>扩展</td><td>扩展特定指标</td></tr></tbody></table><hr><h2 id=实际示例>实际示例</h2><h3 id=简单的-gauge-采集器>简单的 Gauge 采集器</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;当前数据库连接&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    SELECT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      count(*) as total,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      count(*) FILTER (WHERE state = &#39;active&#39;) as active,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      count(*) FILTER (WHERE state = &#39;idle&#39;) as idle,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      count(*) FILTER (WHERE state = &#39;idle in transaction&#39;) as idle_in_transaction
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    FROM pg_stat_activity
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    WHERE pid != pg_backend_pid()</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>total</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;总连接数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>active</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;活跃连接数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>idle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;空闲连接数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>idle_in_transaction</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;事务中空闲连接数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=带标签的-counter>带标签的 Counter</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_table_stats</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;表统计信息&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    SELECT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      schemaname,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      tablename,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      n_tup_ins,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      n_tup_upd,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      n_tup_del,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      n_live_tup,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      n_dead_tup
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    FROM pg_stat_user_tables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>schemaname</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>LABEL}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>tablename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>LABEL}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>n_tup_ins</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: COUNTER, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;插入的元组数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>n_tup_upd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: COUNTER, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;更新的元组数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>n_tup_del</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: COUNTER, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;删除的元组数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>n_live_tup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;活跃元组数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>n_dead_tup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;死亡元组数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=版本特定采集器>版本特定采集器</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_wal_stats</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;WAL 统计信息（PG 14+）&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>min_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>140000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    SELECT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      wal_records,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      wal_bytes,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      wal_buffers_full,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      wal_write_time,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      wal_sync_time
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    FROM pg_stat_wal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>cluster]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>wal_records</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>COUNTER}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>wal_bytes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>COUNTER}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>wal_buffers_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>COUNTER}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>wal_write_time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: COUNTER, scale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.001</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>wal_sync_time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: COUNTER, scale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.001</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=扩展依赖采集器>扩展依赖采集器</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements_metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;查询性能统计&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>extension:pg_stat_statements]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    SELECT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      sum(calls) as total_calls,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      sum(total_exec_time) as total_time,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      sum(mean_exec_time * calls) / sum(calls) as mean_time
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    FROM pg_stat_statements</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>total_calls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>COUNTER}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>total_time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: COUNTER, scale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.001</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>mean_time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, scale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.001</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=自定义采集器>自定义采集器</h2><h3 id=创建自己的指标>创建自己的指标</h3><ol><li>在配置目录中创建新的 YAML 文件：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># /etc/pg_exporter/custom_metrics.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>app_metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;应用特定指标&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    SELECT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      (SELECT count(*) FROM users WHERE active = true) as active_users,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      (SELECT count(*) FROM orders WHERE created_at &gt; NOW() - &#39;1 hour&#39;::interval) as recent_orders,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      (SELECT avg(processing_time) FROM jobs WHERE completed_at &gt; NOW() - &#39;5 minutes&#39;::interval) as avg_job_time</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>active_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;当前活跃用户数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>recent_orders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;最近一小时的订单数&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>avg_job_time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage: GAUGE, description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;平均作业处理时间&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ol start=2><li>测试您的采集器：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_exporter --explain --config<span style=color:#ce5c00;font-weight:700>=</span>/etc/pg_exporter/
</span></span></code></pre></div><h3 id=条件指标>条件指标</h3><p>使用谓词查询实现条件指标：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>partition_metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>desc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;分区表指标&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>predicate_queries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;检查是否使用了分区&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>predicate_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        SELECT EXISTS (
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          SELECT 1 FROM pg_class
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>          WHERE relkind = &#39;p&#39; LIMIT 1
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        )</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    SELECT
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      parent.relname as parent_table,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      count(*) as partition_count,
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      sum(pg_relation_size(child.oid)) as total_size
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    FROM pg_inherits
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    JOIN pg_class parent ON parent.oid = pg_inherits.inhparent
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    JOIN pg_class child ON child.oid = pg_inherits.inhrelid
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    WHERE parent.relkind = &#39;p&#39;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    GROUP BY parent.relname</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ttl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>metrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>parent_table</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>LABEL}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>partition_count</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>GAUGE}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#204a87;font-weight:700>total_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>usage</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>GAUGE}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=性能优化>性能优化</h2><h3 id=查询优化技巧>查询优化技巧</h3><ol><li><p><strong>使用适当的 TTL 值</strong>：</p><ul><li>快速查询：1-10 秒</li><li>中等查询：10-60 秒</li><li>昂贵查询：300-3600 秒</li></ul></li><li><p><strong>设置合理的超时</strong>：</p><ul><li>默认：100ms</li><li>复杂查询：500ms-1s</li><li>生产环境中不要禁用超时</li></ul></li><li><p><strong>使用集群级标签</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>tags</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>cluster] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 每集群运行一次，而不是每数据库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></li><li><p><strong>禁用昂贵的采集器</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_table_bloat</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>skip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 如果不需要则禁用</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></li></ol><h3 id=监控采集器性能>监控采集器性能</h3><p>检查采集器执行统计：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看采集器统计</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/stat
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查哪些采集器较慢</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/metrics <span style=color:#000;font-weight:700>|</span> grep pg_exporter_collector_duration
</span></span></code></pre></div><hr><h2 id=配置故障排查>配置故障排查</h2><h3 id=验证配置>验证配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 干运行 - 显示解析后的配置</span>
</span></span><span style=display:flex><span>pg_exporter --dry-run
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 解释 - 显示计划的查询</span>
</span></span><span style=display:flex><span>pg_exporter --explain
</span></span></code></pre></div><h3 id=常见问题>常见问题</h3><table class=full-width><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>指标缺失</td><td>检查标签和版本兼容性</td></tr><tr><td>抓取缓慢</td><td>增加 TTL、添加超时、禁用昂贵查询</td></tr><tr><td>内存使用高</td><td>减少结果集大小，使用 LIMIT</td></tr><tr><td>权限错误</td><td>验证监控用户的查询权限</td></tr></tbody></table><h3 id=调试日志>调试日志</h3><p>启用调试日志进行故障排查：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_exporter --log.level<span style=color:#ce5c00;font-weight:700>=</span>debug
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-675a152e2a26dbcc46c98b2d6b49d625>4 - API 参考</h1><div class=lead>PG Exporter 的 HTTP API 端点参考</div><p>PG Exporter 提供全面的 REST API，用于指标采集、健康检查、流量路由和运维控制。所有端点都通过配置的端口（默认：9630）以 HTTP 方式暴露。</p><hr><h2 id=端点概览>端点概览</h2><table class=full-width><thead><tr><th>端点</th><th>方法</th><th>描述</th></tr></thead><tbody><tr><td><a href=#get-metrics><code>/metrics</code></a></td><td>GET</td><td>Prometheus 指标端点</td></tr><tr><td><a href=#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5><code>/up</code></a></td><td>GET</td><td>基本存活检查</td></tr><tr><td><a href=#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5><code>/health</code></a></td><td>GET</td><td><code>/up</code> 别名</td></tr><tr><td><a href=#%E6%B5%81%E9%87%8F%E8%B7%AF%E7%94%B1><code>/primary</code></a></td><td>GET</td><td>主库服务器检查</td></tr><tr><td><a href=#%E6%B5%81%E9%87%8F%E8%B7%AF%E7%94%B1><code>/replica</code></a></td><td>GET</td><td>从库服务器检查</td></tr><tr><td><a href=#%E6%B5%81%E9%87%8F%E8%B7%AF%E7%94%B1><code>/read</code></a></td><td>GET</td><td>读流量路由</td></tr><tr><td><a href=#%E8%BF%90%E7%BB%B4%E7%AB%AF%E7%82%B9><code>/reload</code></a></td><td>GET/POST</td><td>重新加载配置</td></tr><tr><td><a href=#%E8%BF%90%E7%BB%B4%E7%AB%AF%E7%82%B9><code>/explain</code></a></td><td>GET</td><td>解释查询规划</td></tr><tr><td><a href=#%E8%BF%90%E7%BB%B4%E7%AB%AF%E7%82%B9><code>/stat</code></a></td><td>GET</td><td>运行时统计</td></tr></tbody></table><hr><h2 id=指标端点>指标端点</h2><h3 id=get-metrics>GET /metrics</h3><p>暴露所有采集指标的主端点，格式为 Prometheus 格式。</p><h4 id=请求>请求</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://localhost:9630/metrics
</span></span></code></pre></div><h4 id=响应>响应</h4><pre tabindex=0><code class=language-prometheus data-lang=prometheus># HELP pg_up PostgreSQL server is up and accepting connections
# TYPE pg_up gauge
pg_up 1

# HELP pg_version PostgreSQL server version number
# TYPE pg_version gauge
pg_version 140000

# HELP pg_in_recovery PostgreSQL server is in recovery mode
# TYPE pg_in_recovery gauge
pg_in_recovery 0

# HELP pg_exporter_build_info PG Exporter build information
# TYPE pg_exporter_build_info gauge
pg_exporter_build_info{version=&#34;1.2.0&#34;,branch=&#34;main&#34;,revision=&#34;&lt;git-sha&gt;&#34;} 1

# ... 更多指标
</code></pre><h4 id=响应格式>响应格式</h4><p>指标遵循 Prometheus 暴露格式：</p><pre tabindex=0><code># HELP &lt;metric_name&gt; &lt;description&gt;
# TYPE &lt;metric_name&gt; &lt;type&gt;
&lt;metric_name&gt;{&lt;label_name&gt;=&#34;&lt;label_value&gt;&#34;,...} &lt;value&gt; &lt;timestamp&gt;
</code></pre><hr><h2 id=健康检查>健康检查</h2><p>健康检查端点提供多种方式来监控 PG Exporter 和目标数据库的状态。</p><h3 id=get-up>GET /up</h3><p>简单的存活检查（基于后台探针缓存状态，不会在每次 HTTP 请求时主动探测数据库）。</p><h4 id=响应码>响应码</h4><table class=full-width><thead><tr><th>状态码</th><th>状态</th><th>描述</th></tr></thead><tbody><tr><td>200</td><td>OK</td><td>目标可用（primary/replica）</td></tr><tr><td>503</td><td>Service Unavailable</td><td>目标不可用（down/starting/unknown）</td></tr></tbody></table><h4 id=示例>示例</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查服务是否正常</span>
</span></span><span style=display:flex><span>curl -I http://localhost:9630/up
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HTTP/1.1 <span style=color:#0000cf;font-weight:700>200</span> OK
</span></span><span style=display:flex><span>Content-Type: text/plain<span style=color:#000;font-weight:700>;</span> <span style=color:#000>charset</span><span style=color:#ce5c00;font-weight:700>=</span>utf-8
</span></span></code></pre></div><h3 id=get-health>GET /health</h3><p><code>/up</code> 的别名，行为相同。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://localhost:9630/health
</span></span></code></pre></div><h3 id=get-liveness>GET /liveness</h3><p>Kubernetes 存活探针端点。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 存活探针配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>livenessProbe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>httpGet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/liveness</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>initialDelaySeconds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>periodSeconds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=get-readiness>GET /readiness</h3><p>Kubernetes 就绪探针端点。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 就绪探针配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>readinessProbe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>httpGet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/readiness</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>initialDelaySeconds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>periodSeconds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=流量路由>流量路由</h2><p>这些端点专为负载均衡器和代理设计，根据服务器角色路由流量。</p><h3 id=get-primary>GET /primary</h3><p>检查服务器是否为主库（primary）实例。</p><h4 id=响应码-1>响应码</h4><table class=full-width><thead><tr><th>状态码</th><th>状态</th><th>描述</th></tr></thead><tbody><tr><td>200</td><td>OK</td><td>服务器是主库且接受写入</td></tr><tr><td>404</td><td>Not Found</td><td>服务器不是主库（是从库）</td></tr><tr><td>503</td><td>Service Unavailable</td><td>服务器不可用（down/starting/unknown）</td></tr></tbody></table><h4 id=别名>别名</h4><ul><li><code>/leader</code></li><li><code>/master</code></li><li><code>/read-write</code></li><li><code>/rw</code></li></ul><h4 id=示例-1>示例</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查服务器是否为主库</span>
</span></span><span style=display:flex><span>curl -I http://localhost:9630/primary
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在 HAProxy 配置中使用</span>
</span></span><span style=display:flex><span>backend pg_primary
</span></span><span style=display:flex><span>  option httpchk GET /primary
</span></span><span style=display:flex><span>  server pg1 10.0.0.1:5432 check port <span style=color:#0000cf;font-weight:700>9630</span>
</span></span><span style=display:flex><span>  server pg2 10.0.0.2:5432 check port <span style=color:#0000cf;font-weight:700>9630</span>
</span></span></code></pre></div><h3 id=get-replica>GET /replica</h3><p>检查服务器是否为从库（standby）实例。</p><h4 id=响应码-2>响应码</h4><table class=full-width><thead><tr><th>状态码</th><th>状态</th><th>描述</th></tr></thead><tbody><tr><td>200</td><td>OK</td><td>服务器是从库且处于恢复状态</td></tr><tr><td>404</td><td>Not Found</td><td>服务器不是从库（是主库）</td></tr><tr><td>503</td><td>Service Unavailable</td><td>服务器不可用（down/starting/unknown）</td></tr></tbody></table><h4 id=别名-1>别名</h4><ul><li><code>/standby</code></li><li><code>/read-only</code></li><li><code>/ro</code></li></ul><p><code>/slave</code> 仍兼容，但建议优先使用 <code>/replica</code>。</p><h4 id=示例-2>示例</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查服务器是否为从库</span>
</span></span><span style=display:flex><span>curl -I http://localhost:9630/replica
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在负载均衡器配置中使用</span>
</span></span><span style=display:flex><span>backend pg_replicas
</span></span><span style=display:flex><span>  option httpchk GET /replica
</span></span><span style=display:flex><span>  server pg2 10.0.0.2:5432 check port <span style=color:#0000cf;font-weight:700>9630</span>
</span></span><span style=display:flex><span>  server pg3 10.0.0.3:5432 check port <span style=color:#0000cf;font-weight:700>9630</span>
</span></span></code></pre></div><h3 id=get-read>GET /read</h3><p>检查服务器是否可以处理读流量（主库和从库都可以）。</p><h4 id=响应码-3>响应码</h4><table class=full-width><thead><tr><th>状态码</th><th>状态</th><th>描述</th></tr></thead><tbody><tr><td>200</td><td>OK</td><td>服务器正常运行且可以处理读请求</td></tr><tr><td>503</td><td>Service Unavailable</td><td>服务器不可用（down/starting/unknown）</td></tr></tbody></table><h4 id=示例-3>示例</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查服务器是否可以处理读请求</span>
</span></span><span style=display:flex><span>curl -I http://localhost:9630/read
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 将读流量路由到任何可用服务器</span>
</span></span><span style=display:flex><span>backend pg_read
</span></span><span style=display:flex><span>  option httpchk GET /read
</span></span><span style=display:flex><span>  server pg1 10.0.0.1:5432 check port <span style=color:#0000cf;font-weight:700>9630</span>
</span></span><span style=display:flex><span>  server pg2 10.0.0.2:5432 check port <span style=color:#0000cf;font-weight:700>9630</span>
</span></span><span style=display:flex><span>  server pg3 10.0.0.3:5432 check port <span style=color:#0000cf;font-weight:700>9630</span>
</span></span></code></pre></div><hr><h2 id=运维端点>运维端点</h2><h3 id=get-reload--post-reload>GET /reload / POST /reload</h3><p>在不重启导出器的情况下重新加载配置。</p><h4 id=请求-1>请求</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 推荐 POST</span>
</span></span><span style=display:flex><span>curl -X POST http://localhost:9630/reload
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 兼容 GET</span>
</span></span><span style=display:flex><span>curl http://localhost:9630/reload
</span></span></code></pre></div><h4 id=响应-1>响应</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>server reloaded
</span></span></code></pre></div><h4 id=响应码-4>响应码</h4><table class=full-width><thead><tr><th>状态码</th><th>状态</th><th>描述</th></tr></thead><tbody><tr><td>200</td><td>OK</td><td>配置重新加载成功</td></tr><tr><td>500</td><td>Internal Server Error</td><td>重新加载失败（返回 <code>fail to reload: ...</code>）</td></tr><tr><td>405</td><td>Method Not Allowed</td><td>非 GET/POST 方法（<code>Allow: GET, POST</code>）</td></tr></tbody></table><h4 id=使用场景>使用场景</h4><ul><li>更新采集器定义</li><li>更改查询参数</li><li>修改缓存 TTL 值</li><li>添加或移除采集器</li></ul><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>注意</div><p>重载会刷新采集器配置和查询计划；如需修改进程级参数（例如监听地址、CLI 参数），仍需重启导出器。</p></div><h3 id=get-explain>GET /explain</h3><p>显示所有已配置采集器的查询执行规划信息。</p><h4 id=请求-2>请求</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://localhost:9630/explain
</span></span></code></pre></div><h4 id=响应-2>响应</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Collector: pg_stat_database
</span></span><span style=display:flex><span>  Query: SELECT datname, numbackends FROM pg_stat_database
</span></span><span style=display:flex><span>  Tags: [cluster]
</span></span><span style=display:flex><span>  TTL: 10s
</span></span><span style=display:flex><span>  Timeout: 100ms
</span></span><span style=display:flex><span>  Version: 100000-999999
</span></span><span style=display:flex><span>  Status: Active
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Collector: pg_stat_replication
</span></span><span style=display:flex><span>  Query: SELECT client_addr, state FROM pg_stat_replication
</span></span><span style=display:flex><span>  Tags: [primary]
</span></span><span style=display:flex><span>  TTL: 5s
</span></span><span style=display:flex><span>  Timeout: 100ms
</span></span><span style=display:flex><span>  Version: 100000-999999
</span></span><span style=display:flex><span>  Status: Active (primary only)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h3 id=get-stat>GET /stat</h3><p>显示运行时统计信息，包括采集器执行时间和成功/失败计数。</p><h4 id=请求-3>请求</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl http://localhost:9630/stat
</span></span></code></pre></div><h4 id=响应-3>响应</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>Collector Statistics:
</span></span><span style=display:flex><span>  pg_stat_database:
</span></span><span style=display:flex><span>    Executions: 1234
</span></span><span style=display:flex><span>    Successes: 1230
</span></span><span style=display:flex><span>    Failures: 4
</span></span><span style=display:flex><span>    Avg Duration: 2.5ms
</span></span><span style=display:flex><span>    Last Execution: 2024-01-15T10:29:55Z
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  pg_stat_activity:
</span></span><span style=display:flex><span>    Executions: 1234
</span></span><span style=display:flex><span>    Successes: 1234
</span></span><span style=display:flex><span>    Failures: 0
</span></span><span style=display:flex><span>    Avg Duration: 1.2ms
</span></span><span style=display:flex><span>    Last Execution: 2024-01-15T10:29:55Z
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><p>此端点对于识别慢速或有问题的采集器非常有用。</p><hr><h2 id=在负载均衡器中使用>在负载均衡器中使用</h2><h3 id=haproxy-配置示例>HAProxy 配置示例</h3><pre tabindex=0><code class=language-haproxy data-lang=haproxy># 主库后端 - 用于写流量
backend pg_primary
  mode tcp
  option httpchk GET /primary
  http-check expect status 200
  server pg1 10.0.0.1:5432 check port 9630 inter 3000 fall 2 rise 2
  server pg2 10.0.0.2:5432 check port 9630 inter 3000 fall 2 rise 2 backup

# 从库后端 - 用于读流量
backend pg_replicas
  mode tcp
  balance roundrobin
  option httpchk GET /replica
  http-check expect status 200
  server pg2 10.0.0.2:5432 check port 9630 inter 3000 fall 2 rise 2
  server pg3 10.0.0.3:5432 check port 9630 inter 3000 fall 2 rise 2

# 读后端 - 用于任何可以处理读请求的服务器
backend pg_read
  mode tcp
  balance leastconn
  option httpchk GET /read
  http-check expect status 200
  server pg1 10.0.0.1:5432 check port 9630 inter 3000 fall 2 rise 2
  server pg2 10.0.0.2:5432 check port 9630 inter 3000 fall 2 rise 2
  server pg3 10.0.0.3:5432 check port 9630 inter 3000 fall 2 rise 2
</code></pre><h3 id=nginx-配置示例>Nginx 配置示例</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=display:flex><span><span style=color:#204a87;font-weight:700>upstream</span> <span style=color:#4e9a06>pg_primary</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>server</span> <span style=color:#000>10.0.0.1</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>server</span> <span style=color:#000>10.0.0.2</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#4e9a06>backup</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>upstream</span> <span style=color:#4e9a06>pg_replicas</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>server</span> <span style=color:#000>10.0.0.2</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>server</span> <span style=color:#000>10.0.0.3</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>server</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>listen</span> <span style=color:#0000cf;font-weight:700>5432</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>location</span> <span style=color:#4e9a06>/</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>proxy_pass</span> <span style=color:#4e9a06>http://pg_primary</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>health_check</span> <span style=color:#4e9a06>uri=/primary</span> <span style=color:#4e9a06>port=9630</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-403a539868ecb0c6cbcc02f03ee09c43>5 - 部署指南</h1><div class=lead>生产环境部署策略与最佳实践</div><p>本指南涵盖生产环境的部署策略、最佳实践和实际配置。</p><p>pg_exporter 本身可以通过以下方式配置：</p><ol><li><strong>命令行参数</strong>（优先级较高）</li><li><strong>环境变量</strong>（优先级较低）</li></ol><p>指标采集器通过 YAML 配置文件（目录/文件）进行配置：</p><ul><li><code>/etc/pg_exporter.yml</code>（默认）</li><li><code>/etc/pg_exporter/</code>（包含多个文件的目录）</li></ul><p>配置文件使用 YAML 格式，由 <strong>采集器定义</strong> 组成，指定要采集的指标以及如何采集。</p><hr><h2 id=部署设计逻辑>部署设计逻辑</h2><p><code>pg_exporter</code> 在生产环境中的关键设计取舍如下：</p><ul><li>本地优先：默认 URL 为 <code>postgresql:///?sslmode=disable</code>，适配同机部署</li><li>先可观测后可连接：默认非阻塞启动，目标库暂时不可达时也先暴露 HTTP 端点</li><li>可控失败策略：设置 <code>--fail-fast</code> 后，启动阶段目标不可达会直接失败退出</li><li>在线变更：支持 <code>POST/GET /reload</code> 与 <code>SIGHUP</code> 触发热重载（非 Windows 额外支持 <code>SIGUSR1</code>）</li><li>健康探针解耦：<code>/up</code> 等端点基于后台探测缓存，避免探针风暴影响数据库</li></ul><hr><h2 id=命令行参数>命令行参数</h2><p>所有配置选项都可以通过命令行标志指定：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_exporter <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --url<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;postgres://user:pass@localhost:5432/postgres&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --config<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/etc/pg_exporter/pg_exporter.yml&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --web.listen-address<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;:9630&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --auto-discovery <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --exclude-database<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;template0,template1&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --log.level<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;info&#34;</span>
</span></span></code></pre></div><p>运行 <code>pg_exporter --help</code> 获取完整的可用标志列表：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Flags:
</span></span><span style=display:flex><span>  -h, --<span style=color:#ce5c00;font-weight:700>[</span>no-<span style=color:#ce5c00;font-weight:700>]</span><span style=color:#204a87>help</span>                显示上下文相关帮助（也可尝试 --help-long 和 --help-man）。
</span></span><span style=display:flex><span>  -u, --url<span style=color:#ce5c00;font-weight:700>=</span>URL                  postgres 目标 URL
</span></span><span style=display:flex><span>  -c, --config<span style=color:#ce5c00;font-weight:700>=</span>CONFIG            配置目录或文件路径
</span></span><span style=display:flex><span>      --<span style=color:#ce5c00;font-weight:700>[</span>no-<span style=color:#ce5c00;font-weight:700>]</span>web.systemd-socket  使用 systemd socket 激活监听器代替端口监听器（仅限 Linux）。
</span></span><span style=display:flex><span>      --web.listen-address<span style=color:#ce5c00;font-weight:700>=</span>:9630 ...
</span></span><span style=display:flex><span>                                 暴露指标和 Web 界面的地址。可重复指定多个地址。示例：<span style=color:#4e9a06>`</span>:9100<span style=color:#4e9a06>`</span> 或 <span style=color:#4e9a06>`</span><span style=color:#ce5c00;font-weight:700>[</span>::1<span style=color:#ce5c00;font-weight:700>]</span>:9100<span style=color:#4e9a06>`</span> 用于 http，<span style=color:#4e9a06>`</span>vsock://:9100<span style=color:#4e9a06>`</span> 用于 vsock
</span></span><span style=display:flex><span>      --web.config.file<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>       可启用 TLS 或认证的配置文件路径。参见：https://github.com/prometheus/exporter-toolkit/blob/master/docs/web-configuration.md
</span></span><span style=display:flex><span>  -l, --label<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>                 常量标签：逗号分隔的 <span style=color:#000>label</span><span style=color:#ce5c00;font-weight:700>=</span>value 对列表 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_LABEL</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -t, --tag<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>                   标签，逗号分隔的服务器标签列表 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_TAG</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -C, --<span style=color:#ce5c00;font-weight:700>[</span>no-<span style=color:#ce5c00;font-weight:700>]</span>disable-cache       强制不使用缓存 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_DISABLE_CACHE</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -m, --<span style=color:#ce5c00;font-weight:700>[</span>no-<span style=color:#ce5c00;font-weight:700>]</span>disable-intro       禁用导出器内置/自监控指标，仅保留查询指标 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_DISABLE_INTRO</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -a, --<span style=color:#ce5c00;font-weight:700>[</span>no-<span style=color:#ce5c00;font-weight:700>]</span>auto-discovery      自动抓取给定服务器的所有数据库 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_AUTO_DISCOVERY</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -x, --exclude-database<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;template0,template1,postgres&#34;</span>
</span></span><span style=display:flex><span>                                 启用自动发现时排除的数据库 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_EXCLUDE_DATABASE</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -i, --include-database<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>      启用自动发现时包含的数据库 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_INCLUDE_DATABASE</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -n, --namespace<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>             内置指标的前缀，默认为 <span style=color:#ce5c00;font-weight:700>(</span>pg<span style=color:#000;font-weight:700>|</span>pgbouncer<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_NAMESPACE</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -f, --<span style=color:#ce5c00;font-weight:700>[</span>no-<span style=color:#ce5c00;font-weight:700>]</span>fail-fast           启动时立即失败而不是等待 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_FAIL_FAST</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -T, --connect-timeout<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100</span>      连接超时（毫秒），默认 <span style=color:#0000cf;font-weight:700>100</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_CONNECT_TIMEOUT</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -P, --web.telemetry-path<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/metrics&#34;</span>
</span></span><span style=display:flex><span>                                 暴露指标的 URL 路径 <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$PG_EXPORTER_TELEMETRY_PATH</span><span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>  -D, --<span style=color:#ce5c00;font-weight:700>[</span>no-<span style=color:#ce5c00;font-weight:700>]</span>dry-run             干运行并打印原始配置
</span></span><span style=display:flex><span>  -E, --<span style=color:#ce5c00;font-weight:700>[</span>no-<span style=color:#ce5c00;font-weight:700>]</span>explain             解释服务器计划的查询
</span></span><span style=display:flex><span>      --log.level<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;info&#34;</span>         日志级别：debug<span style=color:#000;font-weight:700>|</span>info<span style=color:#000;font-weight:700>|</span>warn<span style=color:#000;font-weight:700>|</span>error<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>      --log.format<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;logfmt&#34;</span>      日志格式：logfmt<span style=color:#000;font-weight:700>|</span>json
</span></span><span style=display:flex><span>      --<span style=color:#ce5c00;font-weight:700>[</span>no-<span style=color:#ce5c00;font-weight:700>]</span>version             显示应用程序版本
</span></span></code></pre></div><hr><h2 id=环境变量>环境变量</h2><p>所有命令行参数都有对应的环境变量：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;postgresql:///?sslmode=disable&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_CONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/pg_exporter.yml
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_LABEL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_TAG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_DISABLE_CACHE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_AUTO_DISCOVERY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_EXCLUDE_DATABASE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;template0,template1,postgres&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_INCLUDE_DATABASE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_NAMESPACE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;pg&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_FAIL_FAST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_CONNECT_TIMEOUT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_TELEMETRY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/metrics&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--log.level=info&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg_exporter
</span></span></code></pre></div><p>除 <code>PG_EXPORTER_URL</code> 外，还支持：</p><ul><li><code>PGURL</code>：作为连接 URL 的兼容环境变量</li><li><code>PG_EXPORTER_URL_FILE</code>：从文件中读取连接 URL（适合容器 Secret）</li></ul><hr><h2 id=部署架构>部署架构</h2><p>最简单的部署方式是每个 PostgreSQL 实例配置一个导出器：</p><pre tabindex=0><code>┌─────────────┐     ┌──────────────┐     ┌────────────┐
│ Prometheus  │────▶│ PG Exporter  │────▶│ PostgreSQL │
└─────────────┘     └──────────────┘     └────────────┘
                         :9630                :5432
</code></pre><h3 id=多数据库环境>多数据库环境</h3><p>使用自动发现来监控多个数据库（默认启用）：</p><pre tabindex=0><code>┌─────────────┐     ┌────────────────┐     ┌────────────┐
│ Prometheus  │────▶│ PG Exporter    │────▶│ PostgreSQL │
└─────────────┘     │   启用自动发现  │     │  ├─ db1    │
                    │                │     │  ├─ db2    │
                    └────────────────┘     │  └─ db3    │
                                           └────────────┘
</code></pre><hr><h2 id=生产配置>生产配置</h2><h3 id=postgresql-用户设置>PostgreSQL 用户设置</h3><p>创建一个具有最小必要权限的专用监控用户：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 创建监控角色
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8> </span><span style=color:#000>LOGIN</span><span style=color:#f8f8f8> </span><span style=color:#000>PASSWORD</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;strong_password&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 授予必要权限
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- PostgreSQL 10+ 内置角色
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对于特定数据库
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>app_db</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USAGE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 扩展监控的额外权限
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#000>TABLES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_catalog</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#000>SEQUENCES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_catalog</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h3 id=连接安全>连接安全</h3><h4 id=使用-ssltls>使用 SSL/TLS</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 带 SSL 的连接字符串</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;postgres://monitor:password@db.example.com:5432/postgres?sslmode=require&amp;sslcert=/path/to/client.crt&amp;sslkey=/path/to/client.key&amp;sslrootcert=/path/to/ca.crt&#39;</span>
</span></span></code></pre></div><h4 id=使用-pgpass-文件>使用 .pgpass 文件</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建 .pgpass 文件</span>
</span></span><span style=display:flex><span><span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;db.example.com:5432:*:monitor:password&#34;</span> &gt; ~/.pgpass
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>600</span> ~/.pgpass
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在 URL 中不使用密码</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;postgres://monitor@db.example.com:5432/postgres&#39;</span>
</span></span></code></pre></div><hr><h2 id=systemd-服务配置>Systemd 服务配置</h2><p>完整的生产环境 systemd 设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Description</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>Prometheus exporter for PostgreSQL/Pgbouncer server metrics</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Documentation</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>https://github.com/pgsty/pg_exporter</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>After</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>network.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>EnvironmentFile</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>-/etc/default/pg_exporter</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>User</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>prometheus</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>ExecStart</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>/usr/bin/pg_exporter $PG_EXPORTER_OPTS</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>Restart</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>on-failure</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>WantedBy</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>multi-user.target</span>
</span></span></code></pre></div><p>环境文件 <code>/etc/default/pg_exporter</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;postgresql:///?sslmode=disable&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_CONFIG</span><span style=color:#ce5c00;font-weight:700>=</span>/etc/pg_exporter.yml
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_LABEL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_TAG</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_DISABLE_CACHE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_AUTO_DISCOVERY</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_EXCLUDE_DATABASE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;template0,template1,postgres&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_INCLUDE_DATABASE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_NAMESPACE</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;pg&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_FAIL_FAST</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_CONNECT_TIMEOUT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_TELEMETRY_PATH</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/metrics&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--log.level=info&#39;</span>
</span></span></code></pre></div><hr><h2 id=服务管理>服务管理</h2><h3 id=启动和停止服务>启动和停止服务</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 启动服务</span>
</span></span><span style=display:flex><span>sudo systemctl start pg_exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 停止服务</span>
</span></span><span style=display:flex><span>sudo systemctl stop pg_exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重启服务</span>
</span></span><span style=display:flex><span>sudo systemctl restart pg_exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看服务状态</span>
</span></span><span style=display:flex><span>sudo systemctl status pg_exporter
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 设置开机自启</span>
</span></span><span style=display:flex><span>sudo systemctl <span style=color:#204a87>enable</span> pg_exporter
</span></span></code></pre></div><h3 id=查看日志>查看日志</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 实时查看日志</span>
</span></span><span style=display:flex><span>journalctl -u pg_exporter -f
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看最近的日志</span>
</span></span><span style=display:flex><span>journalctl -u pg_exporter --since <span style=color:#4e9a06>&#34;1 hour ago&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看错误日志</span>
</span></span><span style=display:flex><span>journalctl -u pg_exporter -p err
</span></span></code></pre></div><hr><h2 id=docker-部署>Docker 部署</h2><h3 id=基本-docker-运行>基本 Docker 运行</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker run -d <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --name pg_exporter <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --restart unless-stopped <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -p 9630:9630 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>PG_EXPORTER_URL</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;postgres://user:pass@host:5432/postgres&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  pgsty/pg_exporter:latest
</span></span></code></pre></div><h3 id=docker-compose>Docker Compose</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;3.8&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pg_exporter</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsty/pg_exporter:latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>container_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>restart</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>unless-stopped</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#34;9630:9630&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>environment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>PG_EXPORTER_URL=postgres://monitor:password@postgres:5432/postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>PG_EXPORTER_AUTO_DISCOVERY=true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>PG_EXPORTER_EXCLUDE_DATABASE=template0,template1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>volumes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>./pg_exporter.yml:/etc/pg_exporter.yml:ro</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>depends_on</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>postgres</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=kubernetes-部署>Kubernetes 部署</h2><h3 id=deployment-示例>Deployment 示例</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>apps/v1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Deployment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replicas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>matchLabels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>prometheus.io/scrape</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>prometheus.io/port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;9630&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>containers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>image</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsty/pg_exporter:latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span>- <span style=color:#204a87;font-weight:700>containerPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>env</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>PG_EXPORTER_URL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>valueFrom</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>secretKeyRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>              </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-credentials</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>              </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>connection-url</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>PG_EXPORTER_AUTO_DISCOVERY</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>value</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>livenessProbe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>httpGet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/liveness</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>initialDelaySeconds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>periodSeconds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>readinessProbe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>httpGet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/readiness</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>initialDelaySeconds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>periodSeconds</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>resources</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>limits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>200m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>256Mi</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>requests</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>cpu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>100m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>memory</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128Mi</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=service-示例>Service 示例</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>v1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Service</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ports</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>targetPort</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>metrics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-exporter</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=prometheus-配置>Prometheus 配置</h2><h3 id=静态配置>静态配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>scrape_configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>job_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgresql&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>static_configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>targets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span>- <span style=color:#4e9a06>&#39;pg-exporter-1:9630&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span>- <span style=color:#4e9a06>&#39;pg-exporter-2:9630&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span>- <span style=color:#4e9a06>&#39;pg-exporter-3:9630&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=服务发现>服务发现</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>scrape_configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>job_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgresql&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>kubernetes_sd_configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pod</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>relabel_configs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>source_labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>__meta_kubernetes_pod_label_app]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>regex</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>action</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>keep</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>source_labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>__meta_kubernetes_pod_ip]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>target_label</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>__address__</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>replacement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>${1}:9630</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=监控与告警>监控与告警</h2><h3 id=推荐的告警规则>推荐的告警规则</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>groups</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 导出器宕机告警</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>alert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>PgExporterDown</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>up{job=&#34;postgresql&#34;} == 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>5m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>severity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>critical</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>summary</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;PG Exporter 宕机&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ $labels.instance }} 的 PG Exporter 已宕机超过 5 分钟&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 数据库连接失败告警</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>alert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>PostgreSQLDown</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_up == 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>severity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>critical</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>summary</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;PostgreSQL 连接失败&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;无法连接到 {{ $labels.instance }} 上的 PostgreSQL&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 抓取时间过长告警</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>alert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>PgExporterSlowScrape</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>expr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_exporter_scrape_duration &gt; 30</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>5m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>severity</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>warning</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>summary</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;PG Exporter 抓取缓慢&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>description</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ $labels.instance }} 的抓取时间超过 30 秒&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-6422ba42493572f811549fcad2c81178>6 - 发布注记</h1><div class=lead>PG Exporter 版本发布历史</div><p><code>pg_exporter</code> 的最新稳定版本是 <a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.2.0>v1.2.0</a></p><table class=full-width><thead><tr><th style=text-align:center>版本</th><th style=text-align:center>日期</th><th>摘要</th><th style=text-align:center>GitHub</th></tr></thead><tbody><tr><td style=text-align:center><a href=#v120>v1.2.0</a></td><td style=text-align:center>2026-02-12</td><td>热重载与非阻塞启动，新增 PG9.1-9.6 legacy 支持</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.2.0>v1.2.0</a></td></tr><tr><td style=text-align:center><a href=#v112>v1.1.2</a></td><td style=text-align:center>2026-01-16</td><td>修复 pg_timeline 配置问题，使用最新依赖构建</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.1.2>v1.1.2</a></td></tr><tr><td style=text-align:center><a href=#v111>v1.1.1</a></td><td style=text-align:center>2025-12-30</td><td>新增 pg_timeline 采集器，pg_sub_16 分支，Bug 修复</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.1.1>v1.1.1</a></td></tr><tr><td style=text-align:center><a href=#v110>v1.1.0</a></td><td style=text-align:center>2025-12-15</td><td>更新默认指标采集器，升级到 Go 1.25.5</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.1.0>v1.1.0</a></td></tr><tr><td style=text-align:center><a href=#v103>v1.0.3</a></td><td style=text-align:center>2025-11-20</td><td>例行更新到 1.25.4，修复不支持的 libpq 环境变量</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.0.3>v1.0.3</a></td></tr><tr><td style=text-align:center><a href=#v102>v1.0.2</a></td><td style=text-align:center>2025-08-14</td><td>使用 goreleaser 构建更多操作系统架构</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.0.2>v1.0.2</a></td></tr><tr><td style=text-align:center><a href=#v101>v1.0.1</a></td><td style=text-align:center>2025-07-17</td><td>DockerHub 镜像，Go 1.24.5，禁用 pg_tsdb_hypertable</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.0.1>v1.0.1</a></td></tr><tr><td style=text-align:center><a href=#v100>v1.0.0</a></td><td style=text-align:center>2025-05-06</td><td>PostgreSQL 18 支持，新增 WAL/检查点/I/O 指标</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.0.0>v1.0.0</a></td></tr><tr><td style=text-align:center><a href=#v090>v0.9.0</a></td><td style=text-align:center>2025-04-26</td><td>TimescaleDB、Citus、pg_wait_sampling 采集器</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.9.0>v0.9.0</a></td></tr><tr><td style=text-align:center><a href=#v081>v0.8.1</a></td><td style=text-align:center>2025-02-14</td><td>依赖更新，Docker 镜像标签</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.8.1>v0.8.1</a></td></tr><tr><td style=text-align:center><a href=#v080>v0.8.0</a></td><td style=text-align:center>2025-02-14</td><td>PgBouncer 1.24 支持，Go 1.24，日志重构</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.8.0>v0.8.0</a></td></tr><tr><td style=text-align:center><a href=#v071>v0.7.1</a></td><td style=text-align:center>2024-12-29</td><td>例行更新，支持 Reader 配置</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.7.1>v0.7.1</a></td></tr><tr><td style=text-align:center><a href=#v070>v0.7.0</a></td><td style=text-align:center>2024-08-13</td><td>PostgreSQL 17 支持，谓词查询功能</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.7.0>v0.7.0</a></td></tr><tr><td style=text-align:center><a href=#v060>v0.6.0</a></td><td style=text-align:center>2023-10-18</td><td>PostgreSQL 16 支持，ARM64 包，安全修复</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.6.0>v0.6.0</a></td></tr><tr><td style=text-align:center><a href=#v050>v0.5.0</a></td><td style=text-align:center>2022-04-27</td><td>RPM/DEB 构建，列缩放，指标增强</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.5.0>v0.5.0</a></td></tr><tr><td style=text-align:center><a href=#v041>v0.4.1</a></td><td style=text-align:center>2022-03-08</td><td>采集器更新，connect-timeout 参数</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.4.1>v0.4.1</a></td></tr><tr><td style=text-align:center><a href=#v040>v0.4.0</a></td><td style=text-align:center>2021-07-12</td><td>PostgreSQL 14 支持，自动发现功能</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.4.0>v0.4.0</a></td></tr><tr><td style=text-align:center><a href=#v032>v0.3.2</a></td><td style=text-align:center>2021-02-01</td><td>Shadow DSN 修复，文档更新</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.3.2>v0.3.2</a></td></tr><tr><td style=text-align:center><a href=#v031>v0.3.1</a></td><td style=text-align:center>2020-12-04</td><td>旧版 PostgreSQL 配置修复</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.3.1>v0.3.1</a></td></tr><tr><td style=text-align:center><a href=#v030>v0.3.0</a></td><td style=text-align:center>2020-10-29</td><td>PostgreSQL 13 支持，REST API，虚拟服务器</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.3.0>v0.3.0</a></td></tr><tr><td style=text-align:center><a href=#v020>v0.2.0</a></td><td style=text-align:center>2020-03-21</td><td>YUM 包，配置重载支持</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.2.0>v0.2.0</a></td></tr><tr><td style=text-align:center><a href=#v012>v0.1.2</a></td><td style=text-align:center>2020-02-20</td><td>动态配置重载，批量模式</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.1.2>v0.1.2</a></td></tr><tr><td style=text-align:center><a href=#v011>v0.1.1</a></td><td style=text-align:center>2020-01-10</td><td>启动挂起 Bug 修复</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.1.1>v0.1.1</a></td></tr><tr><td style=text-align:center><a href=#v010>v0.1.0</a></td><td style=text-align:center>2020-01-08</td><td>首个稳定版本</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.1.0>v0.1.0</a></td></tr><tr><td style=text-align:center><a href=#v004>v0.0.4</a></td><td style=text-align:center>2019-12-20</td><td>生产环境测试版本</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.0.4>v0.0.4</a></td></tr><tr><td style=text-align:center><a href=#v003>v0.0.3</a></td><td style=text-align:center>2019-12-14</td><td>生产环境测试</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.0.3>v0.0.3</a></td></tr><tr><td style=text-align:center><a href=#v002>v0.0.2</a></td><td style=text-align:center>2019-12-09</td><td>早期测试版本</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.0.2>v0.0.2</a></td></tr><tr><td style=text-align:center><a href=#v001>v0.0.1</a></td><td style=text-align:center>2019-12-06</td><td>初始版本，支持 PgBouncer 模式</td><td style=text-align:center><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.0.1>v0.0.1</a></td></tr></tbody></table><hr><h2 id=v120>v1.2.0</h2><p><code>v1.2.0</code> 是一次聚焦稳定性与兼容性的中版本更新，覆盖启动流程、热重载、健康检查、配置校验与 Legacy 支持。</p><p><strong>新功能：</strong></p><ul><li>支持配置热重载：新增平台相关的信号重载（<code>SIGHUP</code> / <code>SIGUSR1</code>），并强化 <code>POST /reload</code> 工作流，可在不重启进程情况下更新配置与查询计划</li><li>启动流程改为非阻塞：即使目标库预检失败，也会先启动 HTTP 服务，便于监控系统先接入后恢复</li><li>新增 PostgreSQL 9.1-9.6 Legacy 配置套件：提供 <code>legacy/</code> 配置目录与 <code>make conf9</code> 目标，便于 EOL 老版本平滑接入</li><li>健康检查机制重构：引入缓存健康快照与周期探测，读写角色类健康端点行为更一致，重载期间更平滑</li><li>工程链路增强：Release 工作流增加 <code>go test</code> 与 <code>go vet</code>，并升级构建链到 Go 1.26.0</li></ul><p><strong>Bug 修复：</strong></p><ul><li>修复多处配置解析边界问题：拒绝非法 metrics 定义、无效目录加载失败场景可正确报错，并补齐运行时回退逻辑</li><li>修复命令行布尔参数解析：正确处理 <code>--flag=false</code> 风格传参，避免被误判为启用</li><li>修复 <code>/explain</code> 输出与渲染安全性：调整内容类型并改用更安全的模板渲染路径</li><li>修复谓词查询与连接 URL 处理细节：增强 BOOL/BOOLEAN 条件支持、完善 <code>dbname</code> 查询参数解析与 URL 脱敏输出</li><li>修复自动发现目标移除时的资源释放行为：异步关闭已移除数据库连接，降低采集阻塞风险</li><li>修复指标与标签校验细节：补齐常量标签冲突检查、默认值缩放处理与若干 Prometheus 规则校验</li></ul><p><strong>校验和</strong></p><p>（待补充）</p><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.2.0>https://github.com/pgsty/pg_exporter/releases/tag/v1.2.0</a></p><hr><h2 id=v112>v1.1.2</h2><p>小版本更新，修复 pg_timeline 配置问题，使用最新 Go 依赖构建。</p><p><strong>校验和</strong></p><p><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.1.2/checksums.txt>https://github.com/pgsty/pg_exporter/releases/download/v1.1.2/checksums.txt</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>8cddd57a843914a3145a80a3220bc875047b9bcac0664357c01ba86485436236  pg-exporter_1.1.2-1_amd64.deb
</span></span><span style=display:flex><span>f5b25a8ae5c022867a54c17ba1c6493eba20dcb292340460390289336df24f04  pg-exporter_1.1.2-1_arm64.deb
</span></span><span style=display:flex><span>4da2c287f6717681b25befda0d59a89b9d1b258281ce94f3a6bc21d02f70c83c  pg-exporter_1.1.2-1_ppc64le.deb
</span></span><span style=display:flex><span>b26355f3c1a5b8a147291a51e2d7ada204deed6d52877c146a8b3e499defa5e8  pg_exporter-1.1.2-1.aarch64.rpm
</span></span><span style=display:flex><span>42ef89716ba99dd918b0e9c77ef3236129d613f68bb8ae5929668a5a2596cca5  pg_exporter-1.1.2-1.ppc64le.rpm
</span></span><span style=display:flex><span>a8f4a2d5c7b6701c7bac788a7ed7183b6c4b74a334326cd389f3a695fb77675d  pg_exporter-1.1.2-1.x86_64.rpm
</span></span><span style=display:flex><span>775f5ea3188a6acb1327c001c4ba9a0651424c3bb37d800e6f67972c904c4750  pg_exporter-1.1.2.darwin-amd64.tar.gz
</span></span><span style=display:flex><span>7f2bbcc2db1e16dc78c3edd8e67e20e4ec81f2972c8c37135cba6f6afbf91003  pg_exporter-1.1.2.darwin-arm64.tar.gz
</span></span><span style=display:flex><span>33c34b1f9ef6b6e7615f241a95059a8137a2337a454930b668180a9329d12b98  pg_exporter-1.1.2.linux-amd64.tar.gz
</span></span><span style=display:flex><span>2b91a5818d780e38692ab6446cacb496695e67388676c18012be582e8ddfbdd8  pg_exporter-1.1.2.linux-arm64.tar.gz
</span></span><span style=display:flex><span>adcb5f229f4a5d641f6430b9a2dfb0377a2e4310efad242730867d6cdf5e27ee  pg_exporter-1.1.2.linux-ppc64le.tar.gz
</span></span><span style=display:flex><span>90b7c7e4b2b94936b5faa3cf2d35509b62ebc0d60b3afe1abaaf03efcd415a4a  pg_exporter-1.1.2.windows-amd64.tar.gz
</span></span></code></pre></div><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.1.2>https://github.com/pgsty/pg_exporter/releases/tag/v1.1.2</a></p><hr><h2 id=v111>v1.1.1</h2><p>小版本更新，新增采集器和 Bug 修复。</p><p><strong>新功能：</strong></p><ul><li>新增 <code>pg_timeline</code> 采集器，用于时间线监控</li><li>新增 <code>pg_sub_16</code> 采集器分支，排除订阅中的并行操作（PostgreSQL 16+ 兼容性）</li></ul><p><strong>Bug 修复：</strong></p><ul><li>修复：为 <code>pg_recv</code> 采集器的 slotname 添加 coalesce 以处理 NULL 值</li></ul><p><strong>校验和</strong></p><p><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.1.1/checksums.txt>https://github.com/pgsty/pg_exporter/releases/download/v1.1.1/checksums.txt</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>fd5ee96511676fc11b975115a4870ed0c811056519f79ad7f24ab7ec538fa278  pg-exporter_1.1.1-1_amd64.deb
</span></span><span style=display:flex><span>b90a08d16a6e4707d82f8f3ae282cb76acb331de607e7544532fd0b774b7aa27  pg-exporter_1.1.1-1_arm64.deb
</span></span><span style=display:flex><span>163955f59a71da48901ffa26bb2f2db0712d31d8aeb1ab3fa463683f719a6d3a  pg-exporter_1.1.1-1_ppc64le.deb
</span></span><span style=display:flex><span>cf4f8bc12bb8a2d1e55553f891fd31c43324e4348249727972eb44f82cd4e6c8  pg_exporter-1.1.1-1.aarch64.rpm
</span></span><span style=display:flex><span>5a425b2f61f308b32f2d107372830c34eb685bfb312ee787f11877a20f1c4a2e  pg_exporter-1.1.1-1.ppc64le.rpm
</span></span><span style=display:flex><span>23606ccea565368971ac2e7f39766455b507021f09457bcf61db13cb10501a16  pg_exporter-1.1.1-1.x86_64.rpm
</span></span><span style=display:flex><span>ce74624eba92573318f50764cee4f355fa1f35697d209f70a4240f8f9d976188  pg_exporter-1.1.1.darwin-amd64.tar.gz
</span></span><span style=display:flex><span>35fba12521dbdcc54a3792278ed4822e4ca9e951665b5e53dff7c2a0f7014ae3  pg_exporter-1.1.1.darwin-arm64.tar.gz
</span></span><span style=display:flex><span>7699bdef15dd306289645beee8d40a123ca75dc988e46d89cdd75a1c1f650bef  pg_exporter-1.1.1.linux-amd64.tar.gz
</span></span><span style=display:flex><span>f4baba59d27a8eb67f0c5209fed7b9f00f78db796e583cc3487701e7803671c6  pg_exporter-1.1.1.linux-arm64.tar.gz
</span></span><span style=display:flex><span>810c3817c27358fa667714f8bfe8d52840a7ea010035e29547919ccb7c9fa781  pg_exporter-1.1.1.linux-ppc64le.tar.gz
</span></span><span style=display:flex><span>3f6df693b3eb92fdaeaeccf99ea7e5977b2c65028a4f00bdfabbc0405b9f5f93  pg_exporter-1.1.1.windows-amd64.tar.gz
</span></span></code></pre></div><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.1.1>https://github.com/pgsty/pg_exporter/releases/tag/v1.1.1</a></p><hr><h2 id=v110>v1.1.0</h2><p>使用 Go 1.25.5 和最新依赖构建，采集器更新：</p><p><strong>采集器变更：</strong></p><ul><li><code>pg_setting</code>：针对 PG10-18 兼容性进行重大重构，支持 <code>missing_ok</code><ul><li>新增 13 个指标：<code>max_parallel_workers</code>、<code>max_parallel_workers_per_gather</code>、<code>max_parallel_maintenance_workers</code>、<code>shared_buffers</code>、<code>maintenance_work_mem</code>、<code>effective_cache_size</code>、<code>fsync</code>、<code>full_page_writes</code>、<code>autovacuum</code>、<code>autovacuum_max_workers</code>、<code>checkpoint_timeout</code>、<code>checkpoint_completion_target</code>、<code>hot_standby</code>、<code>synchronous_commit</code>、<code>io_method</code></li><li>将 <code>work_memory_size</code> 重命名为 <code>work_mem</code></li><li>min_version 从 9.6 改为 10，显式 <code>::int</code> 类型转换</li></ul></li><li><code>pg_size</code>：修复日志目录大小检测，使用 <code>logging_collector</code> 检查代替路径模式匹配</li><li><code>pg_table</code>：性能优化，用 JOIN 替换 LATERAL 子查询以提升查询性能；修复 <code>tuples</code> 和 <code>frozenxid</code> 指标类型从 COUNTER 改为 GAUGE；超时从 1s 增加到 2s</li><li><code>pg_vacuuming</code>：新增 PG17 采集器分支，包含新指标 <code>indexes_total</code>、<code>indexes_processed</code>、<code>dead_tuple_bytes</code> 用于索引 vacuum 进度跟踪</li><li><code>pg_query</code>：超时从 1s 增加到 2s 以应对高负载场景</li><li><code>pg_io</code>：修复 <code>reuses</code> 描述中的拼写错误（&ldquo;in reused&rdquo; -> &ldquo;is reused&rdquo;）</li><li><code>pg_checkpointer</code>：修复 pg_checkpointer_10 描述（&ldquo;9.4+&rdquo; -> &ldquo;9.4-17&rdquo;）</li><li><code>pg_db_confl</code>：修复 pg_db_confl_15 描述（&ldquo;9.1 - 16&rdquo; -> &ldquo;9.1 - 15&rdquo;）</li><li><code>pg_db</code>、<code>pg_indexing</code>、<code>pg_clustering</code>、<code>pg_backup</code> 格式对齐修复</li></ul><p><strong>其他变更：</strong></p><ul><li>由 <a href=https://github.com/anayrat>@anayrat</a> 修复发布年份</li></ul><p><strong>校验和</strong></p><p><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.0.3/checksums.txt>https://github.com/pgsty/pg_exporter/releases/download/v1.0.3/checksums.txt</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>9c65f43e76213bb8a49d1eab2c76a27d9ab694e67bc79f0ad12769ea362b5ca2  pg-exporter_1.1.0-1_amd64.deb
</span></span><span style=display:flex><span>bcd2cacb4febc5fb92f9eda8e733c161c8c6721416e16ec91a773503241c972d  pg-exporter_1.1.0-1_arm64.deb
</span></span><span style=display:flex><span>2c9d4a9cb06d07af0b6dd9dd6e568af073dc9f6775abde63b45f0aae34d171b1  pg-exporter_1.1.0-1_ppc64le.deb
</span></span><span style=display:flex><span>2934ab5b0fb16dca5a96ec1e8f230e32c72b30ca076b5e5ddf8ec553c821f7b8  pg_exporter-1.1.0-1.aarch64.rpm
</span></span><span style=display:flex><span>3c9955f31ba93532cc7f95ff60b0658f4b6eca6a827710e2f70c0716b34eab43  pg_exporter-1.1.0-1.ppc64le.rpm
</span></span><span style=display:flex><span>9fdefbd8e7660dcb130207901a27762e0a381857ba8cf12b63184744f92dea05  pg_exporter-1.1.0-1.x86_64.rpm
</span></span><span style=display:flex><span>7159002016754309e0ed625a9a48049d21177883fa11d1e448eb7655ceb690cc  pg_exporter-1.1.0.darwin-amd64.tar.gz
</span></span><span style=display:flex><span>7d55ac5cda0b1fd8ffbd5e76b9c1c1784ac8e353104a206caaadce89adda6d65  pg_exporter-1.1.0.darwin-arm64.tar.gz
</span></span><span style=display:flex><span>8211ec24277554b9b1a36920d7865153e21c2621031d3d08f22d94cdd2ddf02f  pg_exporter-1.1.0.linux-amd64.tar.gz
</span></span><span style=display:flex><span>d17ab7f9bf04442e642483d432d005d25bb62e0c9caa73cb7e69ee19eb89b3ae  pg_exporter-1.1.0.linux-arm64.tar.gz
</span></span><span style=display:flex><span>c074aeb345cc30f7b6e16aa153ae3d9a12789e4425987590c3fd77c4e68a40b6  pg_exporter-1.1.0.linux-ppc64le.tar.gz
</span></span><span style=display:flex><span>13d653e2abb023ce9526bdc2815135b82f49c044d237030f3f56b09fb016fcb7  pg_exporter-1.1.0.windows-amd64.tar.gz
</span></span></code></pre></div><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.1.0>https://github.com/pgsty/pg_exporter/releases/tag/v1.1.0</a></p><hr><h2 id=v103>v1.0.3</h2><ul><li>使用 Go 1.25.4 和最新依赖构建</li><li>修复 <a href=https://github.com/pgsty/pg_exporter/issues/80>#80</a> 与 libpq 环境变量冲突</li><li>由 <a href=https://github.com/kadaffy>@kadaffy</a> 将 <code>auto-discovery</code> 默认值改为 <code>true</code></li></ul><p><strong>校验和</strong></p><p><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.0.3/checksums.txt>https://github.com/pgsty/pg_exporter/releases/download/v1.0.3/checksums.txt</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>7efa1a77dfd5b94813c32c7ac015b1d479b1f04fb958f6b1ed5af333e354d015  pg-exporter_1.0.3-1_amd64.deb
</span></span><span style=display:flex><span>41e18bf18eba2ab90ac371bfb46e9152da9fe628ebd8e26766cac08325eb3b07  pg-exporter_1.0.3-1_arm64.deb
</span></span><span style=display:flex><span>7da8ed738d254c120d42aa51d6137f84e7f4e3188bc764d4f9a1438220363a43  pg-exporter_1.0.3-1_ppc64le.deb
</span></span><span style=display:flex><span>a214b555981156da7b7d248b1f728f8ac88a07ac8f77a66c5d8e43b40670d6b4  pg_exporter-1.0.3-1.aarch64.rpm
</span></span><span style=display:flex><span>d876fc66e208612ebffe3c43dabce88b088d915f92584260d710b85a3a131413  pg_exporter-1.0.3-1.ppc64le.rpm
</span></span><span style=display:flex><span>75f62d314fec50c836c534996c884d25ecea77810ab33e7ba0e9c4b783e775b4  pg_exporter-1.0.3-1.x86_64.rpm
</span></span><span style=display:flex><span>47829a19707284bcee1b8dc47cc7d0172398bb533e6b4043950f787486712769  pg_exporter-1.0.3.darwin-amd64.tar.gz
</span></span><span style=display:flex><span>38b6ccb72315cadea542b1f2a7b7022d0e8d48ffd4ab177bb69a0a909b99af6b  pg_exporter-1.0.3.darwin-arm64.tar.gz
</span></span><span style=display:flex><span>36e8dff84d61a7593ff1fcec567ca4ffeaecd0be2f9eabd227ceac71b12a919a  pg_exporter-1.0.3.linux-amd64.tar.gz
</span></span><span style=display:flex><span>6477e8ef873773a09c4f39a29444f21b5b2c71e717e52ca425bcc8e8e5448791  pg_exporter-1.0.3.linux-arm64.tar.gz
</span></span><span style=display:flex><span>a083b51ebed2b280e2eaa0f19558494e7fa6f122a0a86a1d117206fcd090820c  pg_exporter-1.0.3.linux-ppc64le.tar.gz
</span></span><span style=display:flex><span>a1f9b27b7190f478726d96f270a72d9dc4d3f2bcc3b0326b7c4a2607e62ea588  pg_exporter-1.0.3.windows-amd64.tar.gz
</span></span></code></pre></div><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.0.3>https://github.com/pgsty/pg_exporter/releases/tag/v1.0.3</a></p><hr><h2 id=v102>v1.0.2</h2><ul><li>使用 Go 1.25.0 和最新依赖构建</li><li>专属网站和主页：https://exp.pgsty.com</li><li>使用 goreleaser 通过 CI/CD 流水线发布更多操作系统/架构：<ul><li>新增 Windows amd64 支持</li><li>新增 Linux ppc64le 支持</li></ul></li></ul><p><strong>校验和</strong></p><p><a href=https://github.com/pgsty/pg_exporter/releases/download/v1.0.2/checksums.txt>https://github.com/pgsty/pg_exporter/releases/download/v1.0.2/checksums.txt</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>683bf97f22173f2f2ec319a88e136939c2958a1f5ced4f4aa09a1357fc1c44c5  pg-exporter_1.0.2-1_amd64.deb
</span></span><span style=display:flex><span>f62d479a92be2d03211c162b8419f968cea87ceef5b1f25f2bcd390e0b72ccb5  pg-exporter_1.0.2-1_arm64.deb
</span></span><span style=display:flex><span>e1bbfc5a4c1b93e6f92bc7adcb4364583ab763e76e156aa5c979d6d1040f4c7a  pg-exporter_1.0.2-1_ppc64le.deb
</span></span><span style=display:flex><span>f51d5b45448e6bbec3467d1d1dc049b1e16976f723af713c4262541ac55a039c  pg_exporter-1.0.2-1.aarch64.rpm
</span></span><span style=display:flex><span>18380011543674e4c48b2410266b41165974d780cbc8918fc562152ba623939e  pg_exporter-1.0.2-1.ppc64le.rpm
</span></span><span style=display:flex><span>198372d894b9598c166a0e91ca36d3c9271cb65298415f63dbffcf6da611f2bb  pg_exporter-1.0.2-1.x86_64.rpm
</span></span><span style=display:flex><span>cbe7e07df6d180507c830cdab4cf86d40ccd62774723946307b5331d4270477d  pg_exporter-1.0.2.darwin-amd64.tar.gz
</span></span><span style=display:flex><span>20c4a35fa244287766c1d1a19cd2e393b3fa451a96a81e5635401e69bef04b97  pg_exporter-1.0.2.darwin-arm64.tar.gz
</span></span><span style=display:flex><span>d742111185f6a89fff34bfd304b851c8eb7a8e38444f0220786e11ed1934eff1  pg_exporter-1.0.2.linux-amd64.tar.gz
</span></span><span style=display:flex><span>0b1f4c97c1089c4767d92eb22419b8f29c9f46fb90ddfd1e8514cc42dc41054f  pg_exporter-1.0.2.linux-arm64.tar.gz
</span></span><span style=display:flex><span>895083fd2c7fc5409cc1a2dbaaef1e47ac7aa6a3fd5db2359012922d90bcdcc3  pg_exporter-1.0.2.linux-ppc64le.tar.gz
</span></span><span style=display:flex><span>5f751228e7120604af9a482fb70197489fa633c38a0f2b6a3489393fbc6a10aa  pg_exporter-1.0.2.windows-amd64.tar.gz
</span></span></code></pre></div><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.0.2>https://github.com/pgsty/pg_exporter/releases/tag/v1.0.2</a></p><hr><h2 id=v101>v1.0.1</h2><ul><li>新增 DockerHub 镜像：<a href=https://hub.docker.com/r/pgsty/pg_exporter>pgsty/pg_exporter</a></li><li>升级 Go 依赖到最新版本，使用 Go 1.24.5 构建</li><li>默认禁用 <code>pg_tsdb_hypertable</code> 采集器，因为 <code>timescaledb</code> 目录已变更</li></ul><p><strong>校验和</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>d5e2d6a656eef0ae1b29cd49695f9773  pg_exporter-1.0.1-1.aarch64.rpm
</span></span><span style=display:flex><span>cb01bb78d7b216a235363e9342803cb3  pg_exporter-1.0.1-1.x86_64.rpm
</span></span><span style=display:flex><span>67093a756b04845f69ad333b6d458e81  pg_exporter-v1.0.1.darwin-amd64.tar.gz
</span></span><span style=display:flex><span>2d3fdc10045d1cf494b9c1ee7f94f127  pg_exporter-v1.0.1.darwin-arm64.tar.gz
</span></span><span style=display:flex><span>e242314461becfa99c3978ae72838ab0  pg_exporter-v1.0.1.linux-amd64.tar.gz
</span></span><span style=display:flex><span>63de91da9ef711a53718bc60b89c82a6  pg_exporter-v1.0.1.linux-arm64.tar.gz
</span></span><span style=display:flex><span>718f6afc004089f12c1ca6553f9b9ba5  pg-exporter_1.0.1_amd64.deb
</span></span><span style=display:flex><span>57da7a8005cdf91ba8c1fb348e0d7367  pg-exporter_1.0.1_arm64.deb
</span></span></code></pre></div><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.0.1>https://github.com/pgsty/pg_exporter/releases/tag/v1.0.1</a></p><hr><h2 id=v100>v1.0.0</h2><p>新增 PostgreSQL 18 指标支持</p><ul><li>新采集器分支 <code>pg_wal_18</code>：<ul><li>移除 <code>write</code>、<code>sync</code>、<code>write_time</code>、<code>sync_time</code> 指标</li><li>移至 <code>pg_stat_io</code></li></ul></li><li>新采集器分支 <code>pg_checkpointer_18</code>：<ul><li>新指标 <code>num_done</code></li><li>新指标 <code>slru_written</code></li></ul></li><li>新采集器分支 <code>pg_db_18</code>：<ul><li>新指标 <code>parallel_workers_to_launch</code></li><li>新指标 <code>parallel_workers_launched</code></li></ul></li><li>新采集器分支 <code>pg_table_18</code>：<ul><li><code>table_parallel_workers_to_launch</code></li><li><code>table_parallel_workers_launched</code></li></ul></li><li>新采集器分支 <code>pg_io_18</code>：<ul><li>新增 WAL 统计系列</li><li>新指标 <code>read_bytes</code></li><li>新指标 <code>write_bytes</code></li><li>新指标 <code>extend_bytes</code></li><li>移除 <code>op_bytes</code>（因为是固定值）</li></ul></li><li>新采集器分支 <code>pg_vacuuming_18</code>：<ul><li>新指标 <code>delay_time</code></li></ul></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>8637bc1a05b93eedfbfd3816cca468dd  pg_exporter-1.0.0-1.aarch64.rpm
</span></span><span style=display:flex><span>a28c4c0dcdd3bf412268a2dbff79f5b9  pg_exporter-1.0.0-1.x86_64.rpm
</span></span><span style=display:flex><span>229129209b8e6bc356c28043c7c22359  pg_exporter-v1.0.0.darwin-amd64.tar.gz
</span></span><span style=display:flex><span>d941c2c28301269e62a8853c93facf12  pg_exporter-v1.0.0.darwin-arm64.tar.gz
</span></span><span style=display:flex><span>5bbb94db46cacca4075d4c341c54db37  pg_exporter-v1.0.0.linux-amd64.tar.gz
</span></span><span style=display:flex><span>da9ad428a50546a507a542d808f1c0fa  pg_exporter-v1.0.0.linux-arm64.tar.gz
</span></span><span style=display:flex><span>0fa2395d9d7a43ab87e5c87e5b06ffcc  pg-exporter_1.0.0_amd64.deb
</span></span><span style=display:flex><span>fed56f8a37e30cc59e85f03c81fce3f5  pg-exporter_1.0.0_arm64.deb
</span></span></code></pre></div><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v1.0.0>https://github.com/pgsty/pg_exporter/releases/tag/v1.0.0</a></p><hr><h2 id=v090>v0.9.0</h2><p><strong>默认采集器</strong></p><ul><li>新增 <code>timescaledb</code> 超表指标采集器</li><li>新增 <code>citus</code> 分布式节点指标采集器</li><li>新增 <code>pg_wait_sampling</code> 等待事件采集器</li><li><code>pg_slot</code> 全面改进：新增 16/17 pg_replication_slot 指标</li><li>允许 <code>pg_slot</code> 采集器从 16/17 开始在从库上运行</li><li>重构 <code>pg_wait</code> 采集器，从所有进程聚合</li><li>限制 pg_clustering、pg_indexing、pg_vacuuming 只在主库运行</li><li>将所有 <code>reset_time</code> 标记为 <code>GAUGE</code> 而非 <code>COUNTER</code></li><li>修复 <code>pg_recovery_prefetch_skip_fpw</code> 类型从 <code>GAUGE</code> 改为 <code>COUNTER</code></li><li>修复 <code>pg_recv.state</code> 类型从 <code>LABEL</code> 改为 <code>GAUGE</code></li><li>采集器格式改为紧凑模式</li><li>新增默认指标 <code>pg_exporter_build_info</code> / <code>pgbouncer_exporter_build_info</code></li><li>为 <code>pg_meta</code> 采集器新增 <code>server_encoding</code></li><li>为 <code>pg_setting</code> 采集器新增 12 个设置指标：<ul><li>wal_block_size</li><li>segment_size</li><li>wal_segment_size</li><li>wal_level</li><li>wal_log_hints</li><li>work_mem</li><li>hugepage_count</li><li>hugepage_status</li><li>max_wal_size</li><li>min_wal_size</li><li>max_slot_wal_keep_size</li></ul></li></ul><p><strong>导出器代码库</strong></p><ul><li>使用最小 PG 版本后缀规范化采集器分支名称</li><li>为二进制包添加许可证文件</li><li>将 <code>pgsty/pg_exporter</code> 仓库移至 <code>pgsty/pg_exporter</code></li><li>重构 <code>server.go</code> 以降低 <code>Compatible</code> 和 <code>PostgresPrecheck</code> 复杂度</li><li>使用额外数字前缀重命名指标采集器以便排序</li><li>升级依赖到最新版本</li><li>在所有非致命采集器之前执行致命采集器，快速失败</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.9.0>https://github.com/pgsty/pg_exporter/releases/tag/v0.9.0</a></p><hr><h2 id=v081>v0.8.1</h2><ul><li>升级依赖到最新版本</li><li><a href=https://github.com/pgsty/pg_exporter/pull/67>升级 golang.org/x/net 从 0.35.0 到 0.36.0 #67</a></li><li>更新 Docker 镜像构建标签</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.8.1>https://github.com/pgsty/pg_exporter/releases/tag/v0.8.1</a></p><hr><h2 id=v080>v0.8.0</h2><ul><li>新增 PgBouncer 1.24 新指标支持（stat、pool、database）</li><li>修复：<code>310-pg_size.yml</code> 在日志目录设置不正确时失败 <a href=https://github.com/pgsty/pg_exporter/issues/64>#64</a>，由 <a href=https://github.com/suikast42>@Süleyman Vurucu</a> 贡献</li><li>使用最新 Go 1.24 构建并升级所有依赖</li><li>使用标准 <code>log/slog</code> 重构日志，替代 <code>go-kit</code></li><li><strong>完整变更日志</strong>：https://github.com/pgsty/pg_exporter/compare/v0.7.1&mldr;v0.8.0</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.8.0>https://github.com/pgsty/pg_exporter/releases/tag/v0.8.0</a></p><hr><h2 id=v071>v0.7.1</h2><p>使用 dependabot 进行例行更新</p><ul><li>功能：支持将配置指定为 Reader，由 <a href=https://github.com/ringerc>@ringerc</a> 在 <a href=https://github.com/pgsty/pg_exporter/pull/62>#62</a> 贡献</li><li>升级 golang.org/x/crypto 从 0.21.0 到 0.31.0，由 <a href=https://github.com/dependabot>@dependabot</a> 在 <a href=https://github.com/pgsty/pg_exporter/pull/63>#63</a> 贡献</li><li>修复一些拼写错误</li><li><strong>完整变更日志</strong>：https://github.com/pgsty/pg_exporter/compare/v0.7.0&mldr;v0.7.1</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.7.1>https://github.com/pgsty/pg_exporter/releases/tag/v0.7.1</a></p><hr><h2 id=v070>v0.7.0</h2><p>为最新 Go 版本重构代码库。</p><ul><li><a href=https://github.com/pgsty/pg_exporter/issues/53>PostgreSQL 17 指标支持</a>，由 @Vonng 贡献</li><li><a href=https://github.com/pgsty/pg_exporter/pull/47>pg_exporter: 谓词查询功能</a>，由 <a href=https://github.com/ringerc>@ringerc</a> 贡献</li><li><a href=https://github.com/pgsty/pg_exporter/pull/54>在 Dockerfile 中进行干净构建</a>，由 <a href=https://github.com/ringerc>@ringerc</a> 贡献</li><li><a href=https://github.com/pgsty/pg_exporter/pull/46>pg_exporter: &ldquo;bind: address already in use&rdquo; 后不再 panic</a>，由 <a href=https://github.com/ringerc>@ringerc</a> 贡献</li><li><a href=https://github.com/pgsty/pg_exporter/pull/48>pg_exporter: 修复 /stat 端点格式</a>，由 <a href=https://github.com/ringerc>@ringerc</a> 贡献</li><li><a href=https://github.com/pgsty/pg_exporter/pull/49>pg_exporter: yaml 导出时省略默认查询属性</a>，由 <a href=https://github.com/ringerc>@ringerc</a> 贡献</li><li><a href=https://github.com/pgsty/pg_exporter/pull/50>从发现中排除模板数据库并模式限定发现查询</a>，由 <a href=https://github.com/ringerc>@ringerc</a> 贡献</li><li><a href=https://github.com/pgsty/pg_exporter/pull/51>修复一些拼写错误和指标描述错误</a>，由 <a href=https://github.com/ringerc>@ringerc</a> 贡献</li><li><a href=https://github.com/pgsty/pg_exporter/pull/52>从废弃的 lib/pq 驱动切换到带 stdlib 包装的 pgx</a>，由 <a href=https://github.com/ringerc>@ringerc</a> 贡献</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.7.0>https://github.com/pgsty/pg_exporter/releases/tag/v0.7.0</a></p><hr><h2 id=v060>v0.6.0</h2><ul><li><p>安全增强：修复 <a href="https://github.com/pgsty/pg_exporter/security/dependabot?q=is%3Aclosed">安全</a> dependabot 问题</p></li><li><p>新增 pg16 采集器</p></li><li><p>新增 <code>arm64</code> 和 <code>aarch64</code> 包</p></li><li><p>移除 <code>pg_query</code> 采集器的 <code>monitor</code> 模式要求（您需要通过 search_path 确保或直接在默认 <code>public</code> 模式中安装 <code>pg_stat_statements</code>）</p></li><li><p>修复 pgbouncer 版本解析消息级别从 info 改为 debug</p></li><li><p>修复 <code>pg_table_10_12</code> 采集器缺少 <code>relid</code> 的问题</p></li><li><p><a href=https://github.com/pgsty/pg_exporter/pull/34>识别配置目录中的 yml 后缀文件</a>，由 <a href=https://github.com/japinli>@Japin Li</a> 贡献</p></li><li><p><a href=https://github.com/pgsty/pg_exporter/pull/35>支持 PostgreSQL 15 及更高版本</a>，由 <a href=https://github.com/japinli>@Japin Li</a> 贡献</p></li><li><p><a href=https://github.com/pgsty/pg_exporter/pull/37/files>修复 connect-timeout 传播</a>，由 <a href=https://github.com/mouchar>@mouchar</a> 贡献</p></li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.6.0>https://github.com/pgsty/pg_exporter/releases/tag/v0.6.0</a></p><hr><h2 id=v050>v0.5.0</h2><p><strong>导出器增强</strong></p><ul><li>使用 <code>nfpm</code> 构建 rpm 和 deb</li><li>新增 <code>column.default</code>，当指标值为 NULL 时替换</li><li>新增 <code>column.scale</code>，当指标值为浮点/整数时乘以缩放因子（例如微秒转秒）</li><li>修复 <code>/stat</code> 端点输出</li><li>新增 Docker 容器 <a href=https://hub.docker.com/r/pgsty/pg_exporter><code>pgsty/pg_exporter</code></a></li></ul><p><strong>指标采集器</strong></p><ul><li>将 bgwriter 和 pg_wal 时间单位缩放为秒</li><li>移除 pg_class 采集器，将其移至 pg_table 和 pg_index</li><li>为 pg_table 新增 pg_class 指标</li><li>为 pg_index 新增 pg_class 指标</li><li>默认启用 pg_table_size</li><li>将 pg_query、pg_db、pg_bgwriter、pg_ssl、pgbouncer_stat 时间指标缩放为秒</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.5.0>https://github.com/pgsty/pg_exporter/releases/tag/v0.5.0</a></p><hr><h2 id=v041>v0.4.1</h2><ul><li>更新默认采集器<ul><li>在对象监控中省略 citus 和 timescaledb 模式</li><li>避免重复的 pg_statio 元组</li><li>支持 pgbouncer v1.16</li><li>Bug 修复：<code>pg_repl</code> 采集器在 pg 12 上重叠</li></ul></li><li>新参数：<code>-T</code> <code>connect-timeout</code> <code>PG_EXPORTER_CONNECT_TIMEOUT</code>
这在监控远程 Postgres 实例时很有用</li><li>现在 <code>pg_exporter.yaml</code> 在 rpm 包中重命名为 <code>pg_exporter.yml</code></li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.4.1>https://github.com/pgsty/pg_exporter/releases/tag/v0.4.1</a></p><hr><h2 id=v040>v0.4.0</h2><ul><li>新增 PG 14 支持</li><li>默认指标配置全面改进（但您仍可使用旧配置）</li><li>新增 <code>auto-discovery</code>、<code>include-database</code> 和 <code>exclude-database</code> 选项</li><li>新增多数据库监控实现（使用 <code>auto-discovery = on</code>）</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.4.0>https://github.com/pgsty/pg_exporter/releases/tag/v0.4.0</a></p><hr><h2 id=v032>v0.3.2</h2><ul><li>修复 shadow DSN 边界情况</li><li>修复拼写错误和文档</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.3.2>https://github.com/pgsty/pg_exporter/releases/tag/v0.3.2</a></p><hr><h2 id=v031>v0.3.1</h2><p>修复默认配置问题（特别是低于 13 的版本）</p><ul><li>设置 <code>primary_conninfo</code> 在 PG13 之前不存在</li><li>为 <code>pg_func</code> 采集器添加 <code>funcid</code> 标签以避免函数名重复标签</li><li>修复版本字符串为 <code>pg_exporter</code></li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.3.1>https://github.com/pgsty/pg_exporter/releases/tag/v0.3.1</a></p><hr><h2 id=v030>v0.3.0</h2><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.3.0>https://github.com/pgsty/pg_exporter/releases/tag/v0.3.0</a></p><ul><li>更改默认配置，支持 PostgreSQL 13 新指标（<code>pg_slru</code>、<code>pg_shmem</code>、<code>pg_query13</code>、<code>pg_backup</code> 等）</li><li>新增一系列用于健康/恢复状态检查的 REST API</li><li>新增一个带有假 <code>pg_up 0</code> 指标的虚拟服务器，在 PgExporter 初始化之前提供服务</li><li>如果未指定 <code>sslmode</code>，向 URL 添加 <code>sslmode=disable</code></li><li>修复拼写错误和 Bug</li></ul><hr><h2 id=v020>v0.2.0</h2><ul><li>新增 yum 包和 Linux 服务定义</li><li>在查询配置中新增 &lsquo;skip&rsquo; 标志</li><li>修复 <code>pgbouncer_up</code> 指标</li><li>新增配置重载支持</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.2.0>https://github.com/pgsty/pg_exporter/releases/tag/v0.2.0</a></p><hr><h2 id=v012>v0.1.2</h2><ul><li>修复 pgbouncer_up 指标</li><li>新增动态配置重载</li><li>移除 &lsquo;shard&rsquo; 相关逻辑</li><li>在默认设置中添加 &lsquo;bulky&rsquo; 模式</li></ul><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.1.2>https://github.com/pgsty/pg_exporter/releases/tag/v0.1.2</a></p><hr><h2 id=v011>v0.1.1</h2><p>修复 pg_exporter 在启动时如果任何查询失败会挂起的 Bug。</p><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.1.1>https://github.com/pgsty/pg_exporter/releases/tag/v0.1.1</a></p><hr><h2 id=v010>v0.1.0</h2><p>可以工作了，看起来不错。</p><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.1.0>https://github.com/pgsty/pg_exporter/releases/tag/v0.1.0</a></p><hr><h2 id=v004>v0.0.4</h2><p>在真实生产环境中测试了大约 2 周，200+ 节点。看起来不错！</p><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.0.4>https://github.com/pgsty/pg_exporter/releases/tag/v0.0.4</a></p><hr><h2 id=v003>v0.0.3</h2><p>v0.0.3 发布，在生产环境中测试</p><p>此版本已在生产环境中测试。</p><p>这个项目仍在快速发展中，如果您想在生产中使用，请谨慎尝试。</p><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.0.3>https://github.com/pgsty/pg_exporter/releases/tag/v0.0.3</a></p><hr><h2 id=v002>v0.0.2</h2><p>现在可以尝试了</p><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.0.2>https://github.com/pgsty/pg_exporter/releases/tag/v0.0.2</a></p><hr><h2 id=v001>v0.0.1</h2><p>新增 pgbouncer 模式</p><p><a href=https://github.com/pgsty/pg_exporter/releases/tag/v0.0.1>https://github.com/pgsty/pg_exporter/releases/tag/v0.0.1</a></p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>