<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/infra/admin/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/infra/admin/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>管理预案 | PIGSTY</title><meta name=description content="基础设施组件与 Infra 集群管理 SOP：创建，销毁，扩容，缩容，证书，仓库……"><meta property="og:url" content="https://pigsty.cc/docs/infra/admin/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="管理预案"><meta property="og:description" content="基础设施组件与 Infra 集群管理 SOP：创建，销毁，扩容，缩容，证书，仓库……"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="管理预案"><meta itemprop=description content="基础设施组件与 Infra 集群管理 SOP：创建，销毁，扩容，缩容，证书，仓库……"><meta itemprop=dateModified content="2026-01-08T18:37:06+08:00"><meta itemprop=wordCount content="3"><meta itemprop=keywords content="任务,参考"><meta name=twitter:card content="summary"><meta name=twitter:title content="管理预案"><meta name=twitter:description content="基础设施组件与 Infra 集群管理 SOP：创建，销毁，扩容，缩容，证书，仓库……"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/infra/admin/>返回本页常规视图</a>.</p></div><h1 class=title>管理预案</h1><div class=lead>基础设施组件与 Infra 集群管理 SOP：创建，销毁，扩容，缩容，证书，仓库……</div><ul><li>1: <a href=#pg-52d708085244eb9d51e81dd9e7c10996>Nginx 管理</a></li><li>2: <a href=#pg-3e5c80de91c09afe274f784b52a45287>软件仓库</a></li><li>3: <a href=#pg-11e76a7fd5b13e8b9ed2ffe665bd1146>域名管理</a></li><li>4: <a href=#pg-99138bcc6d2f367b6fb7df8b7a59e131>模块管理</a></li><li>5: <a href=#pg-3903df191db5a10a2713083bc196961f>CA 与证书</a></li><li>6: <a href=#pg-c91827b2709e7c2e7f7afc8662f9e0bf>Grafana 高可用部署：使用 PostgreSQL 后端数据库</a></li></ul><div class=content><p>本章节介绍 Pigsty 部署的日常管理和运维操作。</p></div></div><div class=td-content><h1 id=pg-52d708085244eb9d51e81dd9e7c10996>1 - Nginx 管理</h1><div class=lead>Nginx 管理，Web 门户配置，Web Server，暴露上游服务</div><p>Pigsty 在 INFRA 节点上安装 Nginx 作为所有 Web 服务的入口，默认监听在 80/443 标准端口上。</p><p>在 Pigsty 中，你可以通过修改配置清单，让 nginx 对外提供多种服务：</p><ul><li>对外暴露 Grafana、VictoriaMetrics（VMUI）、Alertmanager、VictoriaLogs 等监控组件的 Web 界面</li><li>提供静态文件服务（如软件仓库、文档站，网站等）</li><li>代理自定义的应用服务（如内部应用、数据库管理界面，Docker 应用的界面等）</li><li>自动签发自签名的 HTTPS 证书，或者使用 certbot 申请免费的 Let&rsquo;s Encrypt 证书</li><li>通过不同的子域名，使用单一端口对外暴露服务</li></ul><hr><h2 id=基础配置>基础配置</h2><p>您可以通过 <a href=/docs/infra/param#infra_portal><code>infra_portal</code></a> 参数定制 Nginx 的行为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>infra_portal</code> 是一个字典，每个键定义一个服务，值为服务的配置选项。
只有定义了 <code>domain</code> 的服务才会生成对应的 Nginx 配置文件。</p><ul><li><strong><code>home</code></strong>：特殊的默认服务器，用于处理首页和内置监控组件的反向代理</li><li><strong>代理服务</strong>：通过 <code>endpoint</code> 指定上游服务地址，进行反向代理</li><li><strong>静态服务</strong>：通过 <code>path</code> 指定本地目录，提供静态文件服务</li></ul><hr><h2 id=服务器参数>服务器参数</h2><h3 id=基本参数>基本参数</h3><table class=full-width><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>domain</code></td><td>可选的代理域名</td></tr><tr><td><code>endpoint</code></td><td>上游服务地址（IP:PORT 或 socket）</td></tr><tr><td><code>path</code></td><td>静态内容的本地目录</td></tr><tr><td><code>scheme</code></td><td>协议类型（http/https），默认 http</td></tr><tr><td><code>domains</code></td><td>额外的域名列表（别名）</td></tr></tbody></table><h3 id=ssltls-选项>SSL/TLS 选项</h3><table class=full-width><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>certbot</code></td><td>启用 Let&rsquo;s Encrypt 证书管理，值为证书名称</td></tr><tr><td><code>cert</code></td><td>自定义证书文件路径</td></tr><tr><td><code>key</code></td><td>自定义私钥文件路径</td></tr><tr><td><code>enforce_https</code></td><td>强制跳转 HTTPS（301 重定向）</td></tr></tbody></table><h3 id=高级设置>高级设置</h3><table class=full-width><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>config</code></td><td>自定义 Nginx 配置片段</td></tr><tr><td><code>index</code></td><td>启用目录列表（用于静态服务）</td></tr><tr><td><code>log</code></td><td>自定义日志文件名称</td></tr><tr><td><code>websocket</code></td><td>启用 WebSocket 支持</td></tr><tr><td><code>auth</code></td><td>启用 Basic Auth 认证</td></tr><tr><td><code>realm</code></td><td>Basic Auth 认证提示语</td></tr></tbody></table><hr><h2 id=配置示例>配置示例</h2><h3 id=反向代理服务>反向代理服务</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>grafana</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: g.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:3000&#34;</span><span style=color:#204a87;font-weight:700>, websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgadmin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: adm.pigsty, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:8885&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=静态文件与目录列表>静态文件与目录列表</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: repo.pigsty.cc, path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;/www/repo&#34;</span><span style=color:#204a87;font-weight:700>, index</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=自定义-ssl-证书>自定义 SSL 证书</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>secure_app</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>secure.pigsty.cc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:8443&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>cert</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;/etc/ssl/certs/custom.crt&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;/etc/ssl/private/custom.key&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=使用-lets-encrypt-证书>使用 Let&rsquo;s Encrypt 证书</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>grafana</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>demo.pigsty.cc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:3000&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>certbot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty.demo   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 证书名称，多个域名可共用同一证书</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=强制-https-跳转>强制 HTTPS 跳转</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>web.io</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en.pigsty.cc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;/www/web.io&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>certbot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty.doc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>enforce_https</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=自定义配置片段>自定义配置片段</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>web.cc</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty.cc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;/www/web.cc&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>domains</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>zh.pigsty.cc ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>certbot</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty.doc</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    # rewrite /zh/ to /
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        location /zh/ {
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>            rewrite ^/zh/(.*)$ /$1 permanent;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>        }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=管理命令>管理命令</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t nginx           <span style=color:#8f5902;font-style:italic># 完整重新配置 Nginx</span>
</span></span><span style=display:flex><span>./infra.yml -t nginx_config    <span style=color:#8f5902;font-style:italic># 重新生成配置文件</span>
</span></span><span style=display:flex><span>./infra.yml -t nginx_launch    <span style=color:#8f5902;font-style:italic># 重启 Nginx 服务</span>
</span></span><span style=display:flex><span>./infra.yml -t nginx_cert      <span style=color:#8f5902;font-style:italic># 重新生成 SSL 证书</span>
</span></span><span style=display:flex><span>./infra.yml -t nginx_certbot   <span style=color:#8f5902;font-style:italic># 使用 certbot 签发证书</span>
</span></span><span style=display:flex><span>./infra.yml -t nginx_reload    <span style=color:#8f5902;font-style:italic># 重新加载 Nginx 配置</span>
</span></span></code></pre></div><hr><h2 id=域名解析>域名解析</h2><p>有三种方式将域名解析到 Pigsty 服务器：</p><ol><li><strong>公网域名</strong>：通过 DNS 服务商配置</li><li><strong>内网 DNS 服务器</strong>：配置内部 DNS 解析</li><li><strong>本地 hosts 文件</strong>：修改 <code>/etc/hosts</code></li></ol><p>本地开发时，在 <code>/etc/hosts</code> 中添加：</p><pre tabindex=0><code>&lt;your_public_ip_address&gt; i.pigsty g.pigsty p.pigsty a.pigsty
</code></pre><p>Pigsty 内置了 dnsmasq 服务，可以通过 <a href=/docs/infra/param#dns_records><code>dns_records</code></a> 参数配置内部 DNS 解析。</p><hr><h2 id=https-配置>HTTPS 配置</h2><p>通过 <a href=/docs/infra/param#nginx_sslmode><code>nginx_sslmode</code></a> 参数配置 HTTPS：</p><table class=full-width><thead><tr><th>模式</th><th>说明</th></tr></thead><tbody><tr><td><code>disable</code></td><td>仅监听 HTTP（<code>nginx_port</code>）</td></tr><tr><td><code>enable</code></td><td>同时监听 HTTPS（<code>nginx_ssl_port</code>），默认签发自签名证书</td></tr><tr><td><code>enforce</code></td><td>强制跳转到 HTTPS，所有 80 端口请求都会 301 重定向</td></tr></tbody></table><p>对于自签名证书，有以下几种访问方式：</p><ul><li>在浏览器中信任自签名 CA（下载地址 <code>http://&lt;ip>/ca.crt</code>）</li><li>使用浏览器安全绕过（Chrome 中输入 &ldquo;thisisunsafe&rdquo;）</li><li>为生产环境配置正规 CA 签发的证书或使用 Let&rsquo;s Encrypt</li></ul><hr><h2 id=certbot-证书>Certbot 证书</h2><p>Pigsty 支持使用 Certbot 申请免费的 Let&rsquo;s Encrypt 证书。</p><h3 id=启用-certbot>启用 Certbot</h3><ol><li>在 <code>infra_portal</code> 中为服务添加 <code>certbot</code> 参数，指定证书名称</li><li>配置 <a href=/docs/infra/param#certbot_email><code>certbot_email</code></a> 为有效的邮箱地址</li><li>设置 <a href=/docs/infra/param#certbot_sign><code>certbot_sign</code></a> 为 <code>true</code> 在部署时自动签发</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>certbot_sign</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>certbot_email</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>your@email.com</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=手动签发证书>手动签发证书</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t nginx_certbot   <span style=color:#8f5902;font-style:italic># 签发 Let&#39;s Encrypt 证书</span>
</span></span></code></pre></div><p>或直接运行服务器上的脚本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/etc/nginx/sign-cert           <span style=color:#8f5902;font-style:italic># 签发证书</span>
</span></span><span style=display:flex><span>/etc/nginx/link-cert           <span style=color:#8f5902;font-style:italic># 链接证书到 Nginx 配置目录</span>
</span></span></code></pre></div><p>更多信息，请参阅 <a href=/docs/infra/admin/cert>Certbot：申请与更新 HTTPS 证书</a></p><hr><h2 id=默认首页>默认首页</h2><p>Pigsty 的默认首页 <code>home</code> 服务器提供以下内置路由：</p><table class=full-width><thead><tr><th>路径</th><th>说明</th></tr></thead><tbody><tr><td><code>/</code></td><td>首页导航</td></tr><tr><td><code>/zh</code></td><td>中文首页</td></tr><tr><td><code>/ui/</code></td><td>Grafana 监控面板</td></tr><tr><td><code>/vmetrics/</code></td><td>VictoriaMetrics VMUI</td></tr><tr><td><code>/vlogs/</code></td><td>VictoriaLogs 日志查询</td></tr><tr><td><code>/vtraces/</code></td><td>VictoriaTraces 链路追踪</td></tr><tr><td><code>/vmalert/</code></td><td>VMAlert 告警规则</td></tr><tr><td><code>/alertmgr/</code></td><td>AlertManager 告警管理</td></tr><tr><td><code>/blackbox/</code></td><td>Blackbox Exporter</td></tr><tr><td><code>/pev</code></td><td>PostgreSQL Explain 可视化工具</td></tr><tr><td><code>/haproxy/&lt;cluster>/</code></td><td>HAProxy 管理界面（如有）</td></tr></tbody></table><p>这些路由允许通过单一入口访问所有监控组件，无需配置多个域名。</p><hr><h2 id=最佳实践>最佳实践</h2><ul><li>使用域名而非 IP:PORT 访问服务</li><li>正确配置 DNS 解析或 hosts 文件</li><li>为实时应用启用 WebSocket（如 Grafana、Jupyter）</li><li>生产环境启用 HTTPS</li><li>使用有意义的子域名组织服务</li><li>监控 Let&rsquo;s Encrypt 证书过期时间</li><li>利用 <code>config</code> 参数添加自定义 Nginx 配置</li></ul><hr><h2 id=完整示例>完整示例</h2><p>以下是 Pigsty 公开演示站点 <a href=https://demo.pigsty.cc>demo.pigsty.cc</a> 使用的 Nginx 配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home         </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>i.pigsty }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>cc           </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: pigsty.cc      ,path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;/www/pigsty.cc&#34;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,cert: /etc/cert/pigsty.cc.crt ,key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/cert/pigsty.cc.key }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio        </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: m.pigsty.cc    ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:9001&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,scheme: https ,websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>postgrest    </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: api.pigsty.cc  ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:8884&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgadmin      </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: adm.pigsty.cc  ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:8885&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgweb        </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: cli.pigsty.cc  ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:8886&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bytebase     </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: ddl.pigsty.cc  ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:8887&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>jupyter      </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: lab.pigsty.cc  ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:8888&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>gitea        </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: git.pigsty.cc  ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:8889&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wiki         </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: wiki.pigsty.cc ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:9002&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>noco         </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: noco.pigsty.cc ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:9003&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>supa         </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: supa.pigsty.cc ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;10.10.10.10:8000&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>dify         </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: dify.pigsty.cc ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;10.10.10.10:8001&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>odoo         </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: odoo.pigsty.cc ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;127.0.0.1:8069&#34;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>mm           </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: mm.pigsty.cc   ,endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;10.10.10.10:8065&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-3e5c80de91c09afe274f784b52a45287>2 - 软件仓库</h1><div class=lead>管理本地 APT/YUM 软件仓库</div><p>Pigsty 支持创建和管理本地 APT/YUM 软件仓库，用于在离线环境中部署或加速软件包安装。</p><hr><h2 id=快速开始>快速开始</h2><p>向本地仓库添加软件包：</p><ol><li>将软件包添加到 <a href=/docs/infra/param#repo_packages><code>repo_packages</code></a>（默认软件包）</li><li>将软件包添加到 <a href=/docs/infra/param#repo_extra_packages><code>repo_extra_packages</code></a>（额外软件包）</li><li>执行构建命令：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t repo_build   <span style=color:#8f5902;font-style:italic># 从上游构建本地仓库</span>
</span></span><span style=display:flex><span>./node.yml -t node_repo     <span style=color:#8f5902;font-style:italic># 刷新节点仓库缓存</span>
</span></span></code></pre></div><hr><h2 id=软件包别名>软件包别名</h2><p>Pigsty 预定义了常用的软件包组合，方便批量安装：</p><h3 id=el-系统rhelcentosrocky>EL 系统（RHEL/CentOS/Rocky）</h3><table class=full-width><thead><tr><th>别名</th><th>说明</th></tr></thead><tbody><tr><td><code>node-bootstrap</code></td><td>Ansible、Python3 工具、SSH 相关</td></tr><tr><td><code>infra-package</code></td><td>Nginx、etcd、HAProxy、监控导出器、MinIO 等</td></tr><tr><td><code>pgsql-utility</code></td><td>Patroni、pgBouncer、pgBackRest、PG 工具</td></tr><tr><td><code>pgsql</code></td><td>完整 PostgreSQL（服务端、客户端、扩展）</td></tr><tr><td><code>pgsql-mini</code></td><td>最小化 PostgreSQL 安装</td></tr></tbody></table><h3 id=debianubuntu-系统>Debian/Ubuntu 系统</h3><table class=full-width><thead><tr><th>别名</th><th>说明</th></tr></thead><tbody><tr><td><code>node-bootstrap</code></td><td>Ansible、开发工具</td></tr><tr><td><code>infra-package</code></td><td>基础设施组件（使用 Debian 命名规范）</td></tr><tr><td><code>pgsql-client</code></td><td>PostgreSQL 客户端</td></tr><tr><td><code>pgsql-server</code></td><td>PostgreSQL 服务端及相关包</td></tr></tbody></table><hr><h2 id=剧本任务>剧本任务</h2><h3 id=主要任务>主要任务</h3><table class=full-width><thead><tr><th>任务</th><th>说明</th></tr></thead><tbody><tr><td><code>repo</code></td><td>从互联网或离线包创建本地仓库</td></tr><tr><td><code>repo_build</code></td><td>如不存在则从上游构建</td></tr><tr><td><code>repo_upstream</code></td><td>添加上游仓库文件</td></tr><tr><td><code>repo_pkg</code></td><td>下载软件包及依赖</td></tr><tr><td><code>repo_create</code></td><td>创建/更新 YUM 或 APT 仓库</td></tr><tr><td><code>repo_nginx</code></td><td>启动 Nginx 文件服务器</td></tr></tbody></table><h3 id=完整任务列表>完整任务列表</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t repo_dir          <span style=color:#8f5902;font-style:italic># 创建本地软件仓库目录</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_check        <span style=color:#8f5902;font-style:italic># 检查本地仓库是否存在</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_prepare      <span style=color:#8f5902;font-style:italic># 直接使用已有仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build        <span style=color:#8f5902;font-style:italic># 从上游构建仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_upstream     <span style=color:#8f5902;font-style:italic># 添加上游仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_remove       <span style=color:#8f5902;font-style:italic># 删除现有仓库文件</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_add          <span style=color:#8f5902;font-style:italic># 添加仓库到系统目录</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_url_pkg      <span style=color:#8f5902;font-style:italic># 从互联网下载包</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_cache        <span style=color:#8f5902;font-style:italic># 创建元数据缓存</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_boot_pkg     <span style=color:#8f5902;font-style:italic># 安装引导包</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_pkg          <span style=color:#8f5902;font-style:italic># 下载包及依赖</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_create       <span style=color:#8f5902;font-style:italic># 创建本地仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_use          <span style=color:#8f5902;font-style:italic># 添加新建仓库到系统</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_nginx        <span style=color:#8f5902;font-style:italic># 启动 Nginx 文件服务器</span>
</span></span></code></pre></div><hr><h2 id=常用操作>常用操作</h2><h3 id=添加新软件包>添加新软件包</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 配置上游仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_upstream
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 下载软件包及依赖</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_pkg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 构建本地仓库元数据</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_create
</span></span></code></pre></div><h3 id=刷新节点仓库>刷新节点仓库</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo    <span style=color:#8f5902;font-style:italic># 刷新所有节点的仓库缓存</span>
</span></span></code></pre></div><h3 id=完整重建仓库>完整重建仓库</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t repo        <span style=color:#8f5902;font-style:italic># 从互联网或离线包创建仓库</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-11e76a7fd5b13e8b9ed2ffe665bd1146>3 - 域名管理</h1><div class=lead>配置本地或公网域名访问 Pigsty 服务</div><p>使用域名代替 IP 地址访问 Pigsty 的各项 Web 服务。</p><hr><h2 id=快速开始>快速开始</h2><p>将以下静态解析记录添加到 <code>/etc/hosts</code>：</p><pre tabindex=0><code>10.10.10.10 i.pigsty g.pigsty p.pigsty a.pigsty
</code></pre><p>将 IP 地址替换为实际 Pigsty 节点的 IP。</p><hr><h2 id=为什么使用域名>为什么使用域名</h2><ul><li>比 IP 地址更易于记忆</li><li>灵活指向不同 IP</li><li>通过 Nginx 统一管理服务</li><li>支持 HTTPS 加密</li><li>防止某些地区的 ISP 劫持</li><li>允许通过代理访问内部绑定的服务</li></ul><hr><h2 id=dns-机制>DNS 机制</h2><p><strong>DNS 协议</strong>：将域名解析为 IP 地址。多个域名可以指向同一个 IP。</p><p><strong>HTTP 协议</strong>：使用 Host 头将请求路由到同一端口（80/443）上的不同站点。</p><hr><h2 id=默认域名>默认域名</h2><p>Pigsty 预定义了以下默认域名：</p><table class=full-width><thead><tr><th>域名</th><th>服务</th><th>端口</th><th>用途</th></tr></thead><tbody><tr><td><code>i.pigsty</code></td><td>Nginx</td><td>80/443</td><td>默认首页、本地仓库与统一入口</td></tr><tr><td><code>g.pigsty</code></td><td>Grafana</td><td>3000</td><td>监控与可视化</td></tr><tr><td><code>p.pigsty</code></td><td>VictoriaMetrics</td><td>8428</td><td>VMUI/PromQL 入口</td></tr><tr><td><code>a.pigsty</code></td><td>AlertManager</td><td>9059</td><td>告警路由</td></tr><tr><td><code>m.pigsty</code></td><td>MinIO</td><td>9001</td><td>对象存储控制台</td></tr></tbody></table><hr><h2 id=解析方式>解析方式</h2><h3 id=本地静态解析>本地静态解析</h3><p>在客户端机器的 <code>/etc/hosts</code> 中添加条目：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Linux/macOS</span>
</span></span><span style=display:flex><span>sudo vim /etc/hosts
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Windows</span>
</span></span><span style=display:flex><span>notepad C:<span style=color:#4e9a06>\W</span>indows<span style=color:#4e9a06>\S</span>ystem32<span style=color:#4e9a06>\d</span>rivers<span style=color:#4e9a06>\e</span>tc<span style=color:#4e9a06>\h</span>osts
</span></span></code></pre></div><p>添加内容：</p><pre tabindex=0><code>10.10.10.10 i.pigsty g.pigsty p.pigsty a.pigsty m.pigsty
</code></pre><h3 id=内网动态解析>内网动态解析</h3><p>Pigsty 内置了 dnsmasq 服务作为内网 DNS 服务器。配置被管理的节点使用 INFRA 节点作为 DNS 服务器：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_dns_servers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#4e9a06>&#39;${admin_ip}&#39;</span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 使用 INFRA 节点作为 DNS 服务器</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_dns_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>add               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 将其添加到现有 DNS 服务器列表</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>通过 <a href=/docs/infra/param#dns_records><code>dns_records</code></a> 参数配置 dnsmasq 解析的域名记录：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>dns_records</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#34;${admin_ip} i.pigsty&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#34;${admin_ip} m.pigsty supa.pigsty api.pigsty adm.pigsty cli.pigsty ddl.pigsty&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=公网域名>公网域名</h3><p>购买域名并添加 DNS A 记录指向公网 IP：</p><ol><li>在域名服务商处购买域名（如 <code>example.com</code>）</li><li>配置 A 记录指向服务器公网 IP</li><li>在 <a href=/docs/infra/param#infra_portal><code>infra_portal</code></a> 中使用真实域名</li></ol><hr><h2 id=内置-dns-服务>内置 DNS 服务</h2><p>Pigsty 在 INFRA 节点上运行 dnsmasq 作为 DNS 服务器。</p><h3 id=相关参数>相关参数</h3><table class=full-width><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/infra/param#dns_enabled><code>dns_enabled</code></a></td><td><code>true</code></td><td>是否启用 DNS 服务</td></tr><tr><td><a href=/docs/infra/param#dns_port><code>dns_port</code></a></td><td><code>53</code></td><td>DNS 监听端口</td></tr><tr><td><a href=/docs/infra/param#dns_records><code>dns_records</code></a></td><td>见下文</td><td>默认 DNS 记录列表</td></tr></tbody></table><p>默认的 DNS 记录：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>dns_records</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#34;${admin_ip} i.pigsty&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#34;${admin_ip} m.pigsty supa.pigsty api.pigsty adm.pigsty cli.pigsty ddl.pigsty&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=动态-dns-注册>动态 DNS 注册</h3><p>Pigsty 会自动为 PostgreSQL 集群和实例注册 DNS 记录：</p><ul><li><strong>实例级 DNS</strong>：<code>&lt;pg_instance></code> 指向实例 IP（如 <code>pg-meta-1</code>）</li><li><strong>集群级 DNS</strong>：<code>&lt;pg_cluster></code> 指向主库 IP 或 VIP（如 <code>pg-meta</code>）</li></ul><p>集群级 DNS 目标由 <a href=/docs/pgsql/param#pg_dns_target><code>pg_dns_target</code></a> 参数控制：</p><table class=full-width><thead><tr><th>值</th><th>说明</th></tr></thead><tbody><tr><td><code>auto</code></td><td>自动选择：有 VIP 用 VIP，否则用主库 IP</td></tr><tr><td><code>primary</code></td><td>始终指向主库 IP</td></tr><tr><td><code>vip</code></td><td>始终指向 VIP（需启用 VIP）</td></tr><tr><td><code>none</code></td><td>不注册集群 DNS</td></tr><tr><td><code>&lt;ip></code></td><td>指定固定 IP 地址</td></tr></tbody></table><p>通过 <a href=/docs/pgsql/param#pg_dns_suffix><code>pg_dns_suffix</code></a> 可为集群 DNS 添加后缀。</p><hr><h2 id=节点-dns-配置>节点 DNS 配置</h2><p>Pigsty 管理被纳管节点的 DNS 配置。</p><h3 id=静态-hosts-记录>静态 hosts 记录</h3><p>通过 <a href=/docs/node/param#node_etc_hosts><code>node_etc_hosts</code></a> 配置静态 <code>/etc/hosts</code> 记录：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_etc_hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#34;${admin_ip} i.pigsty&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#34;${admin_ip} sss.pigsty&#34;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 可选：MinIO S3 接入域名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#34;10.10.10.20 db.example.com&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=dns-服务器配置>DNS 服务器配置</h3><table class=full-width><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/node/param#node_dns_method><code>node_dns_method</code></a></td><td><code>add</code></td><td>DNS 配置方式</td></tr><tr><td><a href=/docs/node/param#node_dns_servers><code>node_dns_servers</code></a></td><td><code>['${admin_ip}']</code></td><td>DNS 服务器列表</td></tr><tr><td><a href=/docs/node/param#node_dns_options><code>node_dns_options</code></a></td><td>见下文</td><td>resolv.conf 选项</td></tr></tbody></table><p><code>node_dns_method</code> 可选值：</p><table class=full-width><thead><tr><th>值</th><th>说明</th></tr></thead><tbody><tr><td><code>add</code></td><td>添加到现有 DNS 服务器列表前面</td></tr><tr><td><code>overwrite</code></td><td>完全覆盖 DNS 服务器配置</td></tr><tr><td><code>none</code></td><td>不修改 DNS 配置</td></tr></tbody></table><p>默认的 DNS 选项：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_dns_options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>options single-request-reopen timeout:1</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=https-证书>HTTPS 证书</h2><p>Pigsty 默认使用自签名证书。可选方案包括：</p><ul><li>忽略警告，使用 HTTP</li><li>信任自签名 CA 证书（下载地址 <code>http://&lt;ip>/ca.crt</code>）</li><li>使用真实 CA 或通过 Certbot 获取免费公网域名证书</li></ul><p>详见 <a href=/docs/infra/admin/cert/>CA 与证书</a> 文档。</p><hr><h2 id=扩展域名>扩展域名</h2><p>Pigsty 扩展预留了以下域名用于各种应用服务：</p><table class=full-width><thead><tr><th>域名</th><th>用途</th></tr></thead><tbody><tr><td><code>adm.pigsty</code></td><td>PgAdmin 管理界面</td></tr><tr><td><code>ddl.pigsty</code></td><td>Bytebase DDL 管理</td></tr><tr><td><code>cli.pigsty</code></td><td>PgWeb 命令行界面</td></tr><tr><td><code>api.pigsty</code></td><td>PostgREST API 服务</td></tr><tr><td><code>lab.pigsty</code></td><td>Jupyter 实验环境</td></tr><tr><td><code>git.pigsty</code></td><td>Gitea Git 服务</td></tr><tr><td><code>wiki.pigsty</code></td><td>Wiki.js 文档</td></tr><tr><td><code>noco.pigsty</code></td><td>NocoDB</td></tr><tr><td><code>supa.pigsty</code></td><td>Supabase</td></tr><tr><td><code>dify.pigsty</code></td><td>Dify AI</td></tr><tr><td><code>odoo.pigsty</code></td><td>Odoo ERP</td></tr><tr><td><code>mm.pigsty</code></td><td>Mattermost</td></tr></tbody></table><p>使用这些域名需要在 <a href=/docs/infra/param#infra_portal><code>infra_portal</code></a> 中配置相应的服务。</p><hr><h2 id=管理命令>管理命令</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t dns            <span style=color:#8f5902;font-style:italic># 完整配置 DNS 服务</span>
</span></span><span style=display:flex><span>./infra.yml -t dns_config     <span style=color:#8f5902;font-style:italic># 重新生成 dnsmasq 配置</span>
</span></span><span style=display:flex><span>./infra.yml -t dns_record     <span style=color:#8f5902;font-style:italic># 更新默认 DNS 记录</span>
</span></span><span style=display:flex><span>./infra.yml -t dns_launch     <span style=color:#8f5902;font-style:italic># 重启 dnsmasq 服务</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./node.yml -t node_hosts      <span style=color:#8f5902;font-style:italic># 配置节点 /etc/hosts</span>
</span></span><span style=display:flex><span>./node.yml -t node_resolv     <span style=color:#8f5902;font-style:italic># 配置节点 DNS 解析器</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_dns         <span style=color:#8f5902;font-style:italic># 注册 PostgreSQL DNS 记录</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_dns_ins     <span style=color:#8f5902;font-style:italic># 仅注册实例级 DNS</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_dns_cls     <span style=color:#8f5902;font-style:italic># 仅注册集群级 DNS</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-99138bcc6d2f367b6fb7df8b7a59e131>4 - 模块管理</h1><div class=lead>Infra 模块本身的管理 SOP：定义，创建，销毁，扩容，缩容</div><p>本文介绍 INFRA 模块的日常管理操作，包括安装、卸载、扩容、以及各组件的管理维护。</p><hr><h2 id=安装-infra-模块>安装 Infra 模块</h2><p>使用 <a href=/docs/infra/playbook/#infrayml><code>infra.yml</code></a> 剧本在 <code>infra</code> 分组上安装 INFRA 模块：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml     <span style=color:#8f5902;font-style:italic># 在 infra 分组上安装 INFRA 模块</span>
</span></span></code></pre></div><hr><h2 id=卸载-infra-模块>卸载 Infra 模块</h2><p>使用 <a href=/docs/infra/playbook/#infra-rmyml><code>infra-rm.yml</code></a> 剧本从 <code>infra</code> 分组上卸载 INFRA 模块：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra-rm.yml  <span style=color:#8f5902;font-style:italic># 从 infra 分组上卸载 INFRA 模块</span>
</span></span></code></pre></div><hr><h2 id=扩容-infra-模块>扩容 Infra 模块</h2><p>在配置清单中为新节点分配 <a href=/docs/infra/param/#infra_seq><code>infra_seq</code></a> 并加入 <code>infra</code> 分组：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 原有节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 新节点</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用限制选项 <code>-l</code> 仅在新节点上执行剧本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -l 10.10.10.11    <span style=color:#8f5902;font-style:italic># 在新节点上安装 INFRA 模块</span>
</span></span></code></pre></div><hr><h2 id=管理本地软件仓库>管理本地软件仓库</h2><p>本地软件仓库相关的管理任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t repo              <span style=color:#8f5902;font-style:italic># 从互联网或离线包创建仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_upstream     <span style=color:#8f5902;font-style:italic># 添加上游仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_pkg          <span style=color:#8f5902;font-style:italic># 下载包及依赖</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_create       <span style=color:#8f5902;font-style:italic># 创建本地 yum/apt 仓库</span>
</span></span></code></pre></div><p>完整子任务列表：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t repo_dir          <span style=color:#8f5902;font-style:italic># 创建本地软件仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_check        <span style=color:#8f5902;font-style:italic># 检查本地软件仓库是否存在</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_prepare      <span style=color:#8f5902;font-style:italic># 直接使用已有仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build        <span style=color:#8f5902;font-style:italic># 从上游构建仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_upstream     <span style=color:#8f5902;font-style:italic># 添加上游仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_remove       <span style=color:#8f5902;font-style:italic># 删除现有仓库文件</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_add          <span style=color:#8f5902;font-style:italic># 添加仓库到系统目录</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_url_pkg      <span style=color:#8f5902;font-style:italic># 从互联网下载包</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_cache        <span style=color:#8f5902;font-style:italic># 创建元数据缓存</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_boot_pkg     <span style=color:#8f5902;font-style:italic># 安装引导包</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_pkg          <span style=color:#8f5902;font-style:italic># 下载包及依赖</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_create       <span style=color:#8f5902;font-style:italic># 创建本地仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_use          <span style=color:#8f5902;font-style:italic># 添加新建仓库到系统</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_nginx        <span style=color:#8f5902;font-style:italic># 启动 nginx 文件服务器</span>
</span></span></code></pre></div><hr><h2 id=管理-nginx>管理 Nginx</h2><p>Nginx 相关的管理任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t nginx                       <span style=color:#8f5902;font-style:italic># 重置 Nginx 组件</span>
</span></span><span style=display:flex><span>./infra.yml -t nginx_index                 <span style=color:#8f5902;font-style:italic># 重新渲染首页</span>
</span></span><span style=display:flex><span>./infra.yml -t nginx_config,nginx_reload   <span style=color:#8f5902;font-style:italic># 重新渲染配置并重载</span>
</span></span></code></pre></div><p>申请 HTTPS 证书：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t nginx_certbot,nginx_reload -e <span style=color:#000>certbot_sign</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><hr><h2 id=管理基础设施组件>管理基础设施组件</h2><p>基础设施各组件的管理命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t infra           <span style=color:#8f5902;font-style:italic># 配置基础设施</span>
</span></span><span style=display:flex><span>./infra.yml -t infra_env       <span style=color:#8f5902;font-style:italic># 配置环境变量</span>
</span></span><span style=display:flex><span>./infra.yml -t infra_pkg       <span style=color:#8f5902;font-style:italic># 安装软件包</span>
</span></span><span style=display:flex><span>./infra.yml -t infra_user      <span style=color:#8f5902;font-style:italic># 设置操作系统用户</span>
</span></span><span style=display:flex><span>./infra.yml -t infra_cert      <span style=color:#8f5902;font-style:italic># 颁发证书</span>
</span></span><span style=display:flex><span>./infra.yml -t dns             <span style=color:#8f5902;font-style:italic># 配置 DNSMasq</span>
</span></span><span style=display:flex><span>./infra.yml -t nginx           <span style=color:#8f5902;font-style:italic># 配置 Nginx</span>
</span></span><span style=display:flex><span>./infra.yml -t victoria        <span style=color:#8f5902;font-style:italic># 配置 VictoriaMetrics/Logs/Traces</span>
</span></span><span style=display:flex><span>./infra.yml -t alertmanager    <span style=color:#8f5902;font-style:italic># 配置 AlertManager</span>
</span></span><span style=display:flex><span>./infra.yml -t blackbox        <span style=color:#8f5902;font-style:italic># 配置 Blackbox Exporter</span>
</span></span><span style=display:flex><span>./infra.yml -t grafana         <span style=color:#8f5902;font-style:italic># 配置 Grafana</span>
</span></span><span style=display:flex><span>./infra.yml -t infra_register  <span style=color:#8f5902;font-style:italic># 注册到 VictoriaMetrics/Grafana</span>
</span></span></code></pre></div><p>常用维护命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t nginx_index                        <span style=color:#8f5902;font-style:italic># 重新渲染首页</span>
</span></span><span style=display:flex><span>./infra.yml -t nginx_config,nginx_reload          <span style=color:#8f5902;font-style:italic># 重新配置并重载</span>
</span></span><span style=display:flex><span>./infra.yml -t vmetrics_config,vmetrics_launch    <span style=color:#8f5902;font-style:italic># 重新生成 VictoriaMetrics 配置并重启</span>
</span></span><span style=display:flex><span>./infra.yml -t vlogs_config,vlogs_launch          <span style=color:#8f5902;font-style:italic># 更新 VictoriaLogs 配置</span>
</span></span><span style=display:flex><span>./infra.yml -t grafana_provision                  <span style=color:#8f5902;font-style:italic># 重新加载 Grafana 仪表盘与数据源定义</span>
</span></span></code></pre></div><hr><h2 id=管理-grafana-密码>管理 Grafana 密码</h2><p>Grafana 有两个密码参数：<a href=/docs/infra/param#grafana_admin_password><strong><code>grafana_admin_password</code></strong></a>（默认 <code>pigsty</code>）和 <a href=/docs/infra/param#grafana_view_password><strong><code>grafana_view_password</code></strong></a>（默认 <code>DBUser.Viewer</code>）：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>渲染到的配置文件</th></tr></thead><tbody><tr><td style=text-align:left><code>grafana_admin_password</code></td><td style=text-align:left><code>/etc/grafana/grafana.ini</code>，<code>/infra/env/pigsty</code></td></tr><tr><td style=text-align:left><code>grafana_view_password</code></td><td style=text-align:left><code>/etc/grafana/provisioning/datasources/pigsty.yml</code></td></tr></tbody></table><p>这两个密码一旦初始化之后，就只能通过 grafana 界面进行修改。</p><p>Pigsty 会在初始化 Grafana 监控面板，注册 Grafana 数据源的时候，使用 <a href=/docs/infra/param#grafana_admin_password><strong><code>grafana_admin_password</code></strong></a> 。
所以如果你通过 Grafana GUI 修改了这个密码，请相应调整配置文件里面的配置。另外，您可以使用以下命令渲染新的密码到环境变量中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t env_var            <span style=color:#8f5902;font-style:italic># 重新渲染环境变量</span>
</span></span></code></pre></div><p><a href=/docs/infra/param#grafana_view_password><strong><code>grafana_view_password</code></strong></a> 是 Grafana 中默认的 Meta PostgreSQL 数据源用户 <code>dbuser_view</code> 的密码。
如果你修改了这个密码，请在 Grafana 数据源管理界面中同步修改密码。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3903df191db5a10a2713083bc196961f>5 - CA 与证书</h1><div class=lead>使用自签名 CA 或真实 HTTPS 证书</div><p>Pigsty 默认使用<strong>自签名证书颁发机构 (CA)</strong> 进行内部 SSL/TLS 加密。本文档包含：</p><ul><li><a href=#%E8%87%AA%E7%AD%BE%E5%90%8D-ca>自签名 CA</a>：默认的 PKI 基础设施</li><li><a href=#%E7%AD%BE%E5%8F%91%E8%AF%81%E4%B9%A6>签发证书</a>：使用 <code>cert.yml</code> 签发额外证书</li><li><a href=#%E4%BF%A1%E4%BB%BB-ca-%E8%AF%81%E4%B9%A6>信任 CA 证书</a>：在客户端机器上安装 CA</li><li><a href=#lets-encrypt>Let&rsquo;s Encrypt</a>：为公网服务使用真实证书</li></ul><hr><h2 id=自签名-ca>自签名 CA</h2><p>Pigsty 在基础设施初始化 (<code>infra.yml</code>) 时自动创建自签名 CA。该 CA 用于签发以下证书：</p><ul><li>PostgreSQL 服务器/客户端 SSL</li><li>Patroni REST API</li><li>etcd 集群通信</li><li>MinIO 集群通信</li><li>Nginx HTTPS（备用）</li><li>基础设施服务</li></ul><h3 id=pki-目录结构>PKI 目录结构</h3><pre tabindex=0><code>files/pki/
├── ca/
│   ├── ca.key                # CA 私钥（务必保管好！）
│   └── ca.crt                # CA 证书
├── csr/                      # 证书签名请求
├── misc/                     # 杂项证书（cert.yml 输出）
├── etcd/                     # ETCD 证书
├── pgsql/                    # PostgreSQL 证书
├── minio/                    # MinIO 证书
├── infra/                    # 基础设施证书
├── nginx/                    # Nginx 证书
└── mongo/                    # FerretDB 证书
</code></pre><h3 id=ca-变量>CA 变量</h3><table class=full-width><thead><tr><th>变量</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>ca_create</code></td><td><code>true</code></td><td>如果不存在则创建 CA，否则中止</td></tr><tr><td><code>ca_cn</code></td><td><code>pigsty-ca</code></td><td>CA 证书通用名称</td></tr><tr><td><code>cert_validity</code></td><td><code>7300d</code></td><td>签发证书的默认有效期</td></tr></tbody></table><h3 id=证书有效期>证书有效期</h3><table class=full-width><thead><tr><th>证书类型</th><th>有效期</th><th>控制参数</th></tr></thead><tbody><tr><td>CA 证书</td><td>100 年</td><td>硬编码（36500 天）</td></tr><tr><td>服务器/客户端</td><td>20 年</td><td><code>cert_validity</code>（7300d）</td></tr><tr><td>Nginx HTTPS</td><td>~1 年</td><td><code>nginx_cert_validity</code>（397d）</td></tr></tbody></table><blockquote><p><strong>注意</strong>：浏览器厂商限制超过 398 天的证书信任。Nginx 使用较短有效期以保证浏览器兼容性。</p></blockquote><h3 id=使用外部-ca>使用外部 CA</h3><p>如需使用企业自有 CA 而非自动生成的 CA：</p><ol><li><p>在配置中设置 <code>ca_create: false</code></p></li><li><p>在运行 playbook 之前放置 CA 文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p files/pki/ca
</span></span><span style=display:flex><span>cp /path/to/your/ca.key files/pki/ca/ca.key
</span></span><span style=display:flex><span>cp /path/to/your/ca.crt files/pki/ca/ca.crt
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>600</span> files/pki/ca/ca.key
</span></span><span style=display:flex><span>chmod <span style=color:#0000cf;font-weight:700>644</span> files/pki/ca/ca.crt
</span></span></code></pre></div></li><li><p>运行 <code>./infra.yml</code></p></li></ol><h3 id=备份-ca-文件>备份 CA 文件</h3><p>CA 私钥至关重要，请安全备份：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 带时间戳备份</span>
</span></span><span style=display:flex><span>tar -czvf pigsty-ca-<span style=color:#204a87;font-weight:700>$(</span>date +%Y%m%d<span style=color:#204a87;font-weight:700>)</span>.tar.gz files/pki/ca/
</span></span></code></pre></div><blockquote><p><strong>警告</strong>：如果丢失 CA 私钥，由其签发的所有证书都将无法验证。您需要重新生成所有内容。</p></blockquote><hr><h2 id=签发证书>签发证书</h2><p>使用 <code>cert.yml</code> 签发由 Pigsty CA 签名的额外证书。</p><h3 id=基本用法>基本用法</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 为数据库用户签发证书（客户端证书）</span>
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_dba
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 为监控用户签发证书</span>
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_monitor
</span></span></code></pre></div><p>默认情况下，证书生成在 <code>files/pki/misc/&lt;cn>.{key,crt}</code>。</p><h3 id=参数说明>参数说明</h3><table class=full-width><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><code>cn</code></td><td><code>pigsty</code></td><td>通用名称（必填）</td></tr><tr><td><code>san</code></td><td><code>[DNS:localhost, IP:127.0.0.1]</code></td><td>主题备用名称</td></tr><tr><td><code>org</code></td><td><code>pigsty</code></td><td>组织名称</td></tr><tr><td><code>unit</code></td><td><code>pigsty</code></td><td>组织单位名称</td></tr><tr><td><code>expire</code></td><td><code>7300d</code></td><td>证书有效期（20 年）</td></tr><tr><td><code>key</code></td><td><code>files/pki/misc/&lt;cn>.key</code></td><td>私钥输出路径</td></tr><tr><td><code>crt</code></td><td><code>files/pki/misc/&lt;cn>.crt</code></td><td>证书输出路径</td></tr></tbody></table><h3 id=高级示例>高级示例</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 签发带自定义 SAN（DNS 和 IP）的证书</span>
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>myservice <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#4e9a06>&#39;{&#34;san&#34;:[&#34;DNS:myservice.local&#34;,&#34;DNS:myservice&#34;,&#34;IP:10.10.10.10&#34;]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 签发自定义有效期（10 年）的证书</span>
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>shortlived -e <span style=color:#000>expire</span><span style=color:#ce5c00;font-weight:700>=</span>3650d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 签发到自定义路径</span>
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>custom <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>key</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp/custom.key <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>crt</span><span style=color:#ce5c00;font-weight:700>=</span>/tmp/custom.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 签发带自定义组织的证书</span>
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>external <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>org</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;My Company&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -e <span style=color:#000>unit</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;IT Department&#34;</span>
</span></span></code></pre></div><h3 id=使用场景>使用场景</h3><p><strong>PostgreSQL 客户端证书</strong></p><p>用于 SSL 客户端认证（<code>pg_hba.conf</code> 中的 <code>cert</code> 认证方式）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 为 DBA 用户签发证书</span>
</span></span><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_dba
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 复制到客户端机器</span>
</span></span><span style=display:flex><span>scp files/pki/misc/dbuser_dba.<span style=color:#ce5c00;font-weight:700>{</span>key,crt<span style=color:#ce5c00;font-weight:700>}</span> user@client:~/.postgresql/
</span></span><span style=display:flex><span>scp files/pki/ca/ca.crt user@client:~/.postgresql/root.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用客户端证书连接</span>
</span></span><span style=display:flex><span>psql <span style=color:#4e9a06>&#34;host=pg-test port=5432 dbname=postgres user=dbuser_dba sslmode=verify-full sslcert=~/.postgresql/dbuser_dba.crt sslkey=~/.postgresql/dbuser_dba.key sslrootcert=~/.postgresql/root.crt&#34;</span>
</span></span></code></pre></div><p><strong>服务间 TLS</strong></p><p>用于需要双向 TLS 的内部服务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./cert.yml -e <span style=color:#000>cn</span><span style=color:#ce5c00;font-weight:700>=</span>myapp -e <span style=color:#4e9a06>&#39;{&#34;san&#34;:[&#34;DNS:myapp.service.local&#34;,&#34;IP:10.10.10.50&#34;]}&#39;</span>
</span></span></code></pre></div><hr><h2 id=信任-ca-证书>信任 CA 证书</h2><p>在客户端机器上信任自签名 CA：</p><h3 id=linux-debianubuntu>Linux (Debian/Ubuntu)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp files/pki/ca/ca.crt /usr/local/share/ca-certificates/pigsty-ca.crt
</span></span><span style=display:flex><span>sudo update-ca-certificates
</span></span></code></pre></div><h3 id=linux-rhelrockyalma>Linux (RHEL/Rocky/Alma)</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo cp files/pki/ca/ca.crt /etc/pki/ca-trust/source/anchors/pigsty-ca.crt
</span></span><span style=display:flex><span>sudo update-ca-trust
</span></span></code></pre></div><h3 id=macos>macOS</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo security add-trusted-cert -d -r trustRoot <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -k /Library/Keychains/System.keychain files/pki/ca/ca.crt
</span></span></code></pre></div><h3 id=windows>Windows</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-powershell data-lang=powershell><span style=display:flex><span><span style=color:#204a87>Import-Certificate</span> <span style=color:#000>-FilePath</span> <span style=color:#000>files</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>pki</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>ca</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>ca</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>crt</span> <span style=color:#000>-CertStoreLocation</span> <span style=color:#000>Cert</span><span style=color:#a40000>:</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>LocalMachine</span><span style=color:#000;font-weight:700>\</span><span style=color:#000>Root</span>
</span></span></code></pre></div><h3 id=从-nginx-下载>从 Nginx 下载</h3><p>CA 证书也可通过 Nginx 在 <code>http://&lt;infra_ip>/ca.crt</code> 获取：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -o ca.crt http://10.10.10.10/ca.crt
</span></span></code></pre></div><hr><h2 id=lets-encrypt>Let&rsquo;s Encrypt</h2><p>对于公网服务，您可以通过 Certbot 使用 Let&rsquo;s Encrypt 的真实证书。</p><h3 id=前置条件>前置条件</h3><ul><li>拥有公网域名</li><li>DNS 记录指向服务器的公网 IP</li><li>Nginx 已正确配置</li><li>80 和 443 端口可访问</li></ul><h3 id=第一步域名配置>第一步：域名配置</h3><p>在 <code>infra_portal</code> 中配置服务域名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>home</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty.cc }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>grafana</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: g.pigsty.cc, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:3000&#34;</span><span style=color:#204a87;font-weight:700>, websocket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vmetrics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: p.pigsty.cc, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:8428&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>alertmanager</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>domain: a.pigsty.cc, endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;${admin_ip}:9059&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=第二步dns-配置>第二步：DNS 配置</h3><p>通过 A 记录将所有域名指向服务器的公网 IP：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nslookup g.pigsty.cc
</span></span><span style=display:flex><span>dig +short g.pigsty.cc
</span></span></code></pre></div><h3 id=第三步申请证书>第三步：申请证书</h3><p><strong>交互式方式：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>certbot --nginx -d pigsty.cc -d g.pigsty.cc -d p.pigsty.cc -d a.pigsty.cc
</span></span></code></pre></div><p><strong>非交互式方式：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>certbot --nginx --agree-tos --email admin@pigsty.cc -n <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -d pigsty.cc -d g.pigsty.cc -d p.pigsty.cc -d a.pigsty.cc
</span></span></code></pre></div><h3 id=第四步nginx-配置>第四步：Nginx 配置</h3><p>在 portal 条目中添加 <code>certbot: &lt;证书名称></code> 参数（例如 <code>certbot: pigsty-prod</code>），然后重新生成配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t nginx_config,nginx_launch
</span></span></code></pre></div><h3 id=第五步自动续期>第五步：自动续期</h3><p>测试续期（预演模式）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>certbot renew --dry-run
</span></span></code></pre></div><p>设置 cron 定时任务（每月 1 日凌晨 2 点）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#0000cf;font-weight:700>0</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#0000cf;font-weight:700>1</span> * * certbot renew --quiet
</span></span></code></pre></div><p>或启用 systemd 定时器：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl <span style=color:#204a87>enable</span> certbot.timer
</span></span></code></pre></div><hr><h2 id=管理命令>管理命令</h2><h3 id=certbot-命令>Certbot 命令</h3><table class=full-width><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td><code>certbot certificates</code></td><td>列出所有证书</td></tr><tr><td><code>certbot renew --cert-name domain.com</code></td><td>续期指定证书</td></tr><tr><td><code>certbot delete --cert-name domain.com</code></td><td>删除证书</td></tr><tr><td><code>certbot revoke --cert-path /path/to/cert.pem</code></td><td>吊销证书</td></tr></tbody></table><h3 id=openssl-命令>OpenSSL 命令</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看证书详情</span>
</span></span><span style=display:flex><span>openssl x509 -in files/pki/ca/ca.crt -text -noout
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看证书过期时间</span>
</span></span><span style=display:flex><span>openssl x509 -in files/pki/pgsql/pg-meta-1.crt -enddate -noout
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 验证证书是否由 CA 签发</span>
</span></span><span style=display:flex><span>openssl verify -CAfile files/pki/ca/ca.crt files/pki/pgsql/pg-meta-1.crt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查证书链</span>
</span></span><span style=display:flex><span>openssl s_client -connect 10.10.10.10:5432 -starttls postgres &lt;/dev/null
</span></span></code></pre></div><hr><h2 id=故障排查>故障排查</h2><table class=full-width><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td>证书过期</td><td>重新运行 playbook 重新生成，或使用 <code>cert.yml</code></td></tr><tr><td>CA 不被信任</td><td>在客户端安装 CA 证书（参见信任 CA 章节）</td></tr><tr><td>域名无法访问</td><td>验证 DNS 传播是否完成</td></tr><tr><td>端口 80 被阻止</td><td>确保 Let&rsquo;s Encrypt 验证时端口 80 开放</td></tr><tr><td>请求频率限制</td><td>避免短时间内多次申请 Let&rsquo;s Encrypt 证书</td></tr><tr><td>权限被拒绝</td><td>检查文件权限（密钥：0600，证书：0644）</td></tr></tbody></table><hr><h2 id=最佳实践>最佳实践</h2><ul><li><strong>备份 CA 密钥</strong>：将 <code>files/pki/ca/ca.key</code> 安全地离线存储</li><li><strong>使用适当的有效期</strong>：nginx 用短期（浏览器兼容），内部服务用长期</li><li><strong>轮换证书</strong>：定期重新运行 playbook 刷新证书</li><li><strong>监控过期</strong>：设置证书过期告警</li><li><strong>公网用 Let&rsquo;s Encrypt</strong>：内部用自签名，公网服务用真实证书</li><li><strong>记录配置</strong>：跟踪哪些服务使用哪些证书</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c91827b2709e7c2e7f7afc8662f9e0bf>6 - Grafana 高可用部署：使用 PostgreSQL 后端数据库</h1><div class=lead>使用 PostgreSQL 而不是 SQLite 作为 Grafana 后端使用的远程存储数据库，获取更好的性能与可用性。</div><p>您可以使用 PostgreSQL 作为 Grafana 后端使用的数据库。</p><p>这是了解Pigsty部署系统使用方式的好机会，完成此教程，您会了解：</p><ul><li>如何 <a href=#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4>创建新数据库集群</a></li><li>如何在已有数据库集群中 <a href=#%E5%88%9B%E5%BB%BAgrafana%E4%B8%9A%E5%8A%A1%E7%94%A8%E6%88%B7>创建新业务用户</a></li><li>如何在已有数据库集群中 <a href=#%E5%88%9B%E5%BB%BAgrafana%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93>创建新业务数据库</a></li><li>如何 <a href=#%E4%BD%BF%E7%94%A8grafana%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93>访问Pigsty所创建的数据库</a></li><li>如何 <a href=#%E7%AE%A1%E7%90%86grafana%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF>管理Grafana中的监控面板</a></li><li>如何管理Grafana中的 <a href=#%E7%AE%A1%E7%90%86postgres%E6%95%B0%E6%8D%AE%E6%BA%90>PostgreSQL数据源</a></li><li>如何一步到位完成 <a href=#%E4%B8%80%E6%AD%A5%E5%88%B0%E4%BD%8D%E6%9B%B4%E6%96%B0grafana>Grafana数据库升级</a></li></ul><hr><h2 id=太长不看>太长不看</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vi pigsty.yml <span style=color:#8f5902;font-style:italic># 取消注释DB/User定义：dbuser_grafana  grafana </span>
</span></span><span style=display:flex><span>bin/pgsql-user  pg-meta  dbuser_grafana
</span></span><span style=display:flex><span>bin/pgsql-db    pg-meta  grafana
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana -c <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#39;CREATE TABLE t(); DROP TABLE t;&#39;</span> <span style=color:#8f5902;font-style:italic># 检查连接串可用性</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>vi /etc/grafana/grafana.ini <span style=color:#8f5902;font-style:italic># 修改 [database] type url</span>
</span></span><span style=display:flex><span>systemctl restart grafana-server
</span></span></code></pre></div><hr><h2 id=创建数据库集群>创建数据库集群</h2><p>我们可以在<code>pg-meta</code>上定义一个新的数据库<code>grafana</code>，也可以在新的机器节点上创建一个专用于Grafana的数据库集群：<code>pg-grafana</code></p><h3 id=定义集群>定义集群</h3><p>如果需要创建新的专用数据库集群<code>pg-grafana</code>，部署在<code>10.10.10.11</code>，<code>10.10.10.12</code>两台机器上，可以使用以下配置文件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-grafana</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> 
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-grafana</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_grafana</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_grafana</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Grafana</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=创建集群>创建集群</h3><p>使用以下命令完成数据库集群<code>pg-grafana</code>的创建：<a href=/docs/pgsql/playbook#pgsqlyml><code>pgsql.yml</code></a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-grafana    <span style=color:#8f5902;font-style:italic># 初始化pg-grafana集群</span>
</span></span></code></pre></div><p>该命令是 Ansible Playbook <a href=/docs/pgsql/playbook#pgsqlyml><code>pgsql.yml</code></a>，用于创建数据库集群。</p><p>定义在 <a href=/docs/pgsql/param#pg_users><code>pg_users</code></a> 与 <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> 中的业务用户与业务数据库会在集群初始化时自动创建，因此使用该配置时，集群创建完毕后，（在没有DNS支持的情况下）您可以使用以下连接串 <a href=/docs/concept/sec/ac>访问</a> 数据库（任一即可）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.11:5432/grafana <span style=color:#8f5902;font-style:italic># 主库直连</span>
</span></span><span style=display:flex><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.11:5436/grafana <span style=color:#8f5902;font-style:italic># 直连default服务</span>
</span></span><span style=display:flex><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.11:5433/grafana <span style=color:#8f5902;font-style:italic># 连接串读写服务</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.12:5432/grafana <span style=color:#8f5902;font-style:italic># 主库直连</span>
</span></span><span style=display:flex><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.12:5436/grafana <span style=color:#8f5902;font-style:italic># 直连default服务</span>
</span></span><span style=display:flex><span>postgres://dbuser_grafana:DBUser.Grafana@10.10.10.12:5433/grafana <span style=color:#8f5902;font-style:italic># 连接串读写服务</span>
</span></span></code></pre></div><p>因为默认情况下Pigsty安装在<strong>单个元节点</strong>上，接下来的步骤我们会在已有的<code>pg-meta</code>数据库集群上创建Grafana所需的用户与数据库，而并非使用这里创建的<code>pg-grafana</code>集群。</p><hr><h2 id=创建grafana业务用户>创建Grafana业务用户</h2><p>通常业务对象管理的惯例是：先创建用户，再创建数据库。
因为如果为数据库配置了<code>owner</code>，数据库对相应的用户存在依赖。</p><h3 id=定义用户>定义用户</h3><p>要在<code>pg-meta</code>集群上创建用户<code>dbuser_grafana</code>，首先将以下用户定义添加至<code>pg-meta</code>的 <a href=#%E5%AE%9A%E4%B9%89%E9%9B%86%E7%BE%A4>集群定义</a> 中：</p><p>添加位置：<code>all.children.pg-meta.vars.pg_users</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_grafana</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Grafana</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>如果您在这里定义了不同的密码，请在后续步骤中将相应参数替换为新密码</p></blockquote><h3 id=创建用户>创建用户</h3><p>使用以下命令完成<code>dbuser_grafana</code>用户的创建（任一均可）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_grafana <span style=color:#8f5902;font-style:italic># 在pg-meta集群上创建`dbuser_grafana`用户</span>
</span></span></code></pre></div><p>实际上调用了 Ansible Playbook <a href=/docs/pgsql/playbook#pgsql-useryml><code>pgsql-user.yml</code></a> 创建用户</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l pg-meta -e <span style=color:#000>pg_user</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_grafana  <span style=color:#8f5902;font-style:italic># Ansible</span>
</span></span></code></pre></div><p><code>dbrole_admin</code> 角色具有在数据库中执行DDL变更的权限，这正是Grafana所需要的。</p><hr><h2 id=创建grafana业务数据库>创建Grafana业务数据库</h2><h3 id=定义数据库>定义数据库</h3><p>创建业务数据库的方式与业务用户一致，首先在<code>pg-meta</code>的集群定义中添加新数据库<code>grafana</code>的 <a href=#%E5%AE%9A%E4%B9%89%E9%9B%86%E7%BE%A4>定义</a>。</p><p>添加位置：<code>all.children.pg-meta.vars.pg_databases</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana, owner: dbuser_grafana, revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=创建数据库>创建数据库</h3><p>使用以下命令完成<code>grafana</code>数据库的创建（任一均可）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta grafana <span style=color:#8f5902;font-style:italic># 在`pg-meta`集群上创建`grafana`数据库</span>
</span></span></code></pre></div><p>实际上调用了 Ansible Playbook <a href=/docs/pgsql/playbook#pgsql-dbyml><code>pgsql-db.yml</code></a> 创建数据库</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l pg-meta -e <span style=color:#000>pg_database</span><span style=color:#ce5c00;font-weight:700>=</span>grafana <span style=color:#8f5902;font-style:italic># 实际执行的Ansible剧本</span>
</span></span></code></pre></div><hr><h2 id=使用grafana业务数据库>使用Grafana业务数据库</h2><h3 id=检查连接串可达性>检查连接串可达性</h3><p>您可以使用不同的 <a href=/docs/concept/ha/svc>服务</a> 或 <a href=/docs/concept/sec/ac>接入</a> 方式访问数据库，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres://dbuser_grafana:DBUser.Grafana@meta:5432/grafana <span style=color:#8f5902;font-style:italic># 直连</span>
</span></span><span style=display:flex><span>postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana <span style=color:#8f5902;font-style:italic># default服务</span>
</span></span><span style=display:flex><span>postgres://dbuser_grafana:DBUser.Grafana@meta:5433/grafana <span style=color:#8f5902;font-style:italic># primary服务</span>
</span></span></code></pre></div><p>这里，我们将使用通过负载均衡器直接访问主库的 <a href=/docs/pgsql/service#default%E6%9C%8D%E5%8A%A1>Default服务</a> 访问数据库。</p><p>首先检查连接串是否可达，以及是否有权限执行DDL命令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana -c <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  <span style=color:#4e9a06>&#39;CREATE TABLE t(); DROP TABLE t;&#39;</span>
</span></span></code></pre></div><h3 id=直接修改grafana配置>直接修改Grafana配置</h3><p>为了让Grafana使用 Postgres 数据源，您需要编辑 <code>/etc/grafana/grafana.ini</code>，并修改配置项：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[database]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>;type = sqlite3</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>;host = 127.0.0.1:3306</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>;name = grafana</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>;user = root</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># If the password contains # or ; you have to wrap it with triple quotes. Ex &#34;&#34;&#34;#password;&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>;password =</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>;url =</span>
</span></span></code></pre></div><p>将默认的配置项修改为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#204a87;font-weight:700>[database]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>type</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>postgres</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>url</span> <span style=color:#ce5c00;font-weight:700>=</span>  <span style=color:#4e9a06>postgres://dbuser_grafana:DBUser.Grafana@meta/grafana</span>
</span></span></code></pre></div><p>随后重启Grafana即可：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart grafana-server
</span></span></code></pre></div><p>从监控系统中看到新增的 <a href="http://g.pigsty.cc/d/pgsql-database/pgsql-database?var-cls=pg-meta&amp;var-ins=pg-meta-1&amp;var-datname=grafana&amp;orgId=1"><code>grafana</code></a> 数据库已经开始有活动，则说明Grafana已经开始使用Postgres作为首要后端数据库了。
但一个新的问题是，Grafana中原有的Dashboards与Datasources都消失了！这里需要重新导入 <a href=#%E7%AE%A1%E7%90%86grafana%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF>监控面板</a> 与 <a href=#%E7%AE%A1%E7%90%86postgres%E6%95%B0%E6%8D%AE%E6%BA%90>Postgres数据源</a></p><hr><h2 id=管理grafana监控面板>管理Grafana监控面板</h2><p>您可以使用管理用户前往 Pigsty 目录下的 <code>files/grafana</code> 目录，执行 <code>grafana.py init</code> 重新加载 Pigsty 监控面板。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty/files/grafana
</span></span><span style=display:flex><span>./grafana.py init    <span style=color:#8f5902;font-style:italic># 使用当前目录下的Dashboards初始化Grafana监控面板</span>
</span></span></code></pre></div><p>执行结果：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant@meta:~/pigsty/files/grafana
</span></span><span style=display:flex><span>$ ./grafana.py init
</span></span><span style=display:flex><span>Grafana API: admin:pigsty @ http://10.10.10.10:3000
</span></span><span style=display:flex><span>init dashboard : home.json
</span></span><span style=display:flex><span>init folder pgcat
</span></span><span style=display:flex><span>init dashboard: pgcat / pgcat-table.json
</span></span><span style=display:flex><span>init dashboard: pgcat / pgcat-bloat.json
</span></span><span style=display:flex><span>init dashboard: pgcat / pgcat-query.json
</span></span><span style=display:flex><span>init folder pgsql
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-replication.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-table.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-activity.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-cluster.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-node.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-database.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-xacts.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-overview.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-session.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-tables.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-instance.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-queries.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-alert.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-service.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-persist.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-proxy.json
</span></span><span style=display:flex><span>init dashboard: pgsql / pgsql-query.json
</span></span><span style=display:flex><span>init folder pglog
</span></span><span style=display:flex><span>init dashboard: pglog / pglog-instance.json
</span></span><span style=display:flex><span>init dashboard: pglog / pglog-analysis.json
</span></span><span style=display:flex><span>init dashboard: pglog / pglog-session.json
</span></span></code></pre></div><p>该脚本会通过 Grafana API 导入仪表盘。你可以使用环境变量显式指定 Grafana 访问参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GRAFANA_ENDPOINT</span><span style=color:#ce5c00;font-weight:700>=</span>http://10.10.10.10:3000
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GRAFANA_USERNAME</span><span style=color:#ce5c00;font-weight:700>=</span>admin
</span></span><span style=display:flex><span><span style=color:#204a87>export</span> <span style=color:#000>GRAFANA_PASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>pigsty
</span></span></code></pre></div><p>题外话，使用<code>grafana.py clean</code>会清空目标监控面板，使用<code>grafana.py load</code>会加载当前目录下所有监控面板，当Pigsty的监控面板发生变更，可以使用这两个命令升级所有的监控面板。</p><h2 id=管理postgres数据源>管理Postgres数据源</h2><p>当使用 <a href=/docs/pgsql/playbook#pgsqlyml><code>pgsql.yml</code></a> 创建新 PostgreSQL 集群，或使用 <a href=/docs/pgsql/playbook#pgsql-dbyml><code>pgsql-db.yml</code></a> 创建新业务数据库时，Pigsty会在Grafana中注册新的PostgreSQL数据源，您可以使用默认的监控用户通过Grafana直接访问目标数据库实例。应用<code>pgcat</code>的绝大部分功能有赖于此。</p><p>要注册 Postgres 数据库数据源，可以使用 <a href=/docs/pgsql/playbook#pgsqlyml><code>pgsql.yml</code></a> 中的 <code>add_ds</code> 任务（或使用更全面的 <code>pg_register</code>）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t add_ds             <span style=color:#8f5902;font-style:italic># 重新注册当前环境中所有 PostgreSQL 数据源</span>
</span></span><span style=display:flex><span>./pgsql.yml -t add_ds -l pg-test  <span style=color:#8f5902;font-style:italic># 仅重新注册 pg-test 集群的数据源</span>
</span></span></code></pre></div><hr><h2 id=一步到位更新grafana>一步到位更新Grafana</h2><p>您可以直接通过修改 Pigsty 配置文件，更改 Grafana 使用的后端数据源，一步到位的完成切换 Grafana 后端数据库的工作。编辑 <code>pigsty.yml</code> 中 <a href=/docs/infra/param#grafana_pgurl><code>grafana_pgurl</code></a> 参数，将其修改为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>grafana_pgurl</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>然后重新执行 <a href=/docs/infra/playbook#infrayml><code>infra.yml</code></a> 中的 <code>grafana</code> 任务，即可完成 Grafana 升级</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -t grafana
</span></span></code></pre></div></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>