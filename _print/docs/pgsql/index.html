<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/pgsql/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/pgsql/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>模块：PGSQL | PIGSTY</title><meta name=description content="如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！"><meta property="og:url" content="https://pigsty.cc/docs/pgsql/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="模块：PGSQL"><meta property="og:description" content="如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="模块：PGSQL"><meta itemprop=description content="如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！"><meta itemprop=dateModified content="2026-02-09T18:40:32+08:00"><meta itemprop=wordCount content="268"><meta itemprop=keywords content="参考,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="模块：PGSQL"><meta name=twitter:description content="如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/pgsql/>返回本页常规视图</a>.</p></div><h1 class=title>模块：PGSQL</h1><div class=lead>如何使用 Pigsty 部署并管理世界上最先进的开源关系型数据库 —— PostgreSQL，按需定制，开箱即用！</div><ul><li>1: <a href=#pg-9dfef2dab7a4f2eb42759587047ed179>配置指南</a></li><li>2: <a href=#pg-bf8af5ce90608b25fe15dcd42ae6f786>集群配置</a></li><ul><li>2.1: <a href=#pg-01e9f6eb810a0f6072913a962bfd631d>集群实例</a></li><li>2.2: <a href=#pg-64c78407e33d191b14a78a9a03369255>内核版本</a></li><li>2.3: <a href=#pg-ad5d6482cea01b850636a3033b3ec973>别名翻译</a></li><li>2.4: <a href=#pg-f3a29e30e1bcb1622450d4b2d3604bdc>用户/角色</a></li><li>2.5: <a href=#pg-662c4a4a95a52da3073eeed2f4407af9>数据库</a></li><li>2.6: <a href=#pg-be500246ccc4d0aea19a8d2e848cf128>HBA 规则</a></li><li>2.7: <a href=#pg-ff84fb35cef7a71a971ba3fb6712ed0c>参数配置</a></li><li>2.8: <a href=#pg-f26623b2f855e9bc5073aeb50aea422a>访问控制</a></li></ul><li>3: <a href=#pg-a5ab1e936057c396561d23f099852606>服务/接入</a></li><ul></ul><li>4: <a href=#pg-52d6aa237ebdf1b892ae495c94936fe3>访问控制</a></li><ul></ul><li>5: <a href=#pg-3d5c83e1f406be878a7cbcafe1e9c234>管理任务</a></li><li>6: <a href=#pg-48b1bc6613befa103400a3961be086ff>日常管理</a></li><ul><li>6.1: <a href=#pg-17b67ff7274e6ed5025cdb1b71ec35a4>管理 PostgreSQL 数据库集群</a></li><li>6.2: <a href=#pg-81e255f632d154a2662d19c783c4514a>管理 PostgreSQL 业务用户</a></li><li>6.3: <a href=#pg-9dd15cada3b5a59a9375eadbdeec7bf7>管理 PostgreSQL 业务数据库</a></li><li>6.4: <a href=#pg-0cd896e3522e4cf2db0a08ece91619f5>管理 Patroni 高可用</a></li><li>6.5: <a href=#pg-289eefb8da504803e0c1952004777bb0>Pgbouncer 连接池管理</a></li><li>6.6: <a href=#pg-ef5d737e5bae0aa77e9e8e5340965fd9>管理 PostgreSQL 组件服务</a></li><li>6.7: <a href=#pg-d6d9a4c3d54ca40e435a862870043f19>管理 PostgreSQL 定时任务</a></li><li>6.8: <a href=#pg-fda28727166c3a3a755b7258c9071594>升级 PostgreSQL 大小版本</a></li><li>6.9: <a href=#pg-2b2e08d4aed2707846688f2a5517519d>管理 PostgreSQL 扩展插件</a></li></ul><li>7: <a href=#pg-efb2d1006e9f523db1ec2975456da71f>备份恢复</a></li><ul><li>7.1: <a href=#pg-4c34e733cec9746048fccac02c01fd36>备份策略</a></li><li>7.2: <a href=#pg-931bd9f9bf4846ff58a1265e886414d1>备份机制</a></li><li>7.3: <a href=#pg-e2aad9fad6e8fd1fba46059ad4ea7613>备份仓库</a></li><li>7.4: <a href=#pg-bd9fc4fbfbb9e33698d751afa14c6077>管理命令</a></li><li>7.5: <a href=#pg-ee98f0d297c9a6847c501efbbbed8fa6>恢复操作</a></li><li>7.6: <a href=#pg-f811d9356784e47cdedcf860a7ba394a>克隆数据库集群</a></li></ul><li>8: <a href=#pg-9f140ff0db86673b0d243757b9f578fc>数据迁移</a></li><ul></ul><li>9: <a href=#pg-30aee675be8bae1bfec9459ffb30d160>任务教程</a></li><ul><li>9.1: <a href=#pg-39a4da4f2254a96928c0e56a6cb63c63>故障排查</a></li><li>9.2: <a href=#pg-e6716a8d517caddd0851177927c9c69c>误删处理</a></li><li>9.3: <a href=#pg-23871ed725b644a5e3d037862c0c13aa>手工恢复</a></li><li>9.4: <a href=#pg-febcd9ad443b4eae6bee9e48b3f2d10e>利用 xfs 实现实例 Fork</a></li><li>9.5: <a href=#pg-ec3ed8119ef85413c277384f41ca7b27>为 PostgreSQL 集群启用 HugePage</a></li><li>9.6: <a href=#pg-677d9d9a118e237b46693da04151cde7>3坏2应急处理</a></li><li>9.7: <a href=#pg-b4eeb541b5d47f6b2e5017106913ea72>使用 VIP-Manager 为 PostgreSQL 集群配置二层 VIP</a></li><li>9.8: <a href=#pg-1a6ecaf250187005e255b6c6eafd53e2>Citus 集群部署</a></li></ul><li>10: <a href=#pg-ecaf10982eb41799d970bf83186f0f12>参考资料</a></li><li>11: <a href=#pg-318a92a644bd3692615ad49e01f0f4e1>监控系统</a></li><ul></ul><li>12: <a href=#pg-a794a26bf3d40b2536adae3b38d29ef6>监控面板</a></li><ul><li>12.1: <a href=#pg-c580a7d5af0c814a622cd05d2217ea00>总览面板</a></li><ul><li>12.1.1: <a href=#pg-98c77cd5a40440bd2142743d9aa7e924>PGSQL Overview</a></li><li>12.1.2: <a href=#pg-c0d2340d281acc8b5f2c5c898b37729d>PGSQL Alert</a></li><li>12.1.3: <a href=#pg-c7ea59a32ca19d6b135cb915d738ec5f>PGSQL Shard</a></li></ul><li>12.2: <a href=#pg-71d11dac090b2845d43964a086c029e7>集群面板</a></li><ul><li>12.2.1: <a href=#pg-ac13540d2c30a80f1d60794c913740ab>PGSQL Cluster</a></li><li>12.2.2: <a href=#pg-777b02cba7b02a268aecc27250e0815d>PGRDS Cluster</a></li><li>12.2.3: <a href=#pg-f593ebcf5a965df4fb71075741e2b77e>PGSQL Activity</a></li><li>12.2.4: <a href=#pg-fc20a0ddfc32761378480d5e1617d77f>PGSQL Replication</a></li><li>12.2.5: <a href=#pg-5be6c72f3740f9ca61bbab9d0fb51474>PGSQL Service</a></li><li>12.2.6: <a href=#pg-49c9b74c56a741db1e680ea66c062840>PGSQL Databases</a></li><li>12.2.7: <a href=#pg-7c90bff16bde850becbc89a8ff49fa4d>PGSQL Patroni</a></li><li>12.2.8: <a href=#pg-3c35cf3066a9271b66140e3ae546cc97>PGSQL PITR</a></li></ul><li>12.3: <a href=#pg-0d3b46a9e4488b08a97e5a2cd93e8342>实例面板</a></li><ul><li>12.3.1: <a href=#pg-efab5aa64980fd75bc6e3faafa448046>PGSQL Instance</a></li><li>12.3.2: <a href=#pg-745f68183713f01820b7036ca02434dc>PGRDS Instance</a></li><li>12.3.3: <a href=#pg-cc7ae26f510c83819e09f711ea4efd4c>PGCAT Instance</a></li><li>12.3.4: <a href=#pg-7e14c54a9f928b5211431714593ff1d7>PGSQL Persist</a></li><li>12.3.5: <a href=#pg-ab6bcd147d1f1aadd3cac0741c8d3885>PGSQL Proxy</a></li><li>12.3.6: <a href=#pg-7650b8f9f3f719c7343b60768a765bbe>PGSQL Pgbouncer</a></li><li>12.3.7: <a href=#pg-ca5931906d508cd9f75edfe7218e753c>PGSQL Session</a></li><li>12.3.8: <a href=#pg-9d9def57863d569d20a7a3193aa26c93>PGSQL Xacts</a></li><li>12.3.9: <a href=#pg-f25ea8d94e36ba9a5b3676cb12633bf2>PGSQL Exporter</a></li></ul><li>12.4: <a href=#pg-5ab1262c99945ca6857061b54141248e>数据库面板</a></li><ul><li>12.4.1: <a href=#pg-8c17cc1092ed2d1e76d0b7d93b35bbf1>PGSQL Database</a></li><li>12.4.2: <a href=#pg-0ecd8fa92a2426ecb8dc9ceaff62f45b>PGCAT Database</a></li><li>12.4.3: <a href=#pg-357ff5497ef591ed19467aefaaf30b9d>PGSQL Tables</a></li><li>12.4.4: <a href=#pg-f9982c1d8e0198daa19cb19992ddc73b>PGSQL Table</a></li><li>12.4.5: <a href=#pg-c99501fec4430d07944e241ee98f8712>PGCAT Table</a></li><li>12.4.6: <a href=#pg-8cf1de3a04204d7b46c3b3846c17a033>PGSQL Query</a></li><li>12.4.7: <a href=#pg-0e025bec035b17c9d59be41163595514>PGCAT Query</a></li><li>12.4.8: <a href=#pg-0e05e1ef2b7aebfa9cc6f51275cc6cd8>PGCAT Locks</a></li><li>12.4.9: <a href=#pg-eba5c01f53f336bd71d4a7391ec48511>PGCAT Schema</a></li></ul></ul><li>13: <a href=#pg-1f69b3f46163cb973f38581bf88a88a8>指标列表</a></li><li>14: <a href=#pg-aecdecaf4fe39eee883ee97a664ab88f>参数列表</a></li><ul></ul><li>15: <a href=#pg-091b9f18681382583303e1ac5c7cea55>预置剧本</a></li><li>16: <a href=#pg-f11dbaecba8ffad62c75360642541598>扩展插件</a></li><ul><li>16.1: <a href=#pg-cb575384aee4c018fb0db527378640fd>快速开始</a></li><li>16.2: <a href=#pg-37c08dbc246cb158947abfb17f172ecc>扩展简介</a></li><li>16.3: <a href=#pg-6c21bc6ef6cf2173aeb9948071de953f>软件包</a></li><li>16.4: <a href=#pg-96a6a67c2f3d2429fabeed6f98b76c7f>下载扩展</a></li><li>16.5: <a href=#pg-128bcfdba2d6b955af1661f0a806fd9e>安装扩展</a></li><li>16.6: <a href=#pg-8c405665bb423ccc536997bd9c3a64ca>配置扩展</a></li><li>16.7: <a href=#pg-5b462599a5e29b51a35ede5bb5e310a8>启用扩展</a></li><li>16.8: <a href=#pg-aeb68b34de12844024f2519dd13df6f0>更新扩展</a></li><li>16.9: <a href=#pg-13869765de25ae294c556ad54ac4ee27>移除扩展</a></li><li>16.10: <a href=#pg-cd40e09e16b398209123543c21e68960>默认扩展</a></li><li>16.11: <a href=#pg-fef9a9d4af92d185f18fab30d92a530d>扩展仓库</a></li></ul><li>17: <a href=#pg-a670d0bcea1364c05aff52997d9cdc42>场景模板</a></li><ul><li>17.1: <a href=#pg-c343b4e12cd241ebdb244700f6f7ae20>默认配置模板的参数优化策略说明</a></li><li>17.2: <a href=#pg-04bbfb111fd00b28b14a77c5a5a92955>OLTP 模板</a></li><li>17.3: <a href=#pg-571aa5133064fa24ac707a69e4d84659>OLAP 模板</a></li><li>17.4: <a href=#pg-7cf828587f72da3b425e1bd025ccbacf>CRIT 模板</a></li><li>17.5: <a href=#pg-609856237df74f1f0f6e5fba1111e545>TINY 模板</a></li></ul><li>18: <a href=#pg-08a8dc2fb6ea8fd6936acfdf250bdc97>内核分支</a></li><ul><li>18.1: <a href=#pg-6b647bd80a1130f992c12a77393a87c3>PostgreSQL</a></li><li>18.2: <a href=#pg-2f9342f89a206383c945315b79c7967f>Supabase</a></li><li>18.3: <a href=#pg-7200791b1d0ca9c1c30f1e8d7dc9ece2>Citus</a></li><li>18.4: <a href=#pg-86f570780ad542823d4ed958af36ce0f>Babelfish</a></li><li>18.5: <a href=#pg-d4592799fc81bf53d57e017444a325f6>IvorySQL</a></li><li>18.6: <a href=#pg-293b566be2331c0d55a3457bdfb0a860>PolarDB PG</a></li><li>18.7: <a href=#pg-ffed78d77ebf7627086f9da938f9b9f6>PolarDB Oracle</a></li><li>18.8: <a href=#pg-5e2941fff6b5b682be30d52c9d82b986>Percona</a></li><li>18.9: <a href=#pg-e59a81d2edf1c2072f834e4d8ef376db>PostgresML</a></li><li>18.10: <a href=#pg-8b89390bfb5e407f5413ce18cede184b>OpenHalo</a></li><li>18.11: <a href=#pg-227e1bd7e26827efbe4f8ed91ee4c679>Greenplum</a></li><li>18.12: <a href=#pg-311f723c83095a738bfb441159db0044>OrioleDB</a></li><li>18.13: <a href=#pg-a970dfd99688547f0ffb0bf4d5c4de61>Cloudberry</a></li><li>18.14: <a href=#pg-2342a2eaca8515e616cb1dfa8c4db39d>Neon</a></li></ul><li>19: <a href=#pg-06a73ab7adbd73b0e635c3d9403cab4e>常见问题</a></li><li>20: <a href=#pg-ac541723370b0cdbf999a3eb82ccfc89>其他说明</a></li><ul><li>20.1: <a href=#pg-4d65100b9600fb960eb0de13b0e7c894>用户/角色</a></li><li>20.2: <a href=#pg-e73c12463833eb5e14e27191b7858ef7>数据库</a></li><li>20.3: <a href=#pg-3a18781032fdda789d5f38d1dd1c01a2>服务/接入</a></li><li>20.4: <a href=#pg-ba271faa49ebb08213e3b4f058522cdb>认证 / HBA</a></li><li>20.5: <a href=#pg-0b7772f5fffba0123e7353706362f45e>访问控制</a></li></ul></ul><div class=content><blockquote><p><strong>世界上最先进的开源关系型数据库！</strong></p><p>而 Pigsty 帮它进入全盛状态：开箱即用、可靠、可观测、可维护、可伸缩！ <a href=/docs/pgsql/config>配置</a> | <a href=/docs/pgsql/admin>管理</a> | <a href=/docs/pgsql/playbook>剧本</a> | <a href=/docs/pgsql/monitor>监控</a> | <a href=#%E5%8F%82%E6%95%B0>参数</a></p></blockquote><hr><h2 id=概览>概览</h2><blockquote><p>了解关于 PostgreSQL 的重要主题与概念。</p></blockquote><ul><li><a href=/docs/concept/arch/pgsql>系统架构</a></li><li><a href=/docs/pgsql/config>集群配置</a></li><li><a href=/docs/ref/extension>扩展插件</a></li><li><a href=/docs/pgsql/config/user>用户/角色</a></li><li><a href=/docs/pgsql/config/db>数据库</a></li><li><a href=/docs/pgsql/service/>服务/接入</a></li><li><a href=/docs/pgsql/config/hba>认证/HBA</a></li><li><a href=/docs/concept/sec/ac/>访问控制</a></li><li><a href=/docs/pgsql/admin>管理预案</a></li><li><a href=/docs/pgsql/tutorial/pitr>备份恢复</a></li><li><a href=/docs/pgsql/monitor>监控接入</a></li><li><a href=/docs/pgsql/migration>集群迁移</a></li><li><a href=/docs/pgsql/monitor>仪表盘</a></li></ul><hr><h2 id=配置>配置</h2><blockquote><p><a href=/docs/pgsql/config>描述</a> 你想要的 PostgreSQL 集群</p></blockquote><ul><li><a href=/docs/concept/model/pgsql#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0>身份参数</a>：定义PostgreSQL集群的身份参数</li><li><a href=/docs/pgsql/config/cluster#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93>读写主库</a>：创建由单一主库构成的单实例“集群“</li><li><a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读从库</a>：创建一主一从的两节点基础高可用集群</li><li><a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a>：创建专用于OLAP/ETL/交互式查询的特殊只读实例</li><li><a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a>：启用同步提交，以确保没有数据丢失</li><li><a href=/docs/pgsql/config/cluster#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4>法定人数</a>：使用法定人数同步提交以获得更高的一致性级别</li><li><a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a>：克隆现有集群，并保持同步（异地灾备集群）</li><li><a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟集群</a>：克隆现有集群，并延迟重放，用于紧急数据恢复</li><li><a href=/docs/pgsql/config/cluster#citus%E9%9B%86%E7%BE%A4>Citus集群</a>：定义并创建 Citus 水平分布式数据库集群</li><li><a href=/docs/pgsql/config/kernel#%E5%A4%A7%E7%89%88%E6%9C%AC%E4%B8%8E%E8%BD%AF%E4%BB%B6%E5%8C%85>大版本切换</a>：使用不同的 PostgreSQL 大版本部署集群</li></ul><hr><h2 id=管理>管理</h2><blockquote><p><a href=/docs/pgsql/admin>管理</a> 您所创建的 PostgreSQL 集群。</p></blockquote><ul><li><a href=/docs/pgsql/admin/component#%E5%91%BD%E4%BB%A4%E9%80%9F%E6%9F%A5>命令速查</a></li><li><a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4>创建集群</a></li><li><a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7>创建用户</a></li><li><a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93>创建数据库</a></li><li><a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a></li><li><a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0hba>重载HBA</a></li><li><a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a></li><li><a href=/docs/pgsql/admin/cluster#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4>添加实例</a></li><li><a href=/docs/pgsql/admin/cluster#%E7%BC%A9%E5%AE%B9%E9%9B%86%E7%BE%A4>移除实例</a></li><li><a href=/docs/pgsql/admin/cluster#%E9%94%80%E6%AF%81%E9%9B%86%E7%BE%A4>下线集群</a></li><li><a href=/docs/pgsql/admin/patroni#%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2>主动切换</a></li><li><a href=/docs/pgsql/admin/cluster#%E5%85%8B%E9%9A%86%E9%9B%86%E7%BE%A4>备份集群</a></li><li><a href=/docs/pgsql/backup/restore>恢复集群</a></li><li><a href=/docs/pgsql/faq/>疑难杂症</a></li></ul><hr><h2 id=剧本>剧本</h2><blockquote><p>使用幂等的 <a href=/docs/pgsql/playbook>剧本</a>，将您的描述变为现实。</p></blockquote><ul><li><a href=/docs/pgsql/playbook#pgsqlyml><code>pgsql.yml</code></a> ：初始化PostgreSQL集群或添加新的从库。</li><li><a href=/docs/pgsql/playbook#pgsql-rmyml><code>pgsql-rm.yml</code></a> ：移除PostgreSQL集群，或移除某个实例</li><li><a href=/docs/pgsql/playbook#pgsql-useryml><code>pgsql-user.yml</code></a> ：在现有的PostgreSQL集群中添加新的业务用户</li><li><a href=/docs/pgsql/playbook#pgsql-dbyml><code>pgsql-db.yml</code></a> ：在现有的PostgreSQL集群中添加新的业务数据库</li><li><a href=/docs/pgsql/playbook#pgsql-monitoryml><code>pgsql-monitor.yml</code></a> ：将远程postgres实例纳入监控中</li><li><a href=/docs/pgsql/playbook#pgsql-migrationyml><code>pgsql-migration.yml</code></a> ：为现有的PostgreSQL集群生成迁移手册和脚本</li></ul><hr><h2 id=监控>监控</h2><blockquote><p>在 Grafana <a href=/docs/pgsql/monitor>仪表盘</a> 中查阅 PostgreSQL 的详情状态。</p></blockquote><p>在 Pigsty 中共有 26 个与 PostgreSQL 相关的监控面板：</p><table><thead><tr><th style=text-align:center>总览</th><th style=text-align:center>集群</th><th style=text-align:center>实例</th><th style=text-align:center>数据库</th></tr></thead><tbody><tr><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-overview>PGSQL Overview</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-cluster>PGSQL Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-instance>PGSQL Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-database>PGSQL Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-alert>PGSQL Alert</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgrds-cluster>PGRDS Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgrds-instance>PGRDS Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-database>PGCAT Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-shard>PGSQL Shard</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-activity>PGSQL Activity</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-instance>PGCAT Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-tables>PGSQL Tables</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-replication>PGSQL Replication</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-persist>PGSQL Persist</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-table>PGSQL Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-service>PGSQL Service</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-proxy>PGSQL Proxy</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-table>PGCAT Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-databases>PGSQL Databases</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-pgbouncer>PGSQL Pgbouncer</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-query>PGSQL Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-patroni>PGSQL Patroni</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-session>PGSQL Session</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-query>PGCAT Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-pitr>PGSQL PITR</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-xacts>PGSQL Xacts</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-locks>PGCAT Locks</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-exporter>PGSQL Exporter</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-schema>PGCAT Schema</a></td></tr></tbody></table><hr><h2 id=参数>参数</h2><blockquote><p><a href=/docs/pgsql/param>PGSQL</a> 模块的配置参数列表</p></blockquote><ul><li><a href=/docs/pgsql/param#pg_id><code>PG_ID</code></a> : 计算和校验 PostgreSQL 实例身份</li><li><a href=/docs/pgsql/param#pg_business><code>PG_BUSINESS</code></a> : PostgreSQL业务对象定义</li><li><a href=/docs/pgsql/param#pg_install><code>PG_INSTALL</code></a> : 安装 PostgreSQL 内核，支持软件包与扩展插件</li><li><a href=/docs/pgsql/param#pg_bootstrap><code>PG_BOOTSTRAP</code></a> : 使用 Patroni 初始化高可用 PostgreSQL 集群</li><li><a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a> : 创建 PostgreSQL 用户、数据库和其他数据库内对象</li><li><a href=/docs/pgsql/param#pg_backup><code>PG_BACKUP</code></a> : 使用 pgbackrest 设置备份仓库</li><li><a href=/docs/pgsql/param#pg_access><code>PG_ACCESS</code></a> : 暴露 PostgreSQL 服务，绑定 VIP （可选），以及注册DNS</li><li><a href=/docs/pgsql/param#pg_monitor><code>PG_MONITOR</code></a> : 为 PostgreSQL 实例添加监控，并注册至基础设施中。</li><li><a href=/docs/pgsql/param#pg_remove><code>PG_REMOVE</code></a> : 移除 PostgreSQL 集群，实例和相关资源。</li></ul><hr><h2 id=教程>教程</h2><blockquote><p>一些使用/管理 Pigsty中 PostgreSQL 数据库的教程。</p></blockquote><ul><li>克隆一套现有的 PostgreSQL 集群</li><li>创建一套现有 PostgreSQL 集群的在线备份集群。</li><li>创建一套现有 PostgreSQL 集群的延迟备份集群</li><li>监控一个已有的 postgres 实例？</li><li>使用逻辑复制从外部 PostgreSQL 迁移至 Pigsty 托管的 PostgreSQL 实例？</li><li>使用 MinIO 作为集中的 pgBackRest 备份仓库。</li><li>使用专门的 etcd 集群作为 PostgreSQL / Patroni 的 DCS ？</li><li>使用专用的 haproxy 负载均衡器集群对外暴露暴露 PostgreSQL 服务。</li><li>使用 pg-meta CMDB 替代 pigsty.yml 作为配置清单源。</li><li>使用 PostgreSQL 作为 Grafana 的后端存储数据库？</li><li>使用 PostgreSQL 作为 Prometheus 后端存储数据库？</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-9dfef2dab7a4f2eb42759587047ed179>1 - 配置指南</h1></div><div class=td-content style=page-break-before:always><h1 id=pg-bf8af5ce90608b25fe15dcd42ae6f786>2 - 集群配置</h1><div class=lead>根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。</div><p>Pigsty 是一个“配置驱动”的 PostgreSQL 平台：所有行为都来自 <code>~/pigsty/conf/*.yml</code> 清单与 <a href=/docs/pgsql/param><code>PGSQL</code> 参数</a> 的组合。</p><p>只要写好配置，你就能在几分钟内复刻出一套包含实例、用户、数据库、访问控制、扩展与调优策略的定制集群。</p><hr><h2 id=配置入口>配置入口</h2><ol><li><strong>准备清单</strong>：复制 <code>pigsty/conf/*.yml</code> 模板或从零开始编写 Ansible Inventory，将集群分组（<code>all.children.&lt;cls>.hosts</code>）与全局变量（<code>all.vars</code>）写入同一个文件。</li><li><strong>定义参数</strong>：在 <code>vars</code> 区块中覆盖需要的 <a href=/docs/pgsql/param><code>PGSQL</code> 参数</a>。全局 → 集群 → 主机的覆盖顺序决定了最终值。</li><li><strong>应用配置</strong>：运行 <code>./configure -c &lt;conf></code> 或 <code>bin/pgsql-add &lt;cls></code> 等剧本让配置落地。Pigsty 会根据参数生成 Patroni/pgbouncer/pgbackrest 等服务所需的配置文件。</li></ol><p>Pigsty 默认的 Demo 清单 <code>conf/pgsql.yml</code> 就是一份最小化示例：一个 <code>pg-meta</code> 集群、全局 <code>pg_version: 18</code>、少量业务用户与数据库定义。你可以在此基础上扩展更多集群。</p><hr><h2 id=关注点与文档索引>关注点与文档索引</h2><p>Pigsty 的 PostgreSQL 配置可以从以下几个维度组合，后续文档会逐一展开“如何配置”：</p><ul><li><strong><a href=/docs/pgsql/config/cluster>集群实例</a></strong>：通过 <code>pg_cluster / pg_role / pg_seq / pg_upstream</code> 定义实例拓扑（单机、主从、备份集群、延迟集群、Citus 等）。</li><li><strong><a href=/docs/pgsql/config/kernel>内核版本</a></strong>：使用 <code>pg_version</code>、<code>pg_mode</code>、<code>pg_packages</code>、<code>pg_extensions</code>、<code>pg_conf</code> 等参数挑选核心版本、风味和调优模板。</li><li><strong><a href=/docs/pgsql/config/user>用户/角色</a></strong>：在 <code>pg_default_roles</code> 与 <code>pg_users</code> 中声明系统角色、业务账号、密码策略以及连接池属性。</li><li><strong><a href=/docs/pgsql/config/db>数据库对象</a></strong>：借助 <code>pg_databases</code>、<code>baseline</code>、<code>schemas</code>、<code>extensions</code>、<code>pool_*</code> 字段按需创建数据库并自动接入 pgbouncer/Grafana。</li><li><strong><a href=/docs/pgsql/config/hba>访问控制 (HBA)</a></strong>：利用 <code>pg_default_hba_rules</code> 与 <code>pg_hba_rules</code> 维护主机级认证策略，保证不同角色/网络的访问边界。</li><li><strong><a href=/docs/pgsql/config/acl>权限模型 (ACL)</a></strong>：通过 <code>pg_default_privileges</code>、<code>pg_default_roles</code>、<code>pg_revoke_public</code> 等参数收敛对象权限，开箱即用地提供分层角色体系。</li></ul><p>理解这些参数之后，你就可以针对任意业务需求写出“配置即基础设施”的声明式清单，Pigsty 会负责执行并确保幂等。</p><hr><h2 id=一个典型示例>一个典型示例</h2><p>下面的片段展示了如何在同一个配置文件中同时控制实例拓扑、内核版本、扩展、用户以及数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-analytics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica, pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bi, owner: dbuser_bi, schemas: [mart], extensions: [timescaledb], pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_bi, password: DBUser.BI, roles: [dbrole_admin], pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main pgsql-common ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_bi, db: bi, addr: intra, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;BI 只允许内网 SSL 访问&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>pg-analytics</code> 集群包含一个主库和一个离线副本。</li><li>全局指定 <code>pg_version: 17</code> 与一套扩展示例，并加载 <code>olap.yml</code> 调优。</li><li>在 <code>pg_databases</code> 与 <code>pg_users</code> 中声明业务对象，自动生成 schema/extension 与连接池条目。</li><li>附加的 <code>pg_hba_rules</code> 限制了访问来源与认证方式。</li></ul><p>修改并应用这份清单即可得到一套定制化的 PostgreSQL 集群，而无需手工逐项配置。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-01e9f6eb810a0f6072913a962bfd631d>2.1 - 集群实例</h1><div class=lead>根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。</div><blockquote><p>根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。</p></blockquote><p>您可以定义不同类型的实例和集群，下面是 Pigsty 中常见的几种 PostgreSQL 实例/集群类型：</p><ul><li><a href=#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93>读写主库</a>：定义单一实例集群。</li><li><a href=#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读从库</a>：定义具有一个主库和一个副本的基本HA集群。</li><li><a href=#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a>：定义专用于OLAP/ETL/交互式查询的实例</li><li><a href=#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a>：启用同步提交以确保没有数据丢失。</li><li><a href=#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4>法定人数提交</a>：使用多数同步提交获得更高的一致性级别。</li><li><a href=#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a>：克隆现有集群并跟随它</li><li><a href=#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟集群</a>：克隆现有集群用于紧急数据恢复</li><li><a href=#citus%E9%9B%86%E7%BE%A4>Citus集群</a>：定义一个Citus分布式数据库集群</li></ul><hr><h2 id=读写主库>读写主库</h2><p>我们从最简单的情况开始：由一个主库（Primary）组成的单实例集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这段配置言简意赅，自我描述，仅由 <a href=/docs/concept/model/pgsql#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 构成，请注意 Ansible Group 分组名应当与 <a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a> 保持一致。</p><p>使用以下命令创建该集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test
</span></span></code></pre></div><p>Demo展示，开发测试，承载临时需求，进行无关紧要的计算分析任务时，使用单一数据库实例可能并没有太大问题。但这样的单机集群没有 <a href=/docs/concept/ha>高可用</a>，当出现硬件故障时，您需要使用 <a href=/docs/concept/pitr>PITR</a> 或其他恢复手段来确保集群的 RTO / RPO。为此，您可以考虑为集群添加若干个 <a href=#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读从库</a></p><hr><h2 id=只读从库>只读从库</h2><p>要添加一台只读从库（Replica）实例，您可以在 <code>pg-test</code> 中添加一个新节点，并将其 <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> 设置为<code>replica</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 新添加的从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果整个集群不存在，您可以直接 <a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4>创建</a> 这个完整的集群。 如果集群主库已经初始化好了，那么您可以向现有集群 <a href=/docs/pgsql/admin/cluster#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4>添加</a> 一个从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test               <span style=color:#8f5902;font-style:italic># 一次性初始化整个集群</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-test 10.10.10.12   <span style=color:#8f5902;font-style:italic># 添加从库到现有的集群</span>
</span></span></code></pre></div><p>当集群主库出现故障时，只读实例（Replica）可以在高可用系统的帮助下接管主库的工作。除此之外，只读实例还可以用于执行只读查询：许多业务的读请求要比写请求多很多，而大部分只读查询负载都可以由从库实例承担。</p><hr><h2 id=离线从库>离线从库</h2><p>离线实例（Offline）是专门用于服务慢查询、ETL、OLAP流量和交互式查询等的专用只读从库。慢查询/长事务对在线业务的性能与稳定性有不利影响，因此最好将它们与在线业务隔离开来。</p><p>要添加离线实例，请为其分配一个新实例，并将 <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> 设置为<code>offline</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 新添加的离线从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>专用离线实例的工作方式与常见的从库实例类似，但它在 <code>pg-test-replica</code> 服务中用作备份服务器。 也就是说，只有当所有<code>replica</code>实例都宕机时，离线和主实例才会提供此项只读服务。</p><p>许多情况下，数据库资源有限，单独使用一台服务器作为离线实例是不经济的做法。作为折中，您可以选择一台现有的从库实例，打上 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> 标记，将其标记为一台可以承载"离线查询"的实例。在这种情况下，这台只读从库会同时承担在线只读请求与离线类查询。您可以使用 <a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a> 和 <a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a> 对离线实例进行额外的访问控制。</p><hr><h2 id=同步备库>同步备库</h2><p>当启用同步备库（Sync Standby）时，PostgreSQL 将选择一个从库作为<strong>同步备库</strong>，其他所有从库作为<strong>候选者</strong>。 主数据库会等待备库实例刷新到磁盘，然后才确认提交，备库实例始终拥有最新的数据，没有复制延迟，主从切换至同步备库不会有数据丢失。</p><p>PostgreSQL 默认使用异步流复制，这可能会有小的复制延迟（10KB / 10ms 数量级）。当主库失败时，可能会有一个小的数据丢失窗口（可以使用 <a href=/docs/pgsql/param#pg_rpo><code>pg_rpo</code></a> 来控制），但对于大多数场景来说，这是可以接受的。</p><p>但在某些关键场景中（例如，金融交易），数据丢失是完全不可接受的，或者，读取复制延迟是不可接受的。在这种情况下，您可以使用同步提交来解决这个问题。 要启用同步备库模式，您可以简单地使用 <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a> 中的<code>crit.yml</code>模板。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 使用 crit 模板</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>要在现有集群上启用同步备库，请 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a> 并启用 <code>synchronous_mode</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test    <span style=color:#8f5902;font-style:italic># 在管理员节点以管理员用户身份运行</span>
</span></span><span style=display:flex><span>+++
</span></span><span style=display:flex><span>-synchronous_mode: <span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># &lt;--- 旧值</span>
</span></span><span style=display:flex><span>+synchronous_mode: <span style=color:#204a87>true</span>     <span style=color:#8f5902;font-style:italic># &lt;--- 新值</span>
</span></span><span style=display:flex><span> synchronous_mode_strict: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>应用这些更改？<span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>在这种情况下，PostgreSQL 配置项 <a href=https://www.postgresql.org/docs/current/runtime-config-replication.html#synchronous_standby_names><code>synchronous_standby_names</code></a> 由 Patroni 自动管理。
一台从库将被选拔为同步从库，它的 <code>application_name</code> 将被写入 PostgreSQL 主库配置文件中并应用生效。</p><hr><h2 id=法定人数提交>法定人数提交</h2><p>法定人数提交（Quorum Commit）提供了比同步备库更强大的控制能力：特别是当您有多个从库时，您可以设定提交成功的标准，实现更高/更低的一致性级别（以及可用性之间的权衡）。</p><p>如果想要<strong>最少两个从</strong>库来确认提交，可以通过 Patroni <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a>，调整参数 <a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-replication-factor><code>synchronous_node_count</code></a> 并应用生效</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 确保同步提交已经启用</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_node_count</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 指定“至少”有多少个从库提交成功，才算提交成功</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果你想要使用更多的同步从库，修改 <code>synchronous_node_count</code> 的取值即可。当集群的规模发生变化时，您应当确保这里的配置仍然是有效的，以避免服务不可用。</p><p>在这种情况下，PostgreSQL 配置项 <a href=https://www.postgresql.org/docs/current/runtime-config-replication.html#synchronous_standby_names><code>synchronous_standby_names</code></a> 由 Patroni 自动管理。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>synchronous_standby_names = &#39;2 (&#34;pg-test-3&#34;,&#34;pg-test-2&#34;)&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><details><summary>示例：使用多个同步从库</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>+synchronous_node_count: <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>应用配置后，出现两个同步备库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7080814403632534854<span style=color:#ce5c00;font-weight:700>)</span> +---------+----+-----------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role         <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB <span style=color:#000;font-weight:700>|</span> Tags            <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span> Leader       <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Sync Standby <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Sync Standby <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span></code></pre></div></details><p>另一种情景是，使用 <strong>任意n个</strong> 从库来确认提交。在这种情况下，配置的方式略有不同，例如，假设我们只需要任意一个从库确认提交：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>quorum       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用法定人数提交</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>postgresql</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 修改 PostgreSQL 的配置参数 synchronous_standby_names ，使用 `ANY n ()` 语法</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>synchronous_standby_names</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;ANY 1 (*)&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 你可以指定具体的从库列表，或直接使用 * 通配所有从库。</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><details><summary>示例：启用ANY法定人数提交</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>+    synchronous_standby_names: <span style=color:#4e9a06>&#39;ANY 1 (*)&#39;</span> <span style=color:#8f5902;font-style:italic># 在 ANY 模式下，需要使用此参数</span>
</span></span><span style=display:flex><span>- synchronous_node_count: <span style=color:#0000cf;font-weight:700>2</span>  <span style=color:#8f5902;font-style:italic># 在 ANY 模式下， 不需要使用此参数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>应用后，配置生效，所有备库在 Patroni 中变为普通的 replica。但是在 <code>pg_stat_replication</code> 中可以看到 <code>sync_state</code> 会变为 <code>quorum</code>。</p></details><hr><h2 id=备份集群>备份集群</h2><p>您可以克隆现有的集群，并创建一个备份集群（Standby Cluster），用于数据迁移、水平拆分、多区域部署，或灾难恢复。</p><p>在正常情况下，备份集群将追随上游集群并保持内容同步，您可以将备份集群提升，作为真正地独立集群。</p><p>备份集群的定义方式与正常集群的定义基本相同，除了在主库上额外定义了 <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a> 参数，备份集群的主库被称为 <strong>备份集群领导者</strong> （Standby Leader）。</p><p>例如，下面定义了一个<code>pg-test</code>集群，以及其备份集群<code>pg-test2</code>，其配置清单可能如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test 是原始集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test2 是 pg-test 的备份集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- pg_upstream 在这里定义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test2 }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>而 <code>pg-test2</code> 集群的主节点 <code>pg-test2-1</code> 将是 <code>pg-test</code> 的下游从库，并在<code>pg-test2</code>集群中充当备份集群领导者（<strong>Standby Leader</strong>）。</p><p>只需确保备份集群的主节点上配置了 <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a> 参数，以便自动从原始上游拉取备份。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test     <span style=color:#8f5902;font-style:italic># 创建原始集群</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-test2    <span style=color:#8f5902;font-style:italic># 创建备份集群</span>
</span></span></code></pre></div><details><summary>示例：更改复制上游</summary><p>如有必要（例如，上游发生主从切换/故障转移），您可以通过 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a> 更改备份集群的复制上游。</p><p>要这样做，只需将<code>standby_cluster.host</code>更改为新的上游IP地址并应用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.13     <span style=color:#8f5902;font-style:italic># &lt;--- 旧的上游</span>
</span></span><span style=display:flex><span>+  host: 10.10.10.12     <span style=color:#8f5902;font-style:italic># &lt;--- 新的上游</span>
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><details><summary>示例：提升备份集群</summary><p>你可以随时将备份集群提升为独立集群，这样该集群就可以独立承载写入请求，并与原集群分叉。</p><p>为此，你必须 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置</a> 该集群并完全擦除<code>standby_cluster</code>部分，然后应用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>-standby_cluster:
</span></span><span style=display:flex><span>-  create_replica_methods:
</span></span><span style=display:flex><span>-  - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11
</span></span><span style=display:flex><span>-  port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><details><summary>示例：级联复制</summary><p>如果您在一台从库上指定了 <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a>，而不是主库。那么可以配置集群的 <strong>级联复制</strong>（Cascade Replication）</p><p>在配置级联复制时，您必须使用集群中某一个实例的IP地址作为参数的值，否则初始化会报错。该从库从特定的实例进行流复制，而不是主库。</p><p>这台充当 WAL 中继器的实例被称为 <strong>桥接实例</strong>（Bridge Instance）。使用桥接实例可以分担主库发送 WAL 的负担，当您有几十台从库时，使用桥接实例级联复制是一个不错的注意。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg-test-1 ---&gt; pg-test-2 ---&gt; pg-test-3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 桥接实例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica, pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ^--- 从 pg-test-2 (桥接)复制，而不是从 pg-test-1 (主节点) </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=延迟集群>延迟集群</h2><p>延迟集群（Delayed Cluster）是一种特殊类型的 <a href=#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a>，用于尽快恢复"意外删除"的数据。</p><p>例如，如果你希望有一个名为 <code>pg-testdelay</code> 的集群，其数据内容与一小时前的 <code>pg-test</code> 集群相同：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test 是原始集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-testdelay 是 pg-test 的延迟集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-testdelay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_upstream: 10.10.10.11, pg_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1d }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-testdelay }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>你还可以在现有的 <a href=#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a> 上 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置</a> 一个"复制延迟"。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-testdelay
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>   host: 10.10.10.11
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>+  recovery_min_apply_delay: 1h    <span style=color:#8f5902;font-style:italic># &lt;--- 在此处添加延迟时长，例如1小时</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>当某些元组和表格被意外删除时，你可以通过修改此参数的方式，将此延迟集群推进到适当的时间点，并从中读取数据，快速修复原始集群。</p><p>延迟集群需要额外的资源，但比起 <a href=/docs/concept/pitr#%E6%81%A2%E5%A4%8D>PITR</a> 要快得多，并且对系统的影响也小得多，对于非常关键的集群，可以考虑搭建延迟集群。</p><hr><h2 id=citus集群>Citus集群</h2><p>Pigsty 原生支持 Citus。可以参考 <a href=https://github.com/Vonng/pigsty/blob/main/conf/citus.yml><code>files/pigsty/citus.yml</code></a> 与 <a href=https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L298><code>prod.yml</code></a> 作为样例。</p><p>要定义一个 citus 集群，您需要指定以下参数：</p><ul><li><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a> 必须设置为 <code>citus</code>，而不是默认的 <code>pgsql</code></li><li>在每个分片集群上都必须定义分片名 <a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a> 和分片号 <a href=/docs/pgsql/param#pg_group><code>pg_group</code></a></li><li>必须定义 <a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a> 来指定由 Patroni 管理的 Citus 数据库。</li><li>如果您想使用 <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a> 的 <code>postgres</code> 而不是默认的 <a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a> 来执行管理命令，那么 <a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a> 必须设置为非空的纯文本密码</li></ul><p>此外，还需要额外的 hba 规则，允许从本地和其他数据节点进行 SSL 访问。如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 0号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 1号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 2号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 3号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.14</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># 所有 Citus 集群的全局参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgsql 集群模式需要设置为： citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 水平分片名称： pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 数据库名称：meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 如果使用 dbsu ，那么需要为其配置一个密码</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>在协调者节点上，您可以创建分布式表和引用表，并从任何数据节点查询它们。从 11.2 开始，任何 Citus 数据库节点都可以扮演协调者的角色了。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SELECT create_distributed_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_accounts&#39;</span>, <span style=color:#4e9a06>&#39;aid&#39;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_accounts<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>SELECT create_reference_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_branches&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>         <span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_branches<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>SELECT create_reference_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_history&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_history<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>SELECT create_reference_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_tellers&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_tellers<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-64c78407e33d191b14a78a9a03369255>2.2 - 内核版本</h1><div class=lead>如何选择合适的 PostgreSQL 内核与大版本。</div><blockquote><p>在 Pigsty 中选择"内核"意味着确定 PostgreSQL 大版本、模式/发行版、需要安装的包以及要加载的调优模板。</p></blockquote><p>Pigsty v4.1 当前支持 PostgreSQL 13 - 18，默认使用 18。下方内容展示如何通过配置文件完成这些选择。</p><hr><h2 id=大版本与软件包>大版本与软件包</h2><ul><li><code>pg_version</code>：指定 PostgreSQL 主版本（默认 18）。Pigsty 会根据版本自动映射到正确的包名前缀。</li><li><code>pg_packages</code>：定义需要安装的核心包集合，支持使用 <a href=/docs/pgsql/config/alias>包别名</a>（默认 <code>pgsql-main pgsql-common</code>，包含内核 + patroni/pgbouncer/pgbackrest 等常用工具）。</li><li><code>pg_extensions</code>：额外需要安装的扩展包列表，同样支持别名；缺省为空表示只装核心依赖。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main pgsql-common ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector, pgml ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：Ansible 在安装阶段会拉取与 <code>pg_version=18</code> 对应的包，将扩展预装到系统中，随后数据库初始化脚本即可直接 <code>CREATE EXTENSION</code>。</p></blockquote><p>Pigsty 的离线仓库中不同版本的扩展支持范围不同：13 可用扩展相对较少，17/18 覆盖最广。若某扩展未预打包，可通过 <code>repo_packages_extra</code> 追加。</p><hr><h2 id=内核模式pg_mode>内核模式（pg_mode）</h2><p><code>pg_mode</code> 控制要部署的内核“风味”，默认 <code>pgsql</code> 表示标准 PostgreSQL。Pigsty 目前支持以下模式：</p><table class=full-width><thead><tr><th>模式</th><th>场景</th></tr></thead><tbody><tr><td><code>pgsql</code></td><td>标准 PostgreSQL，高可用 + 复制</td></tr><tr><td><code>citus</code></td><td>Citus 分布式集群，需要额外的 <code>pg_shard / pg_group</code></td></tr><tr><td><code>gpsql</code></td><td>Greenplum / MatrixDB</td></tr><tr><td><code>mssql</code></td><td>Babelfish for PostgreSQL</td></tr><tr><td><code>mysql</code></td><td>OpenGauss/HaloDB 兼容 MySQL 协议</td></tr><tr><td><code>polar</code></td><td>阿里 PolarDB（基于 pg <code>polar</code> 发行）</td></tr><tr><td><code>ivory</code></td><td>IvorySQL（Oracle 兼容语法）</td></tr><tr><td><code>oriole</code></td><td>OrioleDB 存储引擎</td></tr><tr><td><code>oracle</code></td><td>PostgreSQL + ora 兼容（<code>pg_mode: oracle</code>）</td></tr></tbody></table><p>选择模式后，Pigsty 会自动加载对应的模板、依赖包与 Patroni 配置。以部署 Citus 为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0, pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1, pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_citus_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：所有成员会安装 Citus 相关包，Patroni 以分片模式写入 etcd，并自动在 <code>meta</code> 数据库内 <code>CREATE EXTENSION citus</code>。</p></blockquote><hr><h2 id=扩展与预置对象>扩展与预置对象</h2><p>除了系统包，你还可以通过以下参数控制数据库启动后自动加载的组件：</p><ul><li><code>pg_libs</code>：写入 <code>shared_preload_libraries</code> 的列表。例如 <code>pg_libs: 'timescaledb, pg_stat_statements, auto_explain'</code>。</li><li><code>pg_default_extensions</code> / <code>pg_default_schemas</code>：控制初始化脚本对 <code>template1</code> 与 <code>postgres</code> 预创建的 schema、扩展。</li><li><code>pg_parameters</code>：为所有实例附加 <code>ALTER SYSTEM SET</code>（写入 <code>postgresql.auto.conf</code>）。</li></ul><p>示例：启用 TimescaleDB、pgvector 并自定义一些系统参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-analytics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, pgml&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>timescaledb.max_background_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;&#39;timescaledb,pg_stat_statements,pgml&#39;&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：初始化时 <code>template1</code> 会创建扩展、Patroni 的 <code>postgresql.conf</code> 注入对应参数，所有业务库继承这些设置。</p></blockquote><hr><h2 id=调优模板-pg_conf>调优模板 (<code>pg_conf</code>)</h2><p><code>pg_conf</code> 指向 <code>roles/pgsql/templates/*.yml</code> 中的 Patroni 模板。Pigsty内置四套通用模板：</p><table class=full-width><thead><tr><th>模板</th><th>适用场景</th></tr></thead><tbody><tr><td><code>oltp.yml</code></td><td>默认模板，面向 4–128 核的 TP 负载</td></tr><tr><td><code>olap.yml</code></td><td>针对分析场景优化</td></tr><tr><td><code>crit.yml</code></td><td>强调同步提交/最小延迟，适合金融等零丢失场景</td></tr><tr><td><code>tiny.yml</code></td><td>轻量机 / 边缘场景 / 资源受限环境</td></tr></tbody></table><p>你可以直接替换模板或自定义一个 YAML 文件放在 <code>templates/</code> 下，然后在集群 <code>vars</code> 里指定。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-ledger</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.21</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-ledger</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>synchronous_commit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;remote_apply&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>max_wal_senders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2GB&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：拷贝 <code>crit.yml</code> 作为 Patroni 配置，叠加 <code>pg_parameters</code> 写入 <code>postgresql.auto.conf</code>，使实例立即以同步提交模式运行。</p></blockquote><hr><h2 id=组合实例一个完整示例>组合实例：一个完整示例</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-rag</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.31</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.32</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-rag</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main pgsql-common ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, pgml, postgis ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, pgvector, pgml&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>max_parallel_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;32GB&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>第一台主库 + 一台 replica，使用 <code>olap.yml</code> 调优。</li><li>安装 PG18 + RAG 常用扩展，自动在系统级加载 <code>pgvector/pgml</code>。</li><li>Patroni/pgbouncer/pgbackrest 由 Pigsty 生成，无需手工干预。</li></ul><p>根据业务需要替换上述参数即可完成内核层的全部定制。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ad5d6482cea01b850636a3033b3ec973>2.3 - 别名翻译</h1><div class=lead>Pigsty 提供软件包别名翻译机制，可以屏蔽底层操作系统的二进制包细节差异，让安装更简易。</div><p>PostgreSQL 在不同操作系统上的软件包命名规则存在显著差异：</p><ul><li><strong>EL 系统</strong>（RHEL/Rocky/Alma/&mldr;）使用 <code>pgvector_17</code>，<code>postgis36_17*</code> 这样的格式</li><li><strong>Debian/Ubuntu 系统</strong>使用 <code>postgresql-17-pgvector</code>，<code>postgresql-17-postgis-3</code> 这样的格式</li></ul><p>这种差异给用户带来了额外的认知负担：您需要记住不同系统的包名规则，还要处理 PostgreSQL 版本号嵌入的问题。</p><h2 id=软件包别名>软件包别名</h2><p>Pigsty 通过 <strong>软件包别名（Package Alias）</strong> 机制解决了这个问题：您只需使用统一的别名，Pigsty 会处理好所有细节：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用别名 —— 简单、统一、跨平台</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, pgvector, timescaledb ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 等效于 EL9 + PG17 上的实际包名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis36_17*, pgvector_17*, timescaledb-tsl_17* ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 等效于 Ubuntu 24 + PG17 上的实际包名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgresql-17-postgis-3, postgresql-17-pgvector, postgresql-17-timescaledb-tsl ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h2 id=别名翻译>别名翻译</h2><p>别名还可以将一组软件包归类为一个整体，例如 Pigsty 默认安装的软件包 —— <a href=/docs/pgsql/param#pg_packages><strong><code>pg_packages</code></strong></a> 的默认值是：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># pg packages to be installed, alias can be used</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 将查询当前的操作系统别名清单（假设为 <a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el10.x86_64.yml#L105><strong><code>el10.x86_64</code></strong></a>），将其翻译为 PGSQL 内核，扩展，以及工具包：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgsql-main</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#4e9a06>&#34;postgresql$v postgresql$v-server postgresql$v-libs postgresql$v-contrib postgresql$v-plperl postgresql$v-plpython3 postgresql$v-pltcl postgresql$v-llvmjit pg_repack_$v* wal2json_$v* pgvector_$v*&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgsql-common</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;patroni patroni-etcd pgbouncer pgbackrest pg_exporter pgbackrest_exporter vip-manager&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>接下来，Pigsty 又进一步通过当前指定的 PG 大版本（假设 <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a> = <code>18</code> ），将 <code>pgsql-main</code> 翻译为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg18-main</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#4e9a06>&#34;postgresql18 postgresql18-server postgresql18-libs postgresql18-contrib postgresql18-plperl postgresql18-plpython3 postgresql18-pltcl postgresql18-llvmjit pg_repack_18* wal2json_18* pgvector_18*&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>通过这种方式，Pigsty 屏蔽了软件包的复杂性，让用户可以简单的指定自己想要的功能组件。</p><hr><h2 id=哪些变量可以使用别名>哪些变量可以使用别名？</h2><p>您可以在以下四个参数中使用包别名，别名会根据翻译流程自动转换为实际的软件包名称：</p><ul><li><a href=/docs/pgsql/param#pg_extensions><strong><code>pg_extensions</code></strong></a> - PG 扩展软件包</li><li><a href=/docs/pgsql/param#pg_extensions><strong><code>pg_packages</code></strong></a> - PG 内核/基础工具软件包</li><li><a href=/docs/infra/param#repo_packages><strong><code>repo_packages</code></strong></a> - 软件包下载参数：下载到本地软件仓库的软件包</li><li><a href=/docs/pgsql/param#pg_extensions><strong><code>repo_packages_extra</code></strong></a> - 扩展安装参数：额外下载到本地软件仓库的软件包</li></ul><hr><h2 id=别名列表>别名列表</h2><p>你可以在 Pigsty 项目源代码的 <a href=https://github.com/pgsty/pigsty/tree/main/roles/node_id/vars><code>roles/node_id/vars/</code></a> 目录下，找到各操作系统与架构对应的别名映射文件：</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el10.x86_64.yml#L85><code>el10.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el10.aarch64.yml#L85><code>el10.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el9.x86_64.yml#L85><code>el9.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el9.aarch64.yml#L85><code>el9.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el8.x86_64.yml#L85><code>el8.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el8.aarch64.yml#L85><code>el8.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u24.x86_64.yml#L78><code>u24.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u24.aarch64.yml#L78><code>u24.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u22.x86_64.yml#L78><code>u22.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u22.aarch64.yml#L78><code>u22.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d13.x86_64.yml#L78><code>d13.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d13.aarch64.yml#L78><code>d13.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d12.x86_64.yml#L78><code>d12.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d12.aarch64.yml#L78><code>d12.aarch64</code></a></li></ul><hr><h2 id=工作原理>工作原理</h2><h3 id=别名翻译流程>别名翻译流程</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>用户配置别名 --&gt; 检测操作系统 --&gt;  查找别名映射表 ---&gt; 替换<span style=color:#000>$v占位符</span> ---&gt; 安装实际软件包
</span></span><span style=display:flex><span>     ↓              ↓               ↓                               ↓
</span></span><span style=display:flex><span>  postgis      el9.x86_64      postgis36_<span style=color:#000>$v</span>*                postgis36_17*
</span></span><span style=display:flex><span>  postgis      u24.x86_64      postgresql-<span style=color:#000>$v</span>-postgis-3      postgresql-17-postgis-3
</span></span></code></pre></div><h3 id=版本占位符>版本占位符</h3><p>Pigsty 的别名系统使用 <code>$v</code> 作为 PostgreSQL 版本号的占位符。当您使用 <a href=/docs/pgsql/param#pg_version><code>pg_version</code></a> 指定了 PostgreSQL 版本后，所有别名中的 <code>$v</code> 都会被替换为实际版本号。</p><p>例如，当 <code>pg_version: 17</code> 时：</p><table class=full-width><thead><tr><th>别名定义 (EL)</th><th>展开结果</th></tr></thead><tbody><tr><td><code>postgresql$v*</code></td><td><code>postgresql17*</code></td></tr><tr><td><code>pgvector_$v*</code></td><td><code>pgvector_17*</code></td></tr><tr><td><code>timescaledb-tsl_$v*</code></td><td><code>timescaledb-tsl_17*</code></td></tr></tbody></table><table class=full-width><thead><tr><th>别名定义 (Debian/Ubuntu)</th><th>展开结果</th></tr></thead><tbody><tr><td><code>postgresql-$v</code></td><td><code>postgresql-17</code></td></tr><tr><td><code>postgresql-$v-pgvector</code></td><td><code>postgresql-17-pgvector</code></td></tr><tr><td><code>postgresql-$v-timescaledb-tsl</code></td><td><code>postgresql-17-timescaledb-tsl</code></td></tr></tbody></table><h3 id=通配符匹配>通配符匹配</h3><p>在 EL 系统上，许多别名使用 <code>*</code> 通配符来匹配相关的子包。例如：</p><ul><li><code>postgis36_17*</code> 会匹配 <code>postgis36_17</code>、<code>postgis36_17-client</code>、<code>postgis36_17-utils</code> 等</li><li><code>postgresql17*</code> 会匹配 <code>postgresql17</code>、<code>postgresql17-server</code>、<code>postgresql17-libs</code>、<code>postgresql17-contrib</code> 等</li></ul><p>这种设计确保您无需逐一列出每个子包，一个别名即可安装完整的扩展。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f3a29e30e1bcb1622450d4b2d3604bdc>2.4 - 用户/角色</h1><div class=lead>如何通过配置来定制所需 PostgreSQL 用户与角色？</div><blockquote><p>在本文中，&ldquo;用户&rdquo;（User） 指的是使用 SQL 命令 <code>CREATE USER/ROLE</code> 创建的，数据库集簇内的逻辑对象。</p></blockquote><p>在 PostgreSQL 中，用户直接隶属于数据库集簇而非某个具体的数据库。因此在创建业务数据库和业务用户时，应当遵循"先用户，后数据库"的原则。</p><p>Pigsty 通过两个配置参数定义数据库集群中的角色与用户：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a>：定义全局统一使用的角色和用户</li><li><a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a>：在数据库集群层面定义业务用户和角色</li></ul><p>前者用于定义整套环境中共用的角色与用户，后者定义单个集群中特有的业务角色与用户。二者形式相同，均为用户定义对象的数组。
用户/角色按数组顺序逐一创建，因此后定义的用户可以属于先定义的角色。</p><p>默认情况下，所有带有 <code>pgbouncer: true</code> 标记的用户都会被添加到 <a href=/docs/concept/arch/pgsql#pgbouncer><strong>Pgbouncer</strong></a> 连接池用户列表中。</p><hr><h2 id=定义用户>定义用户</h2><p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的业务用户定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_noco     ,password: DBUser.Noco     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for nocodb service      }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_remove   ,state: absent }  # 使用 state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent 删除用户</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个用户/角色定义都是一个复杂对象，可能包括以下字段，除了 <code>name</code> 字段外，其他字段均为可选字段：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是用户定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>create                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户状态：create（创建，默认）、absent（删除）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，密码，可以是 scram-sha-256 哈希字符串或明文</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，默认为 true，是否可以登录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否是超级用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以创建数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以创建角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，默认为 true，是否自动继承所属角色权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以发起流复制连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以绕过行级安全</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，用户连接数限制，默认 -1 不限制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，从创建时起 N 天后过期（优先级比 expire_at 高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 可选，过期日期，使用 YYYY-MM-DD 格式（优先级没 expire_in 高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户备注信息</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，所属角色数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，角色级配置参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否加入连接池用户列表，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户级别的池化模式，默认 transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，用户级别的连接池最大连接数，默认 -1 不限制</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>用户级连接池限额字段统一使用 <code>pool_connlimit</code>（对应 Pgbouncer <code>max_user_connections</code>）。</p></blockquote><hr><h2 id=参数总览>参数总览</h2><p>所有参数中唯一 <strong>必选</strong> 的字段是 <code>name</code>，它应该是当前 PostgreSQL 集群中有效且唯一的用户名，其他参数都有合理的默认值，均为可选项。</p><table class=full-width><thead><tr><th>字段</th><th>分类</th><th>类型</th><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><a href=#name><strong><code>name</code></strong></a></td><td>基本</td><td><code>string</code></td><td>必选</td><td>用户名，必须是有效且唯一的标识符</td></tr><tr><td><a href=#state><strong><code>state</code></strong></a></td><td>基本</td><td><code>enum</code></td><td>可选</td><td>用户状态：<code>create</code>（默认）、<code>absent</code></td></tr><tr><td><a href=#password><strong><code>password</code></strong></a></td><td>基本</td><td><code>string</code></td><td>可变</td><td>用户密码，明文或哈希</td></tr><tr><td><a href=#comment><strong><code>comment</code></strong></a></td><td>基本</td><td><code>string</code></td><td>可变</td><td>用户备注信息</td></tr><tr><td><a href=#login><strong><code>login</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否允许登录，默认 <code>true</code></td></tr><tr><td><a href=#superuser><strong><code>superuser</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否为超级用户，默认 <code>false</code></td></tr><tr><td><a href=#createdb><strong><code>createdb</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否可创建数据库，默认 <code>false</code></td></tr><tr><td><a href=#createrole><strong><code>createrole</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否可创建角色，默认 <code>false</code></td></tr><tr><td><a href=#inherit><strong><code>inherit</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否继承所属角色权限，默认 <code>true</code></td></tr><tr><td><a href=#replication><strong><code>replication</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否可进行复制，默认 <code>false</code></td></tr><tr><td><a href=#bypassrls><strong><code>bypassrls</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否可绕过行级安全，默认 <code>false</code></td></tr><tr><td><a href=#connlimit><strong><code>connlimit</code></strong></a></td><td>权限</td><td><code>int</code></td><td>可变</td><td>连接数限制，<code>-1</code> 表示不限制</td></tr><tr><td><a href=#expire_in><strong><code>expire_in</code></strong></a></td><td>有效期</td><td><code>int</code></td><td>可变</td><td>从当前日期起 N 天后过期（优先级高于 <code>expire_at</code>）</td></tr><tr><td><a href=#expire_at><strong><code>expire_at</code></strong></a></td><td>有效期</td><td><code>string</code></td><td>可变</td><td>过期日期，<code>YYYY-MM-DD</code> 格式</td></tr><tr><td><a href=#roles><strong><code>roles</code></strong></a></td><td>角色</td><td><code>array</code></td><td>增量</td><td>所属角色数组，支持字符串或对象格式</td></tr><tr><td><a href=#parameters><strong><code>parameters</code></strong></a></td><td>参数</td><td><code>object</code></td><td>可变</td><td>角色级参数</td></tr><tr><td><a href=#pgbouncer><strong><code>pgbouncer</code></strong></a></td><td>连接池</td><td><code>bool</code></td><td>可变</td><td>是否加入连接池，默认 <code>false</code></td></tr><tr><td><a href=#pool_mode><strong><code>pool_mode</code></strong></a></td><td>连接池</td><td><code>enum</code></td><td>可变</td><td>池化模式：<code>transaction</code>（默认）</td></tr><tr><td><a href=#pool_connlimit><strong><code>pool_connlimit</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>连接池用户最大连接数</td></tr></tbody></table><hr><h2 id=参数详情>参数详情</h2><h3 id=name><code>name</code></h3><p>字符串，必选参数，表示用户的名称，在一个数据库集群内必须唯一。</p><p>用户名必须是有效的 PostgreSQL 标识符，必须匹配正则表达式 <strong><code>^[a-z_][a-z0-9_]{0,62}$</code></strong>：
以小写字母或下划线开头，只能包含小写字母、数字、下划线，最长 63 个字符。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 标准命名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_readonly      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 下划线分隔</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>_internal         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 下划线开头（用于内部角色）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=state><code>state</code></h3><p>枚举值，用于指定要对用户执行的操作，可以是 <code>create</code> 或 <code>absent</code>，默认值为 <code>create</code>。</p><table class=full-width><thead><tr><th>状态</th><th>说明</th></tr></thead><tbody><tr><td><code>create</code></td><td>默认，创建用户，如果已存在则更新属性</td></tr><tr><td><code>absent</code></td><td>删除用户，使用 <code>DROP ROLE</code></td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># state 默认为 create</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_old</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 删除用户</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>以下系统用户无法通过 <code>state: absent</code> 删除，这是为了防止误删关键系统用户导致集群故障：</p><ul><li><code>postgres</code>：数据库超级用户</li><li><code>replicator</code>：复制用户（或 <a href=/docs/pgsql/param#pg_replication_username><strong><code>pg_replication_username</code></strong></a> 配置的用户）</li><li><code>dbuser_dba</code>：管理员用户（或 <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a> 配置的用户）</li><li><code>dbuser_monitor</code>：监控用户（或 <a href=/docs/pgsql/param#pg_monitor_username><strong><code>pg_monitor_username</code></strong></a> 配置的用户）</li></ul><h3 id=password><code>password</code></h3><p>字符串，可变参数，用于设置用户密码，不指定则用户无法使用密码登录。</p><p>密码可以是以下格式之一：</p><table class=full-width><thead><tr><th>格式</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>明文密码</td><td><code>DBUser.Meta</code></td><td>不推荐，会被记录到配置文件和日志</td></tr><tr><td>SCRAM-SHA-256</td><td><code>SCRAM-SHA-256$4096:xxx$yyy:zzz</code></td><td>推荐，PostgreSQL 10+ 默认认证方式</td></tr><tr><td>MD5 哈希</td><td><code>md5...</code></td><td>兼容旧版本，不推荐新项目使用</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 明文密码（不推荐，会被记录到配置和日志中）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>MySecretPassword</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># SCRAM-SHA-256 哈希（推荐）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;SCRAM-SHA-256$4096:xxx$yyy:zzz&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>设置密码时，Pigsty 会临时屏蔽当前会话的日志记录以避免密码泄露：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_statement</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;none&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>PASSWORD</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;xxx&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_statement</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果你不希望在配置文件中记录明文密码，可以使用 <code>SCRAM-SHA-256</code> 哈希字符串代替明文密码。生成 SCRAM-SHA-256 哈希的方法：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 PostgreSQL 生成（需要先连接到数据库，数据库有 pgcrypto 扩展）</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;SELECT encode(digest(&#39;password&#39; || &#39;username&#39;, &#39;sha256&#39;), &#39;hex&#39;)&#34;</span>
</span></span></code></pre></div><h3 id=comment><code>comment</code></h3><p>字符串，可变参数，用于设置用户的备注信息，如果不指定，默认值为 <code>business user {name}</code>。</p><p>用户备注信息通过 <code>COMMENT ON ROLE</code> 语句设置，支持中文和特殊字符（Pigsty 会自动转义单引号）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;业务应用主账号&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;业务应用主账号&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=login><code>login</code></h3><p>布尔值，可变参数，用于控制用户是否可以登录，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 则创建的是无法登陆的 <strong>角色</strong>（Role）而非用户（User），通常用于权限分组。</p><p>在 PostgreSQL 中，<code>CREATE USER</code> 等价于 <code>CREATE ROLE ... LOGIN</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建可登录用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建角色（不可登录，用于权限分组）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_custom</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>自定义权限角色</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>LOGIN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_custom&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>NOLOGIN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=superuser><code>superuser</code></h3><p>布尔值，可变参数，用于指定用户是否为超级用户，默认值为 <code>false</code>。</p><p>超级用户拥有数据库的全部权限，可以绕过所有权限检查。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 危险：拥有全部权限</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>SUPERUSER</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 已经提供了默认的超级用户 <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a> （<code>dbuser_dba</code>）
除非绝对必要，否则不应创建额外的超级用户。</p><h3 id=createdb><code>createdb</code></h3><p>布尔值，可变参数，用于指定用户是否可以创建数据库，默认值为 <code>false</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 允许创建数据库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_dev&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CREATEDB</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>一些应用软件可能会要求自己创建数据库，例如 <code>Gitea</code>，<code>Odoo</code> 等，因此您可能需要为这些应用的管理员用户启用 <code>CREATEDB</code> 权限。</p><h3 id=createrole><code>createrole</code></h3><p>布尔值，可变参数，用于指定用户是否可以创建其他角色，默认值为 <code>false</code>。</p><p>拥有 <code>CREATEROLE</code> 权限的用户可以创建、修改、删除其他非超级用户角色。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 允许管理其他角色</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>CREATEROLE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=inherit><code>inherit</code></h3><p>布尔值，可变参数，用于控制用户是否自动继承所属角色的权限，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 时，用户需要通过 <code>SET ROLE</code> 显式切换角色才能使用所属角色的权限。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 自动继承角色权限（默认）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 需要显式切换角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_special&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>NOINHERIT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 用户需要执行 SET ROLE dbrole_admin 才能获得该角色权限（必要但不充分）
</span></span></span></code></pre></div><h3 id=replication><code>replication</code></h3><p>布尔值，可变参数，用于指定用户是否可以发起流复制连接，默认值为 <code>false</code>。</p><p>通常只有复制用户（如 <code>replicator</code>）需要此权限。普通业务用户不应该拥有此权限，除非这是一个逻辑解码订阅者。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 允许流复制连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pg_monitor, dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;replicator&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>REPLICATION</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=bypassrls><code>bypassrls</code></h3><p>布尔值，可变参数，用于指定用户是否可以绕过行级安全（RLS）策略，默认值为 <code>false</code>。</p><p>启用此权限后，用户可以访问所有行，即使表上定义了行级安全策略。此权限通常只授予管理员用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myappadmin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 绕过行级安全策略</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_myappadmin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>BYPASSRLS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=connlimit><code>connlimit</code></h3><p>整数，可变参数，用于限制用户的最大并发连接数，默认值为 <code>-1</code>，表示不限制。</p><p>设置为正整数时，会限制该用户同时建立的最大数据库连接数。此限制不影响超级用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 最多 100 个并发连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_batch</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 批处理用户限制连接数</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=expire_in><code>expire_in</code></h3><p>整数，可变参数，用于指定用户从当前日期起多少天后过期。</p><p>此参数优先级高于 <a href=#expire_at><strong><code>expire_at</code></strong></a>，如果同时指定两者，只有 <code>expire_in</code> 生效。</p><p>每次执行剧本时会根据当前日期重新计算过期时间，适合用于临时用户或需要定期续期的场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 30 天后过期</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 90 天后过期</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>执行时会计算实际过期日期并生成对应的 SQL：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- expire_in: 30, 假设当前日期为 2025-01-01
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;temp_user&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALID</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UNTIL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-01-31&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=expire_at><code>expire_at</code></h3><p>字符串，可变参数，用于指定用户的过期日期，格式为 <code>YYYY-MM-DD</code> 或特殊值 <code>infinity</code>。</p><p>此参数优先级低于 <a href=#expire_in><strong><code>expire_in</code></strong></a>。使用 <code>infinity</code> 表示用户永不过期。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 指定日期过期</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>permanent_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 永不过期</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;contractor_user&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALID</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UNTIL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;permanent_user&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALID</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UNTIL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=roles><code>roles</code></h3><p>数组，增量参数，用于定义用户所属的角色。数组元素可以是字符串或对象。</p><p>简单格式使用字符串直接指定角色名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>pg_read_all_data</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_readwrite&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg_read_all_data&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>完整格式使用对象定义，支持更精细的角色成员关系控制：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite                           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单字符串：GRANT 角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 带 ADMIN OPTION</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set: false }            # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>不允许 SET ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_signal_backend, inherit: false } # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>不自动继承权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 撤销角色成员关系</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>对象格式参数说明</strong>：</p><table class=full-width><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>name</code></td><td>string</td><td>角色名称（必选）</td></tr><tr><td><code>state</code></td><td>enum</td><td><code>grant</code>（默认）或 <code>absent</code>/<code>revoke</code>：控制授予或撤销</td></tr><tr><td><code>admin</code></td><td>bool</td><td><code>true</code>：WITH ADMIN OPTION，<code>false</code>：REVOKE ADMIN</td></tr><tr><td><code>set</code></td><td>bool</td><td>PG16+：<code>true</code>：WITH SET TRUE，<code>false</code>：REVOKE SET</td></tr><tr><td><code>inherit</code></td><td>bool</td><td>PG16+：<code>true</code>：WITH INHERIT TRUE，<code>false</code>：REVOKE INHERIT</td></tr></tbody></table><p><strong>PostgreSQL 16+ 新特性</strong>：</p><p>PostgreSQL 16 引入了更细粒度的角色成员关系控制：</p><ul><li><strong>ADMIN OPTION</strong>：允许将角色授予其他用户</li><li><strong>SET OPTION</strong>：允许使用 <code>SET ROLE</code> 切换到该角色</li><li><strong>INHERIT OPTION</strong>：是否自动继承该角色的权限</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PostgreSQL 16+ 完整示例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 普通成员关系</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 可以将 dbrole_admin 授予其他用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 不能 SET ROLE 到 pg_monitor（只能通过继承使用权限）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 不自动继承 pg_execute_server_program 的权限（需要显式 SET ROLE）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_execute_server_program, inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 撤销 old_role 的成员关系</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>set</code> 和 <code>inherit</code> 选项仅在 PostgreSQL 16+ 中有效，在早期版本会被忽略并在生成的 SQL 中添加警告注释。</p><h3 id=parameters><code>parameters</code></h3><p>对象，可变参数，用于设置角色级别的配置参数。参数通过 <code>ALTER ROLE ... SET</code> 设置，会对该用户的所有会话生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;search_path&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;log_statement&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用特殊值 <code>DEFAULT</code>（大小写不敏感）可以将参数重置为 PostgreSQL 默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 设置新值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>常用角色级参数：</p><table class=full-width><thead><tr><th>参数</th><th>说明</th><th>示例值</th></tr></thead><tbody><tr><td><code>work_mem</code></td><td>查询工作内存</td><td><code>'64MB'</code></td></tr><tr><td><code>statement_timeout</code></td><td>语句超时时间</td><td><code>'30s'</code></td></tr><tr><td><code>lock_timeout</code></td><td>锁等待超时</td><td><code>'10s'</code></td></tr><tr><td><code>idle_in_transaction_session_timeout</code></td><td>空闲事务超时</td><td><code>'10min'</code></td></tr><tr><td><code>search_path</code></td><td>Schema 搜索路径</td><td><code>'app,public'</code></td></tr><tr><td><code>log_statement</code></td><td>日志记录级别</td><td><code>'ddl'</code></td></tr><tr><td><code>temp_file_limit</code></td><td>临时文件大小限制</td><td><code>'10GB'</code></td></tr></tbody></table><p>您可以从数据库的 <a href=https://www.postgresql.org/docs/current/view-pg-db-role-setting.html><strong><code>pg_db_role_setting</code></strong></a> 系统视图查询用户级别的参数设置。</p><h3 id=pgbouncer><code>pgbouncer</code></h3><p>布尔值，可变参数，用于控制是否将用户添加到 Pgbouncer 连接池用户列表，默认值为 <code>false</code>。</p><p>对于需要通过连接池访问数据库的生产用户，必须显式设置 <code>pgbouncer: true</code>。
默认为 <code>false</code> 是为了避免意外将内部用户暴露给连接池。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 生产用户：需要连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 内部用户：不需要连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 默认值，可省略</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>设置 <code>pgbouncer: true</code> 的用户会被添加到 <code>/etc/pgbouncer/userlist.txt</code> 文件中。</p><h3 id=pool_mode><code>pool_mode</code></h3><p>枚举值，可变参数，用于设置用户级别的池化模式，可选值为 <code>transaction</code>、<code>session</code> 或 <code>statement</code>，默认值为 <code>transaction</code>。</p><table class=full-width><thead><tr><th>模式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>transaction</code></td><td>事务结束后归还连接</td><td>大多数 OLTP 应用，默认推荐</td></tr><tr><td><code>session</code></td><td>会话结束后归还连接</td><td>需要会话状态的应用（如 SET 命令）</td></tr><tr><td><code>statement</code></td><td>每条语句后归还连接</td><td>简单无状态查询，极致复用</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># DBA 用户使用 session 模式（可能需要 SET 命令等会话状态）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 普通业务用户使用 transaction 模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>用户级别的连接池参数通过 <code>/etc/pgbouncer/useropts.txt</code> 文件配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><h3 id=pool_connlimit><code>pool_connlimit</code></h3><p>整数，可变参数，用于设置用户级别的连接池最大连接数，默认值为 <code>-1</code>，表示不限制。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 此用户最多使用 50 个连接池连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=acl-系统>ACL 系统</h2><p>Pigsty 提供了一套内置的、开箱即用的访问控制 / <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7><strong>ACL</strong></a> 系统，您只需将以下四个默认角色分配给业务用户即可轻松使用：</p><table class=full-width><thead><tr><th>角色</th><th>权限说明</th><th>典型使用场景</th></tr></thead><tbody><tr><td><code>dbrole_readwrite</code></td><td>全局读写访问</td><td>主属业务的生产账号</td></tr><tr><td><code>dbrole_readonly</code></td><td>全局只读访问</td><td>其他业务的只读访问</td></tr><tr><td><code>dbrole_admin</code></td><td>拥有 DDL 权限</td><td>业务管理员，需要建表的场景</td></tr><tr><td><code>dbrole_offline</code></td><td>受限只读访问（仅离线实例）</td><td>个人用户，ETL/分析任务</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 典型业务用户配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产账号，读写权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 只读账号</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 管理员，可执行 DDL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_etl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.ETL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_offline]     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 离线分析账号</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果您希望重新设计您自己的 ACL 系统，可以考虑定制以下参数和模板：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a>：系统范围的角色和全局用户</li><li><a href=/docs/pgsql/param#pg_default_privileges><strong><code>pg_default_privileges</code></strong></a>：新建对象的默认权限</li><li><a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-role.sql><strong><code>pg-init-role.sql</code></strong></a>：角色创建 SQL 模板</li><li><a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><strong><code>pg-init-template.sql</code></strong></a>：权限 SQL 模板</li></ul><hr><h2 id=pgbouncer-用户>Pgbouncer 用户</h2><p>默认情况下启用 Pgbouncer 作为连接池中间件。Pigsty 默认将 <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> 中显式带有 <code>pgbouncer: true</code> 标志的所有用户添加到 Pgbouncer 用户列表中。</p><p>Pgbouncer 连接池中的用户在 <code>/etc/pgbouncer/userlist.txt</code> 中列出：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>&#34;postgres&#34; &#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_wiki&#34; &#34;SCRAM-SHA-256$4096:+77dyhrPeFDT/TptHs7/7Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$KeatuohpKIYzHPCt/tqBu85vI11o9mar/by0hHYM2W8=:X9gig4JtjoS8Y/o1vQsIX/gY1Fns8ynTXkbWOjUfbRQ=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_view&#34; &#34;SCRAM-SHA-256$4096:DFoZHU/DXsHL8MJ8regdEw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$gx9sUGgpVpdSM4o6A2R9PKAUkAsRPLhLoBDLBUYtKS0=:MujSgKe6rxcIUMv4GnyXJmV0YNbf39uFRZv724+X1FE=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_monitor&#34; &#34;SCRAM-SHA-256$4096:fwU97ZMO/KR0ScHO5+UuBg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$CrNsmGrx1DkIGrtrD1Wjexb/aygzqQdirTO1oBZROPY=:L8+dJ+fqlMQh7y4PmVR/gbAOvYWOr+KINjeMZ8LlFww=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_meta&#34; &#34;SCRAM-SHA-256$4096:leB2RQPcw1OIiRnPnOMUEg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$eyC+NIMKeoTxshJu314+BmbMFpCcspzI3UFZ1RYfNyU=:fJgXcykVPvOfro2MWNkl5q38oz21nSl1dTtM65uYR1Q=&#34;</span>
</span></span></code></pre></div><p>用户级别的连接池参数使用另一个单独的文件 <code>/etc/pgbouncer/useropts.txt</code> 进行维护：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><p>当您 <a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7><strong>创建用户</strong></a> 时，Pgbouncer 的用户列表定义文件将会被刷新，并通过在线重载配置的方式生效，不会影响现有的连接。</p><p>Pgbouncer 使用和 PostgreSQL 相同的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户。您可以使用 <code>pgb</code> 别名，使用 dbsu 访问 Pgbouncer 管理功能。</p><p><a href=/docs/pgsql/param#pgbouncer_auth_query><strong><code>pgbouncer_auth_query</code></strong></a> 参数允许您使用动态查询来完成连接池用户认证，当您不想手动管理连接池中的用户时，这是一种便捷的方案。</p><hr><h2 id=相关资源>相关资源</h2><p>关于用户管理操作，请参考 <a href=/docs/pgsql/admin/user><strong>用户管理</strong></a> 一节。</p><p>关于用户的访问权限，请参考 <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7><strong>ACL：角色权限</strong></a> 一节。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-662c4a4a95a52da3073eeed2f4407af9>2.5 - 数据库</h1><div class=lead>如何通过配置来定制所需 PostgreSQL 数据库？</div><blockquote><p>在本文中，“数据库”（Database） 指的是使用 SQL 命令 <code>CREATE DATABASE</code> 创建的，数据库集簇内的逻辑对象。</p></blockquote><p>一组 PostgreSQL 服务器可以同时服务于多个 <strong>数据库</strong> （Database）。在 Pigsty 中，你可以在集群配置中 <a href=#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93><strong>定义</strong></a> 好所需的数据库。</p><p>Pigsty会对默认模板数据库<code>template1</code>进行修改与定制，创建默认模式，安装默认扩展，配置默认权限，新创建的数据库默认会从<code>template1</code>继承这些设置。
您也可以通过 <a href=#template><strong><code>template</code></strong></a> 参数指定其他模板数据库，实现瞬间 <a href=/docs/pgsql/admin/db#%E5%85%8B%E9%9A%86%E6%95%B0%E6%8D%AE%E5%BA%93><strong>数据库克隆</strong></a>。</p><p>默认情况下，所有业务数据库都会被 1:1 添加到 <a href=/docs/concept/arch/pgsql#pgbouncer><strong>Pgbouncer</strong></a> <a href=#%E8%BF%9E%E6%8E%A5%E6%B1%A0><strong>连接池</strong></a> 中；<a href=/docs/concept/arch/pgsql#pg_exporter><strong><code>pg_exporter</code></strong></a> 默认会通过 <strong>自动发现</strong> 机制查找所有业务数据库并进行库内对象监控。
所有数据库也会添加到所有 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a> 上的 <a href=/docs/concept/arch/infra#grafana><strong>Grafana</strong></a> 中，
注册为 PostgreSQL 数据源供 PGCAT 监控面板使用。</p><hr><h2 id=定义数据库>定义数据库</h2><p>业务数据库定义在数据库集群参数 <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> 中，这是一个数据库定义构成的对象数组。
在集群初始化时，数组内的数据库按照 <strong>定义顺序</strong> 依次创建，因此后面定义的数据库可以使用先前定义的数据库作为<strong>模板</strong>。</p><p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的数据库定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: noco     ,owner: dbuser_noco     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>nocodb database }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个数据库定义都是一个复杂对象，可能包括以下字段，除了 <code>name</code> 字段外，其他字段均为可选字段：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是数据库定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>create                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库状态：create（创建，默认）、absent（删除）、recreate（重建）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库 sql 的基线定义文件路径（ansible 搜索路径中的相对路径，如 files/）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库添加到 pgbouncer 数据库列表？默认为 true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要创建的附加模式，由模式名称字符串组成的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，要安装的附加扩展： 扩展对象的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可以指定将扩展安装到某个模式中，也可以不指定（不指定则安装到 search_path 首位模式中）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 例如有的扩展会创建并使用固定的模式，就不需要指定模式。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库的说明与备注信息</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库所有者，不指定则为当前用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要使用的模板，默认为 template1，目标必须是一个模板数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，克隆策略：FILE_COPY 或 WAL_LOG（PG15+），不指定使用 PG 默认</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（UTF8）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（C）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（C）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（C）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>libc          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，本地化提供者：libc、icu、builtin（PG15+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，ICU 本地化规则（PG15+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，ICU 排序规则（PG16+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，内置本地化提供者规则（PG17+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认表空间，默认为 &#39;pg_default&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>is_template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，是否标记为模板数据库，允许任何有 CREATEDB 权限的用户克隆</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库注册到 grafana 数据源？默认为 true，显式设置为 false 会跳过注册</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库连接限制，默认为 -1 ，不限制，设置为正整数则会限制连接数。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，数据库级参数，通过 ALTER DATABASE SET 设置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;64MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，连接到此 pgbouncer 数据库的所有连接都将使用此用户进行验证（启用 pgbouncer_auth_query 才有用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池化模式，默认为 transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 默认池子大小，默认为 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池子保留空间，默认为 32，当默认池子不够用时，最多再申请这么多条突发连接。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池的最小大小，默认为 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的最大数据库连接数，默认为 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>自 Pigsty <code>v4.1.0</code> 起，数据库连接池参数统一使用 <code>pool_reserve</code> 与 <code>pool_connlimit</code>，旧别名 <code>pool_size_reserve</code> / <code>pool_max_db_conn</code> 已收敛。</p></blockquote><hr><h2 id=参数总览>参数总览</h2><p>所有参数中唯一 <strong>必选</strong> 的字段是 <code>name</code>，它应该是当前 PostgreSQL 集群中有效且唯一的数据库名称，其他参数都有合理的默认值，均为可选项。
带有 “<strong>不可变</strong>” 标记的参数仅在数据库创建时生效，创建后无法修改，若需更改则必须删除并重建数据库。</p><table class=full-width><thead><tr><th>字段</th><th>分类</th><th>类型</th><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><a href=#name><strong><code>name</code></strong></a></td><td>基本</td><td><code>string</code></td><td>必选</td><td>数据库名称，必须是有效且唯一的标识符</td></tr><tr><td><a href=#state><strong><code>state</code></strong></a></td><td>基本</td><td><code>enum</code></td><td>可选</td><td>数据库状态：<code>create</code>（默认）、<code>absent</code>、<code>recreate</code></td></tr><tr><td><a href=#owner><strong><code>owner</code></strong></a></td><td>基本</td><td><code>string</code></td><td>可变</td><td>数据库属主，不指定则为 <code>postgres</code></td></tr><tr><td><a href=#comment><strong><code>comment</code></strong></a></td><td>基本</td><td><code>string</code></td><td>可变</td><td>数据库备注信息</td></tr><tr><td><a href=#template><strong><code>template</code></strong></a></td><td>模板</td><td><code>string</code></td><td>不可变</td><td>创建时使用的模板数据库，默认 <code>template1</code></td></tr><tr><td><a href=#strategy><strong><code>strategy</code></strong></a></td><td>模板</td><td><code>enum</code></td><td>不可变</td><td>克隆策略：<code>FILE_COPY</code> 或 <code>WAL_LOG</code>（PG15+）</td></tr><tr><td><a href=#encoding><strong><code>encoding</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>字符编码，默认继承模板（<code>UTF8</code>）</td></tr><tr><td><a href=#locale><strong><code>locale</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>本地化规则，默认继承模板（<code>C</code>）</td></tr><tr><td><a href=#lc_collate><strong><code>lc_collate</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>排序规则，默认继承模板（<code>C</code>）</td></tr><tr><td><a href=#lc_ctype><strong><code>lc_ctype</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>字符分类，默认继承模板（<code>C</code>）</td></tr><tr><td><a href=#locale_provider><strong><code>locale_provider</code></strong></a></td><td>编码</td><td><code>enum</code></td><td>不可变</td><td>本地化提供者：<code>libc</code>、<code>icu</code>、<code>builtin</code>（PG15+）</td></tr><tr><td><a href=#icu_locale><strong><code>icu_locale</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>ICU 本地化规则（PG15+）</td></tr><tr><td><a href=#icu_rules><strong><code>icu_rules</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>ICU 排序定制规则（PG16+）</td></tr><tr><td><a href=#builtin_locale><strong><code>builtin_locale</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>内置本地化规则（PG17+）</td></tr><tr><td><a href=#tablespace><strong><code>tablespace</code></strong></a></td><td>存储</td><td><code>string</code></td><td>可变</td><td>默认表空间，修改会触发数据迁移</td></tr><tr><td><a href=#is_template><strong><code>is_template</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否标记为模板数据库</td></tr><tr><td><a href=#allowconn><strong><code>allowconn</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否允许连接，默认 <code>true</code></td></tr><tr><td><a href=#revokeconn><strong><code>revokeconn</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否回收 PUBLIC 的 CONNECT 权限</td></tr><tr><td><a href=#connlimit><strong><code>connlimit</code></strong></a></td><td>权限</td><td><code>int</code></td><td>可变</td><td>连接数限制，<code>-1</code> 表示不限制</td></tr><tr><td><a href=#baseline><strong><code>baseline</code></strong></a></td><td>初始化</td><td><code>string</code></td><td>可变</td><td>SQL 基线文件路径，仅首次创建时执行</td></tr><tr><td><a href=#schemas><strong><code>schemas</code></strong></a></td><td>初始化</td><td><code>(string|object)[]</code></td><td>可变</td><td>要创建的模式定义数组</td></tr><tr><td><a href=#extensions><strong><code>extensions</code></strong></a></td><td>初始化</td><td><code>(string|object)[]</code></td><td>可变</td><td>要安装的扩展定义数组</td></tr><tr><td><a href=#parameters><strong><code>parameters</code></strong></a></td><td>初始化</td><td><code>object</code></td><td>可变</td><td>数据库级参数</td></tr><tr><td><a href=#pgbouncer><strong><code>pgbouncer</code></strong></a></td><td>连接池</td><td><code>bool</code></td><td>可变</td><td>是否加入连接池，默认 <code>true</code></td></tr><tr><td><a href=#pool_mode><strong><code>pool_mode</code></strong></a></td><td>连接池</td><td><code>enum</code></td><td>可变</td><td>池化模式：<code>transaction</code>（默认）</td></tr><tr><td><a href=#pool_size><strong><code>pool_size</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>默认池大小，默认 <code>64</code></td></tr><tr><td><a href=#pool_size_min><strong><code>pool_size_min</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>最小池大小，默认 <code>0</code></td></tr><tr><td><a href=#pool_reserve><strong><code>pool_reserve</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>保留池大小，默认 <code>32</code></td></tr><tr><td><a href=#pool_connlimit><strong><code>pool_connlimit</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>最大数据库连接数，默认 <code>100</code></td></tr><tr><td><a href=#pool_auth_user><strong><code>pool_auth_user</code></strong></a></td><td>连接池</td><td><code>string</code></td><td>可变</td><td>认证查询用户</td></tr><tr><td><a href=#register_datasource><strong><code>register_datasource</code></strong></a></td><td>监控</td><td><code>bool</code></td><td>可变</td><td>是否注册到 Grafana 数据源，默认 <code>true</code></td></tr></tbody></table><hr><h2 id=参数详情>参数详情</h2><h3 id=name><code>name</code></h3><p>字符串，必选参数，表示数据库的名称，在一个数据库集群内集群内必须唯一。</p><p>数据库名称必须是有效的 PostgreSQL 标识符，长度不超过 63 个字符，不得使用 SQL 关键字，
形式上以字母或下划线开头，后续字符可以是字母、数字或下划线，不能包含空格或特殊字符。
形式应当满足正则表达式：<strong><code>^[A-Za-z_][A-Za-z0-9_$]{0,62}$</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单命名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>my_application    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 下划线分隔</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_v2            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 包含版本号</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=state><code>state</code></h3><p>枚举值，用于指定要对数据库执行的操作，可以是 <code>create</code>、<code>absent</code> 或 <code>recreate</code>，默认值为 <code>create</code>。</p><table class=full-width><thead><tr><th>状态</th><th>说明</th></tr></thead><tbody><tr><td><code>create</code></td><td>默认，创建或修改数据库，如果已经存在，则将可变参数调整到描述的状态</td></tr><tr><td><code>absent</code></td><td>删除数据库，使用 <code>DROP DATABASE WITH (FORCE)</code></td></tr><tr><td><code>recreate</code></td><td>先删除再创建，用于重置数据库</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># state 默认为 create</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olddb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 删除数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>testdb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>recreate           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重建数据库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=owner><code>owner</code></h3><p>字符串，指定数据库的属主用户，默认不指定，不指定则为数据库 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a>，即 <code>postgres</code> 用户。</p><p>要指定数据库的 <code>owner</code>，被指定的用户必须已存在。修改 owner 会执行：旧 Owner 在数据库上的权限不会被撤回。</p><p>数据库属主具有对数据库的完全控制权限，包括创建模式、表、扩展等对象的权限，对于多租户场景尤为有用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OWNER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;new_owner&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;new_owner&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=comment><code>comment</code></h3><p>字符串，用于设置数据库的备注信息，如果不指定，默认值为 <code>business database {name}</code>。</p><p>数据库备注信息通过 <code>COMMENT ON DATABASE</code> 语句设置，支持中文和特殊字符（Pigsty 会自动转义单引号）。
备注信息会存储在系统目录 <code>pg_database.datacl</code> 中，可以通过 <code>\l+</code> 命令查看。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;我的应用主数据库&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>我的应用主数据库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=template><code>template</code></h3><p>字符串，<strong>不可变参数</strong>，用于指定创建数据库时使用的模板数据库，默认值为 <code>template1</code>。</p><p>PostgreSQL 的 <code>CREATE DATABASE</code> 本质上是对模板数据库进行复制，新数据库会继承模板中的所有对象、扩展、模式、权限设置等。
Pigsty 会在集群初始化阶段对 <code>template1</code> 进行定制配置，因此新建数据库默认会继承这些设置。</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><code>template1</code></td><td>默认模板，包含 Pigsty 预配置的扩展、模式和权限设置</td></tr><tr><td><code>template0</code></td><td>干净模板，使用不同于集群默认的本地化提供者时，必须使用此模板</td></tr><tr><td>自定义数据库</td><td>可以使用已有数据库作为模板进行克隆</td></tr></tbody></table><p>使用 <code>icu</code> 或 <code>builtin</code> 本地化提供者时，必须指定 <code>template: template0</code>，因为 <code>template1</code> 已有本地化设置无法覆盖。
使用其他</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用 ICU 时必须指定 template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zh-Hans</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用 <code>template0</code> 时，监控所需的扩展与 Schema，以及角色的默认权限都不再自动创建，这允许你从一个完全干净的模板开始定制数据库。</p><h3 id=strategy><code>strategy</code></h3><p>枚举值，不可变参数，用于指定从模板克隆数据库的策略，可选值为 <code>FILE_COPY</code> 或 <code>WAL_LOG</code>，此参数在 PostgreSQL 15 及以上版本可用。</p><table class=full-width><thead><tr><th>策略</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>FILE_COPY</code></td><td>直接复制数据文件，PG15+ 默认</td><td>大模板，通用场景</td></tr><tr><td><code>WAL_LOG</code></td><td>通过 WAL 日志记录复制</td><td>小模板，不阻塞模板上的连接</td></tr></tbody></table><p><code>WAL_LOG</code> 策略的优势是复制过程中不会阻塞模板数据库上的连接，但对于较大的模板效率不如 <code>FILE_COPY</code>。
在 PostgreSQL 14 及更早版本中，此参数会被忽略。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cloned_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>source_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>WAL_LOG         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用 WAL 日志方式克隆</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=encoding><code>encoding</code></h3><p>字符串，不可变参数，用于指定数据库的字符编码，如果不指定则继承模板数据库的编码设置，通常为 <code>UTF8</code>。</p><p>如果没有特殊原因，强烈建议使用 <code>UTF8</code> 编码。字符编码在数据库创建后无法修改，如需更改必须重建数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>legacy_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指定非默认编码时使用 template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>LATIN1</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=locale><code>locale</code></h3><p>字符串，不可变参数，用于指定数据库的本地化规则，相当于同时设置 <code>lc_collate</code> 和 <code>lc_ctype</code>，如果不指定则继承模板数据库的设置，通常为 <code>C</code>。</p><p>本地化规则决定了字符串的排序顺序和字符分类行为。使用 <code>C</code> 或 <code>POSIX</code> 可获得最佳性能和跨平台一致性，
使用特定语言的本地化规则（如 <code>zh_CN.UTF-8</code>）可以获得符合该语言习惯的排序结果。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>chinese_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zh_CN.UTF-8       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 中文本地化</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=lc_collate><code>lc_collate</code></h3><p>字符串，不可变参数，用于指定字符串的排序规则，如果不指定则继承模板数据库的设置，通常为 <code>C</code>。</p><p>排序规则决定了 <code>ORDER BY</code> 和比较操作的结果。常用值包括：<code>C</code>（字节序，最快）、<code>C.UTF-8</code>、<code>en_US.UTF-8</code>、<code>zh_CN.UTF-8</code>。
此参数在数据库创建后无法修改。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en_US.UTF-8   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 英文排序规则</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en_US.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=lc_ctype><code>lc_ctype</code></h3><p>字符串，不可变参数，用于指定字符分类规则，决定字符的大小写、数字、字母等分类，如果不指定则继承模板数据库的设置，通常为 <code>C</code>。</p><p>字符分类规则影响 <code>upper()</code>、<code>lower()</code>、正则表达式中的 <code>\w</code> 等函数的行为。此参数在数据库创建后无法修改。</p><h3 id=locale_provider><code>locale_provider</code></h3><p>枚举值，不可变参数，用于指定本地化的实现提供者，可选值为 <code>libc</code>、<code>icu</code> 或 <code>builtin</code>，此参数在 PostgreSQL 15 及以上版本可用，默认值为 <code>libc</code>。</p><table class=full-width><thead><tr><th>提供者</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td><code>libc</code></td><td>-</td><td>使用操作系统 C 库，传统默认方式，行为因系统而异</td></tr><tr><td><code>icu</code></td><td>PG15+</td><td>使用 ICU 库，跨平台一致，支持更多语言</td></tr><tr><td><code>builtin</code></td><td>PG17+</td><td>PostgreSQL 内置实现，最高效，仅支持 C/C.UTF-8</td></tr></tbody></table><p>使用 <code>icu</code> 或 <code>builtin</code> 提供者时，必须指定 <code>template: template0</code>，并配合相应的 <code>icu_locale</code> 或 <code>builtin_locale</code> 参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>fast_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>builtin  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用内置提供者，最高效</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=icu_locale><code>icu_locale</code></h3><p>字符串，不可变参数，用于指定 ICU 本地化规则标识符，此参数在 PostgreSQL 15 及以上版本、且 <code>locale_provider</code> 为 <code>icu</code> 时可用。</p><p>ICU 本地化标识符遵循 BCP 47 标准，常用值包括：</p><table class=full-width><thead><tr><th>值</th><th>说明</th></tr></thead><tbody><tr><td><code>en-US</code></td><td>美式英语</td></tr><tr><td><code>en-GB</code></td><td>英式英语</td></tr><tr><td><code>zh-Hans</code></td><td>简体中文</td></tr><tr><td><code>zh-Hant</code></td><td>繁体中文</td></tr><tr><td><code>ja-JP</code></td><td>日语</td></tr><tr><td><code>ko-KR</code></td><td>韩语</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>chinese_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zh-Hans       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简体中文 ICU 排序</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=icu_rules><code>icu_rules</code></h3><p>字符串，不可变参数，用于自定义 ICU 排序规则，此参数在 PostgreSQL 16 及以上版本可用。</p><p>ICU 规则允许对默认排序行为进行微调，使用 <a href=https://unicode-org.github.io/icu/userguide/collation/customization/><strong>ICU 排序规则语法</strong></a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom_sort_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&amp;V &lt;&lt; w &lt;&lt;&lt; W&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 自定义 V/W 排序顺序</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=builtin_locale><code>builtin_locale</code></h3><p>字符串，不可变参数，用于指定内置本地化提供者的规则，此参数在 PostgreSQL 17 及以上版本、且 <code>locale_provider</code> 为 <code>builtin</code> 时可用，可选值为 <code>C</code> 或 <code>C.UTF-8</code>。</p><p><code>builtin</code> 提供者是 PostgreSQL 17 新增的内置本地化实现，比 <code>libc</code> 更快，且行为跨平台完全一致。
适合只需要 <code>C</code> 或 <code>C.UTF-8</code> 排序规则的场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>fast_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>builtin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 内置 UTF-8 支持</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=tablespace><code>tablespace</code></h3><p>字符串，可变参数，用于指定数据库的默认表空间，默认值为 <code>pg_default</code>。</p><p>修改现有数据库的表空间会触发数据物理迁移，PostgreSQL 会将数据库中的所有对象移动到新表空间，对于大数据库可能需要较长时间，慎用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>archive_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>slow_hdd      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 归档数据使用慢速存储</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;archive_db&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>TABLESPACE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;slow_hdd&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=is_template><code>is_template</code></h3><p>布尔值，可变参数，用于指定是否将数据库标记为模板数据库，默认值为 <code>false</code>。</p><p>设置为 <code>true</code> 后，任何拥有 <code>CREATEDB</code> 权限的用户都可以使用此数据库作为模板克隆新数据库。
模板数据库通常用于预装标准模式、扩展和数据，方便快速创建具有相同配置的新数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>is_template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 标记为模板，允许普通用户克隆</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>core, api]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>postgis, pg_trgm]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>删除标记为 <code>is_template: true</code> 的数据库时，Pigsty 会先执行 <code>ALTER DATABASE ... IS_TEMPLATE false</code> 取消模板标记，然后再删除。</p><h3 id=allowconn><code>allowconn</code></h3><p>布尔值，可变参数，用于控制是否允许连接到此数据库，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 会在数据库层面完全禁止连接，任何用户（包括超级用户）都无法连接到此数据库。
此参数通常用于维护或归档用途。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>archive_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 禁止任何连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;archive_db&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>ALLOW_CONNECTIONS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=revokeconn><code>revokeconn</code></h3><p>布尔值，可变参数，用于控制是否回收 PUBLIC 角色的 <code>CONNECT</code> 权限，默认值为 <code>false</code>。</p><p>设置为 <code>true</code> 时，Pigsty 会执行以下权限变更：</p><ul><li>回收 PUBLIC 的 CONNECT 权限，普通用户将无法连接</li><li>授予复制用户（<code>replicator</code>）和监控用户（<code>dbuser_monitor</code>）连接权限</li><li>授予管理员用户（<code>dbuser_dba</code>）和数据库属主连接权限，并附带 <code>WITH GRANT OPTION</code></li></ul><p>设置为 <code>false</code> 时，会恢复 PUBLIC 的 CONNECT 权限。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>secure_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_secure</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 回收公共连接权限，只有指定用户可连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=connlimit><code>connlimit</code></h3><p>整数，可变参数，用于限制数据库的最大并发连接数，默认值为 <code>-1</code>，表示不限制。</p><p>设置为正整数时，会限制同时连接到此数据库的最大会话数。此限制不影响超级用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>limited_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 最多允许 50 个并发连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;limited_db&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=baseline><code>baseline</code></h3><p>字符串，一次性参数，用于指定数据库创建后要执行的 SQL 基线文件路径。</p><p>基线文件通常包含表结构定义、初始数据、存储过程等，用于初始化新数据库。
路径是相对于 Ansible 搜索路径的相对路径，通常放在 <code>files/</code> 目录下。</p><p>基线文件仅在首次创建数据库时执行；如果数据库已存在则跳过。使用 <code>state: recreate</code> 重建数据库时会重新执行基线文件。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_schema.sql </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 会查找 files/myapp_schema.sql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=schemas><code>schemas</code></h3><p>数组，可变参数（支持增删），用于定义要在数据库中创建或删除的模式。数组元素可以是字符串或对象。</p><p>简单格式使用字符串直接指定模式名，仅支持创建操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>api</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>core</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>完整格式使用对象定义，支持指定模式属主和删除操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 模式名（必选）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 模式属主（可选），生成 AUTHORIZATION 子句</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>deprecated</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 删除模式（使用 CASCADE）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>创建模式时使用 <code>IF NOT EXISTS</code>，已存在则跳过；删除模式时使用 <code>CASCADE</code>，会同时删除模式内的所有对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AUTHORIZATION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;deprecated&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=extensions><code>extensions</code></h3><p>数组，可变参数（支持增删），用于定义要在数据库中安装或卸载的扩展。数组元素可以是字符串或对象。</p><p>简单格式使用字符串直接指定扩展名，仅支持安装操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgis</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pg_trgm</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>vector</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>完整格式使用对象定义，支持指定安装模式、版本和卸载操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>vector            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 扩展名（必选）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装到指定模式（可选）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.5.1&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 指定版本（可选）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>old_extension</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 卸载扩展（使用 CASCADE）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>安装扩展时使用 <code>CASCADE</code>，如果已存在则会报错但跳过，同时自动安装依赖扩展；卸载扩展时使用 <code>CASCADE</code>，会同时删除依赖此扩展的对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;vector&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;public&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VERSION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.5.1&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;old_extension&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=parameters><code>parameters</code></h3><p>对象，可变参数，用于设置数据库级别的配置参数。参数通过 <code>ALTER DATABASE ... SET</code> 设置，会对连接到此数据库的所有会话生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;512MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用特殊值 <code>DEFAULT</code>（大小写不敏感）可以将参数重置为 PostgreSQL 默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 设置新值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgbouncer><code>pgbouncer</code></h3><p>布尔值，可变参数，用于控制是否将数据库添加到 Pgbouncer 连接池列表，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 时，数据库不会出现在 Pgbouncer 的数据库列表中，客户端无法通过连接池访问此数据库。
适用于内部管理数据库或需要直连的特殊场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>internal_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 不通过连接池访问</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_mode><code>pool_mode</code></h3><p>枚举值，可变参数，用于设置此数据库在 Pgbouncer 中的池化模式，可选值为 <code>transaction</code>、<code>session</code> 或 <code>statement</code>，默认值为 <code>transaction</code>。</p><table class=full-width><thead><tr><th>模式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>transaction</code></td><td>事务结束后归还连接</td><td>大多数 OLTP 应用，默认推荐</td></tr><tr><td><code>session</code></td><td>会话结束后归还连接</td><td>需要会话级状态的应用</td></tr><tr><td><code>statement</code></td><td>每条语句后归还连接</td><td>简单无状态查询，极致复用</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用会话级池化</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_size><code>pool_size</code></h3><p>整数，可变参数，用于设置此数据库在 Pgbouncer 中的默认连接池大小，默认值为 <code>64</code>。</p><p>连接池大小决定了 Pgbouncer 为此数据库预留的后端连接数量。根据应用负载调整此值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>high_load_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>128</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 高负载应用使用更大的池</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_size_min><code>pool_size_min</code></h3><p>整数，可变参数，用于设置此数据库在 Pgbouncer 中的最小连接池大小，默认值为 <code>0</code>。</p><p>设置大于 0 的值会让 Pgbouncer 预先创建指定数量的后端连接，用于连接预热，减少首次请求的延迟。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latency_sensitive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 预热 10 个连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_reserve><code>pool_reserve</code></h3><p>整数，可变参数，用于设置此数据库在 Pgbouncer 中的保留连接数，默认值为 <code>32</code>。</p><p>当默认池不够用时，Pgbouncer 最多可以额外申请 <code>pool_reserve</code> 个连接来处理突发流量。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bursty_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 允许突发到 128 个连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_connlimit><code>pool_connlimit</code></h3><p>整数，可变参数，用于设置通过 Pgbouncer 连接池访问此数据库的最大连接数，默认值为 <code>100</code>。</p><p>此限制是 Pgbouncer 层面的限制，与数据库本身的 <code>connlimit</code> 参数独立。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>limited_pool_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 连接池最多 50 个连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_auth_user><code>pool_auth_user</code></h3><p>字符串，可变参数，用于指定 Pgbouncer 认证查询使用的用户。</p><p>此参数需要配合 <a href=/docs/pgsql/param#pgbouncer_auth_query><strong><code>pgbouncer_auth_query</code></strong></a> 参数启用才生效。
设置后，所有通过 Pgbouncer 连接到此数据库的请求都会使用指定用户执行认证查询来验证密码。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用监控用户执行认证查询</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=register_datasource><code>register_datasource</code></h3><p>布尔值，可变参数，用于控制是否将此数据库注册到 Grafana 作为 PostgreSQL 数据源，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 可以跳过 Grafana 数据源注册。适用于临时数据库、测试数据库，或不希望在监控系统中出现的内部数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 不注册到 Grafana</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=模板继承>模板继承</h2><p>许多参数如果不显式指定，会从模板数据库继承。默认模板是 <code>template1</code>，其编码设置由集群初始化参数决定：</p><table class=full-width><thead><tr><th>集群参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/param#pg_encoding><strong><code>pg_encoding</code></strong></a></td><td><code>UTF8</code></td><td>集群默认字符编码</td></tr><tr><td><a href=/docs/pgsql/param#pg_locale><strong><code>pg_locale</code></strong></a></td><td><code>C</code> / <code>C-UTF-8</code> (如果支持)</td><td>集群默认本地化</td></tr><tr><td><a href=/docs/pgsql/param#pg_lc_collate><strong><code>pg_lc_collate</code></strong></a></td><td><code>C</code> / <code>C-UTF-8</code> (如果支持)</td><td>集群默认排序规则</td></tr><tr><td><a href=/docs/pgsql/param#pg_lc_ctype><strong><code>pg_lc_ctype</code></strong></a></td><td><code>C</code> / <code>C-UTF-8</code> (如果支持)</td><td>集群默认字符分类</td></tr></tbody></table><p>新创建的数据库默认会从 <code>template1</code> 数据库 Fork 出来，这个模版数据库会在 <a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a> 阶段进行定制修改：
配置好扩展、模式以及默认权限，因此新创建的数据库也会继承这些配置，除非您显式使用一个其他的数据库作为模板。</p><hr><h2 id=深度定制>深度定制</h2><p>Pigsty 提供了丰富的定制参数与配置旋钮，如果你想定制模板数据库，请参考以下资源：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a> ：postgres 集群中的默认预定义角色和系统用户</li><li><a href=/docs/pgsql/param#pg_default_privileges><strong><code>pg_default_privileges</code></strong></a> ：由管理员用户创建数据库内对象时的默认权限</li><li><a href=/docs/pgsql/param#pg_default_schemas><strong><code>pg_default_schemas</code></strong></a> ：要创建的默认模式列表</li><li><a href=/docs/pgsql/param#pg_default_extensions><strong><code>pg_default_extensions</code></strong></a> ：要创建的默认扩展列表</li><li><a href=/docs/pgsql/param#pg_default_hba_rules><strong><code>pg_default_hba_rules</code></strong></a> ：postgres 基于主机的认证规则，全局PG默认HBA</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><strong><code>pgb_default_hba_rules</code></strong></a> ：pgbouncer 默认的基于主机的认证规则，全局PGB默认HBA</li></ul><p>如果上面这些配置仍然无法满足您的需求，您可以使用 <a href=/docs/pgsql/param#pg_init><strong><code>pg_init</code></strong></a> 指定自定义的集群初始化脚本进行定制：</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init><strong><code>pg-init</code></strong></a> ：集群初始化脚本</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><strong><code>pg-init-template.sql</code></strong></a>：模板定制 SQL</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-roles.sql><strong><code>pg-init-roles.sql</code></strong></a>：定制默认角色的 SQL</li></ul><hr><h2 id=本地化提供者>本地化提供者</h2><p>PostgreSQL 15+ 引入了 <strong><code>locale_provider</code></strong> 参数，支持不同的本地化实现。这些属性只能在数据库创建时指定，之后无法修改。</p><p>Pigsty 在 <a href=/docs/concept/iac/configure><strong><code>configure</code></strong></a> 配置向导中会根据 PG 与操作系统版本，优先使用 PG 内置的 C.UTF-8/C 本地化提供者。
数据库在默认情况下继承集群的本地化设置。如果您要为数据库指定一个不同于集群默认的本地化提供者，则必须使用 <code>template0</code> 作为模板数据库。</p><p><strong>使用 ICU 提供者（PG15+）</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ICU 必须使用 template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ICU 本地化规则</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>使用内置提供者（PG17+）</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_builtin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>builtin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 内置本地化规则</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>提供者对比</strong>：<code>libc</code>（传统方式，依赖操作系统）、<code>icu</code>（PG15+，跨平台一致，功能丰富）、<code>builtin</code>（PG17+，最高效的 C/C.UTF-8 排序）。</p><hr><h2 id=连接池>连接池</h2><p><a href=/docs/concept/arch/pgsql#pgbouncer><strong>Pgbouncer</strong></a> 连接池可以优化短连接性能，降低并发征用，以避免过高的连接数冲垮数据库，并在数据库迁移时提供额外的灵活处理空间。</p><p>Pigsty 会默认为 PostgreSQL 实例 1:1 配置启用一个连接池，
使用和 PostgreSQL 同样的 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> 运行，默认为 <code>postgres</code> 操作系统用户。
连接池与数据库使用 <code>/var/run/postgresql</code> Unix Socket 通信。</p><p>Pigsty 默认将 <a href=/docs/pgsql/param/#pg_databases><code>pg_databases</code></a> 中的所有数据库都添加到 pgbouncer 的数据库列表中。
您可以通过在数据库定义中显式设置 <a href=#pgbouncer><code>pgbouncer: false</code></a> 来禁用特定数据库的 pgbouncer 连接池支持。
pgbouncer 数据库列表与其配置参数在 <code>/etc/pgbouncer/database.txt</code> 中定义。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>meta                        = host=/var/run/postgresql mode=session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>grafana                     = host=/var/run/postgresql mode=transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bytebase                    = host=/var/run/postgresql auth_user=dbuser_meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>kong                        = host=/var/run/postgresql pool_size=32 reserve_pool=64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>gitea                       = host=/var/run/postgresql min_pool_size=10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>wiki                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>noco                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>mongo                       = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>当您 <a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93><strong>创建数据库</strong></a>时，Pgbouncer 的数据库列表定义文件将会被刷新，并通过在线重载配置的方式生效，正常不会影响现有的连接。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-be500246ccc4d0aea19a8d2e848cf128>2.6 - HBA 规则</h1><div class=lead>Pigsty 中 PostgreSQL 与 Pgbouncer 的 HBA（Host-Based Authentication）规则配置详解。</div><h2 id=概述>概述</h2><p>HBA（Host-Based Authentication）控制"谁可以从哪里、以什么方式连接到数据库"。
Pigsty 通过 <a href=#pg_default_hba_rules><strong><code>pg_default_hba_rules</code></strong></a> 与 <a href=#pg_hba_rules><strong><code>pg_hba_rules</code></strong></a> 让 HBA 规则也能以声明式配置形式管理。</p><p>Pigsty 在集群初始化或 HBA 刷新时渲染以下配置文件：</p><table><thead><tr><th style=text-align:left>配置文件</th><th style=text-align:left>路径</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>PostgreSQL HBA</td><td style=text-align:left><code>/pg/data/pg_hba.conf</code></td><td style=text-align:left>PostgreSQL 服务器的 HBA 规则</td></tr><tr><td style=text-align:left>Pgbouncer HBA</td><td style=text-align:left><code>/etc/pgbouncer/pgb_hba.conf</code></td><td style=text-align:left>连接池 Pgbouncer 的 HBA 规则</td></tr></tbody></table><p>HBA 规则由以下参数控制：</p><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>层级</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_default_hba_rules><code>pg_default_hba_rules</code></a></td><td style=text-align:left>G</td><td style=text-align:left>PostgreSQL 全局默认 HBA 规则</td></tr><tr><td style=text-align:left><a href=#pg_hba_rules><code>pg_hba_rules</code></a></td><td style=text-align:left>G/C/I</td><td style=text-align:left>PostgreSQL 集群/实例级追加规则</td></tr><tr><td style=text-align:left><a href=#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a></td><td style=text-align:left>G</td><td style=text-align:left>Pgbouncer 全局默认 HBA 规则</td></tr><tr><td style=text-align:left><a href=#pgb_hba_rules><code>pgb_hba_rules</code></a></td><td style=text-align:left>G/C/I</td><td style=text-align:left>Pgbouncer 集群/实例级追加规则</td></tr></tbody></table><p>规则支持以下特性：</p><ul><li><strong>按角色过滤</strong>：规则支持 <code>role</code> 字段，根据实例的 <code>pg_role</code> 自动筛选生效</li><li><strong>按顺序排序</strong>：规则支持 <code>order</code> 字段，控制规则在最终配置文件中的位置</li><li><strong>两种写法</strong>：支持别名形式（简化语法）和原始形式（直接 HBA 文本）</li></ul><hr><h2 id=刷新-hba>刷新 HBA</h2><p>修改配置后，需要重新渲染配置文件并让服务重载：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;                   <span style=color:#8f5902;font-style:italic># 刷新整个集群的 HBA 规则（推荐）</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; &lt;ip&gt;...           <span style=color:#8f5902;font-style:italic># 刷新集群中指定实例的 HBA 规则</span>
</span></span></code></pre></div><p>脚本内部执行以下剧本命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><p><strong>仅刷新 PostgreSQL</strong>：<code>./pgsql.yml -l &lt;cls> -t pg_hba,pg_reload -e pg_reload=true</code></p><p><strong>仅刷新 Pgbouncer</strong>：<code>./pgsql.yml -l &lt;cls> -t pgbouncer_hba,pgbouncer_reload</code></p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>不要直接编辑配置文件</div><p>不要直接编辑 <code>/pg/data/pg_hba.conf</code> 或 <code>/etc/pgbouncer/pgb_hba.conf</code>，下次执行 playbook 时会被覆盖。
所有变更应在 <code>pigsty.yml</code> 中进行，然后执行 <code>bin/pgsql-hba</code> 刷新。</p></div><hr><h2 id=参数详解>参数详解</h2><h3 id=pg_default_hba_rules><code>pg_default_hba_rules</code></h3><p>PostgreSQL 全局默认 HBA 规则列表，通常定义在 <code>all.vars</code> 中，为所有 PostgreSQL 集群提供基础访问控制。</p><ul><li>类型：<code>rule[]</code>，层级：全局 (G)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title: &#39;admin @ everywhere with ssl &amp; pwd&#39;    ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_hba_rules><code>pg_hba_rules</code></h3><p>PostgreSQL 集群/实例级 HBA 追加规则，可在集群或实例级别覆盖，与默认规则合并后按 <code>order</code> 排序。</p><ul><li>类型：<code>rule[]</code>，层级：全局/集群/实例 (G/C/I)，默认值：<code>[]</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: app_user, db: app_db, addr: intra, auth: pwd, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app user access&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgb_default_hba_rules><code>pgb_default_hba_rules</code></h3><p>Pgbouncer 全局默认 HBA 规则列表，通常定义在 <code>all.vars</code> 中。</p><ul><li>类型：<code>rule[]</code>，层级：全局 (G)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgb_hba_rules><code>pgb_hba_rules</code></h3><p>Pgbouncer 集群/实例级 HBA 追加规则。</p><ul><li>类型：<code>rule[]</code>，层级：全局/集群/实例 (G/C/I)，默认值：<code>[]</code></li></ul><blockquote><p><strong>注意</strong>：Pgbouncer HBA 不支持 <code>db: replication</code>。</p></blockquote><hr><h2 id=规则字段>规则字段</h2><p>每条 HBA 规则是一个 YAML 字典，支持以下字段：</p><table><thead><tr><th style=text-align:left>字段</th><th style=text-align:left>类型</th><th style=text-align:left>必需</th><th style=text-align:left>默认值</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>user</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left><code>all</code></td><td style=text-align:left>用户名，支持 <code>all</code>、变量占位符、<code>+rolename</code> 等</td></tr><tr><td style=text-align:left><code>db</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left><code>all</code></td><td style=text-align:left>数据库名，支持 <code>all</code>、<code>replication</code>、具体库名</td></tr><tr><td style=text-align:left><code>addr</code></td><td style=text-align:left>string</td><td style=text-align:left>是*</td><td style=text-align:left>-</td><td style=text-align:left>地址别名或 CIDR，见 <a href=#%E5%9C%B0%E5%9D%80%E5%88%AB%E5%90%8D><strong>地址别名</strong></a></td></tr><tr><td style=text-align:left><code>auth</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left><code>pwd</code></td><td style=text-align:left>认证方式别名，见 <a href=#%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F><strong>认证方式</strong></a></td></tr><tr><td style=text-align:left><code>title</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left>-</td><td style=text-align:left>规则说明/注释，会渲染为配置文件中的注释</td></tr><tr><td style=text-align:left><code>role</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left><code>common</code></td><td style=text-align:left>实例角色过滤，见 <a href=#%E8%A7%92%E8%89%B2%E8%BF%87%E6%BB%A4><strong>角色过滤</strong></a></td></tr><tr><td style=text-align:left><code>order</code></td><td style=text-align:left>int</td><td style=text-align:left>否</td><td style=text-align:left><code>1000</code></td><td style=text-align:left>排序权重，数字小的排前面，见 <a href=#%E6%8E%92%E5%BA%8F%E6%9C%BA%E5%88%B6><strong>排序机制</strong></a></td></tr><tr><td style=text-align:left><code>rules</code></td><td style=text-align:left>list</td><td style=text-align:left>是*</td><td style=text-align:left>-</td><td style=text-align:left>原始 HBA 文本行列表，与 <code>addr</code> 二选一</td></tr></tbody></table><blockquote><p><code>addr</code> 和 <code>rules</code> 必须指定其一。使用 <code>rules</code> 时可以直接写原始 HBA 格式。</p></blockquote><hr><h2 id=地址别名>地址别名</h2><p>Pigsty 提供地址别名，简化 HBA 规则编写：</p><table><thead><tr><th style=text-align:left>别名</th><th style=text-align:left>展开为</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>local</code></td><td style=text-align:left>Unix socket</td><td style=text-align:left>本地 Unix 套接字连接</td></tr><tr><td style=text-align:left><code>localhost</code></td><td style=text-align:left>Unix socket + <code>127.0.0.1/32</code> + <code>::1/128</code></td><td style=text-align:left>本地回环地址</td></tr><tr><td style=text-align:left><code>admin</code></td><td style=text-align:left><code>${admin_ip}/32</code></td><td style=text-align:left>管理员 IP 地址</td></tr><tr><td style=text-align:left><code>infra</code></td><td style=text-align:left>所有 infra 组节点 IP</td><td style=text-align:left>基础设施节点列表</td></tr><tr><td style=text-align:left><code>cluster</code></td><td style=text-align:left>当前集群所有成员 IP</td><td style=text-align:left>同一集群内的所有实例</td></tr><tr><td style=text-align:left><code>intra</code> / <code>intranet</code></td><td style=text-align:left><code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code></td><td style=text-align:left>内网 CIDR 网段</td></tr><tr><td style=text-align:left><code>world</code> / <code>all</code></td><td style=text-align:left><code>0.0.0.0/0</code> + <code>::/0</code></td><td style=text-align:left>任意地址（IPv4 + IPv6）</td></tr><tr><td style=text-align:left><code>&lt;CIDR></code></td><td style=text-align:left>直接使用</td><td style=text-align:left>如 <code>192.168.1.0/24</code>、<code>10.1.1.100/32</code></td></tr></tbody></table><p>内网 CIDR 可通过 <code>node_firewall_intranet</code> 参数自定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_firewall_intranet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>10.0.0.0</span><span style=color:#000>/8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>172.16.0.0</span><span style=color:#000>/12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>192.168.0.0</span><span style=color:#000>/16</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=认证方式>认证方式</h2><p>Pigsty 提供认证方式别名，简化配置：</p><table><thead><tr><th style=text-align:left>别名</th><th style=text-align:left>实际方式</th><th style=text-align:left>连接类型</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>pwd</code></td><td style=text-align:left><code>scram-sha-256</code> 或 <code>md5</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>根据 <code>pg_pwd_enc</code> 自动选择</td></tr><tr><td style=text-align:left><code>ssl</code></td><td style=text-align:left><code>scram-sha-256</code> 或 <code>md5</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>强制 SSL + 密码</td></tr><tr><td style=text-align:left><code>ssl-sha</code></td><td style=text-align:left><code>scram-sha-256</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>强制 SSL + SCRAM-SHA-256</td></tr><tr><td style=text-align:left><code>ssl-md5</code></td><td style=text-align:left><code>md5</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>强制 SSL + MD5</td></tr><tr><td style=text-align:left><code>cert</code></td><td style=text-align:left><code>cert</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>客户端证书认证</td></tr><tr><td style=text-align:left><code>trust</code></td><td style=text-align:left><code>trust</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>无条件信任（危险）</td></tr><tr><td style=text-align:left><code>deny</code> / <code>reject</code></td><td style=text-align:left><code>reject</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>拒绝连接</td></tr><tr><td style=text-align:left><code>ident</code></td><td style=text-align:left><code>ident</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>OS 用户映射（PostgreSQL）</td></tr><tr><td style=text-align:left><code>peer</code></td><td style=text-align:left><code>peer</code></td><td style=text-align:left><code>local</code></td><td style=text-align:left>OS 用户映射（Pgbouncer/本地）</td></tr></tbody></table><blockquote><p><code>pg_pwd_enc</code> 默认为 <code>scram-sha-256</code>，可设为 <code>md5</code> 以兼容老客户端。</p></blockquote><hr><h2 id=用户变量>用户变量</h2><p>HBA 规则支持以下用户占位符，渲染时自动替换为实际用户名：</p><table><thead><tr><th style=text-align:left>占位符</th><th style=text-align:left>默认值</th><th style=text-align:left>对应参数</th></tr></thead><tbody><tr><td style=text-align:left><code>${dbsu}</code></td><td style=text-align:left><code>postgres</code></td><td style=text-align:left><code>pg_dbsu</code></td></tr><tr><td style=text-align:left><code>${repl}</code></td><td style=text-align:left><code>replicator</code></td><td style=text-align:left><code>pg_replication_username</code></td></tr><tr><td style=text-align:left><code>${monitor}</code></td><td style=text-align:left><code>dbuser_monitor</code></td><td style=text-align:left><code>pg_monitor_username</code></td></tr><tr><td style=text-align:left><code>${admin}</code></td><td style=text-align:left><code>dbuser_dba</code></td><td style=text-align:left><code>pg_admin_username</code></td></tr></tbody></table><hr><h2 id=角色过滤>角色过滤</h2><p>HBA 规则的 <code>role</code> 字段控制规则在哪些实例上生效：</p><table><thead><tr><th style=text-align:left>角色</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>common</code></td><td style=text-align:left>默认值，所有实例都生效</td></tr><tr><td style=text-align:left><code>primary</code></td><td style=text-align:left>仅主库实例生效</td></tr><tr><td style=text-align:left><code>replica</code></td><td style=text-align:left>仅从库实例生效</td></tr><tr><td style=text-align:left><code>offline</code></td><td style=text-align:left>仅离线实例生效（<code>pg_role: offline</code> 或 <code>pg_offline_query: true</code>）</td></tr><tr><td style=text-align:left><code>standby</code></td><td style=text-align:left>备库实例</td></tr><tr><td style=text-align:left><code>delayed</code></td><td style=text-align:left>延迟从库实例</td></tr></tbody></table><p>角色过滤基于实例的 <code>pg_role</code> 变量进行匹配，不匹配的规则会被注释掉（以 <code>#</code> 开头）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 仅在主库生效：写入用户只能连主库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: writer, db: all, addr: intra, auth: pwd, role: primary, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;writer only on primary&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 仅在离线实例生效：ETL 任务专用网络</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39;, db: all, addr: &#39;172.20.0.0/16&#39;, auth: ssl, role: offline, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;offline dedicated&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=排序机制>排序机制</h2><p>PostgreSQL HBA 是 <strong>首条匹配生效</strong>，规则顺序至关重要。Pigsty 通过 <code>order</code> 字段控制规则渲染顺序。</p><p><strong>Order 区间约定</strong></p><table><thead><tr><th style=text-align:left>区间</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><code>0 - 99</code></td><td style=text-align:left>用户高优先规则（在所有默认规则之前）</td></tr><tr><td style=text-align:left><code>100 - 650</code></td><td style=text-align:left>默认规则区（间隔 50，便于插入）</td></tr><tr><td style=text-align:left><code>1000+</code></td><td style=text-align:left>用户规则默认值（不填 <code>order</code> 时追加到最后）</td></tr></tbody></table><p><strong>PostgreSQL 默认规则 Order 分配</strong></p><table><thead><tr><th style=text-align:left>Order</th><th style=text-align:left>规则说明</th></tr></thead><tbody><tr><td style=text-align:left>100</td><td style=text-align:left>dbsu local ident</td></tr><tr><td style=text-align:left>150</td><td style=text-align:left>dbsu replication local</td></tr><tr><td style=text-align:left>200</td><td style=text-align:left>replicator localhost</td></tr><tr><td style=text-align:left>250</td><td style=text-align:left>replicator intra replication</td></tr><tr><td style=text-align:left>300</td><td style=text-align:left>replicator intra postgres</td></tr><tr><td style=text-align:left>350</td><td style=text-align:left>monitor localhost</td></tr><tr><td style=text-align:left>400</td><td style=text-align:left>monitor infra</td></tr><tr><td style=text-align:left>450</td><td style=text-align:left>admin infra ssl</td></tr><tr><td style=text-align:left>500</td><td style=text-align:left>admin world ssl</td></tr><tr><td style=text-align:left>550</td><td style=text-align:left>dbrole_readonly localhost</td></tr><tr><td style=text-align:left>600</td><td style=text-align:left>dbrole_readonly intra</td></tr><tr><td style=text-align:left>650</td><td style=text-align:left>dbrole_offline intra</td></tr></tbody></table><p><strong>Pgbouncer 默认规则 Order 分配</strong></p><table><thead><tr><th style=text-align:left>Order</th><th style=text-align:left>规则说明</th></tr></thead><tbody><tr><td style=text-align:left>100</td><td style=text-align:left>dbsu local peer</td></tr><tr><td style=text-align:left>150</td><td style=text-align:left>all localhost pwd</td></tr><tr><td style=text-align:left>200</td><td style=text-align:left>monitor pgbouncer intra</td></tr><tr><td style=text-align:left>250</td><td style=text-align:left>monitor world deny</td></tr><tr><td style=text-align:left>300</td><td style=text-align:left>admin intra pwd</td></tr><tr><td style=text-align:left>350</td><td style=text-align:left>admin world deny</td></tr><tr><td style=text-align:left>400</td><td style=text-align:left>all intra pwd</td></tr></tbody></table><hr><h2 id=写法示例>写法示例</h2><p><strong>别名形式</strong>：使用 Pigsty 提供的简化语法</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow grafana view access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_view</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>渲染结果：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow grafana view access [primary]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  meta               dbuser_view        10.10.10.10/32     scram-sha-256</span>
</span></span></code></pre></div><p><strong>原始形式</strong>：直接使用 PostgreSQL HBA 语法</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>host all all 10.0.0.0/8 scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>host all all 172.16.0.0/12 scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>host all all 192.168.0.0/16 scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>渲染结果：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow intranet password access [common]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host all all 10.0.0.0/8 scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host all all 172.16.0.0/12 scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host all all 192.168.0.0/16 scram-sha-256</span>
</span></span></code></pre></div><hr><h2 id=常见配置场景>常见配置场景</h2><p><strong>黑名单 IP</strong>：使用 <code>order: 0</code> 确保最先匹配</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: all, db: all, addr: &#39;10.1.1.100/32&#39;, auth: deny, order: 0, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;block bad ip&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>白名单应用服务器</strong>：高优先级允许特定 IP</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: app_user, db: app_db, addr: &#39;192.168.1.10/32&#39;, auth: ssl, order: 50, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app server&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理员强制证书</strong>：覆盖默认的 SSL 密码认证</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#204a87;font-weight:700>, db: all, addr: world, auth: cert, order: 10, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin cert only&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>离线实例专用网络</strong>：仅在 offline 实例生效</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39;, db: all, addr: &#39;172.20.0.0/16&#39;, auth: ssl-sha, role: offline, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etl network&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>按数据库限制访问</strong>：敏感库仅允许特定网段</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: fin_user, db: finance_db, addr: &#39;10.20.0.0/16&#39;, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;finance only&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: hr_user, db: hr_db, addr: &#39;10.30.0.0/16&#39;, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;hr only&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Pgbouncer 专用规则</strong>：注意不支持 <code>db: replication</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readwrite&#39;, db: all, addr: world, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app via pgbouncer&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=完整集群示例>完整集群示例</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-prod</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-prod</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 黑名单：已知恶意 IP（最高优先级）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: all, db: all, addr: &#39;10.1.1.100/32&#39;, auth: deny, order: 0, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;blacklist&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 应用服务器白名单（高优先级）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: app_user, db: app_db, addr: &#39;192.168.1.0/24&#39;, auth: ssl, order: 50, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app servers&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># ETL 任务：仅离线实例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: etl_user, db: all, addr: &#39;172.20.0.0/16&#39;, auth: pwd, role: offline, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etl tasks&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 集群内监控访问</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#204a87;font-weight:700>, db: all, addr: cluster, auth: pwd, order: 380, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;cluster monitor&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgb_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 应用通过连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readwrite&#39;, db: all, addr: &#39;192.168.1.0/24&#39;, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app via pgbouncer&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=验证与排查>验证与排查</h2><p><strong>查看当前 HBA 规则</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;TABLE pg_hba_file_rules&#34;</span>         <span style=color:#8f5902;font-style:italic># 通过 SQL 查看（推荐）</span>
</span></span><span style=display:flex><span>cat /pg/data/pg_hba.conf                  <span style=color:#8f5902;font-style:italic># 查看 PostgreSQL HBA 文件</span>
</span></span><span style=display:flex><span>cat /etc/pgbouncer/pgb_hba.conf           <span style=color:#8f5902;font-style:italic># 查看 Pgbouncer HBA 文件</span>
</span></span><span style=display:flex><span>grep <span style=color:#4e9a06>&#39;^#&#39;</span> /pg/data/pg_hba.conf <span style=color:#000;font-weight:700>|</span> head -20 <span style=color:#8f5902;font-style:italic># 查看规则标题（验证 order）</span>
</span></span></code></pre></div><p><strong>测试连接认证</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -h &lt;host&gt; -p <span style=color:#0000cf;font-weight:700>5432</span> -U &lt;user&gt; -d &lt;db&gt; -c <span style=color:#4e9a06>&#34;SELECT 1&#34;</span>
</span></span></code></pre></div><p><strong>常见问题排查</strong></p><table><thead><tr><th style=text-align:left>错误信息</th><th style=text-align:left>可能原因</th><th style=text-align:left>解决方案</th></tr></thead><tbody><tr><td style=text-align:left><code>no pg_hba.conf entry for host...</code></td><td style=text-align:left>没有匹配的 HBA 规则</td><td style=text-align:left>添加对应规则并刷新</td></tr><tr><td style=text-align:left><code>password authentication failed</code></td><td style=text-align:left>密码错误或加密方式不兼容</td><td style=text-align:left>检查密码和 <code>pg_pwd_enc</code></td></tr><tr><td style=text-align:left>规则不生效</td><td style=text-align:left>未刷新或 order 被覆盖</td><td style=text-align:left>执行 <code>bin/pgsql-hba</code> 并检查顺序</td></tr></tbody></table><hr><h2 id=注意事项>注意事项</h2><ol><li><strong>顺序敏感</strong>：PostgreSQL HBA 首条匹配生效，善用 <code>order</code> 字段</li><li><strong>角色匹配</strong>：确保 <code>role</code> 字段与目标实例的 <code>pg_role</code> 一致</li><li><strong>地址格式</strong>：CIDR 必须正确，如 <code>10.0.0.0/8</code> 而非 <code>10.0.0.0/255.0.0.0</code></li><li><strong>Pgbouncer 限制</strong>：不支持 <code>db: replication</code></li><li><strong>SSL 前提</strong>：使用 <code>ssl</code>、<code>cert</code> 认证前确保 SSL 已正确配置</li><li><strong>测试优先</strong>：修改 HBA 前建议先在测试环境验证</li><li><strong>扩缩容刷新</strong>：使用 <code>addr: cluster</code> 的规则在集群成员变化后需要刷新</li></ol><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/misc/hba/><strong>HBA 管理</strong></a>：HBA 规则的日常管理操作与故障排查</li><li><a href=/docs/pgsql/config/user/><strong>用户配置</strong></a>：用户与角色配置</li><li><a href=/docs/pgsql/config/acl/><strong>访问控制</strong></a>：角色体系与权限模型</li><li><a href=/docs/concept/sec/><strong>安全与合规</strong></a>：PostgreSQL 集群的安全特性</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ff84fb35cef7a71a971ba3fb6712ed0c>2.7 - 参数配置</h1><div class=lead>如何配置集群、实例、用户和数据库级别的 PostgreSQL 参数</div><p>PostgreSQL 参数可以在多个层级进行配置，不同层级的参数设置具有不同的作用范围和优先级。
Pigsty 支持在四个层级配置 PostgreSQL 参数，从全局到局部依次为：</p><table class=full-width><thead><tr><th>层级</th><th>作用范围</th><th>配置方式</th><th>存储位置</th></tr></thead><tbody><tr><td><a href=#%E9%9B%86%E7%BE%A4%E7%BA%A7%E5%8F%82%E6%95%B0><strong>集群级</strong></a></td><td>整个集群所有实例</td><td>Patroni DCS / 调优模板</td><td>etcd + <code>postgresql.conf</code></td></tr><tr><td><a href=#%E5%AE%9E%E4%BE%8B%E7%BA%A7%E5%8F%82%E6%95%B0><strong>实例级</strong></a></td><td>单个 PostgreSQL 实例</td><td><code>pg_parameters</code> / <code>ALTER SYSTEM</code></td><td><code>postgresql.auto.conf</code></td></tr><tr><td><a href=#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BA%A7%E5%8F%82%E6%95%B0><strong>数据库级</strong></a></td><td>特定数据库的所有会话</td><td><code>pg_databases[].parameters</code></td><td><code>pg_db_role_setting</code></td></tr><tr><td><a href=#%E7%94%A8%E6%88%B7%E7%BA%A7%E5%8F%82%E6%95%B0><strong>用户级</strong></a></td><td>特定用户的所有会话</td><td><code>pg_users[].parameters</code></td><td><code>pg_db_role_setting</code></td></tr></tbody></table><p>参数优先级从低到高：<strong>集群级 &lt; 实例级 &lt; 数据库级 &lt; 用户级 &lt; 会话级</strong>（<code>SET</code> 命令）。
高优先级的设置会覆盖低优先级的设置。</p><blockquote><p>关于 PostgreSQL 参数的完整说明，请参阅 <a href=https://www.postgresql.org/docs/current/runtime-config.html><strong>PostgreSQL 官方文档：服务器配置</strong></a>。</p></blockquote><hr><h2 id=集群级参数>集群级参数</h2><p>集群级参数是整个 PostgreSQL 集群共享的配置，所有实例（主库和从库）都会使用相同的参数值。
在 Pigsty 中，集群级参数通过 <a href=/docs/pgsql/admin/patroni><strong>Patroni</strong></a> 管理，存储在分布式配置存储（DCS，默认为 etcd）中。</p><p>Pigsty 提供了四种预置的 <a href=/docs/pgsql/template><strong>Patroni 参数优化模板</strong></a>，针对不同的使用场景进行了优化，通过 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数指定：</p><table class=full-width><thead><tr><th>模板</th><th>适用场景</th><th>特点</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/template/oltp><strong><code>oltp.yml</code></strong></a></td><td>在线事务处理</td><td>低延迟、高并发，默认推荐</td></tr><tr><td><a href=/docs/pgsql/template/olap><strong><code>olap.yml</code></strong></a></td><td>在线分析处理</td><td>大查询、高吞吐，适合数仓</td></tr><tr><td><a href=/docs/pgsql/template/crit><strong><code>crit.yml</code></strong></a></td><td>核心金融业务</td><td>最大持久性，牺牲部分性能换取安全</td></tr><tr><td><a href=/docs/pgsql/template/tiny><strong><code>tiny.yml</code></strong></a></td><td>微型实例</td><td>资源受限环境，适合开发测试</td></tr></tbody></table><p>调优模板文件位于 Pigsty 安装目录的 <code>roles/pgsql/templates/</code> 目录下，包含了根据硬件规格自动计算的参数值。
这些模板会在集群初始化时渲染为 Patroni 配置文件 <code>/etc/patroni/patroni.yml</code>。更多详情请参阅 <a href=/docs/pgsql/template><strong>场景模板</strong></a>。</p><p>在集群创建前，您可以通过调整这些 Patroni 配置模板来修改集群的 <strong>初始化参数</strong>。
一旦集群初始化完成，后续的参数修改应通过 Patroni 的 <a href=/docs/pgsql/admin/patroni><strong>配置管理</strong></a> 机制进行。</p><h3 id=patroni-dcs-配置>Patroni DCS 配置</h3><p>Patroni 将集群配置存储在 DCS（分布式配置存储，默认为 etcd）中，确保集群所有成员使用一致的配置。</p><p><strong>配置存储结构</strong>：</p><pre tabindex=0><code>/pigsty/                          # 命名空间（patroni_namespace）
  └── pg-meta/                    # 集群名称（pg_cluster）
      ├── config                  # 集群配置（所有成员共享）
      ├── leader                  # 当前主库信息
      ├── members/                # 成员注册信息
      │   ├── pg-meta-1
      │   └── pg-meta-2
      └── ...
</code></pre><p><strong>配置渲染流程</strong>：</p><ol><li><strong>初始化阶段</strong>：调优模板（如 <code>oltp.yml</code>）通过 Jinja2 渲染为 <code>/etc/patroni/patroni.yml</code></li><li><strong>启动阶段</strong>：Patroni 读取本地配置，将 PostgreSQL 参数写入 DCS</li><li><strong>运行阶段</strong>：Patroni 定期从 DCS 同步配置到本地 PostgreSQL</li></ol><p><strong>本地缓存机制</strong>：</p><p>每个 Patroni 实例会在本地缓存 DCS 配置，位于 <code>/pg/conf/&lt;instance>.yml</code>：</p><ul><li>启动时：从 DCS 加载配置，缓存到本地</li><li>运行时：定期同步 DCS 配置到本地缓存</li><li>DCS 不可用时：使用本地缓存继续运行（但无法进行主从切换）</li></ul><h3 id=配置文件层次>配置文件层次</h3><p>Patroni 会将 DCS 中的配置渲染到本地 PostgreSQL 配置文件，形成以下层次结构：</p><pre tabindex=0><code>/pg/data/
├── postgresql.conf          # 主配置文件（由 Patroni 动态管理）
├── postgresql.base.conf     # 基础配置（通过 include 指令加载）
├── postgresql.auto.conf     # 实例级覆盖配置（ALTER SYSTEM 写入）
├── pg_hba.conf              # 客户端认证配置
└── pg_ident.conf            # 用户映射配置
</code></pre><p><strong>配置加载顺序</strong>（优先级从低到高）：</p><ol><li><code>postgresql.conf</code>：Patroni 动态生成，包含 DCS 中的集群参数</li><li><code>postgresql.base.conf</code>：通过 <code>include</code> 指令加载，包含静态基础配置</li><li><code>postgresql.auto.conf</code>：PostgreSQL 自动加载，用于实例级参数覆盖</li></ol><p>由于 <code>postgresql.auto.conf</code> <strong>最后加载</strong>，其中的参数会覆盖前面文件中的同名参数。</p><hr><h2 id=实例级参数>实例级参数</h2><p>实例级参数仅对单个 PostgreSQL 实例生效，用于覆盖集群级配置或设置实例特定的参数。
实例级参数会写入 <code>postgresql.auto.conf</code> 文件，由于该文件最后加载，可以覆盖集群级的任何参数。</p><p>这是一项非常有用的技术：您可以为特定实例设置不同于集群的参数值，例如：</p><ul><li>为从库设置 <code>hot_standby_feedback = on</code></li><li>为特定实例调整 <code>work_mem</code> 或 <code>maintenance_work_mem</code></li><li>为延迟从库设置 <code>recovery_min_apply_delay</code></li></ul><h3 id=使用-pg_parameters>使用 pg_parameters</h3><p>在 Pigsty 配置中，使用 <a href=/docs/pgsql/param#pg_parameters><strong><code>pg_parameters</code></strong></a> 参数定义实例级配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                              </span><span style=color:#8f5902;font-style:italic># 实例级参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all                       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 仅此实例记录所有 SQL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                                </span><span style=color:#8f5902;font-style:italic># 集群默认的实例参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>log_timezone</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Asia/Shanghai</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用 <code>./pgsql.yml -l &lt;cls> -t pg_param</code> 子任务，可以将参数配置应用生效，这些参数会被渲染到 <code>postgresql.auto.conf</code> 文件中。</p><h3 id=参数覆盖层次>参数覆盖层次</h3><p><code>pg_parameters</code> 可以在 Ansible 配置的不同层次定义，优先级从低到高：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 全局默认</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>none</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 集群级覆盖</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 实例级覆盖（最高优先级）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=使用-alter-system>使用 ALTER SYSTEM</h3><p>除了通过配置文件，还可以在运行时使用 SQL 命令 <a href=https://www.postgresql.org/docs/current/sql-altersystem.html><strong><code>ALTER SYSTEM</code></strong></a> 修改实例级参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 设置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_min_duration_statement</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 重置为默认值
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- 重置所有 ALTER SYSTEM 设置
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 重新加载配置使其生效
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_reload_conf</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>ALTER SYSTEM</code> 会将参数写入 <code>postgresql.auto.conf</code> 文件。</p><blockquote><p><strong>注意</strong>：在 Pigsty 管理的集群中，<code>postgresql.auto.conf</code> 由 Ansible 通过 <code>pg_parameters</code> 管理。
手动使用 <code>ALTER SYSTEM</code> 修改的参数可能会在下次执行 playbook 时被覆盖。
建议通过修改 <code>pigsty.yml</code> 中的 <code>pg_parameters</code> 来管理实例级参数。</p></blockquote><h3 id=列表类型参数>列表类型参数</h3><p>PostgreSQL 中有一类特殊的参数接受逗号分隔的列表值。在 YAML 配置文件中配置这类参数时，
<strong>整个值必须用引号包裹</strong>，否则 YAML 解析器会将其解释为数组而导致错误：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ✓ 正确：用引号包裹整个值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;$user&#34;, public, app&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ✗ 错误：不加引号会导致 YAML 解析错误</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb, pg_stat_statements  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># YAML 会解析为数组！</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 会自动识别以下列表类型参数，在渲染到配置文件时<strong>不添加外层引号</strong>：</p><table class=full-width><thead><tr><th>参数</th><th>说明</th><th>示例值</th></tr></thead><tbody><tr><td><code>shared_preload_libraries</code></td><td>预加载共享库</td><td><code>'timescaledb, pg_stat_statements'</code></td></tr><tr><td><code>search_path</code></td><td>Schema 搜索路径</td><td><code>'"$user", public, app'</code></td></tr><tr><td><code>local_preload_libraries</code></td><td>本地预加载库</td><td><code>'auto_explain'</code></td></tr><tr><td><code>session_preload_libraries</code></td><td>会话预加载库</td><td><code>'pg_hint_plan'</code></td></tr><tr><td><code>log_destination</code></td><td>日志输出目标</td><td><code>'csvlog, stderr'</code></td></tr><tr><td><code>unix_socket_directories</code></td><td>Unix Socket 目录</td><td><code>'/var/run/postgresql, /tmp'</code></td></tr><tr><td><code>temp_tablespaces</code></td><td>临时表空间</td><td><code>'ssd_space, hdd_space'</code></td></tr><tr><td><code>debug_io_direct</code></td><td>直接 I/O 模式（PG16+）</td><td><code>'data, wal'</code></td></tr></tbody></table><p><strong>渲染示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pigsty.yml 配置（YAML 中需要引号）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;$user&#34;, public, app&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 渲染后的 postgresql.auto.conf（列表参数无外层引号）</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>shared_preload_libraries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>timescaledb, pg_stat_statements</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>search_path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;$user&#34;, public, app</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>work_mem</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;64MB&#39;</span>
</span></span></code></pre></div><hr><h2 id=数据库级参数>数据库级参数</h2><p>数据库级参数针对特定数据库生效，连接到该数据库的所有会话都会应用这些参数设置。
通过 <a href=https://www.postgresql.org/docs/current/sql-alterdatabase.html><strong><code>ALTER DATABASE ... SET</code></strong></a> 实现，存储在系统表 <code>pg_db_role_setting</code> 中。</p><h3 id=配置方式>配置方式</h3><p>在 <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> 中使用 <code>parameters</code> 字段定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>256MB                             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 分析库需要更多内存</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1GB                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 大表维护操作</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 允许长查询</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;$user&#34;, public, mart&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 列表参数需要引号</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>与实例级参数相同，列表类型参数值在 YAML 中需要用引号包裹。</p></blockquote><h3 id=参数渲染规则>参数渲染规则</h3><p>数据库级参数通过 <code>ALTER DATABASE ... SET</code> 语句设置。Pigsty 会根据参数类型自动选择正确的语法：</p><p><strong>列表类型参数</strong>（<code>search_path</code>、<code>temp_tablespaces</code>、<code>local_preload_libraries</code>、<code>session_preload_libraries</code>、<code>log_destination</code>）不加外层引号：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;analytics&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;search_path&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;$user&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>mart</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>标量参数</strong> 使用引号包裹值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;analytics&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;analytics&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10min&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p><strong>注意</strong>：虽然 <code>log_destination</code> 在数据库级参数白名单中，但由于其 <code>context</code> 为 <code>sighup</code>，
实际上无法在数据库级别生效。此参数应在实例级（<code>pg_parameters</code>）配置。</p></blockquote><h3 id=查看数据库参数>查看数据库参数</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看特定数据库的参数设置
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>unnest</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>setconfig</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>setting</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_db_role_setting</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_database</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setdatabase</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setrole</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=手动管理>手动管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 设置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>search_path</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;$user&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>myschema</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 重置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=用户级参数>用户级参数</h2><p>用户级参数针对特定数据库用户生效，该用户的所有会话都会应用这些参数设置。
通过 <a href=https://www.postgresql.org/docs/current/sql-alterrole.html><strong><code>ALTER USER ... SET</code></strong></a> 实现，同样存储在系统表 <code>pg_db_role_setting</code> 中。</p><h3 id=配置方式-1>配置方式</h3><p>在 <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> 或 <a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a> 中使用 <code>parameters</code> 字段定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>256MB                             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 分析查询需要更多内存</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>5min                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 允许较长的查询时间</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;$user&#34;, public, analytics&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 列表参数需要引号</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all                          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 记录所有 SQL</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=参数渲染规则-1>参数渲染规则</h3><p>用户级参数的渲染规则与数据库级参数相同：</p><p><strong>列表类型参数</strong>（<code>search_path</code>、<code>temp_tablespaces</code>、<code>local_preload_libraries</code>、<code>session_preload_libraries</code>）不加外层引号：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;search_path&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;$user&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>标量参数</strong> 使用引号包裹：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=特殊值-default>特殊值 DEFAULT</h3><p>使用 <code>DEFAULT</code>（大小写不敏感）可以将参数重置为 PostgreSQL 默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>30s    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 设置具体值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=查看用户参数>查看用户参数</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看特定用户的参数设置
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>unnest</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>setconfig</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>setting</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_db_role_setting</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setrole</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbuser_analyst&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=手动管理-1>手动管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 设置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;128MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>search_path</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;$user&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>myschema</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 重置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=参数优先级>参数优先级</h2><p>当同一参数在多个层级设置时，PostgreSQL 按以下优先级应用（从低到高）：</p><pre tabindex=0><code>postgresql.conf           ← 集群级参数（Patroni DCS）
       ↓
postgresql.auto.conf      ← 实例级参数（pg_parameters / ALTER SYSTEM）
       ↓
数据库级                    ← ALTER DATABASE SET
       ↓
用户级                      ← ALTER USER SET
       ↓
会话级                      ← SET 命令
</code></pre><p><strong>关于数据库级与用户级的优先级</strong>：</p><p>当用户连接到特定数据库时，如果同一参数在数据库级和用户级都有设置，
PostgreSQL 会使用 <strong>用户级参数</strong>，因为用户级优先级更高。</p><p><strong>示例场景</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 数据库级：analytics 数据库 work_mem = 256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 用户级：analyst 用户 work_mem = 512MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>512MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>当 <code>analyst</code> 用户连接到 <code>analytics</code> 数据库时：<code>work_mem = 512MB</code>（用户级优先）</li><li>当其他用户连接到 <code>analytics</code> 数据库时：<code>work_mem = 256MB</code>（数据库级生效）</li><li>当 <code>analyst</code> 用户连接到其他数据库时：<code>work_mem = 512MB</code>（用户级生效）</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f26623b2f855e9bc5073aeb50aea422a>2.8 - 访问控制</h1><div class=lead>Pigsty 提供的默认角色系统与权限模型</div><blockquote><p>访问控制由“角色体系 + 权限模板 + HBA”共同决定。本节聚焦于如何通过配置参数声明角色与对象权限。</p></blockquote><p>Pigsty 预置了一套精简的 ACL 模型，全部通过以下参数描述：</p><ul><li><code>pg_default_roles</code>：系统角色与系统用户。</li><li><code>pg_users</code>：业务用户与角色。</li><li><code>pg_default_privileges</code>：管理员/属主新建对象时的默认权限。</li><li><code>pg_revoke_public</code>、<code>pg_default_schemas</code>、<code>pg_default_extensions</code>：控制 <code>template1</code> 的默认行为。</li></ul><p>理解这些参数后，你就可以写出完全可复现的权限配置。</p><hr><h2 id=默认角色体系pg_default_roles>默认角色体系（pg_default_roles）</h2><p>默认包含 4 个业务角色 + 4 个系统用户：</p><table class=full-width><thead><tr><th>名称</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td>所有业务共用，拥有 SELECT/USAGE</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>继承只读角色，并拥有 INSERT/UPDATE/DELETE</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>继承 <code>pg_monitor</code> + 读写角色，可建对象和触发器</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td>受限只读角色，仅允许访问离线实例</td></tr><tr><td><code>postgres</code></td><td>用户</td><td>系统超级用户，与 <code>pg_dbsu</code> 同名</td></tr><tr><td><code>replicator</code></td><td>用户</td><td>用于流复制与备份，继承监控与只读权限</td></tr><tr><td><code>dbuser_dba</code></td><td>用户</td><td>主要管理员账号，同时同步到 pgbouncer</td></tr><tr><td><code>dbuser_monitor</code></td><td>用户</td><td>监控账号，具备 <code>pg_monitor</code> 权限，默认记录慢 SQL</td></tr></tbody></table><p>这些定义位于 <code>pg_default_roles</code>，理论上可以自定义，但若要替换名称，必须同步更新 HBA/ACL/脚本中的引用。</p><p>示例：为离线任务额外加一个 <code>dbrole_etl</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_etl, login: false, roles: [dbrole_offline], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etl read-only role&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, login: false, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pg_monitor, dbrole_readwrite, dbrole_etl] }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：所有继承 <code>dbrole_admin</code> 的用户自动拥有 <code>dbrole_etl</code> 权限，可访问 offline 实例并执行 ETL。</p></blockquote><hr><h2 id=默认用户与凭据参数>默认用户与凭据参数</h2><p>系统用户的用户名/密码由以下参数控制：</p><table class=full-width><thead><tr><th>参数</th><th>默认值</th><th>作用</th></tr></thead><tbody><tr><td><code>pg_dbsu</code></td><td><code>postgres</code></td><td>数据库/系统超级用户</td></tr><tr><td><code>pg_dbsu_password</code></td><td>空字符串</td><td>dbsu 密码（默认不启用）</td></tr><tr><td><code>pg_replication_username</code></td><td><code>replicator</code></td><td>复制用户名称</td></tr><tr><td><code>pg_replication_password</code></td><td><code>DBUser.Replicator</code></td><td>复制用户密码</td></tr><tr><td><code>pg_admin_username</code></td><td><code>dbuser_dba</code></td><td>管理员用户名</td></tr><tr><td><code>pg_admin_password</code></td><td><code>DBUser.DBA</code></td><td>管理员密码</td></tr><tr><td><code>pg_monitor_username</code></td><td><code>dbuser_monitor</code></td><td>监控用户</td></tr><tr><td><code>pg_monitor_password</code></td><td><code>DBUser.Monitor</code></td><td>监控用户密码</td></tr></tbody></table><blockquote><p>如果修改这些参数，请同步在 <code>pg_default_roles</code> 中更新对应用户的定义，以避免角色属性不一致。</p></blockquote><hr><h2 id=业务角色与授权pg_users>业务角色与授权（pg_users）</h2><p>业务用户通过 <code>pg_users</code> 声明（详细字段见 <a href=/docs/pgsql/config/user>用户配置</a>），其中 <code>roles</code> 字段控制授予的业务角色。</p><p>示例：创建只读/读写用户各一名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: app_reader,  password: DBUser.Reader,  roles: [dbrole_readonly],  pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: app_writer,  password: DBUser.Writer,  roles: [dbrole_readwrite], pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>通过继承 <code>dbrole_*</code> 来控制访问权限，无需为每个库单独 GRANT。配合 <a href=/docs/pgsql/config/hba><code>pg_hba_rules</code></a> 即可区分访问来源。</p></blockquote><p>若需要更细粒度的 ACL，可在 <code>baseline</code> SQL 中或后续剧本里使用标准 <code>GRANT/REVOKE</code>。Pigsty 不会阻止你额外授予权限。</p><hr><h2 id=默认权限模板pg_default_privileges>默认权限模板（pg_default_privileges）</h2><p><code>pg_default_privileges</code> 会在 <code>postgres</code>、<code>dbuser_dba</code>、<code>dbrole_admin</code>（业务管理员 <code>SET ROLE</code> 后）上设置 DEFAULT PRIVILEGE。默认模板如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>只要对象由上述管理员创建，就会自动携带对应权限，无需人为执行 GRANT。若业务需要自定义模板，直接替换该数组即可。</p></blockquote><p>额外提示：</p><ul><li><code>pg_revoke_public</code> 默认为 <code>true</code>，意味着自动撤销 <code>PUBLIC</code> 在数据库和 <code>public</code> schema 上的 <code>CREATE</code> 权限。</li><li><code>pg_default_schemas</code> 和 <code>pg_default_extensions</code> 控制在 <code>template1/postgres</code> 中预创建的 schema/扩展，通常用于监控对象（<code>monitor</code> schema、<code>pg_stat_statements</code> 等）。</li></ul><hr><h2 id=常见配置场景>常见配置场景</h2><h3 id=为合作方提供只读账号>为合作方提供只读账号</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>partner_ro</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Partner.Read</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: partner_ro, db: analytics, addr: 203.0.113.0/24, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：合作方账号登录后只具备默认只读权限，并且只能通过 TLS 从指定网段访问 <code>analytics</code> 库。</p></blockquote><h3 id=为业务管理员赋予-ddl-能力>为业务管理员赋予 DDL 能力</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.AppAdmin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>业务管理员通过 <code>SET ROLE dbrole_admin</code> 或直接以 <code>app_admin</code> 登录，即可继承默认的 DDL 权限模板。</p></blockquote><h3 id=自定义默认权限>自定义默认权限</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT,UPDATE,DELETE ON TABLES TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT,UPDATE ON SEQUENCES TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT ON TABLES TO reporting_group</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>替换默认模板后，所有由管理员创建的对象都会携带新的权限定义，避免逐对象授权。</p></blockquote><hr><h2 id=与其他组件的协同>与其他组件的协同</h2><ul><li><strong>HBA 规则</strong>：使用 <code>pg_hba_rules</code> 将角色与来源进行绑定（例如只让 <code>dbrole_offline</code> 访问离线实例）。</li><li><strong>Pgbouncer</strong>：<code>pgbouncer: true</code> 的用户会被写入 <code>userlist.txt</code>，<code>pool_mode/pool_connlimit</code> 可以控制连接池层面的配额。</li><li><strong>Grafana/监控</strong>：<code>dbuser_monitor</code> 的权限来自 <code>pg_default_roles</code>，如果你新增监控用户，记得赋予 <code>pg_monitor</code> + <code>monitor</code> schema 的访问权。</li></ul><p>通过这些参数，可以让权限体系与代码一起版本化，真正做到“配置即策略”。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-a5ab1e936057c396561d23f099852606>3 - 服务/接入</h1><div class=lead>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</div><blockquote><p>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</p></blockquote><p><a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>服务</a> 是一种抽象：它是数据库集群对外提供能力的形式，并封装了底层集群的细节。</p><p>服务对于生产环境中的 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>稳定接入</a> 至关重要，在 <a href=/docs/concept/ha>高可用</a> 集群自动故障时方显其价值，<a href=#%E5%8D%95%E6%9C%BA%E7%94%A8%E6%88%B7>单机用户</a> 通常不需要操心这个概念。</p><hr><h2 id=单机用户>单机用户</h2><p>“服务” 的概念是给生产环境用的，个人用户/单机集群可以不折腾，直接拿实例名/IP地址访问数据库。</p><p>例如，Pigsty 默认的单节点 <code>pg-meta</code>.<code>meta</code> 数据库，就可以直接用下面三个不同的用户连接上去。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># 直接用 DBA 超级用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># 用默认的业务管理员用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># 用默认的只读用户走实例域名连上去</span>
</span></span></code></pre></div><hr><h2 id=服务概述>服务概述</h2><p>在真实世界生产环境中，我们会使用基于复制的主从数据库集群。集群中有且仅有一个实例作为领导者（<a href=/docs/pgsql/config/cluster#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93>主库</a>）可以接受写入。
而其他实例（<a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>从库</a>）则会从持续从集群领导者获取变更日志，与领导者保持一致。同时，从库还可以承载只读请求，在读多写少的场景下可以显著分担主库的负担，
因此对集群的写入请求与只读请求进行区分，是一种十分常见的实践。</p><p>此外对于高频短连接的生产环境，我们还会通过连接池中间件（Pgbouncer）对请求进行池化，减少连接与后端进程的创建开销。但对于ETL与变更执行等场景，我们又需要绕过连接池，直接访问数据库。
同时，高可用集群在故障时会出现故障切换（Failover），故障切换会导致集群的领导者出现变更。因此高可用的数据库方案要求写入流量可以自动适配集群的领导者变化。
这些不同的访问需求（读写分离，池化与直连，故障切换自动适配）最终抽象出 <strong>服务</strong> （Service）的概念。</p><p>通常来说，数据库集群都必须提供这种最基础的服务：</p><ul><li><strong>读写服务（primary）</strong> ：可以读写数据库</li></ul><p>对于生产数据库集群，至少应当提供这两种服务：</p><ul><li><strong>读写服务（primary）</strong> ：写入数据：只能由主库所承载。</li><li><strong>只读服务（replica）</strong> ：读取数据：可以由从库承载，没有从库时也可由主库承载</li></ul><p>此外，根据具体的业务场景，可能还会有其他的服务，例如：</p><ul><li><strong>默认直连服务（default）</strong> ：允许（管理）用户，绕过连接池直接访问数据库的服务</li><li><strong>离线从库服务（offline）</strong> ：不承接线上只读流量的专用从库，用于ETL与分析查询</li><li><strong>同步从库服务（standby）</strong> ：没有复制延迟的只读服务，由 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a>/主库处理只读查询</li><li><strong>延迟从库服务（delayed）</strong> ：访问同一个集群在一段时间之前的旧数据，由 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟从库</a> 来处理</li></ul><hr><h2 id=默认服务>默认服务</h2><p>Pigsty默认为每个 PostgreSQL 数据库集群提供四种不同的服务，以下是默认服务及其定义：</p><table class=full-width><thead><tr><th>服务</th><th>端口</th><th>描述</th></tr></thead><tbody><tr><td><a href=#primary%E6%9C%8D%E5%8A%A1>primary</a></td><td>5433</td><td>生产读写，连接到主库连接池（6432）</td></tr><tr><td><a href=#replica%E6%9C%8D%E5%8A%A1>replica</a></td><td>5434</td><td>生产只读，连接到备库连接池（6432）</td></tr><tr><td><a href=#default%E6%9C%8D%E5%8A%A1>default</a></td><td>5436</td><td>管理，ETL写入，直接访问主库（5432）</td></tr><tr><td><a href=#offline%E6%9C%8D%E5%8A%A1>offline</a></td><td>5438</td><td>OLAP、ETL、个人用户、交互式查询</td></tr></tbody></table><p>以默认的 <code>pg-meta</code> 集群为例，它提供四种默认服务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5433/meta   <span style=color:#8f5902;font-style:italic># pg-meta-primary : 通过主要的 pgbouncer(6432) 进行生产读写</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5434/meta   <span style=color:#8f5902;font-style:italic># pg-meta-replica : 通过备份的 pgbouncer(6432) 进行生产只读</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@pg-meta:5436/meta     <span style=color:#8f5902;font-style:italic># pg-meta-default : 通过主要的 postgres(5432) 直接连接</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_stats:DBUser.Stats@pg-meta:5438/meta <span style=color:#8f5902;font-style:italic># pg-meta-offline : 通过离线的 postgres(5432) 直接连接</span>
</span></span></code></pre></div><p>从示例集群 <a href=/docs/concept/arch>架构图</a> 上可以看出这四种服务的工作方式：</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>注意在这里<code>pg-meta</code> 域名指向了集群的 L2 VIP，进而指向集群主库上的 haproxy 负载均衡器，它负责将流量路由到不同的实例上，详见 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>服务接入</a></p><hr><h2 id=服务实现>服务实现</h2><p>在 Pigsty 中，服务使用 <a href=/docs/node>节点</a> 上的 <a href=/docs/node/param#haproxy>haproxy</a> 来实现，通过主机节点上的不同端口进行区分。</p><p>Pigsty 所纳管的每个节点上都默认启用了 Haproxy 以对外暴露服务，而数据库节点也不例外。
集群中的节点尽管从数据库的视角来看有主从之分，但从服务的视角来看，每个节点都是相同的：
这意味着即使您访问的是从库节点，只要使用正确的服务端口，就依然可以使用到主库读写的服务。
这样的设计可以屏蔽复杂度：所以您只要可以访问 PostgreSQL 集群上的任意一个实例，就可以完整的访问到所有服务。</p><p>这样的设计类似于 Kubernetes 中的 NodePort 服务，同样在 Pigsty 中，每一个服务都包括以下两个核心要素：</p><ol><li>通过 NodePort 暴露的访问端点（端口号，从哪访问？）</li><li>通过 Selectors 选择的目标实例（实例列表，谁来承载？）</li></ol><p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器，请参考 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>接入服务</a>。</p><p>所有的服务都通过配置文件进行声明，例如，PostgreSQL 默认服务就是由 <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> 参数所定义的：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您也可以在 <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a> 中定义额外的服务，参数 <code>pg_default_services</code> 与 <code>pg_services</code> 都是由 <a href=#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1>服务定义</a> 对象组成的数组。</p><hr><h2 id=定义服务>定义服务</h2><p>Pigsty 允许您定义自己的服务：</p><ul><li><a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a>：所有 PostgreSQL 集群统一对外暴露的服务，默认有四个。</li><li><a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>：额外的 PostgreSQL 服务，可以视需求在全局或集群级别定义。</li><li><a href=/docs/node/param#haproxy_services><code>haproxy_servies</code></a>：直接定制 HAProxy 服务内容，可以用于其他组件的接入</li></ul><p>对于 PostgreSQL 集群来说，通常只需要关注前两者即可。
每一条服务定义都会在所有相关 HAProxy 实例的配置目录下生成一个新的配置文件：<a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/service.j2><code>/etc/haproxy/&lt;svcname>.cfg</code></a>
下面是一个自定义的服务样例 <code>standby</code>：当您想要对外提供没有复制延迟的只读服务时，就可以在 <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a> 新增这条记录：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>standby                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，服务名称，最终的 svc 名称会使用 `pg_cluster` 作为前缀，例如：pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 必选，暴露的服务端口（作为 kubernetes 服务节点端口模式）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># 可选，服务绑定的 IP 地址，默认情况下为所有 IP 地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># 必选，服务成员选择器，使用 JMESPath 来筛选配置清单</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 可选，服务成员选择器（备份），也就是当默认选择器选中的实例都宕机后，服务才会由这里选中的实例成员来承载</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，目标端口，default|postgres|pgbouncer|&lt;port_number&gt;，默认为 &#39;default&#39;，Default的意思就是使用 pg_default_service_dest 的取值来最终决定</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>check</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，健康检查 URL 路径，默认为 /，这里使用 Patroni API：/sync ，只有同步备库和主库才会返回 200 健康状态码 </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，允许的前端连接最大数，默认为5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>balance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>roundrobin            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，haproxy 负载均衡算法（默认为 roundrobin，其他选项：leastconn）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>而上面的服务定义，在样例的三节点 <code>pg-test</code> 上将会被转换为 haproxy 配置文件 <code>/etc/haproxy/pg-test-standby.conf</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service: pg-test-standby @ 10.10.10.11:5435</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service instances 10.10.10.11, 10.10.10.13, 10.10.10.12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service backups   10.10.10.11</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>listen pg-test-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5435           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 绑定了所有IP地址上的 5435 端口</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 负载均衡器工作在 TCP 协议上</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 最大连接数为 5000，可按需调大</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 负载均衡算法为 rr 轮询，还可以使用 leastconn </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 启用 HTTP 健康检查</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 保持HTTP连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /sync  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- 这里使用 /sync ，Patroni 健康检查 API ，只有同步备库和主库才会返回 200 健康状态码。 </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- 健康检查返回代码 200 代表正常</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers： # pg-test 集群全部三个实例都被 selector: &#34;[]&#34; 给圈中了，因为没有任何的筛选条件，所以都会作为 pg-test-replica 服务的后端服务器。但是因为还有 /sync 健康检查，所以只有主库和同步备库才能真正承载请求。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;----- 唯独主库满足条件 pg_role == `primary`， 被 backup selector 选中。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#        因此作为服务的兜底实例：平时不承载请求，其他从库全部宕机后，才会承载只读请求，从而最大避免了读写服务受到只读服务的影响</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#        </span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>在这里，<code>pg-test</code> 集群全部三个实例都被 <code>selector: "[]"</code> 给圈中了，渲染进入 <code>pg-test-replica</code> 服务的后端服务器列表中。但是因为还有 <code>/sync</code> 健康检查，Patroni Rest API只有在主库和 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a> 上才会返回代表健康的 HTTP 200 状态码，因此只有主库和同步备库才能真正承载请求。
此外，主库因为满足条件 <code>pg_role == primary</code>， 被 backup selector 选中，被标记为了备份服务器，只有当没有其他实例（也就是同步备库）可以满足需求时，才会顶上。</p><hr><h2 id=primary服务>Primary服务</h2><p>Primary服务可能是生产环境中最关键的服务，它在 5433 端口提供对数据库集群的读写能力，服务定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>选择器参数 <code>selector: "[]"</code> 意味着所有集群成员都将被包括在Primary服务中</li><li>但只有主库能够通过健康检查（<code>check: /primary</code>），实际承载Primary服务的流量。</li><li>目的地参数 <code>dest: default</code> 意味着Primary服务的目的地受到 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 参数的影响</li><li><code>dest</code> 默认值 <code>default</code> 会被替换为 <code>pg_default_service_dest</code> 的值，默认为 <code>pgbouncer</code>。</li><li>默认情况下 Primary 服务的目的地默认是主库上的连接池，也就是由 <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a> 指定的端口，默认为 6432</li></ul><p>如果 <code>pg_default_service_dest</code> 的值为 <code>postgres</code>，那么 primary 服务的目的地就会绕过连接池，直接使用 PostgreSQL 数据库的端口（<a href=/docs/pgsql/param#pg_port><code>pg_port</code></a>，默认值 5432），对于一些不希望使用连接池的场景，这个参数非常实用。</p><details><summary>示例：pg-test-primary 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>listen pg-test-primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5433        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary 服务默认使用 5433 端口</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /primary</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary 服务默认使用 Patroni RestAPI /primary 健康检查</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><p>Patroni 的 <a href=/docs/concept/ha>高可用</a> 机制确保任何时候最多只会有一个实例的 <code>/primary</code> 健康检查为真，因此Primary服务将始终将流量路由到主实例。</p><p>使用 Primary 服务而不是直连数据库的一个好处是，如果集群因为某种情况出现了双主（比如在没有watchdog的情况下kill -9杀死主库 Patroni），Haproxy在这种情况下仍然可以避免脑裂，因为它只会在 Patroni 存活且返回主库状态时才会分发流量。</p><hr><h2 id=replica服务>Replica服务</h2><p>Replica服务在生产环境中的重要性仅次于Primary服务，它在 5434 端口提供对数据库集群的只读能力，服务定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>选择器参数 <code>selector: "[]"</code> 意味着所有集群成员都将被包括在Replica服务中</li><li>所有实例都能够通过健康检查（<code>check: /read-only</code>），承载Replica服务的流量。</li><li>备份选择器：<code>[? pg_role == 'primary' || pg_role == 'offline' ]</code> 将主库和 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a> 标注为备份服务器。</li><li>只有当所有 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>普通从库</a> 都宕机后，Replica服务才会由主库或离线从库来承载。</li><li>目的地参数 <code>dest: default</code> 意味着Replica服务的目的地也受到 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 参数的影响</li><li><code>dest</code> 默认值 <code>default</code> 会被替换为 <code>pg_default_service_dest</code> 的值，默认为 <code>pgbouncer</code>，这一点和 <a href=#primary%E6%9C%8D%E5%8A%A1>Primary服务</a> 相同</li><li>默认情况下 Replica 服务的目的地默认是从库上的连接池，也就是由 <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a> 指定的端口，默认为 6432</li></ul><details><summary>示例：pg-test-replica 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5434</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /read-only</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><p>Replica服务非常灵活：如果有存活的专用 Replica 实例，那么它会优先使用这些实例来承载只读请求，只有当从库实例全部宕机后，才会由主库来兜底只读请求。对于常见的一主一从双节点集群就是：只要从库活着就用从库，从库挂了再用主库。</p><p>此外，除非专用只读实例全部宕机，Replica 服务也不会使用专用 Offline 实例，这样就避免了在线快查询与离线慢查询混在一起，相互影响。</p><hr><h3 id=default服务>Default服务</h3><p>Default服务在 5436 端口上提供服务，它是Primary服务的变体。</p><p>Default服务总是绕过连接池直接连到主库上的 PostgreSQL，这对于管理连接、ETL写入、CDC数据变更捕获等都很有用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果 <code>pg_default_service_dest</code> 被修改为 <code>postgres</code>，那么可以说 Default 服务除了端口和名称内容之外，与 Primary 服务是完全等价的。在这种情况下，您可以考虑将 Default 从默认服务中剔除。</p><details><summary>示例：pg-test-default 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-default</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5436         # &lt;--- 除了监听端口/目标端口和服务名，其他配置和 primary 服务一模一样</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><hr><h3 id=offline服务>Offline服务</h3><p>Default服务在 5438 端口上提供服务，它也绕开连接池直接访问 PostgreSQL 数据库，通常用于慢查询/分析查询/ETL读取/个人用户交互式查询，其服务定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Offline服务将流量直接路由到专用的 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a> 上，或者带有 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> 标记的普通 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读实例</a>。</p><ul><li>选择器参数从集群中筛选出了两种实例：<a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code> 的离线从库，或是带有 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code> 标记的普通 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读实例</a></li><li>专用离线从库和打标记的普通从库主要的区别在于：前者默认不承载 <a href=#replica%E6%9C%8D%E5%8A%A1>Replica服务</a> 的请求，避免快慢请求混在一起，而后者默认会承载。</li><li>备份选择器参数从集群中筛选出了一种实例：不带 offline 标记的普通从库，这意味着如果离线实例或者带Offline标记的普通从库挂了之后，其他普通的从库可以用来承载Offline服务。</li><li>健康检查 <code>/replica</code> 只会针对从库返回 200， 主库会返回错误，因此 Offline服务 永远不会将流量分发到主库实例上去，哪怕集群中只剩这一台主库。</li><li>同时，主库实例既不会被选择器圈中，也不会被备份选择器圈中，因此它永远不会承载Offline服务。因此 Offline 服务总是可以避免用户访问主库，从而避免对主库的影响。</li></ul><details><summary>示例：pg-test-offline 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-offline</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5438</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100 backup</span>
</span></span></code></pre></div></details><p>Offline服务提供受限的只读服务，通常用于两类查询：交互式查询（个人用户），慢查询长事务（分析/ETL）。</p><p>Offline 服务需要额外的维护照顾：当集群发生主从切换或故障自动切换时，集群的实例角色会发生变化，而 Haproxy 的配置却不会自动发生变化。对于有多个从库的集群来说，这通常并不是一个问题。
然而对于一主一从，从库跑Offline查询的精简小集群而言，主从切换意味着从库变成了主库（健康检查失效），原来的主库变成了从库（不在 Offline 后端列表中），于是没有实例可以承载 Offline 服务了，因此需要手动 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a> 以使变更生效。</p><p>如果您的业务模型较为简单，您可以考虑剔除 Default 服务与 Offline 服务，使用 Primary 服务与 Replica 服务直连数据库。</p><hr><h2 id=重载服务>重载服务</h2><p>当集群成员发生变化，如添加/删除副本、主备切换或调整相对权重时， 你需要 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a> 以使更改生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ip...<span style=color:#ce5c00;font-weight:700>]</span>         <span style=color:#8f5902;font-style:italic># 为 lb 集群或 lb 实例重载服务</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ./pgsql.yml -t pg_service         # 重载服务的实际 ansible 任务</span>
</span></span></code></pre></div><hr><h2 id=接入服务>接入服务</h2><p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器。</p><p>典型的做法是使用 DNS 或 VIP 接入，将其绑定在集群所有或任意数量的负载均衡器上。</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>你可以使用不同的 主机 & 端口 组合，它们以不同的方式提供 PostgreSQL 服务。</p><p><strong>主机</strong></p><table class=full-width><thead><tr><th>类型</th><th>样例</th><th>描述</th></tr></thead><tbody><tr><td>集群域名</td><td><code>pg-test</code></td><td>通过集群域名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>集群 VIP 地址</td><td><code>10.10.10.3</code></td><td>通过由 <code>vip-manager</code> 管理的 L2 VIP 地址访问，绑定到主节点</td></tr><tr><td>实例主机名</td><td><code>pg-test-1</code></td><td>通过任何实例主机名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>实例 IP 地址</td><td><code>10.10.10.11</code></td><td>访问任何实例的 IP 地址</td></tr></tbody></table><p><strong>端口</strong></p><p>Pigsty 使用不同的 <strong>端口</strong> 来区分 <a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>pg services</a></p><table class=full-width><thead><tr><th>端口</th><th>服务</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>数据库</td><td>直接访问 postgres 服务器</td></tr><tr><td>6432</td><td>pgbouncer</td><td>中间件</td><td>访问 postgres 前先通过连接池中间件</td></tr><tr><td>5433</td><td>primary</td><td>服务</td><td>访问主 pgbouncer (或 postgres)</td></tr><tr><td>5434</td><td>replica</td><td>服务</td><td>访问备份 pgbouncer (或 postgres)</td></tr><tr><td>5436</td><td>default</td><td>服务</td><td>访问主 postgres</td></tr><tr><td>5438</td><td>offline</td><td>服务</td><td>访问离线 postgres</td></tr></tbody></table><p><strong>组合</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群域名访问</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主直接连接</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群 VIP 直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例名</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 数据库实例直接连接 (单例访问)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库离线读/写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例 IP 访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># 数据库实例直接连接 (直接指定实例, 没有自动流量分配)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库离线读-写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 智能客户端：自动进行读写分离</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div><hr><h2 id=覆盖服务>覆盖服务</h2><p>你可以通过多种方式覆盖默认的服务配置，一种常见的需求是让 <a href=#primary%E6%9C%8D%E5%8A%A1>Primary服务</a> 与 <a href=#replica%E6%9C%8D%E5%8A%A1>Replica服务</a> 绕过Pgbouncer连接池，直接访问 PostgreSQL 数据库。</p><p>为了实现这一点，你可以将 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 更改为 <code>postgres</code>，这样所有服务定义中 <code>svc.dest='default'</code> 的服务都会使用 <code>postgres</code> 而不是默认的 <code>pgbouncer</code> 作为目标。</p><p>如果您已经将 <a href=#primary%E6%9C%8D%E5%8A%A1>Primary服务</a> 指向了 PostgreSQL，那么 <a href=#default%E6%9C%8D%E5%8A%A1>default服务</a> 就会比较多余，可以考虑移除。</p><p>如果您不需要区分个人交互式查询，分析/ETL慢查询，可以考虑从默认服务列表 <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> 中移除 <a href=#offline%E6%9C%8D%E5%8A%A1>Offline服务</a>。</p><p>如果您不需要只读从库来分担在线只读流量，也可以从默认服务列表中移除 <a href=#replica%E6%9C%8D%E5%8A%A1>Replica服务</a>。</p><hr><h2 id=委托服务>委托服务</h2><p>Pigsty 通过节点上的 haproxy 暴露 PostgreSQL 服务。整个集群中的所有 haproxy 实例都使用相同的 <a href=#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1>服务定义</a> 进行配置。</p><p>但是，你可以将 pg 服务委托给特定的节点分组（例如，专门的 haproxy 负载均衡器集群），而不是 PostgreSQL 集群成员上的 haproxy。</p><p>为此，你需要使用 <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> 覆盖默认的服务定义，并将 <a href=/docs/pgsql/param#pg_service_provider><code>pg_service_provider</code></a> 设置为代理组名称。</p><p>例如，此配置将在端口 10013 的 <code>proxy</code> haproxy 节点组上公开 pg 集群的主服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>proxy      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用端口 10013 上的 `proxy` 组的负载均衡器</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 10013 ,dest: postgres  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>用户需要确保每个委托服务的端口，在代理集群中都是<strong>唯一</strong>的。</p><p>在 43 节点生产环境仿真 <a href=/docs/deploy/sandbox><strong>沙箱</strong></a> 中提供了一个使用专用负载均衡器集群的例子：<a href=https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L111>prod.yml</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-52d6aa237ebdf1b892ae495c94936fe3>4 - 访问控制</h1><div class=lead>Pigsty 提供的默认角色系统与权限模型</div><blockquote><p>Pigsty 提供了一套开箱即用的，基于 <a href=#%E8%A7%92%E8%89%B2%E7%B3%BB%E7%BB%9F>角色系统</a> 和 <a href=#%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F>权限系统</a> 的访问控制模型。</p></blockquote><p>权限控制很重要，但很多用户做不好。因此 Pigsty 提供了一套开箱即用的精简访问控制模型，为您的集群安全性提供一个兜底。</p><hr><h2 id=角色系统>角色系统</h2><p>Pigsty 默认的角色系统包含四个 <a href=#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2>默认角色</a> 和四个 <a href=#%E9%BB%98%E8%AE%A4%E7%94%A8%E6%88%B7>默认用户</a>：</p><table class=full-width><thead><tr><th>角色名称</th><th>属性</th><th>所属</th><th>描述</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td></td><td>角色：全局只读访问</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>dbrole_readonly</td><td>角色：全局读写访问</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>pg_monitor,dbrole_readwrite</td><td>角色：管理员/对象创建</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td></td><td>角色：受限的只读访问</td></tr><tr><td><code>postgres</code></td><td><code>SUPERUSER</code></td><td></td><td>系统超级用户</td></tr><tr><td><code>replicator</code></td><td><code>REPLICATION</code></td><td>pg_monitor,dbrole_readonly</td><td>系统复制用户</td></tr><tr><td><code>dbuser_dba</code></td><td><code>SUPERUSER</code></td><td>dbrole_admin</td><td>pgsql 管理用户</td></tr><tr><td><code>dbuser_monitor</code></td><td></td><td>pg_monitor</td><td>pgsql 监控用户</td></tr></tbody></table><p>这些 <a href=/docs/pgsql/config/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7>角色与用户</a> 的详细定义如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 全局默认的角色与系统用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=默认角色>默认角色</h2><p>Pigsty 中有四个默认角色：</p><ul><li>业务只读 (<code>dbrole_readonly</code>): 用于全局只读访问的角色。如果别的业务想要此库只读访问权限，可以使用此角色。</li><li>业务读写 (<code>dbrole_readwrite</code>): 用于全局读写访问的角色，主属业务使用的生产账号应当具有数据库读写权限</li><li>业务管理员 (<code>dbrole_admin</code>): 拥有DDL权限的角色，通常用于业务管理员，或者需要在应用中建表的场景（比如各种业务软件）</li><li>离线只读访问 (<code>dbrole_offline</code>): 受限的只读访问角色（只能访问 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>offline</a> 实例，通常是个人用户，ETL工具账号）</li></ul><p>默认角色在 <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> 中定义，除非您确实知道自己在干什么，建议不要更改默认角色的名称。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  , login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access  }                           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产环境的只读角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline ,   login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access (offline instance) }     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 受限的只读角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产环境的读写角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产环境的 DDL 更改角色</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=默认用户>默认用户</h2><p>Pigsty 也有四个默认用户（系统用户）：</p><ul><li>超级用户 (<code>postgres</code>)，集群的所有者和创建者，与操作系统 dbsu 名称相同。</li><li>复制用户 (<code>replicator</code>)，用于主-从复制的系统用户。</li><li>监控用户 (<code>dbuser_monitor</code>)，用于监控数据库和连接池指标的用户。</li><li>管理用户 (<code>dbuser_dba</code>)，执行日常操作和数据库更改的管理员用户。</li></ul><p>这4个默认用户的用户名/密码通过4对专用参数进行定义，并在很多地方引用：</p><ul><li><a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a>：操作系统 dbsu 名称，默认为 postgres，最好不要更改它</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>：dbsu 密码，默认为空字符串意味着不设置 dbsu 密码，最好不要设置。</li><li><a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a>：postgres 复制用户名，默认为 <code>replicator</code></li><li><a href=/docs/pgsql/param#pg_replication_password><code>pg_replication_password</code></a>：postgres 复制密码，默认为 <code>DBUser.Replicator</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a>：postgres 管理员用户名，默认为 <code>dbuser_dba</code></li><li><a href=/docs/pgsql/param#pg_admin_password><code>pg_admin_password</code></a>：postgres 管理员密码的明文，默认为 <code>DBUser.DBA</code></li><li><a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a>：postgres 监控用户名，默认为 <code>dbuser_monitor</code></li><li><a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a>：postgres 监控密码，默认为 <code>DBUser.Monitor</code></li></ul><blockquote><p><strong>在生产部署中记得更改这些密码，不要使用默认值！</strong></p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 数据库超级用户名，这个用户名建议不要修改。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 数据库超级用户密码，这个密码建议留空！禁止dbsu密码登陆。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统复制用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统复制密码，请务必修改此密码！</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统监控用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统监控密码，请务必修改此密码！</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统管理用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统管理密码，请务必修改此密码！</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果您修改默认用户的参数，在 <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> 中修改相应的角色 <a href=/docs/pgsql/config/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7>定义</a> 即可：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true                                          ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=权限系统>权限系统</h2><p>Pigsty 拥有一套开箱即用的权限模型，该模型与 <a href=#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2>默认角色</a> 一起配合工作。</p><ul><li>所有用户都可以访问所有模式。</li><li>只读用户（<code>dbrole_readonly</code>）可以从所有表中读取数据。（SELECT，EXECUTE）</li><li>读写用户（<code>dbrole_readwrite</code>）可以向所有表中写入数据并运行 DML。（INSERT，UPDATE，DELETE）。</li><li>管理员用户（<code>dbrole_admin</code>）可以创建对象并运行 DDL（CREATE，USAGE，TRUNCATE，REFERENCES，TRIGGER）。</li><li>离线用户（<code>dbrole_offline</code>）类似只读用户，但访问受到限制，只允许访问 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线实例</a>（<code>pg_role = 'offline'</code> 或 <code>pg_offline_query = true</code>）</li><li>由管理员用户创建的对象将具有正确的权限。</li><li>所有数据库上都配置了默认权限，包括模板数据库。</li><li>数据库连接权限由数据库 <a href=/docs/pgsql/config/db#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>定义</a> 管理。</li><li>默认撤销<code>PUBLIC</code>在数据库和<code>public</code>模式下的<code>CREATE</code>权限。</li></ul><hr><h2 id=对象权限>对象权限</h2><p>数据库中新建对象的默认权限由参数 <a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a> 所控制：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>由管理员<strong>新创建</strong>的对象，默认将会上述权限。使用 <code>\ddp+</code> 可以查看这些默认权限：</p><table class=full-width><thead><tr><th>类型</th><th>访问权限</th></tr></thead><tbody><tr><td>函数</td><td>=X</td></tr><tr><td></td><td>dbrole_readonly=X</td></tr><tr><td></td><td>dbrole_offline=X</td></tr><tr><td></td><td>dbrole_admin=X</td></tr><tr><td>模式</td><td>dbrole_readonly=U</td></tr><tr><td></td><td>dbrole_offline=U</td></tr><tr><td></td><td>dbrole_admin=UC</td></tr><tr><td>序列号</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=wU</td></tr><tr><td></td><td>dbrole_admin=rwU</td></tr><tr><td>表</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=awd</td></tr><tr><td></td><td>dbrole_admin=arwdDxt</td></tr></tbody></table><hr><h2 id=默认权限>默认权限</h2><p><a href=https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html><code>ALTER DEFAULT PRIVILEGES</code></a> 允许您设置将来创建的对象的权限。 它不会影响已经存在对象的权限，也不会影响非管理员用户创建的对象。</p><p>在 Pigsty 中，默认权限针对三个角色进行定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dbsu</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_admin_username</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对于其他业务管理员而言，它们应当在执行 DDL 前执行 SET ROLE dbrole_admin，从而使用对应的默认权限配置。
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这些内容将会被 PG集群初始化模板 <a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>pg-init-template.sql</code></a> 所使用，在集群初始化的过程中渲染并输出至 <code>/pg/tmp/pg-init-template.sql</code>。
该命令会在 <code>template1</code> 与 <code>postgres</code> 数据库中执行，新创建的数据库会通过模板 <code>template1</code> 继承这些默认权限配置。</p><p>也就是说，为了维持正确的对象权限，您必须用<strong>管理员用户</strong>来执行 DDL，它们可以是：</p><ol><li><a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>，默认为 <code>postgres</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>{{ pg_admin_username }}</code></a>，默认为 <code>dbuser_dba</code></li><li>授予了 <code>dbrole_admin</code> 角色的业务管理员用户（通过 <code>SET ROLE</code> 切换为 <code>dbrole_admin</code> 身份）。</li></ol><p>使用 <code>postgres</code> 作为全局对象所有者是明智的。如果您希望以业务管理员用户身份创建对象，创建之前必须使用 <code>SET ROLE dbrole_admin</code> 来维护正确的权限。</p><p>当然，您也可以在数据库中通过 <code>ALTER DEFAULT PRIVILEGE FOR ROLE &lt;some_biz_admin> XXX</code> 来显式对业务管理员授予默认权限。</p><hr><h2 id=数据库权限>数据库权限</h2><p>在 Pigsty 中，数据库（Database）层面的权限在 <a href=/docs/pgsql/config/db#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>数据库定义</a> 中被涵盖。</p><p>数据库有三个级别的权限：<code>CONNECT</code>、<code>CREATE</code>、<code>TEMP</code>，以及一个特殊的&rsquo;权限&rsquo;：<code>OWNERSHIP</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是数据库定义中唯一的必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库所有者，默认为 postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>如果 <code>owner</code> 参数存在，它作为数据库属主，替代默认的 <a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>（通常也就是<code>postgres</code>）</li><li>如果 <code>revokeconn</code> 为 <code>false</code>，所有用户都有数据库的 <code>CONNECT</code> 权限，这是默认的行为。</li><li>如果显式设置了 <code>revokeconn</code> 为 <code>true</code>：<ul><li>数据库的 <code>CONNECT</code> 权限将从 <code>PUBLIC</code> 中撤销：普通用户无法连接上此数据库</li><li><code>CONNECT</code> 权限将被显式授予 <code>{{ pg_replication_username }}</code>、<code>{{ pg_monitor_username }}</code> 和 <code>{{ pg_admin_username }}</code></li><li><code>CONNECT</code> 权限将 <code>GRANT OPTION</code> 被授予数据库属主，数据库属主用户可以自行授权其他用户连接权限。</li></ul></li><li><code>revokeconn</code> 选项可用于在同一个集群间隔离跨数据库访问，您可以为每个数据库创建不同的业务用户作为属主，并为它们设置 <code>revokeconn</code> 选项。</li></ul><details><summary>示例：数据库隔离</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.40</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.41</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_confluence, password: mc2iohos , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_gitlab, password: sdf23g22sfdd , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_readwrite ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_jira, password: sdpijfsfdsfdfs , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: confluence , revokeconn: true, owner: dbuser_confluence , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitlab , revokeconn: true, owner: dbuser_gitlab, connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: jira , revokeconn: true, owner: dbuser_jira , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=create权限>CREATE权限</h2><p>出于安全考虑，Pigsty 默认从 <code>PUBLIC</code> 撤销数据库上的 <code>CREATE</code> 权限，从 PostgreSQL 15 开始这也是默认行为。</p><p>数据库属主总是可以根据实际需要，来自行调整 CREATE 权限。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-3d5c83e1f406be878a7cbcafe1e9c234>5 - 管理任务</h1><p>数据库管理与运维任务</p></div><div class=td-content style=page-break-before:always><h1 id=pg-48b1bc6613befa103400a3961be086ff>6 - 日常管理</h1><div class=lead>数据库日常管理任务标准操作指南（SOP）</div></div><div class=td-content><h1 id=pg-17b67ff7274e6ed5025cdb1b71ec35a4>6.1 - 管理 PostgreSQL 数据库集群</h1><div class=lead>创建/销毁 PostgreSQL 集群，以及对现有集群进行扩容，缩容，克隆集群。</div><h2 id=速查手册>速查手册</h2><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>创建集群</strong></a></td><td style=text-align:left><code>bin/pgsql-add &lt;cls></code></td><td style=text-align:left>创建新的 PostgreSQL 集群</td></tr><tr><td style=text-align:left><a href=#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4><strong>扩容集群</strong></a></td><td style=text-align:left><code>bin/pgsql-add &lt;cls> &lt;ip...></code></td><td style=text-align:left>为现有集群添加从库副本</td></tr><tr><td style=text-align:left><a href=#%E7%BC%A9%E5%AE%B9%E9%9B%86%E7%BE%A4><strong>缩容集群</strong></a></td><td style=text-align:left><code>bin/pgsql-rm &lt;cls> &lt;ip...></code></td><td style=text-align:left>从集群中移除指定实例</td></tr><tr><td style=text-align:left><a href=#%E9%94%80%E6%AF%81%E9%9B%86%E7%BE%A4><strong>销毁集群</strong></a></td><td style=text-align:left><code>bin/pgsql-rm &lt;cls></code></td><td style=text-align:left>销毁整个 PostgreSQL 集群</td></tr><tr><td style=text-align:left><a href=#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1><strong>刷新服务</strong></a></td><td style=text-align:left><code>bin/pgsql-svc &lt;cls> [ip...]</code></td><td style=text-align:left>重载集群的负载均衡配置</td></tr><tr><td style=text-align:left><a href=#%E5%88%B7%E6%96%B0hba><strong>刷新HBA</strong></a></td><td style=text-align:left><code>bin/pgsql-hba &lt;cls> [ip...]</code></td><td style=text-align:left>重载集群的 HBA 访问规则</td></tr><tr><td style=text-align:left><a href=#%E5%85%8B%E9%9A%86%E9%9B%86%E7%BE%A4><strong>克隆集群</strong></a></td><td style=text-align:left>-</td><td style=text-align:left>通过备份集群或 PITR 克隆</td></tr></tbody></table><p>其他管理任务，请参考：<a href=/docs/pgsql/admin/patroni><strong>高可用管理</strong></a>，<a href=/docs/pgsql/admin/user/><strong>管理用户</strong></a>，<a href=/docs/pgsql/admin/db/><strong>管理数据库</strong></a>。</p><hr><h2 id=创建集群>创建集群</h2><p>要创建一个新的 PostgreSQL 集群，请首先在 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中 <a href=/docs/pgsql/config/cluster><strong>定义集群</strong></a>，然后 <a href=/docs/node/admin#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9><strong>纳管节点</strong></a>并进行初始化：</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-00-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-00-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-00-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add  &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># 添加分组 &lt;cls&gt; 下的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml  -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本添加分组 &lt;cls&gt; 下的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># 例子，添加 pg-test 分组下的节点，实际执行 ./node.yml -l pg-test</span>
</span></span></code></pre></div></div></div><p>在被纳管的节点上，可以使用以下命令创建集群：（针对 <strong><code>&lt;cls></code></strong> 分组执行 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> 剧本）</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-01-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-01-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-01-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># 创建 PostgreSQL 集群 &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本创建 PostgreSQL 集群 &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># 例子，创建 pg-test 集群</span>
</span></span></code></pre></div></div></div><p><strong>示例：创建三节点 PG 集群 <code>pg-test</code></strong></p><div id=asciinema-942dc186323899bcee0f4643447fbd01 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-942dc186323899bcee0f4643447fbd01",o="/demo/pgsql.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[4,"执行"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>针对已经存在的集群重新执行创建存在风险</div><p>如果您在已经存在的集群上重新执行创建操作，Pigsty 不会移除已有的数据文件，但现有服务配置会被覆盖，集群会发生 <strong>重启</strong>！
此外，如果你在 <a href=/docs/pgsql/config/db#baseline><strong>数据库定义</strong></a> 中指定了 <code>baseline</code> SQL ，它也会重新执行，如果里面包含删除/覆盖逻辑，可能会导致 <strong>数据丢失</strong>。</p></div><hr><h2 id=扩容集群>扩容集群</h2><p>若要将新从库添加到 <strong>现有的 PostgreSQL 集群</strong> 中，您需要将 <a href=/docs/pgsql/config/cluster><strong>实例定义</strong></a> 添加到 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a>：<code>all.children.&lt;cls>.hosts</code> 中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 已存在的成员</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 已存在的成员</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 新成员</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>扩容集群的操作与 <a href=#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>创建集群</strong></a> 非常类似，首先需要将扩容的节点纳入 Pigsty 管理：<a href=/docs/node/admin#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9><strong>添加节点</strong></a>：</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-04-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-04-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-04-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add &lt;ip&gt;       <span style=color:#8f5902;font-style:italic># 添加 IP 地址为 &lt;ip&gt; 的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -l &lt;ip&gt;      <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本添加 &lt;ip&gt; 对应的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add 10.10.10.13    <span style=color:#8f5902;font-style:italic># 例子，添加 IP 为 10.10.10.13 的节点，实际执行 ./node.yml -l 10.10.10.13</span>
</span></span></code></pre></div></div></div><p>然后在新节点上运行以下命令以扩容集群（针对新节点安装 <a href=/docs/pgsql><strong>PGSQL 模块</strong></a>，使用与现有集群相同的 <a href=/docs/pgsql/param#pg_cluster><strong><code>pg_cluster</code></strong></a>）</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-05-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-05-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-05-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add &lt;cls&gt; &lt;ip&gt;  <span style=color:#8f5902;font-style:italic># 添加 IP 地址为 &lt;ip&gt; 的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;       <span style=color:#8f5902;font-style:italic># 核心逻辑：使用 Ansible 剧本在 &lt;ip&gt; 节点上安装 PGSQL 模块</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test 10.10.10.13   <span style=color:#8f5902;font-style:italic># 示例，为 pg-test 集群扩容 IP 为 10.10.10.13 的节点</span>
</span></span></code></pre></div></div></div><p>扩容完成后，您应当 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1><strong>刷新服务</strong></a> 以将新成员添加至负载均衡器中以实际承载流量。</p><p><strong>示例：为两节点集群 <code>pg-test</code> 扩容一个新从库 <code>10.10.10.13</code></strong></p><div id=asciinema-05fce5eacdeb3446795df8299bfa61bb class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-05fce5eacdeb3446795df8299bfa61bb",o="/demo/pgsql-append.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=缩容集群>缩容集群</h2><p>若要从 <strong>现有的 PostgreSQL 集群</strong> 中移除副本，您需要从 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 的 <code>all.children.&lt;cls>.hosts</code> 中移除对应的 <a href=/docs/pgsql/config/cluster><strong>实例定义</strong></a>。</p><p>缩容集群首先需要卸载目标节点上的 PGSQL 模块（针对 <strong><code>&lt;ip></code></strong> 执行 <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> 剧本）：</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-07-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-07-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-07-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm &lt;cls&gt; &lt;ip&gt;   <span style=color:#8f5902;font-style:italic># 从集群 &lt;cls&gt; 中移除 &lt;ip&gt; 节点上的 PostgreSQL 实例</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;ip&gt;    <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本移除 &lt;ip&gt; 节点上的 PostgreSQL 实例</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-test 10.10.10.13  <span style=color:#8f5902;font-style:italic># 例子，从 pg-test 集群移除 10.10.10.13 节点</span>
</span></span></code></pre></div></div></div><p>移除 PGSQL 模块后，您可以选择将节点从 Pigsty 管理中移除：<a href=/docs/node/admin#%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9><strong>移除节点</strong></a>（可选）：</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-08-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-08-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-08-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm &lt;ip&gt;          <span style=color:#8f5902;font-style:italic># 从 Pigsty 管理中移除 &lt;ip&gt; 节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node-rm.yml -l &lt;ip&gt;     <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本从 Pigsty 管理中移除 &lt;ip&gt; 节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm 10.10.10.13   <span style=color:#8f5902;font-style:italic># 例子，从 Pigsty 管理中移除 10.10.10.13 节点</span>
</span></span></code></pre></div></div></div><p>缩容完成后，您应当从 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中移除该实例的定义，然后 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1><strong>刷新服务</strong></a> 以将已它从负载均衡器中踢除。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 执行后移除此行</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>示例：从三节点集群 <code>pg-test</code> 中缩容一个从库 <code>10.10.10.13</code></strong></p><div id=asciinema-89bfaa9d26b25502fcaa59352090b5f0 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-89bfaa9d26b25502fcaa59352090b5f0",o="/demo/pgsql-shrink.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=销毁集群>销毁集群</h2><p>销毁集群需要在集群的所有节点上卸载 PGSQL 模块（针对 <strong><code>&lt;cls></code></strong> 执行 <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> 剧本）：</p><ul class="nav nav-tabs" id=tabs-10 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-10-00-tab data-bs-toggle=tab data-bs-target=#tabs-10-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-10-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-10-01-tab data-bs-toggle=tab data-bs-target=#tabs-10-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-10-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-10-02-tab data-bs-toggle=tab data-bs-target=#tabs-10-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-10-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-10-content><div class="tab-body tab-pane fade show active" id=tabs-10-00 role=tabpanel aria-labelled-by=tabs-10-00-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm &lt;cls&gt;        <span style=color:#8f5902;font-style:italic># 销毁整个 PostgreSQL 集群 &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-01 role=tabpanel aria-labelled-by=tabs-10-01-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本销毁整个 PostgreSQL 集群 &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-02 role=tabpanel aria-labelled-by=tabs-10-02-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-test      <span style=color:#8f5902;font-style:italic># 例子，销毁 pg-test 集群</span>
</span></span></code></pre></div></div></div><p>销毁 PGSQL 模块后，您可以选择将节点一并从 Pigsty 管理中移除：<a href=/docs/node/admin#%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9><strong>移除节点</strong></a>（可选，如果还有其他服务可以保留）：</p><ul class="nav nav-tabs" id=tabs-11 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-11-00-tab data-bs-toggle=tab data-bs-target=#tabs-11-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-11-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-11-01-tab data-bs-toggle=tab data-bs-target=#tabs-11-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-11-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-11-02-tab data-bs-toggle=tab data-bs-target=#tabs-11-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-11-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-11-content><div class="tab-body tab-pane fade show active" id=tabs-11-00 role=tabpanel aria-labelled-by=tabs-11-00-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm &lt;cls&gt;         <span style=color:#8f5902;font-style:italic># 从 Pigsty 管理中移除 &lt;cls&gt; 分组下的所有节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-01 role=tabpanel aria-labelled-by=tabs-11-01-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node-rm.yml -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本从 Pigsty 管理中移除 &lt;cls&gt; 分组下的所有节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-02 role=tabpanel aria-labelled-by=tabs-11-02-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm pg-test       <span style=color:#8f5902;font-style:italic># 例子，从 Pigsty 管理中移除 pg-test 分组下的所有节点</span>
</span></span></code></pre></div></div></div><p>销毁结束后，建议及时从 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中移除整个 <a href=/docs/pgsql/config/cluster><strong>集群定义</strong></a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 清理这个集群定义分组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>示例：销毁三节点 PG 集群 <code>pg-test</code></strong></p><div id=asciinema-4b148718963c7bab646e97087cabccda class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-4b148718963c7bab646e97087cabccda",o="/demo/pgsql-rm.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><p>注意：如果为这个集群配置了 <a href=/docs/pgsql/param#pg_safeguard><strong><code>pg_safeguard</code></strong></a>（或全局设置为 <code>true</code>），<code>pgsql-rm.yml</code> 将中止执行，以避免意外销毁集群。
您可以使用剧本命令行参数明确地覆盖它，以强制执行销毁。
此外默认情况下，集群的备份仓库将同集群一并删除。如果你希望保留备份（例如在使用集中式备份仓库时），可以设置 <a href=/docs/pgsql/param#pg_rm_backup><strong><code>pg_rm_backup=false</code></strong></a> 参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l pg-meta -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># 强制销毁受保护的 pg 集群 pg-meta</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-meta -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># 在销毁集群过程中保留其备份仓库</span>
</span></span></code></pre></div><hr><h2 id=刷新服务>刷新服务</h2><p>PostgreSQL 集群通过主机节点上的 <a href=/docs/concept/arch/pgsql#haproxy><strong>HAProxy</strong></a> 对外提供 <a href=/docs/pgsql/service/><strong>服务</strong></a>。
当服务定义变化，实例权重变化，或者集群成员发生变化时（例如，集群 <a href=#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4><strong>扩容</strong></a> / <a href=#%E7%BC%A9%E5%AE%B9%E9%9B%86%E7%BE%A4><strong>缩容</strong></a>，主从切换／故障转移），您需要择机刷新服务以更新负载均衡器的配置。</p><p>要在整个集群或特定实例上刷新服务配置（针对 <strong><code>&lt;cls></code></strong> 或 <strong><code>&lt;ip></code></strong> 执行 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> 的 <code>pg_service</code> 子任务）：</p><ul class="nav nav-tabs" id=tabs-13 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-13-00-tab data-bs-toggle=tab data-bs-target=#tabs-13-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-13-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-13-01-tab data-bs-toggle=tab data-bs-target=#tabs-13-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-13-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-13-02-tab data-bs-toggle=tab data-bs-target=#tabs-13-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-13-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-13-content><div class="tab-body tab-pane fade show active" id=tabs-13-00 role=tabpanel aria-labelled-by=tabs-13-00-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># 刷新整个集群 &lt;cls&gt; 的服务配置</span>
</span></span><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; &lt;ip...&gt;   <span style=color:#8f5902;font-style:italic># 刷新集群 &lt;cls&gt; 中指定实例的服务配置</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-13-01 role=tabpanel aria-labelled-by=tabs-13-01-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_service -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>        <span style=color:#8f5902;font-style:italic># 刷新整个集群的服务配置</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;  -t pg_service -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>        <span style=color:#8f5902;font-style:italic># 刷新指定实例的服务配置</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-13-02 role=tabpanel aria-labelled-by=tabs-13-02-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc pg-test                 <span style=color:#8f5902;font-style:italic># 例子，刷新 pg-test 集群的服务配置</span>
</span></span><span style=display:flex><span>bin/pgsql-svc pg-test 10.10.10.13     <span style=color:#8f5902;font-style:italic># 例子，刷新 pg-test 集群中 10.10.10.13 实例的服务配置</span>
</span></span></code></pre></div></div></div><blockquote><p>备注：如果您使用集中式的专用负载均衡集群（<a href=/docs/pgsql/param#pg_service_provider><strong><code>pg_service_provider</code></strong></a>），那么只有刷新集群主库时才会更新负载均衡配置。</p></blockquote><p><strong>示例：刷新集群 <code>pg-test</code> 的服务配置</strong></p><div id=asciinema-d04ae8e428be2e84e61f51c21cb4556e class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-d04ae8e428be2e84e61f51c21cb4556e",o="/demo/pgsql-svc.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><details><summary>示例：重载PG服务以踢除一个实例</summary><p><a href=https://asciinema.org/a/568815><img src=https://asciinema.org/a/568815.svg alt=asciicast></a></p></details><hr><h2 id=刷新hba>刷新HBA</h2><p>当您修改了 HBA 相关配置后，需要刷新 HBA 规则以应用更改。（<a href=/docs/pgsql/param#pg_hba_rules><strong><code>pg_hba_rules</code></strong></a> / <a href=/docs/pgsql/param#pgb_hba_rules><strong><code>pgb_hba_rules</code></strong></a>）
如果您有任何特定于角色的 HBA 规则，或者在 IP 地址段中引用了集群成员的别名，那么当主从切换/集群扩缩容后也可能需要刷新 HBA。</p><p>要在整个集群或特定实例上刷新 PG 和 Pgbouncer 的 HBA 规则（针对 <strong><code>&lt;cls></code></strong> 或 <strong><code>&lt;ip></code></strong> 执行 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> 的 HBA 相关子任务）：</p><ul class="nav nav-tabs" id=tabs-15 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-15-00-tab data-bs-toggle=tab data-bs-target=#tabs-15-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-15-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-15-01-tab data-bs-toggle=tab data-bs-target=#tabs-15-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-15-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-15-02-tab data-bs-toggle=tab data-bs-target=#tabs-15-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-15-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-15-content><div class="tab-body tab-pane fade show active" id=tabs-15-00 role=tabpanel aria-labelled-by=tabs-15-00-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># 刷新整个集群 &lt;cls&gt; 的 HBA 规则</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; &lt;ip...&gt;   <span style=color:#8f5902;font-style:italic># 刷新集群 &lt;cls&gt; 中指定实例的 HBA 规则</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-15-01 role=tabpanel aria-labelled-by=tabs-15-01-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>   <span style=color:#8f5902;font-style:italic># 刷新整个集群</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;  -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>   <span style=color:#8f5902;font-style:italic># 刷新指定实例</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-15-02 role=tabpanel aria-labelled-by=tabs-15-02-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba pg-test                 <span style=color:#8f5902;font-style:italic># 例子，刷新 pg-test 集群的 HBA 规则</span>
</span></span><span style=display:flex><span>bin/pgsql-hba pg-test 10.10.10.13     <span style=color:#8f5902;font-style:italic># 例子，刷新 pg-test 集群中 10.10.10.13 实例的 HBA 规则</span>
</span></span></code></pre></div></div></div><p><strong>示例：刷新集群 <code>pg-test</code> 的 HBA 规则</strong></p><div id=asciinema-ff9b13ed062434f2b3b348cc9909ad10 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ff9b13ed062434f2b3b348cc9909ad10",o="/demo/pgsql-hba.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=配置集群>配置集群</h2><p>PostgreSQL 的配置参数由 Patroni 管理，初始参数由 <a href=/docs/pgsql/template/><strong>Patroni 配置模板</strong></a> 指定。
集群初始化之后，配置存储在 Etcd 中，并由 Patroni 进行动态管理，并在集群中同步与共享。
Patroni 本身的 <a href=/docs/pgsql/admin/patroni#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong>配置参数</strong></a> 大部分可以通过 <code>patronictl</code>命令行工具修改。
其余参数（例如，etcd DCS 配置，日志/RestAPI 等配置）则可以通过下面的子任务进行更新。例如，当 <a href=/docs/etcd><strong>etcd</strong></a> 集群成员发生变动时，你可以刷新 Patroni 配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-test -t pg_conf                   <span style=color:#8f5902;font-style:italic># 更新 Patroni 配置文件</span>
</span></span><span style=display:flex><span>ansible pg-test -b -a <span style=color:#4e9a06>&#39;systemctl reload patroni&#39;</span>    <span style=color:#8f5902;font-style:italic># 重载 Patroni 服务</span>
</span></span></code></pre></div><p>您可以在不同层次上覆盖 Patroni 集中管理的默认，例如单独 <a href=/docs/pgsql/param#pg_parameters><strong>为实例指定配置参数</strong></a>；
单独为 <a href=/docs/pgsql/admin/user><strong>为用户指定配置参数</strong></a>，或者 <a href=/docs/pgsql/admin/db><strong>为数据库指定配置参数</strong></a>。</p><hr><h2 id=克隆集群>克隆集群</h2><p>有两种克隆集群的方式：使用 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4><strong>备份集群</strong></a> 功能，或者使用 <a href=/docs/pgsql/backup/restore#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B><strong>时间点恢复</strong></a> 功能。
前者配置简单，无需依赖，但只能克隆指定集群的最新状态；后者依赖集中式的 <a href=/docs/pgsql/backup/repository><strong>备份仓库</strong></a>（例如 MinIO），但可以克隆到备份保留期内的任意时间点。</p><table><thead><tr><th style=text-align:left>方式</th><th style=text-align:left>优点</th><th style=text-align:left>缺点</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:left>备份集群</td><td style=text-align:left>配置简单，无需依赖</td><td style=text-align:left>只能克隆最新状态</td><td style=text-align:left>灾备，读写分离，迁移</td></tr><tr><td style=text-align:left>PITR</td><td style=text-align:left>可恢复到任意时间点</td><td style=text-align:left>依赖集中式备份仓库</td><td style=text-align:left>误操作恢复，数据审计</td></tr></tbody></table><h3 id=使用备份集群克隆>使用备份集群克隆</h3><p>备份集群（Standby Cluster）通过流复制从上游集群持续同步数据，是克隆集群最简单的方式。
只需在新集群主库上指定 <a href=/docs/pgsql/param#pg_upstream><strong><code>pg_upstream</code></strong></a> 参数，即可自动从上游集群拉取数据。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test 是原始集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test2 是 pg-test 的备份集群（克隆）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 指定上游</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test2 }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用以下命令创建备份集群：</p><ul class="nav nav-tabs" id=tabs-17 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-17-00-tab data-bs-toggle=tab data-bs-target=#tabs-17-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-17-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-17-01-tab data-bs-toggle=tab data-bs-target=#tabs-17-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-17-01 aria-selected=false>
剧本</button></li></ul><div class=tab-content id=tabs-17-content><div class="tab-body tab-pane fade show active" id=tabs-17-00 role=tabpanel aria-labelled-by=tabs-17-00-tab tabindex=17><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test2    <span style=color:#8f5902;font-style:italic># 创建备份集群，自动从上游 pg-test 克隆数据</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-17-01 role=tabpanel aria-labelled-by=tabs-17-01-tab tabindex=17><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-test2   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本创建备份集群</span>
</span></span></code></pre></div></div></div><p>备份集群会持续追随上游集群，保持数据同步。您可以随时将其 <strong>提升</strong> 为独立集群：</p><details><summary>示例：提升备份集群为独立集群</summary><p>通过 <a href=#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4><strong>配置集群</strong></a> 擦除 <code>standby_cluster</code> 配置段，即可将备份集群提升为独立集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>-standby_cluster:
</span></span><span style=display:flex><span>-  create_replica_methods:
</span></span><span style=display:flex><span>-  - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11
</span></span><span style=display:flex><span>-  port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>提升后，<code>pg-test2</code> 将成为可以独立承载写入请求的独立集群，与原集群 <code>pg-test</code> 分叉。</p></details><details><summary>示例：更改复制上游</summary><p>如果上游集群发生主从切换，您可以通过 <a href=#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4><strong>配置集群</strong></a> 更改备份集群的复制上游：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11     <span style=color:#8f5902;font-style:italic># &lt;--- 旧的上游</span>
</span></span><span style=display:flex><span>+  host: 10.10.10.14     <span style=color:#8f5902;font-style:italic># &lt;--- 新的上游</span>
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><h3 id=使用-pitr-克隆>使用 PITR 克隆</h3><p><a href=/docs/pgsql/backup/restore><strong>时间点恢复</strong></a>（PITR）允许您将集群恢复到备份保留期内的任意时间点。
此方式依赖集中式的 <a href=/docs/pgsql/backup/repository><strong>备份仓库</strong></a>（如 MinIO/S3），但功能更加强大。</p><p>要使用 PITR 克隆集群，在配置中添加 <a href=/docs/pgsql/backup/restore#pitr-%E5%8F%82%E6%95%B0%E5%AE%9A%E4%B9%89><strong><code>pg_pitr</code></strong></a> 参数指定恢复目标：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从 pg-meta 集群的备份克隆一个新集群 pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 从 pg-meta 的备份恢复</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-01-10 10:00:00+00&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 恢复到指定时间点</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用 <code>pgsql-pitr.yml</code> 剧本执行克隆：</p><ul class="nav nav-tabs" id=tabs-18 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-18-00-tab data-bs-toggle=tab data-bs-target=#tabs-18-00 role=tab data-td-tp-persist=剧本 aria-controls=tabs-18-00 aria-selected=true>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-18-01-tab data-bs-toggle=tab data-bs-target=#tabs-18-01 role=tab data-td-tp-persist=命令行 aria-controls=tabs-18-01 aria-selected=false>
命令行</button></li></ul><div class=tab-content id=tabs-18-content><div class="tab-body tab-pane fade show active" id=tabs-18-00 role=tabpanel aria-labelled-by=tabs-18-00-tab tabindex=18><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2    <span style=color:#8f5902;font-style:italic># 从 pg-meta 备份克隆 pg-meta2</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-18-01 role=tabpanel aria-labelled-by=tabs-18-01-tab tabindex=18><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 也可以通过命令行参数指定 PITR 选项</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-01-10 10:00:00+00&#34;}}&#39;</span>
</span></span></code></pre></div></div></div><p>PITR 支持多种恢复目标类型：</p><table><thead><tr><th style=text-align:left>目标类型</th><th style=text-align:left>参数示例</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>时间点</td><td style=text-align:left><code>time: "2025-01-10 10:00:00+00"</code></td><td style=text-align:left>恢复到指定时间戳</td></tr><tr><td style=text-align:left>事务ID</td><td style=text-align:left><code>xid: "250000"</code></td><td style=text-align:left>恢复到指定事务之前/之后</td></tr><tr><td style=text-align:left>恢复点</td><td style=text-align:left><code>name: "before_migration"</code></td><td style=text-align:left>恢复到命名恢复点</td></tr><tr><td style=text-align:left>LSN</td><td style=text-align:left><code>lsn: "0/4001C80"</code></td><td style=text-align:left>恢复到指定 WAL 位置</td></tr><tr><td style=text-align:left>最新</td><td style=text-align:left><code>type: "latest"</code></td><td style=text-align:left>恢复到 WAL 归档末尾</td></tr></tbody></table><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>PITR 恢复后处理</div><p>恢复后的集群会<strong>禁用</strong> <code>archive_mode</code>，以防止意外的 WAL 写入覆盖归档。
如果恢复后的数据库状态正常，您应当启用归档并执行新的全量备份：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode; SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>pg-backup full    <span style=color:#8f5902;font-style:italic># 执行新的全量备份</span>
</span></span></code></pre></div></div><p>更多 PITR 的详细用法，请参考 <a href=/docs/pgsql/backup/restore><strong>恢复操作</strong></a> 文档。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-81e255f632d154a2662d19c783c4514a>6.2 - 管理 PostgreSQL 业务用户</h1><div class=lead>用户管理：创建、修改、删除用户，管理角色成员关系，连接池用户配置</div><h2 id=快速上手>快速上手</h2><p>Pigsty 使用声明式管理方式，首先在 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中 <a href=/docs/pgsql/config/user><strong>定义用户</strong></a>，然后使用 <code>bin/pgsql-user &lt;cls> &lt;username></code> 创建或修改用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_app, password: &#39;DBUser.App&#39;, pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># &lt;--- 在这里定义用户列表！</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-00-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-00-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-00-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上创建/修改 &lt;username&gt; 用户</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l pg-meta -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_app    <span style=color:#8f5902;font-style:italic># 直接使用剧本在 &lt;cls&gt; 集群上创建/修改 &lt;username&gt; 用户</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上创建/修改 dbuser_app 用户</span>
</span></span></code></pre></div></div></div><p>关于用户定义参数的完整参考，请查阅 <a href=/docs/pgsql/config/user><strong>用户配置</strong></a>。关于用户的访问权限，请参考 <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7><strong>ACL：角色权限</strong></a>。</p><p>请注意，用户的 <code>name</code> 字段在创建后无法修改。如需更改用户名，请先删除原用户，再创建新用户。</p><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7><strong>创建用户</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>创建新的业务用户或角色</td></tr><tr><td style=text-align:left><a href=#%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7><strong>修改用户</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>修改已存在用户的属性</td></tr><tr><td style=text-align:left><a href=#%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7><strong>删除用户</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>安全删除用户（需设置 <code>state: absent</code>）</td></tr></tbody></table><div id=asciinema-ea4542a7c787faec4a82af4534ee61d2 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ea4542a7c787faec4a82af4534ee61d2",o="/demo/pgsql-user.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=创建用户>创建用户</h2><p>定义在 <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> 里面的用户会在 PostgreSQL <a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>集群创建</strong></a> 的时候在 <code>pg_user</code> 任务中自动创建。</p><p>要在现有的 PostgreSQL 集群上创建新的业务用户，请将 <a href=/docs/pgsql/config/user><strong>用户定义</strong></a> 添加到 <code>all.children.&lt;cls>.pg_users</code>，然后执行：</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-02-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-02-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-02-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;   <span style=color:#8f5902;font-style:italic># 创建用户 &lt;username&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;username&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本创建用户</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># 例子，在 pg-meta 集群中创建 dbuser_app 用户</span>
</span></span></code></pre></div></div></div><p><strong>示例配置：创建名为 <code>dbuser_app</code> 的业务用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars.pg_users: # 省略上级缩进</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>application user for myapp</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>执行效果</strong>：在主库上创建用户 <code>dbuser_app</code>，设置密码，授予 <code>dbrole_readwrite</code> 角色权限，
将用户添加到 Pgbouncer 连接池，在每个实例上重载 Pgbouncer 配置使其立即生效。</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>建议使用剧本创建用户</div><p>如果您需要手工创建用户，那么需要自行确保 Pgbouncer 连接池用户列表同步。</p></div><hr><h2 id=修改用户>修改用户</h2><p>修改用户与创建用户使用相同的命令，剧本是幂等的。当目标用户已存在时，Pigsty 会修改目标用户的属性使其符合配置。</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-04-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-04-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-04-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;user&gt;   <span style=color:#8f5902;font-style:italic># 修改用户 &lt;user&gt; 的属性</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;user&gt;   <span style=color:#8f5902;font-style:italic># 幂等操作，可重复执行</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># 修改 dbuser_app 用户的属性使其符合配置</span>
</span></span></code></pre></div></div></div><p><strong>不可修改的属性</strong>：用户的 <code>name</code>（名称）在创建后无法修改，需要先删除再创建。</p><p>其他属性均可修改，以下是一些常见的修改示例：</p><p><strong>修改密码</strong>：更新配置中的 <code>password</code> 字段后执行剧本。密码修改时会临时禁用日志记录，避免密码泄露到日志中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>NewSecretPassword    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 修改密码</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>修改权限属性</strong>：通过配置相应的布尔标志来修改用户权限。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 超级用户（谨慎使用！）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 允许创建数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 允许创建角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 自动继承角色权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 允许流复制连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 绕过行级安全策略</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 限制连接数，-1 不限制</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>修改用户有效期</strong>：使用 <code>expire_in</code> 设置相对过期时间（N 天后过期），或 <code>expire_at</code> 设置绝对过期日期。<code>expire_in</code> 优先级更高，每次执行剧本时会重新计算，适合需要定期续期的临时用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 30 天后过期（相对时间）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 指定日期过期（绝对时间）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>permanent_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 永不过期</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>修改角色成员关系</strong>：通过 <code>roles</code> 数组配置角色成员关系，支持简单格式和扩展格式。角色成员关系是增量操作，不会移除未声明的现有角色。使用 <code>state: absent</code> 可以显式撤销角色。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单形式：授予角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 带 ADMIN OPTION（可以将此角色授予其他用户）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set: false }      # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>不允许 SET ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 撤销角色成员关系</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理用户参数</strong>：通过 <code>parameters</code> 字典配置用户级参数，会生成 <code>ALTER USER ... SET</code> 语句。使用特殊值 <code>DEFAULT</code> 可将参数重置为 PostgreSQL 默认值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>连接池配置</strong>：设置 <code>pgbouncer: true</code> 将用户添加到连接池，可选配置 <code>pool_mode</code>（池化模式：transaction/session/statement）和 <code>pool_connlimit</code>（用户最大连接数）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 添加到连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 池化模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 用户最大连接数</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=删除用户>删除用户</h2><p>要删除用户，将其 <code>state</code> 设置为 <code>absent</code> 并执行剧本：</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-05-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-05-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-05-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;user&gt;   <span style=color:#8f5902;font-style:italic># 删除用户 &lt;user&gt;（需在配置中设置 state: absent）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;user&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本删除用户</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_old    <span style=color:#8f5902;font-style:italic># 删除 dbuser_old 用户（配置中已设置 state: absent）</span>
</span></span></code></pre></div></div></div><p><strong>配置示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_old</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>删除操作会</strong>：使用 <code>pg-drop-role</code> 脚本安全删除用户，自动禁用用户登录并终止活跃连接，自动转移数据库/表空间所有权到 <code>postgres</code>，自动处理所有数据库中的对象所有权和权限，撤销所有角色成员关系，创建审计日志，从 Pgbouncer 用户列表中移除并重载配置。</p><p><strong>保护机制</strong>：以下系统用户无法删除，会被自动跳过：<code>postgres</code>（超级用户）、<code>replicator</code>（或 <a href=/docs/pgsql/param#pg_replication_username><strong><code>pg_replication_username</code></strong></a> 配置的用户）、<code>dbuser_dba</code>（或 <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a> 配置的用户）、<code>dbuser_monitor</code>（或 <a href=/docs/pgsql/param#pg_monitor_username><strong><code>pg_monitor_username</code></strong></a> 配置的用户）。</p><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>安全删除</div><p>Pigsty 使用 <code>pg-drop-role</code> 脚本安全删除用户，该脚本会自动处理用户拥有的数据库、表空间、Schema、表等对象，自动终止用户的活跃连接，将对象所有权转移给 <code>postgres</code> 用户，并在 <code>/tmp/pg_drop_role_&lt;user>_&lt;timestamp>.log</code> 创建审计日志。无需手动处理依赖对象。</p></div><hr><h2 id=手工删除用户>手工删除用户</h2><p>如果需要手动删除用户，可以直接使用 <code>pg-drop-role</code> 脚本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查依赖关系（只读操作）</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --check
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 预览删除操作（不实际执行）</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --dry-run -v
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 删除用户，转移对象给 postgres</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 强制删除（终止活跃连接）</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 删除用户，转移对象给指定用户</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old dbuser_new
</span></span></code></pre></div><hr><h2 id=常见用例>常见用例</h2><p>下面是一些常见的用户配置示例：</p><p><strong>创建基本业务用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>application user</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建只读用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建管理员用户（可执行 DDL）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建临时用户（30天后过期）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_contractor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>TempPassword</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建角色（不可登录，用于权限分组）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom_role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom role for special permissions</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建带高级角色选项的用户（PG16+）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_execute_server_program, inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=查询用户>查询用户</h2><p>以下是一些常用的 SQL 查询，用于查看用户信息：</p><p><strong>查看所有用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolsuper</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolinherit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolcreaterole</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolcreatedb</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>rolcanlogin</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolreplication</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolbypassrls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolconnlimit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_%&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看用户的角色成员关系</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>member</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>admin_option</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_option</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inherit_option</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_auth_members</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>roleid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbuser_app&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看用户级参数设置</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>setconfig</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_db_role_setting</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setrole</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setdatabase</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看即将过期的用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>time_remaining</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87>INTERVAL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30 days&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=连接池管理>连接池管理</h2><p>在用户定义中配置的 <a href=/docs/pgsql/config/user#pgbouncer><strong>连接池参数</strong></a> 会在创建/修改用户时应用到 Pgbouncer 连接池中。</p><p>设置 <code>pgbouncer: true</code> 的用户会被添加到 <code>/etc/pgbouncer/userlist.txt</code> 文件中。用户级别的连接池参数（<code>pool_mode</code>、<code>pool_connlimit</code>）通过 <code>/etc/pgbouncer/useropts.txt</code> 文件配置。</p><p>您可以使用 <code>postgres</code> 操作系统用户，使用 <code>pgb</code> 别名访问 Pgbouncer 管理数据库。更多连接池管理操作，请参考 <a href=/docs/pgsql/admin/pgbouncer><strong>Pgbouncer 管理</strong></a>。</p><hr><h2 id=管理默认用户密码>管理默认用户密码</h2><p>要修改普通用户的密码， 按照上面 <a href=#%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7><strong>修改用户</strong></a> 的说明，更新配置中的 <code>password</code> 字段并执行剧本即可。
不过修改 <strong>默认用户</strong> 的密码会稍微复杂一些，因为它们的密码还在多个地方被其他服务引用。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>默认值</th><th style=text-align:left>对应用户</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_admin_password><strong><code>pg_admin_password</code></strong></a></td><td style=text-align:left><code>DBUser.DBA</code></td><td style=text-align:left><code>dbuser_dba</code></td><td style=text-align:left>管理员用户密码</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_monitor_password><strong><code>pg_monitor_password</code></strong></a></td><td style=text-align:left><code>DBUser.Monitor</code></td><td style=text-align:left><code>dbuser_monitor</code></td><td style=text-align:left>监控用户密码</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_replication_password><strong><code>pg_replication_password</code></strong></a></td><td style=text-align:left><code>DBUser.Replicator</code></td><td style=text-align:left><code>replicator</code></td><td style=text-align:left>复制用户密码</td></tr></tbody></table><p>要修改 <a href=/docs/pgsql/param#pg_admin_password><strong><code>pg_admin_password</code></strong></a>，请执行以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 1: 修改配置文件中的密码 pg_admin_password 后（重要！），通过剧本批量修改密码</span>
</span></span><span style=display:flex><span>./pgsql-user.yml -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_dba -e <span style=color:#4e9a06>&#39;{&#34;pg_users&#34;:[{&#34;name&#34;:&#34;dbuser_dba&#34;,&#34;password&#34;:&#34;NewPass123&#34;}]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 2: 更新所有 PG 节点的 patroni 配置文件与 .pgpass，然后重载 patroni 配置</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_conf,pg_pass,patroni_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 3: 刷新 /infra/env/.pgpass 以及 /infra/conf/pg_service.conf 对管理员密码的引用</span>
</span></span><span style=display:flex><span>./infra.yml -t env_pgpass,env_pg_service
</span></span></code></pre></div><p>要修改 <a href=/docs/pgsql/param#pg_monitor_password><strong><code>pg_monitor_password</code></strong></a>，请执行以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 1: 修改配置文件中的密码 pg_monitor_password 后（重要！），通过剧本批量修改密码</span>
</span></span><span style=display:flex><span>./pgsql-user.yml -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_monitor -e <span style=color:#4e9a06>&#39;{&#34;pg_users&#34;:[{&#34;name&#34;:&#34;dbuser_monitor&#34;,&#34;password&#34;:&#34;NewPass123&#34;}]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 2: 更新所有 PG 节点的 patroni 配置文件与 .pgpass，然后重载 patroni 配置</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_conf,pg_pass,patroni_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 3: 刷新 pg_exporter 与 pgbouncer_exporter 配置里面使用的密码，更新 Grafana 监控面板中数据源使用的密码</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_exporter,pgbouncer_exporter,add_ds
</span></span></code></pre></div><p>要修改 <a href=/docs/pgsql/param#pg_replication_password><strong><code>pg_replication_password</code></strong></a>，请执行以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 1: 修改配置文件中的密码 pg_replication_password 后（重要！），通过剧本批量修改密码</span>
</span></span><span style=display:flex><span>./pgsql-user.yml -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>replicator -e <span style=color:#4e9a06>&#39;{&#34;pg_users&#34;:[{&#34;name&#34;:&#34;replicator&#34;,&#34;password&#34;:&#34;NewPass123&#34;}]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 2: 更新所有 PG 节点的 patorni 配置文件与 .pgpass，然后重载 patroni 配置</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_conf,pg_pass,patroni_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 3: 更新 Infra 节点的 .pgpass</span>
</span></span><span style=display:flex><span>./infra.yml -t env_pgpass
</span></span></code></pre></div><p>此外，Patroni 本身 RestAPI 的密码 <a href=/docs/pgsql/param#patroni_password><strong><code>patroni_password</code></strong></a> 可以通过以下命令进行修改：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 1: 刷新 patroni 配置文件里面配置的密码，并重载 patroni 配置应用生效</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_conf,patroni_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 2: 刷新 /infra/conf/patronictl.yml 对 patroni 密码的引用</span>
</span></span><span style=display:flex><span>./infra.yml -t env_patroni
</span></span></code></pre></div><blockquote><p>修改前三个密码前，需先用 SQL 修改对应 PostgreSQL 用户的密码：<code>ALTER USER &lt;username> PASSWORD '&lt;new_password>';</code></p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-9dd15cada3b5a59a9375eadbdeec7bf7>6.3 - 管理 PostgreSQL 业务数据库</h1><div class=lead>数据库管理：创建、修改、删除、重建数据库，使用模板克隆数据库</div><h2 id=快速上手>快速上手</h2><p>Pigsty 使用声明式管理方式，首先在 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中 <a href=/docs/pgsql/config/db><strong>定义数据库</strong></a>，然后使用 <code>bin/pgsql-db &lt;cls> &lt;dbname></code> 创建或修改数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>some_db }] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 在这里定义数据库列表！</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-00-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-00-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-00-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上创建/修改 &lt;dbname&gt; 数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l pg-meta -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>some_db    <span style=color:#8f5902;font-style:italic># 直接使用剧本在 &lt;cls&gt; 集群上创建/修改 &lt;dbname&gt; 数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta some_db    <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上创建/修改 some_db 数据库</span>
</span></span></code></pre></div></div></div><p>关于数据库定义参数的完整参考，请查阅 <a href=/docs/pgsql/config/db><strong>数据库配置</strong></a>。关于数据库的访问权限，请参考 <a href=/docs/concept/sec/ac/#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9A%94%E7%A6%BB><strong>ACL：数据库权限</strong></a>。</p><p>请注意，部分数据库参数仅能在 <strong>创建时</strong> 指定。修改这些参数需要先删除再创建数据库（使用 <code>state: recreate</code> 重建数据库）。</p><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93><strong>创建数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>创建新的业务数据库</td></tr><tr><td style=text-align:left><a href=#%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E5%BA%93><strong>修改数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>修改已存在数据库的属性</td></tr><tr><td style=text-align:left><a href=#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93><strong>删除数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>删除数据库（需设置 <code>state: absent</code>）</td></tr><tr><td style=text-align:left><a href=#%E9%87%8D%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93><strong>重建数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>先删再建（需设置 <code>state: recreate</code>）</td></tr><tr><td style=text-align:left><a href=#%E5%85%8B%E9%9A%86%E6%95%B0%E6%8D%AE%E5%BA%93><strong>克隆数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>使用模板克隆数据库</td></tr></tbody></table><div id=asciinema-cd66826a3d08fab10d21e9ac82d386f7 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-cd66826a3d08fab10d21e9ac82d386f7",o="/demo/pgsql-db.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=创建数据库>创建数据库</h2><p>定义在 <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> 里面的数据库会在 PostgreSQL <a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>集群创建</strong></a> 的时候在 <code>pg_db</code> 任务中自动创建。</p><p>要在现有的 PostgreSQL 集群上创建新的业务数据库，请将 <a href=/docs/pgsql/config/db><strong>数据库定义</strong></a> 添加到 <code>all.children.&lt;cls>.pg_databases</code>，然后执行：</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-02-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-02-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-02-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;   <span style=color:#8f5902;font-style:italic># 创建数据库 &lt;dbname&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;dbname&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本创建数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta myapp    <span style=color:#8f5902;font-style:italic># 例子，在 pg-meta 集群中创建 myapp 数据库</span>
</span></span></code></pre></div></div></div><p><strong>示例配置：创建名为 <code>myapp</code> 的业务数据库</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars.pg_databases: # 省略上级缩进</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>app]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_trgm }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>btree_gin }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>my application database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>执行效果</strong>：在主库上创建数据库 <code>myapp</code>，设置数据库所有者为 <code>dbuser_myapp</code>，创建 schema <code>app</code>，
启用扩展 <code>pg_trgm</code> 和 <code>btree_gin</code>，数据库将默认添加到 Pgbouncer 连接池，并注册为 Grafana PG 数据源。</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>建议使用剧本创建数据库</div><p>如果您需要手工创建数据库，那么需要自行确保 pgbouncer 连接池 / grafana 数据源同步。</p></div><hr><h2 id=修改数据库>修改数据库</h2><p>修改数据库与创建数据库使用相同的命令，在没有定义 <code>baseline</code> SQL 的情况下剧本是幂等的。</p><p>当目标数据库已存在时，Pigsty 会修改目标数据库的属性使其符合配置。然而，一些属性只能在数据库创建时设置。</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-04-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-04-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-04-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># 修改数据库 &lt;db&gt; 的属性</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># 幂等操作，可重复执行</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta myapp    <span style=color:#8f5902;font-style:italic># 修改 myapp 数据库的属性使其符合配置</span>
</span></span></code></pre></div></div></div><p><strong>不可修改的属性</strong>：以下属性在数据库创建后无法修改，需要使用 <code>state: recreate</code> 重建数据库：</p><ul><li><code>name</code>（数据库名称）、<code>template</code>（模板数据库）、<code>strategy</code>（克隆策略）。</li><li><code>encoding</code>（字符编码）、<code>locale</code>/<code>lc_collate</code>/<code>lc_ctype</code>（本地化设置）、<code>locale_provider</code>/<code>icu_locale</code>/<code>icu_rules</code>/<code>builtin_locale</code>（本地化提供者设置）</li></ul><p>其他属性均可修改，以下是一些常见的修改示例：</p><p><strong>修改属主</strong>：更新配置中的 <code>owner</code> 字段后执行剧本，会执行 <code>ALTER DATABASE ... OWNER TO</code> 并授予相应权限。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_new_owner    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 修改为新属主</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>修改连接限制</strong>：通过 <code>connlimit</code> 限制数据库的最大连接数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 限制最大 100 个连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>回收公共连接权限</strong>：设置 <code>revokeconn: true</code> 会回收 PUBLIC 的 CONNECT 权限，仅允许属主、DBA、监控用户和复制用户连接。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 回收 PUBLIC 的 CONNECT 权限</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理数据库参数</strong>：通过 <code>parameters</code> 字典配置数据库级参数，会生成 <code>ALTER DATABASE ... SET</code> 语句。使用特殊值 <code>DEFAULT</code> 可将参数重置为默认值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;512MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理模式（Schema）</strong>：通过 <code>schemas</code> 数组配置模式，支持简单格式和指定属主的完整格式。使用 <code>state: absent</code> 删除模式（CASCADE）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>app                                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单形式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: core, owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp }  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指定属主</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: deprecated, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 删除模式</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理扩展（Extension）</strong>：通过 <code>extensions</code> 数组配置扩展，支持简单格式和指定 schema/版本的完整格式。使用 <code>state: absent</code> 卸载扩展（CASCADE）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>postgis                                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单形式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: vector, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指定 schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_trgm, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 卸载扩展</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>CASCADE 警告</div><p>删除模式或卸载扩展使用 <code>CASCADE</code> 选项，会同时删除依赖该模式/扩展的所有对象。请确保理解影响范围后再执行删除操作。</p></div><p><strong>连接池配置</strong>：默认情况下所有业务数据库都会添加到 Pgbouncer 连接池。可配置 <code>pgbouncer</code>（是否加入连接池）、<code>pool_mode</code>（池化模式）、<code>pool_size</code>（默认池大小）、<code>pool_reserve</code>（保留连接数）、<code>pool_size_min</code>（最小池大小）、<code>pool_connlimit</code>（最大数据库连接）、<code>pool_auth_user</code>（认证查询用户）等参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 是否加入连接池（默认 true）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 池化模式：transaction/session/statement</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 默认池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 保留池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 最小池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 最大数据库连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 认证查询使用用户（配合 pgbouncer_auth_query）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>自 Pigsty <code>v4.1.0</code> 起，数据库连接池参数统一使用 <code>pool_reserve</code> 与 <code>pool_connlimit</code>，旧别名 <code>pool_size_reserve</code> / <code>pool_max_db_conn</code> 已收敛。</p></blockquote><hr><h2 id=删除数据库>删除数据库</h2><p>要删除数据库，将其 <code>state</code> 设置为 <code>absent</code> 并执行剧本：</p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-06-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-06-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-06-02-tab data-bs-toggle=tab data-bs-target=#tabs-06-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-06-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># 删除数据库 &lt;db&gt;（需在配置中设置 state: absent）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本删除数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-02 role=tabpanel aria-labelled-by=tabs-06-02-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta olddb    <span style=color:#8f5902;font-style:italic># 删除 olddb 数据库（配置中已设置 state: absent）</span>
</span></span></code></pre></div></div></div><p><strong>配置示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olddb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>删除操作会</strong>：如果数据库标记为 <code>is_template: true</code>，先执行 <code>ALTER DATABASE ... IS_TEMPLATE false</code>；使用 <code>DROP DATABASE ... WITH (FORCE)</code> 强制删除数据库（PG13+）并终止所有活动连接；从 Pgbouncer 连接池中移除该数据库；从 Grafana 数据源中取消注册。</p><p><strong>保护机制</strong>：系统数据库 <code>postgres</code>、<code>template0</code>、<code>template1</code> 无法删除。删除操作仅在主库上执行，流复制会自动同步到从库。</p><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>危险操作警告</div><p>删除数据库是<strong>不可逆</strong>操作，会永久删除该数据库中的所有数据。执行前请确保：已有最新的数据库备份、已确认没有业务在使用该数据库、已通知相关干系人。
Pigsty 不对任何因删除数据库导致的数据丢失承担责任，使用需自担风险。</p></div><hr><h2 id=重建数据库>重建数据库</h2><p><code>recreate</code> 状态用于重建数据库，等效于先删除再创建：</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-08-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-08-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-08-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># 重建数据库 &lt;db&gt;（需在配置中设置 state: recreate）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本重建数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta testdb    <span style=color:#8f5902;font-style:italic># 重建 testdb 数据库（配置中已设置 state: recreate）</span>
</span></span></code></pre></div></div></div><p><strong>配置示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>testdb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>recreate</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test_init.sql   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重建后执行初始化</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>适用场景</strong>：测试环境重置、清空开发数据库、修改不可变属性（编码、本地化等）、恢复数据库到初始状态。</p><p><strong>与手动 DROP + CREATE 的区别</strong>：单条命令完成，无需两次操作；自动保留 Pgbouncer 和 Grafana 配置；执行后自动加载 <code>baseline</code> 初始化脚本。</p><hr><h2 id=克隆数据库>克隆数据库</h2><p>你可以通过 PG 的 template 机制复制一个 PostgreSQL 数据库，在克隆期间，不允许有任何连接到模版数据库的活动连接。</p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-09-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-09-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-09-02-tab data-bs-toggle=tab data-bs-target=#tabs-09-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-09-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># 克隆数据库 &lt;db&gt;（需在配置中指定 template）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本克隆数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-02 role=tabpanel aria-labelled-by=tabs-09-02-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta meta_dev    <span style=color:#8f5902;font-style:italic># 克隆创建 meta_dev 数据库（配置中已指定 template: meta）</span>
</span></span></code></pre></div></div></div><p><strong>配置示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 源数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 以 meta 作为模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PG15+ 克隆策略，PG18 瞬间生效</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>瞬间克隆（PG18+）</strong>：如果使用 PostgreSQL 18 以上版本，Pigsty 默认设置了 <a href=https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-FILE-COPY-METHOD><strong><code>file_copy_method</code></strong></a>，配合 <code>strategy: FILE_COPY</code> 可以在约 200ms 内完成数据库克隆，而不需要复制数据文件。例如克隆一个 30 GB 的数据库，普通克隆用时 18 秒，瞬间克隆仅需 200 毫秒。</p><p><strong>手动克隆</strong>：确保清理掉所有连接到模版数据库的连接后执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_terminate_backend</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TEMPLATE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8> </span><span style=color:#000>STRATEGY</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>局限性与注意事项</strong>：瞬间克隆仅在支持的文件系统上可用（xfs，brtfs，zfs，apfs）；不要使用 <code>postgres</code> 数据库作为模版数据库进行克隆；在高并发环境中使用瞬间克隆需要谨慎，需在克隆窗口（200ms）内清理掉所有连接到模版数据库的连接。</p><hr><h2 id=连接池管理>连接池管理</h2><p>在数据库定义中配置的 <a href=/docs/pgsql/config/db#%E8%BF%9E%E6%8E%A5%E6%B1%A0><strong>连接池参数</strong></a> 会在创建/修改数据库时应用到 Pgbouncer 连接池中。</p><p>默认情况下所有业务数据库都会添加到 Pgbouncer 连接池（<code>pgbouncer: true</code>）。数据库会被添加到 <code>/etc/pgbouncer/database.txt</code> 文件中，数据库级别的连接池参数（<code>pool_auth_user</code>、<code>pool_mode</code>、<code>pool_size</code>、<code>pool_reserve</code>、<code>pool_size_min</code>、<code>pool_connlimit</code>）通过此文件配置。</p><p>您可以使用 <code>postgres</code> 操作系统用户，使用 <code>pgb</code> 别名访问 Pgbouncer 管理数据库。更多连接池管理操作，请参考 <a href=/docs/pgsql/admin/pgbouncer><strong>Pgbouncer 管理</strong></a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0cd896e3522e4cf2db0a08ece91619f5>6.4 - 管理 Patroni 高可用</h1><div class=lead>使用 Patroni 管理 PG 集群高可用，包括，修改参数，查看状态，主从切换，重启，重做从库等操作。</div><h2 id=概览>概览</h2><p>Pigsty 使用 Patroni 管理 PostgreSQL 集群，它可以用来修改集群配置，查看集群状态，执行主从切换，重启集群，重做从库等操作。</p><p>要使用 Patroni 进行管理，您需要有以下两种身份之一：</p><ul><li>从 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA 节点</strong></a> 上使用 <a href=/docs/deploy/admin><strong>管理员用户</strong></a> ，可以管理环境中的所有集群。</li><li>从 <a href=/docs/concept/arch/node#pgsql%E8%8A%82%E7%82%B9><strong>PGSQL节点</strong></a> 上使用 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> （默认为 <code>postgres</code>），可以管理当前集群。</li></ul><p>Patroni 提供了 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html><strong><code>patronictl</code></strong></a> 命令行工具用于管理，Pigsty 提供了封装的快捷命令 <code>pg</code> 来简化其操作。</p><details><summary>通过 pg 别名使用 patronictl</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg <span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>patroni_conf</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/infra/conf/patronictl.yml&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -r <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#000>patroni_conf</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/etc/patroni/patroni.yml&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -r <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;error: patronictl config not found&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> 1<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    patronictl -c <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$@</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></details><hr><h2 id=可用命令>可用命令</h2><table class=full-width><thead><tr><th>命令</th><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><a href=#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong><code>edit-config</code></strong></a></td><td>修改配置</td><td>交互式修改集群的 Patroni/PostgreSQL 配置</td></tr><tr><td><a href=#%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81><strong><code>list</code></strong></a></td><td>查看状态</td><td>列出集群成员及其状态</td></tr><tr><td><a href=#%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2><strong><code>switchover</code></strong></a></td><td>主动切换</td><td>将主库角色切换到指定从库（计划内维护）</td></tr><tr><td><a href=#%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2><strong><code>failover</code></strong></a></td><td>故障切换</td><td>强制故障转移到指定从库（紧急情况）</td></tr><tr><td><a href=#%E9%87%8D%E5%90%AF%E5%AE%9E%E4%BE%8B><strong><code>restart</code></strong></a></td><td>重启实例</td><td>重启 PostgreSQL 实例以应用需要重启的参数</td></tr><tr><td><a href=#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE><strong><code>reload</code></strong></a></td><td>重载配置</td><td>重载 Patroni 配置（无需重启）</td></tr><tr><td><a href=#%E9%87%8D%E5%81%9A%E4%BB%8E%E5%BA%93><strong><code>reinit</code></strong></a></td><td>重做从库</td><td>重新初始化从库（擦除数据并重新复制）</td></tr><tr><td><a href=#%E6%9A%82%E5%81%9C%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2><strong><code>pause</code></strong></a></td><td>暂停自动切换</td><td>暂停 Patroni 的自动故障转移功能</td></tr><tr><td><a href=#%E6%81%A2%E5%A4%8D%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2><strong><code>resume</code></strong></a></td><td>恢复自动切换</td><td>恢复 Patroni 的自动故障转移功能</td></tr><tr><td><a href=#%E6%9F%A5%E7%9C%8B%E5%8E%86%E5%8F%B2><strong><code>history</code></strong></a></td><td>查看历史</td><td>显示集群的故障转移历史记录</td></tr><tr><td><a href=#%E6%98%BE%E7%A4%BA%E9%85%8D%E7%BD%AE><strong><code>show-config</code></strong></a></td><td>显示配置</td><td>显示集群当前的配置（只读）</td></tr><tr><td><a href=#%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2><strong><code>query</code></strong></a></td><td>执行查询</td><td>在集群成员上执行 SQL 查询</td></tr><tr><td><a href=#%E6%9F%A5%E7%9C%8B%E6%8B%93%E6%89%91><strong><code>topology</code></strong></a></td><td>查看拓扑</td><td>显示集群的复制拓扑结构</td></tr><tr><td><a href=#%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC><strong><code>version</code></strong></a></td><td>查看版本</td><td>显示 Patroni 版本信息</td></tr><tr><td><a href=#%E7%A7%BB%E9%99%A4%E6%88%90%E5%91%98><strong><code>remove</code></strong></a></td><td>移除成员</td><td>从 DCS 中移除集群成员（危险操作）</td></tr></tbody></table><hr><h2 id=修改配置>修改配置</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-edit-config><strong><code>edit-config</code></strong></a> 子命令可以交互式修改集群的 Patroni 与 PostgreSQL 配置。该命令会打开一个编辑器，让您修改存储在 DCS（分布式配置存储）中的集群配置，修改后会自动应用到所有集群成员。您可以更改 Patroni 本身的参数（如 <code>ttl</code>、<code>loop_wait</code>、<code>synchronous_mode</code> 等），以及 <code>postgresql.parameters</code> 中的 PostgreSQL 参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># 交互式编辑集群配置</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; --force          <span style=color:#8f5902;font-style:italic># 跳过确认提示直接应用</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; -p &lt;k&gt;<span style=color:#ce5c00;font-weight:700>=</span>&lt;v&gt;       <span style=color:#8f5902;font-style:italic># 修改 PostgreSQL 参数（--pg 简写）</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; -s &lt;k&gt;<span style=color:#ce5c00;font-weight:700>=</span>&lt;v&gt;       <span style=color:#8f5902;font-style:italic># 修改 Patroni 参数（--set 简写）</span>
</span></span></code></pre></div><div id=asciinema-7f7700930ae8f7d432a1cae8fb8bc426 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-7f7700930ae8f7d432a1cae8fb8bc426",o="/demo/pgsql-config.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[7,"修改配置"],[9,"应用生效"],[11,"检验结果"],[13,"API修改"],[14,"API修改验证"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><p>以下是一些常见的配置修改示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 PostgreSQL 参数：慢查询阈值（会询问是否应用）</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 PostgreSQL 参数并跳过确认</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改多个 PostgreSQL 参数</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>work_mem</span><span style=color:#ce5c00;font-weight:700>=</span>256MB -p <span style=color:#000>maintenance_work_mem</span><span style=color:#ce5c00;font-weight:700>=</span>1GB --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 Patroni 参数：增大故障检测时间窗口（增大 RTO）</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>loop_wait</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>15</span> -s <span style=color:#000>ttl</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 Patroni 参数：启用同步复制模式</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>synchronous_mode</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 Patroni 参数：启用严格同步模式（至少一个同步从库才允许写入）</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>synchronous_mode_strict</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改需要重启的参数（修改后需执行 pg restart）</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>shared_buffers</span><span style=color:#ce5c00;font-weight:700>=</span>4GB --force
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements&#39;</span> --force
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>max_connections</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>200</span> --force
</span></span></code></pre></div><p>部分参数修改后需要重启 PostgreSQL 才能生效，您可以使用 <code>pg list</code> 检查集群状态，带 <code>*</code> 标记的实例表示需要重启。然后使用 <code>pg restart</code> 命令重启集群使配置生效。
您也可以使用 <code>curl</code> 或编写程序直接调用 Patroni 提供的 <a href=https://patroni.readthedocs.io/en/latest/rest_api.html><strong>REST API</strong></a> 来修改配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看当前配置</span>
</span></span><span style=display:flex><span>curl -s 10.10.10.11:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过 API 修改参数（需要认证）</span>
</span></span><span style=display:flex><span>curl -u <span style=color:#4e9a06>&#39;postgres:Patroni.API&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>     -d <span style=color:#4e9a06>&#39;{&#34;postgresql&#34;:{&#34;parameters&#34;: {&#34;log_min_duration_statement&#34;:200}}}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>     -s -X PATCH http://10.10.10.11:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span></code></pre></div><hr><h2 id=查看状态>查看状态</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-list><strong><code>list</code></strong></a> 子命令可以查看集群成员及其状态。输出结果会显示每个实例的名称、主机地址、角色、运行状态、时间线和复制延迟等信息。这是日常运维中最常用的命令之一，用于快速了解集群的健康状况。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list &lt;cls&gt;                         <span style=color:#8f5902;font-style:italic># 查看指定集群的状态</span>
</span></span><span style=display:flex><span>pg list                               <span style=color:#8f5902;font-style:italic># 列出所有集群（需要在管理节点上执行）</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -e                      <span style=color:#8f5902;font-style:italic># 显示扩展信息（--extended）</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -t                      <span style=color:#8f5902;font-style:italic># 显示时间戳（--timestamp）</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -f json                 <span style=color:#8f5902;font-style:italic># 以 JSON 格式输出（--format）</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -W <span style=color:#0000cf;font-weight:700>5</span>                    <span style=color:#8f5902;font-style:italic># 每 5 秒刷新一次（--watch）</span>
</span></span></code></pre></div><p>输出示例：</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) -----+----+--------------+
| Member    | Host        | Role    | State   | TL | Lag in MB    |
+-----------+-------------+---------+---------+----+--------------+
| pg-test-1 | 10.10.10.11 | Leader  | running |  1 |              |
| pg-test-2 | 10.10.10.12 | Replica | running |  1 |            0 |
| pg-test-3 | 10.10.10.13 | Replica | running |  1 |            0 |
+-----------+-------------+---------+---------+----+--------------+
</code></pre><p>输出列说明：<strong>Member</strong> 是实例名称，由 <code>pg_cluster</code>-<code>pg_seq</code> 组成；<strong>Host</strong> 是实例所在主机的 IP 地址；<strong>Role</strong> 表示角色，包括 Leader（主库）、Replica（从库）、Sync Standby（同步从库）、Standby Leader（级联复制的级联主库）等；<strong>State</strong> 表示运行状态，常见值包括 <code>running</code>（正常运行）、<code>streaming</code>（流复制中）、<code>in archive recovery</code>（归档恢复中）、<code>starting</code>（启动中）、<code>stopped</code>（已停止）等；<strong>TL</strong> 是时间线编号（Timeline），每次主从切换后会递增；<strong>Lag in MB</strong> 是复制延迟，以 MB 为单位，主库不显示此值。</p><p>如果某个实例需要重启才能应用配置更改，实例名称后会显示 <code>*</code> 标记：</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) -------+----+--------------+
| Member      | Host        | Role    | State   | TL | Lag in MB    |
+-------------+-------------+---------+---------+----+--------------+
| pg-test-1 * | 10.10.10.11 | Leader  | running |  1 |              |
| pg-test-2 * | 10.10.10.12 | Replica | running |  1 |            0 |
+-------------+-------------+---------+---------+----+--------------+
</code></pre><hr><h2 id=主动切换>主动切换</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-switchover><strong><code>switchover</code></strong></a> 子命令可以执行计划内的主从切换。Switchover 是一种优雅的切换方式：Patroni 会先确保从库完全同步，然后让主库降级为从库，最后提升目标从库为新主库。这个过程通常只需要几秒钟，期间会有短暂的写入不可用。适用于主库所在主机需要维护、升级、或者需要将主库迁移到性能更好的节点等场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg switchover &lt;cls&gt;                   <span style=color:#8f5902;font-style:italic># 交互式切换，会提示选择目标从库</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --leader &lt;old&gt;    <span style=color:#8f5902;font-style:italic># 指定当前主库名称</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --candidate &lt;new&gt; <span style=color:#8f5902;font-style:italic># 指定目标从库名称</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --scheduled &lt;time&gt; <span style=color:#8f5902;font-style:italic># 定时切换，格式如 2024-12-01T03:00</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --force           <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span></code></pre></div><p>执行切换前请确保所有从库复制状态正常（状态为 <code>running</code> 或 <code>streaming</code>），复制延迟在可接受范围内，并已通知相关业务方。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 交互式切换（推荐，会显示当前拓扑并提示选择）</span>
</span></span><span style=display:flex><span>$ pg switchover pg-test
</span></span><span style=display:flex><span>Current cluster topology
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -----+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span>Primary <span style=color:#ce5c00;font-weight:700>[</span>pg-test-1<span style=color:#ce5c00;font-weight:700>]</span>:
</span></span><span style=display:flex><span>Candidate <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;pg-test-2&#39;</span>, <span style=color:#4e9a06>&#39;pg-test-3&#39;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[]</span>: pg-test-2
</span></span><span style=display:flex><span>When should the switchover take place <span style=color:#ce5c00;font-weight:700>(</span>e.g. 2024-01-01T12:00<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>[</span>now<span style=color:#ce5c00;font-weight:700>]</span>:
</span></span><span style=display:flex><span>Are you sure you want to switchover cluster pg-test, demoting current leader pg-test-1? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 非交互式切换（指定主库和候选从库）</span>
</span></span><span style=display:flex><span>pg switchover pg-test --leader pg-test-1 --candidate pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 定时切换（在凌晨 3 点执行，适合维护窗口）</span>
</span></span><span style=display:flex><span>pg switchover pg-test --leader pg-test-1 --candidate pg-test-2 --scheduled <span style=color:#4e9a06>&#34;2024-12-01T03:00&#34;</span>
</span></span></code></pre></div><p>切换完成后，请使用 <code>pg list</code> 确认新的集群拓扑。</p><hr><h2 id=故障切换>故障切换</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-failover><strong><code>failover</code></strong></a> 子命令可以执行紧急故障切换。与 <code>switchover</code> 不同，<code>failover</code> 用于主库已经不可用的紧急情况。它会直接提升一个从库为新主库，而不等待原主库的确认。由于从库可能尚未完全同步所有数据，使用 <code>failover</code> 可能会导致少量数据丢失。因此，在非紧急情况下请优先使用 <code>switchover</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg failover &lt;cls&gt;                     <span style=color:#8f5902;font-style:italic># 交互式故障切换</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --leader &lt;old&gt;      <span style=color:#8f5902;font-style:italic># 指定原主库（用于验证，可选）</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --candidate &lt;new&gt;   <span style=color:#8f5902;font-style:italic># 指定要提升的从库</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --force             <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span></code></pre></div><p>故障切换示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 交互式故障切换</span>
</span></span><span style=display:flex><span>$ pg failover pg-test
</span></span><span style=display:flex><span>Candidate <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;pg-test-2&#39;</span>, <span style=color:#4e9a06>&#39;pg-test-3&#39;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[]</span>: pg-test-2
</span></span><span style=display:flex><span>Are you sure you want to failover cluster pg-test? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>Successfully failed over to <span style=color:#4e9a06>&#34;pg-test-2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 非交互式故障切换（紧急情况快速执行）</span>
</span></span><span style=display:flex><span>pg failover pg-test --candidate pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指定原主库进行验证（如果原主库名称不匹配会报错）</span>
</span></span><span style=display:flex><span>pg failover pg-test --leader pg-test-1 --candidate pg-test-2 --force
</span></span></code></pre></div><p><strong>Switchover 与 Failover 的区别</strong>：Switchover 用于计划内维护，要求原主库在线，执行前会确保数据完全同步，不会丢失数据；Failover 用于紧急故障恢复，原主库可以离线，会直接提升从库，可能丢失未同步的数据。日常维护、升级请使用 Switchover；只有在主库彻底故障无法恢复时才使用 Failover。</p><hr><h2 id=重启实例>重启实例</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-restart><strong><code>restart</code></strong></a> 子命令可以重启 PostgreSQL 实例，通常用于应用需要重启才能生效的参数更改。Patroni 会协调重启过程，对于整个集群的重启会采用滚动方式：先重启从库，最后重启主库，以最小化服务中断。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart &lt;cls&gt;                      <span style=color:#8f5902;font-style:italic># 重启整个集群的所有实例</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; &lt;member&gt;             <span style=color:#8f5902;font-style:italic># 重启指定实例</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --role leader        <span style=color:#8f5902;font-style:italic># 仅重启主库</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --role replica       <span style=color:#8f5902;font-style:italic># 仅重启所有从库</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --pending            <span style=color:#8f5902;font-style:italic># 仅重启标记为需要重启的实例</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --scheduled &lt;time&gt;   <span style=color:#8f5902;font-style:italic># 定时重启</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --timeout &lt;sec&gt;      <span style=color:#8f5902;font-style:italic># 设置重启超时时间（秒）</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --force              <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span></code></pre></div><p>当您修改了需要重启才能生效的参数（如 <code>shared_buffers</code>、<code>shared_preload_libraries</code>、<code>max_connections</code>、<code>max_worker_processes</code> 等）后，需要使用此命令重启实例。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看哪些实例需要重启（名称后带 * 标记）</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 * <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 * <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重启单个从库实例</span>
</span></span><span style=display:flex><span>pg restart pg-test pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重启整个集群（滚动重启，先从库后主库）</span>
</span></span><span style=display:flex><span>pg restart pg-test --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 仅重启需要重启的实例</span>
</span></span><span style=display:flex><span>pg restart pg-test --pending --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 仅重启所有从库</span>
</span></span><span style=display:flex><span>pg restart pg-test --role replica --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 定时重启（在维护窗口执行）</span>
</span></span><span style=display:flex><span>pg restart pg-test --scheduled <span style=color:#4e9a06>&#34;2024-12-01T03:00&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 设置重启超时时间为 300 秒</span>
</span></span><span style=display:flex><span>pg restart pg-test --timeout <span style=color:#0000cf;font-weight:700>300</span> --force
</span></span></code></pre></div><hr><h2 id=重载配置>重载配置</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-reload><strong><code>reload</code></strong></a> 子命令可以重载 Patroni 配置，无需重启 PostgreSQL。该命令会让 Patroni 重新读取配置文件，并将不需要重启的参数变更应用到 PostgreSQL（通过 <code>pg_reload_conf()</code>）。相比 <code>restart</code>，<code>reload</code> 更加轻量，不会中断数据库连接和正在执行的查询。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg reload &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># 重载整个集群的配置</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; &lt;member&gt;              <span style=color:#8f5902;font-style:italic># 重载指定实例的配置</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --role leader         <span style=color:#8f5902;font-style:italic># 仅重载主库</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --role replica        <span style=color:#8f5902;font-style:italic># 仅重载所有从库</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --force               <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span></code></pre></div><p>大多数 PostgreSQL 参数可以通过 <code>reload</code> 生效，只有少数参数（位于 postmaster 上下文的参数，例如 <code>shared_buffers</code>、<code>max_connections</code>、<code>shared_preload_libraries</code>，<code>archive_mode</code> 等）需要重启 PostgreSQL 才能生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重载整个集群</span>
</span></span><span style=display:flex><span>pg reload pg-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重载单个实例</span>
</span></span><span style=display:flex><span>pg reload pg-test pg-test-1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 强制重载，跳过确认</span>
</span></span><span style=display:flex><span>pg reload pg-test --force
</span></span></code></pre></div><hr><h2 id=重做从库>重做从库</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-reinit><strong><code>reinit</code></strong></a> 子命令可以重新初始化从库。该操作会删除从库上的所有数据，然后从主库重新执行 <code>pg_basebackup</code> 进行完整的数据复制。适用于从库数据损坏无法修复、从库落后太多导致 WAL 已被清理无法追赶、或从库配置错误需要重置等场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt;              <span style=color:#8f5902;font-style:italic># 重新初始化指定从库</span>
</span></span><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt; --force      <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt; --wait       <span style=color:#8f5902;font-style:italic># 等待重建完成后再返回</span>
</span></span></code></pre></div><blockquote><p>⚠️ <strong>警告</strong>：此操作会删除目标实例的所有数据！只能对从库执行，不能对主库执行。</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重新初始化从库（会提示确认）</span>
</span></span><span style=display:flex><span>$ pg reinit pg-test pg-test-2
</span></span><span style=display:flex><span>Are you sure you want to reinitialize members pg-test-2? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>Success: reinitialize <span style=color:#204a87;font-weight:700>for</span> member pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 强制重新初始化，跳过确认</span>
</span></span><span style=display:flex><span>pg reinit pg-test pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重新初始化并等待完成</span>
</span></span><span style=display:flex><span>pg reinit pg-test pg-test-2 --force --wait
</span></span></code></pre></div><p>重建过程中，可以使用 <code>pg list</code> 查看进度。从库状态会显示为 <code>creating replica</code>：</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) --------------+----+------+
| Member    | Host        | Role    | State            | TL | Lag  |
+-----------+-------------+---------+------------------+----+------+
| pg-test-1 | 10.10.10.11 | Leader  | running          |  2 |      |
| pg-test-2 | 10.10.10.12 | Replica | creating replica |    |    ? |
+-----------+-------------+---------+------------------+----+------+
</code></pre><hr><h2 id=暂停自动切换>暂停自动切换</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-pause><strong><code>pause</code></strong></a> 子命令可以暂停 Patroni 的自动故障转移功能。暂停后，即使主库故障，Patroni 也不会自动提升从库为新主库。适用于计划内维护窗口（避免维护操作误触发切换）、调试问题时防止集群状态变化、或需要手动控制切换时机等场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg pause &lt;cls&gt;                        <span style=color:#8f5902;font-style:italic># 暂停自动故障转移</span>
</span></span><span style=display:flex><span>pg pause &lt;cls&gt; --wait                 <span style=color:#8f5902;font-style:italic># 暂停并等待所有成员确认</span>
</span></span></code></pre></div><blockquote><p>⚠️ <strong>警告</strong>：暂停期间如果主库故障，集群将不会自动恢复！请确保在维护完成后及时使用 <code>resume</code> 恢复。</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 暂停自动切换</span>
</span></span><span style=display:flex><span>$ pg pause pg-test
</span></span><span style=display:flex><span>Success: cluster management is paused
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看集群状态（底部会显示 Maintenance mode: on）</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -----+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span> Maintenance mode: on
</span></span></code></pre></div><hr><h2 id=恢复自动切换>恢复自动切换</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-resume><strong><code>resume</code></strong></a> 子命令可以恢复 Patroni 的自动故障转移功能。维护完成后应立即执行此命令，以确保集群在主库故障时能够自动恢复。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># 恢复自动故障转移</span>
</span></span><span style=display:flex><span>pg resume &lt;cls&gt; --wait                <span style=color:#8f5902;font-style:italic># 恢复并等待所有成员确认</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复自动切换</span>
</span></span><span style=display:flex><span>$ pg resume pg-test
</span></span><span style=display:flex><span>Success: cluster management is resumed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 确认已恢复（Maintenance mode 提示消失）</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span></code></pre></div><hr><h2 id=查看历史>查看历史</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-history><strong><code>history</code></strong></a> 子命令可以查看集群的故障转移历史记录。每次主从切换（无论是自动故障转移还是手动切换）都会生成一条新的时间线记录。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt;                      <span style=color:#8f5902;font-style:italic># 显示故障转移历史</span>
</span></span><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt; -f json              <span style=color:#8f5902;font-style:italic># 以 JSON 格式输出</span>
</span></span><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt; -f yaml              <span style=color:#8f5902;font-style:italic># 以 YAML 格式输出</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg <span style=color:#204a87>history</span> pg-test
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span>       LSN <span style=color:#000;font-weight:700>|</span> Reason                       <span style=color:#000;font-weight:700>|</span> Timestamp                 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 0/5000060 <span style=color:#000;font-weight:700>|</span> no recovery target specified <span style=color:#000;font-weight:700>|</span> 2024-01-15T10:30:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 0/6000000 <span style=color:#000;font-weight:700>|</span> switchover to pg-test-2      <span style=color:#000;font-weight:700>|</span> 2024-01-20T14:00:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span> 0/7000028 <span style=color:#000;font-weight:700>|</span> failover to pg-test-1        <span style=color:#000;font-weight:700>|</span> 2024-01-25T09:15:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span></code></pre></div><p>输出列说明：<strong>TL</strong> 是时间线编号（Timeline），每次切换后递增，用于区分不同的主库历史；<strong>LSN</strong> 是切换时的日志序列号（Log Sequence Number），标识切换发生时的 WAL 位置；<strong>Reason</strong> 是切换原因，可能是 <code>switchover to xxx</code>（手动切换）、<code>failover to xxx</code>（故障转移）或 <code>no recovery target specified</code>（初始化）；<strong>Timestamp</strong> 是切换发生的时间戳。</p><hr><h2 id=显示配置>显示配置</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-show-config><strong><code>show-config</code></strong></a> 子命令可以查看集群当前存储在 DCS 中的配置。这是一个只读操作，如需修改配置请使用 <code>edit-config</code> 命令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg show-config &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># 显示集群配置</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg show-config pg-test
</span></span><span style=display:flex><span>loop_wait: <span style=color:#0000cf;font-weight:700>10</span>
</span></span><span style=display:flex><span>maximum_lag_on_failover: <span style=color:#0000cf;font-weight:700>1048576</span>
</span></span><span style=display:flex><span>postgresql:
</span></span><span style=display:flex><span>  parameters:
</span></span><span style=display:flex><span>    archive_command: pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-test archive-push %p
</span></span><span style=display:flex><span>    max_connections: <span style=color:#0000cf;font-weight:700>100</span>
</span></span><span style=display:flex><span>    shared_buffers: 256MB
</span></span><span style=display:flex><span>    log_min_duration_statement: <span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>  use_pg_rewind: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>  use_slots: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>retry_timeout: <span style=color:#0000cf;font-weight:700>10</span>
</span></span><span style=display:flex><span>ttl: <span style=color:#0000cf;font-weight:700>30</span>
</span></span><span style=display:flex><span>synchronous_mode: <span style=color:#204a87>false</span>
</span></span></code></pre></div><hr><h2 id=执行查询>执行查询</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-query><strong><code>query</code></strong></a> 子命令可以在集群成员上快速执行 SQL 查询。这是一个方便的调试工具，适合快速检查集群状态或执行简单查询。生产环境中的复杂查询建议使用 <code>psql</code> 或应用程序连接。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span>             <span style=color:#8f5902;font-style:italic># 在主库上执行查询</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -m &lt;member&gt; <span style=color:#8f5902;font-style:italic># 在指定实例上执行（--member）</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -r leader   <span style=color:#8f5902;font-style:italic># 在主库上执行（--role）</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -r replica  <span style=color:#8f5902;font-style:italic># 在所有从库上执行</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -f &lt;file&gt;              <span style=color:#8f5902;font-style:italic># 从文件读取 SQL 执行</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -U &lt;user&gt;   <span style=color:#8f5902;font-style:italic># 指定用户名（--username）</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -d &lt;db&gt;     <span style=color:#8f5902;font-style:italic># 指定数据库（--dbname）</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> --format json  <span style=color:#8f5902;font-style:italic># 以 JSON 格式输出</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看主库当前连接数</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT count(*) FROM pg_stat_activity&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看 PostgreSQL 版本</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT version()&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在所有从库上查看复制状态</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT pg_is_in_recovery(), pg_last_wal_replay_lsn()&#34;</span> -r replica
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在指定实例上执行</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT pg_is_in_recovery()&#34;</span> -m pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用指定用户和数据库</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT current_user, current_database()&#34;</span> -U postgres -d postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 以 JSON 格式输出结果</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT * FROM pg_stat_replication&#34;</span> --format json
</span></span></code></pre></div><hr><h2 id=查看拓扑>查看拓扑</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-topology><strong><code>topology</code></strong></a> 子命令可以以树形结构查看集群的复制拓扑。与 <code>list</code> 相比，<code>topology</code> 更直观地展示了主从复制关系，特别适合级联复制（Cascading Replication）场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg topology &lt;cls&gt;                     <span style=color:#8f5902;font-style:italic># 显示复制拓扑</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg topology pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1   <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> + pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> + pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span></code></pre></div><p>在级联复制场景中，拓扑图会清晰展示复制链路层级，例如 <code>pg-test-3</code> 从 <code>pg-test-2</code> 复制，而 <code>pg-test-2</code> 从主库 <code>pg-test-1</code> 复制。</p><hr><h2 id=查看版本>查看版本</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-version><strong><code>version</code></strong></a> 子命令可以查看 patronictl 的版本信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg version                            <span style=color:#8f5902;font-style:italic># 显示 patronictl 版本</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg version
</span></span><span style=display:flex><span>patronictl version 4.1.0
</span></span></code></pre></div><hr><h2 id=移除成员>移除成员</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-remove><strong><code>remove</code></strong></a> 子命令可以从 DCS（分布式配置存储）中移除集群或成员的元数据。这是一个危险操作，仅移除 DCS 中的元数据，不会停止 PostgreSQL 服务或删除数据文件。错误使用可能导致集群状态不一致。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg remove &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># 从 DCS 中移除整个集群的元数据</span>
</span></span></code></pre></div><p>通常情况下您不需要使用此命令。如需正确移除集群或实例，请使用 Pigsty 提供的 <a href=/docs/pgsql/admin/cluster#%E9%94%80%E6%AF%81%E9%9B%86%E7%BE%A4><strong><code>bin/pgsql-rm</code></strong></a> 脚本或 <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> 剧本。
只有在以下特殊情况下才考虑使用 <code>remove</code>：DCS 中存在孤立的元数据需要清理（例如节点已物理移除但元数据残留），或集群已通过其他方式销毁需要清理残留信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 移除整个集群的元数据（需要多次确认）</span>
</span></span><span style=display:flex><span>$ pg remove pg-test
</span></span><span style=display:flex><span>Please confirm the cluster name to remove: pg-test
</span></span><span style=display:flex><span>You are about to remove all information in DCS <span style=color:#204a87;font-weight:700>for</span> pg-test, please type: <span style=color:#4e9a06>&#34;Yes I am aware&#34;</span>: Yes I am aware
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-289eefb8da504803e0c1952004777bb0>6.5 - Pgbouncer 连接池管理</h1><div class=lead>使用 Pgbouncer 管理连接池，包括暂停、恢复、禁用、启用、重连、终止、重载等操作。</div><h2 id=概览>概览</h2><p>Pigsty 使用 <a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> 作为 PostgreSQL 的连接池中间件，默认监听 <code>6432</code> 端口，代理访问本机 <code>5432</code> 端口上的 PostgreSQL 实例。</p><p>这是一个 <strong>可选组件</strong>，如果您并没有海量链接，也不需要事务池化与查询监控指标，可以关闭连接池，直连数据库，或者保留但不使用。</p><hr><h2 id=用户与数据库管理>用户与数据库管理</h2><p>Pgbouncer 中的用户和数据库由 Pigsty 自动管理，并在 <a href=/docs/pgsql/admin/db><strong>创建数据库</strong></a> 与 <a href=/docs/pgsql/admin/user><strong>创建用户</strong></a> 时自动应用 <a href=/docs/pgsql/config/db><strong>数据库配置</strong></a> 与 <a href=/docs/pgsql/config/user><strong>用户配置</strong></a>。</p><p><strong>数据库管理</strong>：在 <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> 中定义的数据库，默认会自动添加到 Pgbouncer。设置 <a href=/docs/pgsql/admin/db#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%AE%A1%E7%90%86><strong><code>pgbouncer: false</code></strong></a> 可以排除特定数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mydb               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认加入连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，认证查询用户（配合 pgbouncer_auth_query）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 数据库级池化模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 默认池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 保留池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 最小池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 最大数据库连接数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 不加入连接池</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>用户管理</strong>：在 <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> 中定义的用户，需要显式设置 <a href=/docs/pgsql/admin/user#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%AE%A1%E7%90%86><strong><code>pgbouncer: true</code></strong></a> 才会加入连接池用户列表。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 加入连接池用户列表</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 用户级池化模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># 用户级最大连接数</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>自 Pigsty <code>v4.1.0</code> 起，数据库连接池参数统一使用 <code>pool_reserve</code> 与 <code>pool_connlimit</code>，旧别名 <code>pool_size_reserve</code> / <code>pool_max_db_conn</code> 已收敛。</p></blockquote><hr><h2 id=服务管理>服务管理</h2><p>在 Pigsty 中，PostgreSQL 集群的 <a href=/docs/pgsql/service#primary%E6%9C%8D%E5%8A%A1><strong>Primary 服务</strong></a> 与 Replica 服务默认指向 Pgbouncer 6432 端口，
如果您想要让这两个服务绕过连接池直接访问 PostgreSQL 实例，可以定制 <a href=/docs/pgsql/param#pg_services><strong><code>pg_services</code></strong></a>，或将将 <a href=/docs/pgsql/param#pg_default_service_dest><strong><code>pg_default_service_dest</code></strong></a> 设置为 <code>postgres</code>。</p><hr><h2 id=配置管理>配置管理</h2><p>Pgbouncer 的配置文件位于 <code>/etc/pgbouncer/</code> 目录，由 Pigsty 统一生成与管理：</p><table class=full-width><thead><tr><th>文件</th><th>说明</th></tr></thead><tbody><tr><td><code>pgbouncer.ini</code></td><td>主配置文件，连接池级别参数</td></tr><tr><td><code>database.txt</code></td><td>数据库列表，数据库级别参数</td></tr><tr><td><code>userlist.txt</code></td><td>用户密码列表</td></tr><tr><td><code>useropts.txt</code></td><td>用户级别的连接池参数</td></tr><tr><td><code>pgb_hba.conf</code></td><td>HBA 访问控制规则</td></tr></tbody></table><p>Pigsty 会自动管理 <code>database.txt</code> 和 <code>userlist.txt</code>，在 <a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93><strong>创建数据库</strong></a> 或 <a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7><strong>创建用户</strong></a> 时自动更新这些文件。</p><p>您也可以手动编辑配置文件后执行 <code>RELOAD</code> 使其生效：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 编辑配置</span>
</span></span><span style=display:flex><span>$ vim /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重载生效：通过 systemctl</span>
</span></span><span style=display:flex><span>$ sudo systemctl reload pgbouncer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重载生效，本身是 pg_dbsu / postgres 用户</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>
</span></span></code></pre></div><hr><h2 id=连接池管理>连接池管理</h2><p>Pgbouncer 使用和 PostgreSQL 相同的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户。Pigsty 提供了快捷命令 <code>pgb</code> 来简化管理操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>alias</span> <span style=color:#000>pgb</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;psql -p 6432 -d pgbouncer -U postgres&#34;</span>
</span></span></code></pre></div><p>您可以在数据库节点上使用 <code>pgb</code> 命令连接到 Pgbouncer 管理控制台，执行管理命令和监控查询。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW POOLS;</span>
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW CLIENTS;</span>
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW SERVERS;</span>
</span></span></code></pre></div><table class=full-width><thead><tr><th>命令</th><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><a href=#pause><strong><code>PAUSE</code></strong></a></td><td>暂停</td><td>暂停数据库连接，等待事务完成后断开服务端连接</td></tr><tr><td><a href=#resume><strong><code>RESUME</code></strong></a></td><td>恢复</td><td>恢复被 PAUSE/KILL/SUSPEND 暂停的数据库</td></tr><tr><td><a href=#disable><strong><code>DISABLE</code></strong></a></td><td>禁用</td><td>拒绝指定数据库的新客户端连接</td></tr><tr><td><a href=#enable><strong><code>ENABLE</code></strong></a></td><td>启用</td><td>允许指定数据库的新客户端连接</td></tr><tr><td><a href=#reconnect><strong><code>RECONNECT</code></strong></a></td><td>重连</td><td>优雅地关闭并重建服务端连接</td></tr><tr><td><a href=#kill><strong><code>KILL</code></strong></a></td><td>终止</td><td>立即断开指定数据库的所有客户端和服务端连接</td></tr><tr><td><a href=#kill_client><strong><code>KILL_CLIENT</code></strong></a></td><td>杀客户端</td><td>终止指定的客户端连接</td></tr><tr><td><a href=#suspend><strong><code>SUSPEND</code></strong></a></td><td>挂起</td><td>刷新缓冲区并停止监听，用于在线重启</td></tr><tr><td><a href=#shutdown><strong><code>SHUTDOWN</code></strong></a></td><td>关闭</td><td>关闭 Pgbouncer 进程</td></tr><tr><td><a href=#reload><strong><code>RELOAD</code></strong></a></td><td>重载</td><td>重新加载配置文件</td></tr><tr><td><a href=#wait_close><strong><code>WAIT_CLOSE</code></strong></a></td><td>等待关闭</td><td>等待 RECONNECT/RELOAD 后的服务端连接释放</td></tr><tr><td><a href=#%E7%9B%91%E6%8E%A7%E5%91%BD%E4%BB%A4><strong>监控命令</strong></a></td><td>监控</td><td>查看连接池状态、客户端、服务端等信息</td></tr></tbody></table><hr><h3 id=pause>PAUSE</h3><p>使用 <code>PAUSE</code> 命令暂停数据库连接。Pgbouncer 会根据池化模式等待活动事务/会话完成后断开服务端连接。新的客户端请求会被阻塞直到执行 <code>RESUME</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>PAUSE</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 暂停指定数据库，不指定则暂停所有数据库
</span></span></span></code></pre></div><p>典型使用场景：</p><ul><li>在线切换后端数据库（如主从切换后更新连接目标）</li><li>执行需要断开所有连接的维护操作</li><li>配合 <code>SUSPEND</code> 实现 Pgbouncer 在线重启</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;PAUSE mydb;&#34;</span>        <span style=color:#8f5902;font-style:italic># 暂停 mydb 数据库</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;PAUSE;&#34;</span>             <span style=color:#8f5902;font-style:italic># 暂停所有数据库</span>
</span></span></code></pre></div><p>暂停后，<code>SHOW DATABASES</code> 会显示 <code>paused</code> 状态：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=#</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>DATABASES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>   </span><span style=color:#000>name</span><span style=color:#f8f8f8>   </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8>    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>port</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>paused</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------+-----------+------+----------+-----+--------+----------
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8> </span><span style=color:#000>mydb</span><span style=color:#f8f8f8>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>run</span><span style=color:#f8f8f8>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>mydb</span><span style=color:#f8f8f8>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>      </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h3 id=resume>RESUME</h3><p>使用 <code>RESUME</code> 命令恢复被 <code>PAUSE</code>、<code>KILL</code> 或 <code>SUSPEND</code> 暂停的数据库，允许新的连接请求并恢复正常服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RESUME</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- 恢复指定数据库，不指定则恢复所有数据库
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RESUME mydb;&#34;</span>       <span style=color:#8f5902;font-style:italic># 恢复 mydb 数据库</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RESUME;&#34;</span>            <span style=color:#8f5902;font-style:italic># 恢复所有数据库</span>
</span></span></code></pre></div><hr><h3 id=disable>DISABLE</h3><p>使用 <code>DISABLE</code> 命令禁用指定数据库，拒绝所有新的客户端连接请求。已存在的连接不受影响。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>DISABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 禁用指定数据库（必须指定数据库名）
</span></span></span></code></pre></div><p>典型使用场景：</p><ul><li>临时下线某个数据库进行维护</li><li>阻止新连接以便安全地进行数据库迁移</li><li>逐步下线即将删除的数据库</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;DISABLE mydb;&#34;</span>      <span style=color:#8f5902;font-style:italic># 禁用 mydb，新连接被拒绝</span>
</span></span></code></pre></div><hr><h3 id=enable>ENABLE</h3><p>使用 <code>ENABLE</code> 命令启用之前被 <code>DISABLE</code> 禁用的数据库，重新接受新的客户端连接。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ENABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>-- 启用指定数据库（必须指定数据库名）
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;ENABLE mydb;&#34;</span>       <span style=color:#8f5902;font-style:italic># 启用 mydb，允许新连接</span>
</span></span></code></pre></div><hr><h3 id=reconnect>RECONNECT</h3><p>使用 <code>RECONNECT</code> 命令优雅地重建服务端连接。Pgbouncer 会在连接释放回池后关闭它们，并在需要时建立新连接。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RECONNECT</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- 重建指定数据库的服务端连接，不指定则重建所有
</span></span></span></code></pre></div><p>典型使用场景：</p><ul><li>后端数据库 IP 地址变更后刷新连接</li><li>主从切换后重新路由流量</li><li>DNS 更新后重建连接</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT mydb;&#34;</span>    <span style=color:#8f5902;font-style:italic># 重建 mydb 的服务端连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT;&#34;</span>         <span style=color:#8f5902;font-style:italic># 重建所有服务端连接</span>
</span></span></code></pre></div><p>执行 <code>RECONNECT</code> 后，可以使用 <code>WAIT_CLOSE</code> 等待旧连接完全释放。</p><hr><h3 id=kill>KILL</h3><p>使用 <code>KILL</code> 命令立即断开指定数据库的所有客户端和服务端连接。与 <code>PAUSE</code> 不同，<code>KILL</code> 不等待事务完成，直接强制断开。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>KILL</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>-- 终止指定数据库的所有连接，不指定则终止所有（admin 除外）
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL mydb;&#34;</span>         <span style=color:#8f5902;font-style:italic># 强制断开 mydb 的所有连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL;&#34;</span>              <span style=color:#8f5902;font-style:italic># 强制断开所有数据库的连接（admin 除外）</span>
</span></span></code></pre></div><p>执行 <code>KILL</code> 后，新连接会被阻塞直到执行 <code>RESUME</code>。</p><hr><h3 id=kill_client>KILL_CLIENT</h3><p>使用 <code>KILL_CLIENT</code> 命令终止指定的客户端连接。客户端 ID 可以从 <code>SHOW CLIENTS</code> 输出中获取。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>KILL_CLIENT</span><span style=color:#f8f8f8> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- 终止指定 ID 的客户端连接
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看客户端连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW CLIENTS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 终止特定客户端（假设 ptr 列显示的 ID 为 0x1234567890）</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL_CLIENT 0x1234567890;&#34;</span>
</span></span></code></pre></div><hr><h3 id=suspend>SUSPEND</h3><p>使用 <code>SUSPEND</code> 命令挂起 Pgbouncer。Pgbouncer 会刷新所有 socket 缓冲区并停止监听数据，直到执行 <code>RESUME</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SUSPEND</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- 挂起 Pgbouncer
</span></span></span></code></pre></div><p><code>SUSPEND</code> 主要用于实现 Pgbouncer 的在线重启（零停机升级）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 挂起当前 Pgbouncer</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SUSPEND;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 启动新的 Pgbouncer 进程（使用 -R 选项接管 socket）</span>
</span></span><span style=display:flex><span>$ pgbouncer -R /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 新进程接管后，旧进程自动退出</span>
</span></span></code></pre></div><hr><h3 id=shutdown>SHUTDOWN</h3><p>使用 <code>SHUTDOWN</code> 命令关闭 Pgbouncer 进程。支持多种关闭模式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic>-- 立即关闭
</span></span></span><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#f8f8f8> </span><span style=color:#000>WAIT_FOR_SERVERS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic>-- 等待服务端连接释放后关闭
</span></span></span><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#f8f8f8> </span><span style=color:#000>WAIT_FOR_CLIENTS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic>-- 等待客户端断开后关闭（零停机滚动重启）
</span></span></span></code></pre></div><table class=full-width><thead><tr><th>模式</th><th>说明</th></tr></thead><tbody><tr><td><code>SHUTDOWN</code></td><td>立即关闭 Pgbouncer 进程</td></tr><tr><td><code>WAIT_FOR_SERVERS</code></td><td>停止接受新连接，等待服务端连接释放后退出</td></tr><tr><td><code>WAIT_FOR_CLIENTS</code></td><td>停止接受新连接，等待所有客户端断开后退出，适用于滚动重启</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHUTDOWN WAIT_FOR_CLIENTS;&#34;</span>   <span style=color:#8f5902;font-style:italic># 优雅关闭，等待客户端断开</span>
</span></span></code></pre></div><hr><h3 id=reload>RELOAD</h3><p>使用 <code>RELOAD</code> 命令重新加载 Pgbouncer 配置文件。可以动态更新大部分配置参数，无需重启进程。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RELOAD</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic>-- 重载配置文件
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>              <span style=color:#8f5902;font-style:italic># 通过管理控制台重载</span>
</span></span><span style=display:flex><span>$ systemctl reload pgbouncer    <span style=color:#8f5902;font-style:italic># 通过 systemd 重载</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGHUP <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># 通过信号重载</span>
</span></span></code></pre></div><p>Pigsty 提供了重载 Pgbouncer 配置的剧本任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pgbouncer_reload    <span style=color:#8f5902;font-style:italic># 重载集群的 Pgbouncer 配置</span>
</span></span></code></pre></div><hr><h3 id=wait_close>WAIT_CLOSE</h3><p>使用 <code>WAIT_CLOSE</code> 命令等待服务端连接完成关闭。通常在 <code>RECONNECT</code> 或 <code>RELOAD</code> 后使用，确保旧连接已全部释放。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>WAIT_CLOSE</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- 等待指定数据库的服务端连接关闭，不指定则等待所有
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 完整的连接重建流程</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT mydb;&#34;</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;WAIT_CLOSE mydb;&#34;</span>    <span style=color:#8f5902;font-style:italic># 等待旧连接释放</span>
</span></span></code></pre></div><hr><h3 id=监控命令>监控命令</h3><p>Pgbouncer 提供了丰富的 <code>SHOW</code> 命令用于监控连接池状态：</p><table class=full-width><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td><code>SHOW HELP</code></td><td>显示可用命令帮助</td></tr><tr><td><code>SHOW DATABASES</code></td><td>显示数据库配置和状态</td></tr><tr><td><code>SHOW POOLS</code></td><td>显示连接池统计信息</td></tr><tr><td><code>SHOW CLIENTS</code></td><td>显示客户端连接列表</td></tr><tr><td><code>SHOW SERVERS</code></td><td>显示服务端连接列表</td></tr><tr><td><code>SHOW USERS</code></td><td>显示用户配置</td></tr><tr><td><code>SHOW STATS</code></td><td>显示统计信息（请求数、字节数等）</td></tr><tr><td><code>SHOW STATS_TOTALS</code></td><td>显示累计统计信息</td></tr><tr><td><code>SHOW STATS_AVERAGES</code></td><td>显示平均统计信息</td></tr><tr><td><code>SHOW CONFIG</code></td><td>显示当前配置参数</td></tr><tr><td><code>SHOW MEM</code></td><td>显示内存使用情况</td></tr><tr><td><code>SHOW DNS_HOSTS</code></td><td>显示 DNS 缓存的主机名</td></tr><tr><td><code>SHOW DNS_ZONES</code></td><td>显示 DNS 缓存的区域</td></tr><tr><td><code>SHOW SOCKETS</code></td><td>显示打开的 socket 信息</td></tr><tr><td><code>SHOW ACTIVE_SOCKETS</code></td><td>显示活动的 socket</td></tr><tr><td><code>SHOW LISTS</code></td><td>显示内部列表计数</td></tr><tr><td><code>SHOW FDS</code></td><td>显示文件描述符使用情况</td></tr><tr><td><code>SHOW STATE</code></td><td>显示 Pgbouncer 运行状态</td></tr><tr><td><code>SHOW VERSION</code></td><td>显示 Pgbouncer 版本</td></tr></tbody></table><p>常用监控示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看连接池状态</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW POOLS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看客户端连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW CLIENTS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看服务端连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW SERVERS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看统计信息</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW STATS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看数据库状态</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW DATABASES;&#34;</span>
</span></span></code></pre></div><p>更多监控命令的详细说明，请参考 <a href=https://www.pgbouncer.org/usage.html><strong>Pgbouncer 官方文档</strong></a>。</p><hr><h3 id=unix-信号>Unix 信号</h3><p>Pgbouncer 支持通过 Unix 信号进行控制，这在无法连接管理控制台时非常有用：</p><table class=full-width><thead><tr><th>信号</th><th>等效命令</th><th>说明</th></tr></thead><tbody><tr><td><code>SIGHUP</code></td><td><code>RELOAD</code></td><td>重载配置文件</td></tr><tr><td><code>SIGTERM</code></td><td><code>SHUTDOWN WAIT_FOR_CLIENTS</code></td><td>优雅关闭，等待客户端断开</td></tr><tr><td><code>SIGINT</code></td><td><code>SHUTDOWN WAIT_FOR_SERVERS</code></td><td>优雅关闭，等待服务端释放</td></tr><tr><td><code>SIGQUIT</code></td><td><code>SHUTDOWN</code></td><td>立即关闭</td></tr><tr><td><code>SIGUSR1</code></td><td><code>PAUSE</code></td><td>暂停所有数据库</td></tr><tr><td><code>SIGUSR2</code></td><td><code>RESUME</code></td><td>恢复所有数据库</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过信号重载配置</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGHUP <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过信号优雅关闭</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGTERM <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过信号暂停</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGUSR1 <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过信号恢复</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGUSR2 <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><hr><h2 id=流量切换>流量切换</h2><p>Pigsty 提供了 <code>pgb-route</code> 实用函数，可以将 Pgbouncer 流量快速切换至其他节点，用于零停机迁移：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 定义（已在 /etc/profile.d/pg-alias.sh 中）</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pgb-route<span style=color:#ce5c00;font-weight:700>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>local</span> <span style=color:#000>ip</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>1</span><span style=color:#000;font-weight:700>-</span><span style=color:#4e9a06>&#39;\/var\/run\/postgresql&#39;</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>  sed -ie <span style=color:#4e9a06>&#34;s/host=[^[:space:]]\+/host=</span><span style=color:#4e9a06>${</span><span style=color:#000>ip</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用：将流量路由到 10.10.10.12</span>
</span></span><span style=display:flex><span>$ pgb-route 10.10.10.12
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT; WAIT_CLOSE;&#34;</span>
</span></span></code></pre></div><p>完整的零停机切换流程：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 修改路由目标</span>
</span></span><span style=display:flex><span>$ pgb-route 10.10.10.12
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 重载配置</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 重建连接并等待旧连接释放</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT;&#34;</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;WAIT_CLOSE;&#34;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ef5d737e5bae0aa77e9e8e5340965fd9>6.6 - 管理 PostgreSQL 组件服务</h1><div class=lead>使用 systemctl 管理 PostgreSQL 集群中的各个组件服务：启动、停止、重启、重载与状态检查。</div><h2 id=概述>概述</h2><p>Pigsty 的 PGSQL 模块由多个组件构成，每个组件都以 systemd 服务的形式运行在节点上。（ <a href=/docs/concept/arch/pgsql#pgbackrest><strong>pgbackrest</strong></a> 除外）</p><p>了解这些组件及其管理方式，对于维护生产环境中的 PostgreSQL 集群非常重要。</p><table class=full-width><thead><tr><th style=text-align:left>组件</th><th style=text-align:left>端口</th><th style=text-align:left>服务名</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>Patroni</td><td style=text-align:left><strong><code>8008</code></strong></td><td style=text-align:left><code>patroni</code></td><td style=text-align:left>高可用管理器，负责 PostgreSQL 的生命周期管理</td></tr><tr><td style=text-align:left>PostgreSQL</td><td style=text-align:left><strong><code>5432</code></strong></td><td style=text-align:left><code>postgres</code></td><td style=text-align:left>占位服务，默认不使用，应急使用</td></tr><tr><td style=text-align:left>Pgbouncer</td><td style=text-align:left><strong><code>6432</code></strong></td><td style=text-align:left><code>pgbouncer</code></td><td style=text-align:left>连接池中间件，业务流量入口</td></tr><tr><td style=text-align:left>PgBackRest</td><td style=text-align:left>-</td><td style=text-align:left>-</td><td style=text-align:left>pgBackRest 没有守护服务</td></tr><tr><td style=text-align:left>HAProxy</td><td style=text-align:left><strong><code>543x</code></strong></td><td style=text-align:left><code>haproxy</code></td><td style=text-align:left>负载均衡器，暴露数据库服务</td></tr><tr><td style=text-align:left>pg_exporter</td><td style=text-align:left><strong><code>9630</code></strong></td><td style=text-align:left><code>pg_exporter</code></td><td style=text-align:left>PostgreSQL 监控指标导出器</td></tr><tr><td style=text-align:left>pgbouncer_exporter</td><td style=text-align:left><strong><code>9631</code></strong></td><td style=text-align:left><code>pgbouncer_exporter</code></td><td style=text-align:left>Pgbouncer 监控指标导出器</td></tr><tr><td style=text-align:left>vip-manager</td><td style=text-align:left>-</td><td style=text-align:left><code>vip-manager</code></td><td style=text-align:left>可选，管理 L2 VIP 地址漂移</td></tr></tbody></table><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>重要提示</div><p><strong>不要直接使用 systemctl 管理 PostgreSQL 服务</strong>。PostgreSQL 由 Patroni 托管，应通过 <a href=/docs/pgsql/admin/patroni><strong><code>patronictl</code></strong></a> 命令进行管理。
直接操作 PostgreSQL 可能导致 Patroni 状态不一致，触发意外的故障转移。<code>postgres</code> 服务是 Patroni 服务失效时的应急逃生窗口。</p></div><hr><h2 id=命令速查>命令速查</h2><table><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>命令</th></tr></thead><tbody><tr><td style=text-align:left>启动服务</td><td style=text-align:left><code>systemctl start &lt;service></code></td></tr><tr><td style=text-align:left>停止服务</td><td style=text-align:left><code>systemctl stop &lt;service></code></td></tr><tr><td style=text-align:left>重启服务</td><td style=text-align:left><code>systemctl restart &lt;service></code></td></tr><tr><td style=text-align:left>重载配置</td><td style=text-align:left><code>systemctl reload &lt;service></code></td></tr><tr><td style=text-align:left>查看状态</td><td style=text-align:left><code>systemctl status &lt;service></code></td></tr><tr><td style=text-align:left>查看日志</td><td style=text-align:left><code>journalctl -u &lt;service> -f</code></td></tr><tr><td style=text-align:left>开机启动</td><td style=text-align:left><code>systemctl enable &lt;service></code></td></tr><tr><td style=text-align:left>禁用启动</td><td style=text-align:left><code>systemctl disable &lt;service></code></td></tr></tbody></table><p>常用组件服务名：<code>patroni</code>、<code>pgbouncer</code>、<code>haproxy</code>、<code>pg_exporter</code>、<code>pgbouncer_exporter</code>、<code>vip-manager</code></p><hr><h2 id=patroni>Patroni</h2><p><a href=https://patroni.readthedocs.io/><strong>Patroni</strong></a> 是 PostgreSQL 的高可用管理器，负责 PostgreSQL 的启动、停止、故障检测与自动故障转移。
它是 PGSQL 模块的核心组件，PostgreSQL 进程由 Patroni 托管，不应直接通过 systemctl 管理 postgres 服务。</p><p><strong>启动 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start patroni     <span style=color:#8f5902;font-style:italic># 启动 Patroni（同时启动 PostgreSQL）</span>
</span></span></code></pre></div><p>启动 Patroni 后，它会自动拉起 PostgreSQL 进程。首次启动时，Patroni 会根据角色决定行为：</p><ul><li>主库：初始化或恢复数据目录</li><li>从库：从主库克隆数据并建立复制</li></ul><p><strong>停止 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop patroni      <span style=color:#8f5902;font-style:italic># 停止 Patroni（同时停止 PostgreSQL）</span>
</span></span></code></pre></div><p>停止 Patroni 时，它会优雅地关闭 PostgreSQL 进程。注意：如果这是主库，且未暂停自动切换，可能触发故障转移。</p><p><strong>重启 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni   <span style=color:#8f5902;font-style:italic># 重启 Patroni（同时重启 PostgreSQL）</span>
</span></span></code></pre></div><p>重启会导致短暂的服务中断。对于生产环境，建议使用 <code>pg restart</code> 命令进行滚动重启。</p><p><strong>重载 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload patroni    <span style=color:#8f5902;font-style:italic># 重载 Patroni 配置</span>
</span></span></code></pre></div><p>重载会让 Patroni 重新读取配置文件，并将可热加载的参数应用到 PostgreSQL。</p><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status patroni    <span style=color:#8f5902;font-style:italic># 查看 Patroni 服务状态</span>
</span></span><span style=display:flex><span>journalctl -u patroni -f    <span style=color:#8f5902;font-style:italic># 实时查看 Patroni 日志</span>
</span></span><span style=display:flex><span>journalctl -u patroni -n <span style=color:#0000cf;font-weight:700>100</span> --no-pager  <span style=color:#8f5902;font-style:italic># 查看最近 100 行日志</span>
</span></span></code></pre></div><p><strong>配置文件位置</strong>：<code>/etc/patroni/patroni.yml</code></p><blockquote><p><strong>最佳实践</strong>：使用 <a href=/docs/pgsql/admin/patroni><strong><code>patronictl</code></strong></a> 而非 systemctl 管理 PostgreSQL 集群。</p></blockquote><hr><h2 id=pgbouncer>Pgbouncer</h2><p><a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> 是轻量级的 PostgreSQL 连接池中间件。
业务流量通常通过 Pgbouncer（6432 端口）而非直接连接 PostgreSQL（5432 端口），以实现连接复用和保护数据库。</p><p><strong>启动 Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pgbouncer
</span></span></code></pre></div><p><strong>停止 Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pgbouncer
</span></span></code></pre></div><p>注意：停止 Pgbouncer 会中断所有通过连接池的业务连接。</p><p><strong>重启 Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart pgbouncer
</span></span></code></pre></div><p>重启会断开所有现有连接。如果只是配置变更，建议使用 <code>reload</code>。</p><p><strong>重载 Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload pgbouncer
</span></span></code></pre></div><p>重载会重新读取配置文件（用户列表、连接池参数等），不会断开现有连接。</p><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pgbouncer
</span></span><span style=display:flex><span>journalctl -u pgbouncer -f
</span></span></code></pre></div><p><strong>配置文件位置</strong>：</p><ul><li>主配置：<code>/etc/pgbouncer/pgbouncer.ini</code></li><li>HBA 规则：<code>/etc/pgbouncer/pgb_hba.conf</code></li><li>用户列表：<code>/etc/pgbouncer/userlist.txt</code></li><li>数据库列表：<code>/etc/pgbouncer/database.txt</code></li></ul><p><strong>管理控制台</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>6432</span> -U postgres -d pgbouncer  <span style=color:#8f5902;font-style:italic># 连接到 Pgbouncer 管理控制台</span>
</span></span></code></pre></div><p>常用管理命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>POOLS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- 查看连接池状态
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>CLIENTS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- 查看客户端连接
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>SERVERS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- 查看后端服务器连接
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>STATS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- 查看统计信息
</span></span></span><span style=display:flex><span><span style=color:#000>RELOAD</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- 重载配置
</span></span></span><span style=display:flex><span><span style=color:#000>PAUSE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 暂停所有连接池
</span></span></span><span style=display:flex><span><span style=color:#000>RESUME</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- 恢复所有连接池
</span></span></span></code></pre></div><hr><h2 id=haproxy>HAProxy</h2><p><a href=https://www.haproxy.org/><strong>HAProxy</strong></a> 是高性能的负载均衡器，负责将流量分发到正确的 PostgreSQL 实例。
Pigsty 使用 HAProxy 暴露 <a href=/docs/pgsql/service/><strong>服务</strong></a>，根据角色（主库/从库）和健康状态进行流量调度。</p><p><strong>启动 HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start haproxy
</span></span></code></pre></div><p><strong>停止 HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop haproxy
</span></span></code></pre></div><p>注意：停止 HAProxy 会中断所有通过负载均衡器的连接。</p><p><strong>重启 HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart haproxy
</span></span></code></pre></div><p><strong>重载 HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload haproxy
</span></span></code></pre></div><p>HAProxy 支持优雅重载，不会断开现有连接。配置变更后推荐使用 <code>reload</code>。</p><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status haproxy
</span></span><span style=display:flex><span>journalctl -u haproxy -f
</span></span></code></pre></div><p><strong>配置文件位置</strong>：<code>/etc/haproxy/haproxy.cfg</code></p><p><strong>管理界面</strong></p><p>HAProxy 提供 Web 管理界面，默认监听在 9101 端口：</p><pre tabindex=0><code>http://&lt;node_ip&gt;:9101/haproxy
</code></pre><p>默认认证：用户名 <code>admin</code>，密码由 <a href=/docs/node/param#haproxy_admin_password><strong><code>haproxy_admin_password</code></strong></a> 配置。</p><hr><h2 id=pg_exporter>pg_exporter</h2><p><a href=https://github.com/Vonng/pg_exporter><strong>pg_exporter</strong></a> 是 PostgreSQL 的 Prometheus 监控指标导出器，负责采集数据库性能指标。</p><p><strong>启动 pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pg_exporter
</span></span></code></pre></div><p><strong>停止 pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pg_exporter
</span></span></code></pre></div><p>停止后，Prometheus 将无法采集该实例的 PostgreSQL 监控指标。</p><p><strong>重启 pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart pg_exporter
</span></span></code></pre></div><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pg_exporter
</span></span><span style=display:flex><span>journalctl -u pg_exporter -f
</span></span></code></pre></div><p><strong>配置文件位置</strong>：<code>/etc/pg_exporter.yml</code></p><p><strong>验证指标采集</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s localhost:9630/metrics <span style=color:#000;font-weight:700>|</span> head -20
</span></span></code></pre></div><hr><h2 id=pgbouncer_exporter>pgbouncer_exporter</h2><p><strong>pgbouncer_exporter</strong> 是 Pgbouncer 的 Prometheus 监控指标导出器。</p><p><strong>启动/停止/重启</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pgbouncer_exporter
</span></span><span style=display:flex><span>systemctl stop pgbouncer_exporter
</span></span><span style=display:flex><span>systemctl restart pgbouncer_exporter
</span></span></code></pre></div><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pgbouncer_exporter
</span></span><span style=display:flex><span>journalctl -u pgbouncer_exporter -f
</span></span></code></pre></div><p><strong>验证指标采集</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s localhost:9631/metrics <span style=color:#000;font-weight:700>|</span> head -20
</span></span></code></pre></div><hr><h2 id=vip-manager>vip-manager</h2><p><a href=https://github.com/cybertec-postgresql/vip-manager><strong>vip-manager</strong></a> 是可选组件，用于管理 L2 VIP 地址漂移。
当启用 <a href=/docs/pgsql/param#pg_vip_enabled><strong><code>pg_vip_enabled</code></strong></a> 时，vip-manager 会将 VIP 绑定到当前主库节点。</p><p><strong>启动 vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start vip-manager
</span></span></code></pre></div><p><strong>停止 vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop vip-manager
</span></span></code></pre></div><p>停止后，VIP 地址会从当前节点释放。</p><p><strong>重启 vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart vip-manager
</span></span></code></pre></div><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status vip-manager
</span></span><span style=display:flex><span>journalctl -u vip-manager -f
</span></span></code></pre></div><p><strong>配置文件位置</strong>：<code>/etc/default/vip-manager</code></p><p><strong>验证 VIP 绑定</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip addr show           <span style=color:#8f5902;font-style:italic># 查看网络接口，检查 VIP 是否绑定</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt;          <span style=color:#8f5902;font-style:italic># 确认主库位置</span>
</span></span></code></pre></div><hr><h2 id=启动顺序与依赖>启动顺序与依赖</h2><p>PGSQL 模块组件的推荐启动顺序：</p><pre tabindex=0><code>1. patroni          # 首先启动 Patroni（会自动启动 PostgreSQL）
2. pgbouncer        # 然后启动连接池
3. haproxy          # 启动负载均衡器
4. pg_exporter      # 启动监控导出器
5. pgbouncer_exporter
6. vip-manager      # 最后启动 VIP 管理器（如果启用）
</code></pre><p>停止顺序应相反。Pigsty 剧本会自动处理这些依赖关系。</p><p><strong>批量启动所有服务</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start patroni pgbouncer haproxy pg_exporter pgbouncer_exporter
</span></span></code></pre></div><p><strong>批量停止所有服务</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pgbouncer_exporter pg_exporter haproxy pgbouncer patroni
</span></span></code></pre></div><hr><h2 id=常见故障排查>常见故障排查</h2><p><strong>服务启动失败</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status &lt;service&gt;        <span style=color:#8f5902;font-style:italic># 查看服务状态</span>
</span></span><span style=display:flex><span>journalctl -u &lt;service&gt; -n <span style=color:#0000cf;font-weight:700>50</span>     <span style=color:#8f5902;font-style:italic># 查看最近日志</span>
</span></span><span style=display:flex><span>journalctl -u &lt;service&gt; --since <span style=color:#4e9a06>&#34;5 min ago&#34;</span>  <span style=color:#8f5902;font-style:italic># 查看最近 5 分钟日志</span>
</span></span></code></pre></div><p><strong>Patroni 无法启动</strong></p><table><thead><tr><th style=text-align:left>现象</th><th style=text-align:left>可能原因</th><th style=text-align:left>解决方案</th></tr></thead><tbody><tr><td style=text-align:left>无法连接 etcd</td><td style=text-align:left>etcd 集群不可用</td><td style=text-align:left>检查 etcd 服务状态</td></tr><tr><td style=text-align:left>数据目录权限错误</td><td style=text-align:left>文件所有权不是 postgres</td><td style=text-align:left><code>chown -R postgres:postgres /pg/data</code></td></tr><tr><td style=text-align:left>端口被占用</td><td style=text-align:left>PostgreSQL 残留进程</td><td style=text-align:left><code>pg_ctl stop -D /pg/data</code> 或 <code>kill</code></td></tr></tbody></table><p><strong>Pgbouncer 无法启动</strong></p><table><thead><tr><th style=text-align:left>现象</th><th style=text-align:left>可能原因</th><th style=text-align:left>解决方案</th></tr></thead><tbody><tr><td style=text-align:left>配置文件语法错误</td><td style=text-align:left>INI 格式错误</td><td style=text-align:left>检查 <code>/etc/pgbouncer/pgbouncer.ini</code></td></tr><tr><td style=text-align:left>端口被占用</td><td style=text-align:left>6432 端口已被使用</td><td style=text-align:left><code>lsof -i :6432</code></td></tr><tr><td style=text-align:left>userlist.txt 权限</td><td style=text-align:left>文件权限不正确</td><td style=text-align:left><code>chmod 600 /etc/pgbouncer/userlist.txt</code></td></tr></tbody></table><p><strong>HAProxy 无法启动</strong></p><table><thead><tr><th style=text-align:left>现象</th><th style=text-align:left>可能原因</th><th style=text-align:left>解决方案</th></tr></thead><tbody><tr><td style=text-align:left>配置文件语法错误</td><td style=text-align:left>haproxy.cfg 格式错误</td><td style=text-align:left><code>haproxy -c -f /etc/haproxy/haproxy.cfg</code></td></tr><tr><td style=text-align:left>端口被占用</td><td style=text-align:left>服务端口冲突</td><td style=text-align:left><code>lsof -i :5433</code></td></tr></tbody></table><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni 管理</strong></a>：使用 patronictl 管理 PostgreSQL 高可用</li><li><a href=/docs/pgsql/admin/cluster/><strong>集群管理</strong></a>：集群的创建、扩缩容、销毁</li><li><a href=/docs/pgsql/service/><strong>服务配置</strong></a>：HAProxy 服务定义与配置</li><li><a href=/docs/pgsql/monitor/><strong>监控系统</strong></a>：PostgreSQL 监控与告警</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d6d9a4c3d54ca40e435a862870043f19>6.7 - 管理 PostgreSQL 定时任务</h1><div class=lead>配置 Crontab 定期调度 PostgreSQL 备份任务，执行备份 / Vacuum Freeze / Analyze 任务，以及处理表膨胀</div><p>Pigsty 使用 crontab 来管理定时任务，用于执行例行备份，冻结老化事务，重整膨胀表索引等维护工作。</p><h2 id=速查手册>速查手册</h2><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1><strong>配置定时任务</strong></a></td><td style=text-align:left><code>./pgsql.yml -t pg_crontab -l &lt;cls></code></td><td style=text-align:left>应用 pg_crontab 配置</td></tr><tr><td style=text-align:left><a href=#%E6%9F%A5%E7%9C%8B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1><strong>查看定时任务</strong></a></td><td style=text-align:left><code>crontab -l</code></td><td style=text-align:left>以 postgres 用户查看</td></tr><tr><td style=text-align:left><a href=#pg-backup><strong>物理备份</strong></a></td><td style=text-align:left><code>pg-backup [full|diff|incr]</code></td><td style=text-align:left>使用 pgBackRest 执行备份</td></tr><tr><td style=text-align:left><a href=#pg-vacuum><strong>事务冻结</strong></a></td><td style=text-align:left><code>pg-vacuum [database...]</code></td><td style=text-align:left>冻结老化事务，预防 XID 回卷</td></tr><tr><td style=text-align:left><a href=#pg-repack><strong>膨胀治理</strong></a></td><td style=text-align:left><code>pg-repack [database...]</code></td><td style=text-align:left>在线重整膨胀的表与索引</td></tr></tbody></table><p>其他管理任务，请参考：<a href=/docs/pgsql/backup/><strong>备份管理</strong></a>，<a href=/docs/pgsql/monitor/><strong>监控系统</strong></a>，<a href=/docs/pgsql/admin/patroni><strong>高可用管理</strong></a>。</p><hr><h2 id=配置定时任务>配置定时任务</h2><p>使用 <a href=/docs/pgsql/param/#pg_crontab><strong><code>pg_crontab</code></strong></a> 参数配置 PostgreSQL 数据库超级用户（<a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a>，默认 <code>postgres</code>）的定时任务。</p><p>下面 <code>pg-meta</code> 集群配置了每天凌晨1点进行全量备份的定时任务，<code>pg-test</code> 配置了每周一全量备份，其余日期增量备份的定时任务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>推荐的维护计划</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 每天凌晨1点全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 03 * * 0 /pg/bin/pg-vacuum&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 每周日凌晨3点执行 vacuum freeze</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 04 * * 1 /pg/bin/pg-repack&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 每周一凌晨4点执行 repack</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:left>任务</th><th style=text-align:left>频率</th><th style=text-align:left>时机</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>pg-backup</code></td><td style=text-align:left>每天</td><td style=text-align:left>凌晨</td><td style=text-align:left>全量或增量备份，视业务需求而定</td></tr><tr><td style=text-align:left><code>pg-vacuum</code></td><td style=text-align:left>每周一次</td><td style=text-align:left>周日凌晨</td><td style=text-align:left>冻结老化事务，预防 XID 回卷</td></tr><tr><td style=text-align:left><code>pg-repack</code></td><td style=text-align:left>每周/每月</td><td style=text-align:left>业务低峰期</td><td style=text-align:left>重整膨胀表索引，回收空间</td></tr></tbody></table><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>仅在主库执行</div><p><code>pg-backup</code>、<code>pg-vacuum</code>、<code>pg-repack</code> 脚本会自动检测当前节点角色，只有主库才会实际执行，从库会直接退出。</p><p>因此可以安全地在所有节点配置相同的定时任务，故障切换后新主库会自动继续执行维护任务。</p></div><hr><h2 id=应用定时任务>应用定时任务</h2><p>定时任务会在 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> 剧本执行时（<code>pg_crontab</code> 任务）自动写入对应操作系统发行版的默认位置：</p><ul><li>EL（RHEL/Rocky/Alma）：<code>/var/spool/cron/postgres</code></li><li>Debian/Ubuntu：<code>/var/spool/cron/crontabs/postgres</code></li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=剧本 aria-controls=tabs-01-00 aria-selected=true>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=手工 aria-controls=tabs-01-01 aria-selected=false>
手工</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_crontab     <span style=color:#8f5902;font-style:italic># 应用 pg_crontab 配置到指定集群</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.10 -t pg_crontab <span style=color:#8f5902;font-style:italic># 仅针对特定主机</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 以 postgres 用户编辑定时任务</span>
</span></span><span style=display:flex><span>sudo -u postgres crontab -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或直接编辑 crontab 文件</span>
</span></span><span style=display:flex><span>sudo vi /var/spool/cron/postgres           <span style=color:#8f5902;font-style:italic># EL 系列</span>
</span></span><span style=display:flex><span>sudo vi /var/spool/cron/crontabs/postgres  <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><p>每次执行剧本都会 <strong>全量覆盖刷新</strong> 定时任务配置。</p><hr><h2 id=查看定时任务>查看定时任务</h2><p>使用 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> 操作系统用户执行以下命令查看定时任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pigsty Managed Crontab for postgres</span>
</span></span><span style=display:flex><span><span style=color:#000>SHELL</span><span style=color:#ce5c00;font-weight:700>=</span>/bin/bash
</span></span><span style=display:flex><span><span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span>/usr/pgsql/bin:/pg/bin:/usr/local/bin:/usr/bin:/usr/sbin:/bin:/sbin
</span></span><span style=display:flex><span><span style=color:#000>MAILTO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>01</span> * * * /pg/bin/pg-backup
</span></span></code></pre></div><p>如果您不熟悉 Crontab 的语法，可以参考 <a href=https://crontab.guru/>Crontab Guru</a> 的解释。</p><hr><h2 id=pg-backup>pg-backup</h2><p><code>pg-backup</code> 是 Pigsty 提供的物理备份脚本，基于 <a href=https://pgbackrest.org/><strong>pgBackRest</strong></a> 实现，支持全量、差异、增量三种备份模式。</p><p><strong>基本用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup                <span style=color:#8f5902;font-style:italic># 执行增量备份（默认），如果没有全量备份则自动执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup full           <span style=color:#8f5902;font-style:italic># 执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup diff           <span style=color:#8f5902;font-style:italic># 执行差异备份（基于最近的全量备份）</span>
</span></span><span style=display:flex><span>pg-backup incr           <span style=color:#8f5902;font-style:italic># 执行增量备份（基于最近的任意备份）</span>
</span></span></code></pre></div><p><strong>备份类型说明</strong></p><table class=full-width><thead><tr><th style=text-align:left>类型</th><th style=text-align:left>参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>全量备份</td><td style=text-align:left><code>full</code></td><td style=text-align:left>完整备份所有数据，恢复时只需要该备份</td></tr><tr><td style=text-align:left>差异备份</td><td style=text-align:left><code>diff</code></td><td style=text-align:left>备份自上次全量备份以来的变更，恢复时需要全量+差异</td></tr><tr><td style=text-align:left>增量备份</td><td style=text-align:left><code>incr</code></td><td style=text-align:left>备份自上次任意备份以来的变更，恢复时需要完整链路</td></tr></tbody></table><p><strong>执行条件</strong></p><ul><li>脚本必须在 <strong>主库</strong> 上以 <strong>postgres</strong> 用户身份运行</li><li>脚本会自动检测当前节点角色，从库执行时会直接退出（exit 1）</li><li>从 <code>/etc/pgbackrest/pgbackrest.conf</code> 中自动获取 stanza 名称</li></ul><p><strong>常用定时任务配置</strong></p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=每日全量 aria-controls=tabs-02-00 aria-selected=true>
每日全量</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=周全量+日增量 aria-controls=tabs-02-01 aria-selected=false>
周全量+日增量</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=周全量+日差异 aria-controls=tabs-02-02 aria-selected=false>
周全量+日差异</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 每天凌晨1点全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 周一全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 其他日期增量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 周一全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup diff&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 其他日期差异备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p>更多备份恢复操作，请参考 <a href=/docs/pgsql/backup/><strong>备份管理</strong></a> 章节。</p><hr><h2 id=pg-vacuum>pg-vacuum</h2><p><code>pg-vacuum</code> 是 Pigsty 提供的事务冻结脚本，用于执行 <code>VACUUM FREEZE</code> 操作，防止事务ID（XID）回卷导致数据库停机。</p><p><strong>基本用法</strong></p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist=基本 aria-controls=tabs-03-00 aria-selected=true>
基本</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist=选项 aria-controls=tabs-03-01 aria-selected=false>
选项</button></li><li class=nav-item><button class=nav-link id=tabs-03-02-tab data-bs-toggle=tab data-bs-target=#tabs-03-02 role=tab data-td-tp-persist=手工sql aria-controls=tabs-03-02 aria-selected=false>
手工SQL</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-vacuum                    <span style=color:#8f5902;font-style:italic># 冻结所有数据库中的老化表</span>
</span></span><span style=display:flex><span>pg-vacuum mydb               <span style=color:#8f5902;font-style:italic># 仅处理指定数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-vacuum -n mydb            <span style=color:#8f5902;font-style:italic># 空跑模式，只显示不执行</span>
</span></span><span style=display:flex><span>pg-vacuum -a <span style=color:#0000cf;font-weight:700>80000000</span> mydb   <span style=color:#8f5902;font-style:italic># 使用自定义年龄阈值（默认1亿）</span>
</span></span><span style=display:flex><span>pg-vacuum -r <span style=color:#0000cf;font-weight:700>50</span> mydb         <span style=color:#8f5902;font-style:italic># 使用自定义老化比例阈值（默认40%）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-02 role=tabpanel aria-labelled-by=tabs-03-02-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对整个数据库执行 VACUUM FREEZE
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VACUUM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FREEZE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对特定表执行 VACUUM FREEZE
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VACUUM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FREEZE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p><strong>命令选项</strong></p><table class=full-width><thead><tr><th style=text-align:left>选项</th><th style=text-align:left>说明</th><th style=text-align:left>默认值</th></tr></thead><tbody><tr><td style=text-align:left><code>-h, --help</code></td><td style=text-align:left>显示帮助信息</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>-n, --dry-run</code></td><td style=text-align:left>空跑模式，只显示不执行</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-a, --age</code></td><td style=text-align:left>年龄阈值，超过此值的表需要冻结</td><td style=text-align:left>100000000</td></tr><tr><td style=text-align:left><code>-r, --ratio</code></td><td style=text-align:left>老化比例阈值，超过则全库冻结（%）</td><td style=text-align:left>40</td></tr></tbody></table><p><strong>工作逻辑</strong></p><ol><li>检查数据库的 <code>datfrozenxid</code> 年龄，如果低于阈值则跳过该库</li><li>计算老化页面比例（超过年龄阈值的表页面占总页面的百分比）</li><li>如果老化比例 > 40%，执行全库 <code>VACUUM FREEZE ANALYZE</code></li><li>否则，仅对超过年龄阈值的表执行 <code>VACUUM FREEZE ANALYZE</code></li></ol><p>脚本会设置 <code>vacuum_cost_limit = 10000</code> 和 <code>vacuum_cost_delay = 1ms</code> 以控制 I/O 影响。</p><p><strong>执行条件</strong></p><ul><li>脚本必须在 <strong>主库</strong> 上以 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> <strong>postgres</strong> 用户身份运行</li><li>使用文件锁 <code>/tmp/pg-vacuum.lock</code> 防止并发执行</li><li>自动跳过 <code>template0</code>、<code>template1</code>、<code>postgres</code> 系统数据库</li></ul><p><strong>常用定时任务配置</strong></p><p>建议将 vacuum 任务与备份/Repack 任务分开执行，避免冲突。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 03 * * 0 /pg/bin/pg-vacuum&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># 每周日凌晨3点执行</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=pg-repack>pg-repack</h2><p><code>pg-repack</code> 是 Pigsty 提供的膨胀治理脚本，基于 <a href=https://reorg.github.io/pg_repack/><strong>pg_repack</strong></a> 扩展实现，用于在线重整膨胀的表与索引。</p><p><strong>基本用法</strong></p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=基本 aria-controls=tabs-04-00 aria-selected=true>
基本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=选项 aria-controls=tabs-04-01 aria-selected=false>
选项</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=手工 aria-controls=tabs-04-02 aria-selected=false>
手工</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-repack                    <span style=color:#8f5902;font-style:italic># 重整所有数据库中的膨胀表与索引</span>
</span></span><span style=display:flex><span>pg-repack mydb               <span style=color:#8f5902;font-style:italic># 仅重整指定数据库</span>
</span></span><span style=display:flex><span>pg-repack mydb1 mydb2        <span style=color:#8f5902;font-style:italic># 重整多个数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-repack -n mydb            <span style=color:#8f5902;font-style:italic># 空跑模式，只显示不执行</span>
</span></span><span style=display:flex><span>pg-repack -t mydb            <span style=color:#8f5902;font-style:italic># 仅重整表</span>
</span></span><span style=display:flex><span>pg-repack -i mydb            <span style=color:#8f5902;font-style:italic># 仅重整索引</span>
</span></span><span style=display:flex><span>pg-repack -T <span style=color:#0000cf;font-weight:700>30</span> -j <span style=color:#0000cf;font-weight:700>4</span> mydb    <span style=color:#8f5902;font-style:italic># 自定义锁超时(秒)和并行度</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接使用 pg_repack 命令重整特定表</span>
</span></span><span style=display:flex><span>pg_repack dbname -t schema.table
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接使用 pg_repack 命令重整特定索引</span>
</span></span><span style=display:flex><span>pg_repack dbname -i schema.index
</span></span></code></pre></div></div></div><p><strong>命令选项</strong></p><table class=full-width><thead><tr><th style=text-align:left>选项</th><th style=text-align:left>说明</th><th style=text-align:left>默认值</th></tr></thead><tbody><tr><td style=text-align:left><code>-h, --help</code></td><td style=text-align:left>显示帮助信息</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>-n, --dry-run</code></td><td style=text-align:left>空跑模式，只显示不执行</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-t, --table</code></td><td style=text-align:left>仅重整表</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-i, --index</code></td><td style=text-align:left>仅重整索引</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-T, --timeout</code></td><td style=text-align:left>锁等待超时时间（秒）</td><td style=text-align:left>10</td></tr><tr><td style=text-align:left><code>-j, --jobs</code></td><td style=text-align:left>并行作业数</td><td style=text-align:left>2</td></tr></tbody></table><p><strong>自动选择阈值</strong></p><p>脚本会根据表和索引的大小与膨胀率，自动选择需要重整的对象：</p><p><strong>表膨胀阈值</strong></p><table class=full-width><thead><tr><th style=text-align:left>大小范围</th><th style=text-align:center>膨胀率阈值</th><th style=text-align:center>最大数量</th></tr></thead><tbody><tr><td style=text-align:left>&lt; 256MB</td><td style=text-align:center>> 40%</td><td style=text-align:center>64</td></tr><tr><td style=text-align:left>256MB - 2GB</td><td style=text-align:center>> 30%</td><td style=text-align:center>16</td></tr><tr><td style=text-align:left>2GB - 8GB</td><td style=text-align:center>> 20%</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>8GB - 64GB</td><td style=text-align:center>> 15%</td><td style=text-align:center>1</td></tr></tbody></table><p><strong>索引膨胀阈值</strong></p><table class=full-width><thead><tr><th style=text-align:left>大小范围</th><th style=text-align:center>膨胀率阈值</th><th style=text-align:center>最大数量</th></tr></thead><tbody><tr><td style=text-align:left>&lt; 128MB</td><td style=text-align:center>> 40%</td><td style=text-align:center>64</td></tr><tr><td style=text-align:left>128MB - 1GB</td><td style=text-align:center>> 35%</td><td style=text-align:center>16</td></tr><tr><td style=text-align:left>1GB - 8GB</td><td style=text-align:center>> 30%</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>8GB - 64GB</td><td style=text-align:center>> 20%</td><td style=text-align:center>1</td></tr></tbody></table><p>超过 64GB 的巨型表/索引会被跳过并给出提示，需要手动处理。</p><p><strong>执行条件</strong></p><ul><li>脚本必须在 <strong>主库</strong> 上以 <strong>postgres</strong> 用户身份运行</li><li>需要安装 <code>pg_repack</code> 扩展（Pigsty 默认安装）</li><li>需要 <code>monitor</code> schema 中的 <code>pg_table_bloat</code> 和 <code>pg_index_bloat</code> 视图</li><li>使用文件锁 <code>/tmp/pg-repack.lock</code> 防止并发执行</li><li>自动跳过 <code>template0</code>、<code>template1</code>、<code>postgres</code> 系统数据库</li></ul><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>锁等待</div><p>重整期间不会影响正常读写，但重整完毕的 <strong>切换瞬间</strong> 需要获取表上的 AccessExclusive 锁阻塞一切访问。对于高吞吐量业务，建议在业务低峰期或维护窗口进行。</p></div><p><strong>常用定时任务配置</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 04 * * 1 /pg/bin/pg-repack&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># 每周一凌晨4点执行</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您可以通过 Pigsty 的 <a href=https://demo.pigsty.cc/d/pgcat-database><strong>PGCAT Database - Table Bloat</strong></a> 面板确认数据库中的膨胀情况，并选择膨胀率较高的表与索引进行重整。</p><p>更多细节请参考：<a href=https://vonng.com/pg/bloat/><strong>关系膨胀的治理</strong></a></p><hr><h2 id=移除定时任务>移除定时任务</h2><p>当使用 <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> 剧本移除 PostgreSQL 集群时，会自动删除 postgres 用户的 crontab 文件。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt; -t pg_crontab    <span style=color:#8f5902;font-style:italic># 仅移除定时任务</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># 移除整个集群（包含定时任务）</span>
</span></span></code></pre></div><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/backup/><strong>备份管理</strong></a>：PostgreSQL 备份与恢复</li><li><a href=/docs/pgsql/monitor/><strong>监控系统</strong></a>：PostgreSQL 监控与告警</li><li><a href=/docs/pgsql/admin/cluster/><strong>集群管理</strong></a>：集群的创建、扩缩容、销毁</li><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni 管理</strong></a>：高可用集群管理</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fda28727166c3a3a755b7258c9071594>6.8 - 升级 PostgreSQL 大小版本</h1><div class=lead>版本升级：小版本滚动升级、大版本迁移、扩展升级</div><h2 id=快速上手>快速上手</h2><p>PostgreSQL 版本升级分为两种类型：<strong>小版本升级</strong> 和 <strong>大版本升级</strong>，两者的风险和复杂度差异很大。</p><table class=full-width><thead><tr><th style=text-align:left>类型</th><th style=text-align:left>示例</th><th style=text-align:left>停机时间</th><th style=text-align:left>数据兼容性</th><th style=text-align:left>风险等级</th></tr></thead><tbody><tr><td style=text-align:left>小版本升级</td><td style=text-align:left>17.2 → 17.3</td><td style=text-align:left>秒级（滚动重启）</td><td style=text-align:left>完全兼容</td><td style=text-align:left>低</td></tr><tr><td style=text-align:left>大版本升级</td><td style=text-align:left>17 → 18</td><td style=text-align:left>分钟级</td><td style=text-align:left>需要升级数据目录</td><td style=text-align:left>中</td></tr></tbody></table><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=小版本 aria-controls=tabs-00-00 aria-selected=true>
小版本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=大版本 aria-controls=tabs-00-01 aria-selected=false>
大版本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=扩展 aria-controls=tabs-00-02 aria-selected=false>
扩展</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 滚动升级：先从库后主库</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span><span style=display:flex><span>pg restart --role replica --force &lt;cls&gt;
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt;
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; &lt;old-primary&gt; --force
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 推荐：逻辑复制迁移</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-new              <span style=color:#8f5902;font-style:italic># 创建新版本集群</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 配置逻辑复制同步数据...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 切换流量到新集群</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgis36_17*&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER EXTENSION postgis UPDATE;&#39;</span>
</span></span></code></pre></div></div></div><p>关于在线迁移的详细流程，请参考 <a href=/docs/pgsql/migration><strong>在线迁移</strong></a> 文档。</p><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>说明</th><th style=text-align:left>风险</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E5%B0%8F%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7><strong>小版本升级</strong></a></td><td style=text-align:left>更新软件包，滚动重启</td><td style=text-align:left>低</td></tr><tr><td style=text-align:left><a href=#%E5%B0%8F%E7%89%88%E6%9C%AC%E9%99%8D%E7%BA%A7><strong>小版本降级</strong></a></td><td style=text-align:left>回退到之前的小版本</td><td style=text-align:left>低</td></tr><tr><td style=text-align:left><a href=#%E5%A4%A7%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7><strong>大版本升级</strong></a></td><td style=text-align:left>逻辑复制或 pg_upgrade</td><td style=text-align:left>中</td></tr><tr><td style=text-align:left><a href=#%E6%89%A9%E5%B1%95%E5%8D%87%E7%BA%A7><strong>扩展升级</strong></a></td><td style=text-align:left>升级扩展软件包和扩展对象</td><td style=text-align:left>低</td></tr></tbody></table><hr><h2 id=小版本升级>小版本升级</h2><p>小版本升级（如 17.2 → 17.3）是最常见的升级场景，通常用于应用安全补丁和 Bug 修复。数据目录完全兼容，通过滚动重启即可完成。</p><p><strong>升级策略</strong>：推荐采用 <strong>滚动升级</strong> 方式：先升级从库，再通过主从切换升级原主库，最小化服务中断。</p><pre tabindex=0><code>1. 更新软件仓库 → 2. 升级从库软件包 → 3. 重启从库
4. 主从切换 → 5. 升级原主库软件包 → 6. 重启原主库
</code></pre><p><strong>步骤一：准备软件包</strong></p><p>确保本地软件仓库中有最新版本的 PostgreSQL 包，并刷新节点缓存：</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=仓库 aria-controls=tabs-01-00 aria-selected=true>
仓库</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=el aria-controls=tabs-01-01 aria-selected=false>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=debian aria-controls=tabs-01-02 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty
</span></span><span style=display:flex><span>./infra.yml -t repo_upstream      <span style=color:#8f5902;font-style:italic># 添加上游仓库（需要互联网）</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build         <span style=color:#8f5902;font-style:italic># 重建本地仓库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum clean all&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum makecache&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt clean&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt update&#39;</span>
</span></span></code></pre></div></div></div><p><strong>步骤二：升级从库</strong></p><p>在所有从库上升级软件包并验证版本：</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=el aria-controls=tabs-02-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=debian aria-controls=tabs-02-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;/usr/pgsql/bin/pg_ctl --version&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;/usr/lib/postgresql/17/bin/pg_ctl --version&#39;</span>
</span></span></code></pre></div></div></div><p>重启所有从库以应用新版本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart --role replica --force &lt;cls&gt;
</span></span></code></pre></div><p><strong>步骤三：切换主库</strong></p><p>执行主从切换，将主库角色转移到已升级的从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg switchover &lt;cls&gt;
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或非交互式：</span>
</span></span><span style=display:flex><span>pg switchover --leader &lt;old-primary&gt; --candidate &lt;new-primary&gt; --scheduled<span style=color:#ce5c00;font-weight:700>=</span>now --force &lt;cls&gt;
</span></span></code></pre></div><p><strong>步骤四：升级原主库</strong></p><p>原主库现在已降级为从库，升级软件包并重启：</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist=el aria-controls=tabs-03-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist=debian aria-controls=tabs-03-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;old-primary-ip&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;old-primary-ip&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17&#39;</span>
</span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart &lt;cls&gt; &lt;old-primary-name&gt; --force
</span></span></code></pre></div><p><strong>步骤五：验证</strong></p><p>确认所有实例版本一致：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list &lt;cls&gt;
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;SELECT version()&#34;</span>
</span></span></code></pre></div><hr><h2 id=小版本降级>小版本降级</h2><p>在极少数情况下（如新版本引入 Bug），可能需要将 PostgreSQL 降级到之前的版本。</p><p><strong>步骤一：获取旧版本包</strong></p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=el aria-controls=tabs-04-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=刷新缓存 aria-controls=tabs-04-01 aria-selected=false>
刷新缓存</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span> ./infra.yml -t repo_upstream     <span style=color:#8f5902;font-style:italic># 添加上游仓库</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> /www/pigsty<span style=color:#000;font-weight:700>;</span> repotrack postgresql17-*-17.1 <span style=color:#8f5902;font-style:italic># 下载指定版本的包</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span> ./infra.yml -t repo_create       <span style=color:#8f5902;font-style:italic># 重建仓库元数据</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum clean all&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum makecache&#39;</span>
</span></span></code></pre></div></div></div><p><strong>步骤二：执行降级</strong></p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=el aria-controls=tabs-05-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=debian aria-controls=tabs-05-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum downgrade -y postgresql17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17=17.1*&#39;</span>
</span></span></code></pre></div></div></div><p><strong>步骤三：重启集群</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart --force &lt;cls&gt;
</span></span></code></pre></div><hr><h2 id=大版本升级>大版本升级</h2><p>大版本升级（如 17 → 18）涉及数据格式变更，需要使用专用工具进行数据迁移。</p><table class=full-width><thead><tr><th style=text-align:left>方式</th><th style=text-align:left>停机时间</th><th style=text-align:left>复杂度</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E9%80%BB%E8%BE%91%E5%A4%8D%E5%88%B6%E8%BF%81%E7%A7%BB><strong>逻辑复制迁移</strong></a></td><td style=text-align:left>秒级切换</td><td style=text-align:left>高</td><td style=text-align:left>生产环境，要求最小停机</td></tr><tr><td style=text-align:left><a href=#pg_upgrade-%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7><strong>pg_upgrade 原地升级</strong></a></td><td style=text-align:left>分钟~小时</td><td style=text-align:left>中</td><td style=text-align:left>测试环境，数据量较小</td></tr></tbody></table><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>推荐方案</div><p>对于生产环境，推荐使用 <strong>逻辑复制迁移</strong> 方式：创建新版本集群，通过逻辑复制同步数据，然后进行蓝绿切换。这种方式停机时间最短，且可以随时回滚。详见 <a href=/docs/pgsql/migration><strong>在线迁移</strong></a>。</p></div><h3 id=逻辑复制迁移>逻辑复制迁移</h3><p>逻辑复制迁移是生产环境大版本升级的推荐方式，核心步骤：</p><pre tabindex=0><code>1. 创建新版本目标集群 → 2. 配置逻辑复制同步数据 → 3. 验证数据一致性
4. 切换应用流量到新集群 → 5. 下线旧集群
</code></pre><p><strong>步骤一：创建新版本集群</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta-new</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-new</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 新版本</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-meta-new
</span></span></code></pre></div><p><strong>步骤二：配置逻辑复制</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 源集群（旧版本）主库：创建发布
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>PUBLICATION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_pub</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#000>TABLES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 目标集群（新版本）主库：创建订阅
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>SUBSCRIPTION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_sub</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;host=10.10.10.11 port=5432 dbname=mydb user=replicator password=xxx&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#000>PUBLICATION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_pub</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>步骤三：等待同步完成</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 目标集群：检查订阅状态
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_subscription</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 源集群：检查复制槽 LSN
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>slot_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>confirmed_flush_lsn</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_replication_slots</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>步骤四：切换流量</strong></p><p>确认数据同步完成后：停止应用写入源集群 → 等待最后的数据同步 → 切换应用连接到新集群 → 删除订阅，下线源集群。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 目标集群：删除订阅
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>SUBSCRIPTION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_sub</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>详细的迁移流程请参考 <a href=/docs/pgsql/migration><strong>在线迁移</strong></a> 文档。</p><h3 id=pg_upgrade-原地升级>pg_upgrade 原地升级</h3><p><code>pg_upgrade</code> 是 PostgreSQL 官方提供的大版本升级工具，适用于测试环境或可接受较长停机时间的场景。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>重要警告</div><p>原地升级会导致较长的停机时间，且回滚困难。生产环境请优先考虑逻辑复制迁移方式。</p></div><p><strong>步骤一：安装新版本软件包</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_pkg -e <span style=color:#000>pg_version</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>18</span>
</span></span></code></pre></div><p><strong>步骤二：停止 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg pause &lt;cls&gt;                        <span style=color:#8f5902;font-style:italic># 暂停自动故障转移</span>
</span></span><span style=display:flex><span>systemctl stop patroni                <span style=color:#8f5902;font-style:italic># 停止 Patroni（会停止 PostgreSQL）</span>
</span></span></code></pre></div><p><strong>步骤三：运行 pg_upgrade</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres
</span></span><span style=display:flex><span>mkdir -p /data/postgres/pg-meta-18/data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 预检（-c 参数只检查不执行）</span>
</span></span><span style=display:flex><span>/usr/pgsql-18/bin/pg_upgrade <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -b /usr/pgsql-17/bin -B /usr/pgsql-18/bin <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -d /data/postgres/pg-meta-17/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -D /data/postgres/pg-meta-18/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -v -c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 执行升级</span>
</span></span><span style=display:flex><span>/usr/pgsql-18/bin/pg_upgrade <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -b /usr/pgsql-17/bin -B /usr/pgsql-18/bin <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -d /data/postgres/pg-meta-17/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -D /data/postgres/pg-meta-18/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --link -j <span style=color:#0000cf;font-weight:700>8</span> -v
</span></span></code></pre></div><p><strong>步骤四：更新链接并启动</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf /usr/pgsql <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ln -s /usr/pgsql-18 /usr/pgsql
</span></span><span style=display:flex><span>rm -rf /pg <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ln -s /data/postgres/pg-meta-18 /pg
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 编辑 /etc/patroni/patroni.yml 更新路径</span>
</span></span><span style=display:flex><span>systemctl start patroni
</span></span><span style=display:flex><span>pg resume &lt;cls&gt;
</span></span></code></pre></div><p><strong>步骤五：后处理</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/pgsql-18/bin/vacuumdb --all --analyze-in-stages
</span></span><span style=display:flex><span>./delete_old_cluster.sh   <span style=color:#8f5902;font-style:italic># pg_upgrade 生成的清理脚本</span>
</span></span></code></pre></div><hr><h2 id=扩展升级>扩展升级</h2><p>升级 PostgreSQL 版本时，通常也需要升级相关扩展插件。</p><p><strong>升级扩展软件包</strong></p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=el aria-controls=tabs-08-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=debian aria-controls=tabs-08-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgis36_17 timescaledb-2-postgresql-17* pgvector_17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17-postgis-3 postgresql-17-pgvector&#39;</span>
</span></span></code></pre></div></div></div><p><strong>升级扩展版本</strong></p><p>软件包升级后，在数据库中执行扩展升级：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看可升级的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 升级扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 检查扩展版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>扩展兼容性</div><p>大版本升级前，请确认所有使用的扩展都支持目标 PostgreSQL 版本。某些扩展可能需要先卸载再重新安装，请查阅扩展文档。</p></div><hr><h2 id=注意事项>注意事项</h2><ol><li><strong>备份优先</strong>：任何升级操作前都应进行完整备份</li><li><strong>测试验证</strong>：先在测试环境验证升级流程</li><li><strong>扩展兼容</strong>：确认所有扩展支持目标版本</li><li><strong>回滚预案</strong>：准备好回滚方案，特别是大版本升级</li><li><strong>监控观察</strong>：升级后密切监控数据库性能和错误日志</li><li><strong>文档记录</strong>：记录升级过程中的所有操作和问题</li></ol><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/migration/><strong>在线迁移</strong></a>：使用逻辑复制进行零停机迁移</li><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni 管理</strong></a>：使用 patronictl 管理集群</li><li><a href=/docs/pgsql/admin/cluster/><strong>集群管理</strong></a>：集群的创建、扩缩容、销毁</li><li><a href=/docs/pgsql/backup/><strong>备份恢复</strong></a>：PostgreSQL 备份与恢复</li><li><a href=/docs/pgsql/admin/ext/><strong>扩展管理</strong></a>：扩展的安装与管理</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2b2e08d4aed2707846688f2a5517519d>6.9 - 管理 PostgreSQL 扩展插件</h1><div class=lead>扩展管理：下载、安装、配置、启用、更新、卸载扩展</div><h2 id=快速上手>快速上手</h2><p>Pigsty 提供 <a href=https://pgext.cloud/zh/list><strong>451 扩展</strong></a>，使用扩展涉及四个步骤：<strong>下载</strong>、<strong>安装</strong>、<strong>配置</strong>、<strong>启用</strong>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 安装扩展软件包</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- 配置预加载扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, vector ]           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 在数据库中启用</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-00-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-00-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-00-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上安装配置中定义的扩展</span>
</span></span><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ext...<span style=color:#ce5c00;font-weight:700>]</span>  <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上安装命令行参数给出的扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_ext    <span style=color:#8f5902;font-style:italic># 使用剧本安装扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta                         <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上安装定义的扩展</span>
</span></span><span style=display:flex><span>bin/pgsql-ext pg-meta pg_duckdb pg_mooncake   <span style=color:#8f5902;font-style:italic># 安装指定扩展</span>
</span></span></code></pre></div></div></div><p>关于扩展的完整参考，请查阅 <a href=/docs/pgsql/ext/><strong>扩展插件</strong></a> 章节。关于可用扩展列表，请参考 <a href=https://pgext.cloud/zh/list><strong>扩展目录</strong></a>。</p><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E4%B8%8B%E8%BD%BD%E6%89%A9%E5%B1%95><strong>下载扩展</strong></a></td><td style=text-align:left><code>./infra.yml -t repo_build</code></td><td style=text-align:left>将扩展下载到本地仓库</td></tr><tr><td style=text-align:left><a href=#%E5%AE%89%E8%A3%85%E6%89%A9%E5%B1%95><strong>安装扩展</strong></a></td><td style=text-align:left><code>bin/pgsql-ext &lt;cls></code></td><td style=text-align:left>在集群节点上安装扩展软件包</td></tr><tr><td style=text-align:left><a href=#%E9%85%8D%E7%BD%AE%E6%89%A9%E5%B1%95><strong>配置扩展</strong></a></td><td style=text-align:left><code>pg edit-config &lt;cls> -p</code></td><td style=text-align:left>将扩展添加到预加载库（需重启）</td></tr><tr><td style=text-align:left><a href=#%E5%90%AF%E7%94%A8%E6%89%A9%E5%B1%95><strong>启用扩展</strong></a></td><td style=text-align:left><code>psql -c 'CREATE EXT ...'</code></td><td style=text-align:left>在数据库中创建扩展对象</td></tr><tr><td style=text-align:left><a href=#%E6%9B%B4%E6%96%B0%E6%89%A9%E5%B1%95><strong>更新扩展</strong></a></td><td style=text-align:left><code>ALTER EXTENSION UPDATE</code></td><td style=text-align:left>更新扩展软件包与扩展对象</td></tr><tr><td style=text-align:left><a href=#%E7%A7%BB%E9%99%A4%E6%89%A9%E5%B1%95><strong>移除扩展</strong></a></td><td style=text-align:left><code>DROP EXTENSION</code></td><td style=text-align:left>删除扩展对象，卸载软件包</td></tr></tbody></table><div id=asciinema-ec8f712cd845ce138b45a5d9d91243a9 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ec8f712cd845ce138b45a5d9d91243a9",o="/demo/pgsql-ext.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=安装扩展>安装扩展</h2><p>定义在 <a href=/docs/pgsql/param#pg_extensions><strong><code>pg_extensions</code></strong></a> 里面的扩展会在 PostgreSQL <a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>集群创建</strong></a> 的时候在 <code>pg_extension</code> 任务中自动安装。</p><p>要在现有的 PostgreSQL 集群上安装扩展，请将扩展添加到 <code>all.children.&lt;cls>.pg_extensions</code>，然后执行：</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-02-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-02-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-02-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt;   <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上安装扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_extension   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本安装扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta    <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上安装配置中定义的扩展</span>
</span></span></code></pre></div></div></div><p><strong>示例配置：在集群上安装 PostGIS、TimescaleDB 和 PGVector</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars: # 省略上级缩进</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>执行效果</strong>：在集群所有节点上安装扩展软件包。Pigsty 会自动将 <a href=/docs/pgsql/config/alias><strong>包别名</strong></a> 翻译为对应操作系统和 PostgreSQL 版本的实际包名。</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>安装前，确保软件源可用</div><p>安装扩展前请确保节点已配置正确的软件源 —— 扩展已经在本地仓库中 <a href=#%E4%B8%8B%E8%BD%BD%E6%89%A9%E5%B1%95><strong>下载好</strong></a>，或者已经 <a href=#%E9%85%8D%E7%BD%AE%E4%BB%93%E5%BA%93><strong>配置扩展仓库</strong></a>。</p></div><hr><h2 id=手工安装>手工安装</h2><p>如果您不想使用 Pigsty 配置来管理 PostgreSQL 扩展，可以在命令行中直接传递要安装的扩展列表：</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-04-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-04-01 aria-selected=false>
剧本</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta pg_duckdb pg_mooncake   <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上安装指定扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_ext -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;: [&#34;pg_duckdb&#34;, &#34;pg_mooncake&#34;]}&#39;</span>
</span></span></code></pre></div></div></div><p>您也可以使用 <a href=/docs/pig><strong>pig</strong></a> 包管理器命令行工具在单个节点上安装扩展，同样会自动进行 <a href=/docs/pgsql/config/alias><strong>包别名</strong></a> 解析。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig install postgis timescaledb       <span style=color:#8f5902;font-style:italic># 安装多个扩展</span>
</span></span><span style=display:flex><span>pig install pgvector -v <span style=color:#0000cf;font-weight:700>17</span>            <span style=color:#8f5902;font-style:italic># 针对特定 PG 大版本安装</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ansible pg-test -b -a <span style=color:#4e9a06>&#39;pig install pg_duckdb&#39;</span>   <span style=color:#8f5902;font-style:italic># 使用 Ansible 在集群上批量安装</span>
</span></span></code></pre></div><p>您也可以 <strong>直接使用操作系统包管理器</strong> (<code>apt/dnf</code>) 进行安装，但您必须知道具体操作系统/PG下的 RPM/DEB 包名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 系统（RHEL、Rocky、Alma、Oracle Linux）</span>
</span></span><span style=display:flex><span>sudo yum install -y pgvector_17*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian / Ubuntu 系统</span>
</span></span><span style=display:flex><span>sudo apt install -y postgresql-17-pgvector
</span></span></code></pre></div><hr><h2 id=下载扩展>下载扩展</h2><p>要想安装扩展，您需要确保节点上配置的 <a href=/docs/repo/pgsql><strong>扩展仓库</strong></a> 包含待安装的扩展：</p><ul><li><a href=/docs/setup/install><strong>单机安装</strong></a> 时无需操心，上游仓库已经直接添加到节点上。</li><li><a href=/docs/setup/offline><strong>离线安装</strong></a> 时无需操心，绝大部分扩展都已经包含在离线安装包里，个别扩展需要在线安装。</li><li>使用本地仓库的 <a href=/docs/deploy/install><strong>生产多节点部署</strong></a>，要看情况，如果在本地仓库创建的时候 <a href=/docs/infra/param/#repo_packages><code>repo_packages</code></a> / <a href=/docs/infra/param/#repo_extra_packages><code>repo_extra_packages</code></a> 中包含了扩展包，
则意味着已经下载到了本地，可以直接安装，否则需要先下载扩展包到本地仓库。或者直接为节点 <a href=#%E9%85%8D%E7%BD%AE%E4%BB%93%E5%BA%93><strong>配置上游仓库</strong></a> 在线安装。</li></ul><p>Pigsty 的默认配置在安装过程中会自动下载主流扩展到本地仓库。如需额外扩展，添加到 <a href=/docs/infra/param#repo_extra_packages><strong><code>repo_extra_packages</code></strong></a> 后重建仓库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>repo_extra_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, postgis, timescaledb ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-05-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-05-01 aria-selected=false>
剧本</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make repo         <span style=color:#8f5902;font-style:italic># 快捷方式 = repo-build + node-repo</span>
</span></span><span style=display:flex><span>make repo-build   <span style=color:#8f5902;font-style:italic># 快捷方式，重建 Infra 上的软件仓库（下载软件包与依赖）</span>
</span></span><span style=display:flex><span>make node-repo    <span style=color:#8f5902;font-style:italic># 快捷方式，刷新节点上的软件源缓存，更新对 Infra 软件仓库的引用</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy.yml -t repo_build,node_repo  <span style=color:#8f5902;font-style:italic># 一次性执行两个任务</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build     <span style=color:#8f5902;font-style:italic># 重新下载软件包到本地仓库</span>
</span></span><span style=display:flex><span>./node.yml  -t node_repo      <span style=color:#8f5902;font-style:italic># 刷新节点软件源缓存</span>
</span></span></code></pre></div></div></div><hr><h2 id=配置仓库>配置仓库</h2><p>您也可以选择直接让所有节点都使用上游仓库（生产环境不推荐），跳过下载步骤，直接从互联网 <a href=/docs/repo/pgsql><strong>上游扩展仓库</strong></a> 安装</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql   <span style=color:#8f5902;font-style:italic># 添加 PGDG 与 Pigsty 上游仓库</span>
</span></span></code></pre></div><hr><h2 id=配置扩展>配置扩展</h2><p>部分扩展需要预加载到 <a href=https://www.postgresql.org/docs/9.0/runtime-config-resource.html#GUC-SHARED-PRELOAD-LIBRARIES><strong><code>shared_preload_libraries</code></strong></a> 才能使用，修改后需要 <strong>重启数据库</strong> 生效。</p><p>您可以用 <a href=/docs/pgsql/param#pg_libs><strong><code>pg_libs</code></strong></a> 参数作为它的默认值，在配置预加载的扩展，但是这个参数只在集群初始化时生效，后面修改就无效了。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 预加载扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb, postgis, pgvector ]         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装扩展包</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>对于已有集群，您可以参考 <a href=/docs/pgsql/admin/patroni#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong>修改配置</strong></a> 的介绍，修改 <code>shared_preload_libraries</code>参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>pg restart pg-meta   <span style=color:#8f5902;font-style:italic># 修改 pg-meta 集群的参数，并重启集群使配置生效</span>
</span></span></code></pre></div><p>请确保扩展软件包已正确安装后再添加预加载配置，如果 <code>shared_preload_libraries</code> 中的扩展不存在或加载失败，PostgreSQL 将 <strong>无法启动</strong>。
此外，请通过 Patroni 管理集群的配置变更，避免使用 <code>ALTER SYSTEM</code> 或者 <a href=/docs/pgsql/param#pg_parameters><strong><code>pg_parameters</code></strong></a> 单独修改实例配置。
如果主库和从库配置不一致，可能导致启动失败或复制中断。</p><hr><h2 id=启用扩展>启用扩展</h2><p>安装扩展软件包后，需要在数据库中执行 <code>CREATE EXTENSION</code> 才能使用扩展提供的功能。</p><p><strong>集群初始化时启用</strong></p><p>在 <a href=/docs/pgsql/config/db><strong>数据库定义</strong></a> 中通过 <code>extensions</code> 数组声明要启用的扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>vector                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单形式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指定 Schema</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>手动启用</strong></p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist=sql aria-controls=tabs-06-00 aria-selected=true>
SQL</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist=psql aria-controls=tabs-06-01 aria-selected=false>
psql</button></li><li class=nav-item><button class=nav-link id=tabs-06-02-tab data-bs-toggle=tab data-bs-target=#tabs-06-02 role=tab data-td-tp-persist=剧本 aria-controls=tabs-06-02 aria-selected=false>
剧本</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic>-- 创建扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- 指定 Schema
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- 幂等创建
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- 自动安装依赖
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION vector;&#39;</span>                  <span style=color:#8f5902;font-style:italic># 在 meta 数据库创建扩展</span>
</span></span><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION postgis SCHEMA public;&#39;</span>   <span style=color:#8f5902;font-style:italic># 指定 Schema</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-02 role=tabpanel aria-labelled-by=tabs-06-02-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改数据库定义后使用剧本启用扩展</span>
</span></span><span style=display:flex><span>bin/pgsql-db pg-meta meta    <span style=color:#8f5902;font-style:italic># 创建/修改数据库会自动启用定义的扩展</span>
</span></span></code></pre></div></div></div><p><strong>执行效果</strong>：在数据库中创建扩展对象（函数、类型、操作符、索引方法等），之后即可使用扩展提供的功能。</p><hr><h2 id=更新扩展>更新扩展</h2><p>扩展更新涉及两个层面：<strong>软件包更新</strong> 和 <strong>扩展对象更新</strong>。</p><p><strong>更新软件包</strong></p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist=pig aria-controls=tabs-07-00 aria-selected=true>
pig</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist=yum aria-controls=tabs-07-01 aria-selected=false>
yum</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab data-td-tp-persist=apt aria-controls=tabs-07-02 aria-selected=false>
apt</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig update pgvector                           <span style=color:#8f5902;font-style:italic># 使用 pig 更新扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum update pgvector_18 <span style=color:#8f5902;font-style:italic># EL</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt upgrade postgresql-18-pgvector  <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><p><strong>更新扩展对象</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看可升级的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 更新扩展到最新版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 更新到指定版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.8.1&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>更新注意事项</div><p>更新扩展前建议备份数据库。预加载扩展更新后可能需要重启 PostgreSQL。某些扩展版本升级可能不兼容，请查阅扩展文档。</p></div><hr><h2 id=移除扩展>移除扩展</h2><p>移除扩展涉及两个层面：<strong>删除扩展对象</strong> 和 <strong>卸载软件包</strong>。</p><p><strong>删除扩展对象</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- 删除扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- 级联删除（删除依赖对象）
</span></span></span></code></pre></div><p><strong>移除预加载</strong></p><p>如果是预加载扩展，需从 <code>shared_preload_libraries</code> 中移除并重启：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>pg restart pg-meta   <span style=color:#8f5902;font-style:italic># 重启使配置生效</span>
</span></span></code></pre></div><p><strong>卸载软件包（可选）</strong></p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist=pig aria-controls=tabs-09-00 aria-selected=true>
pig</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist=yum aria-controls=tabs-09-01 aria-selected=false>
yum</button></li><li class=nav-item><button class=nav-link id=tabs-09-02-tab data-bs-toggle=tab data-bs-target=#tabs-09-02 role=tab data-td-tp-persist=apt aria-controls=tabs-09-02 aria-selected=false>
apt</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig remove pgvector                           <span style=color:#8f5902;font-style:italic># 使用 pig 卸载</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum remove pgvector_17*                  <span style=color:#8f5902;font-style:italic># EL 系统</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-02 role=tabpanel aria-labelled-by=tabs-09-02-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt remove postgresql-17-pgvector        <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>CASCADE 警告</div><p>使用 <code>CASCADE</code> 删除扩展会同时删除所有依赖该扩展的对象（表、索引、视图等）。请先检查依赖关系再执行删除。</p></div><hr><h2 id=查询扩展>查询扩展</h2><p>以下是一些常用的 SQL 查询，用于查看扩展信息：</p><p><strong>查看已启用的扩展</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#f8f8f8> </span><span style=color:#000>n</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extnamespace</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>n</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看可用扩展</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- 仅显示已安装的
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>检查扩展是否可用</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看扩展依赖关系</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>refobjid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>depends_on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>objid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>deptype</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;e&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgis_topology&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看扩展对象</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>classid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>objid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>deptype</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>refobjid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>psql 快捷命令</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#4e9a06>\d</span>x                    <span style=color:#8f5902;font-style:italic># 列出已启用的扩展</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>\d</span>x+ vector            <span style=color:#8f5902;font-style:italic># 显示扩展详情</span>
</span></span></code></pre></div><hr><h2 id=添加仓库>添加仓库</h2><p>如需直接从上游安装扩展，可手动添加软件仓库。</p><p><strong>使用 Pigsty 剧本添加</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql        <span style=color:#8f5902;font-style:italic># 添加 PGDG 与 Pigsty 仓库</span>
</span></span><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql,local  <span style=color:#8f5902;font-style:italic># 包括本地仓库</span>
</span></span></code></pre></div><p><strong>YUM 仓库（EL 系统）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pigsty 仓库</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 中国大陆镜像</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span></code></pre></div><p><strong>APT 仓库（Debian/Ubuntu）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/pigsty.gpg
</span></span><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/pgsql $(lsb_release -cs) main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 中国大陆镜像：将 repo.pigsty.io 替换为 repo.pigsty.cc</span>
</span></span></code></pre></div><hr><h2 id=常见问题>常见问题</h2><p><strong>扩展名与包名的区别</strong></p><table class=full-width><thead><tr><th style=text-align:left>名称</th><th style=text-align:left>说明</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td style=text-align:left>扩展名</td><td style=text-align:left><code>CREATE EXTENSION</code> 使用的名称</td><td style=text-align:left><code>vector</code></td></tr><tr><td style=text-align:left>包别名</td><td style=text-align:left>Pigsty 配置中使用的标准化名称</td><td style=text-align:left><code>pgvector</code></td></tr><tr><td style=text-align:left>包名</td><td style=text-align:left>操作系统实际的包名</td><td style=text-align:left><code>pgvector_17*</code> 或 <code>postgresql-17-pgvector</code></td></tr></tbody></table><p><strong>预加载扩展无法启动</strong></p><p>如果 <code>shared_preload_libraries</code> 中的扩展不存在或加载失败，PostgreSQL 将无法启动。解决方法：</p><ol><li>确保扩展软件包已正确安装</li><li>或从 <code>shared_preload_libraries</code> 中移除该扩展（编辑 <code>/pg/data/postgresql.conf</code>）</li></ol><p><strong>扩展依赖问题</strong></p><p>某些扩展依赖于其他扩展，需按顺序创建或使用 <code>CASCADE</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic>-- 先创建基础扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 再创建依赖扩展
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 或
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- 自动创建依赖
</span></span></span></code></pre></div><p><strong>扩展版本不兼容</strong></p><p>查看当前 PostgreSQL 版本支持的扩展版本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extension_versions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=相关资源>相关资源</h2><ul><li><a href=/docs/pgsql/ext/><strong>扩展插件</strong></a>：扩展管理的详细文档</li><li><a href=https://pgext.cloud/zh/list><strong>扩展目录</strong></a>：查阅 451 可用扩展</li><li><a href=https://pgext.cloud/pig><strong>pig 包管理器</strong></a>：扩展安装命令行工具</li><li><a href=/docs/pgsql/admin/db/><strong>数据库管理</strong></a>：在数据库中启用扩展</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-efb2d1006e9f523db1ec2975456da71f>7 - 备份恢复</h1><div class=lead>时间点恢复（PITR）备份与恢复</div><p>Pigsty 使用 <a href=https://pgbackrest.org/>pgBackRest</a> 管理 PostgreSQL 备份，这可能是生态系统中最强大的开源备份工具。
它支持增量/并行备份与恢复、加密、<a href=/docs/minio>MinIO</a>/S3 等众多特性。Pigsty 默认为每个 <a href=/docs/pgsql>PGSQL</a> 集群预配置了备份功能。</p><table class=full-width><thead><tr><th>章节</th><th>内容</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/backup/mechanism>机制</a></td><td>备份脚本、定时任务、pgbackrest、仓库与管理</td></tr><tr><td><a href=/docs/pgsql/backup/policy>策略</a></td><td>备份策略、磁盘规划、恢复窗口权衡</td></tr><tr><td><a href=/docs/pgsql/backup/repository>仓库</a></td><td>配置备份仓库：本地、MinIO、S3</td></tr><tr><td><a href=/docs/pgsql/backup/admin>管理</a></td><td>常用备份管理命令</td></tr><tr><td><a href=/docs/pgsql/backup/restore>恢复</a></td><td>使用剧本恢复到特定时间点</td></tr><tr><td><a href=/docs/pgsql/backup/restore#%E5%88%86%E6%AD%A5%E6%89%A7%E8%A1%8C>示例</a></td><td>沙箱示例：手工执行恢复操作</td></tr></tbody></table><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>免责声明</div><blockquote><p>Pigsty 尽最大努力提供可靠的 PITR 解决方案，但我们不对 PITR 操作导致的数据丢失承担任何责任，使用需自担风险。如需专业支持，请考虑我们的 <a href=/docs/about/service>专业服务</a>。</p></blockquote></div><hr><h2 id=快速上手>快速上手</h2><ol><li><a href=/docs/pgsql/backup/mechanism>备份策略</a>：使用 Crontab 调度基础备份</li><li><a href=/docs/pgsql/backup/policy>WAL 归档</a>：持续记录写入活动</li><li><a href=/docs/pgsql/backup/restore>恢复与还原</a>：从备份和 WAL 归档中恢复</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;time&#34;: &#34;2025-07-13 10:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4c34e733cec9746048fccac02c01fd36>7.1 - 备份策略</h1><div class=lead>根据您的需求设计备份策略</div><p>下图将“恢复窗口”与“存储空间占用”合并到同一时间轴（<code>0~108h</code>）中，便于一起观察。</p><p>在相同假设（数据库 <code>100GB</code>、日写入 <code>10GB</code>）下，下图展示“每 7 天全量 + 每日增量、全量保留 14 天”时，30 天内恢复窗口与存储占用变化。</p><ul><li><strong>何时</strong>：备份策略</li><li><strong>何处</strong>：备份仓库</li><li><strong>如何</strong>：备份方法</li></ul><hr><h2 id=何时备份>何时备份</h2><p>第一个问题是<strong>何时</strong>备份您的数据库——这是备份频率和恢复时间之间的权衡。
由于您需要从上一次备份开始重放 WAL 日志到恢复目标点，备份越频繁，需要重放的 WAL 日志就越少，恢复速度就越快。</p><h3 id=每日全量备份>每日全量备份</h3><p>对于生产数据库，建议从最简单的每日全量备份策略开始。
这也是 Pigsty 的默认备份策略，通过 <a href=/docs/pgsql/backup/mechanism#%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD>crontab</a> 实现。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 选择备份仓库方法：`local`、`minio` 或其他自定义仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 使用本地 POSIX 文件系统的默认 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按数量保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，保留2个，最多3个全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>假设您的数据库大小为 100GB，每天更新写入 10GB 数据，备份耗时1小时，那么在每日全量备份，使用本地仓库的策略下，恢复窗口与备份空间随时间的变化如下图所示：</p><p>恢复窗口会在 25-49 小时之间循环，备份消耗的存储空间约为全量基础备份的 <code>2</code> 倍加上 2 天的 WAL 日志。
在实践中，您可能需要准备至少 <code>3~5</code> 倍基础数据库大小的备份磁盘才能使用默认备份策略。</p><script src=/js/echarts.min.js></script><div id=echarts-557a63f9d722fa407e500e69783e10e8 class="echarts-container td-max-width-on-larger-screens" style=height:640px></div><script>(function(){var e,t,n,s,o,r,c,l,d,u,h,a=document.getElementById("echarts-557a63f9d722fa407e500e69783e10e8");if(!a)return;window._echartsFns=window._echartsFns||{},e=function(e){return Math.round(Number(e))},u=function(t){return e(t)===0?"0":e(t)+"h"},o=function(t){return e(t)+"h"},t=function(e){return Number(e)===0?"0":(Number(e)>=100?Number(e).toFixed(0):Number(e)>=10?Number(e).toFixed(1):Number(e).toFixed(2)).replace(/\.00$/,"").replace(/(\.\d)0$/,"$1")+"GB"},d=function(t){return e(t)===0?"0":""+e(t)},r=function(n){return!n||!n.length?"":function(s){return["时间: "+e(n[0].axisValue)+"h"].concat(s.win===null?[]:["恢复窗口: "+o(s.win)]).concat(["首要备份: "+t(s.p),"次要备份: "+t(s.s),"WAL归档: "+t(s.w)]).concat(s.t>0?["瞬时备份: "+t(s.t)]:[]).concat(["备份存储: "+t(s.p+s.s+s.w+s.t)]).join("<br/>")}(n.reduce(function(e,t){return t.seriesName==="恢复窗口"?{win:Number(t.data[1]),p:e.p,s:e.s,w:e.w,t:e.t}:t.seriesName==="首要备份"?{win:e.win,p:Number(t.value),s:e.s,w:e.w,t:e.t}:t.seriesName==="次要备份"?{win:e.win,p:e.p,s:Number(t.value),w:e.w,t:e.t}:t.seriesName==="WAL归档"?{win:e.win,p:e.p,s:e.s,w:Number(t.value),t:e.t}:t.seriesName==="瞬时备份"?{win:e.win,p:e.p,s:e.s,w:e.w,t:Number(t.value)}:e},{win:null,p:0,s:0,w:0,t:0}))},window._echartsFns.int1=e,window._echartsFns.fmtHour=u,window._echartsFns.fmtWin=o,window._echartsFns.fmtGb=t,window._echartsFns.fmtGbTick=d,window._echartsFns.tipMerged=r,c=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,n=echarts.init(a,c),l={axisPointer:{link:[{xAxisIndex:[0,1]}]},grid:[{containLabel:!1,height:218,left:82,right:"10%",top:42},{containLabel:!1,height:218,left:82,right:"10%",top:286}],legend:{bottom:10,data:["首要备份","次要备份","WAL归档","瞬时备份"],itemGap:18,show:!1},series:[{data:[[0,0],[1,0],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],[11,11],[12,12],[13,13],[14,14],[15,15],[16,16],[17,17],[18,18],[19,19],[20,20],[21,21],[22,22],[23,23],[24,24],[25,25],[26,26],[27,27],[28,28],[29,29],[30,30],[31,31],[32,32],[33,33],[34,34],[35,35],[36,36],[37,37],[38,38],[39,39],[40,40],[41,41],[42,42],[43,43],[44,44],[45,45],[46,46],[47,47],[48,48],[49,49],[49,25],[50,26],[51,27],[52,28],[53,29],[54,30],[55,31],[56,32],[57,33],[58,34],[59,35],[60,36],[61,37],[62,38],[63,39],[64,40],[65,41],[66,42],[67,43],[68,44],[69,45],[70,46],[71,47],[72,48],[73,49],[73,25],[74,26],[75,27],[76,28],[77,29],[78,30],[79,31],[80,32],[81,33],[82,34],[83,35],[84,36],[85,37],[86,38],[87,39],[88,40],[89,41],[90,42],[91,43],[92,44],[93,45],[94,46],[95,47],[96,48],[97,49],[97,25],[98,26],[99,27],[100,28],[101,29],[102,30],[103,31],[104,32],[105,33],[106,34],[107,35],[108,36]],itemStyle:{color:"#f2a000"},lineStyle:{color:"#f2a000",width:3},markLine:{data:[{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:0},{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:24},{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:48},{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:72},{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:96},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:1},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:25},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:49},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:73},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:97},{label:{color:"#2563eb",distance:12,formatter:"稳态下限 25h",position:"end",show:!0},lineStyle:{color:"#2563eb",opacity:.75,type:"dashdot",width:1.4},yAxis:25},{label:{color:"#7c3aed",distance:12,formatter:"窗口峰值 49h",position:"end",show:!0},lineStyle:{color:"#7c3aed",opacity:.75,type:"dashdot",width:1.4},yAxis:49}],label:{show:!1},symbol:"none"},name:"恢复窗口",showSymbol:!1,smooth:!1,symbol:"none",type:"line",xAxisIndex:0,yAxisIndex:0},{barWidth:5,data:[0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],itemStyle:{color:"#59a14f"},name:"首要备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:5,data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],itemStyle:{color:"#4e79a7"},name:"次要备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:5,data:[0,0,.42,.83,1.25,1.67,2.08,2.5,2.92,3.33,3.75,4.17,4.58,5,5.42,5.83,6.25,6.67,7.08,7.5,7.92,8.33,8.75,9.17,9.58,10,10.42,10.83,11.25,11.67,12.08,12.5,12.92,13.33,13.75,14.17,14.58,15,15.42,15.83,16.25,16.67,17.08,17.5,17.92,18.33,18.75,19.17,19.58,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20],itemStyle:{color:"#edc949"},name:"WAL归档",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:5,data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,0,0,0,0],itemStyle:{color:"#9ca3af",opacity:.75},name:"瞬时备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1}],tooltip:{axisPointer:{label:{show:!1},snap:!0,type:"line"},formatter:"$fn:tipMerged",trigger:"axis"},xAxis:[{axisLabel:{formatter:"$fn:fmtHour",interval:11},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["none","arrow"],symbolSize:[10,14]},axisTick:{length:6,show:!0},boundaryGap:!1,data:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108],gridIndex:0,minorSplitLine:{lineStyle:{color:"#9ca3af",opacity:.14,type:"dotted",width:1},show:!0},minorTick:{length:3,show:!0,splitNumber:12},name:"时间 h",nameGap:10,nameLocation:"end",nameTextStyle:{align:"left",padding:[8,0,0,0],verticalAlign:"top"},position:"bottom",splitLine:{lineStyle:{color:"#9ca3af",opacity:.28,type:"dashed",width:1},show:!0},type:"category"},{axisLabel:{show:!1},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0},axisTick:{length:6,show:!0},boundaryGap:!0,data:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108],gridIndex:1,position:"top",splitLine:{lineStyle:{color:"#9ca3af",opacity:.22,type:"dashed",width:1},show:!0},type:"category"}],yAxis:[{axisLabel:{formatter:"$fn:fmtWin"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["none","arrow"],symbolSize:[10,14]},axisTick:{length:6,show:!0},gridIndex:0,interval:5,max:52,min:0,minorSplitLine:{lineStyle:{color:"#9ca3af",opacity:.18,type:"dotted",width:1},show:!0},minorTick:{length:3,show:!0,splitNumber:5},name:"恢复窗口 h",nameGap:8,nameLocation:"end",nameRotate:0,nameTextStyle:{align:"left",padding:[0,0,8,4],verticalAlign:"bottom"},splitLine:{lineStyle:{color:"#9ca3af",opacity:.35,type:"dashed",width:1},show:!0},type:"value"},{axisLabel:{formatter:"$fn:fmtGbTick"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["arrow","none"],symbolSize:[10,14]},axisTick:{length:6,show:!0},gridIndex:1,interval:50,inverse:!0,max:350,min:0,name:"存储空间 GB",nameGap:8,nameLocation:"end",nameRotate:0,nameTextStyle:{align:"left",padding:[10,0,0,4],verticalAlign:"top"},splitLine:{lineStyle:{color:"#9ca3af",opacity:.32,type:"dashed",width:1},show:!0},type:"value"}]};function i(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,n,s=e.substring(4);return window._echartsFns[s]}if(Array.isArray(e))return e.map(i);if(e&&typeof e=="object"){t={};for(n in e)t[n]=i(e[n]);return t}return e}s=i(l),n.setOption(s),window.addEventListener("resize",function(){n.resize()}),h=new MutationObserver(function(e){e.forEach(function(e){if(e.attributeName==="data-bs-theme"){var t=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;n.dispose(),n=echarts.init(a,t),n.setOption(s)}})}),h.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><h3 id=全量--增量备份>全量 + 增量备份</h3><p>您可以通过调整这些参数来优化备份空间使用。</p><p>如果使用 MinIO / S3 作为集中式备份仓库，您可以使用超出本地磁盘限制的存储空间。
此时可以考虑使用全量 + 增量备份配合 2 周保留策略：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 周一凌晨1点全量备份，工作日增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1           /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 可选的 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 兼容 S3 协议</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认 us-east-1，对 minio 无实际意义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 使用路径风格 URI 而非主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA 证书路径，默认 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 启用块级增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成单个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包大小限制，对象存储建议 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包目标大小，对象存储建议 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按时间保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留最近 14 天的全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>配合内置的 <code>minio</code> 备份仓库使用时，可提供保证 1 周的 PITR 恢复窗口。</p><p>假设您的数据库大小为 100GB，每天写入 10GB 数据，则备份大小如下：</p><div id=echarts-6f3bb4973b1a377a2bad89e57d6ca334 class="echarts-container td-max-width-on-larger-screens" style=height:640px></div><script>(function(){var e,t,n,s,o,r,c,l,d,u,h,m,i=document.getElementById("echarts-6f3bb4973b1a377a2bad89e57d6ca334");if(!i)return;window._echartsFns=window._echartsFns||{},e=function(e){return Math.round(Number(e))},l=function(t){return e(t)<1||e(t)>30?"":""+e(t)},o=function(t){return e(t)+"h"},t=function(e){return Number(e)===0?"0":(Number(e)>=100?Number(e).toFixed(0):Number(e)>=10?Number(e).toFixed(1):Number(e).toFixed(2)).replace(/\.00$/,"").replace(/(\.\d)0$/,"$1")+"GB"},c=function(t){return e(t)===0?"0":""+e(t)},n=function(e){return Number(Array.isArray(e)?e[1]:e)},d=function(s){return!s||!s.length?"":function(n){return["第"+e(s[0].axisValue)+"天"].concat(n.win===null?[]:["恢复窗口: "+o(n.win)]).concat(["首要备份: "+t(n.p),"次要备份: "+t(n.s),"增量备份: "+t(n.i),"WAL归档: "+t(n.w)]).concat(n.t>0?["瞬时备份: "+t(n.t)]:[]).concat(["备份存储: "+t(n.p+n.s+n.i+n.w+n.t)]).join("<br/>")}(s.reduce(function(e,t){return t.seriesName==="恢复窗口"?{win:n(t.value),p:e.p,s:e.s,i:e.i,w:e.w,t:e.t}:t.seriesName==="首要备份"?{win:e.win,p:n(t.value),s:e.s,i:e.i,w:e.w,t:e.t}:t.seriesName==="次要备份"?{win:e.win,p:e.p,s:n(t.value),i:e.i,w:e.w,t:e.t}:t.seriesName==="增量备份"?{win:e.win,p:e.p,s:e.s,i:n(t.value),w:e.w,t:e.t}:t.seriesName==="WAL归档"?{win:e.win,p:e.p,s:e.s,i:e.i,w:n(t.value),t:e.t}:t.seriesName==="瞬时备份"?{win:e.win,p:e.p,s:e.s,i:e.i,w:e.w,t:n(t.value)}:e},{win:null,p:0,s:0,i:0,w:0,t:0}))},window._echartsFns.int30d=e,window._echartsFns.fmtDay30=l,window._echartsFns.fmtWin30=o,window._echartsFns.fmtGb30=t,window._echartsFns.fmtGbTick30=c,window._echartsFns.valY30=n,window._echartsFns.tipMerged30=d,u=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,s=echarts.init(i,u),h={axisPointer:{link:[{xAxisIndex:[0,1]}]},grid:[{containLabel:!1,height:218,left:82,right:"10%",top:42},{containLabel:!1,height:218,left:82,right:"10%",top:302}],legend:{bottom:10,data:["首要备份","次要备份","增量备份","WAL归档","瞬时备份"],itemGap:18,show:!1},series:[{data:[[1,24],[2,48],[3,72],[4,96],[5,120],[6,144],[7,168],[8,192],[9,216],[10,240],[11,264],[12,288],[13,312],[14,336],[14,168],[15,192],[16,216],[17,240],[18,264],[19,288],[20,312],[21,336],[21,168],[22,192],[23,216],[24,240],[25,264],[26,288],[27,312],[28,336],[28,168],[29,192],[30,216]],itemStyle:{color:"#f28e2c"},lineStyle:{color:"#f28e2c",width:3},markLine:{data:[{lineStyle:{color:"#336791",opacity:.65,type:"solid",width:1.4},xAxis:7},{lineStyle:{color:"#336791",opacity:.65,type:"solid",width:1.4},xAxis:14},{lineStyle:{color:"#336791",opacity:.65,type:"solid",width:1.4},xAxis:21},{lineStyle:{color:"#336791",opacity:.65,type:"solid",width:1.4},xAxis:28},{label:{color:"#2563eb",distance:12,formatter:"窗口下限 7d",position:"end",show:!0},lineStyle:{color:"#2563eb",opacity:.72,type:"dashdot",width:1.4},yAxis:168},{label:{color:"#7c3aed",distance:12,formatter:"窗口上限 14d",position:"end",show:!0},lineStyle:{color:"#7c3aed",opacity:.72,type:"dashdot",width:1.4},yAxis:336}],label:{show:!1},symbol:"none"},name:"恢复窗口",showSymbol:!1,smooth:!1,symbol:"none",type:"line",xAxisIndex:0,yAxisIndex:0},{barWidth:16,data:[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],itemStyle:{color:"#59a14f"},name:"首要备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:16,data:[0,0,0,0,0,0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],itemStyle:{color:"#4e79a7"},name:"次要备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:16,data:[0,10,20,30,40,50,60,70,80,90,100,110,120,130,70,80,90,100,110,120,130,70,80,90,100,110,120,130,70,80],itemStyle:{color:"#76b7b2"},name:"增量备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:16,data:[10,20,30,40,50,60,70,80,90,100,110,120,130,140,80,90,100,110,120,130,140,80,90,100,110,120,130,140,80,90],itemStyle:{color:"#edc949"},name:"WAL归档",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:16,data:[0,0,0,0,0,0,0,0,0,0,0,0,0,110,0,0,0,0,0,0,110,0,0,0,0,0,0,110,0,0],itemStyle:{color:"#9ca3af",opacity:.75},name:"瞬时备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1}],tooltip:{axisPointer:{label:{show:!1},snap:!0,type:"line"},formatter:"$fn:tipMerged30",trigger:"axis"},xAxis:[{axisLabel:{formatter:"$fn:fmtDay30"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["none","arrow"],symbolSize:[10,14]},axisTick:{length:6,show:!0},boundaryGap:!1,gridIndex:0,interval:1,max:31,min:0,minorSplitLine:{lineStyle:{color:"#9ca3af",opacity:.14,type:"dotted",width:1},show:!0},minorTick:{length:3,show:!0,splitNumber:4},name:"时间",nameGap:10,nameLocation:"end",nameTextStyle:{align:"left",padding:[8,0,0,0],verticalAlign:"top"},position:"bottom",splitLine:{lineStyle:{color:"#9ca3af",opacity:.28,type:"dashed",width:1},show:!0},type:"value"},{axisLabel:{show:!1},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0},axisTick:{alignWithLabel:!0,length:6,show:!0},boundaryGap:!0,data:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],gridIndex:1,position:"top",splitLine:{lineStyle:{color:"#9ca3af",opacity:.22,type:"dashed",width:1},show:!0},type:"category",z:10}],yAxis:[{axisLabel:{formatter:"$fn:fmtWin30"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["none","arrow"],symbolSize:[10,14]},axisTick:{length:6,show:!0},gridIndex:0,interval:48,max:360,min:0,minorSplitLine:{lineStyle:{color:"#9ca3af",opacity:.18,type:"dotted",width:1},show:!0},minorTick:{length:3,show:!0,splitNumber:4},name:"恢复窗口 h",nameGap:8,nameLocation:"end",nameRotate:0,nameTextStyle:{align:"left",padding:[0,0,8,4],verticalAlign:"bottom"},splitLine:{lineStyle:{color:"#9ca3af",opacity:.35,type:"dashed",width:1},show:!0},type:"value"},{axisLabel:{formatter:"$fn:fmtGbTick30"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["arrow","none"],symbolSize:[10,14]},axisTick:{length:6,show:!0},gridIndex:1,interval:50,inverse:!0,max:600,min:0,name:"存储空间 GB",nameGap:8,nameLocation:"end",nameRotate:0,nameTextStyle:{align:"left",padding:[10,0,0,4],verticalAlign:"top"},splitLine:{lineStyle:{color:"#9ca3af",opacity:.32,type:"dashed",width:1},show:!0},type:"value",z:10}]};function a(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,n,s=e.substring(4);return window._echartsFns[s]}if(Array.isArray(e))return e.map(a);if(e&&typeof e=="object"){t={};for(n in e)t[n]=a(e[n]);return t}return e}r=a(h),s.setOption(r),window.addEventListener("resize",function(){s.resize()}),m=new MutationObserver(function(e){e.forEach(function(e){if(e.attributeName==="data-bs-theme"){var t=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;s.dispose(),s=echarts.init(i,t),s.setOption(r)}})}),m.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=备份位置>备份位置</h2><p>默认情况下，Pigsty 提供两个默认备份仓库定义：<code>local</code> 和 <code>minio</code> 备份仓库。</p><ul><li><code>local</code>：<strong>默认选项</strong>，使用本地 <code>/pg/backup</code> 目录（软链接指向 <a href=/docs/pgsql/param/#pg_fs_backup><code>pg_fs_backup</code></a>：<code>/data/backups</code>）</li><li><code>minio</code>：使用 SNSD 单节点 MinIO 集群（Pigsty 支持，但默认不启用）</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 选择备份仓库方法：`local`、`minio` 或其他自定义仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 使用本地 POSIX 文件系统的默认 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按数量保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，保留2个，最多3个全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 可选的 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 兼容 S3 协议</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认 us-east-1，对 minio 无实际意义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 使用路径风格 URI 而非主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA 证书路径，默认 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 启用块级增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成单个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包大小限制，对象存储建议 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包目标大小，对象存储建议 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按时间保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留最近 14 天的全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-931bd9f9bf4846ff58a1265e886414d1>7.2 - 备份机制</h1><div class=lead>备份脚本、定时任务、备份仓库与基础设施</div><p>备份可以通过内置 <a href=#%E8%84%9A%E6%9C%AC>脚本</a> 调用，使用节点 <a href=#%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD>crontab</a> 定时执行，
由 <a href=https://pgbackrest.org/>pgbackrest</a> 管理，存储在备份仓库中，
仓库可以是本地磁盘文件系统或 MinIO / S3，并支持不同的 <a href=/docs/pgsql/backup/repository#%E4%BB%93%E5%BA%93%E4%BF%9D%E7%95%99%E7%AD%96%E7%95%A5>保留</a> 策略。</p><hr><h2 id=脚本>脚本</h2><p>您可以使用 <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a> 用户（默认为 <code>postgres</code>）执行 <code>pgbackrest</code> 命令创建备份：</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
备份命令</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
backup</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
full</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
diff</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
incr</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
info</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>full backup   <span style=color:#8f5902;font-style:italic># 为集群 pg-meta 创建全量备份</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>full backup
</span></span><span style=display:flex><span>2025-07-15 01:36:57.007 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: --annotation<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>pg_cluster</span><span style=color:#ce5c00;font-weight:700>=</span>pg-meta ...
</span></span><span style=display:flex><span>2025-07-15 01:36:57.030 P00   INFO: execute non-exclusive backup start: backup begins after the requested immediate checkpoint completes
</span></span><span style=display:flex><span>2025-07-15 01:36:57.105 P00   INFO: backup start <span style=color:#000>archive</span> <span style=color:#ce5c00;font-weight:700>=</span> 000000010000000000000006, <span style=color:#000>lsn</span> <span style=color:#ce5c00;font-weight:700>=</span> 0/6000028
</span></span><span style=display:flex><span>2025-07-15 01:36:58.540 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F
</span></span><span style=display:flex><span>2025-07-15 01:36:58.588 P00   INFO: full backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 44.5MB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:36:58.589 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1584ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>diff backup
</span></span><span style=display:flex><span>2025-07-15 01:37:24.952 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-15 01:37:24.985 P00   INFO: last backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F, <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> 2.54.2
</span></span><span style=display:flex><span>2025-07-15 01:37:26.337 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013724D
</span></span><span style=display:flex><span>2025-07-15 01:37:26.381 P00   INFO: diff backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 424.3KB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:37:26.381 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1431ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>incr backup
</span></span><span style=display:flex><span>2025-07-15 01:37:30.305 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-15 01:37:30.337 P00   INFO: last backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013724D, <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> 2.54.2
</span></span><span style=display:flex><span>2025-07-15 01:37:31.356 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013730I
</span></span><span style=display:flex><span>2025-07-15 01:37:31.403 P00   INFO: incr backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 8.3KB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:37:31.403 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1099ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta info
</span></span><span style=display:flex><span>stanza: pg-meta
</span></span><span style=display:flex><span>    status: ok
</span></span><span style=display:flex><span>    cipher: aes-256-cbc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    db <span style=color:#ce5c00;font-weight:700>(</span>current<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        wal archive min/max <span style=color:#ce5c00;font-weight:700>(</span>17<span style=color:#ce5c00;font-weight:700>)</span>: 000000010000000000000001/00000001000000000000000A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        full backup: 20250715-013657F
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:36:57+00 / 2025-07-15 01:36:58+00
</span></span><span style=display:flex><span>            wal start/stop: <span style=color:#0000cf;font-weight:700>000000010000000000000006</span> / <span style=color:#0000cf;font-weight:700>000000010000000000000006</span>
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 44.5MB
</span></span><span style=display:flex><span>            repo1: backup size: 8.7MB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        diff backup: 20250715-013657F_20250715-013724D
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:37:24+00 / 2025-07-15 01:37:26+00
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 424.3KB
</span></span><span style=display:flex><span>            repo1: backup size: 94KB
</span></span><span style=display:flex><span>            backup reference total: <span style=color:#0000cf;font-weight:700>1</span> full
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        incr backup: 20250715-013657F_20250715-013730I
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:37:30+00 / 2025-07-15 01:37:31+00
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 8.3KB
</span></span><span style=display:flex><span>            repo1: backup size: 504B
</span></span><span style=display:flex><span>            backup reference total: <span style=color:#0000cf;font-weight:700>1</span> full, <span style=color:#0000cf;font-weight:700>1</span> diff</span></span></code></pre></div></div></div><p>这里的 <code>stanza</code> 是数据库集群名称：<a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a>，在默认配置中为 <code>pg-meta</code>。</p><p>Pigsty 提供了 <code>pb</code> 别名和 <code>pg-backup</code> 包装脚本，会自动填充当前集群名称作为 stanza：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pb<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>stanza</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>grep -o <span style=color:#4e9a06>&#39;\[[^][]*]&#39;</span> /etc/pgbackrest/pgbackrest.conf <span style=color:#000;font-weight:700>|</span> head -n1 <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/.*\[\([^]]*\)].*/\1/&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$stanza</span> <span style=color:#000>$@</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>pb ...    <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta ...</span>
</span></span><span style=display:flex><span>pb info   <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta info</span>
</span></span><span style=display:flex><span>pb backup <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta backup</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># 执行全量备份         = pgbackrest --stanza=pg-meta --type=full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># 执行增量备份         = pgbackrest --stanza=pg-meta --type=incr backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># 执行差异备份         = pgbackrest --stanza=pg-meta --type=diff backup</span>
</span></span></code></pre></div><hr><h2 id=定时备份>定时备份</h2><p>Pigsty 利用 Linux crontab 来调度备份任务。您可以用它定义备份策略。</p><p>例如，大多数单节点配置模板都有以下用于备份的 <a href=/docs/node/param#node_crontab><code>node_crontab</code></a>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您可以使用 crontab 和 <code>pg-backup</code> 脚本设计更复杂的备份策略，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 周一凌晨1点全量备份，工作日增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>要应用 crontab 变更，使用 <a href=/docs/node/playbook/#nodeyml><code>node.yml</code></a> 更新所有节点的 crontab：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_crontab -l pg-meta    <span style=color:#8f5902;font-style:italic># 将 crontab 变更应用到 pg-meta 组</span>
</span></span></code></pre></div><hr><h2 id=pgbackrest>pgbackrest</h2><p>以下是 Pigsty 对 pgbackrest 的配置细节：</p><ul><li>pgbackrest 备份工具默认已启用并配置（<a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a>）</li><li>在 <a href=/docs/pgsql/playbook/#pgsqlyml><code>pgsql.yml</code></a> 剧本的 <code>pg_install</code> 任务中安装，定义在 <a href=/docs/pgsql/param/#pg_packages><code>pg_packages</code></a></li><li>在 <a href=/docs/pgsql/playbook/#pgsqlyml><code>pgsql.yml</code></a> 剧本的 <code>pg_backup</code> 任务中配置，参见 <a href=/docs/pgsql/param/#pg_backup>参数：PG_BACKUP</a></li><li>在 <code>pgbackrest_init</code> 任务中初始化备份仓库，如果仓库已存在会失败（错误可忽略）</li><li>在 <code>pgbackrest_backup</code> 任务中创建初始备份，由 <a href=/docs/pgsql/param/#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a> 控制</li></ul><h3 id=文件层次结构>文件层次结构</h3><ul><li>bin：<code>/usr/bin/pgbackrest</code>，来自 PGDG 的 <code>pgbackrest</code> 包，在组别名 <code>pgsql-common</code> 中。</li><li>conf：<code>/etc/pgbackrest</code>，主配置文件是 <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pgbackrest.conf><code>/etc/pgbackrest/pgbackrest.conf</code></a>。</li><li>logs：<code>/pg/log/pgbackrest/*</code>，由 <a href=/docs/pgsql/param/#pgbackrest_log_dir><code>pgbackrest_log_dir</code></a> 控制</li><li>tmp：<code>/pg/spool</code> 用作 pgbackrest 的临时 spool 目录</li><li>data：<code>/pg/backup</code> 用于存储数据（当选择默认的 <code>local</code> 文件系统备份仓库时）</li></ul><p>此外，在 <a href=/docs/pgsql/backup/restore>PITR 恢复</a> 过程中，Pigsty 会创建临时的 <code>/pg/conf/pitr.conf</code> pgbackrest 配置文件，
并将 postgres 恢复日志写入 <code>/pg/tmp/recovery.log</code> 文件。</p><h3 id=监控>监控</h3><p>有一个 <code>pgbackrest_exporter</code> 服务运行在 <a href=/docs/pgsql/param/#pgbackrest_exporter_port><code>pgbackrest_exporter_port</code></a>（<code>9854</code>）端口上，用于导出 pgbackrest 指标。
您可以通过 <a href=/docs/pgsql/param/#pgbackrest_exporter_options><code>pgbackrest_exporter_options</code></a> 自定义它，
或将 <a href=/docs/pgsql/param/#pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></a> 设置为 <code>false</code> 来禁用它。</p><h3 id=初始备份>初始备份</h3><p>当创建 postgres 集群时，Pigsty 会自动创建初始备份。
由于新集群几乎为空，这是一个很小的备份。
它会留下一个 <code>/etc/pgbackrest/initial.done</code> 标记文件，以避免重复创建初始备份。
如果不需要初始备份，请将 <a href=/docs/pgsql/param/#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a> 设置为 <code>false</code>。</p><hr><h2 id=管理>管理</h2><h3 id=启用备份>启用备份</h3><p>如果数据库集群创建时 <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> 设置为 <code>true</code>，备份将自动启用。</p><p>如果创建时该值为 <code>false</code>，您可以使用以下命令启用 pgbackrest 组件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># 运行 pgbackrest 子任务</span>
</span></span></code></pre></div><h3 id=删除备份>删除备份</h3><p>当移除主实例（<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>）时，Pigsty 会删除 pgbackrest 备份 stanza。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># 保留备份</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># 仅删除备份</span>
</span></span></code></pre></div><p>使用 <code>pg_backup</code> 子任务仅删除备份，使用 <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> 参数（设为 <code>false</code>）保留备份。</p><p>如果您的备份仓库被<strong>锁定</strong>（例如 S3 / MinIO 有锁定选项），此操作将失败。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>备份删除</div><p>删除备份可能导致永久性数据丢失，这是一个危险操作，请务必谨慎。</p></div><h3 id=列出备份>列出备份</h3><p>此命令将列出 pgbackrest 仓库中的所有备份（所有集群共享）</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><h3 id=手动备份>手动备份</h3><p>Pigsty 提供了内置脚本 <code>/pg/bin/pg-backup</code>，封装了 <code>pgbackrest</code> 备份命令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># 执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># 执行差异备份</span>
</span></span></code></pre></div><h3 id=基础备份>基础备份</h3><p>Pigsty 提供了一个替代备份脚本 <code>/pg/bin/pg-basebackup</code>，它不依赖 <code>pgbackrest</code>，直接提供数据库集群的物理副本。
默认备份目录为 <code>/pg/backup</code>。</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     备份源 URL，可选，默认为 <span style=color:#4e9a06>&#34;postgres:///&#34;</span>，如需密码应在 url、ENV 或 .pgpass 中提供
</span></span><span style=display:flex><span>-d, --dst, --dir     备份文件存放位置，默认为 <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           覆盖默认备份文件名，<span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         删除 n 分钟前的 .lz4 文件，默认 1200（20小时）
</span></span><span style=display:flex><span>-t, --tag            备份文件标签，未设置时使用目标集群名或本地 IP 地址，也用于默认文件名
</span></span><span style=display:flex><span>-k, --key            指定 --encrypt 时的加密密钥，默认密钥为 <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         上传备份文件到云存储（需自行实现）
</span></span><span style=display:flex><span>-e, --encryption     使用 OpenSSL RC4 加密，未指定密钥时使用 tag 作为密钥
</span></span><span style=display:flex><span>-h, --help           打印此帮助信息</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>备份使用 <code>lz4</code> 压缩。您可以使用以下命令解压并提取 tarball：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># 将备份提取到此目录</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><h3 id=逻辑备份>逻辑备份</h3><p>您也可以使用 <code>pg_dump</code> 命令执行逻辑备份。</p><p>逻辑备份不能用于 PITR（时间点恢复），但对于在不同主版本之间迁移数据或实现灵活的数据导出逻辑非常有用。</p><h3 id=从仓库引导>从仓库引导</h3><p>假设您有一个现有集群 <code>pg-meta</code>，想要将其<strong>克隆</strong>为 <code>pg-meta2</code>：</p><p>您需要创建新的 <code>pg-meta2</code> 集群分支，然后在其上运行 <code>pitr</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e2aad9fad6e8fd1fba46059ad4ea7613>7.3 - 备份仓库</h1><div class=lead>PostgreSQL 备份存储仓库配置</div><p>您可以通过指定 <a href=/docs/pgsql/param/#pgbackrest_repo><code>pgbackrest_repo</code></a> 参数来配置备份<strong>存储位置</strong>。
您可以在此定义多个仓库，Pigsty 会根据 <a href=/docs/pgsql/param/#pgbackrest_method><code>pgbackrest_method</code></a> 的值选择使用哪个。</p><h2 id=默认仓库>默认仓库</h2><p>默认情况下，Pigsty 提供两个默认备份仓库定义：<code>local</code> 和 <code>minio</code> 备份仓库。</p><ul><li><code>local</code>：<strong>默认选项</strong>，使用本地 <code>/pg/backup</code> 目录（软链接指向 <a href=/docs/pgsql/param/#pg_fs_backup><code>pg_fs_backup</code></a>：<code>/data/backups</code>）</li><li><code>minio</code>：使用 SNSD 单节点 MinIO 集群（Pigsty 支持，但默认不启用）</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 选择备份仓库方法：`local`、`minio` 或其他自定义仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 使用本地 POSIX 文件系统的默认 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按数量保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，保留2个，最多3个全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 可选的 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 兼容 S3 协议</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认 us-east-1，对 minio 无实际意义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 使用路径风格 URI 而非主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA 证书路径，默认 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 启用块级增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成单个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包大小限制，对象存储建议 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包目标大小，对象存储建议 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按时间保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留最近 14 天的全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=仓库保留策略>仓库保留策略</h2><p>如果每天备份但不删除旧备份，备份仓库会不断增长并耗尽磁盘空间。
您需要定义保留策略，只保留有限数量的备份。</p><p>默认备份策略定义在 <a href=/docs/pgsql/param/#pgbackrest_repo><code>pgbackrest_repo</code></a> 参数中，可按需调整。</p><ul><li><code>local</code>：保留最近 <strong>2</strong> 个全量备份，备份期间最多允许 3 个</li><li><code>minio</code>：保留最近 <strong>14</strong> 天的所有全量备份</li></ul><hr><h2 id=空间规划>空间规划</h2><p>对象存储提供几乎无限的存储容量，因此无需担心磁盘空间。
您可以使用混合的全量 + 差异备份策略来优化空间使用。</p><p>对于本地磁盘备份仓库，Pigsty 建议使用保留最近 <strong>2</strong> 个全量备份的策略，
这意味着磁盘上保留两个最新的全量备份（运行新备份时可能存在第三个副本）。</p><p>这可保证至少 24 小时的恢复窗口。详情请参阅 <a href=/docs/pgsql/backup/policy/>备份策略</a>。</p><hr><h2 id=其他仓库选项>其他仓库选项</h2><p>您也可以使用其他服务作为备份仓库，详情请参阅 <a href=https://pgbackrest.org/user-guide.html>pgbackrest 文档</a>：</p><ul><li><a href=https://pgbackrest.org/user-guide.html#s3-support>S3 兼容对象存储</a></li><li><a href=https://pgbackrest.org/user-guide.html#azure-support>Azure 兼容对象存储</a></li><li><a href=https://pgbackrest.org/user-guide.html#gcs-support>GCS 兼容对象存储</a></li><li><a href=https://pgbackrest.org/user-guide.html#sftp-support>SFTP 支持</a></li></ul><hr><h2 id=仓库版本控制>仓库版本控制</h2><p>您甚至可以指定 <a href=https://pgbackrest.org/user-guide.html#sftp-support#repo-target-time>repo target time</a> 来获取对象存储的快照。</p><p>您可以通过在 <a href=/docs/minio/param#minio_buckets><code>minio_buckets</code></a> 中添加 <code>versioning</code> 标志来启用 MinIO 版本控制：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_buckets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgsql ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta  ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>data }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=仓库锁定>仓库锁定</h2><p>某些对象存储服务（S3、MinIO 等）支持<strong>锁定</strong>功能，可以防止备份被删除，即使是 DBA 本人也无法删除。</p><ul><li><a href=https://min.io/docs/minio/linux/administration/object-management/object-retention.html>MinIO 对象锁定</a></li><li><a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html>AWS S3：使用 Object Lock 锁定对象</a></li></ul><p>您可以通过在 <a href=/docs/minio/param#minio_buckets><code>minio_buckets</code></a> 中添加 <code>lock</code> 标志来启用 MinIO 锁定功能：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_buckets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgsql , lock</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>data }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=使用对象存储>使用对象存储</h2><p>对象存储服务提供几乎无限的存储容量，并为您的系统提供远程容灾能力。
如果您没有对象存储服务，Pigsty 内置了 <a href=/docs/minio>MinIO</a> 支持。</p><h3 id=minio>MinIO</h3><p>您可以通过取消注释以下设置来启用 MinIO 备份仓库。
请注意 pgbackrest 只支持 HTTPS / 域名，因此您必须使用域名和 HTTPS 端点运行 MinIO。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用 minio 作为默认备份仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># 定义一个单节点 minio SNSD 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq: 1 }} ,vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio }}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=s3>S3</h3><p>如果您只有<strong>一个</strong>节点，有意义的备份策略可以是使用云厂商的对象存储服务，如 AWS S3、阿里云 OSS 或 Google Cloud 等。
为此，您可以定义一个新仓库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用 &#39;pgbackrest_repo.s3&#39; 作为备份仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>s3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># 阿里云 OSS（S3 兼容）对象存储服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># oss 兼容 S3 协议</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oss-cn-beijing-internal.aliyuncs.com</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oss-cn-beijing</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_bucket_name&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_access_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_secret_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成单个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包大小限制，对象存储建议 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包目标大小，对象存储建议 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按时间保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留最近 14 天的全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 使用本地 POSIX 文件系统的默认 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按数量保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，保留2个，最多3个全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=管理备份>管理备份</h2><h3 id=启用备份>启用备份</h3><p>如果数据库集群创建时 <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> 设置为 <code>true</code>，备份将自动启用。</p><p>如果创建时该值为 <code>false</code>，您可以使用以下命令启用 pgbackrest 组件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># 运行 pgbackrest 子任务</span>
</span></span></code></pre></div><h3 id=删除备份>删除备份</h3><p>当移除主实例（<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>）时，Pigsty 会删除 pgbackrest 备份 stanza。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># 保留备份</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># 仅删除备份</span>
</span></span></code></pre></div><p>使用 <code>pg_backup</code> 子任务仅删除备份，使用 <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> 参数（设为 <code>false</code>）保留备份。</p><p>如果您的备份仓库被<strong>锁定</strong>（例如 S3 / MinIO 有锁定选项），此操作将失败。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>备份删除</div><p>删除备份可能导致永久性数据丢失，这是一个危险操作，请务必谨慎。</p></div><h3 id=列出备份>列出备份</h3><p>此命令将列出 pgbackrest 仓库中的所有备份（所有集群共享）</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><h3 id=手动备份>手动备份</h3><p>Pigsty 提供了内置脚本 <code>/pg/bin/pg-backup</code>，封装了 <code>pgbackrest</code> 备份命令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># 执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># 执行差异备份</span>
</span></span></code></pre></div><h3 id=基础备份>基础备份</h3><p>Pigsty 提供了一个替代备份脚本 <code>/pg/bin/pg-basebackup</code>，它不依赖 <code>pgbackrest</code>，直接提供数据库集群的物理副本。
默认备份目录为 <code>/pg/backup</code>。</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     备份源 URL，可选，默认为 <span style=color:#4e9a06>&#34;postgres:///&#34;</span>，如需密码应在 url、ENV 或 .pgpass 中提供
</span></span><span style=display:flex><span>-d, --dst, --dir     备份文件存放位置，默认为 <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           覆盖默认备份文件名，<span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         删除 n 分钟前的 .lz4 文件，默认 1200（20小时）
</span></span><span style=display:flex><span>-t, --tag            备份文件标签，未设置时使用目标集群名或本地 IP 地址，也用于默认文件名
</span></span><span style=display:flex><span>-k, --key            指定 --encrypt 时的加密密钥，默认密钥为 <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         上传备份文件到云存储（需自行实现）
</span></span><span style=display:flex><span>-e, --encryption     使用 OpenSSL RC4 加密，未指定密钥时使用 tag 作为密钥
</span></span><span style=display:flex><span>-h, --help           打印此帮助信息</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>备份使用 <code>lz4</code> 压缩。您可以使用以下命令解压并提取 tarball：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># 将备份提取到此目录</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><h3 id=逻辑备份>逻辑备份</h3><p>您也可以使用 <code>pg_dump</code> 命令执行逻辑备份。</p><p>逻辑备份不能用于 PITR（时间点恢复），但对于在不同主版本之间迁移数据或实现灵活的数据导出逻辑非常有用。</p><h3 id=从仓库引导>从仓库引导</h3><p>假设您有一个现有集群 <code>pg-meta</code>，想要将其<strong>克隆</strong>为 <code>pg-meta2</code>：</p><p>您需要创建新的 <code>pg-meta2</code> 集群分支，然后在其上运行 <code>pitr</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bd9fc4fbfbb9e33698d751afa14c6077>7.4 - 管理命令</h1><div class=lead>管理备份仓库和备份</div><h2 id=启用备份>启用备份</h2><p>如果数据库集群创建时 <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> 设置为 <code>true</code>，备份将自动启用。</p><p>如果创建时该值为 <code>false</code>，您可以使用以下命令启用 pgbackrest 组件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># 运行 pgbackrest 子任务</span>
</span></span></code></pre></div><hr><h2 id=删除备份>删除备份</h2><p>当移除主实例（<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>）时，Pigsty 会删除 pgbackrest 备份 stanza。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># 保留备份</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># 仅删除备份</span>
</span></span></code></pre></div><p>使用 <code>pg_backup</code> 子任务仅删除备份，使用 <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> 参数（设为 <code>false</code>）保留备份。</p><p>如果您的备份仓库被<strong>锁定</strong>（例如 S3 / MinIO 有锁定选项），此操作将失败。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>备份删除</div><p>删除备份可能导致永久性数据丢失，这是一个危险操作，请务必谨慎。</p></div><hr><h2 id=列出备份>列出备份</h2><p>此命令将列出 pgbackrest 仓库中的所有备份（所有集群共享）</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><hr><h2 id=手动备份>手动备份</h2><p>Pigsty 提供了内置脚本 <code>/pg/bin/pg-backup</code>，封装了 <code>pgbackrest</code> 备份命令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># 执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># 执行差异备份</span>
</span></span></code></pre></div><hr><h2 id=基础备份>基础备份</h2><p>Pigsty 提供了一个替代备份脚本 <code>/pg/bin/pg-basebackup</code>，它不依赖 <code>pgbackrest</code>，直接提供数据库集群的物理副本。
默认备份目录为 <code>/pg/backup</code>。</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     备份源 URL，可选，默认为 <span style=color:#4e9a06>&#34;postgres:///&#34;</span>，如需密码应在 url、ENV 或 .pgpass 中提供
</span></span><span style=display:flex><span>-d, --dst, --dir     备份文件存放位置，默认为 <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           覆盖默认备份文件名，<span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         删除 n 分钟前的 .lz4 文件，默认 1200（20小时）
</span></span><span style=display:flex><span>-t, --tag            备份文件标签，未设置时使用目标集群名或本地 IP 地址，也用于默认文件名
</span></span><span style=display:flex><span>-k, --key            指定 --encrypt 时的加密密钥，默认密钥为 <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         上传备份文件到云存储（需自行实现）
</span></span><span style=display:flex><span>-e, --encryption     使用 OpenSSL RC4 加密，未指定密钥时使用 tag 作为密钥
</span></span><span style=display:flex><span>-h, --help           打印此帮助信息</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>备份使用 <code>lz4</code> 压缩。您可以使用以下命令解压并提取 tarball：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># 将备份提取到此目录</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><hr><h2 id=逻辑备份>逻辑备份</h2><p>您也可以使用 <code>pg_dump</code> 命令执行逻辑备份。</p><p>逻辑备份不能用于 PITR（时间点恢复），但对于在不同主版本之间迁移数据或实现灵活的数据导出逻辑非常有用。</p><hr><h2 id=从仓库引导>从仓库引导</h2><p>假设您有一个现有集群 <code>pg-meta</code>，想要将其<strong>克隆</strong>为 <code>pg-meta2</code>：</p><p>您需要创建新的 <code>pg-meta2</code> 集群分支，然后在其上运行 <code>pitr</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ee98f0d297c9a6847c501efbbbed8fa6>7.5 - 恢复操作</h1><div class=lead>从备份恢复 PostgreSQL</div><p>您可以使用预配置的 pgbackrest 在 Pigsty 中执行时间点恢复（PITR）。</p><ul><li><a href=#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B><strong>剧本方式</strong></a>：使用 <code>pgsql-pitr.yml</code> 剧本自动执行 PITR</li><li><a href=/docs/pgsql/tutorial/pg-fork#pg-pitr><strong>手动方式</strong></a>：使用 <code>pg-pitr</code> 脚本手动执行 PITR</li></ul><hr><h2 id=快速上手>快速上手</h2><p>如果您想将 <code>pg-meta</code> 集群回滚到之前的时间点，添加 <code>pg_pitr</code> 参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-07-13 10:00:00+00&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 从最新备份恢复</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>然后运行 <code>pgsql-pitr.yml</code> 剧本，它将把 <code>pg-meta</code> 集群回滚到指定时间点。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta
</span></span></code></pre></div><hr><h2 id=恢复后处理>恢复后处理</h2><p>恢复后的集群会<strong>禁用</strong> <code>archive_mode</code>，以防止意外的 WAL 写入。
如果恢复后的数据库状态正常，您可以启用 <code>archive_mode</code> 并执行全量备份。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode; SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>pg-backup full    <span style=color:#8f5902;font-style:italic># 执行新的全量备份</span>
</span></span></code></pre></div><hr><h2 id=恢复目标>恢复目标</h2><p>您可以在 <code>pg_pitr</code> 中指定不同类型的恢复目标，但它们是互斥的：</p><ul><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TIME><code>time</code></a>：恢复到哪个时间点？</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-NAME><code>name</code></a>：恢复到命名的恢复点（由 <code>pg_create_restore_point</code> 创建）</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-XID><code>xid</code></a>：恢复到特定的事务 ID（TXID/XID）</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-LSN><code>lsn</code></a>：恢复到特定的 LSN（日志序列号）点</li></ul><p>如果指定了上述任何参数，恢复 <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TYPE><code>类型</code></a> 会相应设置，
否则将设置为 <code>latest</code>（WAL 归档流的末尾）。
特殊的 <code>immediate</code> 类型可用于指示 pgbackrest 通过在第一个一致点停止来最小化恢复时间。</p><h3 id=目标类型>目标类型</h3><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
恢复目标类型</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
latest</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
time</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
lsn</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
xid</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
name</button></li><li class=nav-item><button class=nav-link id=tabs-00-06-tab data-bs-toggle=tab data-bs-target=#tabs-00-06 role=tab aria-controls=tabs-00-06 aria-selected=false>
immediate</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 恢复到最新状态（WAL 归档流末尾）</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-07-13 10:00:00+00&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;0/4001C80&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;250000&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-06 role=tabpanel aria-labelled-by=tabs-00-06-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;immediate&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div></div><h3 id=按时间恢复>按时间恢复</h3><p>最常用的目标是时间点；您可以指定要恢复到的时间点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;time&#34;: &#34;2025-12-27 15:50:00+00&#34; }}&#39;</span>
</span></span></code></pre></div><p>时间应该是有效的 PostgreSQL <a href=https://www.postgresql.org/docs/current/datatype-datetime.html#DATATYPE-DATETIME-INPUT-TIME-STAMPS><code>TIMESTAMP</code></a> 格式，建议使用 <code>YYYY-MM-DD HH:MM:SS+TZ</code>。</p><h3 id=按名称恢复>按名称恢复</h3><p>您可以使用 <a href=https://www.postgresql.org/docs/current/functions-admin.html#id-1.5.8.34.5.5.2.2.1.1.1.1><code>pg_create_restore_point</code></a> 创建命名恢复点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_create_restore_point</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;shit_incoming&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>然后在 PITR 中使用该命名恢复点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;name&#34;: &#34;shit_incoming&#34; }}&#39;</span>
</span></span></code></pre></div><h3 id=按-xid-恢复>按 XID 恢复</h3><p>如果您有一个事务意外删除了某些数据，最好的恢复方式是将数据库恢复到该事务之前的状态。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;xid&#34;: &#34;250000&#34;, exclusive: true }}&#39;</span>
</span></span></code></pre></div><p>您可以从监控仪表盘找到确切的事务 ID，或从 CSVLOG 中的 <code>TXID</code> 字段获取。</p><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>包含与排除</div><p>目标参数默认是"包含"的，这意味着恢复会包含目标点。
<code>exclusive</code> 标志会排除该确切目标，例如 xid 24999 将是最后一个被重放的事务。</p><p>这仅适用于 <code>time</code>、<code>xid</code>、<code>lsn</code> 恢复目标，详情请参阅 <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-INCLUSIVE><code>recovery_target_inclusive</code></a>。</p></div><h3 id=按-lsn-恢复>按 LSN 恢复</h3><p>PostgreSQL 使用 <a href=https://www.postgresql.org/docs/current/datatype-pg-lsn.html>LSN</a>（日志序列号）来标识 WAL 记录的位置。
您可以在很多地方找到它，比如 Pigsty 仪表盘的 PG LSN 面板。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;lsn&#34;: &#34;0/4001C80&#34;, timeline: &#34;1&#34; }}&#39;</span>
</span></span></code></pre></div><p>要恢复到 WAL 流中的确切位置，您还可以指定 <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TIMELINE><code>timeline</code></a> 参数（默认为 <code>latest</code>）</p><hr><h2 id=恢复来源>恢复来源</h2><ul><li><code>cluster</code>：从哪个集群恢复？默认使用当前的 <code>pg_cluster</code>，您可以使用同一 pgbackrest 仓库中的任何其他集群</li><li><code>repo</code>：覆盖备份仓库，使用与 <code>pgbackrest_repo</code> 相同的格式</li><li><code>set</code>：默认使用 <code>latest</code> 备份集，但您可以通过标签指定特定的 pgbackrest 备份</li></ul><p>Pigsty 将从 pgbackrest 备份仓库恢复。如果您使用集中式备份仓库（如 MinIO/S3），
可以指定另一个 &ldquo;stanza&rdquo;（另一个集群的备份目录）作为恢复来源。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 从 pg-meta 集群备份恢复</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上述配置将标记 PITR 过程使用 <code>pg-meta</code> stanza。
您也可以通过 CLI 参数传递 <code>pg_pitr</code> 参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34; }}&#39;</span>
</span></span></code></pre></div><p>从另一个集群 PITR 时也可以使用这些目标：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-07-14 08:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div><hr><h2 id=分步执行>分步执行</h2><p>这种方式是半自动的，您将参与 PITR 过程以做出关键决策。</p><p>例如，此配置将把 <code>pg-meta</code> 集群本身恢复到指定时间点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-07-13 10:00:00+00&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 从最新备份恢复</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>让我们逐步执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t down     <span style=color:#8f5902;font-style:italic># 暂停 patroni 高可用</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t pitr     <span style=color:#8f5902;font-style:italic># 运行 pitr 过程</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t up       <span style=color:#8f5902;font-style:italic># 生成 pgbackrest 配置和恢复脚本</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># down                 : # 停止高可用并关闭 patroni 和 postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pause            : # 暂停 patroni 自动故障切换</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - stop             : # 停止 patroni 和 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_patroni   : # 停止 patroni 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_postgres  : # 停止 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pitr                 : # 执行 PITR 过程</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - config           : # 生成 pgbackrest 配置和恢复脚本</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - restore          : # 运行 pgbackrest 恢复命令</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - recovery         : # 启动 postgres 并完成恢复</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - verify           : # 验证恢复后的集群控制数据</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># up:                  : # 启动 postgres / patroni 并恢复高可用</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - etcd             : # 启动前清理 etcd 元数据</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - start            : # 启动 patroni 和 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_postgres : # 启动 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_patroni  : # 启动 patroni 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - resume           : # 恢复 patroni 自动故障切换</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=pitr-参数定义>PITR 参数定义</h2><p><code>pg_pitr</code> 参数还有更多可用选项：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># 定义 PITR 任务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_pg_cls_name&#34;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 源集群名称</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 恢复目标类型：time, xid, name, lsn, immediate, default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-01 10:00:00+00&#34;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 恢复目标：时间，与 xid, name, lsn 互斥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># 恢复目标：命名恢复点，与 time, xid, lsn 互斥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;100000&#34;</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 恢复目标：事务 ID，与 time, name, lsn 互斥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;0/3000000&#34;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 恢复目标：日志序列号，与 time, name, xid 互斥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>timeline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latest              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 目标时间线，可以是整数，默认为 latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>exclusive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 是否排除目标点，默认为 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>action</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pause                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 恢复后操作：pause, promote, shutdown</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>archive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 是否保留归档设置？默认为 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db_exclude</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>template0, template1 ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db_include</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>link_map</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_wal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/wal&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_xact</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/pg_xact&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>process</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 并行恢复进程数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># 恢复来源仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/data                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 数据恢复位置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 恢复实例的监听端口</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f811d9356784e47cdedcf860a7ba394a>7.6 - 克隆数据库集群</h1><div class=lead>如何利用 PITR 创建一个新的 PostgreSQL 集群，并恢复到指定时间点？</div><h2 id=快速上手>快速上手</h2><ul><li>利用 Standby Cluster 创建现有集群的在线副本</li><li>利用 PITR 创建现有集群的时间点快照</li><li>在 PITR 完成后进行善后，确保新集群的备份流程正常运行</li></ul><p>您可以使用 PG PITR 机制克隆整个数据库集群。</p><h2 id=重置一个集群的状态>重置一个集群的状态</h2><p>您也可以考虑创建一个全新的空集群，然后利用 PITR，将其重置为 <code>pg-meta</code> 集群的特定状态。</p><p>利用这种技术，您可以将现有集群 <code>pg-meta</code> 的任意时间点（备份保留期内）状态克隆到一个新的集群中。</p><p>我们依然以 Pigsty 4 节点沙箱环境为例，使用以下命令将 <code>pg-test</code> 集群重置为 <code>pg-meta</code> 集群的最新状态：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34; }}&#39;</span>
</span></span></code></pre></div><h2 id=pitr-善后工作>PITR 善后工作</h2><p>当你使用 PITR 恢复一个集群后，这个新集群本身的 PITR 功能是被禁用的。
因为如果它也尝试去生成备份，归档 WAL，有可能会写脏数据之前集群的备份仓库。</p><p>因此，当你确认这个 PITR 恢复出来的新集群状态符合预期后，你需要执行以下善后工作。</p><ul><li>升级备份仓库 Stanza，允许它接纳来自不同集群的新备份（仅当从别的集群恢复时）。</li><li>启用 <code>archive_mode</code>，允许新集群归档 WAL 日志（需要重启集群）</li><li>执行一个新的全量备份，确保新集群的数据被纳入（可选，也可以等 crontab 定时执行）</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pb stanza-upgrade
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode;&#39;</span>
</span></span><span style=display:flex><span>pg-backup full
</span></span></code></pre></div><p>通过这些操作，你的新集群将从第一次全量备份开始时，拥有自己的备份历史。
如果你跳过这些步骤，新集群本身的备份将无法进行，WAL 归档也不会生效。
意味着你将无法对新集群执行任何备份或 PITR 操作。</p><h2 id=不善后的后果>不善后的后果</h2><p>假设您在 <code>pg-test</code> 集群上执行了 PITR 恢复，使用了另外一个集群 <code>pg-meta</code> 的数据，但没有进行善后工作。</p><p>那么在下一次例行备份的时候，你会看到下面的错误：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-test-1:~$ pb backup
</span></span><span style=display:flex><span>2025-12-27 10:20:29.336 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.57.0: --annotation<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>pg_cluster</span><span style=color:#ce5c00;font-weight:700>=</span>pg-test --compress-type<span style=color:#ce5c00;font-weight:700>=</span>lz4 --delta --exec-id<span style=color:#ce5c00;font-weight:700>=</span>21034-171fb30b --expire-auto --log-level-console<span style=color:#ce5c00;font-weight:700>=</span>info --log-level-file<span style=color:#ce5c00;font-weight:700>=</span>info --log-path<span style=color:#ce5c00;font-weight:700>=</span>/pg/log/pgbackrest --pg1-path<span style=color:#ce5c00;font-weight:700>=</span>/pg/data --pg1-port<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5432</span> --repo1-block --repo1-bundle --repo1-bundle-limit<span style=color:#ce5c00;font-weight:700>=</span>20MiB --repo1-bundle-size<span style=color:#ce5c00;font-weight:700>=</span>128MiB --repo1-cipher-pass<span style=color:#ce5c00;font-weight:700>=</span>&lt;redacted&gt; --repo1-cipher-type<span style=color:#ce5c00;font-weight:700>=</span>aes-256-cbc --repo1-path<span style=color:#ce5c00;font-weight:700>=</span>/pgbackrest --repo1-retention-full<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>14</span> --repo1-retention-full-type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --repo1-s3-bucket<span style=color:#ce5c00;font-weight:700>=</span>pgsql --repo1-s3-endpoint<span style=color:#ce5c00;font-weight:700>=</span>sss.pigsty --repo1-s3-key<span style=color:#ce5c00;font-weight:700>=</span>&lt;redacted&gt; --repo1-s3-key-secret<span style=color:#ce5c00;font-weight:700>=</span>&lt;redacted&gt; --repo1-s3-region<span style=color:#ce5c00;font-weight:700>=</span>us-east-1 --repo1-s3-uri-style<span style=color:#ce5c00;font-weight:700>=</span>path --repo1-storage-ca-file<span style=color:#ce5c00;font-weight:700>=</span>/etc/pki/ca.crt --repo1-storage-port<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>9000</span> --repo1-type<span style=color:#ce5c00;font-weight:700>=</span>s3 --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-test --start-fast
</span></span><span style=display:flex><span>2025-12-27 10:20:29.357 P00  ERROR: <span style=color:#ce5c00;font-weight:700>[</span>051<span style=color:#ce5c00;font-weight:700>]</span>: PostgreSQL version 18, system-id <span style=color:#0000cf;font-weight:700>7588470953413201282</span> <span style=color:#204a87;font-weight:700>do</span> not match stanza version 18, system-id <span style=color:#0000cf;font-weight:700>7588470974940466058</span>
</span></span><span style=display:flex><span>                                    HINT: is this the correct stanza?
</span></span><span style=display:flex><span>2025-12-27 10:20:29.357 P00   INFO: backup <span style=color:#204a87>command</span> end: aborted with exception <span style=color:#ce5c00;font-weight:700>[</span>051<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>postgres@pg-test-1:~$
</span></span></code></pre></div><p>WAL 日志归档被 pgBackrest 关闭了，因此也不会有 WAL 归档。</p><h2 id=克隆一个新集群>克隆一个新集群</h2><p>例如，假设您有一个集群 <code>pg-meta</code>，现在你想要从 <code>pg-meta</code> 克隆一个 <code>pg-meta2</code> 的新集群。</p><p>您可以考虑使用 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4><strong>备份集群</strong></a> 的方式创建一个新的集群 <code>pg-meta2</code>。</p><p>pgBackrest 支持增量备份/还原，因此如果您已经通过物理复制拉取了 <code>pg-meta</code> 的数据，通常增量 PITR 还原会非常快。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>pb stop --force
</span></span><span style=display:flex><span>pb stanza-delete --force
</span></span><span style=display:flex><span>pb start
</span></span><span style=display:flex><span>pb stanza-create
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -t pg_backup -l pg-test -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>./pgsql.yml    -t pg_backup -l pg-test
</span></span></code></pre></div><p>如果您想要将 <code>pg-test</code> 集群重置为 <code>pg-meta</code> 集群在 2025 年 12 月 26 日 15:30 的状态，可以使用以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-12-27 17:50:00+08&#34; ,archive: true }}&#39;</span>
</span></span></code></pre></div><p>当然，您也可以直接创建一个全新的集群，然后使用 <code>pgsql-pitr.yml</code> 剧本从 <code>pg-meta</code> 恢复数据到新集群 <code>pg-meta2</code> 并顶替新集群的数据目录。</p><p>使用这种技术，您不仅可以克隆 <code>pg-meta</code> 集群的最新状态，还可以克隆到任意时间点，例如：</p></div><div class=td-content style=page-break-before:always><h1 id=pg-9f140ff0db86673b0d243757b9f578fc>8 - 数据迁移</h1><div class=lead>如何将现有的 PostgreSQL 集群以最小的停机时间迁移至新的、由Pigsty管理的 PostgreSQL 集群？</div><p>Pigsty 内置了一个剧本 <a href=https://github.com/Vonng/pigsty/blob/main/pgsql-migration.yml><code>pgsql-migration.yml</code></a> ，基于逻辑复制来实现在线数据库迁移。</p><p>通过预生成的自动化脚本，应用停机时间可以缩减到几秒内。但请注意，逻辑复制需要 PostgreSQL 10 以上的版本才能工作。</p><p>当然如果您有充足的停机时间预算，那么总是可以使用 <code>pg_dump | psql</code> 的方式进行停机迁移。</p><hr><h2 id=定义迁移任务>定义迁移任务</h2><p>想要使用Pigsty提供的在线迁移剧本，您需要创建一个定义文件，来描述迁移任务的细节。</p><p>请查看任务定义文件示例作为参考： <a href=https://github.com/Vonng/pigsty/blob/main/files/migration/pg-meta.yml><code>files/migration/pg-meta.yml</code></a> 。</p><p>这个迁移任务要将 <code>pg-meta.meta</code> 在线迁移到 <code>pg-test.test</code>，前者称为 <strong>源集群（SRC）</strong>， 后者称为 <strong>宿集群（DST）</strong>。</p><pre tabindex=0><code>pg-meta-1	10.10.10.10  --&gt; pg-test-1	10.10.10.11 (10.10.10.12,10.10.10.13)
</code></pre><p>基于逻辑复制的迁移以数据库为单位，您需要指定需要迁移的数据库名称，以及数据库源宿集群主节点的 IP 地址，以及超级用户的连接信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PG_MIGRATION</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>context_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~/migration </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 迁移手册 &amp; 脚本的放置目录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># SRC Cluster (旧集群)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_cls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 源集群名称                  &lt;必填&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 源数据库名称                &lt;必填&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 源集群主 IP                &lt;必填&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#src_pg: &#39;&#39;            # 如果定义，使用此作为源 dbsu pgurl 代替：</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # postgres://{{ pg_admin_username }}@{{ src_ip }}/{{ src_db }}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # 例如: &#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#sub_conn: &#39;&#39;          # 如果定义，使用此作为订阅连接字符串代替：</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # host={{ src_ip }} dbname={{ src_db }} user={{ pg_replication_username }}&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # 例如: &#39;host=10.10.10.10 dbname=meta user=replicator password=DBUser.Replicator&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># DST Cluster (新集群)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_cls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 宿集群名称                  &lt;必填&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 宿数据库名称                 &lt;必填&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 宿集群主 IP                &lt;必填&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#dst_pg: &#39;&#39;            # 如果定义，使用此作为目标 dbsu pgurl 代替：</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # postgres://{{ pg_admin_username }}@{{ dst_ip }}/{{ dst_db }}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                      # 例如: &#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.11:5432/test&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#-----------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>...</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>默认情况下，源宿集群两侧的超级用户连接串会使用全局的管理员用户和各自主库的 IP 地址拼接而成，但您总是可以通过 <code>src_pg</code> 和 <code>dst_pg</code> 参数来覆盖这些默认值。
同理，您也可以通过 <code>sub_conn</code> 参数来覆盖订阅连接串的默认值。</p><hr><h2 id=生成迁移计划>生成迁移计划</h2><p>此剧本不会主动完成集群的迁移工作，但它会生成迁移所需的操作手册与自动化脚本。</p><p>默认情况下，你会在 <code>~/migration/pg-meta.meta</code> 下找到迁移上下文目录。
按照 <code>README.md</code> 的说明，依次执行这些脚本，你就可以完成数据库迁移了！</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 激活迁移上下文：启用相关环境变量</span>
</span></span><span style=display:flex><span>. ~/migration/pg-meta.meta/activate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 这些脚本用于检查 src 集群状态，并帮助在 pigsty 中生成新的集群定义</span>
</span></span><span style=display:flex><span>./check-user     <span style=color:#8f5902;font-style:italic># 检查 src 用户</span>
</span></span><span style=display:flex><span>./check-db       <span style=color:#8f5902;font-style:italic># 检查 src 数据库</span>
</span></span><span style=display:flex><span>./check-hba      <span style=color:#8f5902;font-style:italic># 检查 src hba 规则</span>
</span></span><span style=display:flex><span>./check-repl     <span style=color:#8f5902;font-style:italic># 检查 src 复制身份</span>
</span></span><span style=display:flex><span>./check-misc     <span style=color:#8f5902;font-style:italic># 检查 src 特殊对象</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 这些脚本用于在现有的 src 集群和由 pigsty 管理的 dst 集群之间建立逻辑复制，除序列外的数据将实时同步</span>
</span></span><span style=display:flex><span>./copy-schema    <span style=color:#8f5902;font-style:italic># 将模式复制到目标</span>
</span></span><span style=display:flex><span>./create-pub     <span style=color:#8f5902;font-style:italic># 在 src 上创建发布</span>
</span></span><span style=display:flex><span>./create-sub     <span style=color:#8f5902;font-style:italic># 在 dst 上创建订阅</span>
</span></span><span style=display:flex><span>./copy-progress  <span style=color:#8f5902;font-style:italic># 打印逻辑复制进度</span>
</span></span><span style=display:flex><span>./copy-diff      <span style=color:#8f5902;font-style:italic># 通过计数表快速比较 src 和 dst 的差异</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 这些脚本将在线迁移中运行，该迁移将停止 src 集群，复制序列号（逻辑复制不复制序列号！）</span>
</span></span><span style=display:flex><span>./copy-seq <span style=color:#ce5c00;font-weight:700>[</span>n<span style=color:#ce5c00;font-weight:700>]</span>   <span style=color:#8f5902;font-style:italic># 同步序列号，如果给出了 n，则会应用额外的偏移</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 你必须根据你的访问方式（dns,vip,haproxy,pgbouncer等），将应用流量切换至新的集群！</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#./disable-src   # 将 src 集群访问限制为管理节点和新集群（你的实现）</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#./re-routing    # 从 SRC 到 DST 重新路由应用流量！（你的实现）</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 然后进行清理以删除订阅和发布</span>
</span></span><span style=display:flex><span>./drop-sub       <span style=color:#8f5902;font-style:italic># 迁移后在 dst 上删除订阅</span>
</span></span><span style=display:flex><span>./drop-pub       <span style=color:#8f5902;font-style:italic># 迁移后在 src 上删除发布</span>
</span></span></code></pre></div><p><strong>注意事项</strong></p><p>如果担心拷贝序列号时出现主键冲突，您可以在拷贝时将所有序列号向前推进一段距离，例如 +1000 ，你可以使用 <code>./copy-seq</code> 加一个参数 <code>1000</code> 来实现这一点。</p><p>你必须实现自己的 <code>./re-routing</code> 脚本，以将你的应用流量从 src 路由到 dst。 因为我们不知道你的流量是如何路由的（例如 dns, VIP, haproxy 或 pgbouncer）。 当然，您也可以手动完成这项操作&mldr;</p><p>你可以实现一个 <code>./disable-src</code> 脚本来限制应用对 src 集群的访问，这是可选的：如果你能确保所有应用流量都在 <code>./re-routing</code> 中干净利落地切完，其实不用这一步。</p><p>但如果您有未知来源的各种访问无法梳理干净，那么最好使用更为彻底的方式：更改 HBA 规则并重新加载来实现（推荐），或者只是简单粗暴地关停源主库上的 postgres、pgbouncer 或 haproxy 进程。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-30aee675be8bae1bfec9459ffb30d160>9 - 任务教程</h1><div class=lead>如何去完成单个任务。每个任务页面是一般通过给出若干步骤展示如何执行完成某事。</div></div><div class=td-content><h1 id=pg-39a4da4f2254a96928c0e56a6cb63c63>9.1 - 故障排查</h1><div class=lead>常见故障与分析排查思路</div><p>本文档列举了 PostgreSQL 和 Pigsty 中可能出现的故障，以及定位、处理、分析问题的 SOP。</p><hr><h2 id=磁盘空间写满>磁盘空间写满</h2><p>磁盘空间写满是最常见的故障类型。</p><h3 id=现象>现象</h3><p>当数据库所在磁盘空间耗尽时，PostgreSQL 将无法正常工作，可能出现以下现象：数据库日志反复报错"no space left on device"（磁盘空间不足），
新数据无法写入，甚至 PostgreSQL 可能触发 PANIC 强制关闭。</p><p>Pigsty 带有 NodeFsSpaceFull 告警规则，当文件系统可用空间不足 10% 时触发告警。
使用监控系统 NODE Instance 面板查阅 FS 指标面板定位问题。</p><h3 id=诊断>诊断</h3><p>您也可以登录数据库节点，使用 <code>df -h</code> 查看各挂载盘符使用率，确定哪个分区被写满。
对于数据库节点，重点检查以下目录及其大小，以判断是哪个类别的文件占满了空间：</p><ul><li><strong>数据目录</strong>（<code>/pg/data/base</code>）：存放表和索引的数据文件，大量写入与临时文件需要关注</li><li><strong>WAL目录</strong>（如 <code>pg/data/pg_wal</code>）：存放 PG WAL，WAL 堆积/复制槽保留是常见的磁盘写满原因。</li><li><strong>数据库日志目录</strong>（如 <code>pg/log</code>）：如果 PG 日志未及时轮转写大量报错写入，也可能占用大量空间。</li><li><strong>本地备份目录</strong>（如 <code>data/backups</code>）：使用 pgBackRest 等在本机保存备份时，也有可能撑满磁盘。</li></ul><p>如果问题出在 Pigsty 管理节点或监控节点，还需考虑：</p><ul><li><strong>监控数据</strong>：VictoriaMetrics 的时序指标和 VictoriaLogs 日志存储都会占用磁盘，可检查保留策略。</li><li><strong>对象存储数据</strong>：Pigsty 集成的 MinIO 对象存储可能会被用于 PG 备份保存。</li></ul><p>明确占用空间最大的目录后，可进一步使用 <code>du -sh &lt;目录></code> 深入查找特定大型文件或子目录。</p><h3 id=处理>处理</h3><p>磁盘写满属于紧急问题，需立即采取措施释放空间并保证数据库继续运行。
当数据盘并未与系统盘区分时，写满磁盘可能导致 Shell 命令无法执行。这种情况下，可以删除 <code>/pg/dummy</code> 占位文件，释放少量应急空间以便 shell 命令恢复正常。
如果数据库由于 pg_wal 写满已经宕机，清理空间后需要重启数据库服务并仔细检查数据完整性。</p><hr><h2 id=事务号回卷>事务号回卷</h2><p>PostgreSQL 循环使用 32 位事务ID (XID)，耗尽时会出现"事务号回卷"故障（XID Wraparound）。</p><h3 id=现象-1>现象</h3><p>第一阶段的典型征兆是 <a href=https://demo.pigsty.cc/d/pgsql-persist>PGSQL Persist - Age Usage</a> 面板年龄饱和度进入警告区域。
数据库日志开始出现：<code>WARNING: database "postgres" must be vacuumed within xxxxxxxx transactions</code> 字样的信息。</p><p>若问题持续恶化，PostgreSQL 会进入保护模式：当剩余事务ID不到约100万时数据库切换为只读模式；达到上限约21亿（2^31）时则拒绝任何新事务并迫使服务器停机以避免数据错误。</p><h3 id=诊断-1>诊断</h3><p>PostgreSQL 与 Pigsty 默认启用自动垃圾回收（AutoVacuum），因此此类故障出现通常有更深层次的根因。
常见的原因包括：超长事务（SAGE），Autovacuum 配置失当，复制槽阻塞，资源不足，存储引擎/扩展BUG，磁盘坏块。</p><p>首先定位年龄最大的数据库，然后可通过 Pigsty PGCAT Database - Tables 面板来确认表的年龄分布。
同时查阅数据库错误日志，通常可以找到定位根因的线索。</p><h3 id=处理-1>处理</h3><ol><li><strong>立即冻结老事务</strong>：如果数据库尚未进入只读保护状态，立刻对受影响的库执行一次手动 VACUUM FREEZE。可以从老化最严重的表开始逐个冻结，而不是整库一起做，以加快效果。使用超级用户连接数据库，针对识别出的 <code>relfrozenxid</code> 最大的表运行 <code>VACUUM FREEZE 表名;</code>，优先冻结那些XID年龄最大的表元组。这样可以迅速回收大量事务ID空间。</li><li><strong>单用户模式救援</strong>：如果数据库已经拒绝写入或宕机保护，此时需要启动数据库到单用户模式执行冻结操作。在单用户模式下运行 <code>VACUUM FREEZE database_name;</code> 对整个数据库进行冻结清理。完成后再以多用户模式重启数据库。这样做可以解除回卷锁定，让数据库重新可写。需要注意在单用户模式下操作要非常谨慎，并确保有足够的事务ID余量完成冻结。</li><li><strong>备用节点接管</strong>：在某些复杂场景（例如遭遇硬件问题导致 vacuum 无法完成），可考虑提升集群中的只读备节点为主，以获取一个相对干净的环境来处理冻结。例如主库因坏块导致无法 vacuum，此时可以手动Failover提升备库为新的主库，再对其进行紧急 vacuum freeze。确保新主库已冻结老事务后，再将负载切回来。</li></ol><hr><h2 id=连接耗尽>连接耗尽</h2><p>PostgreSQL 有一个最大连接数配置 (<code>max_connections</code>)，当客户端连接数超过此上限时，新的连接请求将被拒绝。典型现象是在应用端看到数据库无法连接，并报出类似
<strong>FATAL: remaining connection slots are reserved for non-replication superuser connections</strong> 或 <strong>too many clients already</strong> 的错误。
这表示普通连接数已用完，仅剩下保留给超管或复制的槽位</p><h3 id=诊断-2>诊断</h3><p>连接耗尽通常由客户端大量并发请求引起。您可以通过 PGCAT Instance / PGCAT Database / PGCAT Locks 直接查阅数据库当前的活跃会话。
并判断是什么样的查询填满了系统，并进行进一步的处理。特别需要关注是否存在大量 Idle in Transaction 状态的连接以及长时间运行的事务（以及慢查询）。</p><h3 id=处理-2>处理</h3><p><strong>杀查询</strong>：对于已经耗尽导致业务受阻的情况，通常立即使用 <code>pg_terminate_backend(pid)</code> 进行紧急降压。
对于使用连接池的情况，则可以调整连接池大小参数，并执行 reload 重载的方式减少数据库层面的连接数量。</p><p>您也可以修改 <code>max_connections</code> 参数为更大的值，但本参数需要重启数据库后才能生效。</p><hr><h2 id=etcd-配额写满>etcd 配额写满</h2><p>etcd 配额写满将导致 PG 高可用控制面失效，无法进行配置变更。</p><h3 id=诊断-3>诊断</h3><p>Pigsty 在实现高可用时使用 etcd 作为分布式配置存储(DCS)，etcd 自身有一个存储配额（默认约为2GB）。
当 etcd 存储用量达到配额上限时，etcd 将拒绝写入操作，报错 &ldquo;<strong>etcdserver: mvcc: database space exceeded</strong>"。在这种情况下，Patroni 无法向 etcd 写入心跳或更新配置，从而导致集群管理功能失效。</p><h3 id=解决>解决</h3><p>在 Pigsty v2.0.0 - v2.5.1 之间的版本默认受此问题影响。Pigsty v2.6.0 为部署的 etcd 新增了自动压实的配置项，如果您仅将其用于 PG 高可用租约，则常规用例下不会再有此问题。</p><hr><h2 id=有缺陷的存储引擎>有缺陷的存储引擎</h2><p>目前，TimescaleDB 的试验性存储引擎 Hypercore 被证实存在缺陷，已经出现 VACUUM 无法回收出现 XID 回卷故障的案例。
请使用该功能的用户及时迁移至 PostgreSQL 原生表或者 TimescaleDB 默认引擎</p><p>详细介绍：《<a href=https://mp.weixin.qq.com/s/LdZVVyOj4BA9C892I25lQw>PG新存储引擎故障案例</a>》</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e6716a8d517caddd0851177927c9c69c>9.2 - 误删处理</h1><div class=lead>处理误删数据，误删表，误删数据库</div><h2 id=误删数据>误删数据</h2><p>如果是小批量 <code>DELETE</code> 误操作，可以考虑使用 <a href=https://pgext.cloud/e/pg_surgery><code>pg_surgery</code></a> 或者 <a href=https://pgext.cloud/e/pg_dirtyread><code>pg_dirtyread</code></a> 扩展进行原地手术恢复。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 立即关闭此表上的 Auto Vacuum 并中止 Auto Vacuum 本表的 worker 进程
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>some_table</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>autovacuum_enabled</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>autovacuum_enabled</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dirtyread</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dirtyread</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;tablename&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#f8f8f8> </span><span style=color:#000>type1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>col2</span><span style=color:#f8f8f8> </span><span style=color:#000>type2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果被删除的数据已经被 VACUUM 回收，那么使用通用的误删处理流程。</p><h2 id=误删对象>误删对象</h2><p>当出现 <code>DROP/DELETE</code> 类误操作，通常按照以下流程决定恢复方案。</p><ol><li>确认此数据是否可以通过业务系统或其他数据系统找回，如果可以，直接从业务侧修复。</li><li>确认是否有延迟从库，如果有，推进延迟从库至误删时间点，查询出来恢复。</li><li>如果数据已经确认删除，确认备份信息，恢复范围是否覆盖误删时间点，如果覆盖，开始 PITR</li><li>确认是整集群原地 <a href=/docs/pgsql/backup/restore>PITR 回滚</a>，还是新开服务器重放，还是用从库来重放，并执行恢复策略</li></ol><h2 id=误删集群>误删集群</h2><p>如果出现整个数据库集群通过 Pigsty 管理命令被误删的情况，例如错误的执行 <a href=/docs/pgsql/playbook#pgsql-rmyml><code>pgsql-rm.yml</code></a> 剧本或 <code>bin/pgsql-rm</code> 命令。
除非您指定了 <a href=/docs/pgsql/param#pg_rm_backup><code>pg_rm_backup</code></a> 参数为 <code>false</code>，否则备份会与数据库集群一起被删除。</p><blockquote><p><strong>警告</strong>：在这种情况，您的数据将无法找回！<strong>请务必三思而后行！</strong></p></blockquote><p>建议：对于生产环境，您可以在配置清单中全局配置此参数为 <code>false</code>，在移除集群时保留备份。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-23871ed725b644a5e3d037862c0c13aa>9.3 - 手工恢复</h1><div class=lead>在沙箱环境中按照提示脚本手动执行 PITR</div><p>您可以使用 <code>pgsql-pitr.yml</code> 剧本执行 PITR，但在某些情况下，您可能希望手动执行 PITR，直接使用 pgbackrest 原语实现精细的控制。
我们将使用带有 MinIO 备份仓库的 <a href=/docs/deploy/sandbox><strong>四节点沙箱</strong></a> 集群来演示该过程。</p><p><img src=/img/pigsty/sandbox.png alt=pigsty-sandbox></p><hr><h2 id=初始化沙箱>初始化沙箱</h2><p>使用 <a href=/docs/deploy/vagrant><strong>vagrant</strong></a> 或 <a href=/docs/deploy/terraform><strong>terraform</strong></a> 准备四节点沙箱环境，然后：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty/
</span></span><span style=display:flex><span>./configure -c full
</span></span><span style=display:flex><span>./install
</span></span></code></pre></div><p>现在以管理节点上的管理员用户（或 dbsu）身份操作。</p><hr><h2 id=检查备份>检查备份</h2><p>要检查备份状态，您需要切换到 <code>postgres</code> 用户并使用 <code>pb</code> 命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres    <span style=color:#8f5902;font-style:italic># 切换到 dbsu: postgres 用户</span>
</span></span><span style=display:flex><span>pb info               <span style=color:#8f5902;font-style:italic># 打印 pgbackrest 备份信息</span>
</span></span></code></pre></div><p><code>pb</code> 是 <code>pgbackrest</code> 的别名，会自动从 pgbackrest 配置中获取 <code>stanza</code> 名称。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pb<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>stanza</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>grep -o <span style=color:#4e9a06>&#39;\[[^][]*]&#39;</span> /etc/pgbackrest/pgbackrest.conf <span style=color:#000;font-weight:700>|</span> head -n1 <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/.*\[\([^]]*\)].*/\1/&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$stanza</span> <span style=color:#000>$@</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>您可以看到初始备份信息，这是一个全量备份：</p><pre tabindex=0><code>root@pg-meta-1:~# pb info
stanza: pg-meta
    status: ok
    cipher: aes-256-cbc

    db (current)
        wal archive min/max (17): 000000010000000000000001/000000010000000000000007

        full backup: 20250713-022731F
            timestamp start/stop: 2025-07-13 02:27:31+00 / 2025-07-13 02:27:33+00
            wal start/stop: 000000010000000000000004 / 000000010000000000000004
            database size: 44MB, database backup size: 44MB
            repo1: backup size: 8.4MB
</code></pre><p>备份完成于 <code>2025-07-13 02:27:33+00</code>，这是您可以恢复到的最早时间。
由于 WAL 归档处于活动状态，您可以恢复到备份之后的任何时间点，直到 WAL 结束（即现在）。</p><hr><h2 id=生成心跳>生成心跳</h2><p>您可以生成一些心跳来模拟工作负载。<code>/pg-bin/pg-heartbeat</code> 就是用于此目的的，
它每秒向 <code>monitor.heartbeat</code> 表写入一个心跳时间戳。</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
心跳生成</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
alias</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
pgbench</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make rh     <span style=color:#8f5902;font-style:italic># 运行心跳: ssh 10.10.10.10 &#39;sudo -iu postgres /pg/bin/pg-heartbeat&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh 10.10.10.10 <span style=color:#4e9a06>&#39;sudo -iu postgres /pg/bin/pg-heartbeat&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>   cls   <span style=color:#000;font-weight:700>|</span>              ts               <span style=color:#000;font-weight:700>|</span>    lsn     <span style=color:#000;font-weight:700>|</span>  lsn_int  <span style=color:#000;font-weight:700>|</span> txid <span style=color:#000;font-weight:700>|</span> status  <span style=color:#000;font-weight:700>|</span>       now       <span style=color:#000;font-weight:700>|</span>  elapse
</span></span><span style=display:flex><span>---------+-------------------------------+------------+-----------+------+---------+-----------------+----------
</span></span><span style=display:flex><span> pg-meta <span style=color:#000;font-weight:700>|</span> 2025-07-13 03:01:20.318234+00 <span style=color:#000;font-weight:700>|</span> 0/115BF5C0 <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>291239360</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4812</span> <span style=color:#000;font-weight:700>|</span> leading <span style=color:#000;font-weight:700>|</span> 03:01:20.318234 <span style=color:#000;font-weight:700>|</span> 00:00:00</span></span></code></pre></div></div></div><p>您甚至可以向集群添加更多工作负载，让我们使用 <code>pgbench</code> 生成一些随机写入：</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pgbench 负载</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
alias</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
pgbench</button></li><li class=nav-item><button class=nav-link id=tabs-01-03-tab data-bs-toggle=tab data-bs-target=#tabs-01-03 role=tab aria-controls=tabs-01-03 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make ri     <span style=color:#8f5902;font-style:italic># 初始化 pgbench</span>
</span></span><span style=display:flex><span>make rw     <span style=color:#8f5902;font-style:italic># 运行 pgbench 读写工作负载</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -is10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> pgbench -nv -P1 -c4 --rate<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> -T10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-03 role=tabpanel aria-labelled-by=tabs-01-03-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> pgbench -nv -P1 -c4 --rate<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> -T10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>pgbench <span style=color:#ce5c00;font-weight:700>(</span>17.5 <span style=color:#ce5c00;font-weight:700>(</span>Homebrew<span style=color:#ce5c00;font-weight:700>)</span>, server 17.4 <span style=color:#ce5c00;font-weight:700>(</span>Ubuntu 17.4-1.pgdg24.04+2<span style=color:#ce5c00;font-weight:700>))</span>
</span></span><span style=display:flex><span>progress: 1.0 s, 60.9 tps, lat 7.295 ms stddev 4.219, <span style=color:#0000cf;font-weight:700>0</span> failed, lag 1.818 ms
</span></span><span style=display:flex><span>progress: 2.0 s, 69.1 tps, lat 6.296 ms stddev 1.983, <span style=color:#0000cf;font-weight:700>0</span> failed, lag 1.397 ms
</span></span><span style=display:flex><span>...</span></span></code></pre></div></div></div><hr><h2 id=pitr-手册>PITR 手册</h2><p>现在让我们选择一个恢复时间点，比如 <code>2025-07-13 03:03:03+00</code>，这是初始备份（和心跳）之后的一个时间点。
要执行手动 PITR，使用 <code>pg-pitr</code> 工具：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg-pitr -t <span style=color:#4e9a06>&#34;2025-07-13 03:03:00+00&#34;</span>
</span></span></code></pre></div><p>它会为您生成执行恢复的指令，通常需要四个步骤：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Perform <span style=color:#204a87>time</span> PITR on pg-meta
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>1. Stop PostgreSQL<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   1.1 Pause Patroni <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> there are any replicas<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ pg pause &lt;cls&gt;  <span style=color:#8f5902;font-style:italic># 暂停 patroni 自动故障切换</span>
</span></span><span style=display:flex><span>   1.2 Shutdown Patroni
</span></span><span style=display:flex><span>       $ pt-stop         <span style=color:#8f5902;font-style:italic># sudo systemctl stop patroni</span>
</span></span><span style=display:flex><span>   1.3 Shutdown Postgres
</span></span><span style=display:flex><span>       $ pg-stop         <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data stop -m fast</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2. Perform PITR<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   2.1 Restore Backup
</span></span><span style=display:flex><span>       $ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>   2.2 Start PG to Replay WAL
</span></span><span style=display:flex><span>       $ pg-start        <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data start</span>
</span></span><span style=display:flex><span>   2.3 Validate and Promote
</span></span><span style=display:flex><span>     - If database content is ok, promote it to finish recovery, otherwise goto 2.1
</span></span><span style=display:flex><span>       $ pg-promote      <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data promote</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>3. Restore Primary<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   3.1 Enable Archive Mode <span style=color:#ce5c00;font-weight:700>(</span>Restart Required<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM SET archive_mode = on;&#39;</span>
</span></span><span style=display:flex><span>   3.1 Restart Postgres to Apply Changes
</span></span><span style=display:flex><span>       $ pg-restart      <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data restart</span>
</span></span><span style=display:flex><span>   3.3 Restart Patroni
</span></span><span style=display:flex><span>       $ pt-restart      <span style=color:#8f5902;font-style:italic># sudo systemctl restart patroni</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>4. Restore Cluster<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   4.1 Re-Init All <span style=color:#ce5c00;font-weight:700>[</span>**REPLICAS**<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> any<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       - 4.1.1 option 1: restore replicas with same pgbackrest cmd <span style=color:#ce5c00;font-weight:700>(</span>require central backup repo<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           $ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>       - 4.1.2 option 2: nuke the replica data dir and restart patroni <span style=color:#ce5c00;font-weight:700>(</span>may take long <span style=color:#204a87>time</span> to restore<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           $ rm -rf /pg/data/*<span style=color:#000;font-weight:700>;</span> pt-restart
</span></span><span style=display:flex><span>       - 4.1.3 option 3: reinit with patroni, which may fail <span style=color:#204a87;font-weight:700>if</span> primary lsn &lt; replica lsn
</span></span><span style=display:flex><span>           $ pg reinit pg-meta
</span></span><span style=display:flex><span>   4.2 Resume Patroni
</span></span><span style=display:flex><span>       $ pg resume pg-meta
</span></span><span style=display:flex><span>   4.3 Full Backup <span style=color:#ce5c00;font-weight:700>(</span>optional<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ pg-backup full      <span style=color:#8f5902;font-style:italic># 建议在 PITR 后执行新的全量备份</span>
</span></span></code></pre></div><hr><h2 id=单节点示例>单节点示例</h2><p>让我们从简单的单节点 <code>pg-meta</code> 集群开始，作为一个更简单的示例。</p><h3 id=关闭数据库>关闭数据库</h3><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
关闭服务</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
shutdown patroni</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
shutdown postgres</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pt-stop         <span style=color:#8f5902;font-style:italic># sudo systemctl stop patroni，关闭 patroni（和 postgres）</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 可选，因为如果 patroni 未暂停，postgres 会被 patroni 关闭</span>
</span></span><span style=display:flex><span>$ pg_stop        <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data stop -m fast，关闭 postgres</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg_ctl: PID file <span style=color:#4e9a06>&#34;/pg/data/postmaster.pid&#34;</span> does not exist
</span></span><span style=display:flex><span>Is server running?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ pg-ps           <span style=color:#8f5902;font-style:italic># 打印 postgres 相关进程</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> UID         PID   PPID  C STIME TTY      STAT   TIME CMD
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>31048</span>      <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0</span> 02:27 ?        Ssl    0:19 /usr/sbin/pgbouncer /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>32026</span>      <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0</span> 02:28 ?        Ssl    0:03 /usr/bin/pg_exporter ...
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>35510</span>  <span style=color:#0000cf;font-weight:700>35480</span>  <span style=color:#0000cf;font-weight:700>0</span> 03:01 pts/2    S+     0:00 /bin/bash /pg/bin/pg-heartbeat</span></span></code></pre></div></div></div><p>确保本地 postgres 没有运行，然后执行手册中给出的恢复命令：</p><h3 id=恢复备份>恢复备份</h3><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab aria-controls=tabs-03-00 aria-selected=false>
恢复备份</button></li><li class=nav-item><button class="nav-link active" id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab aria-controls=tabs-03-01 aria-selected=true>
restore</button></li><li class=nav-item><button class=nav-link id=tabs-03-02-tab data-bs-toggle=tab data-bs-target=#tabs-03-02 role=tab aria-controls=tabs-03-02 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-pane fade" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-03-02 role=tabpanel aria-labelled-by=tabs-03-02-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>2025-07-13 03:17:07.443 P00   INFO: restore <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-13 03:17:07.470 P00   INFO: repo1: restore backup <span style=color:#204a87>set</span> 20250713-022731F, recovery will start at 2025-07-13 02:27:31
</span></span><span style=display:flex><span>2025-07-13 03:17:07.471 P00   INFO: remove invalid files/links/paths from <span style=color:#4e9a06>&#39;/pg/data&#39;</span>
</span></span><span style=display:flex><span>2025-07-13 03:17:08.523 P00   INFO: write updated /pg/data/postgresql.auto.conf
</span></span><span style=display:flex><span>2025-07-13 03:17:08.527 P00   INFO: restore <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 44MB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1436</span>
</span></span><span style=display:flex><span>2025-07-13 03:17:08.527 P00   INFO: restore <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1087ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div></div><h3 id=验证数据>验证数据</h3><p>我们不希望 patroni HA 接管，直到确定数据正确，所以手动启动 postgres：</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab aria-controls=tabs-04-00 aria-selected=false>
验证数据</button></li><li class=nav-item><button class="nav-link active" id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab aria-controls=tabs-04-01 aria-selected=true>
start postgres</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab aria-controls=tabs-04-02 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-pane fade" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-start</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>waiting <span style=color:#204a87;font-weight:700>for</span> server to start....2025-07-13 03:19:33.133 UTC <span style=color:#ce5c00;font-weight:700>[</span>39294<span style=color:#ce5c00;font-weight:700>]</span> LOG:  redirecting log output to logging collector process
</span></span><span style=display:flex><span>2025-07-13 03:19:33.133 UTC <span style=color:#ce5c00;font-weight:700>[</span>39294<span style=color:#ce5c00;font-weight:700>]</span> HINT:  Future log output will appear in directory <span style=color:#4e9a06>&#34;/pg/log/postgres&#34;</span>.
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>server started</span></span></code></pre></div></div></div><p>现在您可以检查数据，看看是否处于您想要的时间点。
您可以通过检查业务表中的最新时间戳来验证，或者在本例中通过心跳表检查。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ psql -c <span style=color:#4e9a06>&#39;table monitor.heartbeat&#39;</span>
</span></span><span style=display:flex><span>   id    <span style=color:#000;font-weight:700>|</span>              ts               <span style=color:#000;font-weight:700>|</span>    lsn    <span style=color:#000;font-weight:700>|</span> txid
</span></span><span style=display:flex><span>---------+-------------------------------+-----------+------
</span></span><span style=display:flex><span> pg-meta <span style=color:#000;font-weight:700>|</span> 2025-07-13 03:02:59.214104+00 <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>302005504</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4912</span>
</span></span></code></pre></div><p>时间戳正好在我们指定的时间点之前！（<code>2025-07-13 03:03:00+00</code>）。
如果这不是您想要的时间点，可以使用不同的时间点重复恢复。
由于恢复是以增量和并行方式执行的，速度非常快。
可以重试直到找到正确的时间点。</p><h3 id=提升主库>提升主库</h3><p>恢复后的 postgres 集群处于 <code>recovery</code> 模式，因此在提升为主库之前会拒绝任何写操作。
这些恢复参数是由 pgBackRest 在配置文件中生成的。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>postgres@pg-meta-1:~$ cat /pg/data/postgresql.auto.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Do not edit this file or use ALTER SYSTEM manually!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># It is managed by Pigsty &amp; Ansible automatically!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recovery settings generated by pgBackRest restore on 2025-07-13 03:17:08</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>archive_mode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;off&#39;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>restore_command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;pgbackrest --stanza=pg-meta archive-get %f &#34;%p&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>recovery_target_time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span>
</span></span></code></pre></div><p>如果数据正确，您可以<strong>提升</strong>它为主库，将其标记为新的领导者并准备接受写入。</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab aria-controls=tabs-05-00 aria-selected=false>
提升主库</button></li><li class=nav-item><button class="nav-link active" id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab aria-controls=tabs-05-01 aria-selected=true>
promote</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab aria-controls=tabs-05-02 aria-selected=false>
check</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-pane fade" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-promote
</span></span><span style=display:flex><span>waiting <span style=color:#204a87;font-weight:700>for</span> server to promote.... <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>server promoted</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_is_in_recovery()&#39;</span>   <span style=color:#8f5902;font-style:italic># &#39;f&#39; 表示已提升为主库</span>
</span></span><span style=display:flex><span> pg_is_in_recovery
</span></span><span style=display:flex><span>-------------------
</span></span><span style=display:flex><span> f
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> row<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>新时间线和脑裂</div><p>一旦提升，数据库集群将进入新的时间线（领导者纪元）。
如果有任何写流量，将写入新的时间线。</p></div><h3 id=恢复集群>恢复集群</h3><p>最后，不仅需要恢复数据，还需要恢复集群状态，例如：</p><ul><li>patroni 接管</li><li>归档模式</li><li>备份集</li><li>从库</li></ul><h4 id=patroni-接管>Patroni 接管</h4><p>您的 postgres 是直接启动的，要恢复 HA 接管，您需要启动 patroni 服务：</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab aria-controls=tabs-07-00 aria-selected=false>
Patroni 接管</button></li><li class=nav-item><button class="nav-link active" id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab aria-controls=tabs-07-01 aria-selected=true>
launch patroni</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab aria-controls=tabs-07-02 aria-selected=false>
resume patroni</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-pane fade" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pt-start   <span style=color:#8f5902;font-style:italic># sudo systemctl start patroni</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume pg-meta      <span style=color:#8f5902;font-style:italic># 恢复 patroni 自动故障切换（如果之前暂停过）</span></span></span></code></pre></div></div></div><h4 id=归档模式>归档模式</h4><p><code>archive_mode</code> 在恢复期间被 pgbackrest 禁用。
如果您希望新领导者的写入归档到备份仓库，还需要启用 <code>archive_mode</code> 配置。</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab aria-controls=tabs-08-00 aria-selected=false>
归档模式</button></li><li class=nav-item><button class="nav-link active" id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab aria-controls=tabs-08-01 aria-selected=true>
check archive_mode</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab aria-controls=tabs-08-02 aria-selected=false>
reset archive_mode</button></li><li class=nav-item><button class=nav-link id=tabs-08-03-tab data-bs-toggle=tab data-bs-target=#tabs-08-03 role=tab aria-controls=tabs-08-03 aria-selected=false>
edit directly</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-pane fade" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;show archive_mode&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> archive_mode
</span></span><span style=display:flex><span>--------------
</span></span><span style=display:flex><span> off</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode;&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;show archive_mode&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-08-03 role=tabpanel aria-labelled-by=tabs-08-03-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 您也可以直接编辑 postgresql.auto.conf 并使用 pg_ctl 重载</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;/archive_mode/d&#39;</span> /pg/data/postgresql.auto.conf
</span></span><span style=display:flex><span>pg_ctl -D /pg/data reload</span></span></code></pre></div></div></div><h4 id=备份集>备份集</h4><p>通常建议在 PITR 后执行新的全量备份，但这是可选的。</p><h4 id=从库>从库</h4><p>如果您的 postgres 集群有从库，您也需要在每个从库上执行 PITR。
或者，更简单的方法是删除从库数据目录并重启 patroni，这将从主库重新初始化从库。
我们将在下一个多节点集群示例中介绍这种情况。</p><hr><h2 id=多节点示例>多节点示例</h2><p>现在让我们以三节点 <code>pg-test</code> 集群作为 PITR 示例。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-febcd9ad443b4eae6bee9e48b3f2d10e>9.4 - 利用 xfs 实现实例 Fork</h1><div class=lead>在同一台机器上克隆实例并执行时间点恢复</div><p>Pigsty 提供了两个实用脚本，用于在同一台机器上快速克隆实例并执行时间点恢复：</p><ul><li><a href=#pg-fork><code>pg-fork</code></a>：在同一台机器上快速克隆一个新的 PostgreSQL 实例</li><li><a href=#pg-pitr><code>pg-pitr</code></a>：使用 pgbackrest 手动执行时间点恢复</li></ul><p>这两个脚本可以配合使用：先用 <code>pg-fork</code> 克隆实例，再用 <code>pg-pitr</code> 将克隆实例恢复到指定时间点。</p><hr><h2 id=pg-fork>pg-fork</h2><p><a href=https://github.com/pgsty/pigsty/blob/main/files/postgres/pg-fork><code>pg-fork</code></a> 可以在同一台机器上快速克隆一个新的 PostgreSQL 实例。</p><h3 id=快速上手>快速上手</h3><p>使用 <code>postgres</code> 用户（dbsu）执行以下命令，即可创建一个新的实例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span>                         <span style=color:#8f5902;font-style:italic># 从 /pg/data 克隆到 /pg/data1，端口 15432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>2</span> -d /pg/data1            <span style=color:#8f5902;font-style:italic># 从 /pg/data1 克隆到 /pg/data2，端口 25432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>3</span> -D /tmp/test -P <span style=color:#0000cf;font-weight:700>5555</span>    <span style=color:#8f5902;font-style:italic># 克隆到自定义目录和端口</span>
</span></span></code></pre></div><p>克隆完成后，可以启动并访问新实例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_ctl -D /pg/data1 start         <span style=color:#8f5902;font-style:italic># 启动克隆实例</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span>                     <span style=color:#8f5902;font-style:italic># 连接克隆实例</span>
</span></span></code></pre></div><h3 id=命令语法>命令语法</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-fork &lt;FORK_ID&gt; <span style=color:#ce5c00;font-weight:700>[</span>options<span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><p><strong>必填参数：</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>&lt;FORK_ID></code></td><td>克隆实例编号（1-9），决定默认端口和数据目录</td></tr></tbody></table><p><strong>可选参数：</strong></p><table><thead><tr><th>参数</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>-d, --data &lt;datadir></code></td><td>源实例数据目录</td><td><code>/pg/data</code> 或 <code>$PG_DATA</code></td></tr><tr><td><code>-D, --dst &lt;dst_dir></code></td><td>目标数据目录</td><td><code>/pg/data&lt;FORK_ID></code></td></tr><tr><td><code>-p, --port &lt;port></code></td><td>源实例端口</td><td><code>5432</code> 或 <code>$PG_PORT</code></td></tr><tr><td><code>-P, --dst-port &lt;port></code></td><td>目标实例端口</td><td><code>&lt;FORK_ID>5432</code></td></tr><tr><td><code>-s, --skip</code></td><td>跳过备份 API，使用冷拷贝模式</td><td>-</td></tr><tr><td><code>-y, --yes</code></td><td>跳过确认提示</td><td>-</td></tr><tr><td><code>-h, --help</code></td><td>显示帮助信息</td><td>-</td></tr></tbody></table><h3 id=使用示例>使用示例</h3><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
pg-fork 示例</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
基础克隆</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
指定源端口</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
链式克隆</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
自定义位置</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
冷拷贝模式</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从默认实例克隆到 /pg/data1，端口 15432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从默认实例克隆到 /pg/data2，端口 25432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>2</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从端口 5433 的实例克隆</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -p <span style=color:#0000cf;font-weight:700>5433</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用环境变量指定源端口</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5433</span> pg-fork <span style=color:#0000cf;font-weight:700>1</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从 /pg/data1 克隆到 /pg/data2</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>2</span> -d /pg/data1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从 /pg/data2 克隆到 /pg/data3</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>3</span> -d /pg/data2</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 克隆到自定义目录和端口</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -D /tmp/pgtest -P <span style=color:#0000cf;font-weight:700>5555</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 完全自定义</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -d /pg/data -D /mnt/backup/pgclone -P <span style=color:#0000cf;font-weight:700>6543</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 源实例已停止时使用冷拷贝</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 跳过确认直接执行</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -s -y</span></span></code></pre></div></div></div><h3 id=工作原理>工作原理</h3><p><code>pg-fork</code> 支持两种工作模式：</p><p><strong>热备份模式</strong>（默认，源实例运行中）：</p><ol><li>调用 <code>pg_backup_start()</code> 开始备份</li><li>使用 <code>cp --reflink=auto</code> 拷贝数据目录</li><li>调用 <code>pg_backup_stop()</code> 结束备份</li><li>修改配置文件，避免与源实例冲突</li></ol><p><strong>冷拷贝模式</strong>（使用 <code>-s</code> 参数或源实例未运行）：</p><ol><li>直接使用 <code>cp --reflink=auto</code> 拷贝数据目录</li><li>修改配置文件</li></ol><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>CoW 快速克隆</div><p>如果您使用 XFS（启用 reflink）、Btrfs 或 ZFS 文件系统，<code>pg-fork</code> 会利用 <strong>Copy-on-Write</strong> 特性，
数据目录拷贝在几百毫秒内完成，且几乎不占用额外存储空间。只有在数据被修改时才会分配新的存储块。</p></div><h3 id=克隆后配置>克隆后配置</h3><p><code>pg-fork</code> 会自动修改克隆实例的以下配置：</p><table><thead><tr><th>配置项</th><th>修改内容</th></tr></thead><tbody><tr><td><code>port</code></td><td>改为目标端口（避免冲突）</td></tr><tr><td><code>archive_mode</code></td><td>设为 <code>off</code>（避免污染 WAL 归档）</td></tr><tr><td><code>log_directory</code></td><td>设为 <code>log</code>（使用数据目录下的日志）</td></tr><tr><td><code>primary_conninfo</code></td><td>移除（创建独立实例）</td></tr><tr><td><code>standby.signal</code></td><td>移除（创建独立实例）</td></tr><tr><td><code>pg_replslot/*</code></td><td>清空（避免复制槽冲突）</td></tr></tbody></table><h3 id=典型工作流>典型工作流</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 克隆实例用于测试</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 启动克隆实例</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 在克隆实例上测试（不影响生产）</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span> -c <span style=color:#4e9a06>&#34;DROP TABLE important_data;&#34;</span>  <span style=color:#8f5902;font-style:italic># 安全测试</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. 测试完成后清理</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 stop
</span></span><span style=display:flex><span>rm -rf /pg/data1
</span></span></code></pre></div><hr><h2 id=pg-pitr>pg-pitr</h2><p><a href=https://github.com/pgsty/pigsty/blob/main/files/postgres/pg-pitr><code>pg-pitr</code></a> 是一个用于手动执行时间点恢复的脚本，基于 pgbackrest。</p><h3 id=快速上手-1>快速上手</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr -d                                  <span style=color:#8f5902;font-style:italic># 恢复到最新状态</span>
</span></span><span style=display:flex><span>pg-pitr -i                                  <span style=color:#8f5902;font-style:italic># 恢复到备份完成时间</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-01-01 12:00:00+08&#34;</span>         <span style=color:#8f5902;font-style:italic># 恢复到指定时间点</span>
</span></span><span style=display:flex><span>pg-pitr -n my-savepoint                     <span style=color:#8f5902;font-style:italic># 恢复到命名恢复点</span>
</span></span><span style=display:flex><span>pg-pitr -l <span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span>                      <span style=color:#8f5902;font-style:italic># 恢复到指定 LSN</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>12345678</span> -X                      <span style=color:#8f5902;font-style:italic># 恢复到事务之前</span>
</span></span><span style=display:flex><span>pg-pitr -b 20251225-120000F                 <span style=color:#8f5902;font-style:italic># 恢复到指定备份集</span>
</span></span></code></pre></div><h3 id=命令语法-1>命令语法</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr <span style=color:#ce5c00;font-weight:700>[</span>options<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>recovery_target<span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><p><strong>恢复目标（选择一个）：</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>-d, --default</code></td><td>恢复到 WAL 归档流末尾（最新状态）</td></tr><tr><td><code>-i, --immediate</code></td><td>恢复到数据库一致性点（最快恢复）</td></tr><tr><td><code>-t, --time &lt;timestamp></code></td><td>恢复到指定时间点</td></tr><tr><td><code>-n, --name &lt;restore_point></code></td><td>恢复到命名恢复点</td></tr><tr><td><code>-l, --lsn &lt;lsn></code></td><td>恢复到指定 LSN</td></tr><tr><td><code>-x, --xid &lt;xid></code></td><td>恢复到指定事务 ID</td></tr><tr><td><code>-b, --backup &lt;label></code></td><td>恢复到指定备份集</td></tr></tbody></table><p><strong>可选参数：</strong></p><table><thead><tr><th>参数</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>-D, --data &lt;path></code></td><td>恢复目标数据目录</td><td><code>/pg/data</code></td></tr><tr><td><code>-s, --stanza &lt;name></code></td><td>pgbackrest stanza 名称</td><td>自动检测</td></tr><tr><td><code>-X, --exclusive</code></td><td>排除目标点（恢复到目标之前）</td><td>-</td></tr><tr><td><code>-P, --promote</code></td><td>恢复后自动提升（默认暂停）</td><td>-</td></tr><tr><td><code>-c, --check</code></td><td>干运行模式，仅打印命令</td><td>-</td></tr><tr><td><code>-y, --yes</code></td><td>跳过确认和倒计时</td><td>-</td></tr><tr><td><code>-h, --help</code></td><td>显示帮助信息</td><td>-</td></tr></tbody></table><h3 id=恢复目标类型>恢复目标类型</h3><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
恢复目标</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
latest</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
immediate</button></li><li class=nav-item><button class=nav-link id=tabs-02-03-tab data-bs-toggle=tab data-bs-target=#tabs-02-03 role=tab aria-controls=tabs-02-03 aria-selected=false>
time</button></li><li class=nav-item><button class=nav-link id=tabs-02-04-tab data-bs-toggle=tab data-bs-target=#tabs-02-04 role=tab aria-controls=tabs-02-04 aria-selected=false>
name</button></li><li class=nav-item><button class=nav-link id=tabs-02-05-tab data-bs-toggle=tab data-bs-target=#tabs-02-05 role=tab aria-controls=tabs-02-05 aria-selected=false>
lsn</button></li><li class=nav-item><button class=nav-link id=tabs-02-06-tab data-bs-toggle=tab data-bs-target=#tabs-02-06 role=tab aria-controls=tabs-02-06 aria-selected=false>
xid</button></li><li class=nav-item><button class=nav-link id=tabs-02-07-tab data-bs-toggle=tab data-bs-target=#tabs-02-07 role=tab aria-controls=tabs-02-07 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到 WAL 归档流末尾（最新状态）</span>
</span></span><span style=display:flex><span>pg-pitr -d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 这是默认行为，会重放所有可用的 WAL</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到数据库一致性点</span>
</span></span><span style=display:flex><span>pg-pitr -i
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 最快的恢复方式，不重放额外的 WAL</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 适用于快速验证备份是否可用</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-03 role=tabpanel aria-labelled-by=tabs-02-03-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定时间点</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-01-01 12:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 UTC 时间</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-01-01 04:00:00+00&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 时间格式：YYYY-MM-DD HH:MM:SS[.usec][+/-TZ]</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-04 role=tabpanel aria-labelled-by=tabs-02-04-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到命名恢复点</span>
</span></span><span style=display:flex><span>pg-pitr -n my-savepoint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复点需要事先使用 pg_create_restore_point() 创建</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># SELECT pg_create_restore_point(&#39;my-savepoint&#39;);</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-05 role=tabpanel aria-labelled-by=tabs-02-05-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定 LSN</span>
</span></span><span style=display:flex><span>pg-pitr -l <span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># LSN 可以从监控面板或 pg_current_wal_lsn() 获取</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-06 role=tabpanel aria-labelled-by=tabs-02-06-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定事务 ID</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>12345678</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到事务之前（不包含该事务）</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>12345678</span> -X</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-07 role=tabpanel aria-labelled-by=tabs-02-07-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定备份集</span>
</span></span><span style=display:flex><span>pg-pitr -b 20251225-120000F
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看可用备份集</span>
</span></span><span style=display:flex><span>pgbackrest info</span></span></code></pre></div></div></div><h3 id=使用示例-1>使用示例</h3><p><strong>恢复到指定时间点：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 停止 PostgreSQL</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data stop -m fast
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 执行 PITR</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 启动并验证</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data start
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;SELECT * FROM important_table;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. 确认无误后提升</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data promote
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. 启用归档并执行新备份</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;ALTER SYSTEM SET archive_mode = on;&#34;</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data restart
</span></span><span style=display:flex><span>pg-backup full
</span></span></code></pre></div><p><strong>恢复到克隆实例：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 克隆实例</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 在克隆实例上执行 PITR</span>
</span></span><span style=display:flex><span>pg-pitr -D /pg/data1 -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 启动克隆实例验证</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 start
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span>
</span></span></code></pre></div><p><strong>干运行模式：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 仅打印命令，不执行</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span> -c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 输出示例：</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Command:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   pgbackrest --stanza=pg-meta --delta --force --type=time --target=&#34;2025-12-27 10:00:00+08&#34; restore</span>
</span></span></code></pre></div><h3 id=恢复后处理>恢复后处理</h3><p>恢复完成后，实例会处于<strong>恢复暂停</strong>状态（除非使用 <code>-P</code> 参数）。您需要：</p><ol><li><strong>启动实例</strong>：<code>pg_ctl -D /pg/data start</code></li><li><strong>验证数据</strong>：检查数据是否符合预期</li><li><strong>提升实例</strong>：<code>pg_ctl -D /pg/data promote</code></li><li><strong>启用归档</strong>：<code>psql -c "ALTER SYSTEM SET archive_mode = on;"</code></li><li><strong>重启实例</strong>：<code>pg_ctl -D /pg/data restart</code></li><li><strong>执行备份</strong>：<code>pg-backup full</code></li></ol><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>重要提示</div><p>恢复后的实例 <code>archive_mode</code> 被设为 <code>off</code>，以防止意外的 WAL 写入污染归档仓库。
确认数据正确后，务必重新启用归档并执行全量备份。</p></div><hr><h2 id=组合使用>组合使用</h2><p><code>pg-fork</code> 和 <code>pg-pitr</code> 可以组合使用，实现安全的 PITR 验证流程：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 克隆当前实例</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 在克隆实例上执行 PITR（不影响生产）</span>
</span></span><span style=display:flex><span>pg-pitr -D /pg/data1 -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 启动克隆实例</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. 验证恢复结果</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span> -c <span style=color:#4e9a06>&#34;SELECT count(*) FROM orders WHERE created_at &lt; &#39;2025-12-27 10:00:00&#39;;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. 确认无误后，可以选择：</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#    - 方案A：在生产实例上执行相同的 PITR</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#    - 方案B：将克隆实例提升为新的生产实例</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 6. 清理测试实例</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 stop
</span></span><span style=display:flex><span>rm -rf /pg/data1
</span></span></code></pre></div><hr><h2 id=注意事项>注意事项</h2><h3 id=运行要求>运行要求</h3><ul><li>必须以 <code>postgres</code> 用户（或 postgres 组成员）执行</li><li><code>pg-pitr</code> 执行前必须停止目标实例的 PostgreSQL</li><li><code>pg-fork</code> 热备份模式需要源实例正在运行</li></ul><h3 id=文件系统>文件系统</h3><ul><li>推荐使用 XFS（启用 reflink）或 Btrfs 文件系统</li><li>CoW 文件系统上克隆几乎瞬间完成，且不占用额外空间</li><li>非 CoW 文件系统会执行完整拷贝，耗时较长</li></ul><h3 id=端口规划>端口规划</h3><table><thead><tr><th>FORK_ID</th><th>默认端口</th><th>默认数据目录</th></tr></thead><tbody><tr><td>1</td><td>15432</td><td>/pg/data1</td></tr><tr><td>2</td><td>25432</td><td>/pg/data2</td></tr><tr><td>3</td><td>35432</td><td>/pg/data3</td></tr><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr><tr><td>9</td><td>95432</td><td>/pg/data9</td></tr></tbody></table><h3 id=安全建议>安全建议</h3><ul><li>克隆实例仅用于测试和验证，不应长期运行</li><li>验证完成后及时清理克隆实例</li><li>生产环境 PITR 建议使用 <code>pgsql-pitr.yml</code> 剧本</li><li>重要操作前先使用 <code>-c</code> 干运行模式确认命令</li></ul><h2 id=原理剖析>原理剖析</h2><p>有时候，您想要用现有的 PostgreSQL 实例在 <strong>同一台机器</strong> 上创建一个新的实例 （用于测试，PITR 恢复），可以使用 <code>postgres</code> 用户执行下面的命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>CHECKPOINT;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT pg_backup_start(&#39;pgfork&#39;, true);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>\! rm -rf /pg/data2 &amp;&amp; cp -r --reflink=auto /pg/data /pg/data2 &amp;&amp; ls -alhd /pg/data2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT * FROM pg_backup_stop(false);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改配置，避免与现有实例冲突：端口，日志，归档等</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;s/^port.*/port = 5431/&#39;</span> /pg/data2/postgresql.conf<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;s/^log_destination.*/log_destination = stderr/&#39;</span> /pg/data2/postgresql.conf<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;s/^archive_mode.*/archive_mode = off/&#39;</span> /pg/data2/postgresql.conf<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>rm -rf /pg/data2/postmaster.pid /pg/data2/postmaster.opts
</span></span><span style=display:flex><span>pg_ctl -D /pg/data2 start -l /pg/log/pgfork.log
</span></span><span style=display:flex><span>pg_ctl -D /pg/data2 stop
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>5431</span>  <span style=color:#8f5902;font-style:italic># 访问新实例</span>
</span></span></code></pre></div><p>上面的命令会创建一个新的数据目录 <code>/pg/data2</code>，它是现有数据目录 <code>/pg/data</code> 的一个完整拷贝。
如果您使用的是 XFS （启用了 reflink COW 特性），那么同磁盘拷贝目录会非常快，通常几百毫秒的常数时间内即可完成。</p><p>您在原地拉起新实例前，<strong>务必</strong> 修改 <code>postgresql.conf</code> 里的 <code>port</code> / <code>archive_mode</code> / <code>log_destination</code> 参数，避免影响现有生产实例等运行。
您可以使用一个没有被占用的端口，例如 <code>5431</code>，并将日志输出到 <code>/pg/log/xxxx.log</code> 避免写脏现有实例的日志文件。</p><p>我们建议同时修改 <code>shared_buffers</code> Pigsty 默认情况通常分配 25% 的系统内存给 PostgreSQL 实例，
开启新实例时，会与现有实例争夺内存资源。您可以适当调小，以减小对现有生产实例的影响。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ec3ed8119ef85413c277384f41ca7b27>9.5 - 为 PostgreSQL 集群启用 HugePage</h1><div class=lead>为 PostgreSQL 集群启用大页，减少大内存实例的页表开销并提高性能</div><blockquote><p>使用 <code>node_hugepage_count</code> 和 <code>node_hugepage_ratio</code> 或 <code>/pg/bin/pg-tune-hugepage</code></p></blockquote><p>如果你计划启用大页（HugePage），请考虑使用 <a href=/docs/node/param#node_hugepage_count><code>node_hugepage_count</code></a> 和 <a href=/docs/node/param#node_hugepage_ratio><code>node_hugepage_ratio</code></a>，并配合 <code>./node.yml -t node_tune</code> 进行应用。</p><p>大页对于数据库来说有利有弊，利是内存是专门管理的，不用担心被挪用，降低数据库 OOM 风险。缺点是某些场景下可能对性能由负面影响。</p><p>在 PostgreSQL 启动前，您需要分配 <strong>足够多的</strong> 大页，浪费的部分可以使用 <code>pg-tune-hugepage</code> 脚本对其进行回收，不过此脚本仅 PostgreSQL 15+ 可用。</p><p>如果你的 PostgreSQL 已经在运行，你可以使用下面的办法启动大页（仅 PG15+ 可用）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sync<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>3</span> &gt; /proc/sys/vm/drop_caches   <span style=color:#8f5902;font-style:italic># 刷盘，释放系统缓存（请做好数据库性能受到冲击的准备）</span>
</span></span><span style=display:flex><span>sudo /pg/bin/pg-tune-hugepage             <span style=color:#8f5902;font-style:italic># 将 nr_hugepages 写入 /etc/sysctl.d/hugepage.conf</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt;                          <span style=color:#8f5902;font-style:italic># 重启 postgres 以使用 hugepage</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-677d9d9a118e237b46693da04151cde7>9.6 - 3坏2应急处理</h1><div class=lead>高可用典型场景处理预案：三节点坏了两个节点，高可用不生效了，怎么从紧急状态中恢复？</div><p>如果经典3节点高可用部署同时出现两台（多数主体）故障，系统通常无法自动完成故障切换，需要人工介入：</p><p>首先判断另外两台服务器的情况，如果短时间内可以拉起，优先选择拉起另外两台服务。否则进入 <strong>紧急止血流程</strong></p><p><strong>紧急止血流程假设您的管理节点故障</strong>，只有单台普通数据库节点存活，在这种情况下，最快的恢复操作流程为：</p><ul><li>调整 HAProxy 配置，将流量指向主库。</li><li>关闭 Patroni，手动提升 PostgreSQL 从库为主库。</li></ul><hr><h2 id=调整haproxy配置>调整HAProxy配置</h2><p>如果你通过其他方式绕开 HAProxy 访问集群，那么可以跳过这一步。
如果你通过 HAProxy 方式访问数据库集群，那么你需要调整负载均衡配置，将读写流量手工指向主库。</p><ul><li>编辑 <code>/etc/haproxy/&lt;pg_cluster>-primary.cfg</code> 配置文件，其中 <code>&lt;pg_cluster></code> 为你的 PostgreSQL 集群名称，例如 <code>pg-meta</code>。</li><li>将健康检查配置选项注释，停止进行健康鉴擦好</li><li>将服务器列表中，其他两台故障的机器注释掉，只保留当前主库服务器。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-meta-primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5433</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 注释掉以下四行健康检查配置</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#option httpchk                               # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#option http-keep-alive                       # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#http-check send meth OPTIONS uri /primary    # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#http-check expect status 200                 # &lt;---- remove this</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-meta-1 10.10.10.10:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 注释掉其他两台故障的机器</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#server pg-meta-2 10.10.10.11:6432 check port 8008 weight 100 &lt;---- comment this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#server pg-meta-3 10.10.10.12:6432 check port 8008 weight 100 &lt;---- comment this</span>
</span></span></code></pre></div><p>配置调整完成后，先不着急执行 <code>systemctl reload haproxy</code> 重载生效，等待后续主库提升后一起执行。
以上配置的效果是，HAProxy 将不再进行主库健康检查（默认使用 Patroni），而是直接将写入流量指向当前主库</p><hr><h2 id=手工提升备库>手工提升备库</h2><p>登陆目标服务器，切换至 dbsu 用户，执行 <code>CHECKPOINT</code> 刷盘后，关闭 Patroni，重启 PostgreSQL 并执行 Promote。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres                     <span style=color:#8f5902;font-style:italic># 切换到数据库 dbsu 用户</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;checkpoint; checkpoint;&#39;</span>      <span style=color:#8f5902;font-style:italic># 两次 Checkpoint 刷脏页，避免PG后重启耗时过久</span>
</span></span><span style=display:flex><span>sudo systemctl stop patroni            <span style=color:#8f5902;font-style:italic># 关闭 Patroni</span>
</span></span><span style=display:flex><span>pg-restart                             <span style=color:#8f5902;font-style:italic># 重新拉起 PostgreSQL</span>
</span></span><span style=display:flex><span>pg-promote                             <span style=color:#8f5902;font-style:italic># 将 PostgreSQL 从库提升为主库</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_is_in_recovery();&#39;</span>  <span style=color:#8f5902;font-style:italic># 如果结果为 f，表示已经提升为主库</span>
</span></span></code></pre></div><p>如果你上面调整了 HAProxy 配置，那么现在可以执行 <code>systemctl reload haproxy</code> 重载 HAProxy 配置，将流量指向新的主库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload haproxy                <span style=color:#8f5902;font-style:italic># 重载 HAProxy 配置，将写入流量指向当前实例</span>
</span></span></code></pre></div><hr><h2 id=避免脑裂>避免脑裂</h2><p>紧急止血后，第二优先级问题为：<strong>避免脑裂</strong>。用户应当防止另外两台服务器重新上线后，与当前主库形成脑裂，导致数据不一致。</p><p>简单的做法是：</p><ul><li>将另外两台服务器直接 <strong>断电/断网</strong>，确保它们不会在不受控的情况下再次上线。</li><li>调整应用使用的数据库连接串，将其 HOST 直接指向唯一幸存服务器上的主库。</li></ul><p>然后应当根据具体情况，决定下一步的操作：</p><ul><li>A：这两台服务器是临时故障（比如断网断电），可以原地修复后继续服务</li><li>B：这两台故障服务器是永久故障（比如硬件损坏），将移除并下线。</li></ul><hr><h2 id=临时故障后的复原>临时故障后的复原</h2><p>如果另外两台服务器是临时故障，可以修复后继续服务，那么可以按照以下步骤进行修复与重建：</p><ul><li>每次处理一台故障服务器，优先处理 管理节点 / INFRA 管理节点</li><li>启动故障服务器，并在启动后关停 Patroni</li></ul><p>ETCD 集群在法定人数恢复后，将恢复工作，此时可以启动幸存服务器（当前主库）上的 Patroni，接管现有 PostgreSQL，并重新获取集群领导者身份。
Patroni 启动后进入维护模式。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni
</span></span><span style=display:flex><span>pg pause &lt;pg_cluster&gt;
</span></span></code></pre></div><p>在另外两台实例上以 <code>postgres</code> 用户身份创建 <code>touch /pg/data/standby.signal</code> 标记文件将其标记为从库，然后拉起 Patroni：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni
</span></span></code></pre></div><p>确认 Patroni 集群身份/角色正常后，退出维护模式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume &lt;pg_cluster&gt;
</span></span></code></pre></div><hr><h2 id=永久故障后的复原>永久故障后的复原</h2><p>出现永久故障后，首先需要恢复管理节点上的 <code>~/pigsty</code> 目录，主要是需要 <code>pigsty.yml</code> 与 <code>files/pki/ca/ca.key</code> 两个核心文件。</p><blockquote><p>如果您无法取回或没有备份这两个文件，您可以选择部署一套新的 Pigsty，并通过 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a> 的方式将现有集群迁移至新部署中。</p><p>请定期备份 <code>pigsty</code> 目录（例如使用 Git 进行版本管理）。建议吸取教训，下次不要犯这样的错误。</p></blockquote><h4 id=配置修复>配置修复</h4><p>您可以将幸存的节点作为新的管理节点，将 <code>~/pigsty</code> 目录拷贝到新的管理节点上，然后开始调整配置。
例如，将原本默认的管理节点 <code>10.10.10.10</code> 替换为幸存节点 <code>10.10.10.12</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 使用新的管理节点地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_etc_hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span><span style=color:#000>h.pigsty a.pigsty p.pigsty g.pigsty sss.pigsty]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 一并修改其他引用旧管理节点 IP (10.10.10.10) 的配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                              </span><span style=color:#8f5902;font-style:italic># 调整 Infra 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># 10.10.10.10: { infra_seq: 1 } # 老的 Infra 节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 新增 Infra 节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># 调整 ETCD 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.10: { etcd_seq: 1 }   # 注释掉此故障节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { etcd_seq: 2 }   # 注释掉此故障节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 保留幸存节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># 调整 PGSQL 集群配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.10: { pg_seq: 1, pg_role: primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { pg_seq: 2, pg_role: replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.12: { pg_seq: 3, pg_role: replica , pg_offline_query: true }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: primary , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h4 id=etcd修复>ETCD修复</h4><p>然后执行以下命令，将 ETCD 重置为单节点集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml -e <span style=color:#000>etcd_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> -e <span style=color:#000>etcd_clean</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><p>根据 <a href=/docs/etcd/admin#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE>ETCD重载配置</a> 的说明，调整对 ETCD Endpoint 的引用。</p><h4 id=infra修复>INFRA修复</h4><p>如果幸存节点上没有 INFRA 模块，请在当前节点上配置新的 INFRA 模块并安装。执行以下命令，将 INFRA 模块部署到幸存节点上：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -l 10.10.10.12
</span></span></code></pre></div><p>修复当前节点的监控</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_monitor
</span></span></code></pre></div><h4 id=pgsql修复>PGSQL修复</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_conf                            <span style=color:#8f5902;font-style:italic># 重新生成 PG 配置文件</span>
</span></span><span style=display:flex><span>systemctl reload patroni                          <span style=color:#8f5902;font-style:italic># 在幸存节点上重载 Patroni 配置</span>
</span></span></code></pre></div><p>各模块修复后，您可以参考标准扩容流程，将新的节点加入集群，恢复集群的高可用性。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b4eeb541b5d47f6b2e5017106913ea72>9.7 - 使用 VIP-Manager 为 PostgreSQL 集群配置二层 VIP</h1><p>您可以在 PostgreSQL 集群上绑定一个可选的 L2 VIP —— 前提条件是：集群中的所有节点都在一个二层网络中。</p><p>这个 L2 VIP 强制使用 Master - Backup 模式，Master 始终指向在数据库集群主库实例所在的节点。</p><p>这个 VIP 由 <a href=https://github.com/cybertec-postgresql/vip-manager>VIP-Manager</a> 组件管理，它会从 DCS （etcd） 中直接读取由 Patroni 写入的 Leader Key，从而判断自己是否是 Master。</p><hr><h2 id=启用vip>启用VIP</h2><p>在 PostgreSQL 集群上定义 <a href=/docs/pgsql/param#pg_vip_enabled><code>pg_vip_enabled</code></a> 参数为 <code>true</code>，即可在集群上启用 VIP 组件。当然您也可以在全局配置中启用此配置项。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgsql 3 node ha cluster: pg-test</span>
</span></span><span style=display:flex><span>pg-test:
</span></span><span style=display:flex><span>  hosts:
</span></span><span style=display:flex><span>    10.10.10.11: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 1, pg_role: primary <span style=color:#ce5c00;font-weight:700>}</span>   <span style=color:#8f5902;font-style:italic># primary instance, leader of cluster</span>
</span></span><span style=display:flex><span>    10.10.10.12: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 2, pg_role: replica <span style=color:#ce5c00;font-weight:700>}</span>   <span style=color:#8f5902;font-style:italic># replica instance, follower of leader</span>
</span></span><span style=display:flex><span>    10.10.10.13: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 3, pg_role: replica, pg_offline_query: <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic># replica with offline access</span>
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    pg_cluster: pg-test           <span style=color:#8f5902;font-style:italic># define pgsql cluster name</span>
</span></span><span style=display:flex><span>    pg_users:  <span style=color:#ce5c00;font-weight:700>[{</span> name: <span style=color:#204a87>test</span> , password: <span style=color:#204a87>test</span> , pgbouncer: <span style=color:#204a87>true</span> , roles: <span style=color:#ce5c00;font-weight:700>[</span> dbrole_admin <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>}]</span>
</span></span><span style=display:flex><span>    pg_databases: <span style=color:#ce5c00;font-weight:700>[{</span> name: <span style=color:#204a87>test</span> <span style=color:#ce5c00;font-weight:700>}]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 启用 L2 VIP</span>
</span></span><span style=display:flex><span>    pg_vip_enabled: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>    pg_vip_address: 10.10.10.3/24
</span></span><span style=display:flex><span>    pg_vip_interface: eth1
</span></span></code></pre></div><p>请注意，<a href=/docs/pgsql/param#pg_vip_address><code>pg_vip_address</code></a> 必须是一个合法的 IP 地址，带有网段，且在当前二层网络中可用。</p><p>请注意，<a href=/docs/pgsql/param#pg_vip_interface><code>pg_vip_interface</code></a> 必须是一个合法的网络接口名，并且应当是与 inventory 中使用 IPv4 地址一致的网卡。
如果集群成员的网卡名不一样，用户应当为每个实例显式指定 <code>pg_vip_interface</code> 参数，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth0  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ens33 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># define pgsql cluster name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: test , password: test , pgbouncer: true , roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 启用 L2 VIP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.3</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#pg_vip_interface: eth1</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用以下命令，刷新 PG 的 vip-manager 配置并重启生效：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_vip 
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1a6ecaf250187005e255b6c6eafd53e2>9.8 - Citus 集群部署</h1><div class=lead>如何部署 Citus 高可用分布式集群？</div><p>Citus 是一个 PostgreSQL 扩展，可以将 PostgreSQL 原地转换为一个分布式数据库，并实现在多个节点上水平扩展，以处理大量数据和大量查询。</p><p>Patroni 在 v3.0 后，提供了对 Citus 原生高可用的支持，简化了 Citus 集群的搭建，Pigsty 也对此提供了原生支持。</p><ul><li><a href=https://docs.citusdata.com/en/stable/get_started/what_is_citus.html>Citus 是什么</a></li><li><a href=https://patroni.readthedocs.io/en/latest/citus.html>Patroni Citus 支持</a></li></ul><blockquote><p>注意：Citus 13.x 支持 PostgreSQL 18、17、16、15、14 五个大版本。Pigsty 扩展仓库提供了 Citus ARM64 软件包。</p></blockquote><hr><h2 id=citus集群>Citus集群</h2><p>Pigsty 原生支持 Citus。可以参考 <a href=https://github.com/pgsty/pigsty/blob/main/conf/citus.yml><code>conf/citus.yml</code></a></p><p>这里使用 Pigsty 四节点沙箱，定义了一个 Citus 集群 <code>pg-citus</code>，其中包括一个两节点的协调者集群 <code>pg-citus0</code>，
以及两个 Worker 集群 <code>pg-citus1</code>，<code>pg-citus2</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.2/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.2/24 ,pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.3/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.4/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                            # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># citus 13.x supports PG 14-18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                        # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable vip for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip interface for all members</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, postgis, pgvector, topn, pg_cron, hll ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install these extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, pg_cron, pg_stat_statements&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_citus ,password: DBUser.Citus ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ]    }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: citus ,owner: dbuser_citus ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, vector, topn, pg_cron, hll ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>citus.node_conninfo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslmode=require sslrootcert=/pg/cert/ca.crt sslmode=verify-full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>相比标准 PostgreSQL 集群，Citus 集群的配置有一些特殊之处，首先，你需要确保 Citus 扩展被下载，安装，加载并启用，这涉及到以下四个参数</p><ul><li><a href=/docs/infra/param#repo_packages><code>repo_packages</code></a>：必须包含 <code>citus</code> 扩展，或者你需要使用带有 Citus 扩展的 PostgreSQL 离线安装包。</li><li><a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a>：必须包含 <code>citus</code> 扩展，即你必须在每个节点上安装 <code>citus</code> 扩展。</li><li><a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a>：必须包含 <code>citus</code> 扩展，而且首位必须为 <code>citus</code>，但现在 Patroni 会自动完成这件事了。</li><li><a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a>： 这里要定义一个首要数据库，该数据库必须安装 <code>citus</code> 扩展。</li></ul><p>其次，你需要确保 Citus 集群的配置正确：</p><ul><li><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a>： 必须设置为 <code>citus</code>，从而告知 Patroni 使用 Citus 模式。</li><li><a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a>：必须指定一个首要数据库的名称，该数据库必须安装 <code>citus</code> 扩展，这里名为 <code>citus</code>。</li><li><a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a>：必须指定一个统一的名称，字符串，作为所有水平分片PG集群的集群名称前缀，这里为 <code>pg-citus</code>。</li><li><a href=/docs/pgsql/param#pg_group><code>pg_group</code></a>：必须指定一个分片号，从零开始依次分配的整数，<code>0</code> 号固定代表协调者集群，其他为 Worker 集群。</li><li><a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a> 必须与 <a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a> 和 <a href=/docs/pgsql/param#pg_group><code>pg_group</code></a> 组合后的结果对应。</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>：必须设置为非空的纯文本密码，否则 Citus 无法正常工作。</li><li><a href=/docs/pgsql/param#pg_parameters><code>pg_parameters</code></a>：建议设置 <code>citus.node_conninfo</code> 参数，强制要求 SSL 访问并要求节点间验证客户端证书。</li></ul><p>配置完成后，您可以像创建普通 PostgreSQL 集群一样，使用 <code>pgsql.yml</code> 部署 Citus 集群。</p><hr><h2 id=管理citus集群>管理Citus集群</h2><p>定义好 Citus 集群后，部署 Citus 集群同样使用的剧本 <code>pgsql.yml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-citus    <span style=color:#8f5902;font-style:italic># 部署 Citus 集群 pg-citus</span>
</span></span></code></pre></div><p>使用任意成员的 DBSU（<code>postgres</code>）用户，都能通过 <code>patronictl</code> （<code>alias: pg</code>） 列出 Citus 集群的状态：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg list
</span></span><span style=display:flex><span>+ Citus cluster: pg-citus ----------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Group <span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State     <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB <span style=color:#000;font-weight:700>|</span> Tags               <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> pg-citus0-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 20C.40G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> pg-citus1-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> pg-citus2-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> pg-citus2-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> streaming <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span></code></pre></div><p>您可以将每个水平分片集群视为一个独立的 PGSQL 集群，使用 <code>pg</code> (<code>patronictl</code>) 命令管理它们。
但是务必注意，当你使用 <code>pg</code> 命令管理 Citus 集群时，需要额外使用 <code>--group</code> 参数指定集群分片号</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list pg-citus --group <span style=color:#0000cf;font-weight:700>0</span>   <span style=color:#8f5902;font-style:italic># 需要使用 --group 0 指定集群分片号</span>
</span></span></code></pre></div><p>Citus 中有一个名为 <code>pg_dist_node</code> 的系统表，用于记录 Citus 集群的节点信息，Patroni 会自动维护该表。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PGURL</span><span style=color:#ce5c00;font-weight:700>=</span>postgres://postgres:DBUser.Postgres@10.10.10.10/citus
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql <span style=color:#000>$PGURL</span> -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_node;&#39;</span>       <span style=color:#8f5902;font-style:italic># 查看节点信息</span>
</span></span><span style=display:flex><span> nodeid <span style=color:#000;font-weight:700>|</span> groupid <span style=color:#000;font-weight:700>|</span>  nodename   <span style=color:#000;font-weight:700>|</span> nodeport <span style=color:#000;font-weight:700>|</span> noderack <span style=color:#000;font-weight:700>|</span> hasmetadata <span style=color:#000;font-weight:700>|</span> isactive <span style=color:#000;font-weight:700>|</span> noderole  <span style=color:#000;font-weight:700>|</span> nodecluster <span style=color:#000;font-weight:700>|</span> metadatasynced <span style=color:#000;font-weight:700>|</span> shouldhaveshards
</span></span><span style=display:flex><span>--------+---------+-------------+----------+----------+-------------+----------+-----------+-------------+----------------+------------------
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> secondary <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span></code></pre></div><p>此外，你还可以查看用户认证信息（仅限超级用户访问）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ psql <span style=color:#000>$PGURL</span> -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_authinfo;&#39;</span>   <span style=color:#8f5902;font-style:italic># 查看节点认证信息（仅限超级用户访问）</span>
</span></span></code></pre></div><p>然后，你可以使用普通业务用户（例如，具有 DDL 权限的 <code>dbuser_citus</code>）来访问 Citus 集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_node;&#39;</span>
</span></span></code></pre></div><hr><h2 id=使用citus集群>使用Citus集群</h2><p>在使用 Citus 集群时，我们强烈建议您先阅读 <a href=https://docs.citusdata.com/en/stable/get_started/concepts.html>Citus 官方文档</a>，了解其架构设计与核心概念。</p><p>其中核心是了解 Citus 中的五种表，以及其特点与应用场景：</p><ul><li>分布式表（Distributed Table）</li><li>参考表（Reference Table）</li><li>本地表（Local Table）</li><li>本地管理表（Local Management Table）</li><li>架构表（Schema Table）</li></ul><p>在协调者节点上，您可以创建分布式表和引用表，并从任何数据节点查询它们。从 11.2 开始，任何 Citus 数据库节点都可以扮演协调者的角色了。</p><p>我们可以使用 pgbench 来创建一些表，并将其中的主表（<code>pgbench_accounts</code>）分布到各个节点上，然后将其他小表作为引用表：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PGURL</span><span style=color:#ce5c00;font-weight:700>=</span>postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus
</span></span><span style=display:flex><span>pgbench -i <span style=color:#000>$PGURL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql <span style=color:#000>$PGURL</span> <span style=color:#4e9a06>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_distributed_table(&#39;pgbench_accounts&#39;, &#39;aid&#39;); SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_accounts&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_branches&#39;)         ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_branches&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_history&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_history&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_tellers&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_tellers&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>执行读写测试：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus      <span style=color:#8f5902;font-style:italic># 直连协调者 5432 端口</span>
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.10:6432/citus <span style=color:#8f5902;font-style:italic># 通过连接池，减少客户端连接数压力，可以有效提高整体吞吐。</span>
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.13/citus      <span style=color:#8f5902;font-style:italic># 任意 primary 节点都可以作为 coordinator</span>
</span></span><span style=display:flex><span>pgbench --select-only -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.11/citus <span style=color:#8f5902;font-style:italic># 可以发起只读查询</span>
</span></span></code></pre></div><hr><h2 id=更严肃的生产部署>更严肃的生产部署</h2><p>要将 Citus 用于生产环境，您通常需要为 Coordinator 和每个 Worker 集群设置流复制物理副本。</p><p>例如，在 <a href=https://github.com/pgsty/pigsty/blob/main/conf/simu.yml><code>simu.yml</code></a> 中定义了一个 10 节点的 Citus 集群。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.50</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.51</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.52</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.53</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.54</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.55</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.56</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.57</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.58</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.59</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                            # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># citus 13.x supports PG 14-18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                        # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable vip for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip interface for all members</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># enable dbsu password access for citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, postgis, pgvector, topn, pg_cron, hll ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install these extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, pg_cron, pg_stat_statements&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_citus ,password: DBUser.Citus ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ]    }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: citus ,owner: dbuser_citus ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, vector, topn, pg_cron, hll ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>citus.node_conninfo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslrootcert=/pg/cert/ca.crt sslmode=verify-full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>我们将在后续教程中覆盖一系列关于 Citus 的高级主题</p><ul><li>读写分离</li><li>故障处理</li><li>一致性备份与恢复</li><li>高级监控与问题诊断</li><li>连接池</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ecaf10982eb41799d970bf83186f0f12>10 - 参考资料</h1><p>参数配置与参考文档</p></div><div class=td-content style=page-break-before:always><h1 id=pg-318a92a644bd3692615ad49e01f0f4e1>11 - 监控系统</h1><div class=lead>Pigsty监控系统架构概览，以及如何监控现存的 PostgreSQL 实例？</div><p>本文介绍了 Pigsty 的监控系统架构，包括监控指标，日志，与目标管理的方式。以及如何 <a href=#%E7%9B%91%E6%8E%A7%E7%8E%B0%E6%9C%89%E9%9B%86%E7%BE%A4>监控现有PG集群</a> 与远程 <a href=#%E7%9B%91%E6%8E%A7rds>RDS服务</a>。</p><hr><h2 id=监控概览>监控概览</h2><p>Pigsty使用现代的可观测技术栈对 PostgreSQL 进行监控：</p><ul><li>使用 Grafana 进行指标可视化和 PostgreSQL 数据源。</li><li>使用 VictoriaMetrics 来采集 PostgreSQL / Pgbouncer / Patroni / HAProxy / Node 的指标</li><li>使用 VictoriaLogs 来记录 PostgreSQL / Pgbouncer / Patroni / pgBackRest 以及主机组件的日志</li><li>Pigsty 提供了开箱即用的 Grafana 仪表盘，展示与 PostgreSQL 有关的方方面面。</li></ul><p><strong>监控指标</strong></p><p>PostgreSQL 本身的监控指标完全由 pg_exporter 配置文件所定义：<a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg_exporter.yml><code>pg_exporter.yml</code></a>
它将进一步被 Prometheus 记录规则和告警规则进行加工处理：<a href=https://github.com/Vonng/pigsty/blob/main/files/prometheus/rules/pgsql.yml><code>files/prometheus/rules/pgsql.yml</code></a>。</p><p>Pigsty使用三个身份标签：<code>cls</code>、<code>ins</code>、<code>ip</code>，它们将附加到所有指标和日志上。此外，Pgbouncer的监控指标，主机节点 NODE，与负载均衡器的监控指标也会被 Pigsty 所使用，并尽可能地使用相同的标签以便于关联分析。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-meta-1, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-test-1, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-test-2, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-test-3, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.13</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>日志</strong></p><p>与 PostgreSQL 有关的日志由 vector 负责收集，并发送至 infra 节点上的 VictoriaLogs 日志存储/查询服务。</p><ul><li><a href=/docs/pgsql/param#pg_log_dir><code>pg_log_dir</code></a> : postgres日志目录，默认为<code>/pg/log/postgres</code></li><li><a href=/docs/pgsql/param#pgbouncer_log_dir><code>pgbouncer_log_dir</code></a> : pgbouncer日志目录，默认为<code>/pg/log/pgbouncer</code></li><li><a href=/docs/pgsql/param#patroni_log_dir><code>patroni_log_dir</code></a> : patroni日志目录，默认为<code>/pg/log/patroni</code></li><li><a href=/docs/pgsql/param#pgbackrest_log_dir><code>pgbackrest_log_dir</code></a> : pgbackrest日志目录，默认为<code>/pg/log/pgbackrest</code></li></ul><p><strong>目标管理</strong></p><p>Prometheus的监控目标在 <code>/etc/prometheus/targets/pgsql/</code> 下的静态文件中定义，每个实例都有一个相应的文件。以 <code>pg-meta-1</code> 为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-meta-1 [primary] @ 10.10.10.10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>labels</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cls: pg-meta, ins: pg-meta-1, ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>targets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- pg_exporter 用于PostgreSQL指标</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>9631</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- pg_exporter 用于pgbouncer指标</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#0000cf;font-weight:700>8008</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- patroni指标（未启用 API SSL 时）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>当全局标志 <a href=/docs/pgsql/param#patroni_ssl_enabled><code>patroni_ssl_enabled</code></a> 被设置时，patroni目标将被移动到单独的文件 <code>/etc/prometheus/targets/patroni/&lt;ins>.yml</code>。 因为此时使用的是 https 抓取端点。当您 <a href=#%E7%9B%91%E6%8E%A7rds>监控RDS</a> 实例时，监控目标会被单独放置于： <code>/etc/prometheus/targets/pgrds/</code> 目录下，并以<strong>集群</strong>为单位进行管理。</p><p>当使用 <code>bin/pgsql-rm</code> 或 <code>pgsql-rm.yml</code> 移除集群时，Prometheus监控目标将被移除。您也可以手动移除它，或使用剧本里的子任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-rm &lt;cls<span style=color:#000;font-weight:700>|</span>ins&gt;    <span style=color:#8f5902;font-style:italic># 从所有infra节点中移除 prometheus 监控目标</span>
</span></span></code></pre></div><p>远程 RDS 监控目标会被放置于 <code>/etc/prometheus/targets/pgrds/&lt;cls>.yml</code>，它们是由 <a href=/docs/pgsql/playbook#pgsql-monitoryml><code>pgsql-monitor.yml</code></a> 剧本或 <code>bin/pgmon-add</code> 脚本所创建的。</p><hr><h2 id=监控模式>监控模式</h2><p>Pigsty 提供三种监控模式，以适应不同的监控需求。</p><table class=full-width><thead><tr><th style=text-align:center>事项\等级</th><th style=text-align:center>L1</th><th style=text-align:center>L2</th><th style=text-align:center>L3</th></tr></thead><tbody><tr><td style=text-align:center>名称</td><td style=text-align:center><a href=#%E7%9B%91%E6%8E%A7rds>基础部署</a></td><td style=text-align:center><a href=#%E7%9B%91%E6%8E%A7%E7%8E%B0%E6%9C%89%E9%9B%86%E7%BE%A4>托管部署</a></td><td style=text-align:center><strong>标准部署</strong></td></tr><tr><td style=text-align:center>英文</td><td style=text-align:center><strong>RDS</strong></td><td style=text-align:center><strong>MANAGED</strong></td><td style=text-align:center><strong>FULL</strong></td></tr><tr><td style=text-align:center>场景</td><td style=text-align:center>只有连接串，例如RDS</td><td style=text-align:center>DB已存在，节点可管理</td><td style=text-align:center>实例由 Pigsty 创建</td></tr><tr><td style=text-align:center>PGCAT功能</td><td style=text-align:center>✅ 完整可用</td><td style=text-align:center>✅ 完整可用</td><td style=text-align:center>✅ 完整可用</td></tr><tr><td style=text-align:center>PGSQL功能</td><td style=text-align:center>✅ 限PG指标</td><td style=text-align:center>✅ 限PG与节点指标</td><td style=text-align:center>✅ 完整功能</td></tr><tr><td style=text-align:center>连接池指标</td><td style=text-align:center>❌ 不可用</td><td style=text-align:center>⚠️ 选装</td><td style=text-align:center>✅ 预装项</td></tr><tr><td style=text-align:center>负载均衡器指标</td><td style=text-align:center>❌ 不可用</td><td style=text-align:center>⚠️ 选装</td><td style=text-align:center>✅ 预装项</td></tr><tr><td style=text-align:center>PGLOG功能</td><td style=text-align:center>❌ 不可用</td><td style=text-align:center>⚠️ 选装</td><td style=text-align:center>✅ 预装项</td></tr><tr><td style=text-align:center>PG Exporter</td><td style=text-align:center>⚠️ 部署于Infra节点</td><td style=text-align:center>✅ 部署于DB节点</td><td style=text-align:center>✅ 部署于DB节点</td></tr><tr><td style=text-align:center>Node Exporter</td><td style=text-align:center>❌ 不部署</td><td style=text-align:center>✅ 部署于DB节点</td><td style=text-align:center>✅ 部署于DB节点</td></tr><tr><td style=text-align:center>侵入DB节点</td><td style=text-align:center>✅ 无侵入</td><td style=text-align:center>⚠️ 安装Exporter</td><td style=text-align:center>⚠️ 完全由Pigsty管理</td></tr><tr><td style=text-align:center>监控现有实例</td><td style=text-align:center>✅ 可支持</td><td style=text-align:center>✅ 可支持</td><td style=text-align:center>❌ 仅用于Pigsty托管实例</td></tr><tr><td style=text-align:center>监控用户与视图</td><td style=text-align:center>人工创建</td><td style=text-align:center>人工创建</td><td style=text-align:center>Pigsty自动创建</td></tr><tr><td style=text-align:center>部署使用剧本</td><td style=text-align:center><code>bin/pgmon-add &lt;cls></code></td><td style=text-align:center>部分执行 <code>pgsql.ym</code>/<code>node.yml</code></td><td style=text-align:center><code>pgsql.yml</code></td></tr><tr><td style=text-align:center>所需权限</td><td style=text-align:center>Infra 节点可达的 PGURL</td><td style=text-align:center>DB节点ssh与sudo权限</td><td style=text-align:center>DB节点ssh与sudo权限</td></tr><tr><td style=text-align:center>功能概述</td><td style=text-align:center>PGCAT + PGRDS</td><td style=text-align:center>大部分功能</td><td style=text-align:center>完整功能</td></tr></tbody></table><p>由Pigsty完全管理的数据库会自动纳入监控，并拥有最好的监控支持，通常不需要任何配置。对于现有的 PostgreSQL 集群或者 RDS 服务，如果如果目标DB节点<strong>可以被Pigsty所管理</strong>（ssh可达，sudo可用），那么您可以考虑 <a href=#%E7%9B%91%E6%8E%A7%E7%8E%B0%E6%9C%89%E9%9B%86%E7%BE%A4>托管部署</a>，实现与 Pigsty 基本类似的监控管理体验。如果您<strong>只能通过PGURL</strong>（数据库连接串）的方式访问目标数据库，例如远程的RDS服务，则可以考虑使用 <a href=#%E7%9B%91%E6%8E%A7rds>精简模式</a> 监控目标数据库。</p><hr><h2 id=监控现有集群>监控现有集群</h2><p><strong>如果目标DB节点可以被Pigsty所管理</strong>（<code>ssh</code>可达且<code>sudo</code>可用），那么您可以使用 <a href=/docs/pgsql/playbook#pgsqlyml><code>pgsql.yml</code></a> 剧本中的<code>pg_exporter</code>任务，
使用与标准部署相同的方式，在目标节点上部署监控组件：PG Exporter。您也可以使用该剧本的 <code>pgbouncer</code>，<code>pgbouncer_exporter</code> 任务在已有实例节点上部署连接池及其监控。此外，您也可以使用 <a href=/docs/node/playbook#nodeyml><strong><code>node.yml</code></strong></a> 中的 <code>node_exporter</code>， <code>haproxy</code>， <code>vector</code> 部署主机监控，负载均衡，日志收集组件。从而获得与原生Pigsty数据库实例完全一致的使用体验。</p><p>现有集群的定义方式与 Pigsty 所管理的集群定义方式完全相同，您只是选择性执行 <code>pgsql.yml</code> 剧本中的部分任务，而不是执行整个剧本。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml  -l &lt;cls&gt; -t node_repo,node_pkg           <span style=color:#8f5902;font-style:italic># 在主机节点上添加 INFRA节点的 YUM 源并安装软件包。</span>
</span></span><span style=display:flex><span>./node.yml  -l &lt;cls&gt; -t node_exporter,node_register  <span style=color:#8f5902;font-style:italic># 配置主机监控，并加入 VictoriaMetrics</span>
</span></span><span style=display:flex><span>./node.yml  -l &lt;cls&gt; -t vector                       <span style=color:#8f5902;font-style:italic># 配置主机日志采集，并发送至 victoria-logs</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_exporter,pg_register      <span style=color:#8f5902;font-style:italic># 配置 PostgreSQL 监控，并注册至 Victoria/Grafana</span>
</span></span></code></pre></div><p>因为目标数据库集群已存在，所以您需要手工在目标数据库集群上 <a href=#%E7%9B%91%E6%8E%A7%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE>创建监控用户、模式与扩展</a>。</p><hr><h2 id=监控rds>监控RDS</h2><p>如果您<strong>只能通过PGURL</strong>（数据库连接串）的方式访问目标数据库，那么可以参照这里的说明进行配置。在这种模式下，Pigsty 在 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a> 上部署对应的 PG Exporter，抓取远端数据库指标信息。如下图所示：</p><pre tabindex=0><code>------ infra ------
|                 |
|   prometheus    |            v---- pg-foo-1 ----v
|       ^         |  metrics   |         ^        |
|   pg_exporter &lt;-|------------|----  postgres    |
|   (port: 20001) |            | 10.10.10.10:5432 |
|       ^         |            ^------------------^
|       ^         |                      ^
|       ^         |            v---- pg-foo-2 ----v
|       ^         |  metrics   |         ^        |
|   pg_exporter &lt;-|------------|----  postgres    |
|   (port: 20002) |            | 10.10.10.11:5433 |
-------------------            ^------------------^
</code></pre><p>在这种模式下，监控系统不会有主机，连接池，负载均衡器，高可用组件的相关指标，但数据库本身，以及数据目录（Catalog）中的实时状态信息仍然可用。Pigsty提供了两个专用的监控面板，专注于 PostgreSQL 本身的监控指标： <a href=https://demo.pigsty.cc/d/pgrds-cluster>PGRDS Cluster</a> 与 <a href=https://demo.pigsty.cc/d/pgrds-instance>PGRDS Instance</a>，总览与数据库内监控则复用现有监控面板。因为Pigsty不能管理您的RDS，所以用户需要在目标数据库上提前 <a href=#%E7%9B%91%E6%8E%A7%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE>配置好监控对象</a>。</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>监控外部 Postgres 实例时的局限性</div><ul><li>pgBoucner 连接池指标不可用</li><li>Patroni 高可用组件指标不可用</li><li>主机节点监控指标不可用，以及节点 HAProxy，Keepalived 指标亦不可用。</li><li>日志收集与日志衍生指标不可用</li></ul></div><p>下面我们使用沙箱环境作为示例：现在我们假设 <code>pg-meta</code> 集群是一个有待监控的 RDS 实例 <code>pg-foo-1</code>，而 <code>pg-test</code> 集群则是一个有待监控的RDS集群 <code>pg-bar</code>：</p><ol><li><p>在目标上创建监控模式、用户和权限。详情请参考 <a href=#%E7%9B%91%E6%8E%A7%E5%AF%B9%E8%B1%A1%E9%85%8D%E7%BD%AE>监控对象配置</a></p></li><li><p>在配置清单中声明集群。例如，假设我们想要监控“远端”的 <code>pg-meta</code> & <code>pg-test</code> 集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 代理、监控、警报等的infra集群..</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 在组&#39;infra&#39;上为远程postgres RDS安装pg_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 在此列出所有远程实例，为k分配一个唯一的未使用的本地端口</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 1, pg_host: 10.10.10.10 , pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta }] }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 注册 meta 数据库为 Grafana 数据源</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20002</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 1, pg_host: 10.10.10.11 , pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 几种不同的连接串拼接方法</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20003</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 2, pg_host: 10.10.10.12 , pg_exporter_url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres://dbuser_monitor:DBUser.Monitor@10.10.10.12:5432/postgres?sslmode=disable&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20004</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 3, pg_host: 10.10.10.13 , pg_monitor_username: dbuser_monitor, pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>其中， <code>pg_databases</code> 字段中所列出的数据库，将会被注册至 Grafana 中，成为一个 PostgreSQL 数据源，为 PGCAT 监控面板提供数据支持。如果您不想使用PGCAT，将注册数据库到Grafana中，只需要将 <code>pg_databases</code> 设置为空数组或直接留空即可。</p><p><img src=/img/pigsty/monitor.jpg alt=pigsty-monitor.jpg></p></li><li><p>执行添加监控命令：<code>bin/pgmon-add &lt;clsname></code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-add pg-foo  <span style=color:#8f5902;font-style:italic># 将 pg-foo 集群纳入监控</span>
</span></span><span style=display:flex><span>bin/pgmon-add pg-bar  <span style=color:#8f5902;font-style:italic># 将 pg-bar 集群纳入监控</span>
</span></span></code></pre></div></li><li><p>要删除远程集群的监控目标，可以使用 <code>bin/pgmon-rm &lt;clsname></code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-rm pg-foo  <span style=color:#8f5902;font-style:italic># 将 pg-foo 从 Pigsty 监控中移除</span>
</span></span><span style=display:flex><span>bin/pgmon-rm pg-bar  <span style=color:#8f5902;font-style:italic># 将 pg-bar 从 Pigsty 监控中移除</span>
</span></span></code></pre></div></li></ol><p>您可以使用更多的参数来覆盖默认 <code>pg_exporter</code> 的选项，下面是一个使用 Pigsty 监控阿里云 RDS 与 PolarDB 的配置样例：</p><details><summary>示例：监控阿里云 RDS for PostgreSQL 与 PolarDB</summary><p>详情请参考：<a href=https://github.com/Vonng/pigsty/blob/main/conf/demo/remote.yml>remote.yml</a></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 代理、监控、警报等的infra集群..</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 在此列出所有待监控的远程 RDS PG 实例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># 分配一个唯一的未使用的本地端口，供本地监控 Agent 使用，这里是一个 PolarDB 的主库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-polar                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pc-2ze379wb1d4irc18x.polardbpg.rds.aliyuncs.com</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 主机地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1921</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS 端口（从控制台连接信息获取）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 禁用新数据库自动发现功能</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;test&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 监控用的用户名，覆盖全局配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser_Monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 监控用的密码，覆盖全局配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test }]       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 希望启用PGCAT的数据库列表，只要name字段即可，register_datasource设置为false则不注册。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20002</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 这是一个 PolarDB  从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-polar                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pe-2ze7tg620e317ufj4.polarpgmxs.rds.aliyuncs.com</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 主机地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1521</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS 端口（从控制台连接信息获取）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 禁用新数据库自动发现功能</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;test,postgres&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 监控用的用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser_Monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 监控用的密码</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test } ]       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 希望启用PGCAT的数据库列表，只要name字段即可，register_datasource设置为false则不注册。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20004</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 这是一个基础版的单节点 RDS for PostgreSQL 实例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-rds                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgm-2zern3d323fe9ewk.pg.rds.aliyuncs.com </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 主机地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS 端口（从控制台连接信息获取）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 禁用新数据库自动发现功能</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;rds&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 监控用的用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser_Monitor  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 监控用的密码</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>rds } ]      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 希望启用PGCAT的数据库列表，只要name字段即可，register_datasource设置为false则不注册。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20005</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 这是一个高可用版的 RDS for PostgreSQL 集群主库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-rdsha                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgm-2ze3d35d27bq08wu.pg.rds.aliyuncs.com </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 主机地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS 端口（从控制台连接信息获取）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;rds&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>rds }, {name : test} ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 将这两个数据库纳入 PGCAT 管理，注册为 Grafana 数据源</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>20006</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 这是一个高可用版的 RDS for PostgreSQL 集群只读实例（从库）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-rdsha                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 集群名 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># RDS 实例号 （身份参数，手工指定分配监控系统内名称）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgr-2zexqxalk7d37edt.pg.rds.aliyuncs.com </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># RDS 主机地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># RDS 端口（从控制台连接信息获取）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;rds&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 仅监控这个列表中的数据库（多个数据库用逗号分隔）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>rds }, {name : test} ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 将这两个数据库纳入 PGCAT 管理，注册为 Grafana 数据源</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=监控对象配置>监控对象配置</h2><p>当您想要监控现有实例时，不论是 RDS，还是自建的 PostgreSQL 实例，您都需要在目标数据库上进行一些配置，以便 Pigsty 可以访问它们。</p><p>为了将外部现存PostgreSQL实例纳入监控，您需要有一个可用于访问该实例/集群的连接串。任何可达连接串（业务用户，超级用户）均可使用，但我们建议使用一个专用监控用户以避免权限泄漏。</p><ul><li><input disabled type=checkbox> <a href=#%E7%9B%91%E6%8E%A7%E7%94%A8%E6%88%B7>监控用户</a>：默认使用的用户名为 <code>dbuser_monitor</code>， 该用户属于 <code>pg_monitor</code> 角色组，或确保具有相关视图访问权限。</li><li><input disabled type=checkbox> <a href=#%E7%9B%91%E6%8E%A7%E8%AE%A4%E8%AF%81>监控认证</a>：默认使用密码访问，您需要确保HBA策略允许监控用户从管理机或DB节点本地访问数据库。</li><li><input disabled type=checkbox> <a href=#%E7%9B%91%E6%8E%A7%E6%A8%A1%E5%BC%8F>监控模式</a>：固定使用名称 <code>monitor</code>，用于安装额外的<strong>监控视图</strong>与扩展插件，非必选，但建议创建。</li><li><input disabled type=checkbox> <a href=#%E7%9B%91%E6%8E%A7%E6%89%A9%E5%B1%95>监控扩展</a>：<strong>强烈建议</strong>启用PG自带的监控扩展 <code>pg_stat_statements</code>。</li><li><input disabled type=checkbox> <a href=#%E7%9B%91%E6%8E%A7%E8%A7%86%E5%9B%BE>监控视图</a>：监控视图是可选项，可以提供更多的监控指标支持。</li></ul><h3 id=监控用户>监控用户</h3><p>以Pigsty默认使用的监控用户<code>dbuser_monitor</code>为例，在目标数据库集群创建以下用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                                       </span><span style=color:#8f5902;font-style:italic>-- 创建监控用户
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;system monitor user&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- 监控用户备注
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic>-- 授予监控用户 pg_monitor 权限，否则一些指标将无法采集
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#000>PASSWORD</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;DBUser.Monitor&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- 按需修改监控用户密码（强烈建议修改！但请与Pigsty配置一致）
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_min_duration_statement</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- 建议设置此参数，避免日志塞满监控慢查询
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>search_path</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- 建议设置此参数，避免 pg_stat_statements 扩展无法生效
</span></span></span></code></pre></div><p>请注意，这里创建的监控用户与密码需要与 <a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a> 与 <a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a> 保持一致。</p><hr><h3 id=监控认证>监控认证</h3><p>配置数据库 <code>pg_hba.conf</code> 文件，添加以下规则以允许监控用户从本地，以及管理机使用密码访问所有数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow local role monitor with password</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local   all  dbuser_monitor                    md5</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host    all  dbuser_monitor  127.0.0.1/32      md5</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host    all  dbuser_monitor  &lt;管理机器IP地址&gt;/32 md5</span>
</span></span></code></pre></div><p>如果您的 RDS 不支持定义 HBA，那么把安装 Pigsty 机器的内网 IP 地址开白即可。</p><hr><h3 id=监控模式-1>监控模式</h3><p>监控模式<strong>可选项</strong>，即使没有，Pigsty监控系统的主体也可以正常工作，但我们强烈建议设置此模式。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic>-- 创建监控专用模式
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USAGE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- 允许监控用户使用
</span></span></span></code></pre></div><hr><h3 id=监控扩展>监控扩展</h3><p>监控扩展是可选项，但我们强烈建议启用 <code>pg_stat_statements</code> 扩展该扩展提供了关于查询性能的重要数据。</p><p>注意：该扩展必须列入数据库参数 <code>shared_preload_libraries</code> 中方可生效，而修改该参数需要重启数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg_stat_statements&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;monitor&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>请注意，您应当在默认的管理数据库 <code>postgres</code> 中安装此扩展。有些时候，RDS不允许您在 <code>postgres</code> 数据库中创建监控模式，
在这种情况下，您可以将 <code>pg_stat_statements</code> 插件安装到默认的 <code>public</code> 下，只要确保监控用户的 search_path 按照上面的配置，能够找到 <code>pg_stat_statements</code> 视图即可。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg_stat_statements&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>search_path</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>,</span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>-- 建议设置此参数，避免 pg_stat_statements 扩展无法生效
</span></span></span></code></pre></div><hr><h3 id=监控视图>监控视图</h3><p>监控视图提供了若干常用的预处理结果，并对某些需要高权限的监控指标进行权限封装（例如共享内存分配），便于查询与使用。强烈建议在所有需要监控的数据库中创建</p><details><summary>监控模式与监控视图定义</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Table bloat estimate : monitor.pg_table_bloat
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>CURRENT_CATALOG</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>relname</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>tblpages</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>tblpages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>est_tblpages_ff</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tblpages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>est_tblpages_ff</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>tblpages</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>FLOAT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ratio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>ceil</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000>reltuples</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bs</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>page_hdr</span><span style=color:#000;font-weight:700>)</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000>fillfactor</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tpl_size</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>ceil</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000>toasttuples</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>est_tblpages_ff</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000>tblpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>fillfactor</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>is_na</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                  </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_hdr_size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_data_size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                          </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_hdr_size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_hdr_size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                          </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ceil</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tpl_data_size</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>INT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>ceil</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tpl_data_size</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>INT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                          </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>heappages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>toastpages</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>heappages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#000>toastpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>toasttuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>page_hdr</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>fillfactor</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>is_na</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                  </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ns</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relpages</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>heappages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>toastpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>toasttuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>substring</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>array_to_string</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reloptions</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39; &#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;fillfactor=([0-9]+)&#39;</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>smallint</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>fillfactor</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>current_setting</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;block_size&#39;</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>numeric</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>~</span><span style=color:#4e9a06>&#39;mingw32&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>()</span><span style=color:#ce5c00;font-weight:700>~</span><span style=color:#4e9a06>&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>page_hdr</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#0000cf;font-weight:700>23</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>MAX</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>null_frac</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>int</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                   </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>bool_or</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;oid&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_hdr_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>null_frac</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>avg_width</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tpl_data_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                               </span><span style=color:#000>bool_or</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>atttypid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_catalog.name&#39;</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regtype</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                   </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>is_na</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                    </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                    </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ns</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>ns</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relnamespace</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                    </span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>schemaname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>ns</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tablename</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inherited</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                    </span><span style=color:#204a87;font-weight:700>LEFT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reltoastrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#000>att</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attisdropped</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relkind</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;r&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg_catalog&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;information_schema&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>7</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>9</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                       </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>              </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>s2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#000>is_na</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres table bloat estimate&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Index bloat estimate : monitor.pg_index_bloat
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>CURRENT_CATALOG</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>idxid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>BIGINT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>COALESCE</span><span style=color:#000;font-weight:700>((</span><span style=color:#000>relpages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#000>reltuples</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>index_tuple_hdr</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>index_tuple_hdr</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                               </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>nulldatawidth</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>nulldatawidth</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>nulldatawidth</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                                  </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>bs</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>pagehdr</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>FLOAT</span><span style=color:#f8f8f8>  </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>FLOAT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ratio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>idxname</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>indrelid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>indexrelid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idxid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000>current_setting</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;block_size&#39;</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>INTEGER</span><span style=color:#f8f8f8>                                                               </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>bs</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>~</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;mingw32&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>~</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;64-bit|x86_64|ppc64|ia64|amd64&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ma</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#0000cf;font-weight:700>24</span><span style=color:#f8f8f8>                                                                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>pagehdr</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>COALESCE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>null_frac</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                               </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>index_tuple_hdr</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>((</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>COALESCE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>null_frac</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>COALESCE</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>avg_width</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>))::</span><span style=color:#204a87>INTEGER</span><span style=color:#f8f8f8>                                                     </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>nulldatawidth</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                  </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8>                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>reltuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relpages</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indrelid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indexrelid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>tc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8>                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tablename</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>regexp_split_to_table</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indkey</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>TEXT</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39; &#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>::</span><span style=color:#f8f8f8> </span><span style=color:#204a87>INTEGER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>attnum</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indexrelid</span><span style=color:#f8f8f8>                                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>index_oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_index</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indexrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#000>tc</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_index</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relnamespace</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                      </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_am</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relam</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_am</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_am</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>amname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;btree&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>ic</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relpages</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IN</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pg_catalog&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;information_schema&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>indexrelid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                  </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>schemaname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>((</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tablename</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tablename</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_get_indexdef</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attrelid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TRUE</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                 </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tablename</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>ind_atts</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>idxname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stats</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attnum</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>est</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres index bloat estimate (btree-only)&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Relation Bloat : monitor.pg_bloat
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                                                   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                                                       </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>RegClass</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tblname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#f8f8f8>                                                                            </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>6</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>                 </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>BIGINT</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>idxid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;.&#39;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>||</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8>                                                    </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#f8f8f8>                                                                            </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#f8f8f8>                 </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>size</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>CASE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHEN</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>THEN</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ELSE</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>END</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>BIGINT</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_wasted</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>FULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OUTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>ib</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>tb</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>tblid</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres relation bloat detail&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- monitor.pg_index_bloat_human
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#f8f8f8>                            </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>tblname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>idx_wasted</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>idxname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres index bloat info in human-readable format&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_index_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- monitor.pg_table_bloat_human
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>tblname</span><span style=color:#f8f8f8>                                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>idx_wasted</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#f8f8f8>                          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>all_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                       </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                       </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>pg_size_pretty</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_ratio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>tblname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_size</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)::</span><span style=color:#204a87>NUMERIC</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tbl_ratio</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_wasted</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>             </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>sum</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>idx_size</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idx_size</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_bloat</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>tblname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres table bloat info in human-readable format&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_table_bloat_human</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Activity Overview: monitor.pg_session
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_session</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_session</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>coalesce</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>numbackends</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>active</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>idle</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>ixact</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>max_duration</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>max_tx_duration</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>max_conn_duration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                                         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>numbackends</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>FILTER</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;active&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>       </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>active</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>FILTER</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;idle&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>idle</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>count</span><span style=color:#000;font-weight:700>(</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>FILTER</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;idle in transaction&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                    </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;idle in transaction (aborted)&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>ixact</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>extract</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>epoch</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>state_change</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#000>FILTER</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;active&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>max_duration</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>extract</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>epoch</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>xact_start</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>max_tx_duration</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>                </span><span style=color:#204a87;font-weight:700>max</span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>extract</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>epoch</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>from</span><span style=color:#f8f8f8> </span><span style=color:#000>now</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#000>backend_start</span><span style=color:#000;font-weight:700>))</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>max_conn_duration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>backend_type</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;client backend&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>           </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>pid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_backend_pid</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>GROUP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLLUP</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>         </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#000>NULLS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FIRST</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>     </span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_session</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgres activity group by session&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_session</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- Sequential Scan: monitor.pg_seq_scan
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>schemaname</span><span style=color:#f8f8f8>                                                        </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>relname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>seq_scan</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>seq_tup_read</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>seq_tup_read</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000>seq_scan</span><span style=color:#f8f8f8>                                           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>seq_tup_avg</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>idx_scan</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>n_live_tup</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>n_dead_tup</span><span style=color:#f8f8f8>                                           </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>tuples</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>round</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n_live_tup</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>::</span><span style=color:#204a87>NUMERIC</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n_live_tup</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>n_dead_tup</span><span style=color:#000;font-weight:700>),</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>live_ratio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_user_tables</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>and</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>n_live_tup</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>n_dead_tup</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&gt;</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DESC</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VIEW</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;table that have seq scan&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_seq_scan</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><details><summary>查看共享内存分配的函数（PG13以上可用）</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>REPLACE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RETURNS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SETOF</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>pg_shmem_allocations</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#a40000>$$</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_shmem_allocations</span><span style=color:#000;font-weight:700>;</span><span style=color:#a40000>$$</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LANGUAGE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SQL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SECURITY</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFINER</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;security wrapper for system view pg_shmem&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>REVOKE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PUBLIC</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXECUTE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FUNCTION</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>pg_shmem</span><span style=color:#000;font-weight:700>()</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details></div><div class=td-content style=page-break-before:always><h1 id=pg-a794a26bf3d40b2536adae3b38d29ef6>12 - 监控面板</h1><div class=lead>Pigsty 为 PostgreSQL 提供了诸多开箱即用的 Grafana 监控仪表盘</div><blockquote><p>Pigsty 为 PostgreSQL 提供了诸多开箱即用的 Grafana 监控仪表盘： <a href=https://demo.pigsty.cc/d/pgsql-overview>Demo</a> & <a href=https://github.com/Vonng/pigsty/wiki/Gallery>Gallery</a>。</p></blockquote><p>在 Pigsty 中共有 26 个与 PostgreSQL 相关的监控面板，按照层次分为 总览，集群，实例，数据库四大类，按照数据来源又分为 <a href=#%E6%80%BB%E8%A7%88>PGSQL</a>，<a href=#pgcat>PGCAT</a>，<a href=#pglog>PGLOG</a> 三大类。</p><p><img src=/img/pigsty/dashboard.jpg alt=pigsty-dashboard.jpg></p><hr><h2 id=总览>总览</h2><table class=full-width><thead><tr><th style=text-align:center>总览</th><th style=text-align:center>集群</th><th style=text-align:center>实例</th><th style=text-align:center>数据库</th></tr></thead><tbody><tr><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-overview>PGSQL Overview</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-cluster>PGSQL Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-instance>PGSQL Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-database>PGSQL Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-alert>PGSQL Alert</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgrds-cluster>PGRDS Cluster</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgrds-instance>PGRDS Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-database>PGCAT Database</a></td></tr><tr><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-shard>PGSQL Shard</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-activity>PGSQL Activity</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-instance>PGCAT Instance</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-tables>PGSQL Tables</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-replication>PGSQL Replication</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-persist>PGSQL Persist</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-table>PGSQL Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-service>PGSQL Service</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-proxy>PGSQL Proxy</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-table>PGCAT Table</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-databases>PGSQL Databases</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-pgbouncer>PGSQL Pgbouncer</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-query>PGSQL Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-patroni>PGSQL Patroni</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-session>PGSQL Session</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-query>PGCAT Query</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-pitr>PGSQL PITR</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-xacts>PGSQL Xacts</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-locks>PGCAT Locks</a></td></tr><tr><td style=text-align:center></td><td style=text-align:center></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgsql-exporter>PGSQL Exporter</a></td><td style=text-align:center><a href=https://demo.pigsty.cc/d/pgcat-schema>PGCAT Schema</a></td></tr></tbody></table><p><strong>概览</strong></p><ul><li><a href=https://demo.pigsty.cc/d/pgsql-overview>pgsql-overview</a> : PGSQL模块的主仪表板</li><li><a href=https://demo.pigsty.cc/d/pgsql-alert>pgsql-alert</a> : PGSQL的全局关键指标和警报事件</li><li><a href=https://demo.pigsty.cc/d/pgsql-shard>pgsql-shard</a> : 关于水平分片的PGSQL集群的概览，例如 citus / gpsql 集群</li></ul><p><strong>集群</strong></p><ul><li><a href=https://demo.pigsty.cc/d/pgsql-cluster>pgsql-cluster</a>: 一个PGSQL集群的主仪表板</li><li><a href=https://demo.pigsty.cc/d/pgrds-cluster>pgrds-cluster</a>: PGSQL Cluster 的RDS版本，专注于所有 PostgreSQL 本身的指标</li><li><a href=https://demo.pigsty.cc/d/pgsql-activity>pgsql-activity</a>: 关注PGSQL集群的会话/负载/QPS/TPS/锁定情况</li><li><a href=https://demo.pigsty.cc/d/pgsql-replication>pgsql-replication</a>: 关注PGSQL集群复制、插槽和发布/订阅</li><li><a href=https://demo.pigsty.cc/d/pgsql-service>pgsql-service</a>: 关注PGSQL集群服务、代理、路由和负载均衡</li><li><a href=https://demo.pigsty.cc/d/pgsql-databases>pgsql-databases</a>: 关注所有实例的数据库CRUD、慢查询和表统计信息</li><li><a href=https://demo.pigsty.cc/d/pgsql-patroni>pgsql-patroni</a>: 关注集群高可用状态，Patroni组件状态</li><li><a href=https://demo.pigsty.cc/d/pgsql-pitr>pgsql-pitr</a>: 关注集群 PITR 过程的上下文，用于辅助时间点恢复</li></ul><p><strong>实例</strong></p><ul><li><a href=https://demo.pigsty.cc/d/pgsql-instance>pgsql-instance</a>: 单个PGSQL实例的主仪表板</li><li><a href=https://demo.pigsty.cc/d/pgrds-instance>pgrds-instance</a>: PGSQL Instance 的RDS版本，专注于所有 PostgreSQL 本身的指标</li><li><a href=https://demo.pigsty.cc/d/pgcat-instance>pgcat-instance</a>: 直接从数据库目录获取的实例信息</li><li><a href=https://demo.pigsty.cc/d/pgsql-proxy>pgsql-proxy</a>: 单个haproxy负载均衡器的详细指标</li><li><a href=https://demo.pigsty.cc/d/pgsql-pgbouncer>pgsql-pgbouncer</a>: 单个Pgbouncer连接池实例中的指标总览</li><li><a href=https://demo.pigsty.cc/d/pgsql-persist>pgsql-persist</a>: 持久性指标：WAL、XID、检查点、存档、IO</li><li><a href=https://demo.pigsty.cc/d/pgsql-session>pgsql-session</a>: 单个实例中的会话和活动/空闲时间的指标</li><li><a href=https://demo.pigsty.cc/d/pgsql-xacts>pgsql-xacts</a>: 关于事务、锁、TPS/QPS相关的指标</li><li><a href=https://demo.pigsty.cc/d/pgsql-exporter>pgsql-exporter</a>: Postgres 与 Pgbouncer 监控组件自我监控指标</li></ul><p><strong>数据库</strong></p><ul><li><a href=https://demo.pigsty.cc/d/pgsql-database>pgsql-database</a>: 单个PGSQL数据库的主仪表板</li><li><a href=https://demo.pigsty.cc/d/pgcat-database>pgcat-database</a>: 直接从数据库目录获取的数据库信息</li><li><a href=https://demo.pigsty.cc/d/pgsql-tables>pgsql-tables</a> : 单个数据库内的表/索引访问指标</li><li><a href=https://demo.pigsty.cc/d/pgsql-table>pgsql-table</a>: 单个表的详细信息（QPS/RT/索引/序列&mldr;）</li><li><a href=https://demo.pigsty.cc/d/pgcat-table>pgcat-table</a>: 直接从数据库目录获取的单个表的详细信息（统计/膨胀&mldr;）</li><li><a href=https://demo.pigsty.cc/d/pgsql-query>pgsql-query</a>: 单个查询的详细信息（QPS/RT）</li><li><a href=https://demo.pigsty.cc/d/pgcat-query>pgcat-query</a>: 直接从数据库目录获取的单个查询的详细信息（SQL/统计）</li><li><a href=https://demo.pigsty.cc/d/pgcat-schema>pgcat-schema</a>: 直接从数据库目录获取关于模式的信息（表/索引/序列&mldr;）</li><li><a href=https://demo.pigsty.cc/d/pgcat-locks>pgcat-locks</a>: 直接从数据库目录获取的关于活动与锁等待的信息</li></ul><hr><h2 id=总览-1>总览</h2><p><a href=https://demo.pigsty.cc/d/pgsql-overview>PGSQL Overview</a>：PGSQL模块的主仪表板</p><details><summary>PGSQL Overview</summary><p><a href=https://demo.pigsty.cc/d/pgsql-overview><img src=/img/dashboard/pgsql-overview.jpg alt=pgsql-overview.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-alert>PGSQL Alert</a>：PGSQL 全局核心指标总览与告警事件一览</p><details><summary>PGSQL Alert</summary><p><a href=https://demo.pigsty.cc/d/pgsql-alert><img src=/img/dashboard/pgsql-alert.jpg alt=pgsql-alert.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-shard>PGSQL Shard</a>：展示一个PGSQL 水平分片集群内的横向指标对比：例如 CITUS / GPSQL 集群。</p><details><summary>PGSQL Shard</summary><p><a href=https://demo.pigsty.cc/d/pgsql-shard><img src=/img/dashboard/pgsql-shard.jpg alt=pgsql-shard.jpg></a></p></details><hr><h2 id=集群>集群</h2><p><a href=https://demo.pigsty.cc/d/pgsql-cluster>PGSQL Cluster</a>：一个PGSQL集群的主仪表板</p><details><summary>PGSQL Cluster</summary><p><a href=https://demo.pigsty.cc/d/pgsql-cluster><img src=/img/dashboard/pgsql-cluster.jpg alt=pgsql-cluster.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgrds-cluster>PGRDS Cluster</a>：PGSQL Cluster 的RDS版本，专注于所有 PostgreSQL 本身的指标</p><details><summary>PGRDS Cluster</summary><p><a href=https://demo.pigsty.cc/d/pgrds-cluster><img src=/img/dashboard/pgrds-cluster.jpg alt=pgrds-cluster.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-service>PGSQL Service</a>：关注PGSQL集群服务、代理、路由和负载均衡。</p><details><summary>PGSQL Service</summary><p><a href=https://demo.pigsty.cc/d/pgsql-service><img src=/img/dashboard/pgsql-service.jpg alt=pgsql-service.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-activity>PGSQL Activity</a>：关注PGSQL集群的会话/负载/QPS/TPS/锁定情况</p><details><summary>PGSQL Activity</summary><p><a href=https://demo.pigsty.cc/d/pgsql-activity><img src=/img/dashboard/pgsql-activity.jpg alt=pgsql-activity.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-replication>PGSQL Replication</a>：关注PGSQL集群复制、插槽和发布/订阅。</p><details><summary>PGSQL Replication</summary><p><a href=https://demo.pigsty.cc/d/pgsql-replication><img src=/img/dashboard/pgsql-replication.jpg alt=pgsql-replication.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-databases>PGSQL Databases</a>：关注所有实例的数据库CRUD、慢查询和表统计信息。</p><details><summary>PGSQL Databases</summary><p><a href=https://demo.pigsty.cc/d/pgsql-databases><img src=/img/dashboard/pgsql-databases.jpg alt=pgsql-databases.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-patroni>PGSQL Patroni</a>：关注集群高可用状态，Patroni组件状态</p><details><summary>PGSQL Patroni</summary><p><a href=https://demo.pigsty.cc/d/pgsql-patroni><img src=/img/dashboard/pgsql-patroni.jpg alt=pgsql-patroni.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-pitr>PGSQL PITR</a>：关注集群 PITR 过程的上下文，用于辅助时间点恢复</p><details><summary>PGSQL PITR</summary><p><a href=https://demo.pigsty.cc/d/pgsql-pitr><img src=/img/dashboard/pgsql-pitr.jpg alt=pgsql-patroni.jpg></a></p></details><hr><h2 id=实例>实例</h2><p><a href=https://demo.pigsty.cc/d/pgsql-instance>PGSQL Instance</a>：单个PGSQL实例的主仪表板</p><details><summary>PGSQL Instance</summary><p><a href=https://demo.pigsty.cc/d/pgsql-instance><img src=/img/dashboard/pgsql-instance.jpg alt=pgsql-instance.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgrds-instance>PGRDS Instance</a>：PGSQL Instance 的RDS版本，专注于所有 PostgreSQL 本身的指标</p><details><summary>PGRDS Instance</summary><p><a href=https://demo.pigsty.cc/d/pgrds-instance><img src=/img/dashboard/pgrds-instance.jpg alt=pgrds-instance.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-proxy>PGSQL Proxy</a>：单个haproxy负载均衡器的详细指标</p><details><summary>PGSQL Proxy</summary><p><a href=https://demo.pigsty.cc/d/pgsql-proxy><img src=/img/dashboard/pgsql-proxy.jpg alt=pgsql-proxy.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-pgbouncer>PGSQL Pgbouncer</a>：单个Pgbouncer连接池实例中的指标总览</p><details><summary>PGSQL Pgbouncer</summary><p><a href=https://demo.pigsty.cc/d/pgsql-pgbouncer><img src=/img/dashboard/pgsql-pgbouncer.jpg alt=pgsql-pgbouncer.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-persist>PGSQL Persist</a>：持久性指标：WAL、XID、检查点、存档、IO</p><details><summary>PGSQL Persist</summary><p><a href=https://demo.pigsty.cc/d/pgsql-persist><img src=/img/dashboard/pgsql-persist.jpg alt=pgsql-persist.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-xacts>PGSQL Xacts</a>：关于事务、锁、TPS/QPS相关的指标</p><details><summary>PGSQL Xacts</summary><p><a href=https://demo.pigsty.cc/d/pgsql-xacts><img src=/img/dashboard/pgsql-xacts.jpg alt=pgsql-xacts.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-session>PGSQL Session</a>：单个实例中的会话和活动/空闲时间的指标</p><details><summary>PGSQL Session</summary><p><a href=https://demo.pigsty.cc/d/pgsql-session><img src=/img/dashboard/pgsql-session.jpg alt=pgsql-session.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-exporter>PGSQL Exporter</a>：Postgres/Pgbouncer 监控组件自我监控指标</p><details><summary>PGSQL Exporter</summary><p><a href=https://demo.pigsty.cc/d/pgsql-exporter><img src=/img/dashboard/pgsql-exporter.jpg alt=pgsql-exporter.jpg></a></p></details><hr><h2 id=数据库>数据库</h2><p><a href=https://demo.pigsty.cc/d/pgsql-database>PGSQL Database</a>：单个PGSQL数据库的主仪表板</p><details><summary>PGSQL Database</summary><p><a href=https://demo.pigsty.cc/d/pgsql-database><img src=/img/dashboard/pgsql-database.jpg alt=pgsql-database.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-tables>PGSQL Tables</a>：单个数据库内的表/索引访问指标</p><details><summary>PGSQL Tables</summary><p><a href=https://demo.pigsty.cc/d/pgsql-tables><img src=/img/dashboard/pgsql-tables.jpg alt=pgsql-tables.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-table>PGSQL Table</a>：单个表的详细信息（QPS/RT/索引/序列&mldr;）</p><details><summary>PGSQL Table</summary><p><a href=https://demo.pigsty.cc/d/pgsql-table><img src=/img/dashboard/pgsql-table.jpg alt=pgsql-table.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgsql-query>PGSQL Query</a>：单类查询的详细信息（QPS/RT）</p><details><summary>PGSQL Query</summary><p><a href=https://demo.pigsty.cc/d/pgsql-query><img src=/img/dashboard/pgsql-query.jpg alt=pgsql-query.jpg></a></p></details><hr><h2 id=pgcat>PGCAT</h2><p><a href=https://demo.pigsty.cc/d/pgcat-instance>PGCAT Instance</a>：直接从数据库目录获取的实例信息</p><details><summary>PGCAT Instance</summary><p><a href=https://demo.pigsty.cc/d/pgcat-instance><img src=/img/dashboard/pgcat-instance.jpg alt=pgcat-instance.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgcat-database>PGCAT Database</a>：直接从数据库目录获取的数据库信息</p><details><summary>PGCAT Database</summary><p><a href=https://demo.pigsty.cc/d/pgcat-database><img src=/img/dashboard/pgcat-database.jpg alt=pgcat-database.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgcat-schema>PGCAT Schema</a>：直接从数据库目录获取关于模式的信息（表/索引/序列&mldr;）</p><details><summary>PGCAT Schema</summary><p><a href=https://demo.pigsty.cc/d/pgcat-schema><img src=/img/dashboard/pgcat-schema.jpg alt=pgcat-schema.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgcat-table>PGCAT Table</a>：直接从数据库目录获取的单个表的详细信息（统计/膨胀&mldr;）</p><details><summary>PGCAT Table</summary><p><a href=https://demo.pigsty.cc/d/pgcat-table><img src=/img/dashboard/pgcat-table.jpg alt=pgcat-table.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgcat-query>PGCAT Query</a>：直接从数据库目录获取的单类查询的详细信息（SQL/统计）</p><details><summary>PGCAT Query</summary><p><a href=https://demo.pigsty.cc/d/pgcat-query><img src=/img/dashboard/pgcat-query.jpg alt=pgcat-query.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pgcat-locks>PGCAT Locks</a>：直接从数据库目录获取的关于活动与锁等待的信息</p><details><summary>PGCAT Locks</summary><p><a href=https://demo.pigsty.cc/d/pgcat-locks><img src=/img/dashboard/pgcat-locks.jpg alt=pgcat-locks.jpg></a></p></details><hr><h2 id=pglog>PGLOG</h2><p><a href=https://demo.pigsty.cc/d/pglog-overview>PGLOG Overview</a>：总览 Pigsty CMDB 中的CSV日志样本</p><details><summary>PGLOG Overview</summary><p><a href=https://demo.pigsty.cc/d/pglog-overview><img src=/img/dashboard/pglog-overview.jpg alt=pglog-overview.jpg></a></p></details><p><a href=https://demo.pigsty.cc/d/pglog-overview>PGLOG Overview</a>：Pigsty CMDB 中的CSV日志样本中某一条会话的日志详情</p><details><summary>PGLOG Session</summary><p><a href=https://demo.pigsty.cc/d/pglog-session><img src=/img/dashboard/pglog-session.jpg alt=pglog-session.jpg></a></p></details><hr><h2 id=画廊>画廊</h2><p>详情请参考 <a href=https://github.com/Vonng/pigsty/wiki/Gallery>pigsty/wiki/gallery</a>。</p><details><summary>PGSQL Overview</summary><p><a href=https://demo.pigsty.cc/d/pgsql-overview><img src=/img/dashboard/pgsql-overview.jpg alt=pgsql-overview.jpg></a></p></details><details><summary>PGSQL Shard</summary><p><a href=https://demo.pigsty.cc/d/pgsql-shard><img src=/img/dashboard/pgsql-shard.jpg alt=pgsql-shard.jpg></a></p></details><details><summary>PGSQL Cluster</summary><p><a href=https://demo.pigsty.cc/d/pgsql-cluster><img src=/img/dashboard/pgsql-cluster.jpg alt=pgsql-cluster.jpg></a></p></details><details><summary>PGSQL Service</summary><p><a href=https://demo.pigsty.cc/d/pgsql-service><img src=/img/dashboard/pgsql-service.jpg alt=pgsql-service.jpg></a></p></details><details><summary>PGSQL Activity</summary><p><a href=https://demo.pigsty.cc/d/pgsql-activity><img src=/img/dashboard/pgsql-activity.jpg alt=pgsql-activity.jpg></a></p></details><details><summary>PGSQL Replication</summary><p><a href=https://demo.pigsty.cc/d/pgsql-replication><img src=/img/dashboard/pgsql-replication.jpg alt=pgsql-replication.jpg></a></p></details><details><summary>PGSQL Databases</summary><p><a href=https://demo.pigsty.cc/d/pgsql-databases><img src=/img/dashboard/pgsql-databases.jpg alt=pgsql-databases.jpg></a></p></details><details><summary>PGSQL Instance</summary><p><a href=https://demo.pigsty.cc/d/pgsql-instance><img src=/img/dashboard/pgsql-instance.jpg alt=pgsql-instance.jpg></a></p></details><details><summary>PGSQL Proxy</summary><p><a href=https://demo.pigsty.cc/d/pgsql-proxy><img src=/img/dashboard/pgsql-proxy.jpg alt=pgsql-proxy.jpg></a></p></details><details><summary>PGSQL Pgbouncer</summary><p><a href=https://demo.pigsty.cc/d/pgsql-pgbouncer><img src=/img/dashboard/pgsql-pgbouncer.jpg alt=pgsql-pgbouncer.jpg></a></p></details><details><summary>PGSQL Session</summary><p><a href=https://demo.pigsty.cc/d/pgsql-session><img src=/img/dashboard/pgsql-session.jpg alt=pgsql-session.jpg></a></p></details><details><summary>PGSQL Xacts</summary><p><a href=https://demo.pigsty.cc/d/pgsql-xacts><img src=/img/dashboard/pgsql-xacts.jpg alt=pgsql-xacts.jpg></a></p></details><details><summary>PGSQL Persist</summary><p><a href=https://demo.pigsty.cc/d/pgsql-persist><img src=/img/dashboard/pgsql-persist.jpg alt=pgsql-persist.jpg></a></p></details><details><summary>PGSQL Database</summary><p><a href=https://demo.pigsty.cc/d/pgsql-database><img src=/img/dashboard/pgsql-database.jpg alt=pgsql-database.jpg></a></p></details><details><summary>PGSQL Tables</summary><p><a href=https://demo.pigsty.cc/d/pgsql-tables><img src=/img/dashboard/pgsql-tables.jpg alt=pgsql-tables.jpg></a></p></details><details><summary>PGSQL Table</summary><p><a href=https://demo.pigsty.cc/d/pgsql-table><img src=/img/dashboard/pgsql-table.jpg alt=pgsql-table.jpg></a></p></details><details><summary>PGSQL Query</summary><p><a href=https://demo.pigsty.cc/d/pgsql-query><img src=/img/dashboard/pgsql-query.jpg alt=pgsql-query.jpg></a></p></details><details><summary>PGCAT Instance</summary><p><a href=https://demo.pigsty.cc/d/pgcat-instance><img src=/img/dashboard/pgcat-instance.jpg alt=pgcat-instance.jpg></a></p></details><details><summary>PGCAT Database</summary><p><a href=https://demo.pigsty.cc/d/pgcat-database><img src=/img/dashboard/pgcat-database.jpg alt=pgcat-database.jpg></a></p></details><details><summary>PGCAT Schema</summary><p><a href=https://demo.pigsty.cc/d/pgcat-schema><img src=/img/dashboard/pgcat-schema.jpg alt=pgcat-schema.jpg></a></p></details><details><summary>PGCAT Table</summary><p><a href=https://demo.pigsty.cc/d/pgcat-table><img src=/img/dashboard/pgcat-table.jpg alt=pgcat-table.jpg></a></p></details><details><summary>PGCAT Lock</summary><p><a href=https://demo.pigsty.cc/d/pgcat-locks><img src=/img/dashboard/pgcat-locks.jpg alt=pgcat-locks.jpg></a></p></details><details><summary>PGCAT Query</summary><p><a href=https://demo.pigsty.cc/d/pgcat-query><img src=/img/dashboard/pgcat-query.jpg alt=pgcat-query.jpg></a></p></details><details><summary>PGLOG Overview</summary><p><a href=https://demo.pigsty.cc/d/pglog-overview><img src=/img/dashboard/pglog-overview.jpg alt=pglog-overview.jpg></a></p></details><details><summary>PGLOG Session</summary><p><a href=https://demo.pigsty.cc/d/pglog-session><img src=/img/dashboard/pglog-session.jpg alt=pglog-session.jpg></a></p></details></div><div class=td-content style=page-break-before:always><h1 id=pg-c580a7d5af0c814a622cd05d2217ea00>12.1 - 总览面板</h1><div class=lead>PostgreSQL 模块全局总览类监控面板</div><p>PostgreSQL 模块全局总览类监控面板，包括：</p><ul><li><a href=/docs/pgsql/dashboard/overview/pgsql-overview>PGSQL Overview</a>：PGSQL 模块的主仪表板</li><li><a href=/docs/pgsql/dashboard/overview/pgsql-alert>PGSQL Alert</a>：PGSQL 的全局关键指标和警报事件</li><li><a href=/docs/pgsql/dashboard/overview/pgsql-shard>PGSQL Shard</a>：关于水平分片的 PGSQL 集群的概览</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-98c77cd5a40440bd2142743d9aa7e924>12.1.1 - PGSQL Overview</h1><div class=lead>PGSQL 模块的主仪表板</div><blockquote><p>PGSQL 模块的主仪表板：<a href=https://demo.pigsty.cc/d/pgsql-overview>Demo</a></p></blockquote><p>PGSQL Overview 是 PostgreSQL 模块的主仪表板，提供整个 PGSQL 模块的全局概览视图。</p><p><a href=https://demo.pigsty.cc/d/pgsql-overview><img src=/img/panel/pgsql-overview.webp alt=pgsql-overview></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c0d2340d281acc8b5f2c5c898b37729d>12.1.2 - PGSQL Alert</h1><div class=lead>PGSQL 的全局关键指标和警报事件</div><blockquote><p>PGSQL 的全局关键指标和警报事件：<a href=https://demo.pigsty.cc/d/pgsql-alert>Demo</a></p></blockquote><p>PGSQL Alert 仪表板展示 PGSQL 全局核心指标总览与告警事件一览。</p><p><a href=https://demo.pigsty.cc/d/pgsql-alert><img src=/img/panel/pgsql-alert.webp alt=pgsql-alert></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c7ea59a32ca19d6b135cb915d738ec5f>12.1.3 - PGSQL Shard</h1><div class=lead>关于水平分片的 PGSQL 集群的概览</div><blockquote><p>关于水平分片的 PGSQL 集群的概览：<a href=https://demo.pigsty.cc/d/pgsql-shard>Demo</a></p></blockquote><p>PGSQL Shard 仪表板展示一个 PGSQL 水平分片集群内的横向指标对比，例如 Citus / GPSQL 集群。</p><p><a href=https://demo.pigsty.cc/d/pgsql-shard><img src=/img/panel/pgsql-shard.webp alt=pgsql-shard></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-71d11dac090b2845d43964a086c029e7>12.2 - 集群面板</h1><div class=lead>PostgreSQL 集群级别监控面板</div><p>PostgreSQL 集群级别监控面板，包括：</p><ul><li><a href=/docs/pgsql/dashboard/cluster/pgsql-cluster>PGSQL Cluster</a>：一个 PGSQL 集群的主仪表板</li><li><a href=/docs/pgsql/dashboard/cluster/pgrds-cluster>PGRDS Cluster</a>：PGSQL Cluster 的 RDS 版本，专注于 PostgreSQL 本身的指标</li><li><a href=/docs/pgsql/dashboard/cluster/pgsql-activity>PGSQL Activity</a>：关注 PGSQL 集群的会话/负载/QPS/TPS/锁定情况</li><li><a href=/docs/pgsql/dashboard/cluster/pgsql-replication>PGSQL Replication</a>：关注 PGSQL 集群复制、插槽和发布/订阅</li><li><a href=/docs/pgsql/dashboard/cluster/pgsql-service>PGSQL Service</a>：关注 PGSQL 集群服务、代理、路由和负载均衡</li><li><a href=/docs/pgsql/dashboard/cluster/pgsql-databases>PGSQL Databases</a>：关注所有实例的数据库 CRUD、慢查询和表统计信息</li><li><a href=/docs/pgsql/dashboard/cluster/pgsql-patroni>PGSQL Patroni</a>：关注集群高可用状态，Patroni 组件状态</li><li><a href=/docs/pgsql/dashboard/cluster/pgsql-pitr>PGSQL PITR</a>：关注集群 PITR 过程的上下文，用于辅助时间点恢复</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ac13540d2c30a80f1d60794c913740ab>12.2.1 - PGSQL Cluster</h1><div class=lead>一个 PGSQL 集群的主仪表板</div><blockquote><p>一个 PGSQL 集群的主仪表板：<a href=https://demo.pigsty.cc/d/pgsql-cluster>Demo</a></p></blockquote><p>PGSQL Cluster 是单个 PostgreSQL 集群的主仪表板，提供集群级别的核心指标概览。</p><p><a href=https://demo.pigsty.cc/d/pgsql-cluster><img src=/img/panel/pgsql-cluster.webp alt=pgsql-cluster></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-777b02cba7b02a268aecc27250e0815d>12.2.2 - PGRDS Cluster</h1><div class=lead>PGSQL Cluster 的 RDS 版本，专注于 PostgreSQL 本身的指标</div><blockquote><p>PGSQL Cluster 的 RDS 版本：<a href=https://demo.pigsty.cc/d/pgrds-cluster>Demo</a></p></blockquote><p>PGRDS Cluster 是 PGSQL Cluster 的 RDS 版本，专注于所有 PostgreSQL 本身的指标，适用于云数据库 RDS 监控场景。</p><p><a href=https://demo.pigsty.cc/d/pgrds-cluster><img src=/img/panel/pgrds-cluster.webp alt=pgrds-cluster></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f593ebcf5a965df4fb71075741e2b77e>12.2.3 - PGSQL Activity</h1><div class=lead>关注 PGSQL 集群的会话/负载/QPS/TPS/锁定情况</div><blockquote><p>关注 PGSQL 集群的会话/负载/QPS/TPS/锁定情况：<a href=https://demo.pigsty.cc/d/pgsql-activity>Demo</a></p></blockquote><p>PGSQL Activity 仪表板关注 PGSQL 集群的会话、负载、QPS、TPS 以及锁定情况。</p><p><a href=https://demo.pigsty.cc/d/pgsql-activity><img src=/img/panel/pgsql-activity.webp alt=pgsql-activity></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-fc20a0ddfc32761378480d5e1617d77f>12.2.4 - PGSQL Replication</h1><div class=lead>关注 PGSQL 集群复制、插槽和发布/订阅</div><blockquote><p>关注 PGSQL 集群复制、插槽和发布/订阅：<a href=https://demo.pigsty.cc/d/pgsql-replication>Demo</a></p></blockquote><p>PGSQL Replication 仪表板关注 PGSQL 集群的复制状态、复制插槽和发布/订阅信息。</p><p><a href=https://demo.pigsty.cc/d/pgsql-replication><img src=/img/panel/pgsql-replication.webp alt=pgsql-replication></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5be6c72f3740f9ca61bbab9d0fb51474>12.2.5 - PGSQL Service</h1><div class=lead>关注 PGSQL 集群服务、代理、路由和负载均衡</div><blockquote><p>关注 PGSQL 集群服务、代理、路由和负载均衡：<a href=https://demo.pigsty.cc/d/pgsql-service>Demo</a></p></blockquote><p>PGSQL Service 仪表板关注 PGSQL 集群的服务、代理、路由和负载均衡状态。</p><p><a href=https://demo.pigsty.cc/d/pgsql-service><img src=/img/panel/pgsql-service.webp alt=pgsql-service></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-49c9b74c56a741db1e680ea66c062840>12.2.6 - PGSQL Databases</h1><div class=lead>关注所有实例的数据库 CRUD、慢查询和表统计信息</div><blockquote><p>关注所有实例的数据库 CRUD、慢查询和表统计信息：<a href=https://demo.pigsty.cc/d/pgsql-databases>Demo</a></p></blockquote><p>PGSQL Databases 仪表板关注集群中所有实例的数据库 CRUD、慢查询和表统计信息。</p><p><a href=https://demo.pigsty.cc/d/pgsql-databases><img src=/img/panel/pgsql-database.webp alt=pgsql-databases></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7c90bff16bde850becbc89a8ff49fa4d>12.2.7 - PGSQL Patroni</h1><div class=lead>关注集群高可用状态，Patroni 组件状态</div><blockquote><p>关注集群高可用状态，Patroni 组件状态：<a href=https://demo.pigsty.cc/d/pgsql-patroni>Demo</a></p></blockquote><p>PGSQL Patroni 仪表板关注集群的高可用状态以及 Patroni 组件的运行状态。</p><p><a href=https://demo.pigsty.cc/d/pgsql-patroni><img src=/img/panel/pgsql-patroni.webp alt=pgsql-patroni></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-3c35cf3066a9271b66140e3ae546cc97>12.2.8 - PGSQL PITR</h1><div class=lead>关注集群 PITR 过程的上下文，用于辅助时间点恢复</div><blockquote><p>关注集群 PITR 过程的上下文：<a href=https://demo.pigsty.cc/d/pgsql-pitr>Demo</a></p></blockquote><p>PGSQL PITR 仪表板关注集群 PITR 过程的上下文，用于辅助时间点恢复操作。</p><p><a href=https://demo.pigsty.cc/d/pgsql-pitr><img src=/img/panel/pgsql-pitr.webp alt=pgsql-pitr></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0d3b46a9e4488b08a97e5a2cd93e8342>12.3 - 实例面板</h1><div class=lead>PostgreSQL 实例级别监控面板</div><p>PostgreSQL 实例级别监控面板，包括：</p><ul><li><a href=/docs/pgsql/dashboard/instance/pgsql-instance>PGSQL Instance</a>：单个 PGSQL 实例的主仪表板</li><li><a href=/docs/pgsql/dashboard/instance/pgrds-instance>PGRDS Instance</a>：PGSQL Instance 的 RDS 版本，专注于 PostgreSQL 本身的指标</li><li><a href=/docs/pgsql/dashboard/instance/pgcat-instance>PGCAT Instance</a>：直接从数据库目录获取的实例信息</li><li><a href=/docs/pgsql/dashboard/instance/pgsql-persist>PGSQL Persist</a>：持久性指标：WAL、XID、检查点、存档、IO</li><li><a href=/docs/pgsql/dashboard/instance/pgsql-proxy>PGSQL Proxy</a>：单个 HAProxy 负载均衡器的详细指标</li><li><a href=/docs/pgsql/dashboard/instance/pgsql-pgbouncer>PGSQL Pgbouncer</a>：单个 Pgbouncer 连接池实例中的指标总览</li><li><a href=/docs/pgsql/dashboard/instance/pgsql-session>PGSQL Session</a>：单个实例中的会话和活动/空闲时间的指标</li><li><a href=/docs/pgsql/dashboard/instance/pgsql-xacts>PGSQL Xacts</a>：关于事务、锁、TPS/QPS 相关的指标</li><li><a href=/docs/pgsql/dashboard/instance/pgsql-exporter>PGSQL Exporter</a>：Postgres 与 Pgbouncer 监控组件自我监控指标</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-efab5aa64980fd75bc6e3faafa448046>12.3.1 - PGSQL Instance</h1><div class=lead>单个 PGSQL 实例的主仪表板</div><blockquote><p>单个 PGSQL 实例的主仪表板：<a href=https://demo.pigsty.cc/d/pgsql-instance>Demo</a></p></blockquote><p>PGSQL Instance 是单个 PostgreSQL 实例的主仪表板，提供实例级别的核心指标概览。</p><p><a href=https://demo.pigsty.cc/d/pgsql-instance><img src=/img/panel/pgsql-instance.webp alt=pgsql-instance></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-745f68183713f01820b7036ca02434dc>12.3.2 - PGRDS Instance</h1><div class=lead>PGSQL Instance 的 RDS 版本，专注于 PostgreSQL 本身的指标</div><blockquote><p>PGSQL Instance 的 RDS 版本：<a href=https://demo.pigsty.cc/d/pgrds-instance>Demo</a></p></blockquote><p>PGRDS Instance 是 PGSQL Instance 的 RDS 版本，专注于所有 PostgreSQL 本身的指标，适用于云数据库 RDS 监控场景。</p><p><a href=https://demo.pigsty.cc/d/pgrds-instance><img src=/img/panel/pgrds-instance.webp alt=pgrds-instance></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-cc7ae26f510c83819e09f711ea4efd4c>12.3.3 - PGCAT Instance</h1><div class=lead>直接从数据库目录获取的实例信息</div><blockquote><p>直接从数据库目录获取的实例信息：<a href=https://demo.pigsty.cc/d/pgcat-instance>Demo</a></p></blockquote><p>PGCAT Instance 仪表板展示直接从数据库系统目录获取的实例信息。</p><p><a href=https://demo.pigsty.cc/d/pgcat-instance><img src=/img/panel/pgcat-instance.webp alt=pgcat-instance></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7e14c54a9f928b5211431714593ff1d7>12.3.4 - PGSQL Persist</h1><div class=lead>持久性指标：WAL、XID、检查点、存档、IO</div><blockquote><p>持久性指标：WAL、XID、检查点、存档、IO：<a href=https://demo.pigsty.cc/d/pgsql-persist>Demo</a></p></blockquote><p>PGSQL Persist 仪表板关注持久性相关指标：WAL、XID、检查点、存档和 IO。</p><p><a href=https://demo.pigsty.cc/d/pgsql-persist><img src=/img/panel/pgsql-persist.webp alt=pgsql-persist></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ab6bcd147d1f1aadd3cac0741c8d3885>12.3.5 - PGSQL Proxy</h1><div class=lead>单个 HAProxy 负载均衡器的详细指标</div><blockquote><p>单个 HAProxy 负载均衡器的详细指标：<a href=https://demo.pigsty.cc/d/pgsql-proxy>Demo</a></p></blockquote><p>PGSQL Proxy 仪表板展示单个 HAProxy 负载均衡器的详细指标。</p><p><a href=https://demo.pigsty.cc/d/pgsql-proxy><img src=/img/panel/pgsql-proxy.webp alt=pgsql-proxy></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-7650b8f9f3f719c7343b60768a765bbe>12.3.6 - PGSQL Pgbouncer</h1><div class=lead>单个 Pgbouncer 连接池实例中的指标总览</div><blockquote><p>单个 Pgbouncer 连接池实例中的指标总览：<a href=https://demo.pigsty.cc/d/pgsql-pgbouncer>Demo</a></p></blockquote><p>PGSQL Pgbouncer 仪表板展示单个 Pgbouncer 连接池实例中的指标总览。</p><p><a href=https://demo.pigsty.cc/d/pgsql-pgbouncer><img src=/img/panel/pgsql-pgbouncer.webp alt=pgsql-pgbouncer></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ca5931906d508cd9f75edfe7218e753c>12.3.7 - PGSQL Session</h1><div class=lead>单个实例中的会话和活动/空闲时间的指标</div><blockquote><p>单个实例中的会话和活动/空闲时间的指标：<a href=https://demo.pigsty.cc/d/pgsql-session>Demo</a></p></blockquote><p>PGSQL Session 仪表板展示单个实例中的会话和活动/空闲时间的指标。</p><p><a href=https://demo.pigsty.cc/d/pgsql-session><img src=/img/panel/pgsql-session.webp alt=pgsql-session></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-9d9def57863d569d20a7a3193aa26c93>12.3.8 - PGSQL Xacts</h1><div class=lead>关于事务、锁、TPS/QPS 相关的指标</div><blockquote><p>关于事务、锁、TPS/QPS 相关的指标：<a href=https://demo.pigsty.cc/d/pgsql-xacts>Demo</a></p></blockquote><p>PGSQL Xacts 仪表板关注事务、锁、TPS/QPS 相关的指标。</p><p><a href=https://demo.pigsty.cc/d/pgsql-xacts><img src=/img/panel/pgsql-xacts.webp alt=pgsql-xacts></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f25ea8d94e36ba9a5b3676cb12633bf2>12.3.9 - PGSQL Exporter</h1><div class=lead>Postgres 与 Pgbouncer 监控组件自我监控指标</div><blockquote><p>Postgres 与 Pgbouncer 监控组件自我监控指标：<a href=https://demo.pigsty.cc/d/pgsql-exporter>Demo</a></p></blockquote><p>PGSQL Exporter 仪表板展示 Postgres 与 Pgbouncer 监控组件的自我监控指标。</p><p><a href=https://demo.pigsty.cc/d/pgsql-exporter><img src=/img/panel/pgsql-exporter.webp alt=pgsql-exporter></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-5ab1262c99945ca6857061b54141248e>12.4 - 数据库面板</h1><div class=lead>PostgreSQL 数据库级别监控面板</div><p>PostgreSQL 数据库级别监控面板，包括：</p><ul><li><a href=/docs/pgsql/dashboard/database/pgsql-database>PGSQL Database</a>：单个 PGSQL 数据库的主仪表板</li><li><a href=/docs/pgsql/dashboard/database/pgcat-database>PGCAT Database</a>：直接从数据库目录获取的数据库信息</li><li><a href=/docs/pgsql/dashboard/database/pgsql-tables>PGSQL Tables</a>：单个数据库内的表/索引访问指标</li><li><a href=/docs/pgsql/dashboard/database/pgsql-table>PGSQL Table</a>：单个表的详细信息（QPS/RT/索引/序列……）</li><li><a href=/docs/pgsql/dashboard/database/pgcat-table>PGCAT Table</a>：直接从数据库目录获取的单个表的详细信息</li><li><a href=/docs/pgsql/dashboard/database/pgsql-query>PGSQL Query</a>：单类查询的详细信息（QPS/RT）</li><li><a href=/docs/pgsql/dashboard/database/pgcat-query>PGCAT Query</a>：直接从数据库目录获取的单类查询的详细信息</li><li><a href=/docs/pgsql/dashboard/database/pgcat-locks>PGCAT Locks</a>：直接从数据库目录获取的关于活动与锁等待的信息</li><li><a href=/docs/pgsql/dashboard/database/pgcat-schema>PGCAT Schema</a>：直接从数据库目录获取关于模式的信息</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-8c17cc1092ed2d1e76d0b7d93b35bbf1>12.4.1 - PGSQL Database</h1><div class=lead>单个 PGSQL 数据库的主仪表板</div><blockquote><p>单个 PGSQL 数据库的主仪表板：<a href=https://demo.pigsty.cc/d/pgsql-database>Demo</a></p></blockquote><p>PGSQL Database 是单个 PostgreSQL 数据库的主仪表板，提供数据库级别的核心指标概览。</p><p><a href=https://demo.pigsty.cc/d/pgsql-database><img src=/img/panel/pgsql-database.webp alt=pgsql-database></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0ecd8fa92a2426ecb8dc9ceaff62f45b>12.4.2 - PGCAT Database</h1><div class=lead>直接从数据库目录获取的数据库信息</div><blockquote><p>直接从数据库目录获取的数据库信息：<a href=https://demo.pigsty.cc/d/pgcat-database>Demo</a></p></blockquote><p>PGCAT Database 仪表板展示直接从数据库系统目录获取的数据库信息。</p><p><a href=https://demo.pigsty.cc/d/pgcat-database><img src=/img/panel/pgcat-database.webp alt=pgcat-database></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-357ff5497ef591ed19467aefaaf30b9d>12.4.3 - PGSQL Tables</h1><div class=lead>单个数据库内的表/索引访问指标</div><blockquote><p>单个数据库内的表/索引访问指标：<a href=https://demo.pigsty.cc/d/pgsql-tables>Demo</a></p></blockquote><p>PGSQL Tables 仪表板展示单个数据库内的表和索引访问指标。</p><p><a href=https://demo.pigsty.cc/d/pgsql-tables><img src=/img/panel/pgsql-tables.webp alt=pgsql-tables></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f9982c1d8e0198daa19cb19992ddc73b>12.4.4 - PGSQL Table</h1><div class=lead>单个表的详细信息（QPS/RT/索引/序列……）</div><blockquote><p>单个表的详细信息：<a href=https://demo.pigsty.cc/d/pgsql-table>Demo</a></p></blockquote><p>PGSQL Table 仪表板展示单个表的详细信息，包括 QPS、RT、索引、序列等指标。</p><p><a href=https://demo.pigsty.cc/d/pgsql-table><img src=/img/panel/pgsql-table.webp alt=pgsql-table></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-c99501fec4430d07944e241ee98f8712>12.4.5 - PGCAT Table</h1><div class=lead>直接从数据库目录获取的单个表的详细信息</div><blockquote><p>直接从数据库目录获取的单个表的详细信息：<a href=https://demo.pigsty.cc/d/pgcat-table>Demo</a></p></blockquote><p>PGCAT Table 仪表板展示直接从数据库系统目录获取的单个表的详细信息，包括统计和膨胀信息。</p><p><a href=https://demo.pigsty.cc/d/pgcat-table><img src=/img/panel/pgcat-table.webp alt=pgcat-table></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-8cf1de3a04204d7b46c3b3846c17a033>12.4.6 - PGSQL Query</h1><div class=lead>单类查询的详细信息（QPS/RT）</div><blockquote><p>单类查询的详细信息：<a href=https://demo.pigsty.cc/d/pgsql-query>Demo</a></p></blockquote><p>PGSQL Query 仪表板展示单类查询的详细信息，包括 QPS 和 RT 指标。</p><p><a href=https://demo.pigsty.cc/d/pgsql-query><img src=/img/panel/pgsql-query.webp alt=pgsql-query></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0e025bec035b17c9d59be41163595514>12.4.7 - PGCAT Query</h1><div class=lead>直接从数据库目录获取的单类查询的详细信息</div><blockquote><p>直接从数据库目录获取的单类查询的详细信息：<a href=https://demo.pigsty.cc/d/pgcat-query>Demo</a></p></blockquote><p>PGCAT Query 仪表板展示直接从数据库系统目录获取的单类查询的详细信息，包括 SQL 和统计信息。</p><p><a href=https://demo.pigsty.cc/d/pgcat-query><img src=/img/panel/pgcat-query.webp alt=pgcat-query></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-0e05e1ef2b7aebfa9cc6f51275cc6cd8>12.4.8 - PGCAT Locks</h1><div class=lead>直接从数据库目录获取的关于活动与锁等待的信息</div><blockquote><p>直接从数据库目录获取的关于活动与锁等待的信息：<a href=https://demo.pigsty.cc/d/pgcat-locks>Demo</a></p></blockquote><p>PGCAT Locks 仪表板展示直接从数据库系统目录获取的关于活动与锁等待的信息。</p><p><a href=https://demo.pigsty.cc/d/pgcat-locks><img src=/img/panel/pgcat-locks.webp alt=pgcat-locks></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-eba5c01f53f336bd71d4a7391ec48511>12.4.9 - PGCAT Schema</h1><div class=lead>直接从数据库目录获取关于模式的信息</div><blockquote><p>直接从数据库目录获取关于模式的信息：<a href=https://demo.pigsty.cc/d/pgcat-schema>Demo</a></p></blockquote><p>PGCAT Schema 仪表板展示直接从数据库系统目录获取的关于模式的信息，包括表、索引、序列等。</p><p><a href=https://demo.pigsty.cc/d/pgcat-schema><img src=/img/panel/pgcat-schema.webp alt=pgcat-schema></a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-1f69b3f46163cb973f38581bf88a88a8>13 - 指标列表</h1><div class=lead>Pigsty PGSQL 模块提供的完整监控指标列表与释义</div><p><a href=/docs/pgsql><strong><code>PGSQL</code></strong></a> 模块包含有 638 类可用监控指标。</p><table class=full-width><thead><tr><th>Metric Name</th><th>Type</th><th>Labels</th><th>Description</th></tr></thead><tbody><tr><td>ALERTS</td><td>Unknown</td><td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>alertstate</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>ALERTS_FOR_STATE</td><td>Unknown</td><td><code>category</code>, <code>job</code>, <code>level</code>, <code>ins</code>, <code>severity</code>, <code>ip</code>, <code>alertname</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>cls:pressure1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>cls:pressure15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>cls:pressure5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>go_gc_duration_seconds</td><td>summary</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>quantile</code>, <code>cls</code></td><td>A summary of the pause duration of garbage collection cycles.</td></tr><tr><td>go_gc_duration_seconds_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>go_gc_duration_seconds_sum</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>go_goroutines</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of goroutines that currently exist.</td></tr><tr><td>go_info</td><td>gauge</td><td><code>version</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Information about the Go environment.</td></tr><tr><td>go_memstats_alloc_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes allocated and still in use.</td></tr><tr><td>go_memstats_alloc_bytes_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of bytes allocated, even if freed.</td></tr><tr><td>go_memstats_buck_hash_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used by the profiling bucket hash table.</td></tr><tr><td>go_memstats_frees_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of frees.</td></tr><tr><td>go_memstats_gc_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for garbage collection system metadata.</td></tr><tr><td>go_memstats_heap_alloc_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes allocated and still in use.</td></tr><tr><td>go_memstats_heap_idle_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes waiting to be used.</td></tr><tr><td>go_memstats_heap_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes that are in use.</td></tr><tr><td>go_memstats_heap_objects</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of allocated objects.</td></tr><tr><td>go_memstats_heap_released_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes released to OS.</td></tr><tr><td>go_memstats_heap_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes obtained from system.</td></tr><tr><td>go_memstats_last_gc_time_seconds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of seconds since 1970 of last garbage collection.</td></tr><tr><td>go_memstats_lookups_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of pointer lookups.</td></tr><tr><td>go_memstats_mallocs_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of mallocs.</td></tr><tr><td>go_memstats_mcache_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes in use by mcache structures.</td></tr><tr><td>go_memstats_mcache_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for mcache structures obtained from system.</td></tr><tr><td>go_memstats_mspan_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes in use by mspan structures.</td></tr><tr><td>go_memstats_mspan_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for mspan structures obtained from system.</td></tr><tr><td>go_memstats_next_gc_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of heap bytes when next garbage collection will take place.</td></tr><tr><td>go_memstats_other_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes used for other system allocations.</td></tr><tr><td>go_memstats_stack_inuse_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes in use by the stack allocator.</td></tr><tr><td>go_memstats_stack_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes obtained from system for stack allocator.</td></tr><tr><td>go_memstats_sys_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of bytes obtained from system.</td></tr><tr><td>go_threads</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of OS threads created.</td></tr><tr><td>ins:pressure1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>ins:pressure15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>ins:pressure5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>patroni_cluster_unlocked</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if the cluster is unlocked, 0 if locked.</td></tr><tr><td>patroni_dcs_last_seen</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Epoch timestamp when DCS was last contacted successfully by Patroni.</td></tr><tr><td>patroni_failsafe_mode_is_active</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if failsafe mode is active, 0 if inactive.</td></tr><tr><td>patroni_is_paused</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if auto failover is disabled, 0 otherwise.</td></tr><tr><td>patroni_master</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is the leader, 0 otherwise.</td></tr><tr><td>patroni_pending_restart</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if the node needs a restart, 0 otherwise.</td></tr><tr><td>patroni_postgres_in_archive_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if Postgres is replicating from archive, 0 otherwise.</td></tr><tr><td>patroni_postgres_running</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if Postgres is running, 0 otherwise.</td></tr><tr><td>patroni_postgres_server_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Version of Postgres (if running), 0 otherwise.</td></tr><tr><td>patroni_postgres_streaming</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if Postgres is streaming, 0 otherwise.</td></tr><tr><td>patroni_postgres_timeline</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Postgres timeline of this node (if running), 0 otherwise.</td></tr><tr><td>patroni_postmaster_start_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Epoch seconds since Postgres started.</td></tr><tr><td>patroni_primary</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is the leader, 0 otherwise.</td></tr><tr><td>patroni_replica</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is a replica, 0 otherwise.</td></tr><tr><td>patroni_standby_leader</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is the standby_leader, 0 otherwise.</td></tr><tr><td>patroni_sync_standby</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if this node is a sync standby replica, 0 otherwise.</td></tr><tr><td>patroni_up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>patroni_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Patroni semver without periods.</td></tr><tr><td>patroni_xlog_location</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current location of the Postgres transaction log, 0 if this node is not the leader.</td></tr><tr><td>patroni_xlog_paused</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Value is 1 if the Postgres xlog is paused, 0 otherwise.</td></tr><tr><td>patroni_xlog_received_location</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current location of the received Postgres transaction log, 0 if this node is not a replica.</td></tr><tr><td>patroni_xlog_replayed_location</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current location of the replayed Postgres transaction log, 0 if this node is not a replica.</td></tr><tr><td>patroni_xlog_replayed_timestamp</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>scope</code></td><td>Current timestamp of the replayed Postgres transaction log, 0 if null.</td></tr><tr><td>pg:cls:active_backends</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:active_time_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:active_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:active_time_rate5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:age</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_alloc_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_clean_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_flush_backend_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:buf_flush_checkpoint_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage_15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage_1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:cpu_usage_5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:db_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:file_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:ixact_backends</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:ixact_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lag_bytes</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lag_seconds</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:leader</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:load1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:load15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:load5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lock_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:locks</td><td>Unknown</td><td><code>job</code>, <code>cls</code>, <code>mode</code></td><td>N/A</td></tr><tr><td>pg:cls:log_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:lsn_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:members</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:num_backends</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:partition</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:receiver</td><td>Unknown</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>appname</code>, <code>ip</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>N/A</td></tr><tr><td>pg:cls:rlock_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:saturation1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:saturation15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:saturation5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:sender</td><td>Unknown</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:session_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:slot_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:slot_retained_bytes</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:standby_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:sync_state</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:timeline</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_deleted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_fetched_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_inserted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_modified_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:tup_returned_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:wal_size</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_commit_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_commit_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_commit_rate5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_rollback_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_rollback_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_rollback_rate5m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_total_rate15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_total_rate1m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xact_total_sigma15m</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:cls:xlock_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_backends</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_time_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_time_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:active_time_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:age</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:age_deriv1h</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:age_exhaust</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blk_io_time_seconds_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blk_read_time_seconds_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blk_write_time_seconds_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_access_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_hit_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_hit_ratio1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:blks_read_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:conn_limit</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:conn_usage</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:db_size</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:ixact_backends</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:ixact_time_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:lock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:num_backends</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:rlock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:session_time_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:temp_bytes_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:temp_files_1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_deleted_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_fetched_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_inserted_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_modified_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:tup_returned_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:wlock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_commit_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_commit_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_commit_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_rollback_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_rollback_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_rollback_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_rate15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_rate5m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xact_total_sigma15m</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:db:xlock_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:env:active_backends</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:active_time_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:active_time_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:active_time_rate5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:age</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_count</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage_15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage_1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:cpu_usage_5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:ixact_backends</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:ixact_time_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:lag_bytes</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:lag_seconds</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:lsn_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:session_time_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_deleted_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_fetched_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_inserted_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_modified_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:tup_returned_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_commit_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_commit_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_commit_rate5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_rollback_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_rollback_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_rollback_rate5m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_total_rate15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_total_rate1m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:env:xact_total_sigma15m</td><td>Unknown</td><td><code>job</code></td><td>N/A</td></tr><tr><td>pg:ins:active_backends</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:active_time_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:active_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:active_time_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:age</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:blks_hit_ratio1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_alloc_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_clean_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_flush_backend_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:buf_flush_checkpoint_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ckpt_1h</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ckpt_req_1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ckpt_timed_1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:conn_limit</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:conn_usage</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage_15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage_1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:cpu_usage_5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:db_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:file_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:fs_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:is_leader</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ixact_backends</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:ixact_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lag_bytes</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lag_seconds</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:load1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:load15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:load5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:locks</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:log_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:lsn_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:mem_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:num_backends</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:rlock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:saturation1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:saturation15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:saturation5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:session_time_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:slot_retained_bytes</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:space_usage</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:status</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:sync_state</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:target_count</td><td>Unknown</td><td><code>job</code>, <code>cls</code>, <code>ins</code></td><td>N/A</td></tr><tr><td>pg:ins:timeline</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_deleted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_fetched_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_inserted_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_modified_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:tup_returned_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:wal_size</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:wlock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_commit_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_commit_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_commit_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_rollback_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_rollback_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_rollback_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_rate15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_rate1m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_rate5m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xact_total_sigma15m</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:ins:xlock_count</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:query:call_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:query:rt_1m</td><td>Unknown</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg:table:scan_rate1m</td><td>Unknown</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg_activity_count</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Count of connection among (datname,state)</td></tr><tr><td>pg_activity_max_conn_duration</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Max backend session duration since state change among (datname, state)</td></tr><tr><td>pg_activity_max_duration</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Max duration since last state change among (datname, state)</td></tr><tr><td>pg_activity_max_tx_duration</td><td>gauge</td><td><code>datname</code>, <code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Max transaction duration since state change among (datname, state)</td></tr><tr><td>pg_archiver_failed_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of failed attempts for archiving WAL files</td></tr><tr><td>pg_archiver_finish_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of WAL files that have been successfully archived</td></tr><tr><td>pg_archiver_last_failed_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time of the last failed archival operation</td></tr><tr><td>pg_archiver_last_finish_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time of the last successful archive operation</td></tr><tr><td>pg_archiver_reset_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which archive statistics were last reset</td></tr><tr><td>pg_backend_count</td><td>gauge</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Database backend process count by backend_type</td></tr><tr><td>pg_bgwriter_buffers_alloc</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers allocated</td></tr><tr><td>pg_bgwriter_buffers_backend</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers written directly by a backend</td></tr><tr><td>pg_bgwriter_buffers_backend_fsync</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times a backend had to execute its own fsync call</td></tr><tr><td>pg_bgwriter_buffers_checkpoint</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers written during checkpoints</td></tr><tr><td>pg_bgwriter_buffers_clean</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffers written by the background writer</td></tr><tr><td>pg_bgwriter_checkpoint_sync_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time that has been spent in the portion of checkpoint processing where files are synchronized to disk, in seconds</td></tr><tr><td>pg_bgwriter_checkpoint_write_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time that has been spent in the portion of checkpoint processing where files are written to disk, in seconds</td></tr><tr><td>pg_bgwriter_checkpoints_req</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of requested checkpoints that have been performed</td></tr><tr><td>pg_bgwriter_checkpoints_timed</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of scheduled checkpoints that have been performed</td></tr><tr><td>pg_bgwriter_maxwritten_clean</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times the background writer stopped a cleaning scan because it had written too many buffers</td></tr><tr><td>pg_bgwriter_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which bgwriter statistics were last reset</td></tr><tr><td>pg_boot_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>unix timestamp when postmaster boot</td></tr><tr><td>pg_checkpoint_checkpoint_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint location</td></tr><tr><td>pg_checkpoint_elapse</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Seconds elapsed since latest checkpoint in seconds</td></tr><tr><td>pg_checkpoint_full_page_writes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s full_page_writes enabled</td></tr><tr><td>pg_checkpoint_newest_commit_ts_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s newestCommitTsXid</td></tr><tr><td>pg_checkpoint_next_multi_offset</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextMultiOffset</td></tr><tr><td>pg_checkpoint_next_multixact_id</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextMultiXactId</td></tr><tr><td>pg_checkpoint_next_oid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextOID</td></tr><tr><td>pg_checkpoint_next_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextXID xid</td></tr><tr><td>pg_checkpoint_next_xid_epoch</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s NextXID epoch</td></tr><tr><td>pg_checkpoint_oldest_active_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestActiveXID</td></tr><tr><td>pg_checkpoint_oldest_commit_ts_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestCommitTsXid</td></tr><tr><td>pg_checkpoint_oldest_multi_dbid</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestMulti&rsquo;s DB OID</td></tr><tr><td>pg_checkpoint_oldest_multi_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestMultiXid</td></tr><tr><td>pg_checkpoint_oldest_xid</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestXID</td></tr><tr><td>pg_checkpoint_oldest_xid_dbid</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s oldestXID&rsquo;s DB OID</td></tr><tr><td>pg_checkpoint_prev_tli</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s PrevTimeLineID</td></tr><tr><td>pg_checkpoint_redo_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s REDO location</td></tr><tr><td>pg_checkpoint_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time of latest checkpoint</td></tr><tr><td>pg_checkpoint_tli</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Latest checkpoint&rsquo;s TimeLineID</td></tr><tr><td>pg_conf_reload_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since last configuration reload</td></tr><tr><td>pg_db_active_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent executing SQL statements in this database, in seconds</td></tr><tr><td>pg_db_age</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Age of database calculated from datfrozenxid</td></tr><tr><td>pg_db_allow_conn</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>If false(0) then no one can connect to this database.</td></tr><tr><td>pg_db_blk_read_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent reading data file blocks by backends in this database, in seconds</td></tr><tr><td>pg_db_blk_write_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent writing data file blocks by backends in this database, in seconds</td></tr><tr><td>pg_db_blks_access</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times disk blocks that accessed read+hit</td></tr><tr><td>pg_db_blks_hit</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times disk blocks were found already in the buffer cache</td></tr><tr><td>pg_db_blks_read</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read in this database</td></tr><tr><td>pg_db_cks_fail_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which the last data page checksum failure was detected in this database</td></tr><tr><td>pg_db_cks_fails</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of data page checksum failures detected in this database, -1 for not enabled</td></tr><tr><td>pg_db_confl_confl_bufferpin</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to pinned buffers</td></tr><tr><td>pg_db_confl_confl_deadlock</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to deadlocks</td></tr><tr><td>pg_db_confl_confl_lock</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to lock timeouts</td></tr><tr><td>pg_db_confl_confl_snapshot</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to old snapshots</td></tr><tr><td>pg_db_confl_confl_tablespace</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries in this database that have been canceled due to dropped tablespaces</td></tr><tr><td>pg_db_conflicts</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of queries canceled due to conflicts with recovery in this database</td></tr><tr><td>pg_db_conn_limit</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Sets maximum number of concurrent connections that can be made to this database. -1 means no limit.</td></tr><tr><td>pg_db_datid</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>OID of the database</td></tr><tr><td>pg_db_deadlocks</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of deadlocks detected in this database</td></tr><tr><td>pg_db_frozen_xid</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>All transaction IDs before this one have been frozened</td></tr><tr><td>pg_db_is_template</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>If true(1), then this database can be cloned by any user with CREATEDB privileges</td></tr><tr><td>pg_db_ixact_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent idling while in a transaction in this database, in seconds</td></tr><tr><td>pg_db_numbackends</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of backends currently connected to this database</td></tr><tr><td>pg_db_reset_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which database statistics were last reset</td></tr><tr><td>pg_db_session_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent by database sessions in this database, in seconds</td></tr><tr><td>pg_db_sessions</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of sessions established to this database</td></tr><tr><td>pg_db_sessions_abandoned</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of database sessions to this database that were terminated because connection to the client was lost</td></tr><tr><td>pg_db_sessions_fatal</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of database sessions to this database that were terminated by fatal errors</td></tr><tr><td>pg_db_sessions_killed</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of database sessions to this database that were terminated by operator intervention</td></tr><tr><td>pg_db_temp_bytes</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of data written to temporary files by queries in this database.</td></tr><tr><td>pg_db_temp_files</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of temporary files created by queries in this database</td></tr><tr><td>pg_db_tup_deleted</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows deleted by queries in this database</td></tr><tr><td>pg_db_tup_fetched</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows fetched by queries in this database</td></tr><tr><td>pg_db_tup_inserted</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows inserted by queries in this database</td></tr><tr><td>pg_db_tup_modified</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows modified by queries in this database</td></tr><tr><td>pg_db_tup_returned</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows returned by queries in this database</td></tr><tr><td>pg_db_tup_updated</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows updated by queries in this database</td></tr><tr><td>pg_db_xact_commit</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of transactions in this database that have been committed</td></tr><tr><td>pg_db_xact_rollback</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of transactions in this database that have been rolled back</td></tr><tr><td>pg_db_xact_total</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of transactions in this database</td></tr><tr><td>pg_downstream_count</td><td>gauge</td><td><code>state</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Count of corresponding state</td></tr><tr><td>pg_exporter_agent_up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg_exporter_last_scrape_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pg_exporter_query_cache_ttl</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times to live of query cache</td></tr><tr><td>pg_exporter_query_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds query spending on scrapping</td></tr><tr><td>pg_exporter_query_scrape_error_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times the query failed</td></tr><tr><td>pg_exporter_query_scrape_hit_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers been scrapped from this query</td></tr><tr><td>pg_exporter_query_scrape_metric_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers of metrics been scrapped from this query</td></tr><tr><td>pg_exporter_query_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pg_exporter_scrape_duration</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pg_exporter_scrape_error_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics and failed</td></tr><tr><td>pg_exporter_scrape_total_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics</td></tr><tr><td>pg_exporter_server_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pg_exporter_server_scrape_error_count</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pg_exporter_server_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pg_exporter_server_scrape_total_seconds</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pg_exporter_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>always be 1 if your could retrieve metrics</td></tr><tr><td>pg_exporter_uptime</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since exporter primary server inited</td></tr><tr><td>pg_flush_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>primary only, location of current wal syncing</td></tr><tr><td>pg_func_calls</td><td>counter</td><td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this function has been called</td></tr><tr><td>pg_func_self_time</td><td>counter</td><td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time spent in this function itself, not including other functions called by it, in ms</td></tr><tr><td>pg_func_total_time</td><td>counter</td><td><code>datname</code>, <code>funcname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time spent in this function and all other functions called by it, in ms</td></tr><tr><td>pg_in_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server is in recovery mode? 1 for yes 0 for no</td></tr><tr><td>pg_index_idx_blks_hit</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of buffer hits in this index</td></tr><tr><td>pg_index_idx_blks_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of disk blocks read from this index</td></tr><tr><td>pg_index_idx_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of index scans initiated on this index</td></tr><tr><td>pg_index_idx_tup_fetch</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of live table rows fetched by simple index scans using this index</td></tr><tr><td>pg_index_idx_tup_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Number of index entries returned by scans on this index</td></tr><tr><td>pg_index_relpages</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Size of the on-disk representation of this index in pages</td></tr><tr><td>pg_index_reltuples</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>relid</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>idxname</code></td><td>Estimate relation tuples</td></tr><tr><td>pg_insert_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>primary only, location of current wal inserting</td></tr><tr><td>pg_io_evictions</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of times a block has been written out from a shared or local buffer</td></tr><tr><td>pg_io_extend_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in extend operations in seconds</td></tr><tr><td>pg_io_extends</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of relation extend operations, each of the size specified in op_bytes.</td></tr><tr><td>pg_io_fsync_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in fsync operations in seconds</td></tr><tr><td>pg_io_fsyncs</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of fsync calls. These are only tracked in context normal</td></tr><tr><td>pg_io_hits</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>The number of times a desired block was found in a shared buffer.</td></tr><tr><td>pg_io_op_bytes</td><td>gauge</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>The number of bytes per unit of I/O read, written, or extended. 8192 by default</td></tr><tr><td>pg_io_read_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in read operations in seconds</td></tr><tr><td>pg_io_reads</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of read operations, each of the size specified in op_bytes.</td></tr><tr><td>pg_io_reset_time</td><td>gauge</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Timestamp at which these statistics were last reset</td></tr><tr><td>pg_io_reuses</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>The number of times an existing buffer in reused</td></tr><tr><td>pg_io_write_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in write operations in seconds</td></tr><tr><td>pg_io_writeback_time</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Time spent in writeback operations in seconds</td></tr><tr><td>pg_io_writebacks</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of units of size op_bytes which the process requested the kernel write out to permanent storage.</td></tr><tr><td>pg_io_writes</td><td>counter</td><td><code>type</code>, <code>job</code>, <code>ins</code>, <code>object</code>, <code>ip</code>, <code>context</code>, <code>instance</code>, <code>cls</code></td><td>Number of write operations, each of the size specified in op_bytes.</td></tr><tr><td>pg_is_in_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>1 if in recovery mode</td></tr><tr><td>pg_is_wal_replay_paused</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>1 if wal play paused</td></tr><tr><td>pg_lag</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>replica only, replication lag in seconds</td></tr><tr><td>pg_last_replay_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>time when last transaction been replayed</td></tr><tr><td>pg_lock_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>mode</code>, <code>instance</code>, <code>cls</code></td><td>Number of locks of corresponding mode and database</td></tr><tr><td>pg_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>log sequence number, current write location</td></tr><tr><td>pg_meta_info</td><td>gauge</td><td><code>cls</code>, <code>extensions</code>, <code>version</code>, <code>job</code>, <code>ins</code>, <code>primary_conninfo</code>, <code>conf_path</code>, <code>hba_path</code>, <code>ip</code>, <code>cluster_id</code>, <code>instance</code>, <code>listen_port</code>, <code>wal_level</code>, <code>ver_num</code>, <code>cluster_name</code>, <code>data_dir</code></td><td>constant 1</td></tr><tr><td>pg_query_calls</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times the statement was executed</td></tr><tr><td>pg_query_exec_time</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time spent executing the statement, in seconds</td></tr><tr><td>pg_query_io_time</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total time the statement spent reading and writing blocks, in seconds</td></tr><tr><td>pg_query_rows</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of rows retrieved or affected by the statement</td></tr><tr><td>pg_query_sblk_dirtied</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared blocks dirtied by the statement</td></tr><tr><td>pg_query_sblk_hit</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared block cache hits by the statement</td></tr><tr><td>pg_query_sblk_read</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared blocks read by the statement</td></tr><tr><td>pg_query_sblk_written</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of shared blocks written by the statement</td></tr><tr><td>pg_query_wal_bytes</td><td>counter</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of WAL bytes generated by the statement</td></tr><tr><td>pg_receive_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>replica only, location of wal synced to disk</td></tr><tr><td>pg_recovery_backup_end_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Backup end location</td></tr><tr><td>pg_recovery_backup_start_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Backup start location</td></tr><tr><td>pg_recovery_min_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Minimum recovery ending location</td></tr><tr><td>pg_recovery_min_timeline</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Min recovery ending loc&rsquo;s timeline</td></tr><tr><td>pg_recovery_prefetch_block_distance</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>How many blocks ahead the prefetcher is looking</td></tr><tr><td>pg_recovery_prefetch_hit</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they were already in the buffer pool</td></tr><tr><td>pg_recovery_prefetch_io_depth</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>How many prefetches have been initiated but are not yet known to have completed</td></tr><tr><td>pg_recovery_prefetch_prefetch</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks prefetched because they were not in the buffer pool</td></tr><tr><td>pg_recovery_prefetch_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which these recovery prefetch statistics were last reset</td></tr><tr><td>pg_recovery_prefetch_skip_fpw</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because a full page image was included in the WAL</td></tr><tr><td>pg_recovery_prefetch_skip_init</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they would be zero-initialized</td></tr><tr><td>pg_recovery_prefetch_skip_new</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they didn&rsquo;t exist yet</td></tr><tr><td>pg_recovery_prefetch_skip_rep</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks not prefetched because they were already recently prefetched</td></tr><tr><td>pg_recovery_prefetch_wal_distance</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>How many bytes ahead the prefetcher is looking</td></tr><tr><td>pg_recovery_require_record</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>End-of-backup record required</td></tr><tr><td>pg_recv_flush_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Last write-ahead log location already received and flushed to disk</td></tr><tr><td>pg_recv_flush_tli</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Timeline number of last write-ahead log location received and flushed to disk</td></tr><tr><td>pg_recv_init_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>First write-ahead log location used when WAL receiver is started</td></tr><tr><td>pg_recv_init_tli</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>First timeline number used when WAL receiver is started</td></tr><tr><td>pg_recv_msg_recv_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Receipt time of last message received from origin WAL sender</td></tr><tr><td>pg_recv_msg_send_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Send time of last message received from origin WAL sender</td></tr><tr><td>pg_recv_pid</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Process ID of the WAL receiver process</td></tr><tr><td>pg_recv_reported_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Last write-ahead log location reported to origin WAL sender</td></tr><tr><td>pg_recv_reported_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Time of last write-ahead log location reported to origin WAL sender</td></tr><tr><td>pg_recv_time</td><td>gauge</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Time of current snapshot</td></tr><tr><td>pg_recv_write_lsn</td><td>counter</td><td><code>state</code>, <code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>sender_host</code>, <code>sender_port</code></td><td>Last write-ahead log location already received and written to disk, but not flushed.</td></tr><tr><td>pg_relkind_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>relkind</code></td><td>Number of relations of corresponding relkind</td></tr><tr><td>pg_repl_backend_xmin</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>This standby&rsquo;s xmin horizon reported by hot_standby_feedback.</td></tr><tr><td>pg_repl_client_port</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>TCP port number that the client is using for communication with this WAL sender, or -1 if a Unix socket is used</td></tr><tr><td>pg_repl_flush_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position flushed to disk by this standby server diff with current lsn</td></tr><tr><td>pg_repl_flush_lag</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written and flushed it</td></tr><tr><td>pg_repl_flush_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location flushed to disk by this standby server</td></tr><tr><td>pg_repl_launch_time</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time when this process was started, i.e., when the client connected to this WAL sender</td></tr><tr><td>pg_repl_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current log position on this server</td></tr><tr><td>pg_repl_replay_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position replayed into the database on this standby server diff with current lsn</td></tr><tr><td>pg_repl_replay_lag</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written, flushed and applied it</td></tr><tr><td>pg_repl_replay_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location replayed into the database on this standby server</td></tr><tr><td>pg_repl_reply_time</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Send time of last reply message received from standby server</td></tr><tr><td>pg_repl_sent_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position sent to this standby server diff with current lsn</td></tr><tr><td>pg_repl_sent_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location sent on this connection</td></tr><tr><td>pg_repl_state</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current WAL sender encoded state 0-4 for streaming startup catchup backup stopping</td></tr><tr><td>pg_repl_sync_priority</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Priority of this standby server for being chosen as the synchronous standby</td></tr><tr><td>pg_repl_sync_state</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Encoded synchronous state of this standby server, 0-3 for async potential sync quorum</td></tr><tr><td>pg_repl_time</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current timestamp in unix epoch</td></tr><tr><td>pg_repl_write_diff</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last log position written to disk by this standby server diff with current lsn</td></tr><tr><td>pg_repl_write_lag</td><td>gauge</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time elapsed between flushing recent WAL locally and receiving notification that this standby server has written it</td></tr><tr><td>pg_repl_write_lsn</td><td>counter</td><td><code>pid</code>, <code>usename</code>, <code>address</code>, <code>job</code>, <code>ins</code>, <code>appname</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Last write-ahead log location written to disk by this standby server</td></tr><tr><td>pg_replay_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>replica only, location of wal applied</td></tr><tr><td>pg_seq_blks_hit</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td><td>Number of buffer hits in this sequence</td></tr><tr><td>pg_seq_blks_read</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td><td>Number of disk blocks read from this sequence</td></tr><tr><td>pg_seq_last_value</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code>, <code>seqname</code></td><td>The last sequence value written to disk</td></tr><tr><td>pg_setting_block_size</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>pg page block size, 8192 by default</td></tr><tr><td>pg_setting_data_checksums</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>whether data checksum is enabled, 1 enabled 0 disabled</td></tr><tr><td>pg_setting_max_connections</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>number of concurrent connections to the database server</td></tr><tr><td>pg_setting_max_locks_per_transaction</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>no more than this many distinct objects can be locked at any one time</td></tr><tr><td>pg_setting_max_prepared_transactions</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of transactions that can be in the prepared state simultaneously</td></tr><tr><td>pg_setting_max_replication_slots</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of replication slots</td></tr><tr><td>pg_setting_max_wal_senders</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of concurrent connections from standby servers</td></tr><tr><td>pg_setting_max_worker_processes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>maximum number of background processes that the system can support</td></tr><tr><td>pg_setting_wal_log_hints</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>whether wal_log_hints is enabled, 1 enabled 0 disabled</td></tr><tr><td>pg_size_bytes</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>File size in bytes</td></tr><tr><td>pg_slot_active</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>True(1) if this slot is currently actively being used</td></tr><tr><td>pg_slot_catalog_xmin</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The oldest transaction affecting the system catalogs that this slot needs the database to retain.</td></tr><tr><td>pg_slot_confirm_lsn</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The address (LSN) up to which the logical slot&rsquo;s consumer has confirmed receiving data.</td></tr><tr><td>pg_slot_reset_time</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>When statistics were last reset</td></tr><tr><td>pg_slot_restart_lsn</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The address (LSN) of oldest WAL which still might be required by the consumer of this slot</td></tr><tr><td>pg_slot_retained_bytes</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Size of bytes that retained for this slot</td></tr><tr><td>pg_slot_safe_wal_size</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>bytes that can be written to WAL which will not make slot into lost</td></tr><tr><td>pg_slot_spill_bytes</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes that spilled to disk due to logical decode mem exceeding</td></tr><tr><td>pg_slot_spill_count</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that spilled to disk due to logical decode mem exceeding (a xact can be spilled multiple times)</td></tr><tr><td>pg_slot_spill_txns</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that spilled to disk due to logical decode mem exceeding (subtrans included)</td></tr><tr><td>pg_slot_stream_bytes</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes that streamed to decoding output plugin after mem exceed</td></tr><tr><td>pg_slot_stream_count</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that streamed to decoding output plugin after mem exceed (a xact can be streamed multiple times)</td></tr><tr><td>pg_slot_stream_txns</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Xacts that streamed to decoding output plugin after mem exceed</td></tr><tr><td>pg_slot_temporary</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>True(1) if this is a temporary replication slot.</td></tr><tr><td>pg_slot_total_bytes</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of decoded bytes sent to the decoding output plugin for this slot</td></tr><tr><td>pg_slot_total_txns</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of decoded xacts sent to the decoding output plugin for this slot</td></tr><tr><td>pg_slot_wal_status</td><td>gauge</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>WAL reserve status 0-3 means reserved,extended,unreserved,lost, -1 means other</td></tr><tr><td>pg_slot_xmin</td><td>counter</td><td><code>slot_name</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>The oldest transaction that this slot needs the database to retain.</td></tr><tr><td>pg_slru_blks_exists</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks checked for existence for this SLRU</td></tr><tr><td>pg_slru_blks_hit</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times disk blocks were found already in the SLRU, so that a read was not necessary</td></tr><tr><td>pg_slru_blks_read</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read for this SLRU</td></tr><tr><td>pg_slru_blks_written</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks written for this SLRU</td></tr><tr><td>pg_slru_blks_zeroed</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of blocks zeroed during initializations</td></tr><tr><td>pg_slru_flushes</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of flushes of dirty data for this SLRU</td></tr><tr><td>pg_slru_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time at which these statistics were last reset</td></tr><tr><td>pg_slru_truncates</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of truncates for this SLRU</td></tr><tr><td>pg_ssl_disabled</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of client connection that does not use ssl</td></tr><tr><td>pg_ssl_enabled</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of client connection that use ssl</td></tr><tr><td>pg_sync_standby_enabled</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>names</code>, <code>instance</code>, <code>cls</code></td><td>Synchronous commit enabled, 1 if enabled, 0 if disabled</td></tr><tr><td>pg_table_age</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Age of this table in vacuum cycles</td></tr><tr><td>pg_table_analyze_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been manually analyzed</td></tr><tr><td>pg_table_autoanalyze_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been analyzed by the autovacuum daemon</td></tr><tr><td>pg_table_autovacuum_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been vacuumed by the autovacuum daemon</td></tr><tr><td>pg_table_frozenxid</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>All txid before this have been frozen on this table</td></tr><tr><td>pg_table_heap_blks_hit</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffer hits in this table</td></tr><tr><td>pg_table_heap_blks_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read from this table</td></tr><tr><td>pg_table_idx_blks_hit</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of buffer hits in all indexes on this table</td></tr><tr><td>pg_table_idx_blks_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of disk blocks read from all indexes on this table</td></tr><tr><td>pg_table_idx_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of index scans initiated on this table</td></tr><tr><td>pg_table_idx_tup_fetch</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of live rows fetched by index scans</td></tr><tr><td>pg_table_kind</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Relation kind r/table/114</td></tr><tr><td>pg_table_n_dead_tup</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of dead rows</td></tr><tr><td>pg_table_n_ins_since_vacuum</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of rows inserted since this table was last vacuumed</td></tr><tr><td>pg_table_n_live_tup</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of live rows</td></tr><tr><td>pg_table_n_mod_since_analyze</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Estimated number of rows modified since this table was last analyzed</td></tr><tr><td>pg_table_n_tup_del</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows deleted</td></tr><tr><td>pg_table_n_tup_hot_upd</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows HOT updated (i.e with no separate index update required)</td></tr><tr><td>pg_table_n_tup_ins</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows inserted</td></tr><tr><td>pg_table_n_tup_mod</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows modified (insert + update + delete)</td></tr><tr><td>pg_table_n_tup_newpage_upd</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows updated where the successor version goes onto a new heap page</td></tr><tr><td>pg_table_n_tup_upd</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of rows updated (includes HOT updated rows)</td></tr><tr><td>pg_table_ncols</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of columns in the table</td></tr><tr><td>pg_table_pages</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Size of the on-disk representation of this table in pages</td></tr><tr><td>pg_table_relid</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Relation oid of this table</td></tr><tr><td>pg_table_seq_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of sequential scans initiated on this table</td></tr><tr><td>pg_table_seq_tup_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of live rows fetched by sequential scans</td></tr><tr><td>pg_table_size_bytes</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total bytes of this table (including toast, index, toast index)</td></tr><tr><td>pg_table_size_indexsize</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes of all related indexes of this table</td></tr><tr><td>pg_table_size_relsize</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes of this table itself (main, vm, fsm)</td></tr><tr><td>pg_table_size_toastsize</td><td>gauge</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Bytes of toast tables of this table</td></tr><tr><td>pg_table_tbl_scan</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of scans initiated on this table</td></tr><tr><td>pg_table_tup_read</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of live rows fetched by scans</td></tr><tr><td>pg_table_tuples</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>All txid before this have been frozen on this table</td></tr><tr><td>pg_table_vacuum_count</td><td>counter</td><td><code>datname</code>, <code>relname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times this table has been manually vacuumed (not counting VACUUM FULL)</td></tr><tr><td>pg_timestamp</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>database current timestamp</td></tr><tr><td>pg_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>last scrape was able to connect to the server: 1 for yes, 0 for no</td></tr><tr><td>pg_uptime</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since postmaster start</td></tr><tr><td>pg_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server version number</td></tr><tr><td>pg_wait_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>event</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Count of WaitEvent on target database</td></tr><tr><td>pg_wal_buffers_full</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times WAL data was written to disk because WAL buffers became full</td></tr><tr><td>pg_wal_bytes</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of WAL generated in bytes</td></tr><tr><td>pg_wal_fpi</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of WAL full page images generated</td></tr><tr><td>pg_wal_records</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of WAL records generated</td></tr><tr><td>pg_wal_reset_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>When statistics were last reset</td></tr><tr><td>pg_wal_sync</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times WAL files were synced to disk via issue_xlog_fsync request</td></tr><tr><td>pg_wal_sync_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time spent syncing WAL files to disk via issue_xlog_fsync request, in seconds</td></tr><tr><td>pg_wal_write</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of times WAL buffers were written out to disk via XLogWrite request.</td></tr><tr><td>pg_wal_write_time</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total amount of time spent writing WAL buffers to disk via XLogWrite request in seconds</td></tr><tr><td>pg_write_lsn</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>primary only, location of current wal writing</td></tr><tr><td>pg_xact_xmax</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>First as-yet-unassigned txid. txid >= this are invisible.</td></tr><tr><td>pg_xact_xmin</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Earliest txid that is still active</td></tr><tr><td>pg_xact_xnum</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current active transaction count</td></tr><tr><td>pgbouncer:cls:load1</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:cls:load15</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:cls:load5</td><td>Unknown</td><td><code>job</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:conn_usage</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:conn_usage_reserve</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_current_conn</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_disabled</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_max_conn</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_paused</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_reserve_size</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:db:pool_size</td><td>Unknown</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:free_clients</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:free_servers</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:load1</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:load15</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:load5</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:login_clients</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:pool_databases</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:pool_users</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:pools</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer:ins:used_clients</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer_database_current_connections</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Current number of connections for this database</td></tr><tr><td>pgbouncer_database_disabled</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>True(1) if this database is currently disabled, else 0</td></tr><tr><td>pgbouncer_database_max_connections</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Maximum number of allowed connections for this database</td></tr><tr><td>pgbouncer_database_min_pool_size</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Minimum number of server connections</td></tr><tr><td>pgbouncer_database_paused</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>True(1) if this database is currently paused, else 0</td></tr><tr><td>pgbouncer_database_pool_size</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Maximum number of server connections</td></tr><tr><td>pgbouncer_database_reserve_pool</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>host</code>, <code>cls</code>, <code>real_datname</code>, <code>port</code></td><td>Maximum number of additional connections for this database</td></tr><tr><td>pgbouncer_exporter_agent_up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>pgbouncer_exporter_last_scrape_time</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pgbouncer_exporter_query_cache_ttl</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times to live of query cache</td></tr><tr><td>pgbouncer_exporter_query_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds query spending on scrapping</td></tr><tr><td>pgbouncer_exporter_query_scrape_error_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times the query failed</td></tr><tr><td>pgbouncer_exporter_query_scrape_hit_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers been scrapped from this query</td></tr><tr><td>pgbouncer_exporter_query_scrape_metric_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>numbers of metrics been scrapped from this query</td></tr><tr><td>pgbouncer_exporter_query_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>query</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pgbouncer_exporter_scrape_duration</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter spending on scrapping</td></tr><tr><td>pgbouncer_exporter_scrape_error_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics and failed</td></tr><tr><td>pgbouncer_exporter_scrape_total_count</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter was scraped for metrics</td></tr><tr><td>pgbouncer_exporter_server_scrape_duration</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pgbouncer_exporter_server_scrape_total_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>times exporter server was scraped for metrics</td></tr><tr><td>pgbouncer_exporter_server_scrape_total_seconds</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds exporter server spending on scrapping</td></tr><tr><td>pgbouncer_exporter_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>always be 1 if your could retrieve metrics</td></tr><tr><td>pgbouncer_exporter_uptime</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>seconds since exporter primary server inited</td></tr><tr><td>pgbouncer_in_recovery</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server is in recovery mode? 1 for yes 0 for no</td></tr><tr><td>pgbouncer_list_items</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>list</code>, <code>cls</code></td><td>Number of corresponding pgbouncer object</td></tr><tr><td>pgbouncer_pool_active_cancel_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that have forwarded query cancellations to the server and are waiting for the server response.</td></tr><tr><td>pgbouncer_pool_active_cancel_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are currently forwarding a cancel request</td></tr><tr><td>pgbouncer_pool_active_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that are linked to server connection and can process queries</td></tr><tr><td>pgbouncer_pool_active_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are linked to a client</td></tr><tr><td>pgbouncer_pool_cancel_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that have not forwarded query cancellations to the server yet.</td></tr><tr><td>pgbouncer_pool_cancel_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>cancel requests have completed that were sent to cancel a query on this server</td></tr><tr><td>pgbouncer_pool_idle_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are unused and immediately usable for client queries</td></tr><tr><td>pgbouncer_pool_login_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections currently in the process of logging in</td></tr><tr><td>pgbouncer_pool_maxwait</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>How long the first(oldest) client in the queue has waited, in seconds, key metric</td></tr><tr><td>pgbouncer_pool_maxwait_us</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Microsecond part of the maximum waiting time.</td></tr><tr><td>pgbouncer_pool_tested_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that are currently running reset or check query</td></tr><tr><td>pgbouncer_pool_used_servers</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Server connections that have been idle for more than server_check_delay (means have to run check query)</td></tr><tr><td>pgbouncer_pool_waiting_clients</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>user</code>, <code>cls</code>, <code>pool_mode</code></td><td>Client connections that have sent queries but have not yet got a server connection</td></tr><tr><td>pgbouncer_stat_avg_query_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average queries per second in last stat period</td></tr><tr><td>pgbouncer_stat_avg_query_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average query duration, in seconds</td></tr><tr><td>pgbouncer_stat_avg_recv</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average received (from clients) bytes per second</td></tr><tr><td>pgbouncer_stat_avg_sent</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average sent (to clients) bytes per second</td></tr><tr><td>pgbouncer_stat_avg_wait_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent by clients waiting for a server, in seconds (average per second).</td></tr><tr><td>pgbouncer_stat_avg_xact_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average transactions per second in last stat period</td></tr><tr><td>pgbouncer_stat_avg_xact_time</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Average transaction duration, in seconds</td></tr><tr><td>pgbouncer_stat_total_query_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of SQL queries pooled by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_query_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of seconds spent when executing queries</td></tr><tr><td>pgbouncer_stat_total_received</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total volume in bytes of network traffic received by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_sent</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total volume in bytes of network traffic sent by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_wait_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Time spent by clients waiting for a server, in seconds</td></tr><tr><td>pgbouncer_stat_total_xact_count</td><td>gauge</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of SQL transactions pooled by pgbouncer</td></tr><tr><td>pgbouncer_stat_total_xact_time</td><td>counter</td><td><code>datname</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of seconds spent when in a transaction</td></tr><tr><td>pgbouncer_up</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>last scrape was able to connect to the server: 1 for yes, 0 for no</td></tr><tr><td>pgbouncer_version</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>server version number</td></tr><tr><td>process_cpu_seconds_total</td><td>counter</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total user and system CPU time spent in seconds.</td></tr><tr><td>process_max_fds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Maximum number of open file descriptors.</td></tr><tr><td>process_open_fds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Number of open file descriptors.</td></tr><tr><td>process_resident_memory_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Resident memory size in bytes.</td></tr><tr><td>process_start_time_seconds</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Start time of the process since unix epoch in seconds.</td></tr><tr><td>process_virtual_memory_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Virtual memory size in bytes.</td></tr><tr><td>process_virtual_memory_max_bytes</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Maximum amount of virtual memory available in bytes.</td></tr><tr><td>promhttp_metric_handler_requests_in_flight</td><td>gauge</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Current number of scrapes being served.</td></tr><tr><td>promhttp_metric_handler_requests_total</td><td>counter</td><td><code>code</code>, <code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>Total number of scrapes by HTTP status code.</td></tr><tr><td>scrape_duration_seconds</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>scrape_samples_post_metric_relabeling</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>scrape_samples_scraped</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>scrape_series_added</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr><tr><td>up</td><td>Unknown</td><td><code>job</code>, <code>ins</code>, <code>ip</code>, <code>instance</code>, <code>cls</code></td><td>N/A</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-aecdecaf4fe39eee883ee97a664ab88f>14 - 参数列表</h1><div class=lead>PGSQL 模块提供的 PostgreSQL 相关配置参数详解</div><p><a href=/docs/pgsql><code>PGSQL</code></a> 模块需要在 Pigsty 管理的节点上安装（即节点已经配置了 <a href=/docs/node><code>NODE</code></a> 模块），同时还要求您的部署中有一套可用的 <a href=/docs/etcd><code>ETCD</code></a> 集群来存储集群元数据。</p><p>在单个节点上安装 <code>PGSQL</code> 模块将创建一个独立的 PGSQL 服务器/实例，即 <a href=/docs/pgsql/config/cluster#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93>主实例</a>。
在额外节点上安装将创建 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读副本</a>，可以作为备用实例，并用于承载分担只读请求。
您还可以创建用于 ETL/OLAP/交互式查询的 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线</a> 实例， 使用 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a> 和 <a href=/docs/pgsql/config/cluster#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4>法定人数提交</a> 来提高数据一致性，
甚至搭建 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a> 和 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟集群</a> 以快速应对人为失误与软件缺陷导致的数据损失。</p><p>您可以定义多个 PGSQL 集群并进一步组建一个水平分片集群： Pigsty 支持原生的 <a href=/docs/pgsql/config/cluster#citus%E9%9B%86%E7%BE%A4>citus 集群组</a>，可以将您的标准 PGSQL 集群原地升级为一个分布式的数据库集群。</p><blockquote><p>Pigsty v4.1 默认使用 PostgreSQL 18，并提供 <code>pg_io_method</code>、<code>pgbackrest_exporter</code>、<code>pgbouncer_exporter</code> 等相关参数。</p></blockquote><hr><table class=full-width><thead><tr><th style=text-align:left>参数组</th><th style=text-align:left>功能说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_id><code>PG_ID</code></a></td><td style=text-align:left>PostgreSQL 集群与实例的身份标识参数</td></tr><tr><td style=text-align:left><a href=#pg_business><code>PG_BUSINESS</code></a></td><td style=text-align:left>业务用户、数据库、服务与访问控制规则定义</td></tr><tr><td style=text-align:left><a href=#pg_install><code>PG_INSTALL</code></a></td><td style=text-align:left>PostgreSQL 安装相关：版本、路径、软件包</td></tr><tr><td style=text-align:left><a href=#pg_bootstrap><code>PG_BOOTSTRAP</code></a></td><td style=text-align:left>PostgreSQL 集群初始化引导：Patroni 高可用</td></tr><tr><td style=text-align:left><a href=#pg_provision><code>PG_PROVISION</code></a></td><td style=text-align:left>PostgreSQL 集群模板置备：角色、权限、扩展</td></tr><tr><td style=text-align:left><a href=#pg_backup><code>PG_BACKUP</code></a></td><td style=text-align:left>pgBackRest 备份与恢复配置</td></tr><tr><td style=text-align:left><a href=#pg_access><code>PG_ACCESS</code></a></td><td style=text-align:left>服务暴露、连接池、VIP、DNS 等客户端访问配置</td></tr><tr><td style=text-align:left><a href=#pg_monitor><code>PG_MONITOR</code></a></td><td style=text-align:left>PostgreSQL 监控 Exporter 配置</td></tr><tr><td style=text-align:left><a href=#pg_remove><code>PG_REMOVE</code></a></td><td style=text-align:left>PostgreSQL 实例清理与卸载配置</td></tr></tbody></table><hr><h2 id=参数概览>参数概览</h2><hr><p><a href=#pg_id><code>PG_ID</code></a> 参数组用于定义 PostgreSQL 集群与实例的身份标识，包括集群名称、实例序号、角色、分片等核心身份参数。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_mode><code>pg_mode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql 集群模式: pgsql,citus,mssql,mysql,polar,ivory,oracle,gpsql</td></tr><tr><td style=text-align:left><a href=#pg_cluster><code>pg_cluster</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql 集群名称, 必选身份参数</td></tr><tr><td style=text-align:left><a href=#pg_seq><code>pg_seq</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>pgsql 实例号, 必选身份参数</td></tr><tr><td style=text-align:left><a href=#pg_role><code>pg_role</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>pgsql 实例角色, 必选身份参数, 可为 primary，replica，offline</td></tr><tr><td style=text-align:left><a href=#pg_instances><code>pg_instances</code></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>在一个节点上定义多个 pg 实例，使用 <code>{port:ins_vars}</code> 格式</td></tr><tr><td style=text-align:left><a href=#pg_upstream><code>pg_upstream</code></a></td><td style=text-align:center><code>ip</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>级联从库或备份集群或的复制上游节点IP地址</td></tr><tr><td style=text-align:left><a href=#pg_shard><code>pg_shard</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql 分片名，对 citus 与 gpsql 等水平分片集群为必选身份参数</td></tr><tr><td style=text-align:left><a href=#pg_group><code>pg_group</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql 分片号，正整数，对 citus 与 gpsql 等水平分片集群为必选身份参数</td></tr><tr><td style=text-align:left><a href=#gp_role><code>gp_role</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>这个集群的 greenplum 角色，可以是 master 或 segment</td></tr><tr><td style=text-align:left><a href=#pg_exporters><code>pg_exporters</code></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>在该节点上设置额外的 pg_exporters 用于监控远程 postgres 实例</td></tr><tr><td style=text-align:left><a href=#pg_offline_query><code>pg_offline_query</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>设置为 true 将此只读实例标记为特殊的离线从库，承载 Offline 服务，允许离线查询</td></tr></tbody></table><hr><p><a href=#pg_business><code>PG_BUSINESS</code></a> 参数组用于定义业务用户、数据库、服务与访问控制规则，以及默认的系统用户凭据。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_users><code>pg_users</code></a></td><td style=text-align:center><code>user[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 业务用户</td></tr><tr><td style=text-align:left><a href=#pg_databases><code>pg_databases</code></a></td><td style=text-align:center><code>database[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 业务数据库</td></tr><tr><td style=text-align:left><a href=#pg_services><code>pg_services</code></a></td><td style=text-align:center><code>service[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 业务服务</td></tr><tr><td style=text-align:left><a href=#pg_hba_rules><code>pg_hba_rules</code></a></td><td style=text-align:center><code>hba[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 的业务 hba 规则</td></tr><tr><td style=text-align:left><a href=#pgb_hba_rules><code>pgb_hba_rules</code></a></td><td style=text-align:center><code>hba[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer 的业务 hba 规则</td></tr><tr><td style=text-align:left><a href=#pg_crontab><code>pg_crontab</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres dbsu 的定时任务</td></tr><tr><td style=text-align:left><a href=#pg_replication_username><code>pg_replication_username</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres 复制用户名，默认为 <code>replicator</code></td></tr><tr><td style=text-align:left><a href=#pg_replication_password><code>pg_replication_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres 复制密码，默认为 <code>DBUser.Replicator</code></td></tr><tr><td style=text-align:left><a href=#pg_admin_username><code>pg_admin_username</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres 管理员用户名，默认为 <code>dbuser_dba</code></td></tr><tr><td style=text-align:left><a href=#pg_admin_password><code>pg_admin_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres 管理员明文密码，默认为 <code>DBUser.DBA</code></td></tr><tr><td style=text-align:left><a href=#pg_monitor_username><code>pg_monitor_username</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres 监控用户名，默认为 <code>dbuser_monitor</code></td></tr><tr><td style=text-align:left><a href=#pg_monitor_password><code>pg_monitor_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>postgres 监控密码，默认为 <code>DBUser.Monitor</code></td></tr><tr><td style=text-align:left><a href=#pg_dbsu_password><code>pg_dbsu_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>dbsu 密码，默认为空字符串意味着不设置 dbsu 密码，最好不要设置。</td></tr></tbody></table><hr><p><a href=#pg_install><code>PG_INSTALL</code></a> 参数组用于配置 PostgreSQL 安装相关选项，包括版本、路径、软件包与扩展插件。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_dbsu><code>pg_dbsu</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>操作系统 dbsu 名称，默认为 postgres，最好不要更改</td></tr><tr><td style=text-align:left><a href=#pg_dbsu_uid><code>pg_dbsu_uid</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>操作系统 dbsu uid 和 gid，对于默认的 postgres 用户和组为 26</td></tr><tr><td style=text-align:left><a href=#pg_dbsu_sudo><code>pg_dbsu_sudo</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>dbsu sudo 权限, none,limit,all,nopass，默认为 limit</td></tr><tr><td style=text-align:left><a href=#pg_dbsu_home><code>pg_dbsu_home</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgresql 主目录，默认为 <code>/var/lib/pgsql</code></td></tr><tr><td style=text-align:left><a href=#pg_dbsu_ssh_exchange><code>pg_dbsu_ssh_exchange</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>在 pgsql 集群之间交换 postgres dbsu ssh 密钥</td></tr><tr><td style=text-align:left><a href=#pg_version><code>pg_version</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>要安装的 postgres 主版本，默认为 18</td></tr><tr><td style=text-align:left><a href=#pg_bin_dir><code>pg_bin_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 二进制目录，默认为 <code>/usr/pgsql/bin</code></td></tr><tr><td style=text-align:left><a href=#pg_log_dir><code>pg_log_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 日志目录，默认为 <code>/pg/log/postgres</code></td></tr><tr><td style=text-align:left><a href=#pg_packages><code>pg_packages</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>要安装的 pg 包，<code>${pg_version}</code> 将被替换为实际主版本号</td></tr><tr><td style=text-align:left><a href=#pg_extensions><code>pg_extensions</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>要安装的 pg 扩展，<code>${pg_version}</code> 将被替换为实际主版本号</td></tr></tbody></table><hr><p><a href=#pg_bootstrap><code>PG_BOOTSTRAP</code></a> 参数组用于配置 PostgreSQL 集群初始化引导，包括 Patroni 高可用、数据目录、存储、连接、编码等核心设置。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_data><code>pg_data</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 数据目录，默认为 <code>/pg/data</code></td></tr><tr><td style=text-align:left><a href=#pg_fs_main><code>pg_fs_main</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 主数据的挂载点/路径，默认为 <code>/data/postgres</code></td></tr><tr><td style=text-align:left><a href=#pg_fs_backup><code>pg_fs_backup</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg 备份数据的挂载点/路径，默认为 <code>/data/backups</code></td></tr><tr><td style=text-align:left><a href=#pg_storage_type><code>pg_storage_type</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg 主数据的存储类型，SSD、HDD，默认为 SSD，影响自动优化的参数。</td></tr><tr><td style=text-align:left><a href=#pg_dummy_filesize><code>pg_dummy_filesize</code></a></td><td style=text-align:center><code>size</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left><code>/pg/dummy</code> 的大小，默认保留 64MB 磁盘空间用于紧急抢修</td></tr><tr><td style=text-align:left><a href=#pg_listen><code>pg_listen</code></a></td><td style=text-align:center><code>ip(s)</code></td><td style=text-align:center><code>C/I</code></td><td style=text-align:left>postgres/pgbouncer 的监听地址，用逗号分隔的IP列表，默认为 <code>0.0.0.0</code></td></tr><tr><td style=text-align:left><a href=#pg_port><code>pg_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 监听端口，默认为 5432</td></tr><tr><td style=text-align:left><a href=#pg_localhost><code>pg_localhost</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 的 Unix 套接字目录，用于本地连接</td></tr><tr><td style=text-align:left><a href=#pg_namespace><code>pg_namespace</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>在 etcd 中的顶级键命名空间，被 patroni & vip 用于高可用管理</td></tr><tr><td style=text-align:left><a href=#patroni_enabled><code>patroni_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>如果禁用，初始化期间不会创建 postgres 集群</td></tr><tr><td style=text-align:left><a href=#patroni_mode><code>patroni_mode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni 工作模式：default,pause,remove</td></tr><tr><td style=text-align:left><a href=#patroni_port><code>patroni_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni 监听端口，默认为 8008</td></tr><tr><td style=text-align:left><a href=#patroni_log_dir><code>patroni_log_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni 日志目录，默认为 <code>/pg/log/patroni</code></td></tr><tr><td style=text-align:left><a href=#patroni_ssl_enabled><code>patroni_ssl_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>使用 SSL 保护 patroni RestAPI 通信？</td></tr><tr><td style=text-align:left><a href=#patroni_watchdog_mode><code>patroni_watchdog_mode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni 看门狗模式：automatic,required,off，默认为 off</td></tr><tr><td style=text-align:left><a href=#patroni_username><code>patroni_username</code></a></td><td style=text-align:center><code>username</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni restapi 用户名，默认为 <code>postgres</code></td></tr><tr><td style=text-align:left><a href=#patroni_password><code>patroni_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>patroni restapi 密码，默认为 <code>Patroni.API</code></td></tr><tr><td style=text-align:left><a href=#pg_primary_db><code>pg_primary_db</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>指定集群中首要使用的数据库名，Citus等模式会用到，默认为 <code>postgres</code></td></tr><tr><td style=text-align:left><a href=#pg_parameters><code>pg_parameters</code></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>覆盖 postgresql.auto.conf 中的 PostgreSQL 参数</td></tr><tr><td style=text-align:left><a href=#pg_files><code>pg_files</code></a></td><td style=text-align:center><code>path[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>拷贝至PGDATA目录中的额外文件列表 (例如许可证文件)</td></tr><tr><td style=text-align:left><a href=#pg_conf><code>pg_conf</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>配置模板：oltp,olap,crit,tiny，默认为 <code>oltp.yml</code></td></tr><tr><td style=text-align:left><a href=#pg_max_conn><code>pg_max_conn</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 最大连接数，<code>auto</code> 将使用推荐值</td></tr><tr><td style=text-align:left><a href=#pg_shared_buffer_ratio><code>pg_shared_buffer_ratio</code></a></td><td style=text-align:center><code>float</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>postgres 共享缓冲区内存比率，默认为 0.25，范围 0.1~0.4</td></tr><tr><td style=text-align:left><a href=#pg_rto><code>pg_rto</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>RTO 模式：<code>fast</code>,<code>norm</code>,<code>safe</code>,<code>wide</code>，默认 <code>norm</code></td></tr><tr><td style=text-align:left><a href=#pg_rto_plan><code>pg_rto_plan</code></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center><code>G</code></td><td style=text-align:left>RTO 预设配置，定义 Patroni HA 与 HAProxy 健康检查的超时参数</td></tr><tr><td style=text-align:left><a href=#pg_rpo><code>pg_rpo</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>恢复点目标（字节），默认为 <code>1MiB</code></td></tr><tr><td style=text-align:left><a href=#pg_libs><code>pg_libs</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>预加载的库，默认为 <code>pg_stat_statements,auto_explain</code></td></tr><tr><td style=text-align:left><a href=#pg_delay><code>pg_delay</code></a></td><td style=text-align:center><code>interval</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>备份集群主库的WAL重放应用延迟，用于制备延迟从库</td></tr><tr><td style=text-align:left><a href=#pg_checksum><code>pg_checksum</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>为 postgres 集群启用数据校验和？</td></tr><tr><td style=text-align:left><a href=#pg_pwd_enc><code>pg_pwd_enc</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>密码加密算法：固定为 scram-sha-256</td></tr><tr><td style=text-align:left><a href=#pg_encoding><code>pg_encoding</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>数据库集群编码，默认为 <code>UTF8</code></td></tr><tr><td style=text-align:left><a href=#pg_locale><code>pg_locale</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>数据库集群本地化设置，默认为 <code>C</code></td></tr><tr><td style=text-align:left><a href=#pg_lc_collate><code>pg_lc_collate</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>数据库集群排序，默认为 <code>C</code></td></tr><tr><td style=text-align:left><a href=#pg_lc_ctype><code>pg_lc_ctype</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>数据库字符类型，默认为 <code>C</code></td></tr><tr><td style=text-align:left><a href=#pg_io_method><code>pg_io_method</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>PostgreSQL IO 方法：<code>auto</code>, <code>sync</code>, <code>worker</code>, <code>io_uring</code></td></tr><tr><td style=text-align:left><a href=#pg_etcd_password><code>pg_etcd_password</code></a></td><td style=text-align:center><code>password</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>此 PostgreSQL 集群在 etcd 中使用的密码，默认使用集群名</td></tr><tr><td style=text-align:left><a href=#pgsodium_key><code>pgsodium_key</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsodium 加密主密钥，64 位十六进制数字，默认使用 sha256(pg_cluster)</td></tr><tr><td style=text-align:left><a href=#pgsodium_getkey_script><code>pgsodium_getkey_script</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsodium 获取密钥脚本路径，默认使用模板中的 pgsodium_getkey</td></tr></tbody></table><hr><p><a href=#pg_provision><code>PG_PROVISION</code></a> 参数组用于配置 PostgreSQL 集群模板置备，包括默认角色、权限、模式、扩展与 HBA 规则。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_provision><code>pg_provision</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>在引导后置备 postgres 集群内部的业务对象？</td></tr><tr><td style=text-align:left><a href=#pg_init><code>pg_init</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>为集群模板提供初始化脚本，默认为 <code>pg-init</code></td></tr><tr><td style=text-align:left><a href=#pg_default_roles><code>pg_default_roles</code></a></td><td style=text-align:center><code>role[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>postgres 集群中的默认预定义角色和系统用户</td></tr><tr><td style=text-align:left><a href=#pg_default_privileges><code>pg_default_privileges</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>由管理员用户创建数据库内对象时的默认权限</td></tr><tr><td style=text-align:left><a href=#pg_default_schemas><code>pg_default_schemas</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>要创建的默认模式列表</td></tr><tr><td style=text-align:left><a href=#pg_default_extensions><code>pg_default_extensions</code></a></td><td style=text-align:center><code>extension[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>要创建的默认扩展列表</td></tr><tr><td style=text-align:left><a href=#pg_reload><code>pg_reload</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>A</code></td><td style=text-align:left>更改HBA后，是否立即重载 postgres 配置</td></tr><tr><td style=text-align:left><a href=#pg_default_hba_rules><code>pg_default_hba_rules</code></a></td><td style=text-align:center><code>hba[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>postgres 基于主机的认证规则，全局PG默认HBA</td></tr><tr><td style=text-align:left><a href=#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a></td><td style=text-align:center><code>hba[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>pgbouncer 默认的基于主机的认证规则，全局PGB默认HBA</td></tr></tbody></table><hr><p><a href=#pg_backup><code>PG_BACKUP</code></a> 参数组用于配置 pgBackRest 备份与恢复，包括仓库类型、路径、保留策略等。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pgbackrest_enabled><code>pgbackrest_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>在 pgsql 主机上启用 pgbackrest？</td></tr><tr><td style=text-align:left><a href=#pgbackrest_log_dir><code>pgbackrest_log_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbackrest 日志目录，默认为 <code>/pg/log/pgbackrest</code></td></tr><tr><td style=text-align:left><a href=#pgbackrest_method><code>pgbackrest_method</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbackrest 使用的仓库：local,minio,等&mldr;</td></tr><tr><td style=text-align:left><a href=#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbackrest 初始化完成后是否立即执行全量备份？默认为 <code>true</code></td></tr><tr><td style=text-align:left><a href=#pgbackrest_repo><code>pgbackrest_repo</code></a></td><td style=text-align:center><code>dict</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>pgbackrest 仓库定义</td></tr></tbody></table><hr><p><a href=#pg_access><code>PG_ACCESS</code></a> 参数组用于配置服务暴露、连接池、VIP、DNS 等客户端访问相关选项。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pgbouncer_enabled><code>pgbouncer_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>如果禁用，则不会配置 pgbouncer 连接池</td></tr><tr><td style=text-align:left><a href=#pgbouncer_port><code>pgbouncer_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer 监听端口，默认为 6432</td></tr><tr><td style=text-align:left><a href=#pgbouncer_log_dir><code>pgbouncer_log_dir</code></a></td><td style=text-align:center><code>path</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer 日志目录，默认为 <code>/pg/log/pgbouncer</code></td></tr><tr><td style=text-align:left><a href=#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>使用 AuthQuery 来从 postgres 获取未列出的业务用户？</td></tr><tr><td style=text-align:left><a href=#pgbouncer_poolmode><code>pgbouncer_poolmode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>池化模式：transaction,session,statement，默认为 transaction</td></tr><tr><td style=text-align:left><a href=#pgbouncer_sslmode><code>pgbouncer_sslmode</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer 客户端 SSL 模式，默认为禁用</td></tr><tr><td style=text-align:left><a href=#pgbouncer_ignore_param><code>pgbouncer_ignore_param</code></a></td><td style=text-align:center><code>string[]</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer 忽略的启动参数列表</td></tr><tr><td style=text-align:left><a href=#pg_weight><code>pg_weight</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>I</code></td><td style=text-align:left>在服务中的相对负载均衡权重，默认为 100，范围 0-255</td></tr><tr><td style=text-align:left><a href=#pg_service_provider><code>pg_service_provider</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>专用的 haproxy 节点组名称，或默认空字符，使用本地节点上的 haproxy</td></tr><tr><td style=text-align:left><a href=#pg_default_service_dest><code>pg_default_service_dest</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>如果 svc.dest=&lsquo;default&rsquo;，默认服务指向哪里？postgres 或 pgbouncer</td></tr><tr><td style=text-align:left><a href=#pg_default_services><code>pg_default_services</code></a></td><td style=text-align:center><code>service[]</code></td><td style=text-align:center><code>G/C</code></td><td style=text-align:left>postgres 默认服务定义列表，全局共用。</td></tr><tr><td style=text-align:left><a href=#pg_vip_enabled><code>pg_vip_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>是否为 pgsql 主节点启用 L2 VIP？默认不启用</td></tr><tr><td style=text-align:left><a href=#pg_vip_address><code>pg_vip_address</code></a></td><td style=text-align:center><code>cidr4</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>vip 地址的格式为 <code>&lt;ipv4>/&lt;mask></code>，启用 vip 时为必选参数</td></tr><tr><td style=text-align:left><a href=#pg_vip_interface><code>pg_vip_interface</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C/I</code></td><td style=text-align:left>监听的 vip 网络接口，默认为 eth0</td></tr><tr><td style=text-align:left><a href=#pg_dns_suffix><code>pg_dns_suffix</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgsql dns 后缀，默认为空</td></tr><tr><td style=text-align:left><a href=#pg_dns_target><code>pg_dns_target</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>PG DNS 解析到哪里？auto、primary、vip、none 或者特定的 IP 地址</td></tr></tbody></table><hr><p><a href=#pg_monitor><code>PG_MONITOR</code></a> 参数组用于配置 PostgreSQL 监控 Exporter，包括 pg_exporter、pgbouncer_exporter 和 pgbackrest_exporter。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_exporter_enabled><code>pg_exporter_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>在 pgsql 主机上启用 pg_exporter 吗？</td></tr><tr><td style=text-align:left><a href=#pg_exporter_config><code>pg_exporter_config</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter 配置文件/模板名称</td></tr><tr><td style=text-align:left><a href=#pg_exporter_cache_ttls><code>pg_exporter_cache_ttls</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter 收集器阶梯TTL配置，默认为 &lsquo;1,10,60,300&rsquo;</td></tr><tr><td style=text-align:left><a href=#pg_exporter_port><code>pg_exporter_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter 监听端口，默认为 9630</td></tr><tr><td style=text-align:left><a href=#pg_exporter_params><code>pg_exporter_params</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter dsn 中传入的额外 URL 参数</td></tr><tr><td style=text-align:left><a href=#pg_exporter_url><code>pg_exporter_url</code></a></td><td style=text-align:center><code>pgurl</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>如果指定，则覆盖自动生成的 postgres DSN 连接串</td></tr><tr><td style=text-align:left><a href=#pg_exporter_auto_discovery><code>pg_exporter_auto_discovery</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>监控是否启用自动数据库发现？默认启用</td></tr><tr><td style=text-align:left><a href=#pg_exporter_exclude_database><code>pg_exporter_exclude_database</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>启用自动发现时，排除在外的数据库名称列表，用逗号分隔</td></tr><tr><td style=text-align:left><a href=#pg_exporter_include_database><code>pg_exporter_include_database</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>启用自动发现时，只监控这个列表中的数据库，名称用逗号分隔</td></tr><tr><td style=text-align:left><a href=#pg_exporter_connect_timeout><code>pg_exporter_connect_timeout</code></a></td><td style=text-align:center><code>int</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter 连接超时，单位毫秒，默认为 200</td></tr><tr><td style=text-align:left><a href=#pg_exporter_options><code>pg_exporter_options</code></a></td><td style=text-align:center><code>arg</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pg_exporter 的额外命令行参数选项</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter_enabled><code>pgbouncer_exporter_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>在 pgsql 主机上启用 pgbouncer_exporter 吗？</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter_port><code>pgbouncer_exporter_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer_exporter 监听端口，默认为 9631</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter_url><code>pgbouncer_exporter_url</code></a></td><td style=text-align:center><code>pgurl</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>如果指定，则覆盖自动生成的 pgbouncer dsn 连接串</td></tr><tr><td style=text-align:left><a href=#pgbouncer_exporter_options><code>pgbouncer_exporter_options</code></a></td><td style=text-align:center><code>arg</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbouncer_exporter 的额外命令行参数选项</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>在 pgsql 主机上启用 pgbackrest_exporter 吗？</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter_port><code>pgbackrest_exporter_port</code></a></td><td style=text-align:center><code>port</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbackrest_exporter 监听端口，默认为 9854</td></tr><tr><td style=text-align:left><a href=#pgbackrest_exporter_options><code>pgbackrest_exporter_options</code></a></td><td style=text-align:center><code>arg</code></td><td style=text-align:center><code>C</code></td><td style=text-align:left>pgbackrest_exporter 的额外命令行参数选项</td></tr></tbody></table><hr><p><a href=#pg_remove><code>PG_REMOVE</code></a> 参数组用于配置 PostgreSQL 实例清理与卸载行为，包括数据目录、备份、软件包的删除控制。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_rm_data><code>pg_rm_data</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>删除 pgsql 实例时是否清理 postgres 数据目录？</td></tr><tr><td style=text-align:left><a href=#pg_rm_backup><code>pg_rm_backup</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>删除主库时是否一并清理 pgbackrest 备份？</td></tr><tr><td style=text-align:left><a href=#pg_rm_pkg><code>pg_rm_pkg</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>删除 pgsql 实例时是否卸载相关软件包？</td></tr><tr><td style=text-align:left><a href=#pg_safeguard><code>pg_safeguard</code></a></td><td style=text-align:center><code>bool</code></td><td style=text-align:center><code>G/C/A</code></td><td style=text-align:left>防误删保险，阻止误执行 pgsql 清理操作？默认为 false</td></tr></tbody></table><hr><h2 id=pg_id><code>PG_ID</code></h2><p>以下是一些常用的参数，用于标识 PGSQL 模块中的 <a href=/docs/concept/model/pgsql>实体</a>：集群、实例、服务等&mldr;</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_cluster:           #CLUSTER  # pgsql 集群名称，必需的标识参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_seq: 0             #INSTANCE # pgsql 实例序列号，必需的标识参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_role: replica      #INSTANCE # pgsql 角色，必需的，可以是 primary,replica,offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_instances: {}      #INSTANCE # 在节点上定义多个 pg 实例，使用 `{port:ins_vars}` 格式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_upstream:          #INSTANCE # 备用集群或级联副本的 repl 上游 ip 地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_shard:             #CLUSTER  # pgsql 分片名称，分片集群的可选标识</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_group: 0           #CLUSTER  # pgsql 分片索引号，分片集群的可选标识</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># gp_role: master       #CLUSTER  # 此集群的 greenplum 角色，可以是 master 或 segment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#INSTANCE # 设置为 true 以在此实例上启用离线查询</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您必须显式指定这些<strong>身份参数</strong>，它们没有默认值：</p><table class=full-width><thead><tr><th style=text-align:center>名称</th><th style=text-align:center>类型</th><th style=text-align:center>级别</th><th>扩展说明</th></tr></thead><tbody><tr><td style=text-align:center><a href=#pg_cluster><code>pg_cluster</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><strong>C</strong></td><td><strong>PG 数据库集群名称</strong></td></tr><tr><td style=text-align:center><a href=#pg_seq><code>pg_seq</code></a></td><td style=text-align:center><code>number</code></td><td style=text-align:center><strong>I</strong></td><td><strong>PG 数据库实例 ID</strong></td></tr><tr><td style=text-align:center><a href=#pg_role><code>pg_role</code></a></td><td style=text-align:center><code>enum</code></td><td style=text-align:center><strong>I</strong></td><td><strong>PG 数据库实例角色</strong></td></tr><tr><td style=text-align:center><a href=#pg_shard><code>pg_shard</code></a></td><td style=text-align:center><code>string</code></td><td style=text-align:center><strong>C</strong></td><td><strong>数据库分片名称</strong></td></tr><tr><td style=text-align:center><a href=#pg_group><code>pg_group</code></a></td><td style=text-align:center><code>number</code></td><td style=text-align:center><strong>C</strong></td><td><strong>数据库分片序号</strong></td></tr></tbody></table><ul><li><a href=#pg_cluster><code>pg_cluster</code></a>: 它标识集群的名称，该名称在集群级别配置。</li><li><a href=#pg_role><code>pg_role</code></a>: 在实例级别配置，标识 ins 的角色。只有 <code>primary</code> 角色会特别处理。如果不填写，默认为 <code>replica</code> 角色和特殊的 <code>delayed</code> 和 <code>offline</code> 角色。</li><li><a href=#pg_seq><code>pg_seq</code></a>: 用于在集群内标识 ins，通常是从 0 或 1 递增的整数，一旦分配就不会更改。</li><li><code>{{ pg_cluster }}-{{ pg_seq }}</code> 用于唯一标识 ins，即 <code>pg_instance</code>。</li><li><code>{{ pg_cluster }}-{{ pg_role }}</code> 用于标识集群内的服务，即 <code>pg_service</code>。</li><li><a href=#pg_shard><code>pg_shard</code></a> 和 <a href=#pg_group><code>pg_group</code></a> 用于水平分片集群，仅用于 citus、greenplum 和 matrixdb。</li></ul><p><a href=#pg_cluster><code>pg_cluster</code></a>、<a href=#pg_role><code>pg_role</code></a>、<a href=#pg_seq><code>pg_seq</code></a> 是核心<strong>标识参数</strong>，对于任何 Postgres 集群都是<strong>必选</strong>的，并且必须显式指定。以下是一个示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>所有其他参数都可以从全局配置或默认配置继承，但标识参数必须<strong>明确指定</strong>和<strong>手动分配</strong>。</p><h3 id=pg_mode><code>pg_mode</code></h3><p>参数名称： <code>pg_mode</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>PostgreSQL 集群模式，默认值为 <code>pgsql</code>，即标准的 PostgreSQL 集群。</p><p>可用的模式选项包括：</p><ul><li><code>pgsql</code>：标准的 PostgreSQL 集群</li><li><code>citus</code>：Citus 分布式数据库集群</li><li><code>mssql</code>：Babelfish MSSQL 线缆协议兼容内核</li><li><code>mysql</code>：OpenHalo/HaloDB MySQL 线协议兼容内核</li><li><code>ivory</code>：IvorySQL Oracle 兼容内核</li><li><code>polar</code>：PolarDB for PostgreSQL 内核</li><li><code>oracle</code>：PolarDB for Oracle 内核</li><li><code>gpsql</code>：Greenplum 并行数据库集群（监控）</li></ul><p>如果 <code>pg_mode</code> 设置为 <code>citus</code> 或 <code>gpsql</code>，则需要两个额外的必选身份参数 <a href=#pg_shard><code>pg_shard</code></a> 和 <a href=#pg_group><code>pg_group</code></a> 来定义水平分片集群的身份。</p><p>在这两种情况下，每一个 PostgreSQL 集群都是一组更大的业务单元的一部分。</p><h3 id=pg_cluster><code>pg_cluster</code></h3><p>参数名称： <code>pg_cluster</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>PostgreSQL 集群名称，必选的身份标识参数，没有默认值</p><p>集群名将用作资源的命名空间。</p><p>集群命名需要遵循特定的命名模式：<code>[a-z][a-z0-9-]*</code>，即，只使用数字与小写字母，且不以数字开头，以符合标识上的不同约束的要求。</p><h3 id=pg_seq><code>pg_seq</code></h3><p>参数名称： <code>pg_seq</code>， 类型： <code>int</code>， 层次：<code>I</code></p><p>PostgreSQL 实例序列号，必选的身份标识参数，无默认值。</p><p>此实例的序号，在其<strong>集群</strong>内是唯一分配的，通常使用自然数，从0或1开始分配，通常不会回收重用。</p><h3 id=pg_role><code>pg_role</code></h3><p>参数名称： <code>pg_role</code>， 类型： <code>enum</code>， 层次：<code>I</code></p><p>PostgreSQL 实例角色，必选的身份标识参数，无默认值。取值可以是：<code>primary</code>, <code>replica</code>, <code>offline</code></p><p>PGSQL 实例的角色，可以是：<code>primary</code>、<code>replica</code>、<code>standby</code> 或 <code>offline</code>。</p><ul><li><code>primary</code>: 主实例，在集群中有且仅有一个。</li><li><code>replica</code>: 用于承载在线只读流量的副本，高负载下可能会有轻微复制延迟（10ms~100ms, 100KB）。</li><li><code>offline</code>: 用于处理离线只读流量的离线副本，如统计分析/ETL/个人查询等。</li></ul><h3 id=pg_instances><code>pg_instances</code></h3><p>参数名称： <code>pg_instances</code>， 类型： <code>dict</code>， 层次：<code>I</code></p><p>使用 <code>{port:ins_vars}</code> 的形式在一台主机上定义多个 PostgreSQL 实例。</p><p>此参数是为在单个节点上的多实例部署保留的参数，Pigsty 尚未实现此功能，并强烈建议独占节点部署。</p><h3 id=pg_upstream><code>pg_upstream</code></h3><p>参数名称： <code>pg_upstream</code>， 类型： <code>ip</code>， 层次：<code>I</code></p><p><a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a> 或级联从库的上游实例 IP 地址。</p><p>在集群的 <code>primary</code> 实例上设置 <code>pg_upstream</code> ，表示此集群是一个 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a>，该实例将作为 <code>standby leader</code>，从上游集群接收并应用更改。</p><p>对非 <code>primary</code> 实例设置 <code>pg_upstream</code> 参数将指定一个具体实例作为物理复制的上游，如果与主实例 ip 地址不同，此实例将成为 <strong>级联副本</strong> 。确保上游 IP 地址是同一集群中的另一个实例是用户的责任。</p><h3 id=pg_shard><code>pg_shard</code></h3><p>参数名称： <code>pg_shard</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>PostgreSQL 水平分片名称，对于分片集群来说（例如 citus 集群），这是的必选标识参数。</p><p>当多个标准的 PostgreSQL 集群一起以水平分片方式为同一业务提供服务时，Pigsty 将此组集群标记为 <strong>水平分片集群</strong>。</p><p><a href=#pg_shard><code>pg_shard</code></a> 是分片组名称。它通常是 <a href=#pg_cluster><code>pg_cluster</code></a> 的前缀。</p><p>例如，如果我们有一个分片组 <code>pg-citus</code>，并且其中有4个集群，它们的标识参数将是：</p><pre tabindex=0><code>cls pg_shard: pg-citus
cls pg_group = 0:   pg-citus0
cls pg_group = 1:   pg-citus1
cls pg_group = 2:   pg-citus2
cls pg_group = 3:   pg-citus3
</code></pre><h3 id=pg_group><code>pg_group</code></h3><p>参数名称： <code>pg_group</code>， 类型： <code>int</code>， 层次：<code>C</code></p><p>PostgreSQL 水平分片集群的分片索引号，对于分片集群来说（例如 citus 集群），这是的必选标识参数。</p><p>此参数与 <a href=#pg_shard>pg_shard</a> 配对使用，通常可以使用非负整数作为索引号。</p><h3 id=gp_role><code>gp_role</code></h3><p>参数名称： <code>gp_role</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>PostgreSQL 集群的 Greenplum/Matrixdb 角色，可以是 <code>master</code> 或 <code>segment</code>。</p><ul><li><code>master</code>: 标记 postgres 集群为 greenplum 主实例（协调节点），这是默认值。</li><li><code>segment</code> 标记 postgres 集群为 greenplum 段集群（数据节点）。</li></ul><p>此参数仅用于 Greenplum/MatrixDB 数据库 （<a href=#pg_mode><code>pg_mode</code></a> 为 <code>gpsql</code>），对于普通的 PostgreSQL 集群没有意义。</p><h3 id=pg_exporters><code>pg_exporters</code></h3><p>参数名称： <code>pg_exporters</code>， 类型： <code>dict</code>， 层次：<code>C</code></p><p>额外用于 <a href=/docs/pgsql/monitor>监控</a> 远程 PostgreSQL 实例的 Exporter 定义，默认值：<code>{}</code></p><p>如果您希望监控远程 PostgreSQL 实例，请在监控系统所在节点（Infra节点）集群上的 <code>pg_exporters</code> 参数中定义它们，并使用 <a href=/docs/pgsql/playbook#pgsql-monitoryml><code>pgsql-monitor.yml</code></a> 剧本来完成部署。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># list all remote instances here, alloc a unique unused local port as k</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>20001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 1, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>20004</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 2, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>20002</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 1, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>20003</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-bar, pg_seq: 1, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.13</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_offline_query><code>pg_offline_query</code></h3><p>参数名称： <code>pg_offline_query</code>， 类型： <code>bool</code>， 层次：<code>I</code></p><p>设置为 <code>true</code> 以在此实例上启用离线查询，默认为 <code>false</code>。</p><p>当某个 PostgreSQL 实例启用此参数时， 属于 <code>dbrole_offline</code> 分组的用户可以直接连接到该 PostgreSQL 实例上执行离线查询（慢查询，交互式查询，ETL/分析类查询）。</p><p>带有此标记的实例在效果上类似于为实例设置 <code>pg_role</code> = <code>offline</code> ，唯一的区别在于 <code>offline</code> 实例默认不会承载 <code>replica</code> 服务的请求，是作为专用的离线/分析从库实例而存在的。</p><p>如果您没有富余的实例可以专门用于此目的，则可以挑选一台普通的从库，在实例层次启用此参数，以便在需要时承载离线查询。</p><hr><h2 id=pg_business><code>PG_BUSINESS</code></h2><p>定制集群模板：用户，数据库，服务，权限规则。</p><p>用户需<strong>重点关注</strong>此部分参数，因为这里是业务声明自己所需数据库对象的地方。</p><ul><li>业务用户定义： <a href=#pg_users><strong><code>pg_users</code></strong></a></li><li>业务数据库定义： <a href=#pg_databases><strong><code>pg_databases</code></strong></a></li><li>集群专有服务定义： <a href=#pg_services><strong><code>pg_services</code></strong></a> （全局定义：<a href=#pg_default_services><strong><code>pg_default_services</code></strong></a>）</li><li>PostgreSQL集群/实例特定的HBA规则： <a href=#pg_hba_rules><strong><code>pg_hba_rules</code></strong></a></li><li>Pgbouncer连接池特定HBA规则： <a href=#pgb_hba_rules><strong><code>pgb_hba_rules</code></strong></a></li><li>定时任务（crontab）定义： <a href=#pg_crontab><strong><code>pg_crontab</code></strong></a></li></ul><p><a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7>默认</a> 的数据库用户及其凭据，强烈建议在生产环境中修改这些用户的密码。</p><ul><li>PG管理员用户：<a href=#pg_admin_username><code>pg_admin_username</code></a> / <a href=#pg_admin_password><code>pg_admin_password</code></a></li><li>PG复制用户： <a href=#pg_replication_username><code>pg_replication_username</code></a> / <a href=#pg_replication_password><code>pg_replication_password</code></a></li><li>PG监控用户：<a href=#pg_monitor_username><code>pg_monitor_username</code></a> / <a href=#pg_monitor_password><code>pg_monitor_password</code></a></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># postgres business object definition, overwrite in group vars</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># postgres business users</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># postgres business databases</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># postgres business services</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># business hba rules for postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># business hba rules for pgbouncer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># crontab entries for postgres dbsu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># global credentials, overwrite in global vars</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># dbsu password, empty string means no dbsu password by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_users><code>pg_users</code></h3><p>参数名称： <code>pg_users</code>， 类型： <code>user[]</code>， 层次：<code>C</code></p><p>PostgreSQL 业务用户列表，需要在 PG 集群层面进行定义。默认值为：<code>[]</code> 空列表。</p><p>每一个数组元素都是一个 <a href=/docs/pgsql/config/user><strong>用户/角色</strong></a> 定义，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是用户定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>create                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户状态：create（创建，默认）、absent（删除）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，密码，可以是 scram-sha-256 哈希字符串或明文</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，默认为 true，是否可以登录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否是超级用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以创建数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以创建角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，默认为 true，是否自动继承所属角色权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以发起流复制连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以绕过行级安全</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，用户连接数限制，默认 -1 不限制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，从创建时起 N 天后过期（优先级比 expire_at 高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 可选，过期日期，使用 YYYY-MM-DD 格式（优先级没 expire_in 高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户备注信息</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，所属角色数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，角色级配置参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否加入连接池用户列表，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户级别的池化模式，默认 transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，用户级别的连接池最大连接数，默认 -1 不限制</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>用户级连接池限额字段统一使用 <code>pool_connlimit</code>（对应 Pgbouncer <code>max_user_connections</code>）。</p></blockquote><h3 id=pg_databases><code>pg_databases</code></h3><p>参数名称： <code>pg_databases</code>， 类型： <code>database[]</code>， 层次：<code>C</code></p><p>PostgreSQL 业务数据库列表，需要在 PG 集群层面进行定义。默认值为：<code>[]</code> 空列表。</p><p>每一个数组元素都是一个 <a href=/docs/pgsql/config/db><strong>业务数据库</strong></a> 定义，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是数据库定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>create                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库状态：create（创建，默认）、absent（删除）、recreate（重建）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库 sql 的基线定义文件路径（ansible 搜索路径中的相对路径，如 files/）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库添加到 pgbouncer 数据库列表？默认为 true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要创建的附加模式，由模式名称字符串组成的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，要安装的附加扩展：扩展对象的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可以指定将扩展安装到某个模式中，也可以不指定（不指定则安装到 search_path 首位模式中）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 例如有的扩展会创建并使用固定的模式，就不需要指定模式。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库的说明与备注信息</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库所有者，不指定则为当前用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要使用的模板，默认为 template1，目标必须是一个模板数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，克隆策略：FILE_COPY 或 WAL_LOG（PG15+），不指定使用 PG 默认</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（UTF8）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（C）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（C）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（C）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>libc          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，本地化提供者：libc、icu、builtin（PG15+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，ICU 本地化规则（PG15+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，ICU 排序规则（PG16+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，内置本地化提供者规则（PG17+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认表空间，默认为 &#39;pg_default&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>is_template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，是否标记为模板数据库，允许任何有 CREATEDB 权限的用户克隆</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库注册到 grafana 数据源？默认为 true，显式设置为 false 会跳过注册</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库连接限制，默认为 -1 ，不限制，设置为正整数则会限制连接数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，数据库级参数，通过 ALTER DATABASE SET 设置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;64MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，连接到此 pgbouncer 数据库的所有连接都将使用此用户进行验证（启用 pgbouncer_auth_query 才有用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池化模式，默认为 transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 默认池子大小，默认为 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池子保留空间，默认为 32，当默认池子不够用时，最多再申请这么多条突发连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池的最小大小，默认为 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的最大数据库连接数，默认为 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>自 Pigsty <code>v4.1.0</code> 起，数据库连接池参数统一使用 <code>pool_reserve</code> 与 <code>pool_connlimit</code>，旧别名 <code>pool_size_reserve</code> / <code>pool_max_db_conn</code> 已收敛。</p></blockquote><p>在每个数据库定义对象中，只有 <code>name</code> 是必选字段，其他的字段都是可选项。</p><h3 id=pg_services><code>pg_services</code></h3><p>参数名称： <code>pg_services</code>， 类型： <code>service[]</code>， 层次：<code>C</code></p><p>PostgreSQL 服务列表，需要在 PG 集群层面进行定义。默认值为：<code>[]</code> ，空列表。</p><p>用于在数据库集群层面定义额外的服务，数组中的每一个对象定义了一个 <a href=/docs/pgsql/service/#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1><strong>服务</strong></a>，一个完整的服务定义样例如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>standby                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，服务名称，最终的 svc 名称会使用 `pg_cluster` 作为前缀，例如：pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 必选，暴露的服务端口（作为 kubernetes 服务节点端口模式）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># 可选，服务绑定的 IP 地址，默认情况下为所有 IP 地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># 必选，服务成员选择器，使用 JMESPath 来筛选配置清单</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 可选，服务成员选择器（备份），也就是当默认选择器选中的实例都宕机后，服务才会由这里选中的实例成员来承载</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，目标端口，default|postgres|pgbouncer|&lt;port_number&gt;，默认为 &#39;default&#39;，Default的意思就是使用 pg_default_service_dest 的取值来最终决定</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>check</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，健康检查 URL 路径，默认为 /，这里使用 Patroni API：/sync ，只有同步备库和主库才会返回 200 健康状态码</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，允许的前端连接最大数，默认为5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>balance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>roundrobin            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，haproxy 负载均衡算法（默认为 roundrobin，其他选项：leastconn）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>#options: &#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 注意：健康检查相关参数（inter, fastinter, downinter, rise, fall）现在由 pg_rto_plan 统一控制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 默认 norm 模式参数：inter 2s fastinter 1s downinter 2s rise 3 fall 3</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>请注意，本参数用于在集群层面添加额外的服务。如果您想在全局定义所有 PostgreSQL 数据库都要提供的服务，可以使用 <a href=#pg_default_services><code>pg_default_services</code></a> 参数。</p><h3 id=pg_hba_rules><code>pg_hba_rules</code></h3><p>参数名称： <code>pg_hba_rules</code>， 类型： <code>hba[]</code>， 层次：<code>C</code></p><p>数据库集群/实例的客户端IP黑白名单规则。默认为：<code>[]</code> 空列表。</p><p>对象数组，每一个对象都代表一条规则， <a href=/docs/pgsql/config/hba#%E8%A7%84%E5%88%99%E5%AD%97%E6%AE%B5>hba</a> 规则对象的定义形式如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  10.0.0.0/8      md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  172.16.0.0/12   md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  192.168.0.0/16  md5</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>title</code>： 规则的标题名称，会被渲染为 HBA 文件中的注释。</li><li><code>rules</code>：规则数组，每个元素是一条标准的 HBA 规则字符串。</li><li><code>role</code>：规则的应用范围，哪些实例角色会启用这条规则？<ul><li><code>common</code>：对于所有实例生效</li><li><code>primary</code>, <code>replica</code>,<code>offline</code>： 只针对特定的角色 <a href=#pg_role><code>pg_role</code></a> 实例生效。</li><li>特例：<code>role: 'offline'</code> 的规则除了会应用在 <code>pg_role : offline</code> 的实例上，对于带有 <a href=#pg_offline_query><code>pg_offline_query</code></a> 标记的实例也生效。</li></ul></li></ul><p>除了上面这种原生 HBA 规则定义形式，Pigsty 还提供了另外一种更为简便的别名形式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;intra&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># world|intra|infra|admin|local|localhost|cluster|&lt;cidr&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pwd&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># trust|pwd|ssl|cert|deny|&lt;official auth method&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># all|${dbsu}|${repl}|${admin}|${monitor}|&lt;user&gt;|&lt;group&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># all|replication|....</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># raw hba string precedence over above all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><a href=#pg_default_hba_rules><code>pg_default_hba_rules</code></a> 与本参数基本类似，但它是用于定义全局的 HBA 规则，而本参数通常用于定制某个集群/实例的 HBA 规则。</p><h3 id=pgb_hba_rules><code>pgb_hba_rules</code></h3><p>参数名称： <code>pgb_hba_rules</code>， 类型： <code>hba[]</code>， 层次：<code>C</code></p><p>Pgbouncer 业务HBA规则，默认值为： <code>[]</code>， 空数组。</p><p>此参数与 <a href=#pg_hba_rules><code>pg_hba_rules</code></a> 基本类似，都是 <a href=/docs/pgsql/config/hba#%E8%A7%84%E5%88%99%E5%AD%97%E6%AE%B5>hba</a> 规则对象的数组，区别在于本参数是为 Pgbouncer 准备的。</p><p><a href=#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a> 与本参数基本类似，但它是用于定义全局连接池 HBA 规则，而本参数通常用于定制某个连接池集群/实例的 HBA 规则。</p><h3 id=pg_crontab><code>pg_crontab</code></h3><p>参数名称： <code>pg_crontab</code>， 类型： <code>string[]</code>， 层次：<code>C</code></p><p>PostgreSQL 数据库超级用户（dbsu，默认 <code>postgres</code>）的定时任务列表，默认值为：<code>[]</code> 空数组。</p><p>每个数组元素是一行 crontab 条目，使用标准的用户 crontab 格式：<code>分 时 日 月 周 命令</code>（<strong>无需指定用户名</strong>）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 每天凌晨 1 点全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 13 * * * /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 每天下午 1 点增量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>此参数会将定时任务写入 postgres 用户的个人 crontab 文件：</p><ul><li>EL 系统：<code>/var/spool/cron/postgres</code></li><li>Debian 系统：<code>/var/spool/cron/crontabs/postgres</code></li></ul><blockquote><p><strong>注意</strong>：此参数用于取代在 <a href=/docs/node/param#node_crontab><code>node_crontab</code></a> 中配置 postgres 用户任务的旧做法。
因为 <code>node_crontab</code> 在 NODE 初始化阶段写入 <code>/etc/crontab</code>，此时 <code>postgres</code> 用户可能尚未创建，会导致 cron 报错。</p></blockquote><p>移除集群时，此 crontab 文件会被一并删除。</p><h3 id=pg_replication_username><code>pg_replication_username</code></h3><p>参数名称： <code>pg_replication_username</code>， 类型： <code>username</code>， 层次：<code>G</code></p><p>PostgreSQL 物理复制用户名，默认使用 <code>replicator</code>，不建议修改此参数。</p><h3 id=pg_replication_password><code>pg_replication_password</code></h3><p>参数名称： <code>pg_replication_password</code>， 类型： <code>password</code>， 层次：<code>G</code></p><p>PostgreSQL 物理复制用户密码，默认值为：<code>DBUser.Replicator</code>。</p><blockquote><p>警告：请在生产环境中修改此密码！</p></blockquote><h3 id=pg_admin_username><code>pg_admin_username</code></h3><p>参数名称： <code>pg_admin_username</code>， 类型： <code>username</code>， 层次：<code>G</code></p><p>PostgreSQL / Pgbouncer 管理员名称，默认为：<code>dbuser_dba</code>。</p><p>这是全局使用的数据库管理员，具有数据库的 Superuser 权限与连接池的流量管理权限，请务必控制使用范围。</p><h3 id=pg_admin_password><code>pg_admin_password</code></h3><p>参数名称： <code>pg_admin_password</code>， 类型： <code>password</code>， 层次：<code>G</code></p><p>PostgreSQL / Pgbouncer 管理员密码，默认为： <code>DBUser.DBA</code>。</p><blockquote><p>警告：请在生产环境中修改此密码！</p></blockquote><h3 id=pg_monitor_username><code>pg_monitor_username</code></h3><p>参数名称： <code>pg_monitor_username</code>， 类型： <code>username</code>， 层次：<code>G</code></p><p>PostgreSQL/Pgbouncer 监控用户名，默认为：<code>dbuser_monitor</code>。</p><p>这是一个用于监控的数据库/连接池用户，不建议修改此用户名。</p><p>但如果您的现有数据库使用了不同的监控用户，可以在指定监控目标时使用此参数传入使用的监控用户名。</p><h3 id=pg_monitor_password><code>pg_monitor_password</code></h3><p>参数名称： <code>pg_monitor_password</code>， 类型： <code>password</code>， 层次：<code>G</code></p><p>PostgreSQL/Pgbouncer 监控用户使用的密码，默认为：<code>DBUser.Monitor</code>。</p><p>请尽可能不要在密码中使用 <code>@:/</code> 这些容易与 URL 分隔符混淆的字符，减少不必要的麻烦。</p><blockquote><p>警告：请在生产环境中修改此密码！</p></blockquote><h3 id=pg_dbsu_password><code>pg_dbsu_password</code></h3><p>参数名称： <code>pg_dbsu_password</code>， 类型： <code>password</code>， 层次：<code>G/C</code></p><p>PostgreSQL <a href=#pg_dbsu><code>pg_dbsu</code></a> 超级用户密码，默认是空字符串，即不为其设置密码。</p><p>我们不建议为 dbsu 配置密码登陆，这会增大攻击面。例外情况是：<a href=#pg_mode><code>pg_mode</code></a> = <code>citus</code>，这时候需要为每个分片集群的 dbsu 配置密码，以便在分片集群内部进行连接。</p><hr><h2 id=pg_install><code>PG_INSTALL</code></h2><p>本节负责安装 PostgreSQL 及其扩展。如果您希望安装不同大版本与扩展插件，修改 <a href=#pg_version><code>pg_version</code></a> 与 <a href=#pg_extensions><code>pg_extensions</code></a> 即可，不过请注意，并不是所有扩展都在所有大版本可用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># os 数据库超级用户名称，默认为 postgres，最好不要更改</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_uid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>26</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># os 数据库超级用户 uid 和 gid，默认为 26，适用于默认的 postgres 用户和组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_sudo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>limit              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 数据库超级用户 sudo 权限，可选 none,limit,all,nopass。默认为 limit</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_home</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/var/lib/pgsql     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgresql 主目录，默认为 `/var/lib/pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_ssh_exchange</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># 是否在相同的 pgsql 集群中交换 postgres 数据库超级用户的 ssh 密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 要安装的 postgres 主版本，默认为 18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_bin_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/usr/pgsql/bin       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres 二进制目录，默认为 `/usr/pgsql/bin`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/postgres     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres 日志目录，默认为 `/pg/log/postgres`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># pg packages to be installed, alias can be used</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># pg extensions to be installed, alias can be used</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_dbsu><code>pg_dbsu</code></h3><p>参数名称： <code>pg_dbsu</code>， 类型： <code>username</code>， 层次：<code>C</code></p><p>PostgreSQL 使用的操作系统 dbsu 用户名， 默认为 <code>postgres</code>，改这个用户名是不太明智的。</p><p>不过在特定情况下，您可能会使用到不同于 <code>postgres</code> 的用户名，例如在安装配置 Greenplum / MatrixDB 时，需要使用 <code>gpadmin</code> / <code>mxadmin</code> 作为相应的操作系统超级用户。</p><h3 id=pg_dbsu_uid><code>pg_dbsu_uid</code></h3><p>参数名称： <code>pg_dbsu_uid</code>， 类型： <code>int</code>， 层次：<code>C</code></p><p>操作系统数据库超级用户的 uid 和 gid，<code>26</code> 是 PGDG RPM 默认的 postgres 用户 UID/GID。</p><p>对于 Debian/Ubuntu 系统，没有默认值，且 <code>26</code> 号用户经常被占用。因此Pigsty 在检测到安装环境为 Debian 系，且 uid 为 <code>26</code> 时，会自动使用替换的 <code>pg_dbsu_uid = 543</code>。</p><h3 id=pg_dbsu_sudo><code>pg_dbsu_sudo</code></h3><p>参数名称： <code>pg_dbsu_sudo</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>数据库超级用户的 sudo 权限，可以是 <code>none</code>、<code>limit</code>、<code>all</code> 或 <code>nopass</code>。默认为 <code>limit</code></p><ul><li><p><code>none</code>: 无 Sudo 权限</p></li><li><p><code>limit</code>: 有限的 sudo 权限，用于执行与数据库相关的组件的 <code>systemctl</code> 命令（默认选项）。</p></li><li><p><code>all</code>: 完全的 <code>sudo</code> 权限，需要密码。</p></li><li><p><code>nopass</code>: 不需要密码的完全 <code>sudo</code> 权限（不推荐）。</p></li><li><p>默认值为 <code>limit</code>，只允许执行 <code>sudo systemctl &lt;start|stop|reload> &lt;postgres|patroni|pgbouncer|...> </code>。</p></li></ul><h3 id=pg_dbsu_home><code>pg_dbsu_home</code></h3><p>参数名称： <code>pg_dbsu_home</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>postgresql 主目录，默认为 <code>/var/lib/pgsql</code>，与官方的 pgdg RPM 保持一致。</p><h3 id=pg_dbsu_ssh_exchange><code>pg_dbsu_ssh_exchange</code></h3><p>参数名称： <code>pg_dbsu_ssh_exchange</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>是否在同一 PostgreSQL 集群中交换操作系统 dbsu 的 ssh 密钥？</p><p>默认值为 <code>true</code>，意味着同一集群中的数据库超级用户可以互相 ssh 访问。</p><h3 id=pg_version><code>pg_version</code></h3><p>参数名称： <code>pg_version</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>要安装的 postgres 主版本，默认为 <code>18</code>。</p><p>请注意，PostgreSQL 的物理流复制不能跨主要版本，因此最好不要在实例级别上配置此项。</p><p>您可以使用 <a href=#pg_packages><code>pg_packages</code></a> 和 <a href=#pg_extensions><code>pg_extensions</code></a> 中的参数来为特定的 PG 大版本安装不同的软件包与扩展。</p><h3 id=pg_bin_dir><code>pg_bin_dir</code></h3><p>参数名称： <code>pg_bin_dir</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>PostgreSQL 二进制程序目录，默认为 <code>/usr/pgsql/bin</code>。</p><p>默认值是在安装过程中手动创建的软链接，指向安装的特定的 Postgres 版本目录。</p><p>例如 <code>/usr/pgsql -> /usr/pgsql-15</code>。在 Ubuntu/Debian 上则指向 <code>/usr/lib/postgresql/15/bin</code>。</p><p>更多详细信息，请查看 <a href=/docs/ref/fhs#postgres-fhs>PGSQL 文件结构</a>。</p><h3 id=pg_log_dir><code>pg_log_dir</code></h3><p>参数名称： <code>pg_log_dir</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>PostgreSQL 日志目录，默认为：<code>/pg/log/postgres</code>，Vector 日志代理会使用此变量收集 PostgreSQL 日志。</p><p>请注意，如果日志目录 <a href=#pg_log_dir><code>pg_log_dir</code></a> 以数据库目录 <a href=#pg_data><code>pg_data</code></a> 作为前缀，则不会显式创建（数据库目录初始化时自动创建）。</p><h3 id=pg_packages><code>pg_packages</code></h3><p>参数名称： <code>pg_packages</code>， 类型： <code>string[]</code>， 层次：<code>C</code></p><p>要安装的 PostgreSQL 软件包（RPM/DEB），这是一个包名数组，元素可以是空格或逗号分隔的包别名。</p><p>Pigsty v4 将默认值收敛为两个别名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>pgsql-main</code>：映射到当前平台上的 PostgreSQL 内核、客户端、PL 语言以及 <code>pg_repack</code>、<code>wal2json</code>、<code>pgvector</code> 等核心扩展。</li><li><code>pgsql-common</code>：映射到运行数据库必需的配套组件，例如 Patroni、Pgbouncer、pgBackRest、pg_exporter、vip-manager 等守护进程。</li></ul><p>别名的具体定义可以在 <a href=https://github.com/Vonng/pigsty/tree/main/roles/node_id/vars><code>roles/node_id/vars/</code></a> 中的 <code>pg_package_map</code> 查到，Pigsty 会先根据操作系统和架构解析别名，再将 <code>$v</code>/<code>${pg_version}</code> 替换为实际主版本 <a href=#pg_version><code>pg_version</code></a>，最后安装真实的软件包。这样可以屏蔽不同发行版之间的包名差异。</p><p>如果需要额外的软件包（例如特定 FDW 或扩展），可以直接在 <code>pg_packages</code> 中追加别名或真实包名。但请记得保留 <code>pgsql-main pgsql-common</code>，否则会缺失核心组件。</p><h3 id=pg_extensions><code>pg_extensions</code></h3><p>参数名称： <code>pg_extensions</code>， 类型： <code>string[]</code>， 层次：<code>G/C</code></p><p>要安装的 PostgreSQL 扩展包（RPM/DEB），这是一个由扩展包名或别名组成的数组。</p><p>从 v4 开始默认值为空列表 <code>[]</code>，Pigsty 不再强制安装大体量扩展，用户可以按需选择，避免占用额外的磁盘与依赖。</p><p>如果需要安装扩展，请像下面这样填充：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgis timescaledb pgvector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-fdw    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用别名一次性安装常用 FDW</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>pg_package_map</code> 中提供了大量别名，方便在不同发行版之间屏蔽包名差异。以下是 EL9 平台可用的扩展组合供参考（按需挑选即可）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_extensions: <span style=color:#8f5902;font-style:italic># extensions to be installed on this cluster</span>
</span></span><span style=display:flex><span>  - timescaledb periods temporal_tables emaj table_version pg_cron pg_later pg_background pg_timetable
</span></span><span style=display:flex><span>  - postgis pgrouting pointcloud pg_h3 q3c ogr_fdw geoip <span style=color:#8f5902;font-style:italic>#pg_geohash #mobilitydb</span>
</span></span><span style=display:flex><span>  - pgvector pgvectorscale pg_vectorize pg_similarity pg_tiktoken pgml <span style=color:#8f5902;font-style:italic>#smlar</span>
</span></span><span style=display:flex><span>  - pg_search pg_bigm zhparser hunspell
</span></span><span style=display:flex><span>  - hydra pg_analytics pg_lakehouse pg_duckdb duckdb_fdw pg_fkpart pg_partman plproxy <span style=color:#8f5902;font-style:italic>#pg_strom citus</span>
</span></span><span style=display:flex><span>  - pg_hint_plan age hll rum pg_graphql pg_jsonschema jsquery index_advisor hypopg imgsmlr pg_ivm pgmq pgq <span style=color:#8f5902;font-style:italic>#rdkit</span>
</span></span><span style=display:flex><span>  - pg_tle plv8 pllua plprql pldebugger plpgsql_check plprofiler plsh <span style=color:#8f5902;font-style:italic>#pljava plr pgtap faker dbt2</span>
</span></span><span style=display:flex><span>  - prefix semver pgunit md5hash asn1oid roaringbitmap pgfaceting pgsphere pg_country pg_currency pgmp numeral pg_rational pguint ip4r timestamp9 chkpass <span style=color:#8f5902;font-style:italic>#pg_uri #pgemailaddr #acl #debversion #pg_rrule</span>
</span></span><span style=display:flex><span>  - topn pg_gzip pg_http pg_net pg_html5_email_address pgsql_tweaks pg_extra_time pg_timeit count_distinct extra_window_functions first_last_agg tdigest aggs_for_arrays pg_arraymath pg_idkit pg_uuidv7 permuteseq pg_hashids
</span></span><span style=display:flex><span>  - sequential_uuids pg_math pg_random pg_base36 pg_base62 floatvec pg_financial pgjwt pg_hashlib shacrypt cryptint pg_ecdsa pgpcre icu_ext envvar url_encode <span style=color:#8f5902;font-style:italic>#pg_zstd #aggs_for_vecs #quantile #lower_quantile #pgqr #pg_protobuf</span>
</span></span><span style=display:flex><span>  - pg_repack pg_squeeze pg_dirtyread pgfincore pgdd ddlx pg_prioritize pg_checksums pg_readonly safeupdate pg_permissions pgautofailover pg_catcheck preprepare pgcozy pg_orphaned pg_crash pg_cheat_funcs pg_savior table_log pg_fio <span style=color:#8f5902;font-style:italic>#pgpool pgagent</span>
</span></span><span style=display:flex><span>  - pg_profile pg_show_plans pg_stat_kcache pg_stat_monitor pg_qualstats pg_store_plans pg_track_settings pg_wait_sampling system_stats pg_meta pgnodemx pg_sqlog bgw_replstatus pgmeminfo toastinfo pagevis powa pg_top <span style=color:#8f5902;font-style:italic>#pg_statviz #pgexporter_ext #pg_mon</span>
</span></span><span style=display:flex><span>  - passwordcheck supautils pgsodium pg_vault anonymizer pg_tde pgsmcrypto pgaudit pgauditlogtofile pg_auth_mon credcheck pgcryptokey pg_jobmon logerrors login_hook set_user pg_snakeoil pgextwlist pg_auditor noset <span style=color:#8f5902;font-style:italic>#sslutils</span>
</span></span><span style=display:flex><span>  - wrappers multicorn odbc_fdw mysql_fdw tds_fdw sqlite_fdw pgbouncer_fdw mongo_fdw redis_fdw pg_redis_pubsub kafka_fdw hdfs_fdw firebird_fdw aws_s3 log_fdw <span style=color:#8f5902;font-style:italic>#oracle_fdw #db2_fdw #jdbc_fdw</span>
</span></span><span style=display:flex><span>  - orafce pgtt session_variable pg_statement_rollback pg_dbms_metadata pg_dbms_lock pgmemcache <span style=color:#8f5902;font-style:italic>#pg_dbms_job #wiltondb</span>
</span></span><span style=display:flex><span>  - pglogical pgl_ddl_deploy pg_failover_slots wal2json wal2mongo decoderbufs decoder_raw mimeo pgcopydb pgloader pg_fact_loader pg_bulkload pg_comparator pgimportdoc pgexportdoc <span style=color:#8f5902;font-style:italic>#repmgr #slony</span>
</span></span><span style=display:flex><span>  - gis-stack rag-stack fdw-stack fts-stack etl-stack feat-stack olap-stack supa-stack stat-stack json-stack
</span></span></code></pre></div><p>完整列表请参考：<a href=https://github.com/Vonng/pigsty/blob/main/roles/node_id/vars/><code>roles/node_id/vars</code></a></p><hr><h2 id=pg_bootstrap><code>PG_BOOTSTRAP</code></h2><p>使用 Patroni 引导拉起 PostgreSQL 集群，并设置 1:1 对应的 Pgbouncer 连接池。</p><p>它还会使用 <a href=#pg_provision><code>PG_PROVISION</code></a> 中定义的默认角色、用户、权限、模式、扩展来初始化数据库集群</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/data                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres data directory, `/pg/data` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_fs_main</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/data/postgres       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres main data directory, `/data/postgres` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_fs_backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/data/backups      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres backup data directory, `/data/backups` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_storage_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>SSD             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># storage type for pg main data, SSD,HDD, SSD by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dummy_filesize</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MiB         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># size of `/pg/dummy`, hold 64MB disk space for emergency use</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_listen</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.0.0.0&#39;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># postgres/pgbouncer listen addresses, comma separated list</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># postgres listen port, 5432 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_localhost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/var/run/postgresql</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres unix socket dir for localhost connection</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># if disabled, no postgres cluster will be created during init</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_mode: default             # patroni working mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default,pause,remove</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># top level key namespace in etcd, used by patroni &amp; vip</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8008</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># patroni listen port, 8008 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/patroni </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># patroni log dir, `/pg/log/patroni` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_ssl_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># secure patroni RestAPI communications with SSL?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_watchdog_mode: off        # patroni watchdog mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>automatic,required,off. off by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># patroni restapi username, `postgres` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>patroni_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Patroni.API    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># patroni restapi password, `Patroni.API` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_etcd_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># etcd password for this pg cluster, &#39;&#39; to use pg_cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database name, used by citus,etc... ,postgres by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># extra parameters in postgresql.auto.conf</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># extra files to be copied to postgres data directory (e.g. license)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_conf: oltp.yml                 # config template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp,olap,crit,tiny. `oltp.yml` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_max_conn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>auto                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># postgres max connections, `auto` will use recommended value</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_shared_buffer_ratio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.25</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># postgres shared buffers ratio, 0.25 by default, 0.1~0.4</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_io_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>worker             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># io method for postgres, auto,sync,worker,io_uring, worker by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto: norm                      # shared rto mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>fast,norm,safe,wide (or seconds for compatibility)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rpo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1048576</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># recovery point objective in bytes, `1MiB` at most by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># preloaded libraries, `pg_stat_statements,auto_explain` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># replication apply delay for standby cluster leader</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_checksum</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># enable data checksum for postgres cluster?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pwd_enc: scram-sha-256         # passwords encryption algorithm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>fixed to scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database cluster encoding, `UTF8` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database cluster local, `C` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database cluster collate, `C` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># database character type, `C` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#pgsodium_key: &#34;&#34;                 # pgsodium key, 64 hex digit, default to sha256(pg_cluster)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#pgsodium_getkey_script: &#34;&#34;       # pgsodium getkey script path, pgsodium_getkey by default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_data><code>pg_data</code></h3><p>参数名称： <code>pg_data</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>Postgres 数据目录，默认为 <code>/pg/data</code>。</p><p>这是一个指向底层实际数据目录的符号链接，在多处被使用，请不要修改它。参阅 <a href=/docs/ref/fhs>PGSQL文件结构</a> 获取详细信息。</p><h3 id=pg_fs_main><code>pg_fs_main</code></h3><p>参数名称： <code>pg_fs_main</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>PostgreSQL 主数据盘的挂载点/文件系统路径，默认为<code>/data/postgres</code>。</p><p>默认值：<code>/data/postgres</code>，它将直接用作 PostgreSQL 主数据目录的父目录。</p><p>建议使用 NVME SSD 作为 PostgreSQL 主数据存储，Pigsty默认为SSD存储进行了优化，但是也支持HDD。</p><p>您可以更改 <a href=#pg_storage_type><code>pg_storage_type</code></a> 为 <code>HDD</code> 以针对HDD存储进行优化。</p><h3 id=pg_fs_backup><code>pg_fs_backup</code></h3><p>参数名称： <code>pg_fs_backup</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>PostgreSQL 备份数据盘的挂载点/文件系统路径，默认为<code>/data/backups</code>。</p><p>如果您使用的是默认的 <a href=#pgbackrest_method><code>pgbackrest_method</code></a> = <code>local</code>，建议为备份存储使用一个单独的磁盘。</p><p>备份磁盘应足够大，以容纳所有的备份，至少足以容纳3个基础备份+2天的WAL归档。 通常容量不是什么大问题，因为您可以使用便宜且大的机械硬盘作为备份盘。</p><p>建议为备份存储使用一个单独的磁盘，否则 Pigsty 将回退到主数据磁盘，并占用主数据盘的容量与IO。</p><h3 id=pg_storage_type><code>pg_storage_type</code></h3><p>参数名称： <code>pg_storage_type</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>PostgreSQL 数据存储介质的类型：<code>SSD</code>或<code>HDD</code>，默认为<code>SSD</code>。</p><p>默认值：<code>SSD</code>，它会影响一些调优参数，如 <code>random_page_cost</code> 和 <code>effective_io_concurrency</code> 。</p><h3 id=pg_dummy_filesize><code>pg_dummy_filesize</code></h3><p>参数名称： <code>pg_dummy_filesize</code>， 类型： <code>size</code>， 层次：<code>C</code></p><p><code>/pg/dummy</code>的大小，默认值为<code>64MiB</code>，用于紧急使用的64MB磁盘空间。</p><p>当磁盘已满时，删除占位符文件可以为紧急使用释放一些空间，建议生产使用至少<code>8GiB</code>。</p><h3 id=pg_listen><code>pg_listen</code></h3><p>参数名称： <code>pg_listen</code>， 类型： <code>ip</code>， 层次：<code>C</code></p><p>PostgreSQL / Pgbouncer 的监听地址，默认为<code>0.0.0.0</code>（所有ipv4地址）。</p><p>您可以在此变量中使用占位符，例如：<code>'${ip},${lo}'</code>或<code>'${ip},${vip},${lo}'</code>：</p><ul><li><code>${ip}</code>：转换为 <code>inventory_hostname</code>，它是配置清单中定义的首要内网IP地址。</li><li><code>${vip}</code>：如果启用了 <a href=#pg_vip_enabled><code>pg_vip_enabled</code></a>，将使用 <a href=#pg_vip_address><code>pg_vip_address</code></a> 的主机部分。</li><li><code>${lo}</code>：将替换为<code>127.0.0.1</code></li></ul><p>对于高安全性要求的生产环境，建议限制监听的IP地址。</p><h3 id=pg_port><code>pg_port</code></h3><p>参数名称： <code>pg_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p><p>PostgreSQL 服务器监听的端口，默认为 <code>5432</code>。</p><h3 id=pg_localhost><code>pg_localhost</code></h3><p>参数名称： <code>pg_localhost</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>本地主机连接 PostgreSQL 使用的 Unix套接字目录，默认值为<code>/var/run/postgresql</code>。</p><p>PostgreSQL 和 Pgbouncer 本地连接的Unix套接字目录，<a href=/docs/concept/arch/pgsql#pg_exporter><code>pg_exporter</code></a> 和 patroni 都会优先使用 Unix 套接字访问 PostgreSQL。</p><h3 id=pg_namespace><code>pg_namespace</code></h3><p>参数名称： <code>pg_namespace</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>在 <a href=/docs/concept/arch/pgsql#etcd>etcd</a> 中使用的顶级命名空间，由 patroni 和 vip-manager 使用，默认值是：<code>/pg</code>，不建议更改。</p><h3 id=patroni_enabled><code>patroni_enabled</code></h3><p>参数名称： <code>patroni_enabled</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>是否启用 Patroni ？默认值为：<code>true</code>。</p><p>如果禁用，则在初始化期间不会创建Postgres集群。Pigsty将跳过拉起 patroni的任务，当试图向现有的postgres实例添加一些组件时，可以使用此参数。</p><h3 id=patroni_mode><code>patroni_mode</code></h3><p>参数名称： <code>patroni_mode</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>Patroni 工作模式：<code>default</code>，<code>pause</code>，<code>remove</code>。默认值：<code>default</code>。</p><ul><li><code>default</code>：正常使用 Patroni 引导 PostgreSQL 集群</li><li><code>pause</code>：与<code>default</code>相似，但在引导后进入维护模式</li><li><code>remove</code>：使用Patroni初始化集群，然后删除Patroni并使用原始 PostgreSQL。</li></ul><h3 id=patroni_port><code>patroni_port</code></h3><p>参数名称： <code>patroni_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p><p>patroni监听端口，默认为<code>8008</code>，不建议更改。</p><p>Patroni API服务器在此端口上监听健康检查和API请求。</p><h3 id=patroni_log_dir><code>patroni_log_dir</code></h3><p>参数名称： <code>patroni_log_dir</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>patroni 日志目录，默认为 <code>/pg/log/patroni</code>，由 Vector 日志代理收集。</p><h3 id=patroni_ssl_enabled><code>patroni_ssl_enabled</code></h3><p>参数名称： <code>patroni_ssl_enabled</code>， 类型： <code>bool</code>， 层次：<code>G</code></p><p>使用SSL保护patroni RestAPI通信吗？默认值为<code>false</code>。</p><p>此参数是一个全局标志，只能在部署之前预先设置。因为如果为 patroni 启用了SSL，您将必须使用 HTTPS 而不是 HTTP 执行健康检查、获取指标，调用API。</p><h3 id=patroni_watchdog_mode><code>patroni_watchdog_mode</code></h3><p>参数名称： <code>patroni_watchdog_mode</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>patroni看门狗模式：<code>automatic</code>，<code>required</code>，<code>off</code>，默认值为 <code>off</code>。</p><p>在主库故障的情况下，Patroni 可以使用 <a href=https://patroni.readthedocs.io/en/latest/watchdog.html><strong>看门狗</strong></a> 来强制关机旧主库节点以避免脑裂。</p><ul><li><code>off</code>：不使用<code>看门狗</code>。完全不进行 Fencing （默认行为）</li><li><code>automatic</code>：如果内核启用了<code>softdog</code>模块并且看门狗属于dbsu，则启用 <code>watchdog</code>。</li><li><code>required</code>：强制启用 <code>watchdog</code>，如果<code>softdog</code>不可用则拒绝启动 Patroni/PostgreSQL。</li></ul><p>默认值为<code>off</code>，您不应该在 Infra节点 启用看门狗，数据一致性优先于可用性的关键系统，特别是与钱有关的业务集群可以考虑打开此选项。</p><blockquote><p><strong>注意</strong>：当使用 <a href=#pg_conf><code>pg_conf</code></a> = <code>crit</code> 配置模板时，<code>off</code> 会被自动提升为 <code>automatic</code>，以确保关键业务系统的数据一致性。</p></blockquote><p>请注意，如果您的所有访问流量都使用 HAproxy 健康检查 <a href=/docs/pgsql/service/#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1><strong>服务接入</strong></a>，正常是不存在脑裂风险的。</p><h3 id=patroni_username><code>patroni_username</code></h3><p>参数名称： <code>patroni_username</code>， 类型： <code>username</code>， 层次：<code>C</code></p><p>Patroni REST API 用户名，默认为 <code>postgres</code>，与 <a href=#patroni_password><code>patroni_password</code></a> 配对使用。</p><p>Patroni的危险 REST API （比如重启集群）由额外的用户名/密码保护，查看 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a> 和 <a href=https://patroni.readthedocs.io/en/latest/rest_api.html>Patroni RESTAPI</a> 以获取详细信息。</p><h3 id=patroni_password><code>patroni_password</code></h3><p>参数名称： <code>patroni_password</code>， 类型： <code>password</code>， 层次：<code>C</code></p><p>Patroni REST API 密码，默认为<code>Patroni.API</code>。</p><blockquote><p>警告：务必生产环境中修改此参数！</p></blockquote><h3 id=pg_primary_db><code>pg_primary_db</code></h3><p>参数名称： <code>pg_primary_db</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>指定集群中的主数据库名称，用于 citus 等业务数据库，默认为 <code>postgres</code>。</p><p>例如，在使用 Patroni 管理高可用的 Citus 集群时，您必须选择一个 “主数据库”。</p><p>此外，在这里指定的数据库名称，将在 PGSQL 模块安装完成后，显示在打印的连接串中。</p><h3 id=pg_parameters><code>pg_parameters</code></h3><p>参数名称： <code>pg_parameters</code>， 类型： <code>dict</code>， 层次：<code>G/C/I</code></p><p>可用于指定并管理 <code>postgresql.auto.conf</code> 中的配置参数。</p><p>当集群所有实例完成初始化后，<code>pg_param</code> 任务将会把本字典中的 key / value 键值对依次覆盖写入 <code>/pg/data/postgresql.auto.conf</code> 中。</p><blockquote><p>注意：请不要手工修改该配置文件，或通过 <code>ALTER SYSTEM</code> 修改集群配置参数，修改会在下一次配置同步时被覆盖。</p></blockquote><p>该变量的优先级大于 Patroni / DCS 中的集群配置（即优先级高于集群配置，由 Patroni <code>edit-config</code> 编辑的配置），因此通常可以在实例级别覆盖集群默认参数。</p><p>当您的集群成员有着不同的规格（不推荐的行为！）时，您可以通过本参数对每个实例的配置进行精细化管理。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5GB&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;4GB&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;3GB&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>请注意，一些 <a href=https://patroni.readthedocs.io/en/latest/patroni_configuration.html#important-rules>重要的集群参数</a>（对主从库参数值有要求）是 Patroni 直接通过命令行参数管理的，具有最高优先级，无法通过此方式覆盖，对于这些参数，您必须使用 Patroni <code>edit-config</code> 进行管理与配置。</p><p>在主从上必须保持一致的 PostgreSQL 参数（不一致会导致从库无法启动！）：</p><ul><li><code>wal_level</code></li><li><code>max_connections</code></li><li><code>max_locks_per_transaction</code></li><li><code>max_worker_processes</code></li><li><code>max_prepared_transactions</code></li><li><code>track_commit_timestamp</code></li></ul><p>在主从上最好保持一致的参数（考虑到主从切换的可能性）：</p><ul><li><code>listen_addresses</code></li><li><code>port</code></li><li><code>cluster_name</code></li><li><code>hot_standby</code></li><li><code>wal_log_hints</code></li><li><code>max_wal_senders</code></li><li><code>max_replication_slots</code></li><li><code>wal_keep_segments</code></li><li><code>wal_keep_size</code></li></ul><p>您可以设置不存在的参数（例如来自扩展的 GUC，从而配置 <code>ALTER SYSTEM</code> 无法修改的“尚未存在”的参数），但将现有配置修改为非法值可能会导致 PostgreSQL 无法启动，请谨慎配置！</p><h3 id=pg_files><code>pg_files</code></h3><p>参数名称： <code>pg_files</code>， 类型： <code>path[]</code>， 层次：<code>C</code></p><p>用于指定需要拷贝至PGDATA目录的文件列表，默认为空数组：<code>[]</code></p><p>在本参数中指定的文件将会被拷贝至 <code>{{ pg_data }}</code> 目录下，这主要用于下发特殊商业版本 PostgreSQL 内核要求的 License 文件。</p><p>目前仅有 PolarDB （Oracle兼容）内核需要许可证文件，例如，您可以将 <code>license.lic</code> 文件放置在 <code>files/</code> 目录下，并在 <code>pg_files</code> 中指定：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>license.lic ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_conf><code>pg_conf</code></h3><p>参数名称： <code>pg_conf</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>配置模板：<code>{oltp,olap,crit,tiny}.yml</code>，默认为<code>oltp.yml</code>。</p><ul><li><code>tiny.yml</code>：为小节点、虚拟机、小型演示优化（1-8核，1-16GB）</li><li><code>oltp.yml</code>：为OLTP工作负载和延迟敏感应用优化（4C8GB+）（默认模板）</li><li><code>olap.yml</code>：为OLAP工作负载和吞吐量优化（4C8G+）</li><li><code>crit.yml</code>：为数据一致性和关键应用优化（4C8G+）</li></ul><p>默认值：<code>oltp.yml</code>，但是 <a href=/docs/setup/install#%E9%85%8D%E7%BD%AE>配置</a> 程序将在当前节点为小节点时将此值设置为 <code>tiny.yml</code>。</p><p>您可以拥有自己的模板，只需将其放在<code>templates/&lt;mode>.yml</code>下，并将此值设置为模板名称即可使用。</p><h3 id=pg_max_conn><code>pg_max_conn</code></h3><p>参数名称： <code>pg_max_conn</code>， 类型： <code>int</code>， 层次：<code>C</code></p><p>PostgreSQL 服务器最大连接数。你可以选择一个介于 50 到 5000 之间的值，或使用 <code>auto</code> 选择推荐值。</p><p>默认值为 <code>auto</code>，会根据 <a href=#pg_conf><code>pg_conf</code></a> 和 <a href=#pg_default_service_dest><code>pg_default_service_dest</code></a> 来设定最大连接数。</p><ul><li>tiny: 100</li><li>olap: 200</li><li>oltp: 200 (pgbouncer) / 1000 (postgres)<ul><li>pg_default_service_dest = pgbouncer : 200</li><li>pg_default_service_dest = postgres : 1000</li></ul></li><li>crit: 200 (pgbouncer) / 1000 (postgres)<ul><li>pg_default_service_dest = pgbouncer : 200</li><li>pg_default_service_dest = postgres : 1000</li></ul></li></ul><p>不建议将此值设定为超过 5000，否则你还需要手动增加 haproxy 服务的连接限制。</p><p>Pgbouncer 的事务池可以缓解过多的 OLTP 连接问题，因此默认情况下不建议设置很大的连接数。</p><p>对于 OLAP 场景， <a href=#pg_default_service_dest><code>pg_default_service_dest</code></a> 修改为 <code>postgres</code> 可以绕过连接池。</p><h3 id=pg_shared_buffer_ratio><code>pg_shared_buffer_ratio</code></h3><p>参数名称： <code>pg_shared_buffer_ratio</code>， 类型： <code>float</code>， 层次：<code>C</code></p><p>Postgres 共享缓冲区内存比例，默认为 <code>0.25</code>，正常范围在 <code>0.1</code>~<code>0.4</code> 之间。</p><p>默认值：<code>0.25</code>，意味着节点内存的 25% 将被用作 PostgreSQL 的分片缓冲区。如果您想为 PostgreSQL 启用大页，那么此参数值应当适当小于 <a href=/docs/node/param#node_hugepage_ratio><code>node_hugepage_ratio</code></a>。</p><p>将此值设定为大于 0.4（40%）通常不是好主意，但在极端情况下可能有用。</p><p>注意，共享缓冲区只是 PostgreSQL 中共享内存的一部分，要计算总共享内存，使用 <code>show shared_memory_size_in_huge_pages;</code>。</p><h3 id=pg_rto><code>pg_rto</code></h3><p>参数名称： <code>pg_rto</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>恢复时间目标（RTO）模式，用于控制 Patroni 与 HAProxy 的超时参数，默认为 <code>norm</code>。</p><p>Pigsty 提供四种预设的 RTO 模式，分别针对不同的网络条件与部署场景进行了优化：</p><table><thead><tr><th style=text-align:left>模式</th><th style=text-align:left>适用场景</th><th style=text-align:left>网络条件</th><th style=text-align:left>平均 RTO</th><th style=text-align:left>最坏 RTO</th><th style=text-align:left>误切风险</th></tr></thead><tbody><tr><td style=text-align:left><code>fast</code></td><td style=text-align:left>同机柜/同交换机</td><td style=text-align:left>&lt; 1ms，极稳定</td><td style=text-align:left><strong>14s</strong></td><td style=text-align:left><strong>29s</strong></td><td style=text-align:left>较高</td></tr><tr><td style=text-align:left><code>norm</code></td><td style=text-align:left>同机房（默认）</td><td style=text-align:left>1-5ms，正常</td><td style=text-align:left><strong>21s</strong></td><td style=text-align:left><strong>43s</strong></td><td style=text-align:left>中等</td></tr><tr><td style=text-align:left><code>safe</code></td><td style=text-align:left>同省跨机房</td><td style=text-align:left>10-50ms，跨机房</td><td style=text-align:left><strong>43s</strong></td><td style=text-align:left><strong>91s</strong></td><td style=text-align:left>较低</td></tr><tr><td style=text-align:left><code>wide</code></td><td style=text-align:left>跨地域/跨洲</td><td style=text-align:left>100-200ms，公网</td><td style=text-align:left><strong>92s</strong></td><td style=text-align:left><strong>207s</strong></td><td style=text-align:left>极低</td></tr></tbody></table><p>减小 RTO 可以加快故障恢复速度，但会增加误切风险（网络抖动被误判为故障）。您需要根据实际网络条件选择合适的模式。
更多详情请参阅 <a href=/docs/concept/ha/rto/><strong>RTO 利弊权衡</strong></a> 文档。</p><p>为了向后兼容，也支持直接指定秒数，系统会自动映射到最接近的模式：<code>&lt; 30</code> → <code>fast</code>，<code>30-44</code> → <code>norm</code>，<code>45-89</code> → <code>safe</code>，<code>≥ 90</code> → <code>wide</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>norm  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认模式，适合同机房部署</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>safe  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 跨机房部署推荐</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># 兼容旧版写法，等效于 norm</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_rto_plan><code>pg_rto_plan</code></h3><p>参数名称： <code>pg_rto_plan</code>， 类型： <code>dict</code>， 层次：<code>G</code></p><p>RTO 预设配置字典，定义了 Patroni 高可用与 HAProxy 健康检查的具体超时参数，默认值包含四种预设模式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># [ttl, loop, retry, start, margin, inter, fastinter, downinter, rise, fall]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 30s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 45s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>safe</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>60</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>45</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;1.5s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;3s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 90s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>wide</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>120</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>95</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;2s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#000;font-weight:700>,</span><span style=color:#4e9a06>&#39;4s&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># rto &lt; 150s</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个模式是一个包含 10 个参数的数组，用于同时控制 Patroni 和 HAProxy 的超时行为：</p><table><thead><tr><th style=text-align:center>索引</th><th style=text-align:left>参数名</th><th style=text-align:left>组件</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center>0</td><td style=text-align:left><code>ttl</code></td><td style=text-align:left>Patroni</td><td style=text-align:left>主库锁 TTL（秒）</td></tr><tr><td style=text-align:center>1</td><td style=text-align:left><code>loop_wait</code></td><td style=text-align:left>Patroni</td><td style=text-align:left>主循环休眠间隔（秒）</td></tr><tr><td style=text-align:center>2</td><td style=text-align:left><code>retry_timeout</code></td><td style=text-align:left>Patroni</td><td style=text-align:left>DCS/PostgreSQL 重试超时</td></tr><tr><td style=text-align:center>3</td><td style=text-align:left><code>primary_start_timeout</code></td><td style=text-align:left>Patroni</td><td style=text-align:left>主库恢复等待时间</td></tr><tr><td style=text-align:center>4</td><td style=text-align:left><code>safety_margin</code></td><td style=text-align:left>Patroni</td><td style=text-align:left>Watchdog 安全边界</td></tr><tr><td style=text-align:center>5</td><td style=text-align:left><code>inter</code></td><td style=text-align:left>HAProxy</td><td style=text-align:left>健康检查间隔</td></tr><tr><td style=text-align:center>6</td><td style=text-align:left><code>fastinter</code></td><td style=text-align:left>HAProxy</td><td style=text-align:left>状态变化时的快速检查间隔</td></tr><tr><td style=text-align:center>7</td><td style=text-align:left><code>downinter</code></td><td style=text-align:left>HAProxy</td><td style=text-align:left>服务器宕机时的检查间隔</td></tr><tr><td style=text-align:center>8</td><td style=text-align:left><code>rise</code></td><td style=text-align:left>HAProxy</td><td style=text-align:left>标记为 UP 所需的连续成功检查次数</td></tr><tr><td style=text-align:center>9</td><td style=text-align:left><code>fall</code></td><td style=text-align:left>HAProxy</td><td style=text-align:left>标记为 DOWN 所需的连续失败检查次数</td></tr></tbody></table><p>此参数允许用户通过覆盖默认值来自定义 RTO 行为，或添加新的 RTO 模式。例如，如果您需要一个更激进的 RTO 配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rto_plan</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ultra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.25s&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.5s&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 极速模式，仅限低延迟环境</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p><strong>注意</strong>：修改此参数需要谨慎，不恰当的超时配置可能导致集群不稳定或频繁误切换。</p></blockquote><h3 id=pg_rpo><code>pg_rpo</code></h3><p>参数名称： <code>pg_rpo</code>， 类型： <code>int</code>， 层次：<code>C</code></p><p>以字节为单位的恢复点目标（RPO），默认值：<code>1048576</code>。</p><p>默认为 1MiB，这意味着在故障转移期间最多可以容忍 1MiB 的数据丢失。</p><p>当主节点宕机并且所有副本都滞后时，你必须做出一个艰难的选择，<strong>在可用性和一致性之间进行权衡</strong>：</p><ul><li>提升一个从库成为新的主库，并尽快将系统恢复服务，但要付出可接受的数据丢失代价（例如，少于 1MB）。</li><li>等待主库重新上线（可能永远不会），或人工干预以避免任何数据丢失。</li></ul><p>你可以使用 <code>crit.yml</code> <a href=#pg_conf>conf</a> 模板来确保在故障转移期间没有数据丢失，但这会牺牲一些性能。</p><h3 id=pg_libs><code>pg_libs</code></h3><p>参数名称： <code>pg_libs</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>预加载的动态共享库，默认为 <code>pg_stat_statements,auto_explain</code>，这是两个 PostgreSQL 自带的扩展，强烈建议启用。</p><p>对于现有集群，您可以直接 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a> 的 <code>shared_preload_libraries</code> 参数并应用生效。</p><p>如果您想使用 TimescaleDB 或 Citus 扩展，您需要将 <code>timescaledb</code> 或 <code>citus</code> 添加到此列表中。<code>timescaledb</code> 和 <code>citus</code> 应当放在这个列表的最前面，例如：</p><pre tabindex=0><code>citus,timescaledb,pg_stat_statements,auto_explain
</code></pre><p>其他需要动态加载的扩展也可以添加到这个列表中，例如 <code>pg_cron</code>， <code>pgml</code> 等，通常 <code>citus</code> 和 <code>timescaledb</code> 有着最高的优先级，应该添加到列表的最前面。</p><h3 id=pg_delay><code>pg_delay</code></h3><p>参数名称： <code>pg_delay</code>， 类型： <code>interval</code>， 层次：<code>I</code></p><p>延迟备库复制延迟，默认值：<code>0</code>。</p><p>如果此值被设置为一个正值，备用集群主库在应用 WAL 变更之前将被延迟这个时间。设置为 <code>1h</code> 意味着该集群中的数据将始终滞后原集群一个小时。</p><p>查看 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟备用集群</a> 以获取详细信息。</p><h3 id=pg_checksum><code>pg_checksum</code></h3><p>参数名称： <code>pg_checksum</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>为 PostgreSQL 集群启用数据校验和吗？默认值是 <code>true</code>，启用。</p><p>这个参数只能在 PGSQL 部署之前设置（但你可以稍后手动启用它）。</p><p>数据校验和可以帮助检测磁盘损坏和硬件故障，从 Pigsty v3.5 开始默认启用此功能以确保数据完整性。</p><h3 id=pg_pwd_enc><code>pg_pwd_enc</code></h3><p>参数名称： <code>pg_pwd_enc</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>密码加密算法，Pigsty v4 以后固定为 <code>scram-sha-256</code>。</p><p>所有新建用户都会使用 SCRAM 凭据。<code>md5</code> 已被淘汰，如需兼容旧客户端，请在业务连接池或客户端驱动中升级至 SCRAM。</p><h3 id=pg_encoding><code>pg_encoding</code></h3><p>参数名称： <code>pg_encoding</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>数据库集群编码，默认为 <code>UTF8</code>。</p><p>不建议使用其他非 <code>UTF8</code> 系编码。</p><h3 id=pg_locale><code>pg_locale</code></h3><p>参数名称： <code>pg_locale</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>数据库集群本地化规则集 (Locale)，默认为 <code>C</code>。</p><p>此参数控制数据库的默认 Locale 设置，影响排序规则、字符分类等行为。使用 <code>C</code> 或 <code>POSIX</code> 可以获得最佳的性能和可预测的排序行为。</p><p>如果您需要特定语言的本地化支持，可以设置为相应的 Locale，例如 <code>en_US.UTF-8</code> 或 <code>zh_CN.UTF-8</code>。请注意，Locale 设置会影响索引的排序顺序，因此在集群初始化后无法更改。</p><h3 id=pg_lc_collate><code>pg_lc_collate</code></h3><p>参数名称： <code>pg_lc_collate</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>数据库集群本地化排序规则，默认为 <code>C</code>。</p><p>除非您知道自己在做什么，否则不建议修改集群级别的本地排序规则设置。</p><h3 id=pg_lc_ctype><code>pg_lc_ctype</code></h3><p>参数名称： <code>pg_lc_ctype</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>数据库字符集 CTYPE，默认为 <code>C</code>。</p><p>从 Pigsty v3.5 开始，为了与 <code>pg_lc_collate</code> 保持一致，默认值改为 <code>C</code>。</p><h3 id=pg_io_method><code>pg_io_method</code></h3><p>参数名称： <code>pg_io_method</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>PostgreSQL 的 IO 方法，默认为 <code>worker</code>。可选值包括：</p><ul><li><code>auto</code>：根据操作系统自动选择，在 Debian 系列或 EL 10+ 上使用 <code>io_uring</code>，否则使用 <code>worker</code></li><li><code>sync</code>：使用传统的同步 IO 方式</li><li><code>worker</code>：使用后台工作进程处理 IO（默认选项）</li><li><code>io_uring</code>：使用 Linux 的 io_uring 异步 IO 接口</li></ul><p>此参数仅适用于 PostgreSQL 17 及以上版本，控制 PostgreSQL 数据块层的 IO 策略。</p><ul><li>在 PostgreSQL 17 中，<code>io_uring</code> 可以提供更高的 IO 性能，但需要操作系统内核支持（Linux 5.1+）并安装 <code>liburing</code> 库。</li><li>在 PostgreSQL 18 中，默认 IO 方法已从 <code>sync</code> 改为 <code>worker</code>，使用后台工作进程处理异步 IO，无需额外依赖。</li><li>如果您使用 Debian 12/Ubuntu 22+ 或 EL 10+ 系统，并希望获得最佳 IO 性能，可以考虑设置为 <code>io_uring</code>。</li></ul><p>请注意，在不支持 <code>io_uring</code> 的系统上设置此值可能导致 PostgreSQL 启动失败，因此 <code>auto</code> 或 <code>worker</code> 是更安全的选择。</p><h3 id=pg_etcd_password><code>pg_etcd_password</code></h3><p>参数名称： <code>pg_etcd_password</code>， 类型： <code>password</code>， 层次：<code>C</code></p><p>此 PostgreSQL 集群在 etcd 中使用的密码，默认为空字符串 <code>''</code>。</p><p>如果设置为空字符串，则会使用 <a href=#pg_cluster><code>pg_cluster</code></a> 参数值作为密码（对于 Citus 集群则使用 <a href=#pg_shard><code>pg_shard</code></a> 参数值）。</p><p>此密码用于 Patroni 连接 etcd 以及 vip-manager 访问 etcd 时的认证。</p><h3 id=pgsodium_key><code>pgsodium_key</code></h3><p>参数名称： <code>pgsodium_key</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>用于 pgsodium 扩展的加密主密钥，由 64 位十六进制数字组成。</p><p>默认不设置此参数，如果未指定，Pigsty 会使用 <code>sha256(pg_cluster)</code> 的值自动生成一个确定性的密钥。</p><p><a href=https://github.com/michelp/pgsodium>pgsodium</a> 是一个基于 libsodium 的 PostgreSQL 扩展，提供加密函数和透明列加密功能。
如果您需要使用 pgsodium 的加密功能，建议显式指定一个安全的随机密钥，并妥善保管。</p><p>生成随机密钥的命令示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>openssl rand -hex <span style=color:#0000cf;font-weight:700>32</span>   <span style=color:#8f5902;font-style:italic># 生成 64 位十六进制密钥</span>
</span></span></code></pre></div><h3 id=pgsodium_getkey_script><code>pgsodium_getkey_script</code></h3><p>参数名称： <code>pgsodium_getkey_script</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>pgsodium 获取密钥脚本的路径，默认使用 Pigsty 模板中的 <code>pgsodium_getkey</code> 脚本。</p><p>此脚本用于在 PostgreSQL 启动时获取 pgsodium 的主密钥。默认脚本会从环境变量或配置文件中读取密钥。</p><p>如果您有自定义的密钥管理需求（如使用 HashiCorp Vault、AWS KMS 等），可以提供自定义脚本路径。</p><h2 id=pg_provision><code>PG_PROVISION</code></h2><p>如果说 <a href=#pg_bootstrap><code>PG_BOOTSTRAP</code></a> 是创建一个新的集群，那么 PG_PROVISION 就是在集群中创建默认的对象，包括：</p><ul><li><a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7>默认角色</a></li><li><a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7>默认用户</a></li><li><a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E6%9D%83%E9%99%90%E7%AD%96%E7%95%A5>默认权限</a></li><li><a href=/docs/pgsql/config/hba#pg_default_hba_rules>默认HBA规则</a></li><li>默认模式</li><li>默认扩展</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_provision</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 在引导后提供postgres集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_init</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-init                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 集群模板的初始化脚本，默认为`pg-init`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># postgres集群中的默认角色和用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 管理员用户创建时的默认权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor ]  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 默认扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_stat_statements ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgstattuple        ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_buffercache     ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pageinspect        ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_prewarm         ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_visibility      ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_freespacemap    ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres_fdw       ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: file_fdw           ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: btree_gist         ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: btree_gin          ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_trgm            ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: intagg             ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: intarray           ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_repack }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_reload</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># HBA变化后是否重载配置？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres 默认 HBA 规则集，按 order 排序</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title: &#39;admin @ everywhere with ssl &amp; pwd&#39;    ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer 默认 HBA 规则集，按 order 排序</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_provision-1><code>pg_provision</code></h3><p>参数名称： <code>pg_provision</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>在集群拉起后，完整本节定义的 PostgreSQL 集群置备工作。默认值为<code>true</code>。</p><p>如果禁用，不会置备 PostgreSQL 集群。对于一些特殊的 &ldquo;PostgreSQL&rdquo; 集群，比如 Greenplum，可以关闭此选项跳过置备阶段。</p><h3 id=pg_init><code>pg_init</code></h3><p>参数名称： <code>pg_init</code>， 类型： <code>string</code>， 层次：<code>G/C</code></p><p>用于初始化数据库模板的Shell脚本位置，默认为 <code>pg-init</code>，该脚本会被拷贝至<code>/pg/bin/pg-init</code>后执行。</p><p>该脚本位于 <a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init><code>roles/pgsql/templates/pg-init</code></a></p><p>你可以在该脚本中添加自己的逻辑，或者提供一个新的脚本放置在 <code>templates/</code> 目录下，并将 <code>pg_init</code> 设置为新的脚本名称。使用自定义脚本时请保留现有的初始化逻辑。</p><h3 id=pg_default_roles><code>pg_default_roles</code></h3><p>参数名称： <code>pg_default_roles</code>， 类型： <code>role[]</code>， 层次：<code>G/C</code></p><p>Postgres 集群中的默认角色和用户。</p><p>Pigsty有一个内置的角色系统，请查看 <a href=/docs/concept/sec/ac/#%E5%9B%9B%E5%B1%82%E8%A7%92%E8%89%B2%E6%A8%A1%E5%9E%8B>PGSQL访问控制：角色系统</a> 了解详情。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># postgres集群中的默认角色和用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly]               ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite]  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true                                          ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_default_privileges><code>pg_default_privileges</code></h3><p>参数名称： <code>pg_default_privileges</code>， 类型： <code>string[]</code>， 层次：<code>G/C</code></p><p>每个数据库中的默认权限（<code>DEFAULT PRIVILEGE</code>）设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 管理员用户创建时的默认权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 基于默认角色系统提供了相应的默认权限设置，请查看 <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E6%9D%83%E9%99%90%E7%AD%96%E7%95%A5>PGSQL访问控制：权限</a> 了解详情。</p><h3 id=pg_default_schemas><code>pg_default_schemas</code></h3><p>参数名称： <code>pg_default_schemas</code>， 类型： <code>string[]</code>， 层次：<code>G/C</code></p><p>要创建的默认模式，默认值为：<code>[ monitor ]</code>，这将在所有数据库上创建一个<code>monitor</code>模式，用于放置各种监控扩展、表、视图、函数。</p><h3 id=pg_default_extensions><code>pg_default_extensions</code></h3><p>参数名称： <code>pg_default_extensions</code>， 类型： <code>extension[]</code>， 层次：<code>G/C</code></p><p>要在所有数据库中默认创建启用的扩展列表，默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># default extensions to be created</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_stat_statements ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgstattuple        ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_buffercache     ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pageinspect        ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_prewarm         ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_visibility      ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_freespacemap    ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres_fdw       ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: file_fdw           ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: btree_gist         ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: btree_gin          ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_trgm            ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: intagg             ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: intarray           ,schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_repack }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>唯一的三方扩展是 <code>pg_repack</code>，这对于数据库维护很重要，所有其他扩展都是内置的 PostgreSQL Contrib 扩展插件。</p><p>监控相关的扩展默认安装在 <code>monitor</code> 模式中，该模式由 <a href=#pg_default_schemas><code>pg_default_schemas</code></a> 创建。</p><h3 id=pg_reload><code>pg_reload</code></h3><p>参数名称： <code>pg_reload</code>， 类型： <code>bool</code>， 层次：<code>A</code></p><p>在hba更改后重新加载 PostgreSQL，默认值为<code>true</code></p><p>当您想在应用HBA更改之前进行检查时，将其设置为<code>false</code>以禁用自动重新加载配置。</p><h3 id=pg_default_hba_rules><code>pg_default_hba_rules</code></h3><p>参数名称： <code>pg_default_hba_rules</code>， 类型： <code>hba[]</code>， 层次：<code>G/C</code></p><p>PostgreSQL 基于主机的认证规则，全局默认规则定义。默认值为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres default host-based authentication rules, order by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title: &#39;admin @ everywhere with ssl &amp; pwd&#39;    ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>默认值为常见场景提供了足够的安全级别，请查看 <a href=/docs/pgsql/config/hba>PGSQL身份验证</a> 了解详情。</p><p>本参数为 <a href=/docs/pgsql/config/hba#%E8%A7%84%E5%88%99%E5%AD%97%E6%AE%B5>HBA</a> 规则对象组成的数组，在形式上与 <a href=#pg_hba_rules><code>pg_hba_rules</code></a> 完全一致。
建议在全局配置统一的 <a href=#pg_default_hba_rules><code>pg_default_hba_rules</code></a>，针对特定集群使用 <a href=#pg_hba_rules><code>pg_hba_rules</code></a> 进行额外定制。两个参数中的规则都会依次应用，后者优先级更高。</p><h3 id=pgb_default_hba_rules><code>pgb_default_hba_rules</code></h3><p>参数名称： <code>pgb_default_hba_rules</code>， 类型： <code>hba[]</code>， 层次：<code>G/C</code></p><p>pgbouncer default host-based authentication rules, array or <a href=/docs/pgsql/config/hba#%E8%A7%84%E5%88%99%E5%AD%97%E6%AE%B5>hba</a> rule object.</p><p>default value provides a fair enough security level for common scenarios, check <a href=/docs/pgsql/config/hba>PGSQL Authentication</a> for details.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer default host-based authentication rules, order by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>默认的Pgbouncer HBA规则很简单：</p><ol><li>允许从<strong>本地</strong>使用密码登陆</li><li>允许从内网网断使用密码登陆</li></ol><p>用户可以按照自己的需求进行定制。</p><p>本参数在形式上与 <a href=#pgb_hba_rules><code>pgb_hba_rules</code></a> 完全一致，建议在全局配置统一的 <a href=#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a>，针对特定集群使用 <a href=#pgb_hba_rules><code>pgb_hba_rules</code></a> 进行额外定制。两个参数中的规则都会依次应用，后者优先级更高。</p><hr><h2 id=pg_backup><code>PG_BACKUP</code></h2><p>本节定义了用于 <a href=https://pgbackrest.org/>pgBackRest</a> 的变量，它被用于 PGSQL 时间点恢复 PITR 。</p><p>查看 <a href=/docs/pgsql/tutorial/pitr>PGSQL 备份 & PITR</a> 以获取详细信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 在 pgsql 主机上启用 pgBackRest 吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/pgbackrest</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 日志目录，默认为 `/pg/log/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 仓库方法：local, minio, [用户定义...]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_init_backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># pgbackrest 初始化完成后是否立即执行全量备份？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># pgbackrest 仓库：https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 默认使用本地 posix 文件系统的 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按计数保留完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，最多保留 3 个完整备份，至少保留 2 个</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># pgbackrest 的可选 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 是与 s3 兼容的，所以使用 s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认为 us-east-1，对 minio 无效</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名称，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户秘密密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 对 minio 使用路径风格的 uri，而不是主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认为 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio ca 文件路径，默认为 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 启用块级增量备份（pgBackRest 2.46+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成一个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 对象存储文件打包阈值，默认 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 对象存储文件打包目标大小，默认 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 在 minio 仓库上按时间保留完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留过去 14 天的完整备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgbackrest_enabled><code>pgbackrest_enabled</code></h3><p>参数名称： <code>pgbackrest_enabled</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>是否在 PGSQL 节点上启用 pgBackRest？默认值为： <code>true</code></p><p>在使用本地文件系统备份仓库（<code>local</code>）时，只有集群主库才会真正启用 <code>pgbackrest</code>。其他实例只会初始化一个空仓库。</p><h3 id=pgbackrest_log_dir><code>pgbackrest_log_dir</code></h3><p>参数名称： <code>pgbackrest_log_dir</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>pgBackRest 日志目录，默认为 <code>/pg/log/pgbackrest</code>，Vector 日志代理会引用此参数收集日志。</p><h3 id=pgbackrest_method><code>pgbackrest_method</code></h3><p>参数名称： <code>pgbackrest_method</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>pgBackRest 仓库方法：默认可选项为：<code>local</code>、<code>minio</code> 或其他用户定义的方法，默认为 <code>local</code>。</p><p>此参数用于确定用于 pgBackRest 的仓库，所有可用的仓库方法都在 <a href=#pgbackrest_repo><code>pgbackrest_repo</code></a> 中定义。</p><p>Pigsty 默认使用 <code>local</code> 备份仓库，这将在主实例的 <code>/pg/backup</code> 目录上创建一个备份仓库。底层存储路径由 <a href=#pg_fs_backup><code>pg_fs_backup</code></a> 指定。</p><h3 id=pgbackrest_init_backup><code>pgbackrest_init_backup</code></h3><p>参数名称： <code>pgbackrest_init_backup</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>在 pgBackRest 初始化完成后是否立即执行一次全量备份？默认为 <code>true</code>。</p><p>此操作仅在集群主库（primary）且非级联从库（无 <a href=#pg_upstream><code>pg_upstream</code></a> 定义）时执行。启用此参数可以确保在集群初始化后立即拥有一个基础备份，以便在需要时进行恢复。</p><h3 id=pgbackrest_repo><code>pgbackrest_repo</code></h3><p>参数名称： <code>pgbackrest_repo</code>， 类型： <code>dict</code>， 层次：<code>G/C</code></p><p>pgBackRest 仓库文档：https://pgbackrest.org/configuration.html#section-repository</p><p>默认值包括两种仓库方法：<code>local</code> 和 <code>minio</code>，定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># pgbackrest 仓库：https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 默认使用本地 posix 文件系统的 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按计数保留完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，最多保留 3 个完整备份，至少保留 2 个</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># pgbackrest 的可选 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 是与 s3 兼容的，所以使用 s3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认为 us-east-1，对 minio 无效</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名称，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户秘密密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 对 minio 使用路径风格的 uri，而不是主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认为 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio ca 文件路径，默认为 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 启用块级增量备份（pgBackRest 2.46+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成一个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 对象存储文件打包阈值，默认 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 对象存储文件打包目标大小，默认 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 在 minio 仓库上按时间保留完整备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留过去 14 天的完整备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您可以定义新的备份仓库，例如使用 AWS S3，GCP 或其他云供应商的 S3 兼容存储服务。</p><p><strong>块级增量备份 (Block Incremental Backup)</strong>：从 pgBackRest 2.46 版本开始支持 <code>block: y</code> 选项，可以实现块级增量备份。
这意味着在增量备份时，pgBackRest 只会备份发生变化的数据块，而不是整个变化的文件，从而大幅减少备份数据量和备份时间。
此功能对于大型数据库特别有用，建议在对象存储仓库上启用此选项。</p><hr><h2 id=pg_access><code>PG_ACCESS</code></h2><p>本节负责数据库访问路径，包括：</p><ul><li>在每个 PGSQL 节点上部署 Pgbouncer 连接池并设定默认行为</li><li>通过本地或专用 haproxy 节点发布服务端口</li><li>绑定可选的 L2 VIP、注册 DNS 记录</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># if disabled, pgbouncer will not be launched on pgsql host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>6432</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># pgbouncer listen port, 6432 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_log_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/log/pgbouncer </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbouncer log dir, `/pg/log/pgbouncer` by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_auth_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># query postgres to retrieve unlisted business users?</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_poolmode: transaction   # pooling mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction,session,statement, transaction by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_sslmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>disable       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbouncer client ssl mode, disable by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_ignore_param</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>extra_float_digits, application_name, TimeZone, DateStyle, IntervalStyle, search_path ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>#INSTANCE # relative load balance weight in service, 100 by default, 0-255</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># dedicate haproxy node group name, or empty string for local nodes by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbouncer</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># default service destination if svc.dest=&#39;default&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># postgres default service definitions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># enable a l2 vip for pgsql primary? false by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>127.0.0.1</span><span style=color:#000>/24     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip address in `&lt;ipv4&gt;/&lt;mask&gt;` format, require if vip is enabled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth0           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip network interface to listen, eth0 by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dns_suffix</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># pgsql dns suffix, &#39;&#39; by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dns_target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>auto              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># auto, primary, vip, none, or ad hoc ip</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgbouncer_enabled><code>pgbouncer_enabled</code></h3><p>参数名称： <code>pgbouncer_enabled</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>默认值为 <code>true</code>，如果禁用，将不会在 <a href=/docs/concept/arch/node#pgsql%E8%8A%82%E7%82%B9><strong>PGSQL节点</strong></a> 上配置连接池 Pgbouncer。</p><h3 id=pgbouncer_port><code>pgbouncer_port</code></h3><p>参数名称： <code>pgbouncer_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p><p>Pgbouncer 监听端口，默认为 <code>6432</code>。</p><h3 id=pgbouncer_log_dir><code>pgbouncer_log_dir</code></h3><p>参数名称： <code>pgbouncer_log_dir</code>， 类型： <code>path</code>， 层次：<code>C</code></p><p>Pgbouncer 日志目录，默认为 <code>/pg/log/pgbouncer</code>，Vector 日志代理会根据此参数收集 Pgbouncer 日志。</p><h3 id=pgbouncer_auth_query><code>pgbouncer_auth_query</code></h3><p>参数名称： <code>pgbouncer_auth_query</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>是否允许 Pgbouncer 查询 PostgreSQL，以允许未显式列出的用户通过连接池访问 PostgreSQL？默认值是 <code>false</code>。</p><p>如果启用，pgbouncer 用户将使用 <code>SELECT username, password FROM monitor.pgbouncer_auth($1)</code> 对 postgres 数据库进行身份验证，否则，只有带有 <code>pgbouncer: true</code> 的业务用户才被允许连接到 Pgbouncer 连接池。</p><h3 id=pgbouncer_poolmode><code>pgbouncer_poolmode</code></h3><p>参数名称： <code>pgbouncer_poolmode</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>Pgbouncer 连接池池化模式：<code>transaction</code>,<code>session</code>,<code>statement</code>，默认为 <code>transaction</code>。</p><ul><li><code>session</code>：会话级池化，具有最佳的功能兼容性。</li><li><code>transaction</code>：事务级池化，具有更好的性能（许多小连接），可能会破坏某些会话级特性，如<code>NOTIFY/LISTEN</code> 等&mldr;</li><li><code>statements</code>：语句级池化，用于简单的只读查询。</li></ul><p>如果您的应用出现功能兼容性问题，可以考虑修改此参数为 <code>session</code>。</p><h3 id=pgbouncer_sslmode><code>pgbouncer_sslmode</code></h3><p>参数名称： <code>pgbouncer_sslmode</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>Pgbouncer 客户端 ssl 模式，默认为 <code>disable</code>。</p><p>注意，启用 SSL 可能会对你的 pgbouncer 产生巨大的性能影响。</p><ul><li><code>disable</code>：如果客户端请求 TLS 则忽略（默认）</li><li><code>allow</code>：如果客户端请求 TLS 则使用。如果没有则使用纯TCP。不验证客户端证书。</li><li><code>prefer</code>：与 allow 相同。</li><li><code>require</code>：客户端必须使用 TLS。如果没有则拒绝客户端连接。不验证客户端证书。</li><li><code>verify-ca</code>：客户端必须使用有效的客户端证书的TLS。</li><li><code>verify-full</code>：与 verify-ca 相同。</li></ul><h3 id=pgbouncer_ignore_param><code>pgbouncer_ignore_param</code></h3><p>参数名称： <code>pgbouncer_ignore_param</code>， 类型： <code>string[]</code>， 层次：<code>C</code></p><p>PgBouncer 忽略的启动参数列表，默认值为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>extra_float_digits, application_name, TimeZone, DateStyle, IntervalStyle, search_path ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这些参数会被配置到 PgBouncer 配置文件中的 <code>ignore_startup_parameters</code> 选项。当客户端连接时设置这些参数时，PgBouncer 不会因为连接池中的连接参数不匹配而创建新的连接。</p><p>这允许不同的客户端使用相同的连接池，即使它们设置了不同的这些参数值。此参数在 Pigsty v3.5 中新增。</p><hr><h3 id=pg_weight><code>pg_weight</code></h3><p>参数名称： <code>pg_weight</code>， 类型： <code>int</code>， 层次：<code>I</code></p><p>服务中的相对负载均衡权重，默认为100，范围0-255。</p><p>默认值： <code>100</code>。您必须在实例变量中定义它，并 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a> 以生效。</p><h3 id=pg_service_provider><code>pg_service_provider</code></h3><p>参数名称： <code>pg_service_provider</code>， 类型： <code>string</code>， 层次：<code>G/C</code></p><p>专用的haproxy节点组名，或默认为本地节点的空字符串。</p><p>如果指定，PostgreSQL服务将注册到专用的haproxy节点组，而不是当下的 PGSQL 集群节点。</p><p>请记住为每个服务在专用的 haproxy 节点上分配<strong>唯一</strong>的端口！</p><p>例如，如果我们在3节点的 <code>pg-test</code> 集群上定义以下参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>infra      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use load balancer on group `infra`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># alloc port 10001 and 10002 for pg-test primary/replica service  </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 10001 ,dest: postgres  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 10002 ,dest: postgres  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_default_service_dest><code>pg_default_service_dest</code></h3><p>参数名称： <code>pg_default_service_dest</code>， 类型： <code>enum</code>， 层次：<code>G/C</code></p><p>当定义一个 <a href=/docs/pgsql/service#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1>服务</a> 时，如果 <code>svc.dest='default'</code>，此参数将用作默认值。</p><p>默认值： <code>pgbouncer</code>，意味着5433主服务和5434副本服务将默认将流量路由到 pgbouncer。</p><p>如果您不想使用pgbouncer，将其设置为<code>postgres</code>。流量将直接路由到 postgres。</p><h3 id=pg_default_services><code>pg_default_services</code></h3><p>参数名称： <code>pg_default_services</code>， 类型： <code>service[]</code>， 层次：<code>G/C</code></p><p>postgres默认服务定义</p><p>默认值是四个默认服务定义，如 <a href=/docs/pgsql/service/#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>PGSQL Service</a> 所述</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># postgres default service definitions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_vip_enabled><code>pg_vip_enabled</code></h3><p>参数名称： <code>pg_vip_enabled</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>为 PGSQL 集群启用 L2 VIP吗？默认值是<code>false</code>，表示不创建 L2 VIP。</p><p>启用 L2 VIP 后，会有一个 VIP 绑定在集群主实例节点上，由 <code>vip-manager</code> 管理，根据 <code>etcd</code> 中的数据进行判断。</p><p>L2 VIP只能在相同的L2网络中使用，这可能会对您的网络拓扑产生额外的限制。</p><h3 id=pg_vip_address><code>pg_vip_address</code></h3><p>参数名称： <code>pg_vip_address</code>， 类型： <code>cidr4</code>， 层次：<code>C</code></p><p>如果启用vip，则需要<code>&lt;ipv4>/&lt;mask></code>格式的vip地址。</p><p>默认值： <code>127.0.0.1/24</code>。这个值由两部分组成：<code>ipv4</code>和<code>mask</code>，用<code>/</code>分隔。</p><h3 id=pg_vip_interface><code>pg_vip_interface</code></h3><p>参数名称： <code>pg_vip_interface</code>， 类型： <code>string</code>， 层次：<code>C/I</code></p><p>vip network interface to listen, <code>eth0</code> by default.</p><p>L2 VIP 监听的网卡接口，默认为 <code>eth0</code>。</p><p>它应该是您节点的首要网卡名，即您在配置清单中使用的IP地址。</p><p>如果您的节点有多块名称不同的网卡，您可以在实例变量上进行覆盖：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: replica ,pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth0 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: primary ,pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica ,pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth2 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 为这个集群启用L2 VIP，默认绑定到主实例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_vip_address: 10.10.10.3/24 # L2网络CIDR: 10.10.10.0/24, vip地址</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># pg_vip_interface: eth1      # 如果您的节点有统一的接口，您可以在这里定义它</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_dns_suffix><code>pg_dns_suffix</code></h3><p>参数名称： <code>pg_dns_suffix</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>PostgreSQL DNS 名称后缀，默认为空字符串。</p><p>在默认情况下，PostgreQL 集群名会作为 DNS 域名注册到 Infra 节点的 <code>dnsmasq</code> 中对外提供解析。</p><p>您可以通过本参数指定一个域名后缀，这样会使用 <code>{{ pg_cluster }}{{ pg_dns_suffix }}</code> 作为集群 DNS 名称。</p><p>例如，如果您将 <code>pg_dns_suffix</code> 设置为 <code>.db.vip.company.tld</code>，那么 <code>pg-test</code> 的集群 DNS 名称将是 <code>pg-test.db.vip.company.tld</code></p><h3 id=pg_dns_target><code>pg_dns_target</code></h3><p>参数名称： <code>pg_dns_target</code>， 类型： <code>enum</code>， 层次：<code>C</code></p><p>Could be: <code>auto</code>, <code>primary</code>, <code>vip</code>, <code>none</code>, or an ad hoc ip address, which will be the target IP address of cluster DNS record.</p><p>default values: <code>auto</code> , which will bind to <code>pg_vip_address</code> if <code>pg_vip_enabled</code>, or fallback to cluster primary instance ip address.</p><ul><li><code>vip</code>: bind to <code>pg_vip_address</code></li><li><code>primary</code>: resolve to cluster primary instance ip address</li><li><code>auto</code>: resolve to <code>pg_vip_address</code> if <code>pg_vip_enabled</code>, or fallback to cluster primary instance ip address.</li><li><code>none</code>: do not bind to any ip address</li><li><code>&lt;ipv4></code>: bind to the given IP address</li></ul><p>可以是：<code>auto</code>、<code>primary</code>、<code>vip</code>、<code>none</code>或一个特定的IP地址，它将是集群DNS记录的解析目标IP地址。</p><p>默认值： <code>auto</code>，如果<code>pg_vip_enabled</code>，将绑定到<code>pg_vip_address</code>，否则会回退到集群主实例的 IP 地址。</p><ul><li><code>vip</code>：绑定到<code>pg_vip_address</code></li><li><code>primary</code>：解析为集群主实例IP地址</li><li><code>auto</code>：如果 <a href=#pg_vip_enabled><code>pg_vip_enabled</code></a>，解析为 <a href=#pg_vip_address><code>pg_vip_address</code></a>，或回退到集群主实例ip地址。</li><li><code>none</code>：不绑定到任何ip地址</li><li><code>&lt;ipv4></code>：绑定到指定的IP地址</li></ul><hr><h2 id=pg_monitor><code>PG_MONITOR</code></h2><p>PG_MONITOR 组的参数用于监控 PostgreSQL 数据库、Pgbouncer 连接池与 pgBackRest 备份系统的状态。</p><p>此参数组定义了三个 Exporter 的配置：<code>pg_exporter</code> 用于监控 PostgreSQL，<code>pgbouncer_exporter</code> 用于监控连接池，<code>pgbackrest_exporter</code> 用于监控备份状态。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 在 pgsql 主机上启用 pg_exporter 吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_exporter.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg_exporter 配置文件名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_cache_ttls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;1,10,60,300&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># pg_exporter 收集器 ttl 阶段（秒），默认为 &#39;1,10,60,300&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># pg_exporter 监听端口，默认为 9630</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_params</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslmode=disable&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># pg_exporter dsn 的额外 url 参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 如果指定，将覆盖自动生成的 pg dsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 启用自动数据库发现？默认启用</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_exclude_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;template0,template1,postgres&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 在自动发现过程中不会被监控的数据库的 csv 列表</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 在自动发现过程中将被监控的数据库的 csv 列表</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_connect_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># pg_exporter 连接超时（毫秒），默认为 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 覆盖 pg_exporter 的额外选项</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 在 pgsql 主机上启用 pgbouncer_exporter 吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9631</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># pgbouncer_exporter 监听端口，默认为 9631</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 如果指定，将覆盖自动生成的 pgbouncer dsn</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 覆盖 pgbouncer_exporter 的额外选项</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_exporter_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 在 pgsql 主机上启用 pgbackrest_exporter 吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9854</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># pgbackrest_exporter 监听端口，默认为 9854</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_exporter_options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># 覆盖 pgbackrest_exporter 的额外选项</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_exporter_enabled><code>pg_exporter_enabled</code></h3><p>参数名称： <code>pg_exporter_enabled</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>是否在 PGSQL 节点上启用 pg_exporter？默认值为：<code>true</code>。</p><p>PG Exporter 用于监控 PostgreSQL 数据库实例，如果不想安装 pg_exporter 可以设置为 <code>false</code>。</p><h3 id=pg_exporter_config><code>pg_exporter_config</code></h3><p>参数名称： <code>pg_exporter_config</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>pg_exporter 配置文件名，PG Exporter 和 PGBouncer Exporter 都会使用这个配置文件。默认值：<code>pg_exporter.yml</code>。</p><p>如果你想使用自定义配置文件，你可以在这里定义它。你的自定义配置文件应当放置于 <code>files/&lt;name>.yml</code>。</p><p>例如，当您希望监控一个远程的 PolarDB 数据库实例时，可以使用样例配置：<code>files/polar_exporter.yml</code>。</p><h3 id=pg_exporter_cache_ttls><code>pg_exporter_cache_ttls</code></h3><p>参数名称： <code>pg_exporter_cache_ttls</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>pg_exporter 收集器 TTL 阶梯（秒），默认为 &lsquo;1,10,60,300&rsquo;</p><p>默认值：<code>1,10,60,300</code>，它将为不同的度量收集器使用不同的TTL值： 1s, 10s, 60s, 300s。</p><p>PG Exporter 内置了缓存机制，避免多个 Prometheus 重复抓取对数据库产生不当影响，所有指标收集器按 TTL 分为四类：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>ttl_fast</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ pg_exporter_cache_ttls.split(&#39;,&#39;)[0]|int }}&#34;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># critical queries</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ttl_norm</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ pg_exporter_cache_ttls.split(&#39;,&#39;)[1]|int }}&#34;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># common queries</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ttl_slow</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ pg_exporter_cache_ttls.split(&#39;,&#39;)[2]|int }}&#34;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># slow queries (e.g table size)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ttl_slowest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;{{ pg_exporter_cache_ttls.split(&#39;,&#39;)[3]|int }}&#34;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># ver slow queries (e.g bloat)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>例如，在默认配置下，存活类指标默认最多缓存 <code>1s</code>，大部分普通指标会缓存 <code>10s</code>（应当与监控抓取间隔 <a href=/docs/infra/param#vmetrics_scrape_interval><code>vmetrics_scrape_interval</code></a> 相同）。
少量变化缓慢的查询会有 <code>60s</code> 的TTL，极个别大开销监控查询会有 <code>300s</code> 的TTL。</p><h3 id=pg_exporter_port><code>pg_exporter_port</code></h3><p>参数名称： <code>pg_exporter_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p><p>pg_exporter 监听端口号，默认值为：<code>9630</code></p><h3 id=pg_exporter_params><code>pg_exporter_params</code></h3><p>参数名称： <code>pg_exporter_params</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>pg_exporter 所使用 DSN 中额外的 URL PATH 参数。</p><p>默认值：<code>sslmode=disable</code>，它将禁用用于监控连接的 SSL（因为默认使用本地 unix 套接字）。</p><h3 id=pg_exporter_url><code>pg_exporter_url</code></h3><p>参数名称： <code>pg_exporter_url</code>， 类型： <code>pgurl</code>， 层次：<code>C</code></p><p>如果指定了本参数，将会覆盖自动生成的 PostgreSQL DSN，使用指定的 DSN 连接 PostgreSQL 。默认值为空字符串。</p><p>如果没有指定此参数，PG Exporter 默认会使用以下的连接串访问 PostgreSQL ：</p><pre tabindex=0><code>postgres://{{ pg_monitor_username }}:{{ pg_monitor_password }}@{{ pg_host }}:{{ pg_port }}/postgres{% if pg_exporter_params != &#39;&#39; %}?{{ pg_exporter_params }}{% endif %}
</code></pre><p>当您想监控一个远程的 PostgreSQL 实例时，或者需要使用不同的监控用户/密码，配置选项时，可以使用这个参数。</p><h3 id=pg_exporter_auto_discovery><code>pg_exporter_auto_discovery</code></h3><p>参数名称： <code>pg_exporter_auto_discovery</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>启用自动数据库发现吗？ 默认启用：<code>true</code>。</p><p>PG Exporter 默认会连接到 DSN 中指定的数据库 （默认为管理数据库 <code>postgres</code>） 收集全局指标，如果您希望收集所有业务数据库的指标，可以开启此选项。
PG Exporter 会自动发现目标 PostgreSQL 实例中的所有数据库，并在这些数据库中收集 <strong>库级监控指标</strong>。</p><h3 id=pg_exporter_exclude_database><code>pg_exporter_exclude_database</code></h3><p>参数名称： <code>pg_exporter_exclude_database</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>如果启用了数据库自动发现（默认启用），在这个参数指定的列表中的数据库将不会被监控。
默认值为： <code>template0,template1,postgres</code>，即管理数据库 <code>postgres</code> 与模板数据库会被排除在自动监控的数据库之外。</p><p>作为例外，DSN 中指定的数据库不受此参数影响，例如，PG Exporter 如果连接的是 <code>postgres</code> 数据库，那么即使 <code>postgres</code> 在此列表中，也会被监控。</p><h3 id=pg_exporter_include_database><code>pg_exporter_include_database</code></h3><p>参数名称： <code>pg_exporter_include_database</code>， 类型： <code>string</code>， 层次：<code>C</code></p><p>如果启用了数据库自动发现（默认启用），在这个参数指定的列表中的数据库才会被监控。默认值为空字符串，即不启用此功能。</p><p>参数的形式是由逗号分隔的数据库名称列表，例如：<code>db1,db2,db3</code>。</p><p>此参数相对于 [<code>pg_exporter_exclude_database</code>] 有更高的优先级，相当于白名单模式。如果您只希望监控特定的数据库，可以使用此参数。</p><h3 id=pg_exporter_connect_timeout><code>pg_exporter_connect_timeout</code></h3><p>参数名称： <code>pg_exporter_connect_timeout</code>， 类型： <code>int</code>， 层次：<code>C</code></p><p>pg_exporter 连接超时（毫秒），默认为 <code>200</code> （单位毫秒）</p><p>当 PG Exporter 尝试连接到 PostgreSQL 数据库时，最多会等待多长时间？超过这个时间，PG Exporter 将会放弃连接并报错。</p><p>默认值 200毫秒 对于绝大多数场景（例如：同可用区监控）都是足够的，但是如果您监控的远程 PostgreSQL 位于另一个大洲，您可能需要增加此值以避免连接超时。</p><h3 id=pg_exporter_options><code>pg_exporter_options</code></h3><p>参数名称： <code>pg_exporter_options</code>， 类型： <code>arg</code>， 层次：<code>C</code></p><p>传给 PG Exporter 的命令行参数，默认值为：<code>""</code> 空字符串。</p><p>当使用空字符串时，会使用默认的命令参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% <span style=color:#204a87;font-weight:700>if</span> pg_exporter_port !<span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span> %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--web.listen-address=:{{ pg_exporter_port }} {{ pg_exporter_options }}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% <span style=color:#204a87;font-weight:700>else</span> %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--web.listen-address=:{{ pg_exporter_port }} --log.level=info&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% endif %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>注意，请不要在本参数中覆盖 <a href=#pg_exporter_port><code>pg_exporter_port</code></a> 的端口配置。</p><h3 id=pgbouncer_exporter_enabled><code>pgbouncer_exporter_enabled</code></h3><p>参数名称： <code>pgbouncer_exporter_enabled</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>在 PGSQL 节点上，是否启用 pgbouncer_exporter ？默认值为：<code>true</code>。</p><h3 id=pgbouncer_exporter_port><code>pgbouncer_exporter_port</code></h3><p>参数名称： <code>pgbouncer_exporter_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p><p>pgbouncer_exporter 监听端口号，默认值为：<code>9631</code></p><h3 id=pgbouncer_exporter_url><code>pgbouncer_exporter_url</code></h3><p>参数名称： <code>pgbouncer_exporter_url</code>， 类型： <code>pgurl</code>， 层次：<code>C</code></p><p>如果指定了本参数，将会覆盖自动生成的 pgbouncer DSN，使用指定的 DSN 连接 pgbouncer。默认值为空字符串。</p><p>如果没有指定此参数，Pgbouncer Exporter 默认会使用以下的连接串访问 Pgbouncer：</p><pre tabindex=0><code>postgres://{{ pg_monitor_username }}:{{ pg_monitor_password }}@:{{ pgbouncer_port }}/pgbouncer?host={{ pg_localhost }}&amp;sslmode=disable
</code></pre><p>当您想监控一个远程的 Pgbouncer 实例时，或者需要使用不同的监控用户/密码，配置选项时，可以使用这个参数。</p><h3 id=pgbouncer_exporter_options><code>pgbouncer_exporter_options</code></h3><p>参数名称： <code>pgbouncer_exporter_options</code>， 类型： <code>arg</code>， 层次：<code>C</code></p><p>传给 Pgbouncer Exporter 的命令行参数，默认值为：<code>""</code> 空字符串。</p><p>当使用空字符串时，会使用默认的命令参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% <span style=color:#204a87;font-weight:700>if</span> pgbouncer_exporter_options !<span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;&#39;</span> %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--web.listen-address=:{{ pgbouncer_exporter_port }} {{ pgbouncer_exporter_options }}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% <span style=color:#204a87;font-weight:700>else</span> %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_EXPORTER_OPTS</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;--web.listen-address=:{{ pgbouncer_exporter_port }} --log.level=info&#39;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>% endif %<span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>注意，请不要在本参数中覆盖 <a href=#pgbouncer_exporter_port><code>pgbouncer_exporter_port</code></a> 的端口配置。</p><h3 id=pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></h3><p>参数名称： <code>pgbackrest_exporter_enabled</code>， 类型： <code>bool</code>， 层次：<code>C</code></p><p>是否在 PGSQL 节点上启用 pgbackrest_exporter？默认值为：<code>true</code>。</p><p>pgbackrest_exporter 用于监控 pgBackRest 备份系统的状态，包括备份的大小、时间、类型、持续时长等关键指标。</p><h3 id=pgbackrest_exporter_port><code>pgbackrest_exporter_port</code></h3><p>参数名称： <code>pgbackrest_exporter_port</code>， 类型： <code>port</code>， 层次：<code>C</code></p><p>pgbackrest_exporter 监听端口号，默认值为：<code>9854</code>。</p><p>此端口需要在 Prometheus 服务发现配置中引用，用于抓取备份相关的监控指标。</p><h3 id=pgbackrest_exporter_options><code>pgbackrest_exporter_options</code></h3><p>参数名称： <code>pgbackrest_exporter_options</code>， 类型： <code>arg</code>， 层次：<code>C</code></p><p>传给 pgbackrest_exporter 的命令行参数，默认值为：<code>""</code> 空字符串。</p><p>当使用空字符串时，会使用默认的命令参数配置。您可以在此指定额外的参数选项来调整 exporter 的行为。</p><hr><h2 id=pg_remove><code>PG_REMOVE</code></h2><p><a href=/docs/pgsql/playbook#pgsql-rmyml><code>pgsql-rm.yml</code></a> 会调用 <code>pg_remove</code> 角色来安全地移除 PostgreSQL 实例。本节参数用于控制清理行为，避免误删。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rm_data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># remove postgres data during remove? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rm_backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># remove pgbackrest backup during primary remove? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_rm_pkg</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># uninstall postgres packages during remove? true by default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_safeguard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># stop pg_remove running if pg_safeguard is enabled, false by default</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_rm_data><code>pg_rm_data</code></h3><p>参数名称： <code>pg_rm_data</code>， 类型： <code>bool</code>， 层次：<code>G/C/A</code></p><p>删除 PGSQL 实例时是否清理 <a href=#pg_data><code>pg_data</code></a> 以及软链，默认值 <code>true</code>。</p><p>该开关既影响 <code>pgsql-rm.yml</code>，也影响其他触发 <code>pg_remove</code> 的场景。设为 <code>false</code> 可以保留数据目录，便于手动检查或重新挂载。</p><h3 id=pg_rm_backup><code>pg_rm_backup</code></h3><p>参数名称： <code>pg_rm_backup</code>， 类型： <code>bool</code>， 层次：<code>G/C/A</code></p><p>删除主库时是否一并清理 pgBackRest 仓库与配置，默认值 <code>true</code>。</p><p>该参数仅对 <code>pg_role=primary</code> 的主实例生效：<code>pg_remove</code> 会先停止 pgBackRest、删除当前集群的 stanza，并在 <code>pgbackrest_method == 'local'</code> 时移除 <a href=#pg_fs_backup><code>pg_fs_backup</code></a> 中的数据。备用集群或上游备份不会受到影响。</p><h3 id=pg_rm_pkg><code>pg_rm_pkg</code></h3><p>参数名称： <code>pg_rm_pkg</code>， 类型： <code>bool</code>， 层次：<code>G/C/A</code></p><p>在清理 PGSQL 实例时是否卸载 <a href=#pg_packages><code>pg_packages</code></a> 安装的所有软件包，默认值 <code>true</code>。</p><p>如果只想暂时停机并保留二进制文件，可将其设为 <code>false</code>，否则 <code>pg_remove</code> 会调用系统包管理器彻底卸载 PostgreSQL 相关组件。</p><h3 id=pg_safeguard><code>pg_safeguard</code></h3><p>参数名称： <code>pg_safeguard</code>， 类型： <code>bool</code>， 层次：<code>G/C/A</code></p><p>防误删保险，默认值为 <code>false</code>。当显式设置为 <code>true</code> 时，<code>pg_remove</code> 会立即终止并提示，必须使用 <code>-e pg_safeguard=false</code> 或在变量中关闭后才会继续。</p><p>建议在生产环境批量清理前先开启此开关，确认命令与目标节点无误后再解除，以避免误操作导致实例被删除。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-091b9f18681382583303e1ac5c7cea55>15 - 预置剧本</h1><div class=lead>如何使用 ansible 剧本来管理 PostgreSQL 集群</div><blockquote><p>Pigsty提供了一系列剧本，用于集群上下线扩缩容，用户/数据库管理，监控、备份恢复或迁移已有实例。</p></blockquote><table><thead><tr><th>剧本</th><th>功能</th></tr></thead><tbody><tr><td><a href=#pgsqlyml><code>pgsql.yml</code></a></td><td>初始化 PostgreSQL 集群或添加新的从库</td></tr><tr><td><a href=#pgsql-rmyml><code>pgsql-rm.yml</code></a></td><td>移除 PostgreSQL 集群，或移除某个实例</td></tr><tr><td><a href=#pgsql-useryml><code>pgsql-user.yml</code></a></td><td>在现有的 PostgreSQL 集群中添加新的业务用户</td></tr><tr><td><a href=#pgsql-dbyml><code>pgsql-db.yml</code></a></td><td>在现有的 PostgreSQL 集群中添加新的业务数据库</td></tr><tr><td><a href=#pgsql-monitoryml><code>pgsql-monitor.yml</code></a></td><td>将远程 PostgreSQL 实例纳入监控中</td></tr><tr><td><a href=#pgsql-migrationyml><code>pgsql-migration.yml</code></a></td><td>为现有的 PostgreSQL 集群生成迁移手册和脚本</td></tr><tr><td><a href=#pgsql-pitryml><code>pgsql-pitr.yml</code></a></td><td>执行 PostgreSQL 时间点恢复 (PITR)</td></tr></tbody></table><hr><h2 id=保护机制>保护机制</h2><p>使用 <a href=/docs/pgsql><code>PGSQL</code></a> 剧本时需要<strong>特别注意</strong>，剧本 <a href=#pgsqlyml><code>pgsql.yml</code></a> 与 <a href=#pgsql-rmyml><code>pgsql-rm.yml</code></a> 使用不当会有误删数据库的风险！</p><ul><li>在执行时添加 <code>-l</code> 参数，限制命令执行的对象范围，并确保自己在正确的目标上执行正确的任务。</li><li>限制范围通常以一个数据库集群为宜，使用不带参数的 <code>pgsql.yml</code> 在生产环境中是一个高危操作，务必三思而后行。</li></ul><p>出于防止误删的目的，Pigsty 的 PGSQL 模块提供了防误删保险，由 <a href=/docs/pgsql/param#pg_safeguard><code>pg_safeguard</code></a> 参数控制。
当 <code>pg_safeguard</code> 设置为 <code>true</code> 时，<a href=#pgsql-rmyml><code>pgsql-rm.yml</code></a> 剧本会立即中止执行，防止误删数据库集群。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 将会中止执行，保护数据安全</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过命令行参数强制覆盖保护开关</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span></code></pre></div><p>除了 <code>pg_safeguard</code> 外，<a href=#pgsql-rmyml><code>pgsql-rm.yml</code></a> 还提供了更细粒度的控制参数：</p><table><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/param#pg_safeguard><code>pg_safeguard</code></a></td><td><code>false</code></td><td>防误删保险，设为 <code>true</code> 时剧本会中止执行</td></tr><tr><td><code>pg_rm_data</code></td><td><code>true</code></td><td>是否移除 PostgreSQL 数据目录</td></tr><tr><td><code>pg_rm_backup</code></td><td><code>true</code></td><td>是否移除 pgBackRest 备份数据（仅主库移除时生效）</td></tr><tr><td><code>pg_rm_pkg</code></td><td><code>true</code></td><td>是否卸载 PostgreSQL 软件包</td></tr></tbody></table><p>这些参数允许你根据实际需求精确控制移除行为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 移除集群但保留数据目录（仅停止服务）</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test -e <span style=color:#000>pg_rm_data</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 移除集群但保留备份数据</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 移除集群并卸载软件包</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-test -e <span style=color:#000>pg_rm_pkg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><hr><h2 id=pgsqlyml><code>pgsql.yml</code></h2><p>剧本 <a href=https://github.com/pgsty/pigsty/blob/main/pgsql.yml><code>pgsql.yml</code></a> 用于初始化 PostgreSQL 集群或添加新的从库。</p><p>下面是使用此剧本初始化沙箱环境中 PostgreSQL 集群的过程：</p><p><a href=https://asciinema.org/a/566417><img src=https://asciinema.org/a/566417.svg alt=asciicast></a></p><p><strong>基本用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta            <span style=color:#8f5902;font-style:italic># 初始化集群 pg-meta</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.13        <span style=color:#8f5902;font-style:italic># 初始化/添加实例 10.10.10.13</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-test -t pg_service  <span style=color:#8f5902;font-style:italic># 刷新集群 pg-test 的服务</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-test -t pg_hba,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>  <span style=color:#8f5902;font-style:italic># 重载HBA规则</span>
</span></span></code></pre></div><p><strong>包装脚本</strong></p><p>Pigsty 提供了便捷的包装脚本简化常见操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-meta             <span style=color:#8f5902;font-style:italic># 初始化 pgsql 集群 pg-meta</span>
</span></span><span style=display:flex><span>bin/pgsql-add 10.10.10.10         <span style=color:#8f5902;font-style:italic># 初始化 pgsql 实例 10.10.10.10</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-test 10.10.10.13 <span style=color:#8f5902;font-style:italic># 添加 10.10.10.13 到集群 pg-test（自动刷新服务）</span>
</span></span><span style=display:flex><span>bin/pgsql-svc pg-test             <span style=color:#8f5902;font-style:italic># 刷新 pg-test 的 haproxy 服务（成员变更时使用）</span>
</span></span><span style=display:flex><span>bin/pgsql-hba pg-test             <span style=color:#8f5902;font-style:italic># 重载 pg-test 的 pg/pgb HBA 规则</span>
</span></span></code></pre></div><p><strong>任务列表</strong></p><p>本剧本包含以下子任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_install              : 安装 postgres 软件包与扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_dbsu             : 设置 postgres 超级用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_dbsu_create    : 创建 dbsu 用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_dbsu_sudo      : 配置 dbsu sudo 权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_ssh            : 交换 dbsu SSH 密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_pkg              : 安装 postgres 软件包</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_pre            : 安装前置任务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_ext            : 安装 postgres 扩展包</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_post           : 安装后置任务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_link             : 将 pgsql 版本 bin 链接到 /usr/pgsql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_path             : 将 pgsql bin 添加到系统路径</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_dir              : 创建 postgres 目录并设置 FHS</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_bin              : 同步 /pg/bin 脚本</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_alias            : 配置 pgsql/psql 别名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_dummy            : 创建 dummy 占位文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_bootstrap            : 引导 postgres 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_config           : 生成 postgres 配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_conf           : 生成 patroni 配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_key            : 生成 pgsodium 密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_cert             : 为 postgres 签发证书</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_cert_private   : 检查 pg 私钥是否存在</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_cert_issue     : 签发 pg 服务端证书</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_cert_copy      : 复制密钥与证书到 pg 节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_launch           : 启动 patroni 主库与从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_watchdog       : 授予 postgres watchdog 权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_primary        : 启动 patroni/postgres 主库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_init           : 使用角色/模板初始化 pg 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_pass           : 将 .pgpass 文件写入 pg 主目录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_replica        : 启动 patroni/postgres 从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_hba            : 生成 pg HBA 规则</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - patroni_reload    : 重新加载 patroni 配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_patroni        : 必要时暂停或移除 patroni</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_provision            : 创建 postgres 业务用户与数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_user             : 创建 postgres 业务用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_user_config    : 渲染创建用户的 sql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_user_create    : 在 postgres 上创建用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_db               : 创建 postgres 业务数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_db_drop        : 删除数据库（state=absent/recreate时）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_db_config      : 渲染创建数据库的 sql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_db_create      : 在 postgres 上创建数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_backup               : 初始化 postgres PITR 备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbackrest          : 配置 pgbackrest 备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbackrest_config : 生成 pgbackrest 配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbackrest_init   : 初始化 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbackrest_backup : 引导后进行初始备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_crontab              : 配置 postgres dbsu 定时任务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_access               : 初始化 postgres 服务访问层</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbouncer           : 部署 pgbouncer 连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbouncer_dir     : 创建 pgbouncer 目录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbouncer_config  : 生成 pgbouncer 配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#       - pgbouncer_hba   : 生成 pgbouncer hba 配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#       - pgbouncer_user  : 生成 pgbouncer 用户列表</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbouncer_launch  : 启动 pgbouncer 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pgbouncer_reload  : 重载 pgbouncer 配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_vip              : 使用 vip-manager 绑定 VIP 到主库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_vip_config     : 生成 vip-manager 配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_vip_launch     : 启动 vip-manager 绑定 vip</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_dns              : 将 DNS 名称注册到基础设施 dnsmasq</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_dns_ins        : 注册 pg 实例名称</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_dns_cls        : 注册 pg 集群名称</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_service          : 使用 haproxy 暴露 pgsql 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_service_config : 为 pg 服务生成本地 haproxy 配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - pg_service_reload : 使用 haproxy 暴露 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_monitor              : 设置 pgsql 监控并注册到基础设施</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_exporter         : 配置并启动 pg_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbouncer_exporter  : 配置并启动 pgbouncer_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbackrest_exporter : 配置并启动 pgbackrest_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_register         : 将 pgsql 注册到监控/日志/数据源</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - add_metrics       : 将 pg 注册为 victoria 监控目标</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - add_logs          : 将 pg 注册为 vector 日志来源</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - add_ds            : 将 pg 数据库注册为 grafana 数据源</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>以下管理任务使用到了此剧本</strong></p><ul><li><a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4>创建集群</a></li><li><a href=/docs/pgsql/admin/cluster#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4>添加实例</a></li><li><a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a></li><li><a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0hba>重载HBA</a></li></ul><p><strong>注意事项</strong></p><ul><li>单独针对某一集群从库执行此剧本时，用户应当确保 <strong>集群主库已经完成初始化！</strong></li><li>扩容完成后，您需要 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a> 与 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0hba>重载HBA</a>，包装脚本 <code>bin/pgsql-add</code> 会自动完成这些任务。</li></ul><p>集群扩容时，如果 Patroni 拉起从库的时间过长，Ansible 剧本可能会因为超时而中止：</p><ul><li>典型错误信息为：<code>wait for postgres/patroni replica</code> 任务执行很长时间后中止</li><li>但制作从库的进程会继续，例如制作从库需超过1天的场景，后续处理请参考 <a href=/docs/pgsql/faq>FAQ</a>：制作从库失败。</li></ul><hr><h2 id=pgsql-rmyml><code>pgsql-rm.yml</code></h2><p>剧本 <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-rm.yml><code>pgsql-rm.yml</code></a> 用于移除 PostgreSQL 集群，或移除某个实例。</p><p>下面是使用此剧本移除沙箱环境中 PostgreSQL 集群的过程：</p><p><a href=https://asciinema.org/a/566418><img src=https://asciinema.org/a/566418.svg alt=asciicast></a></p><p><strong>基本用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l pg-test          <span style=color:#8f5902;font-style:italic># 移除集群 pg-test</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l 10.10.10.13      <span style=color:#8f5902;font-style:italic># 移除实例 10.10.10.13</span>
</span></span></code></pre></div><p><strong>命令行参数</strong></p><p>本剧本可以使用以下命令行参数控制其行为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l pg-test          <span style=color:#8f5902;font-style:italic># 移除集群 pg-test</span>
</span></span><span style=display:flex><span>    -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>          <span style=color:#8f5902;font-style:italic># 防误删保险，默认关闭，开启时需强制覆盖</span>
</span></span><span style=display:flex><span>    -e <span style=color:#000>pg_rm_data</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>             <span style=color:#8f5902;font-style:italic># 是否一并移除 PostgreSQL 数据目录，默认移除</span>
</span></span><span style=display:flex><span>    -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>           <span style=color:#8f5902;font-style:italic># 是否一并移除 pgBackRest 备份（仅主库），默认移除</span>
</span></span><span style=display:flex><span>    -e <span style=color:#000>pg_rm_pkg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>              <span style=color:#8f5902;font-style:italic># 是否卸载 PostgreSQL 软件包，默认卸载</span>
</span></span></code></pre></div><p><strong>包装脚本</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-meta               <span style=color:#8f5902;font-style:italic># 移除 pgsql 集群 pg-meta</span>
</span></span><span style=display:flex><span>bin/pgsql-rm pg-test 10.10.10.13   <span style=color:#8f5902;font-style:italic># 从集群 pg-test 移除实例 10.10.10.13</span>
</span></span></code></pre></div><p><strong>任务列表</strong></p><p>本剧本包含以下子任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_safeguard           : 如果 pg_safeguard 启用则中止执行</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_monitor             : 从监控系统移除注册</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_deregister      : 从基础设施移除 pg 监控目标</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - rm_metrics       : 从 prometheus 移除监控目标</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - rm_ds            : 从 grafana 移除数据源</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - rm_logs          : 从 vector 移除日志目标</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_exporter        : 移除 pg_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbouncer_exporter : 移除 pgbouncer_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbackrest_exporter: 移除 pgbackrest_exporter</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_access              : 移除 pg 服务访问层</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - dns                : 移除 pg DNS 记录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - vip                : 移除 vip-manager</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_service         : 从 haproxy 移除 pg 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pgbouncer          : 移除 pgbouncer 连接中间件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_crontab             : 移除 postgres dbsu 定时任务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># postgres               : 移除 postgres 实例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_replica         : 移除所有从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_primary         : 移除主库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_meta            : 从 etcd 移除元数据</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_backup              : 移除备份仓库（使用 pg_rm_backup=false 禁用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_data                : 移除 postgres 数据（使用 pg_rm_data=false 禁用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_pkg                 : 卸载 pg 软件包（使用 pg_rm_pkg=true 启用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pg_ext             : 单独卸载 postgres 扩展</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>以下管理任务使用到了此剧本</strong></p><ul><li><a href=/docs/pgsql/admin/cluster#%E7%BC%A9%E5%AE%B9%E9%9B%86%E7%BE%A4>移除实例</a></li><li><a href=/docs/pgsql/admin/cluster#%E9%94%80%E6%AF%81%E9%9B%86%E7%BE%A4>下线集群</a></li></ul><p><strong>注意事项</strong></p><ul><li><strong>请不要直接对还有从库的集群主库单独执行此剧本</strong>，否则抹除主库后，其余从库会自动触发高可用自动故障切换。总是先下线所有从库后，再下线主库，当一次性下线整个集群时不需要操心此问题。</li><li><strong>实例下线后请刷新集群服务</strong>，当您从集群中下线掉某一个从库实例时，它仍然存留于在负载均衡器的配置文件中。因为健康检查无法通过，所以下线后的实例不会对集群产生影响。但您应当在恰当的时间点 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a>，确保生产环境与配置清单的一致性。</li></ul><hr><h2 id=pgsql-useryml><code>pgsql-user.yml</code></h2><p>剧本 <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-user.yml><code>pgsql-user.yml</code></a> 用于在现有的 PostgreSQL 集群中添加新的业务用户。</p><p><strong>基本用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l pg-meta -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_meta
</span></span></code></pre></div><p><strong>包装脚本</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_meta  <span style=color:#8f5902;font-style:italic># 在集群 pg-meta 上创建用户 dbuser_meta</span>
</span></span></code></pre></div><p><strong>工作流程</strong></p><ol><li>在配置清单中定义用户: <code>all.children.&lt;pg_cluster>.vars.pg_users[i]</code></li><li>执行剧本时指定集群和用户名: <code>pgsql-user.yml -l &lt;pg_cluster> -e username=&lt;name></code></li></ol><p>剧本会：</p><ol><li>在 <code>/pg/tmp/pg-user-{{ user.name }}.sql</code> 生成用户创建 SQL</li><li>在集群主库上执行用户创建/更新 SQL</li><li>若启用 <code>pgbouncer_enabled: true</code>，更新 <code>/etc/pgbouncer/userlist.txt</code> 与 <code>useropts.txt</code></li><li>重载 pgbouncer 使配置生效</li></ol><p><strong>用户定义示例</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必填，用户名是唯一必须的字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，密码可以是 scram-sha-256 哈希或明文</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，是否可登录，默认 true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，是否超级用户，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否可创建数据库，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，是否可创建角色，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，是否继承权限，默认 true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，是否可复制，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，是否绕过 RLS，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否添加到 pgbouncer 用户列表，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，连接数限制，-1 表示无限制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，N 天后过期（覆盖 expire_at）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 可选，指定过期日期</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户注释</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，所属角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># 可选，角色级参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，pgbouncer 用户级连接池模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，用户级最大连接数（映射为 max_user_connections）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>详情请参考：<a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7>管理SOP：创建用户</a></p><hr><h2 id=pgsql-dbyml><code>pgsql-db.yml</code></h2><p>剧本 <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-db.yml><code>pgsql-db.yml</code></a> 用于在现有的 PostgreSQL 集群中添加新的业务数据库。</p><p><strong>基本用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l pg-meta -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>meta
</span></span></code></pre></div><p><strong>包装脚本</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta meta  <span style=color:#8f5902;font-style:italic># 在集群 pg-meta 上创建数据库 meta</span>
</span></span></code></pre></div><p><strong>工作流程</strong></p><ol><li>在配置清单中定义数据库: <code>all.children.&lt;pg_cluster>.vars.pg_databases[i]</code></li><li>执行剧本时指定集群和数据库名: <code>pgsql-db.yml -l &lt;pg_cluster> -e dbname=&lt;name></code></li></ol><p>剧本会：</p><ol><li>在 <code>/pg/tmp/pg-db-{{ database.name }}.sql</code> 生成数据库创建 SQL</li><li>在集群主库上执行数据库创建/更新 SQL</li><li>如果 <code>db.register_datasource</code> 为 true，将数据库注册为 grafana 数据源</li><li>更新 <code>/etc/pgbouncer/database.txt</code> 并重载 pgbouncer</li></ol><p><strong>数据库定义示例</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必填，数据库名是唯一必须的字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库初始化 SQL 文件路径</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否添加到 pgbouncer，默认 true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，额外创建的 schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，要安装的扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库注释</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库所有者</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，模板数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，字符编码</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，区域设置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认表空间</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否允许连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，是否回收 public 连接权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 可选，是否注册到 grafana 数据源</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，连接数限制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，认证查询使用的用户（配合 pgbouncer_auth_query）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，pgbouncer 连接池模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，pgbouncer 默认池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，pgbouncer 保留池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，pgbouncer 最小池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 可选，pgbouncer 最大数据库连接数</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>详情请参考：<a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93>管理SOP：创建数据库</a></p><hr><h2 id=pgsql-monitoryml><code>pgsql-monitor.yml</code></h2><p>剧本 <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-monitor.yml><code>pgsql-monitor.yml</code></a> 用于将远程 PostgreSQL 实例纳入 Pigsty 监控体系。</p><p><strong>基本用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-monitor.yml -e <span style=color:#000>clsname</span><span style=color:#ce5c00;font-weight:700>=</span>pg-foo  <span style=color:#8f5902;font-style:italic># 监控远程集群 pg-foo</span>
</span></span></code></pre></div><p><strong>包装脚本</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-add pg-foo              <span style=color:#8f5902;font-style:italic># 监控一个远程 pgsql 集群 pg-foo</span>
</span></span><span style=display:flex><span>bin/pgmon-add pg-foo pg-bar       <span style=color:#8f5902;font-style:italic># 同时监控多个集群</span>
</span></span></code></pre></div><p><strong>配置方式</strong></p><p>首先需要在 <code>infra</code> 组变量中定义 <code>pg_exporters</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_exporters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 列出所有远程实例，分配唯一的未使用本地端口</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>20001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 1, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>20002</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-foo, pg_seq: 2, pg_host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>架构示意</strong></p><pre tabindex=0><code>     ------ infra ------
     |                 |
     |   prometheus    |            v---- pg-foo-1 ----v
     |       ^         |  metrics   |         ^        |
     |   pg_exporter &lt;-|------------|----  postgres    |
     |   (port: 20001) |            | 10.10.10.10:5432 |
     |       ^         |            ^------------------^
     |       ^         |                      ^
     |       ^         |            v---- pg-foo-2 ----v
     |       ^         |  metrics   |         ^        |
     |   pg_exporter &lt;-|------------|----  postgres    |
     |   (port: 20002) |            | 10.10.10.11:5433 |
     -------------------            ^------------------^
</code></pre><p><strong>可配置参数</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_exporter.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg_exporter 配置文件名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_cache_ttls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;1,10,60,300&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># pg_exporter 采集器 TTL 阶段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9630</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># pg_exporter 监听端口</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_params</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslmode=disable&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># DSN 额外 URL 参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 直接覆盖自动生成的 DSN</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_auto_discovery</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 是否启用自动数据库发现</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_exclude_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;template0,template1,postgres&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 排除的数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_include_database</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 仅包含的数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_exporter_connect_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 连接超时（毫秒）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 监控用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 监控密码</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>远程数据库配置</strong></p><p>远程 PostgreSQL 实例需要创建监控用户：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;system monitor user&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8> </span><span style=color:#000>PASSWORD</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;DBUser.Monitor&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_monitor</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg_stat_statements&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;monitor&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>限制</strong></p><ul><li>仅 postgres 指标可用</li><li>node、pgbouncer、patroni、haproxy 指标不可用</li></ul><p>详情请参考：<a href=/docs/pgsql/monitor#%E7%9B%91%E6%8E%A7rds>管理SOP：监控现有PG</a></p><hr><h2 id=pgsql-migrationyml><code>pgsql-migration.yml</code></h2><p>剧本 <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-migration.yml><code>pgsql-migration.yml</code></a> 用于为现有的 PostgreSQL 集群生成基于逻辑复制的零停机迁移手册和脚本。</p><p><strong>基本用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-migration.yml -e@files/migration/pg-meta.yml
</span></span></code></pre></div><p><strong>工作流程</strong></p><ol><li>定义迁移任务配置文件（如 <code>files/migration/pg-meta.yml</code>）</li><li>执行剧本生成迁移手册与脚本</li><li>按照手册逐步执行脚本完成迁移</li></ol><p><strong>迁移任务定义示例</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># files/migration/pg-meta.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>context_dir</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~/migration          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 迁移手册与脚本输出目录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_cls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 源集群名称（必填）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 源数据库名称（必填）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>src_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.10</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 源集群主库 IP（必填）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_cls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 目标集群名称（必填）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 目标数据库名称（必填）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>dst_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 目标集群主库 IP（必填）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 可选参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>详情请参考：<a href=/docs/pgsql/migration/>管理SOP：迁移数据库集群</a></p><hr><h2 id=pgsql-pitryml><code>pgsql-pitr.yml</code></h2><p>剧本 <a href=https://github.com/pgsty/pigsty/blob/main/pgsql-pitr.yml><code>pgsql-pitr.yml</code></a> 用于执行 PostgreSQL 时间点恢复 (Point-In-Time Recovery)。</p><p><strong>基本用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到最新状态（WAL 归档流末端）</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定时间点</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;time&#34;: &#34;2025-07-13 10:00:00+00&#34;}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定 LSN</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;lsn&#34;: &#34;0/4001C80&#34;}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定事务 ID</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;xid&#34;: &#34;250000&#34;}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到命名还原点</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;name&#34;: &#34;some_restore_point&#34;}}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从其他集群备份恢复</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;cluster&#34;: &#34;pg-meta&#34;}}&#39;</span>
</span></span></code></pre></div><p><strong>PITR 任务参数</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># 定义 PITR 任务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg-meta&#34;</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 源集群名称（恢复其他集群的备份时使用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>type: latest                     # 恢复目标类型</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time, xid, name, lsn, immediate, latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-01 10:00:00+00&#34;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 恢复目标：时间点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 恢复目标：命名还原点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;100000&#34;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 恢复目标：事务 ID</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;0/3000000&#34;</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 恢复目标：日志序列号</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latest                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 从哪个备份集恢复，默认 latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>timeline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latest                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 目标时间线，可以是整数，默认 latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>exclusive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 是否排除目标点，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>action: pause                    # 恢复后动作</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pause, promote, shutdown</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>archive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 是否保留归档设置，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 恢复前是否备份现有数据到 /pg/data-backup？默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db_include</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 仅包含这些数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db_exclude</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 排除这些数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>link_map</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 表空间链接映射</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>process</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># 并行恢复进程数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># 恢复源仓库配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/data                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 恢复数据目录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># 恢复实例监听端口</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>任务列表</strong></p><p>本剧本包含以下子任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># down                 : 停止 HA 并关闭 patroni 和 postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pause            : 暂停 patroni 自动故障转移</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - stop             : 停止 patroni 和 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_patroni   : 停止 patroni 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_postgres  : 停止 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pitr                 : 执行 PITR 恢复过程</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - config           : 生成 pgbackrest 配置和恢复脚本</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - backup           : 执行可选的原始数据备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - restore          : 运行 pgbackrest restore 命令</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - recovery         : 启动 postgres 并完成恢复</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - verify           : 验证恢复的集群控制数据</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># up                   : 启动 postgres/patroni 并恢复 HA</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - etcd             : 启动前清理 etcd 元数据</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - start            : 启动 patroni 和 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_postgres : 启动 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_patroni  : 启动 patroni 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - resume           : 恢复 patroni 自动故障转移</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>恢复目标类型说明</strong></p><table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>latest</code></td><td>恢复到 WAL 归档流末端（最新状态）</td><td><code>{"pg_pitr": {}}</code></td></tr><tr><td><code>time</code></td><td>恢复到指定时间点</td><td><code>{"pg_pitr": {"time": "2025-07-13 10:00:00"}}</code></td></tr><tr><td><code>xid</code></td><td>恢复到指定事务 ID</td><td><code>{"pg_pitr": {"xid": "250000"}}</code></td></tr><tr><td><code>name</code></td><td>恢复到命名还原点</td><td><code>{"pg_pitr": {"name": "before_ddl"}}</code></td></tr><tr><td><code>lsn</code></td><td>恢复到指定 LSN</td><td><code>{"pg_pitr": {"lsn": "0/4001C80"}}</code></td></tr><tr><td><code>immediate</code></td><td>恢复到一致性状态后立即停止</td><td><code>{"pg_pitr": {"type": "immediate"}}</code></td></tr></tbody></table><p>详情请参考：<a href=/docs/pgsql/backup/restore/>备份恢复教程</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-f11dbaecba8ffad62c75360642541598>16 - 扩展插件</h1><div class=lead>利用 PostgreSQL 扩展的协同超能力</div><p>Pigsty 提供 <a href=https://pgext.cloud/zh/list><strong>451</strong> 扩展</a>，覆盖时序、地理、向量、全文检索、分析、特性增强等 16 大类别，开箱即用。</p><p>在 Pigsty 中使用扩展涉及四个核心步骤：<a href=/docs/pgsql/ext/download><strong>下载</strong></a>、<a href=/docs/pgsql/ext/install><strong>安装</strong></a>、<a href=/docs/pgsql/ext/config><strong>配置/加载</strong></a> 与 <a href=/docs/pgsql/ext/create><strong>启用</strong></a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, vector ]  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 启用：在数据库中创建扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 配置：预加载扩展库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装：安装扩展软件包</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><img src=/img/pigsty/ecosystem.png alt></p></div><div class=td-content style=page-break-before:always><h1 id=pg-cb575384aee4c018fb0db527378640fd>16.1 - 快速开始</h1><div class=lead>使用扩展的四步流程速览</div><p>在 Pigsty 中使用扩展需要四个步骤：<strong>下载</strong>、<strong>安装</strong>、<strong>配置</strong>、<strong>启用</strong>。</p><ol><li><strong>下载</strong>：将扩展软件包下载到本地仓库（Pigsty 默认已下载主流扩展）</li><li><strong>安装</strong>：在集群节点上安装扩展软件包</li><li><strong>配置</strong>：部分扩展需要预加载或配置参数</li><li><strong>启用</strong>：在数据库中执行 <code>CREATE EXTENSION</code> 创建扩展</li></ol><hr><h2 id=声明式配置>声明式配置</h2><p>在 Pigsty 配置清单中声明扩展，集群初始化时自动完成安装与启用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, vector ]  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 在数据库中启用扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 预加载扩展库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装扩展软件包</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>执行 <code>./pgsql.yml</code> 初始化集群后，<code>postgis</code>、<code>timescaledb</code>、<code>vector</code> 三个扩展即在 <code>meta</code> 数据库中可用。</p><hr><h2 id=命令式操作>命令式操作</h2><p>对于已有集群，可以使用命令行方式添加扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 安装扩展软件包</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_extension -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;:[&#34;pgvector&#34;]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 预加载扩展（如需要，修改后需重启）</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 在数据库中启用扩展</span>
</span></span><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION vector;&#39;</span>
</span></span></code></pre></div><p>也可以使用 <a href=https://pgext.cloud/pig>pig</a> 包管理器直接安装：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig install pgvector        <span style=color:#8f5902;font-style:italic># 安装扩展包</span>
</span></span><span style=display:flex><span>pig extension create vector  <span style=color:#8f5902;font-style:italic># 在数据库中启用</span>
</span></span></code></pre></div><hr><h2 id=流程速查>流程速查</h2><table class=full-width><thead><tr><th style=text-align:center>步骤</th><th style=text-align:left>参数/命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:center>下载</td><td style=text-align:left><a href=/docs/infra/param#repo_extra_packages><code>repo_extra_packages</code></a></td><td style=text-align:left>指定下载到本地仓库的扩展包</td></tr><tr><td style=text-align:center>安装</td><td style=text-align:left><a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a></td><td style=text-align:left>指定集群要安装的扩展包</td></tr><tr><td style=text-align:center>配置</td><td style=text-align:left><a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a></td><td style=text-align:left>预加载扩展到 <code>shared_preload_libraries</code></td></tr><tr><td style=text-align:center>启用</td><td style=text-align:left><a href=/docs/pgsql/config/db><code>pg_databases.extensions</code></a></td><td style=text-align:left>在数据库中自动执行 <code>CREATE EXTENSION</code></td></tr></tbody></table><blockquote><p>详细说明请参阅各子章节：<a href=/docs/pgsql/ext/download/>下载</a>、<a href=/docs/pgsql/ext/install/>安装</a>、<a href=/docs/pgsql/ext/config/>配置</a>、<a href=/docs/pgsql/ext/create/>启用</a></p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-37c08dbc246cb158947abfb17f172ecc>16.2 - 扩展简介</h1><div class=lead>PostgreSQL 扩展的核心概念与 Pigsty 扩展生态</div><p>扩展是 PostgreSQL 的灵魂所在。Pigsty 收录了 451 个预编译、开箱即用的扩展插件，充分释放 PostgreSQL 的潜能。</p><hr><h2 id=扩展是什么>扩展是什么</h2><p>PostgreSQL 扩展（Extension）是一种模块化机制，允许在不修改核心代码的情况下增强数据库功能。
一个扩展通常包含三部分：</p><ul><li><strong>控制文件</strong>（<code>.control</code>）：必需，包含扩展元数据</li><li><strong>SQL 脚本</strong>（<code>.sql</code>）：可选，定义函数、类型、操作符等数据库对象</li><li><strong>动态库</strong>（<code>.so</code>）：可选，提供 C 语言实现的高性能功能</li></ul><p>扩展可以为 PostgreSQL 添加：新数据类型、索引方法、函数与操作符、外部数据访问、过程语言、性能监控、安全审计等能力。</p><hr><h2 id=核心扩展>核心扩展</h2><p>Pigsty 收录的扩展中，以下是最具代表性的：</p><table class=full-width><thead><tr><th style=text-align:left>扩展</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=https://postgis.net/><strong>PostGIS</strong></a></td><td style=text-align:left>地理空间数据类型与索引，GIS 事实标准</td></tr><tr><td style=text-align:left><a href=https://www.timescale.com/><strong>TimescaleDB</strong></a></td><td style=text-align:left>时序数据库，支持持续聚合、列存储、自动压缩</td></tr><tr><td style=text-align:left><a href=https://github.com/pgvector/pgvector><strong>PGVector</strong></a></td><td style=text-align:left>向量数据类型与 HNSW/IVFFlat 索引，AI 应用必备</td></tr><tr><td style=text-align:left><a href=https://www.citusdata.com/><strong>Citus</strong></a></td><td style=text-align:left>分布式数据库，水平分片扩展能力</td></tr><tr><td style=text-align:left><a href=https://github.com/duckdb/pg_duckdb><strong>pg_duckdb</strong></a></td><td style=text-align:left>嵌入 DuckDB 分析引擎，OLAP 加速</td></tr><tr><td style=text-align:left><a href=https://www.paradedb.com/><strong>ParadeDB</strong></a></td><td style=text-align:left>ElasticSearch 级别的全文搜索能力</td></tr><tr><td style=text-align:left><a href=https://age.apache.org/><strong>Apache AGE</strong></a></td><td style=text-align:left>图数据库，支持 OpenCypher 查询语言</td></tr><tr><td style=text-align:left><a href=https://github.com/supabase/pg_graphql><strong>pg_graphql</strong></a></td><td style=text-align:left>原生 GraphQL 查询支持</td></tr></tbody></table><p>绝大多数扩展可以并存甚至组合使用，产生 1+1 远大于 2 的协同效应。</p><hr><h2 id=扩展类别>扩展类别</h2><p>Pigsty 将扩展划分为 16 个类别：</p><table class=full-width><thead><tr><th style=text-align:center>类别</th><th style=text-align:left>别名</th><th style=text-align:left>说明</th><th style=text-align:left>典型扩展</th></tr></thead><tbody><tr><td style=text-align:center>时序</td><td style=text-align:left><code>time</code></td><td style=text-align:left>时序数据处理</td><td style=text-align:left>timescaledb, pg_cron, periods</td></tr><tr><td style=text-align:center>地理</td><td style=text-align:left><code>gis</code></td><td style=text-align:left>地理空间数据</td><td style=text-align:left>postgis, h3, pgrouting</td></tr><tr><td style=text-align:center>向量</td><td style=text-align:left><code>rag</code></td><td style=text-align:left>向量检索与 AI</td><td style=text-align:left>pgvector, vchord, pg_vectorize</td></tr><tr><td style=text-align:center>搜索</td><td style=text-align:left><code>fts</code></td><td style=text-align:left>全文检索</td><td style=text-align:left>pgroonga, zhparser, pg_bigm</td></tr><tr><td style=text-align:center>分析</td><td style=text-align:left><code>olap</code></td><td style=text-align:left>OLAP 与分析</td><td style=text-align:left>pg_duckdb, pg_mooncake, citus</td></tr><tr><td style=text-align:center>特性</td><td style=text-align:left><code>feat</code></td><td style=text-align:left>功能增强</td><td style=text-align:left>age, pg_graphql, hll, rum</td></tr><tr><td style=text-align:center>语言</td><td style=text-align:left><code>lang</code></td><td style=text-align:left>过程语言</td><td style=text-align:left>plpython3u, pljava, plv8</td></tr><tr><td style=text-align:center>类型</td><td style=text-align:left><code>type</code></td><td style=text-align:left>数据类型</td><td style=text-align:left>hstore, ltree, ip4r</td></tr><tr><td style=text-align:center>工具</td><td style=text-align:left><code>util</code></td><td style=text-align:left>实用工具</td><td style=text-align:left>http, pg_net, pgjwt</td></tr><tr><td style=text-align:center>函数</td><td style=text-align:left><code>func</code></td><td style=text-align:left>函数库</td><td style=text-align:left>pg_uuidv7, topn, tdigest</td></tr><tr><td style=text-align:center>管理</td><td style=text-align:left><code>admin</code></td><td style=text-align:left>运维管理</td><td style=text-align:left>pg_repack, pg_squeeze, pgagent</td></tr><tr><td style=text-align:center>统计</td><td style=text-align:left><code>stat</code></td><td style=text-align:left>监控统计</td><td style=text-align:left>pg_stat_statements, pg_qualstats, auto_explain</td></tr><tr><td style=text-align:center>安全</td><td style=text-align:left><code>sec</code></td><td style=text-align:left>安全审计</td><td style=text-align:left>pgaudit, pgsodium, pg_tde</td></tr><tr><td style=text-align:center>外联</td><td style=text-align:left><code>fdw</code></td><td style=text-align:left>外部数据访问</td><td style=text-align:left>postgres_fdw, mysql_fdw, oracle_fdw</td></tr><tr><td style=text-align:center>兼容</td><td style=text-align:left><code>sim</code></td><td style=text-align:left>数据库兼容</td><td style=text-align:left>orafce, babelfish</td></tr><tr><td style=text-align:center>同步</td><td style=text-align:left><code>etl</code></td><td style=text-align:left>数据同步</td><td style=text-align:left>pglogical, wal2json, decoderbufs</td></tr></tbody></table><p>使用类别别名可以批量安装整个类别的扩展，例如 <code>pg_extensions: [ pgsql-gis, pgsql-rag ]</code>。</p><hr><h2 id=预定义扩展集>预定义扩展集</h2><p>Pigsty 提供了若干预定义的扩展集（Stack），方便按场景选用：</p><table class=full-width><thead><tr><th style=text-align:left>扩展集</th><th style=text-align:left>包含扩展</th></tr></thead><tbody><tr><td style=text-align:left><code>gis-stack</code></td><td style=text-align:left>postgis, pgrouting, pointcloud, h3, q3c, ogr_fdw</td></tr><tr><td style=text-align:left><code>rag-stack</code></td><td style=text-align:left>pgvector, vchord, pgvectorscale, pg_similarity, pg_tiktoken</td></tr><tr><td style=text-align:left><code>fts-stack</code></td><td style=text-align:left>pgroonga, pg_bigm, zhparser, hunspell</td></tr><tr><td style=text-align:left><code>olap-stack</code></td><td style=text-align:left>pg_duckdb, pg_mooncake, timescaledb, pg_partman, plproxy</td></tr><tr><td style=text-align:left><code>feat-stack</code></td><td style=text-align:left>age, hll, rum, pg_graphql, pg_jsonschema, jsquery</td></tr><tr><td style=text-align:left><code>stat-stack</code></td><td style=text-align:left>pg_show_plans, pg_stat_kcache, pg_qualstats, pg_wait_sampling</td></tr><tr><td style=text-align:left><code>supa-stack</code></td><td style=text-align:left>pg_graphql, pg_jsonschema, wrappers, pgvector, pgsodium, vault</td></tr></tbody></table><p>在 <code>pg_extensions</code> 中直接使用这些名称即可安装整套扩展。</p><hr><h2 id=扩展资源>扩展资源</h2><ul><li><a href=https://pgext.cloud/zh/list><strong>扩展目录</strong></a>：查阅所有可用扩展的详细信息</li><li><a href=https://pgext.cloud/zh/repo/><strong>扩展仓库</strong></a>：Pigsty 扩展软件仓库</li><li><a href=https://pgext.cloud/pig><strong>pig 包管理器</strong></a>：命令行扩展管理工具</li><li><a href=https://github.com/pgsty/pigsty><strong>GitHub Pigsty</strong></a>：Pigsty 源代码仓库</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-6c21bc6ef6cf2173aeb9948071de953f>16.3 - 软件包</h1><div class=lead>扩展包别名与类别命名规则</div><p>Pigsty 使用<strong>包别名</strong>机制简化扩展的安装与管理。</p><hr><h2 id=包别名机制>包别名机制</h2><p>管理扩展涉及多个层面的名称映射：</p><table class=full-width><thead><tr><th style=text-align:left>层面</th><th style=text-align:left>示例 <code>pgvector</code></th><th style=text-align:left>示例 <code>postgis</code></th></tr></thead><tbody><tr><td style=text-align:left>扩展名</td><td style=text-align:left><code>vector</code></td><td style=text-align:left><code>postgis</code>, <code>postgis_topology</code>, &mldr;</td></tr><tr><td style=text-align:left>包别名</td><td style=text-align:left><code>pgvector</code></td><td style=text-align:left><code>postgis</code></td></tr><tr><td style=text-align:left>RPM 包名</td><td style=text-align:left><code>pgvector_18</code></td><td style=text-align:left><code>postgis36_18*</code></td></tr><tr><td style=text-align:left>DEB 包名</td><td style=text-align:left><code>postgresql-18-pgvector</code></td><td style=text-align:left><code>postgresql-18-postgis-3*</code></td></tr></tbody></table><p>Pigsty 提供<strong>包别名</strong>抽象层，让用户无需关心具体的 RPM/DEB 包名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, postgis, timescaledb ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用包别名</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 会根据操作系统和 PostgreSQL 版本自动翻译为正确的包名。</p><blockquote><p>注意：<code>CREATE EXTENSION</code> 时使用的是<strong>扩展名</strong>（如 <code>vector</code>），而非包别名（<code>pgvector</code>）。</p></blockquote><hr><h2 id=类别别名>类别别名</h2><p>所有扩展被划分为 16 个类别，可使用类别别名批量安装：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用通用类别别名（自动适配当前 PG 版本）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-gis, pgsql-rag, pgsql-fts ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或使用版本特定的类别别名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pg18-gis, pg18-rag, pg18-fts ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>除 <code>olap</code> 类别外，所有类别的扩展都可以同时安装。<code>olap</code> 类别中存在互斥：<code>pg_duckdb</code> 与 <code>pg_mooncake</code> 冲突。</p><hr><h2 id=类别列表>类别列表</h2><table class=full-width><thead><tr><th style=text-align:center>类别</th><th style=text-align:left>说明</th><th style=text-align:left>典型扩展</th></tr></thead><tbody><tr><td style=text-align:center><code>time</code></td><td style=text-align:left>时序类</td><td style=text-align:left>timescaledb, pg_cron, periods</td></tr><tr><td style=text-align:center><code>gis</code></td><td style=text-align:left>地理类</td><td style=text-align:left>postgis, h3, pgrouting</td></tr><tr><td style=text-align:center><code>rag</code></td><td style=text-align:left>向量类</td><td style=text-align:left>pgvector, pgml, vchord</td></tr><tr><td style=text-align:center><code>fts</code></td><td style=text-align:left>搜索类</td><td style=text-align:left>pg_trgm, zhparser, pgroonga</td></tr><tr><td style=text-align:center><code>olap</code></td><td style=text-align:left>分析类</td><td style=text-align:left>citus, pg_duckdb, pg_analytics</td></tr><tr><td style=text-align:center><code>feat</code></td><td style=text-align:left>特性类</td><td style=text-align:left>age, pg_graphql, rum</td></tr><tr><td style=text-align:center><code>lang</code></td><td style=text-align:left>语言类</td><td style=text-align:left>plpython3u, pljava, plv8</td></tr><tr><td style=text-align:center><code>type</code></td><td style=text-align:left>类型类</td><td style=text-align:left>hstore, ltree, citext</td></tr><tr><td style=text-align:center><code>util</code></td><td style=text-align:left>工具类</td><td style=text-align:left>http, pg_net, pgjwt</td></tr><tr><td style=text-align:center><code>func</code></td><td style=text-align:left>函数类</td><td style=text-align:left>pgcrypto, uuid-ossp, pg_uuidv7</td></tr><tr><td style=text-align:center><code>admin</code></td><td style=text-align:left>管理类</td><td style=text-align:left>pg_repack, pgagent, pg_squeeze</td></tr><tr><td style=text-align:center><code>stat</code></td><td style=text-align:left>统计类</td><td style=text-align:left>pg_stat_statements, pg_qualstats, auto_explain</td></tr><tr><td style=text-align:center><code>sec</code></td><td style=text-align:left>安全类</td><td style=text-align:left>pgaudit, pgcrypto, pgsodium</td></tr><tr><td style=text-align:center><code>fdw</code></td><td style=text-align:left>外部类</td><td style=text-align:left>postgres_fdw, mysql_fdw, oracle_fdw</td></tr><tr><td style=text-align:center><code>sim</code></td><td style=text-align:left>兼容类</td><td style=text-align:left>orafce, babelfishpg_tds</td></tr><tr><td style=text-align:center><code>etl</code></td><td style=text-align:left>数据类</td><td style=text-align:left>pglogical, wal2json, decoderbufs</td></tr></tbody></table><hr><h2 id=查阅扩展目录>查阅扩展目录</h2><p>您可以在 <a href=https://pgext.cloud/zh/list>Pigsty 扩展目录</a> 网站上查阅所有可用扩展的详细信息，包括：</p><ul><li>扩展名称、描述、版本</li><li>支持的 PostgreSQL 版本</li><li>支持的操作系统发行版</li><li>安装方式、预加载需求</li><li>许可证、来源仓库</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-96a6a67c2f3d2429fabeed6f98b76c7f>16.4 - 下载扩展</h1><div class=lead>从软件仓库下载扩展包到本地</div><p>在安装扩展前，需要确保扩展软件包已下载到本地仓库或可从上游获取。</p><hr><h2 id=默认行为>默认行为</h2><p>Pigsty 在安装过程中会自动下载默认 PostgreSQL 版本可用的主流扩展到本地软件仓库。</p><p>使用本地仓库的优势：</p><ul><li>加速安装，避免重复下载</li><li>减少网络流量消耗</li><li>提高交付可靠性</li><li>确保版本一致性</li></ul><hr><h2 id=下载新扩展>下载新扩展</h2><p>要下载额外的扩展，将其添加到 <a href=/docs/infra/param#repo_extra_packages><code>repo_extra_packages</code></a> 并重建仓库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>repo_extra_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, postgis, timescaledb, pg_duckdb ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重新下载软件包到本地仓库</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 刷新所有节点的软件源缓存</span>
</span></span><span style=display:flex><span>./node.yml -t node_repo
</span></span></code></pre></div><hr><h2 id=使用上游仓库>使用上游仓库</h2><p>也可以直接从互联网上游仓库安装，无需预先下载：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在节点上添加上游软件源</span>
</span></span><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql
</span></span></code></pre></div><p>这种方式适合：</p><ul><li>快速测试最新版本</li><li>安装冷门扩展</li><li>网络条件良好的环境</li></ul><p>但可能面临：</p><ul><li>网络不稳定影响安装</li><li>版本不一致风险</li></ul><hr><h2 id=扩展来源>扩展来源</h2><p>扩展软件包来自两个主要源：</p><table class=full-width><thead><tr><th style=text-align:left>仓库</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><strong>PGDG</strong></td><td style=text-align:left>PostgreSQL 官方仓库，提供核心扩展</td></tr><tr><td style=text-align:left><strong>Pigsty</strong></td><td style=text-align:left>Pigsty 补充仓库，提供额外扩展</td></tr></tbody></table><p>Pigsty 仓库只收录 PGDG 仓库中不存在的扩展。一旦某扩展进入 PGDG 仓库，Pigsty 仓库会移除或与其保持一致。</p><p>仓库地址：</p><ul><li>PGDG YUM: <a href=https://download.postgresql.org/pub/repos/yum/>https://download.postgresql.org/pub/repos/yum/</a></li><li>PGDG APT: <a href=https://apt.postgresql.org/pub/repos/apt/>https://apt.postgresql.org/pub/repos/apt/</a></li><li>Pigsty YUM: <a href=https://repo.pigsty.io/yum/>https://repo.pigsty.io/yum/</a></li><li>Pigsty APT: <a href=https://repo.pigsty.io/apt/>https://repo.pigsty.io/apt/</a></li></ul><p>详细的仓库配置请参阅 <a href=/docs/pgsql/ext/repo/>扩展仓库</a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-128bcfdba2d6b955af1661f0a806fd9e>16.5 - 安装扩展</h1><div class=lead>在集群节点上安装扩展软件包</div><p>Pigsty 使用操作系统的包管理器（yum/apt）安装扩展软件包。</p><hr><h2 id=相关参数>相关参数</h2><p>两个参数用于指定要安装的扩展：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>用途</th><th style=text-align:left>默认行为</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_packages><code>pg_packages</code></a></td><td style=text-align:left>全局通用软件包</td><td style=text-align:left>确保存在（不升级）</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a></td><td style=text-align:left>集群特定扩展</td><td style=text-align:left>安装最新版本</td></tr></tbody></table><p><code>pg_packages</code> 通常用于指定所有集群都需要的基础组件（PostgreSQL 内核、Patroni、pgBouncer 等）和必选扩展。</p><p><code>pg_extensions</code> 用于指定特定集群需要的扩展。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># 全局基础包</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># 集群扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgis timescaledb pgvector</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=集群初始化时安装>集群初始化时安装</h2><p>在集群配置中声明扩展，初始化时自动安装：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector, pg_duckdb ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>执行 <code>./pgsql.yml</code> 初始化集群时，扩展会自动安装。</p><hr><h2 id=已有集群安装扩展>已有集群安装扩展</h2><p>对于已初始化的集群，有多种方式安装扩展：</p><h3 id=使用-pigsty-剧本>使用 Pigsty 剧本</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改配置后使用剧本安装</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_extension
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或直接在命令行指定扩展</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_extension -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;:[&#34;pg_duckdb&#34;]}&#39;</span>
</span></span></code></pre></div><h3 id=使用-pig-包管理器>使用 pig 包管理器</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 pig 安装扩展</span>
</span></span><span style=display:flex><span>pig install pg_duckdb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 批量安装</span>
</span></span><span style=display:flex><span>ansible pg-meta -b -a <span style=color:#4e9a06>&#39;pig install pg_duckdb pgvector&#39;</span>
</span></span></code></pre></div><h3 id=直接使用包管理器>直接使用包管理器</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 系统</span>
</span></span><span style=display:flex><span>sudo yum install -y pg_duckdb_18*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian/Ubuntu 系统</span>
</span></span><span style=display:flex><span>sudo apt install -y postgresql-18-pg-duckdb
</span></span></code></pre></div><hr><h2 id=使用包别名>使用包别名</h2><p>Pigsty 支持使用标准化的包别名，自动翻译为对应 PG 版本的包名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgvector          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 自动翻译为 pgvector_18* (EL) 或 postgresql-18-pgvector (Debian)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgis           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 自动翻译为 postgis36_18* (EL) 或 postgresql-18-postgis-3* (Debian)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-gis         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 类别别名，安装整个 GIS 类别的扩展</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>也可以直接使用原始包名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgvector_18*                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># EL 系统的原始包名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgresql-18-pgvector         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Debian 系统的原始包名</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>包别名定义参见：</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el8.x86_64.yml>EL8 扩展列表</a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el9.x86_64.yml>EL9 扩展列表</a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d12.x86_64.yml>D12 扩展列表</a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u22.x86_64.yml>U22 扩展列表</a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u24.x86_64.yml>U24 扩展列表</a></li></ul><hr><h2 id=验证安装>验证安装</h2><p>安装后可在数据库中验证：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看已安装的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看扩展文件是否存在
</span></span></span><span style=display:flex><span><span style=color:#a40000>\</span><span style=color:#000>dx</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-8c405665bb423ccc536997bd9c3a64ca>16.6 - 配置扩展</h1><div class=lead>预加载扩展库与配置扩展参数</div><p>部分扩展需要预加载动态库或配置参数后才能使用，本节介绍如何配置扩展。</p><hr><h2 id=预加载扩展>预加载扩展</h2><p>大多数扩展安装后可直接使用 <code>CREATE EXTENSION</code> 启用，但部分使用 PostgreSQL Hook 机制的扩展需要<strong>预加载</strong>。</p><p>预加载通过 <code>shared_preload_libraries</code> 参数指定，修改后需<strong>重启数据库</strong>生效。</p><h3 id=需要预加载的扩展>需要预加载的扩展</h3><p>以下是常见的需要预加载的扩展：</p><table class=full-width><thead><tr><th style=text-align:left>扩展</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>timescaledb</code></td><td style=text-align:left>时序数据库扩展，必须放在最前面</td></tr><tr><td style=text-align:left><code>citus</code></td><td style=text-align:left>分布式数据库扩展，必须放在最前面</td></tr><tr><td style=text-align:left><code>pg_stat_statements</code></td><td style=text-align:left>SQL 语句统计，Pigsty 默认启用</td></tr><tr><td style=text-align:left><code>auto_explain</code></td><td style=text-align:left>自动记录慢查询执行计划，Pigsty 默认启用</td></tr><tr><td style=text-align:left><code>pg_cron</code></td><td style=text-align:left>定时任务调度</td></tr><tr><td style=text-align:left><code>pg_net</code></td><td style=text-align:left>异步 HTTP 请求</td></tr><tr><td style=text-align:left><code>pg_tle</code></td><td style=text-align:left>可信语言扩展</td></tr><tr><td style=text-align:left><code>pgaudit</code></td><td style=text-align:left>审计日志</td></tr><tr><td style=text-align:left><code>pg_stat_kcache</code></td><td style=text-align:left>内核统计信息</td></tr><tr><td style=text-align:left><code>pg_squeeze</code></td><td style=text-align:left>在线表空间回收</td></tr><tr><td style=text-align:left><code>pgml</code></td><td style=text-align:left>PostgresML 机器学习</td></tr></tbody></table><p>完整列表请参阅 <a href=https://pgext.cloud/zh/list>扩展目录</a>（带 <code>LOAD</code> 标记）。</p><h3 id=预加载顺序>预加载顺序</h3><p><code>shared_preload_libraries</code> 中扩展的加载顺序很重要：</p><ul><li><code>timescaledb</code> 和 <code>citus</code> 必须放在<strong>最前面</strong></li><li>如果同时使用，<code>citus</code> 应在 <code>timescaledb</code> 之前</li><li>统计类扩展应在 <code>pg_stat_statements</code> 之后，以使用相同的 query_id</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=集群初始化时配置>集群初始化时配置</h2><p>在创建新集群时，使用 <a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a> 参数指定预加载的扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb, postgis, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>pg_libs</code> 的值将在集群初始化时写入 <code>shared_preload_libraries</code>。</p><h3 id=默认值>默认值</h3><p><a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a> 的默认值是 <code>pg_stat_statements, auto_explain</code>，这两个 Contrib 扩展提供基本的可观测性：</p><ul><li><code>pg_stat_statements</code>：跟踪所有 SQL 语句的执行统计</li><li><code>auto_explain</code>：自动记录慢查询的执行计划</li></ul><hr><h2 id=已有集群修改配置>已有集群修改配置</h2><p>对于已初始化的集群，使用 <code>patronictl</code> 修改 <code>shared_preload_libraries</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 添加 timescaledb 到预加载库</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重启集群使配置生效</span>
</span></span><span style=display:flex><span>pg restart pg-meta
</span></span></code></pre></div><p>也可以直接修改 <code>postgresql.conf</code> 或使用 <code>ALTER SYSTEM</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>shared_preload_libraries</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>修改后需重启 PostgreSQL 服务生效。</p><hr><h2 id=扩展参数配置>扩展参数配置</h2><p>许多扩展有可配置的参数，可以在以下位置设置：</p><h3 id=集群初始化时>集群初始化时</h3><p>使用 <a href=/docs/pgsql/param#pg_parameters><code>pg_parameters</code></a> 参数指定：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_cron, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg_cron 使用的数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_stat_statements.track</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 跟踪所有语句</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>auto_explain.log_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 记录超过 1 秒的查询</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=运行时修改>运行时修改</h3><p>使用 <code>ALTER SYSTEM</code> 或 <code>patronictl</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 修改参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_statements</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>track</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 重新加载配置
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_reload_conf</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 patronictl 修改</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#4e9a06>&#39;pg_stat_statements.track=all&#39;</span>
</span></span></code></pre></div><hr><h2 id=注意事项>注意事项</h2><ol><li><p><strong>预加载错误会阻止启动</strong>：如果 <code>shared_preload_libraries</code> 中的扩展不存在或加载失败，PostgreSQL 将无法启动。确保扩展已正确安装后再添加预加载。</p></li><li><p><strong>修改需重启</strong>：<code>shared_preload_libraries</code> 的修改需要重启 PostgreSQL 服务才能生效。</p></li><li><p><strong>部分功能可用</strong>：某些扩展在不预加载的情况下可以部分使用，但完整功能需要预加载。</p></li><li><p><strong>查看当前配置</strong>：使用以下命令查看当前的预加载库：</p></li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>shared_preload_libraries</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-5b462599a5e29b51a35ede5bb5e310a8>16.7 - 启用扩展</h1><div class=lead>在数据库中创建和启用扩展</div><p>安装扩展软件包后，需要在数据库中执行 <code>CREATE EXTENSION</code> 才能使用扩展功能。</p><hr><h2 id=查看可用扩展>查看可用扩展</h2><p>安装扩展软件包后，可以查看可用的扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看所有可用扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看特定扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看已启用的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=创建扩展>创建扩展</h2><p>使用 <code>CREATE EXTENSION</code> 在数据库中启用扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 创建扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 创建扩展到指定 Schema
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 自动安装依赖的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 如果不存在则创建
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>注意：<code>CREATE EXTENSION</code> 使用的是<strong>扩展名</strong>（如 <code>vector</code>），而非包别名（<code>pgvector</code>）。</p></blockquote><hr><h2 id=集群初始化时启用>集群初始化时启用</h2><p>在 <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> 中声明扩展，集群初始化时自动创建：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>vector }                        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用默认 Schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指定 Schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_stat_statements, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 会在数据库创建后自动执行 <code>CREATE EXTENSION</code>。</p><hr><h2 id=需要预加载的扩展>需要预加载的扩展</h2><p>部分扩展需要先添加到 <code>shared_preload_libraries</code> 并重启后才能创建：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 需要预加载</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果未预加载就尝试创建，会收到错误信息。</p><p>需要预加载的常见扩展：<code>timescaledb</code>, <code>citus</code>, <code>pg_cron</code>, <code>pg_net</code>, <code>pgaudit</code> 等。详见 <a href=/docs/pgsql/ext/config/>配置扩展</a>。</p><hr><h2 id=扩展依赖>扩展依赖</h2><p>某些扩展依赖于其他扩展，需要按顺序创建：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- postgis_topology 依赖 postgis
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 或使用 CASCADE 自动安装依赖
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=不需要创建的扩展>不需要创建的扩展</h2><p>少数扩展不通过 SQL 接口对外服务，无需执行 <code>CREATE EXTENSION</code>：</p><table class=full-width><thead><tr><th style=text-align:left>扩展</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>wal2json</code></td><td style=text-align:left>逻辑解码插件，直接在复制槽中使用</td></tr><tr><td style=text-align:left><code>decoderbufs</code></td><td style=text-align:left>逻辑解码插件</td></tr><tr><td style=text-align:left><code>decoder_raw</code></td><td style=text-align:left>逻辑解码插件</td></tr></tbody></table><p>这些扩展安装后即可使用，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 使用 wal2json 创建逻辑复制槽
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_create_logical_replication_slot</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;test_slot&#39;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;wal2json&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=查看扩展信息>查看扩展信息</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看扩展详情
</span></span></span><span style=display:flex><span><span style=color:#a40000>\</span><span style=color:#000>dx</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看扩展包含的对象
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension_config_dump</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看扩展版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-aeb68b34de12844024f2519dd13df6f0>16.8 - 更新扩展</h1><div class=lead>升级 PostgreSQL 扩展版本</div><p>扩展更新涉及两个层面：<strong>软件包更新</strong>（操作系统层面）和<strong>扩展对象更新</strong>（数据库层面）。</p><hr><h2 id=更新软件包>更新软件包</h2><p>使用包管理器更新扩展的软件包：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 系统</span>
</span></span><span style=display:flex><span>sudo yum update pgvector_18*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian/Ubuntu 系统</span>
</span></span><span style=display:flex><span>sudo apt update <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> sudo apt upgrade postgresql-18-pgvector
</span></span></code></pre></div><p>使用 Pigsty 批量更新：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 更新指定集群的扩展包</span>
</span></span><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_extension -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;:[&#34;pgvector&#34;]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 pig 包管理器</span>
</span></span><span style=display:flex><span>pig update pgvector
</span></span></code></pre></div><hr><h2 id=更新扩展对象>更新扩展对象</h2><p>软件包更新后，数据库中的扩展对象可能需要同步更新。</p><h3 id=查看可更新的扩展>查看可更新的扩展</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看已安装扩展及其版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看可升级的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=执行扩展更新>执行扩展更新</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 更新到最新版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 更新到指定版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.8.0&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=查看更新路径>查看更新路径</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看扩展的可用升级路径
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension_update_paths</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgvector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=注意事项>注意事项</h2><ol><li><p><strong>备份优先</strong>：更新扩展前建议先备份数据库，特别是涉及数据类型变更的扩展。</p></li><li><p><strong>检查兼容性</strong>：某些扩展的大版本升级可能不兼容，需查阅扩展的升级文档。</p></li><li><p><strong>预加载扩展</strong>：如果更新的是需要预加载的扩展（如 <code>timescaledb</code>），更新后可能需要重启数据库。</p></li><li><p><strong>依赖关系</strong>：如果其他扩展依赖于被更新的扩展，需要按依赖顺序更新。</p></li><li><p><strong>复制环境</strong>：在主从复制环境中，应先在从库测试更新，确认无误后再更新主库。</p></li></ol><hr><h2 id=常见问题>常见问题</h2><h3 id=更新失败>更新失败</h3><p>如果 <code>ALTER EXTENSION UPDATE</code> 失败，可能是因为：</p><ul><li>没有可用的升级路径</li><li>扩展正在被使用</li><li>权限不足</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看扩展依赖
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>refobjid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgvector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=回滚更新>回滚更新</h3><p>PostgreSQL 扩展通常不支持直接回滚。如需回滚：</p><ol><li>从备份恢复</li><li>或者：卸载新版本扩展，安装旧版本软件包，重新创建扩展</li></ol></div><div class=td-content style=page-break-before:always><h1 id=pg-13869765de25ae294c556ad54ac4ee27>16.9 - 移除扩展</h1><div class=lead>卸载 PostgreSQL 扩展</div><p>移除扩展涉及两个层面：<strong>删除扩展对象</strong>（数据库层面）和<strong>卸载软件包</strong>（操作系统层面）。</p><hr><h2 id=删除扩展对象>删除扩展对象</h2><p>使用 <code>DROP EXTENSION</code> 从数据库中删除扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 删除扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 如果有依赖对象，需要级联删除
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p><strong>警告</strong>：<code>CASCADE</code> 会删除所有依赖于该扩展的对象（表、函数、视图等），请谨慎使用。</p></blockquote><h3 id=查看扩展依赖>查看扩展依赖</h3><p>删除前建议先检查依赖关系：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看依赖于某扩展的对象
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>classid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>objid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>deptype</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>refobjid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgvector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看使用了扩展类型的表
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>relname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>a</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>column_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>typname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>type_name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_attribute</span><span style=color:#f8f8f8> </span><span style=color:#000>a</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_class</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>c</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>a</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>attrelid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>c</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_type</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>a</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>atttypid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>typname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=移除预加载>移除预加载</h2><p>如果扩展在 <code>shared_preload_libraries</code> 中，删除后需要从预加载列表移除：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 shared_preload_libraries，移除扩展</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重启使配置生效</span>
</span></span><span style=display:flex><span>pg restart pg-meta
</span></span></code></pre></div><hr><h2 id=卸载软件包>卸载软件包</h2><p>从数据库中删除扩展后，可以选择卸载软件包：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 系统</span>
</span></span><span style=display:flex><span>sudo yum remove pgvector_18*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian/Ubuntu 系统</span>
</span></span><span style=display:flex><span>sudo apt remove postgresql-18-pgvector
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 pig 包管理器</span>
</span></span><span style=display:flex><span>pig remove pgvector
</span></span></code></pre></div><blockquote><p>通常保留软件包不会有问题，仅在需要释放磁盘空间或解决冲突时才需要卸载。</p></blockquote><hr><h2 id=注意事项>注意事项</h2><ol><li><p><strong>数据丢失风险</strong>：使用 <code>CASCADE</code> 会删除依赖对象，可能导致数据丢失。</p></li><li><p><strong>应用兼容性</strong>：删除扩展前确保应用程序不再使用该扩展的功能。</p></li><li><p><strong>预加载顺序</strong>：如果删除的是预加载扩展，务必同时从 <code>shared_preload_libraries</code> 中移除，否则数据库可能无法启动。</p></li><li><p><strong>主从环境</strong>：在主从复制环境中，<code>DROP EXTENSION</code> 会自动复制到从库。</p></li></ol><hr><h2 id=操作顺序>操作顺序</h2><p>完整的扩展移除流程：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 检查依赖关系</span>
</span></span><span style=display:flex><span>psql -d mydb -c <span style=color:#4e9a06>&#34;SELECT * FROM pg_depend WHERE refobjid = (SELECT oid FROM pg_extension WHERE extname = &#39;pgvector&#39;);&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 删除数据库中的扩展</span>
</span></span><span style=display:flex><span>psql -d mydb -c <span style=color:#4e9a06>&#34;DROP EXTENSION pgvector;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 如果是预加载扩展，从 shared_preload_libraries 移除</span>
</span></span><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. 重启数据库（如果修改了预加载配置）</span>
</span></span><span style=display:flex><span>pg restart pg-meta
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. 可选：卸载软件包</span>
</span></span><span style=display:flex><span>sudo yum remove pgvector_18*
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-cd40e09e16b398209123543c21e68960>16.10 - 默认扩展</h1><div class=lead>Pigsty 默认安装的 PostgreSQL 扩展</div><p>Pigsty 在初始化 PostgreSQL 集群时，会默认安装和启用一些核心扩展。</p><hr><h2 id=默认安装的扩展>默认安装的扩展</h2><p>通过 <a href=/docs/pgsql/param#pg_packages><code>pg_packages</code></a> 默认安装的扩展：</p><table class=full-width><thead><tr><th style=text-align:left>扩展</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>pg_repack</code></td><td style=text-align:left>在线处理表膨胀，重要的维护工具</td></tr><tr><td style=text-align:left><code>wal2json</code></td><td style=text-align:left>逻辑解码输出 JSON 格式变更，CDC 场景常用</td></tr></tbody></table><p>通过 <a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a> 可选安装的扩展（默认注释）：</p><table class=full-width><thead><tr><th style=text-align:left>扩展</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>postgis</code></td><td style=text-align:left>地理空间数据库扩展</td></tr><tr><td style=text-align:left><code>timescaledb</code></td><td style=text-align:left>时序数据库扩展</td></tr><tr><td style=text-align:left><code>pgvector</code></td><td style=text-align:left>向量数据类型与索引</td></tr></tbody></table><hr><h2 id=默认启用的扩展>默认启用的扩展</h2><p>通过 <a href=/docs/pgsql/param#pg_default_extensions><code>pg_default_extensions</code></a> 在所有数据库中默认启用的扩展：</p><table class=full-width><thead><tr><th style=text-align:left>扩展</th><th style=text-align:left>Schema</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>pg_stat_statements</code></td><td style=text-align:left>monitor</td><td style=text-align:left>SQL 语句执行统计</td></tr><tr><td style=text-align:left><code>pgstattuple</code></td><td style=text-align:left>monitor</td><td style=text-align:left>元组级统计信息</td></tr><tr><td style=text-align:left><code>pg_buffercache</code></td><td style=text-align:left>monitor</td><td style=text-align:left>缓冲区缓存检查</td></tr><tr><td style=text-align:left><code>pageinspect</code></td><td style=text-align:left>monitor</td><td style=text-align:left>页面级检查</td></tr><tr><td style=text-align:left><code>pg_prewarm</code></td><td style=text-align:left>monitor</td><td style=text-align:left>关系预热</td></tr><tr><td style=text-align:left><code>pg_visibility</code></td><td style=text-align:left>monitor</td><td style=text-align:left>可见性映射检查</td></tr><tr><td style=text-align:left><code>pg_freespacemap</code></td><td style=text-align:left>monitor</td><td style=text-align:left>空闲空间映射检查</td></tr><tr><td style=text-align:left><code>postgres_fdw</code></td><td style=text-align:left>public</td><td style=text-align:left>PostgreSQL 外部数据包装器</td></tr><tr><td style=text-align:left><code>file_fdw</code></td><td style=text-align:left>public</td><td style=text-align:left>文件外部数据包装器</td></tr><tr><td style=text-align:left><code>btree_gist</code></td><td style=text-align:left>public</td><td style=text-align:left>B-tree GiST 操作符类</td></tr><tr><td style=text-align:left><code>btree_gin</code></td><td style=text-align:left>public</td><td style=text-align:left>B-tree GIN 操作符类</td></tr><tr><td style=text-align:left><code>pg_trgm</code></td><td style=text-align:left>public</td><td style=text-align:left>三元组匹配</td></tr><tr><td style=text-align:left><code>intagg</code></td><td style=text-align:left>public</td><td style=text-align:left>整数聚合器</td></tr><tr><td style=text-align:left><code>intarray</code></td><td style=text-align:left>public</td><td style=text-align:left>整数数组函数</td></tr><tr><td style=text-align:left><code>pg_repack</code></td><td style=text-align:left>-</td><td style=text-align:left>在线重组表</td></tr></tbody></table><p>这些扩展提供基础的监控、运维和功能增强能力。</p><hr><h2 id=默认预加载的扩展>默认预加载的扩展</h2><p>通过 <a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a> 默认预加载到 <code>shared_preload_libraries</code> 的扩展：</p><table class=full-width><thead><tr><th style=text-align:left>扩展</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>pg_stat_statements</code></td><td style=text-align:left>跟踪所有 SQL 语句的执行统计</td></tr><tr><td style=text-align:left><code>auto_explain</code></td><td style=text-align:left>自动记录慢查询的执行计划</td></tr></tbody></table><p>这两个扩展提供基本的可观测性，强烈建议保留。</p><hr><h2 id=自定义默认扩展>自定义默认扩展</h2><p>可以通过修改配置参数来自定义默认安装和启用的扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 修改默认安装的扩展包</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>pg_repack_$v* wal2json_$v*</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 修改默认安装的扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 修改默认预加载的扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 修改默认启用的扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_stat_statements, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>monitor }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_repack }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># ... 添加更多</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>详细的扩展使用方法请参阅：</p><ul><li><a href=/docs/pgsql/ext/start/>快速开始</a>：使用扩展的流程速览</li><li><a href=/docs/pgsql/ext/intro/>扩展简介</a>：扩展的核心概念</li><li><a href=/docs/pgsql/ext/install/>安装扩展</a>：如何安装扩展</li><li><a href=/docs/pgsql/ext/config/>配置扩展</a>：预加载与参数配置</li><li><a href=/docs/pgsql/ext/create/>启用扩展</a>：在数据库中创建扩展</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fef9a9d4af92d185f18fab30d92a530d>16.11 - 扩展仓库</h1><div class=lead>Pigsty 扩展软件仓库配置</div><p>Pigsty 提供补充扩展仓库，在 PGDG 官方仓库基础上提供额外的扩展包。</p><hr><h2 id=yum-仓库>YUM 仓库</h2><p>适用于 EL 7/8/9/10 及其兼容系统（RHEL、Rocky、AlmaLinux、CentOS 等）。</p><h3 id=添加仓库>添加仓库</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 添加 GPG 公钥</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 添加仓库配置</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 刷新缓存</span>
</span></span><span style=display:flex><span>sudo yum makecache
</span></span></code></pre></div><h3 id=中国大陆镜像>中国大陆镜像</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span></code></pre></div><h3 id=仓库地址>仓库地址</h3><ul><li>国际: <a href=https://repo.pigsty.io/yum/>https://repo.pigsty.io/yum/</a></li><li>中国: <a href=https://repo.pigsty.cc/yum/>https://repo.pigsty.cc/yum/</a></li></ul><hr><h2 id=apt-仓库>APT 仓库</h2><p>适用于 Debian 11/12/13 和 Ubuntu 22.04/24.04 及其兼容系统。</p><h3 id=添加仓库-1>添加仓库</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 添加 GPG 公钥</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/pigsty.gpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 获取发行版代号并添加仓库</span>
</span></span><span style=display:flex><span><span style=color:#000>distro_codename</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>lsb_release -cs<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/pgsql ${distro_codename} main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 刷新缓存</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span></code></pre></div><h3 id=中国大陆镜像-1>中国大陆镜像</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/key <span style=color:#000;font-weight:700>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/pigsty.gpg
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>distro_codename</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>lsb_release -cs<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.cc/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.cc/apt/pgsql/${distro_codename} ${distro_codename} main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><h3 id=仓库地址-1>仓库地址</h3><ul><li>国际: <a href=https://repo.pigsty.io/apt/>https://repo.pigsty.io/apt/</a></li><li>中国: <a href=https://repo.pigsty.cc/apt/>https://repo.pigsty.cc/apt/</a></li></ul><hr><h2 id=gpg-签名>GPG 签名</h2><p>所有软件包均使用 GPG 签名：</p><ul><li>指纹: <code>9592A7BC7A682E7333376E09E7935D8DB9BD8B20</code></li><li>短 ID: <code>B9BD8B20</code></li></ul><hr><h2 id=仓库策略>仓库策略</h2><p>Pigsty 仓库遵循以下原则：</p><ol><li><strong>补充性</strong>：只收录 PGDG 仓库中不存在的扩展</li><li><strong>一致性</strong>：扩展进入 PGDG 仓库后，Pigsty 仓库会移除或保持一致</li><li><strong>兼容性</strong>：支持 PostgreSQL 13-18 多个大版本</li><li><strong>多平台</strong>：支持 x86_64 和 aarch64 架构</li></ol><hr><h2 id=相关资源>相关资源</h2><ul><li><a href=https://pgext.cloud/zh/list>Pigsty 扩展目录</a>：查阅所有可用扩展</li><li><a href=https://download.postgresql.org/pub/repos/yum/>PGDG YUM 仓库</a></li><li><a href=https://apt.postgresql.org/pub/repos/apt/>PGDG APT 仓库</a></li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-a670d0bcea1364c05aff52997d9cdc42>17 - 场景模板</h1><div class=lead>使用 Pigsty 预置的四种场景化 Patroni 模版，或者基于这些模板自定义您的配置模板</div><p>Pigsty 提供四种预置的 Patroni/PostgreSQL 配置模板，针对不同的使用场景进行了参数优化：</p><table class=full-width><thead><tr><th style=text-align:left>模板</th><th style=text-align:left>CPU核心</th><th style=text-align:left>适用场景</th><th style=text-align:left>特点</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/template/oltp><strong><code>/docs/pgsql/template/oltp.yml</code></strong></a></td><td style=text-align:left>4-128C</td><td style=text-align:left>OLTP 事务处理</td><td style=text-align:left>高并发、低延迟、高吞吐</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/template/olap><strong><code>/docs/pgsql/template/olap.yml</code></strong></a></td><td style=text-align:left>4-128C</td><td style=text-align:left>OLAP 分析处理</td><td style=text-align:left>大查询、高并行、长事务</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/template/crit><strong><code>/docs/pgsql/template/crit.yml</code></strong></a></td><td style=text-align:left>4-128C</td><td style=text-align:left>核心/金融业务</td><td style=text-align:left>数据安全、审计合规、零丢失</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/template/tiny><strong><code>/docs/pgsql/template/tiny.yml</code></strong></a></td><td style=text-align:left>1-3C</td><td style=text-align:left>微型实例</td><td style=text-align:left>资源受限、低配环境</td></tr></tbody></table><p>您可以通过 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数来选择使用哪个配置模板，默认为 <a href=/docs/pgsql/template/oltp><strong><code>/docs/pgsql/template/oltp.yml</code></strong></a>。</p><blockquote><p>通常，数据库调优模板 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 应当与机器调优模板 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> 配套使用。</p></blockquote><hr><h2 id=使用模板>使用模板</h2><p>要使用特定的配置模板，只需在集群定义中设置 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数。
建议同时设置 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> 参数，使操作系统级别的调优与数据库调优保持一致：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 配置模板（默认值）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统调优模板（默认值）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>对于核心金融业务场景，您可以使用 <a href=/docs/pgsql/template/crit><strong><code>/docs/pgsql/template/crit.yml</code></strong></a> 模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-finance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.21</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.22</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.23</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-finance</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 关键业务模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统关键业务调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>对于低配虚拟机或开发环境，可以使用 <a href=/docs/pgsql/template/tiny><strong><code>/docs/pgsql/template/tiny.yml</code></strong></a> 模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-dev</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.31</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=模板对比>模板对比</h2><p>四种模板在关键参数上有显著差异，以适应不同的业务场景。以下是主要差异对比：</p><h3 id=连接与内存>连接与内存</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>max_connections</strong></td><td style=text-align:left>500/1000</td><td style=text-align:left>500</td><td style=text-align:left>500/1000</td><td style=text-align:left>250</td></tr><tr><td style=text-align:left><strong>work_mem</strong> 范围</td><td style=text-align:left>64MB-1GB</td><td style=text-align:left>64MB-8GB</td><td style=text-align:left>64MB-1GB</td><td style=text-align:left>16MB-256MB</td></tr><tr><td style=text-align:left><strong>maintenance_work_mem</strong></td><td style=text-align:left>25% 共享缓冲区</td><td style=text-align:left>50% 共享缓冲区</td><td style=text-align:left>25% 共享缓冲区</td><td style=text-align:left>25% 共享缓冲区</td></tr><tr><td style=text-align:left><strong>max_locks_per_transaction</strong></td><td style=text-align:left>1-2x maxconn</td><td style=text-align:left>2-4x maxconn</td><td style=text-align:left>1-2x maxconn</td><td style=text-align:left>1-2x maxconn</td></tr></tbody></table><h3 id=并行查询>并行查询</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>max_worker_processes</strong></td><td style=text-align:left>cpu+8</td><td style=text-align:left>cpu+12</td><td style=text-align:left>cpu+8</td><td style=text-align:left>cpu+4</td></tr><tr><td style=text-align:left><strong>max_parallel_workers</strong></td><td style=text-align:left>50% cpu</td><td style=text-align:left>80% cpu</td><td style=text-align:left>50% cpu</td><td style=text-align:left>50% cpu</td></tr><tr><td style=text-align:left><strong>max_parallel_workers_per_gather</strong></td><td style=text-align:left>20% cpu (max 8)</td><td style=text-align:left>50% cpu</td><td style=text-align:left>0（禁用）</td><td style=text-align:left>0（禁用）</td></tr><tr><td style=text-align:left><strong>parallel_setup_cost</strong></td><td style=text-align:left>2000</td><td style=text-align:left>1000</td><td style=text-align:left>2000</td><td style=text-align:left>1000</td></tr><tr><td style=text-align:left><strong>parallel_tuple_cost</strong></td><td style=text-align:left>0.2</td><td style=text-align:left>0.1</td><td style=text-align:left>0.2</td><td style=text-align:left>0.1</td></tr></tbody></table><h3 id=同步复制>同步复制</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>synchronous_mode</strong></td><td style=text-align:left>取决于 pg_rpo</td><td style=text-align:left>取决于 pg_rpo</td><td style=text-align:left>强制开启</td><td style=text-align:left>取决于 pg_rpo</td></tr><tr><td style=text-align:left><strong>data_checksums</strong></td><td style=text-align:left>可选</td><td style=text-align:left>可选</td><td style=text-align:left>强制开启</td><td style=text-align:left>可选</td></tr></tbody></table><h3 id=vacuum-配置>Vacuum 配置</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>vacuum_cost_delay</strong></td><td style=text-align:left>20ms</td><td style=text-align:left>10ms</td><td style=text-align:left>20ms</td><td style=text-align:left>20ms</td></tr><tr><td style=text-align:left><strong>vacuum_cost_limit</strong></td><td style=text-align:left>2000</td><td style=text-align:left>10000</td><td style=text-align:left>2000</td><td style=text-align:left>2000</td></tr><tr><td style=text-align:left><strong>autovacuum_max_workers</strong></td><td style=text-align:left>3</td><td style=text-align:left>3</td><td style=text-align:left>3</td><td style=text-align:left>2</td></tr></tbody></table><h3 id=超时与安全>超时与安全</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>idle_in_transaction_session_timeout</strong></td><td style=text-align:left>10min</td><td style=text-align:left>禁用</td><td style=text-align:left>1min</td><td style=text-align:left>10min</td></tr><tr><td style=text-align:left><strong>log_min_duration_statement</strong></td><td style=text-align:left>100ms</td><td style=text-align:left>1000ms</td><td style=text-align:left>100ms</td><td style=text-align:left>100ms</td></tr><tr><td style=text-align:left><strong>default_statistics_target</strong></td><td style=text-align:left>400</td><td style=text-align:left>1000</td><td style=text-align:left>400</td><td style=text-align:left>200</td></tr><tr><td style=text-align:left><strong>track_activity_query_size</strong></td><td style=text-align:left>8KB</td><td style=text-align:left>8KB</td><td style=text-align:left>32KB</td><td style=text-align:left>8KB</td></tr><tr><td style=text-align:left><strong>log_connections</strong></td><td style=text-align:left>仅授权</td><td style=text-align:left>仅授权</td><td style=text-align:left>全部阶段</td><td style=text-align:left>默认</td></tr></tbody></table><h3 id=io-配置pg17>IO 配置（PG17+）</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>io_workers</strong></td><td style=text-align:left>25% cpu (4-16)</td><td style=text-align:left>50% cpu (4-32)</td><td style=text-align:left>25% cpu (4-8)</td><td style=text-align:left>3</td></tr><tr><td style=text-align:left><strong>temp_file_limit</strong></td><td style=text-align:left>1/20 磁盘</td><td style=text-align:left>1/5 磁盘</td><td style=text-align:left>1/20 磁盘</td><td style=text-align:left>1/20 磁盘</td></tr></tbody></table><hr><h2 id=选择建议>选择建议</h2><ul><li><p><a href=/docs/pgsql/template/oltp><strong>OLTP 模板</strong></a>：适用于大多数在线事务处理场景，是默认选择。适合电商、社交、游戏等高并发低延迟应用。</p></li><li><p><a href=/docs/pgsql/template/olap><strong>OLAP 模板</strong></a>：适用于数据仓库、BI 报表、ETL 等分析型负载。特点是允许大查询、高并行度、宽松的超时设置。</p></li><li><p><a href=/docs/pgsql/template/crit><strong>CRIT 模板</strong></a>：适用于金融交易、核心账务等对数据一致性和安全性有极高要求的场景。强制同步复制、数据校验和、完整审计日志。</p></li><li><p><a href=/docs/pgsql/template/tiny><strong>TINY 模板</strong></a>：适用于开发测试环境、资源受限的虚拟机、树莓派等场景。最小化资源占用，禁用并行查询。</p></li></ul><hr><h2 id=自定义模板>自定义模板</h2><p>您可以基于现有模板创建自定义配置模板。模板文件位于 Pigsty 安装目录的 <code>roles/pgsql/templates/</code> 下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>roles/pgsql/templates/
</span></span><span style=display:flex><span>├── oltp.yml    <span style=color:#8f5902;font-style:italic># OLTP 事务处理模板（默认）</span>
</span></span><span style=display:flex><span>├── olap.yml    <span style=color:#8f5902;font-style:italic># OLAP 分析处理模板</span>
</span></span><span style=display:flex><span>├── crit.yml    <span style=color:#8f5902;font-style:italic># CRIT 关键业务模板</span>
</span></span><span style=display:flex><span>└── tiny.yml    <span style=color:#8f5902;font-style:italic># TINY 微型实例模板</span>
</span></span></code></pre></div><p>创建自定义模板的步骤：</p><ol><li>复制一个现有模板作为基础</li><li>根据需要修改参数</li><li>将模板放置在 <code>roles/pgsql/templates/</code> 目录</li><li>在集群定义中通过 <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a> 引用新模板</li></ol><p>例如，创建一个名为 <code>myapp.yml</code> 的自定义模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp roles/pgsql/templates/oltp.yml roles/pgsql/templates/myapp.yml
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 编辑 myapp.yml 进行自定义</span>
</span></span></code></pre></div><p>然后在集群中使用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-myapp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp.yml</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>请注意，模板文件使用 Jinja2 模板语法，参数值会根据节点的实际资源（CPU、内存、磁盘）动态计算。</p><hr><h2 id=参数优化策略>参数优化策略</h2><p>了解更多关于模板参数优化的技术细节，请参阅 <a href=/docs/pgsql/template/tune><strong>参数优化策略</strong></a>，其中详细介绍了：</p><ul><li>内存参数调整（共享缓冲区、工作内存、最大连接数）</li><li>CPU 参数调整（并行查询工作进程配置）</li><li>存储空间参数（WAL 大小、临时文件限制）</li><li>手工调整参数的方法</li></ul><hr><h2 id=相关参数>相关参数</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：指定使用的 PostgreSQL 配置模板</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：指定使用的操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a>：恢复时间目标，影响故障切换超时</li><li><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a>：恢复点目标，影响同步复制模式</li><li><a href=/docs/pgsql/param#pg_max_conn><strong><code>pg_max_conn</code></strong></a>：覆盖模板的最大连接数</li><li><a href=/docs/pgsql/param#pg_shared_buffer_ratio><strong><code>pg_shared_buffer_ratio</code></strong></a>：共享缓冲区占内存比例</li><li><a href=/docs/pgsql/param#pg_storage_type><strong><code>pg_storage_type</code></strong></a>：存储类型，影响 IO 相关参数</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-c343b4e12cd241ebdb244700f6f7ae20>17.1 - 默认配置模板的参数优化策略说明</h1><div class=lead>了解在 Pigsty 中，预置的四种 Patroni 场景化模板所采用的不同参数优化策略</div><p>Pigsty 默认提供了四套场景化参数模板，可以通过 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数指定并使用。</p><ul><li><a href=/docs/pgsql/template/tiny><strong><code>tiny.yml</code></strong></a>：为小节点、虚拟机、小型演示优化（1-8核，1-16GB）</li><li><a href=/docs/pgsql/template/oltp><strong><code>oltp.yml</code></strong></a>：为OLTP工作负载和延迟敏感应用优化（4C8GB+）（默认模板）</li><li><a href=/docs/pgsql/template/olap><strong><code>olap.yml</code></strong></a>：为OLAP工作负载和吞吐量优化（4C8G+）</li><li><a href=/docs/pgsql/template/crit><strong><code>crit.yml</code></strong></a>：为数据一致性和关键应用优化（4C8G+）</li></ul><p>Pigsty 会针对这四种默认场景，采取不同的参数优化策略，如下所示：</p><hr><h2 id=内存参数调整>内存参数调整</h2><p>Pigsty 默认会检测系统的内存大小，并以此为依据设定最大连接数量与内存相关参数。</p><ul><li><a href=/docs/pgsql/param#pg_max_conn><strong><code>pg_max_conn</code></strong></a>：postgres 最大连接数，<code>auto</code> 将使用不同场景下的推荐值</li><li><a href=/docs/pgsql/param#pg_shared_buffer_ratio><strong><code>pg_shared_buffer_ratio</code></strong></a>：内存共享缓冲区比例，默认为 0.25</li></ul><p>默认情况下，Pigsty 使用 25% 的内存作为 PostgreSQL 共享缓冲区，剩余的 75% 作为操作系统缓存。</p><p>默认情况下，如果用户没有设置一个 <a href=/docs/pgsql/param#pg_max_conn><code>pg_max_conn</code></a> 最大连接数，Pigsty 会根据以下规则使用默认值：</p><ul><li>oltp: 500 (pgbouncer) / 1000 (postgres)</li><li>crit: 500 (pgbouncer) / 1000 (postgres)</li><li>tiny: 300</li><li>olap: 300</li></ul><p>其中对于 OLTP 与 CRIT 模版来说，如果服务没有指向 pgbouncer 连接池，而是直接连接 postgres 数据库，最大连接会翻倍至 1000 条。</p><p>决定最大连接数后，<code>work_mem</code> 会根据共享内存数量 / 最大连接数计算得到，并限定在 64MB ~ 1GB 的范围内。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#000>% raw %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% if pg_max_conn != &#39;auto&#39; and pg_max_conn|int &gt;= 20 %}{% set pg_max_connections = pg_max_conn|int %}{% else %}{% if pg_default_service_dest|default(&#39;postgres&#39;) == &#39;pgbouncer&#39; %}{% set pg_max_connections = 500 %}{% else %}{% set pg_max_connections = 1000 %}{% endif %}{% endif %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_max_prepared_transactions = pg_max_connections if &#39;citus&#39; in pg_libs else 0 %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_max_locks_per_transaction = (2 * pg_max_connections)|int if &#39;citus&#39; in pg_libs or &#39;timescaledb&#39; in pg_libs else pg_max_connections %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_shared_buffers = (node_mem_mb|int * pg_shared_buffer_ratio|float) | round(0, &#39;ceil&#39;) | int %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_maintenance_mem = (pg_shared_buffers|int * 0.25)|round(0, &#39;ceil&#39;)|int %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_effective_cache_size = node_mem_mb|int - pg_shared_buffers|int  %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_workmem =  ([ ([ (pg_shared_buffers / pg_max_connections)|round(0,&#39;floor&#39;)|int , 64 ])|max|int , 1024])|min|int %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% endraw %}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=cpu参数调整>CPU参数调整</h2><p>在 PostgreSQL 中，有 4 个与并行查询相关的重要参数，Pigsty 会自动根据当前系统的 CPU 核数进行参数优化。
在所有策略中，总并行进程数量（总预算）通常设置为 CPU 核数 + 8，且保底为 16 个，从而为逻辑复制与扩展预留足够的后台 worker 数量，OLAP 和 TINY 模板根据场景略有不同。</p><table class=full-width><thead><tr><th>OLTP</th><th>设置逻辑</th><th>范围限制</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td><code>max(100% CPU + 8, 16)</code></td><td>核数 + 4，保底 1，</td></tr><tr><td><code>max_parallel_workers</code></td><td><code>max(ceil(50% CPU), 2)</code></td><td>1/2 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td><code>max(ceil(33% CPU), 2)</code></td><td>1/3 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td><code>min(max(ceil(20% CPU), 2),8)</code></td><td>1/5 CPU 下取整，最少两个，最多 8 个</td></tr></tbody></table><table class=full-width><thead><tr><th>OLAP</th><th>设置逻辑</th><th>范围限制</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td><code>max(100% CPU + 12, 20)</code></td><td>核数 + 12，保底 20</td></tr><tr><td><code>max_parallel_workers</code></td><td><code>max(ceil(80% CPU, 2))</code></td><td>4/5 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td><code>max(ceil(33% CPU), 2)</code></td><td>1/3 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td><code>max(floor(50% CPU), 2)</code></td><td>1/2 CPU 上取整，最少两个</td></tr></tbody></table><table class=full-width><thead><tr><th>CRIT</th><th>设置逻辑</th><th>范围限制</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td><code>max(100% CPU + 8, 16)</code></td><td>核数 + 8，保底 16</td></tr><tr><td><code>max_parallel_workers</code></td><td><code>max(ceil(50% CPU), 2)</code></td><td>1/2 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td><code>max(ceil(33% CPU), 2)</code></td><td>1/3 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td><code>0</code>, 按需启用</td><td></td></tr></tbody></table><table class=full-width><thead><tr><th>TINY</th><th>设置逻辑</th><th>范围限制</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td><code>max(100% CPU + 4, 12)</code></td><td>核数 + 4，保底 12</td></tr><tr><td><code>max_parallel_workers</code></td><td><code>max(ceil(50% CPU) 1)</code></td><td>50% CPU 下取整，最少1个</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td><code>max(ceil(33% CPU), 1)</code></td><td>33% CPU 下取整，最少1个</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td>`0, 按需启用</td><td></td></tr></tbody></table><p>请注意，CRIT 和 TINY 模板直接通过设置 <code>max_parallel_workers_per_gather = 0 </code>关闭了并行查询。
用户可以按需在需要时设置此参数以启用并行查询。</p><p>OLTP 和 CRIT 模板都额外设置了以下参数，将并行查询的 Cost x 2，以降低使用并行查询的倾向。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_setup_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># double from 100 to increase parallel cost</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_tuple_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># double from 0.1 to increase parallel cost</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_table_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 4x default 8MB, prefer non-parallel scan</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_index_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>2MB  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 4x default 512kB, prefer non-parallel scan</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>请注意 <code>max_worker_processes</code> 参数的调整必须在重启后才能生效。此外，当从库的本参数配置值高于主库时，从库将无法启动。
此参数必须通过 patroni 配置管理进行调整，该参数由 Patroni 管理，用于确保主从配置一致，避免在故障切换时新从库无法启动。</p><hr><h2 id=存储空间参数>存储空间参数</h2><p>Pigsty 默认检测 <code>/data/postgres</code> 主数据目录所在磁盘的总空间，并以此作为依据指定下列参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#000>% raw %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth, 200])|min }}GB                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 1/20 disk size, max 200GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth * 4, 2000])|min }}GB            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 2/10 disk size, max 2000GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_slot_wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth * 6, 3000])|min }}GB  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 3/10 disk size, max 3000GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>temp_file_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth, 200])|min }}GB              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 1/20 of disk size, max 200GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% endraw %}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>temp_file_limit</code> 默认为磁盘空间的 5%，封顶不超过 200GB。</li><li><code>min_wal_size</code> 默认为磁盘空间的 5%，封顶不超过 200GB。</li><li><code>max_wal_size</code> 默认为磁盘空间的 20%，封顶不超过 2TB。</li><li><code>max_slot_wal_keep_size</code> 默认为磁盘空间的 30%，封顶不超过 3TB。</li></ul><p>作为特例， OLAP 模板允许 20% 的 <code>temp_file_limit</code> ，封顶不超过 2TB</p><hr><h2 id=手工调整参数>手工调整参数</h2><p>除了使用 Pigsty 自动配置的参数外，您还可以手工调整 PostgreSQL 参数。</p><p>使用 <code>pg edit-config &lt;cluster></code> 命令可以交互式编辑集群配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta
</span></span></code></pre></div><p>或者使用 <code>-p</code> 参数直接设置参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span> pg-meta
</span></span><span style=display:flex><span>pg edit-config --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&#39;</span> pg-meta
</span></span></code></pre></div><p>您也可以使用 Patroni REST API 来修改配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -u <span style=color:#4e9a06>&#39;postgres:Patroni.API&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    -d <span style=color:#4e9a06>&#39;{&#34;postgresql&#34;:{&#34;parameters&#34;: {&#34;log_min_duration_statement&#34;:200}}}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    -s -X PATCH http://10.10.10.10:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-04bbfb111fd00b28b14a77c5a5a92955>17.2 - OLTP 模板</h1><div class=lead>针对在线事务处理负载优化的 PostgreSQL 配置模板</div><p><code>oltp.yml</code> 是 Pigsty 的默认配置模板，针对<strong>在线事务处理</strong>（OLTP）负载进行了优化。适用于 4-128 核 CPU 的服务器，特点是高并发连接、低延迟响应、高事务吞吐量。</p><blockquote><p>建议同时使用 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>oltp</code> 进行操作系统级别的配套调优。</p></blockquote><hr><h2 id=适用场景>适用场景</h2><p>OLTP 模板适用于以下场景：</p><ul><li><strong>电商系统</strong>：订单处理、库存管理、用户交易</li><li><strong>社交应用</strong>：用户动态、消息推送、关注关系</li><li><strong>游戏后端</strong>：玩家数据、排行榜、游戏状态</li><li><strong>SaaS 应用</strong>：多租户业务系统</li><li><strong>Web 应用</strong>：常规的 CRUD 操作密集型应用</li></ul><p><strong>特征负载</strong>：</p><ul><li>大量短事务（毫秒级）</li><li>高并发连接（数百到数千）</li><li>读写比例通常在 7:3 到 9:1</li><li>对延迟敏感，要求快速响应</li><li>数据一致性要求高</li></ul><hr><h2 id=使用方法>使用方法</h2><p><a href=/docs/pgsql/template/oltp/><strong><code>oltp.yml</code></strong></a> 是默认模板，无需显式指定：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-oltp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># pg_conf: oltp.yml  # PostgreSQL 配置模板（默认值）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># node_tune: oltp    # 操作系统调优模板（默认值）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>或显式指定：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 配置模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统调优模板</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=参数详解>参数详解</h2><h3 id=连接管理>连接管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#000>/1000  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 取决于是否使用 pgbouncer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>当 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 为 <code>pgbouncer</code> 时，<code>max_connections</code> 设为 500</li><li>当流量直连 PostgreSQL 时，<code>max_connections</code> 设为 1000</li><li>可通过 <a href=/docs/pgsql/param#pg_max_conn><code>pg_max_conn</code></a> 参数覆盖</li></ul><h3 id=内存配置>内存配置</h3><p>OLTP 模板的内存分配策略：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>计算公式</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>内存 × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>默认比例 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × 25%</td><td style=text-align:left>用于 VACUUM、CREATE INDEX</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>64MB - 1GB</td><td style=text-align:left>根据 shared_buffers/max_connections 计算</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>总内存 - shared_buffers</td><td style=text-align:left>可用于缓存的预估内存</td></tr></tbody></table><p><strong>work_mem 计算逻辑</strong>：</p><pre tabindex=0><code>work_mem = min(max(shared_buffers / max_connections, 64MB), 1GB)
</code></pre><p>这确保每个连接有足够的排序/哈希内存，但不会过度分配。</p><h3 id=并行查询>并行查询</h3><p>OLTP 模板对并行查询做了适度限制，以避免并行查询抢占过多资源影响其他事务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cpu + 8 (最小16)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000>% × cpu (最小2)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000>% × cpu (2-8)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_maintenance_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000>% × cpu (最小2)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>同时提高了并行查询的成本估算，让优化器倾向于串行执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_setup_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 默认值 1000 的两倍</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_tuple_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 默认值 0.1 的两倍</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_table_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认值 8MB 的四倍，倾向于不使用并行扫描</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_index_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>2MB   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认值 512kB 的四倍，倾向于不使用并行扫描</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=wal-配置>WAL 配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/20 (最大200GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/5 (最大2000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_slot_wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘×3/10 (最大3000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_flush_after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>commit_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>commit_siblings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>checkpoint_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>15min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>checkpoint_completion_target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.80</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这些设置平衡了数据安全性和写入性能。</p><h3 id=vacuum-配置>Vacuum 配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 每轮 vacuum 后休眠</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 每轮 vacuum 的代价上限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_max_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_naptime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_vacuum_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.08</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 8% 表变化触发 vacuum</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_analyze_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.04</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 4% 表变化触发 analyze</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_freeze_max_age</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>OLTP 模板使用保守的 vacuum 设置，避免 vacuum 操作影响在线事务性能。</p><h3 id=查询优化>查询优化</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>random_page_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.1</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># SSD 优化</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>effective_io_concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># SSD 并发 IO</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>default_statistics_target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 统计信息精度</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这些设置让优化器能够生成更好的查询计划。</p><h3 id=日志与监控>日志与监控</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 记录超过 100ms 的慢查询</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 记录 DDL 语句</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_checkpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_lock_waits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_temp_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 记录超过 1MB 的临时文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_autovacuum_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=客户端超时>客户端超时</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deadlock_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>10 分钟的空闲事务超时可以防止长时间持有锁的僵尸事务。</p><h3 id=扩展配置>扩展配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># auto_explain</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_analyze</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_verbose</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_nested_statements</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_stat_statements</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.max</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_utility</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_planning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=与其他模板的对比>与其他模板的对比</h2><table class=full-width><thead><tr><th style=text-align:left>特性</th><th style=text-align:left><a href=/docs/pgsql/template/oltp/><strong>OLTP</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/olap/><strong>OLAP</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/crit/><strong>CRIT</strong></a></th></tr></thead><tbody><tr><td style=text-align:left>max_connections</td><td style=text-align:left>500-1000</td><td style=text-align:left>500</td><td style=text-align:left>500-1000</td></tr><tr><td style=text-align:left>work_mem</td><td style=text-align:left>64MB-1GB</td><td style=text-align:left>64MB-8GB</td><td style=text-align:left>64MB-1GB</td></tr><tr><td style=text-align:left>并行查询</td><td style=text-align:left>适度限制</td><td style=text-align:left>激进启用</td><td style=text-align:left>禁用</td></tr><tr><td style=text-align:left>vacuum 激进度</td><td style=text-align:left>保守</td><td style=text-align:left>激进</td><td style=text-align:left>保守</td></tr><tr><td style=text-align:left>事务超时</td><td style=text-align:left>10min</td><td style=text-align:left>禁用</td><td style=text-align:left>1min</td></tr><tr><td style=text-align:left>慢查询阈值</td><td style=text-align:left>100ms</td><td style=text-align:left>1000ms</td><td style=text-align:left>100ms</td></tr></tbody></table><h3 id=为什么选择-oltp-而非-olap>为什么选择 OLTP 而非 OLAP？</h3><ul><li>您的查询大多数是简单的点查和范围查询</li><li>事务响应时间要求在毫秒级</li><li>有大量并发连接</li><li>不需要执行复杂的分析查询</li></ul><h3 id=为什么选择-oltp-而非-crit>为什么选择 OLTP 而非 CRIT？</h3><ul><li>可以接受极小概率的数据丢失（异步复制）</li><li>不需要完整的审计日志</li><li>希望获得更好的写入性能</li></ul><hr><h2 id=性能调优建议>性能调优建议</h2><h3 id=连接池>连接池</h3><p>对于高并发场景，强烈建议使用 PgBouncer 连接池：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbouncer </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_poolmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 事务级池化</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=只读分离>只读分离</h3><p>使用只读从库分担读取负载：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=监控指标>监控指标</h3><p>关注以下监控指标：</p><ul><li><strong>连接数</strong>：活跃连接数、等待连接数</li><li><strong>事务率</strong>：TPS、提交/回滚比例</li><li><strong>响应时间</strong>：查询延迟百分位（p50/p95/p99）</li><li><strong>锁等待</strong>：锁等待时间、死锁次数</li><li><strong>复制延迟</strong>：从库延迟时间和字节数</li></ul><hr><h2 id=参考资料>参考资料</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：PostgreSQL 配置模板选择参数</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/template/olap/><strong>OLAP 模板</strong></a>：分析处理模板对比</li><li><a href=/docs/pgsql/template/crit/><strong>CRIT 模板</strong></a>：关键业务模板对比</li><li><a href=/docs/pgsql/template/tiny/><strong>TINY 模板</strong></a>：微型实例模板对比</li><li><a href=/docs/pgsql/config/cluster>集群配置</a>：PostgreSQL 集群类型配置</li><li><a href=/docs/concept/ha>高可用</a>：高可用架构设计</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-571aa5133064fa24ac707a69e4d84659>17.3 - OLAP 模板</h1><div class=lead>针对在线分析处理负载优化的 PostgreSQL 配置模板</div><p><code>olap.yml</code> 是针对<strong>在线分析处理</strong>（OLAP）负载优化的配置模板。适用于 4-128 核 CPU 的服务器，特点是支持大查询、高并行度、宽松的超时设置和激进的 Vacuum 策略。</p><blockquote><p>建议同时使用 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>olap</code> 进行操作系统级别的配套调优。</p></blockquote><hr><h2 id=适用场景>适用场景</h2><p>OLAP 模板适用于以下场景：</p><ul><li><strong>数据仓库</strong>：历史数据存储、多维分析</li><li><strong>BI 报表</strong>：复杂报表查询、仪表盘数据源</li><li><strong>ETL 处理</strong>：数据抽取、转换、加载</li><li><strong>数据分析</strong>：Ad-hoc 查询、数据探索</li><li><strong>HTAP 混合负载</strong>：分析型从库</li></ul><p><strong>特征负载</strong>：</p><ul><li>复杂查询（秒级到分钟级）</li><li>低并发连接（数十到数百）</li><li>读密集型，写入通常是批量操作</li><li>对吞吐量敏感，可以容忍较高延迟</li><li>需要扫描大量数据</li></ul><hr><h2 id=使用方法>使用方法</h2><p>在集群定义中指定 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <code>olap.yml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-olap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-olap</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 分析处理模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统分析处理调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>也可以将 <a href=/docs/pgsql/template/olap/><strong><code>olap.yml</code></strong></a> 模板用于专用的离线从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-mixed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: offline, pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 离线分析从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-mixed</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主库和在线从库使用 OLTP 模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统 OLTP 调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=参数详解>参数详解</h2><h3 id=连接管理>连接管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>OLAP 场景通常不需要大量连接，500 个连接足以应对大多数分析负载。</p><h3 id=内存配置>内存配置</h3><p>OLAP 模板的内存分配策略更为激进：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>计算公式</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>内存 × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>默认比例 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × <strong>50%</strong></td><td style=text-align:left>加速索引创建和 VACUUM</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>64MB - <strong>8GB</strong></td><td style=text-align:left>更大的排序/哈希内存</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>总内存 - shared_buffers</td><td style=text-align:left>可用于缓存的预估内存</td></tr></tbody></table><p><strong>work_mem 计算逻辑</strong>（与 OLTP 不同）：</p><pre tabindex=0><code>work_mem = min(max(shared_buffers / max_connections, 64MB), 8GB)
</code></pre><p>更大的 <code>work_mem</code> 允许更大的排序和哈希操作在内存中完成，避免磁盘溢出。</p><h3 id=锁与事务>锁与事务</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_locks_per_transaction</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span>-<span style=color:#000>4x maxconn  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLTP 是 1-2x</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>OLAP 查询可能涉及更多表（分区表、大量 JOIN），因此需要更多的锁槽。</p><h3 id=并行查询>并行查询</h3><p>OLAP 模板激进启用并行查询：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes: cpu + 12 (最小20)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cpu + 8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers: 80% × cpu (最小2)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000>%</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather: 50% × cpu   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000>% (最大8)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_maintenance_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000>% × cpu</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>并行查询成本保持默认值，让优化器更倾向于选择并行计划：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># parallel_setup_cost: 1000    # 默认值，不加倍</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># parallel_tuple_cost: 0.1     # 默认值，不加倍</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>同时启用分区智能优化：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>enable_partitionwise_join</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 分区表智能 JOIN</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>enable_partitionwise_aggregate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 分区表智能聚合</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=io-配置pg17>IO 配置（PG17+）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>io_workers: 50% × cpu (4-32)    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000>% (4-16)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>更多的 IO 工作线程支持并行扫描大表。</p><h3 id=wal-配置>WAL 配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/20 (最大200GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/5 (最大2000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_slot_wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘×3/10 (最大3000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>temp_file_limit: 磁盘/5 (最大2000GB)   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/20</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>更大的 <code>temp_file_limit</code> 允许更大的中间结果溢出到磁盘。</p><h3 id=vacuum-配置>Vacuum 配置</h3><p>OLAP 模板使用更激进的 vacuum 设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_delay: 10ms         # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms，更快的 vacuum</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_limit: 10000        # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#000>，每轮更多工作</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_max_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_naptime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_vacuum_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.08</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_analyze_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.04</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>分析型数据库通常有大量批量写入，需要更激进的 vacuum 策略来回收空间。</p><h3 id=查询优化>查询优化</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>random_page_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>effective_io_concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>default_statistics_target: 1000    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#000>，更精确的统计信息</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>更高的 <code>default_statistics_target</code> 提供更精确的查询计划，对复杂分析查询尤为重要。</p><h3 id=日志与监控>日志与监控</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>100ms，放宽慢查询阈值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_checkpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_lock_waits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_temp_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_autovacuum_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_cost_delay_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># PG18+，跟踪 vacuum 代价延迟</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=客户端超时>客户端超时</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deadlock_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout: 0   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min，禁用</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>分析查询可能需要长时间持有事务，因此禁用空闲事务超时。</p><hr><h2 id=与-oltp-模板的主要差异>与 OLTP 模板的主要差异</h2><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left><a href=/docs/pgsql/template/olap/><strong>OLAP</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/oltp/><strong>OLTP</strong></a></th><th style=text-align:left>差异原因</th></tr></thead><tbody><tr><td style=text-align:left>max_connections</td><td style=text-align:left>500</td><td style=text-align:left>500-1000</td><td style=text-align:left>分析负载连接数少</td></tr><tr><td style=text-align:left>work_mem 上限</td><td style=text-align:left>8GB</td><td style=text-align:left>1GB</td><td style=text-align:left>支持更大的内存排序</td></tr><tr><td style=text-align:left>maintenance_work_mem</td><td style=text-align:left>50% buffer</td><td style=text-align:left>25% buffer</td><td style=text-align:left>加速索引创建</td></tr><tr><td style=text-align:left>max_locks_per_transaction</td><td style=text-align:left>2-4x</td><td style=text-align:left>1-2x</td><td style=text-align:left>更多表参与查询</td></tr><tr><td style=text-align:left>max_parallel_workers</td><td style=text-align:left>80% cpu</td><td style=text-align:left>50% cpu</td><td style=text-align:left>激进并行</td></tr><tr><td style=text-align:left>max_parallel_workers_per_gather</td><td style=text-align:left>50% cpu</td><td style=text-align:left>20% cpu</td><td style=text-align:left>激进并行</td></tr><tr><td style=text-align:left>parallel_setup_cost</td><td style=text-align:left>1000</td><td style=text-align:left>2000</td><td style=text-align:left>默认值，鼓励并行</td></tr><tr><td style=text-align:left>parallel_tuple_cost</td><td style=text-align:left>0.1</td><td style=text-align:left>0.2</td><td style=text-align:left>默认值，鼓励并行</td></tr><tr><td style=text-align:left>enable_partitionwise_join</td><td style=text-align:left>on</td><td style=text-align:left>off</td><td style=text-align:left>分区表优化</td></tr><tr><td style=text-align:left>enable_partitionwise_aggregate</td><td style=text-align:left>on</td><td style=text-align:left>off</td><td style=text-align:left>分区表优化</td></tr><tr><td style=text-align:left>vacuum_cost_delay</td><td style=text-align:left>10ms</td><td style=text-align:left>20ms</td><td style=text-align:left>激进 vacuum</td></tr><tr><td style=text-align:left>vacuum_cost_limit</td><td style=text-align:left>10000</td><td style=text-align:left>2000</td><td style=text-align:left>激进 vacuum</td></tr><tr><td style=text-align:left>temp_file_limit</td><td style=text-align:left>1/5 磁盘</td><td style=text-align:left>1/20 磁盘</td><td style=text-align:left>允许更大临时文件</td></tr><tr><td style=text-align:left>io_workers</td><td style=text-align:left>50% cpu</td><td style=text-align:left>25% cpu</td><td style=text-align:left>更多并行 IO</td></tr><tr><td style=text-align:left>log_min_duration_statement</td><td style=text-align:left>1000ms</td><td style=text-align:left>100ms</td><td style=text-align:left>放宽慢查询阈值</td></tr><tr><td style=text-align:left>default_statistics_target</td><td style=text-align:left>1000</td><td style=text-align:left>400</td><td style=text-align:left>更精确统计</td></tr><tr><td style=text-align:left>idle_in_transaction_session_timeout</td><td style=text-align:left>禁用</td><td style=text-align:left>10min</td><td style=text-align:left>允许长事务</td></tr></tbody></table><hr><h2 id=性能调优建议>性能调优建议</h2><h3 id=结合-timescaledb>结合 TimescaleDB</h3><p>OLAP 模板与 TimescaleDB 配合使用效果极佳：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-timeseries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>timescaledb</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=结合-pg_duckdb>结合 pg_duckdb</h3><p>对于极致的分析性能，可以结合 pg_duckdb：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-analytics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_duckdb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=列式存储>列式存储</h3><p>考虑使用 Citus 的列式存储或 pg_mooncake：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>citus_columnar </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 或 pg_mooncake</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=资源隔离>资源隔离</h3><p>对于混合负载，建议将分析查询隔离到专用从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-mixed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLTP 写入</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLTP 读取</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLAP 分析</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-mixed</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=监控指标>监控指标</h3><p>关注以下监控指标：</p><ul><li><strong>查询时间</strong>：长查询的执行时间分布</li><li><strong>并行度</strong>：并行工作进程的使用率</li><li><strong>临时文件</strong>：临时文件的大小和数量</li><li><strong>磁盘 IO</strong>：顺序扫描和索引扫描的 IO 量</li><li><strong>缓存命中率</strong>：shared_buffers 和 OS 缓存的命中率</li></ul><hr><h2 id=参考资料>参考资料</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：PostgreSQL 配置模板选择参数</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/template/oltp/><strong>OLTP 模板</strong></a>：事务处理模板对比</li><li><a href=/docs/pgsql/template/crit/><strong>CRIT 模板</strong></a>：关键业务模板对比</li><li><a href=/docs/pgsql/template/tiny/><strong>TINY 模板</strong></a>：微型实例模板对比</li><li><a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a>：专用分析实例</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7cf828587f72da3b425e1bd025ccbacf>17.4 - CRIT 模板</h1><div class=lead>针对核心金融业务优化的 PostgreSQL 配置模板，强调数据安全与审计合规</div><p><code>crit.yml</code> 是针对<strong>核心金融业务</strong>优化的配置模板。适用于 4-128 核 CPU 的服务器，特点是强制同步复制、数据校验和、完整审计日志、严格的安全设置。这个模板牺牲一定的性能来换取最高级别的数据安全性。</p><blockquote><p>建议同时使用 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>crit</code> 进行操作系统级别的配套调优，优化脏页数量。</p></blockquote><hr><h2 id=适用场景>适用场景</h2><p>CRIT 模板适用于以下场景：</p><ul><li><strong>金融交易</strong>：银行转账、支付清算、证券交易</li><li><strong>核心账务</strong>：总账系统、会计系统</li><li><strong>合规审计</strong>：需要完整操作记录的业务</li><li><strong>关键业务</strong>：任何不能容忍数据丢失的场景</li></ul><p><strong>特征需求</strong>：</p><ul><li>零数据丢失（RPO = 0）</li><li>数据完整性校验</li><li>完整的审计日志</li><li>严格的安全策略</li><li>可以接受一定的性能损失</li></ul><hr><h2 id=使用方法>使用方法</h2><p>在集群定义中指定 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <code>crit.yml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-finance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-finance</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 关键业务模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统关键业务调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>建议</strong>：关键业务集群至少配置 3 个节点，以确保在一个节点故障时仍能保持同步复制。</p><hr><h2 id=核心特性>核心特性</h2><h3 id=强制同步复制>强制同步复制</h3><p>CRIT 模板<strong>强制启用同步复制</strong>，无论 <a href=/docs/pgsql/param#pg_rpo><code>pg_rpo</code></a> 设置为何值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 强制开启，不受 pg_rpo 影响</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这意味着每次事务提交都必须等待至少一个从库确认写入，确保 <strong>RPO = 0</strong>（零数据丢失）。</p><p><strong>代价</strong>：写入延迟会增加（通常增加 1-5ms，取决于网络延迟）。</p><h3 id=强制数据校验和>强制数据校验和</h3><p>CRIT 模板<strong>强制启用数据校验和</strong>，无论 <a href=/docs/pgsql/param#pg_checksum><code>pg_checksum</code></a> 设置为何值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>initdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>data-checksums  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 强制启用，不检查 pg_checksum 参数</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>数据校验和可以检测到磁盘静默损坏（bit rot），这对金融数据尤为重要。</p><h3 id=禁用并行查询>禁用并行查询</h3><p>CRIT 模板禁用了并行查询的 gather 操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 禁用并行查询</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>同时提高了并行查询的成本估算：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_setup_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_tuple_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_table_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_index_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>2MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>原因</strong>：并行查询可能导致查询延迟不稳定，对于延迟敏感的金融交易场景，稳定可预测的性能更为重要。</p><hr><h2 id=参数详解>参数详解</h2><h3 id=连接管理>连接管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#000>/1000  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 取决于是否使用 pgbouncer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>与 OLTP 模板相同。</p><h3 id=内存配置>内存配置</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>计算公式</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>内存 × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>默认比例 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × 25%</td><td style=text-align:left>用于 VACUUM、CREATE INDEX</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>64MB - 1GB</td><td style=text-align:left>与 OLTP 相同</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>总内存 - shared_buffers</td><td style=text-align:left>可用于缓存的预估内存</td></tr></tbody></table><h3 id=wal-配置关键差异>WAL 配置（关键差异）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_delay: 10ms              # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms，更频繁刷新</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_flush_after: 0           # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1MB，立即刷新，不缓冲</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_replication_slot_timeout: 3d   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>7d，更严格的槽位清理</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>wal_writer_flush_after: 0</code> 确保每次 WAL 写入都立即刷到磁盘，最大程度减少数据丢失风险。</p><h3 id=复制配置pg15->复制配置（PG15-）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_defer_cleanup_age</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 仅 PG15 及以下版本</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这个参数保留最近 50 万个事务的变更不被 vacuum 清理，为从库提供更多的追赶缓冲。</p><h3 id=审计日志关键差异>审计日志（关键差异）</h3><p>CRIT 模板启用完整的连接审计：</p><p><strong>PostgreSQL 18+</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;receipt,authentication,authorization&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>PostgreSQL 17 及以下</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_disconnections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这记录了每个连接的完整生命周期，包括：</p><ul><li>连接接收</li><li>认证过程</li><li>授权结果</li><li>断开连接</li></ul><h3 id=查询日志>查询日志</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># 记录超过 100ms 的查询</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 记录所有 DDL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size: 32768    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#000>，保存完整查询</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>32KB 的 <code>track_activity_query_size</code> 确保能捕获完整的长查询文本。</p><h3 id=统计跟踪>统计跟踪</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_cost_delay_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># PG18+，跟踪 vacuum 代价延迟</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32768</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=客户端超时关键差异>客户端超时（关键差异）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout: 1min   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min，更严格</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>1 分钟的空闲事务超时可以快速释放持有锁的僵尸事务，避免阻塞其他交易。</p><h3 id=扩展配置>扩展配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;$libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>注意</strong>：CRIT 模板默认加载 <code>passwordcheck</code> 扩展，强制密码复杂度检查。</p><hr><h2 id=与-oltp-模板的主要差异>与 OLTP 模板的主要差异</h2><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left><a href=/docs/pgsql/template/crit/><strong>CRIT</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/oltp/><strong>OLTP</strong></a></th><th style=text-align:left>差异原因</th></tr></thead><tbody><tr><td style=text-align:left>synchronous_mode</td><td style=text-align:left><strong>强制 true</strong></td><td style=text-align:left>取决于 pg_rpo</td><td style=text-align:left>零数据丢失</td></tr><tr><td style=text-align:left>data-checksums</td><td style=text-align:left><strong>强制启用</strong></td><td style=text-align:left>可选</td><td style=text-align:left>数据完整性</td></tr><tr><td style=text-align:left>max_parallel_workers_per_gather</td><td style=text-align:left><strong>0</strong></td><td style=text-align:left>20% cpu</td><td style=text-align:left>稳定延迟</td></tr><tr><td style=text-align:left>wal_writer_delay</td><td style=text-align:left>10ms</td><td style=text-align:left>20ms</td><td style=text-align:left>更频繁刷新</td></tr><tr><td style=text-align:left>wal_writer_flush_after</td><td style=text-align:left><strong>0</strong></td><td style=text-align:left>1MB</td><td style=text-align:left>立即刷新</td></tr><tr><td style=text-align:left>idle_replication_slot_timeout</td><td style=text-align:left>3d</td><td style=text-align:left>7d</td><td style=text-align:left>更严格清理</td></tr><tr><td style=text-align:left>idle_in_transaction_session_timeout</td><td style=text-align:left><strong>1min</strong></td><td style=text-align:left>10min</td><td style=text-align:left>快速释放锁</td></tr><tr><td style=text-align:left>track_activity_query_size</td><td style=text-align:left><strong>32KB</strong></td><td style=text-align:left>8KB</td><td style=text-align:left>完整查询记录</td></tr><tr><td style=text-align:left>log_connections</td><td style=text-align:left><strong>完整记录</strong></td><td style=text-align:left>仅授权</td><td style=text-align:left>审计合规</td></tr><tr><td style=text-align:left>log_disconnections</td><td style=text-align:left><strong>on</strong></td><td style=text-align:left>off</td><td style=text-align:left>审计合规</td></tr><tr><td style=text-align:left>passwordcheck</td><td style=text-align:left><strong>启用</strong></td><td style=text-align:left>未启用</td><td style=text-align:left>密码安全</td></tr><tr><td style=text-align:left>vacuum_defer_cleanup_age</td><td style=text-align:left>500000</td><td style=text-align:left>0</td><td style=text-align:left>从库追赶缓冲</td></tr></tbody></table><hr><h2 id=性能影响>性能影响</h2><p>使用 CRIT 模板会带来以下性能影响：</p><h3 id=写入延迟增加>写入延迟增加</h3><p>同步复制会增加 1-5ms 的写入延迟（取决于网络）：</p><pre tabindex=0><code>异步复制: 提交 -&gt; 本地刷盘 -&gt; 返回客户端
同步复制: 提交 -&gt; 本地刷盘 -&gt; 等待从库确认 -&gt; 返回客户端
</code></pre><h3 id=写入吞吐量下降>写入吞吐量下降</h3><p>由于需要等待从库确认，写入 TPS 可能下降 10-30%。</p><h3 id=查询延迟更稳定>查询延迟更稳定</h3><p>禁用并行查询后，查询延迟更加可预测，没有并行查询启动的开销波动。</p><h3 id=资源开销略有增加>资源开销略有增加</h3><p>更频繁的 WAL 刷新和完整的审计日志会带来额外的 IO 开销。</p><hr><h2 id=高可用配置>高可用配置</h2><h3 id=最小推荐配置>最小推荐配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-critical</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-critical</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 关键业务模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统关键业务调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>3 节点配置确保在一个节点故障时仍能保持同步复制。</p><h3 id=跨机房部署>跨机房部署</h3><p>对于金融级别的容灾要求：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-critical</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 机房 A</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica, pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 机房 A</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.20.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica, pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 机房 B（备用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-critical</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 关键业务模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统关键业务调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=法定人数提交>法定人数提交</h3><p>对于更高的一致性要求，可以配置多个同步从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-critical
</span></span><span style=display:flex><span>synchronous_mode: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>synchronous_node_count: <span style=color:#0000cf;font-weight:700>2</span>    <span style=color:#8f5902;font-style:italic># 需要 2 个从库确认</span>
</span></span></code></pre></div><hr><h2 id=安全加固建议>安全加固建议</h2><h3 id=密码策略>密码策略</h3><p>CRIT 模板已启用 <code>passwordcheck</code>，建议进一步配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 设置密码最小长度
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>password_encryption</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;scram-sha-256&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=审计扩展>审计扩展</h3><p>考虑启用 <code>pgaudit</code> 扩展进行更详细的审计：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain, pgaudit&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgaudit.log</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;ddl, role, write&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=网络隔离>网络隔离</h3><p>确保数据库网络与业务网络隔离，使用 <a href=/docs/pgsql/config/hba>HBA 规则</a> 限制访问。</p><hr><h2 id=监控指标>监控指标</h2><p>对于关键业务集群，重点关注：</p><ul><li><strong>复制延迟</strong>：同步复制延迟应接近 0</li><li><strong>事务提交时间</strong>：p99 延迟</li><li><strong>锁等待</strong>：长时间锁等待可能影响业务</li><li><strong>检查点</strong>：检查点持续时间和频率</li><li><strong>WAL 生成速率</strong>：预测磁盘空间需求</li></ul><hr><h2 id=参考资料>参考资料</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：PostgreSQL 配置模板选择参数</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a>：恢复点目标参数</li><li><a href=/docs/pgsql/template/oltp/><strong>OLTP 模板</strong></a>：事务处理模板对比</li><li><a href=/docs/pgsql/template/olap/><strong>OLAP 模板</strong></a>：分析处理模板对比</li><li><a href=/docs/pgsql/template/tiny/><strong>TINY 模板</strong></a>：微型实例模板对比</li><li><a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a>：同步复制配置</li><li><a href=/docs/pgsql/config/cluster#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4>法定人数提交</a>：更高一致性级别</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-609856237df74f1f0f6e5fba1111e545>17.5 - TINY 模板</h1><div class=lead>针对微型实例和资源受限环境优化的 PostgreSQL 配置模板</div><p><code>tiny.yml</code> 是针对<strong>微型实例</strong>和资源受限环境优化的配置模板。适用于 1-3 核 CPU 的服务器，特点是最小化资源占用、保守的内存分配、禁用并行查询。</p><blockquote><p>建议同时使用 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>tiny</code> 进行操作系统级别的配套调优。</p></blockquote><hr><h2 id=适用场景>适用场景</h2><p>TINY 模板适用于以下场景：</p><ul><li><strong>开发测试</strong>：本地开发环境、CI/CD 测试</li><li><strong>低配虚拟机</strong>：1-2 核 CPU、1-4GB 内存的云主机</li><li><strong>边缘计算</strong>：树莓派、嵌入式设备</li><li><strong>Demo 演示</strong>：快速体验 Pigsty 功能</li><li><strong>个人项目</strong>：资源有限的个人博客、小型应用</li></ul><p><strong>资源限制</strong>：</p><ul><li>1-3 核 CPU</li><li>1-8 GB 内存</li><li>有限的磁盘空间</li><li>可能与其他服务共享资源</li></ul><hr><h2 id=使用方法>使用方法</h2><p>在集群定义中指定 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <code>tiny.yml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-dev</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>单节点开发环境：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>127.0.0.1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-local</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=参数详解>参数详解</h2><h3 id=连接管理>连接管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections: 250   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500-1000</span><span style=color:#000>，减少连接开销</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>微型实例不需要处理大量并发连接，250 个连接足以应对开发测试场景。</p><h3 id=内存配置>内存配置</h3><p>TINY 模板使用保守的内存分配策略：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>计算公式</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>内存 × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>默认比例 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × 25%</td><td style=text-align:left>用于 VACUUM、CREATE INDEX</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>16MB - <strong>256MB</strong></td><td style=text-align:left>更小的排序/哈希内存</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>总内存 - shared_buffers</td><td style=text-align:left>可用于缓存的预估内存</td></tr></tbody></table><p><strong>work_mem 计算逻辑</strong>（与 OLTP 不同）：</p><pre tabindex=0><code>work_mem = min(max(shared_buffers / max_connections, 16MB), 256MB)
</code></pre><p>更小的 <code>work_mem</code> 上限（256MB vs OLTP 的 1GB）避免内存溢出。</p><h3 id=并行查询完全禁用>并行查询（完全禁用）</h3><p>TINY 模板完全禁用了并行查询：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes: cpu + 4 (最小12)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cpu + 8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers: 50% × cpu (最小1)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000>% (最小2)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 禁用并行查询</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_maintenance_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000>% × cpu (最小1)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>max_parallel_workers_per_gather: 0</code> 确保查询不会启动并行工作进程，避免在低核心环境下争抢资源。</p><h3 id=io-配置pg17>IO 配置（PG17+）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>io_workers: 3   # 固定值，OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000>% cpu (4-16)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>固定的低 IO 工作线程数量，适合资源受限环境。</p><h3 id=vacuum-配置>Vacuum 配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_max_workers: 2          # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000>，减少一个工作进程</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_naptime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># autovacuum_vacuum_scale_factor 使用默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># autovacuum_analyze_scale_factor 使用默认值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>减少 autovacuum 工作进程数量，降低后台资源占用。</p><h3 id=查询优化>查询优化</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>random_page_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>effective_io_concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>default_statistics_target: 200     # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#000>，降低统计精度以节省空间</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>较低的 <code>default_statistics_target</code> 减少 <code>pg_statistic</code> 表的大小。</p><h3 id=日志配置>日志配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 与 OLTP 相同</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_checkpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_lock_waits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_temp_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># log_connections 使用默认设置（不额外记录）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>TINY 模板不启用额外的连接日志，以减少日志量。</p><h3 id=客户端超时>客户端超时</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deadlock_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 与 OLTP 相同</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=扩展配置>扩展配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.max: 2500      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000>，减少内存占用</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_utility</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_planning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>pg_stat_statements.max</code> 从 10000 降到 2500，减少约 75% 的内存占用。</p><hr><h2 id=与-oltp-模板的主要差异>与 OLTP 模板的主要差异</h2><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left><a href=/docs/pgsql/template/tiny/><strong>TINY</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/oltp/><strong>OLTP</strong></a></th><th style=text-align:left>差异原因</th></tr></thead><tbody><tr><td style=text-align:left>max_connections</td><td style=text-align:left><strong>250</strong></td><td style=text-align:left>500-1000</td><td style=text-align:left>减少连接开销</td></tr><tr><td style=text-align:left>work_mem 上限</td><td style=text-align:left><strong>256MB</strong></td><td style=text-align:left>1GB</td><td style=text-align:left>避免内存溢出</td></tr><tr><td style=text-align:left>max_worker_processes</td><td style=text-align:left>cpu+4</td><td style=text-align:left>cpu+8</td><td style=text-align:left>减少后台进程</td></tr><tr><td style=text-align:left>max_parallel_workers_per_gather</td><td style=text-align:left><strong>0</strong></td><td style=text-align:left>20% cpu</td><td style=text-align:left>禁用并行查询</td></tr><tr><td style=text-align:left>autovacuum_max_workers</td><td style=text-align:left><strong>2</strong></td><td style=text-align:left>3</td><td style=text-align:left>减少后台负载</td></tr><tr><td style=text-align:left>default_statistics_target</td><td style=text-align:left><strong>200</strong></td><td style=text-align:left>400</td><td style=text-align:left>节省空间</td></tr><tr><td style=text-align:left>pg_stat_statements.max</td><td style=text-align:left><strong>2500</strong></td><td style=text-align:left>10000</td><td style=text-align:left>减少内存占用</td></tr><tr><td style=text-align:left>io_workers</td><td style=text-align:left><strong>3</strong></td><td style=text-align:left>25% cpu</td><td style=text-align:left>固定低值</td></tr></tbody></table><hr><h2 id=资源估算>资源估算</h2><p>以下是 TINY 模板在不同配置下的资源使用估算：</p><h3 id=1-核-1gb-内存>1 核 1GB 内存</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~64MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~12</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>PostgreSQL 进程内存占用</strong>：约 400-600MB</p><h3 id=2-核-4gb-内存>2 核 4GB 内存</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~1GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~32MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~12</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>PostgreSQL 进程内存占用</strong>：约 1.5-2GB</p><h3 id=4-核-8gb-内存>4 核 8GB 内存</h3><p>此配置建议使用 OLTP 模板而非 TINY 模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-small</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 4核8GB可以使用OLTP模板</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=性能调优建议>性能调优建议</h2><h3 id=进一步减少资源>进一步减少资源</h3><p>如果资源极度受限，可以考虑：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 进一步减少</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MB         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 进一步减少</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>8MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=禁用不需要的扩展>禁用不需要的扩展</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 只保留必要扩展</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=关闭不需要的功能>关闭不需要的功能</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 禁用 IO 时间跟踪</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>none         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 禁用函数跟踪</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=使用外部连接池>使用外部连接池</h3><p>即使在微型实例上，使用 PgBouncer 也能显著提高并发能力：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-tiny</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbouncer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_poolmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=云平台推荐规格>云平台推荐规格</h2><h3 id=aws>AWS</h3><ul><li><strong>t3.micro</strong>：1 vCPU, 1GB RAM - 适合 TINY</li><li><strong>t3.small</strong>：2 vCPU, 2GB RAM - 适合 TINY</li><li><strong>t3.medium</strong>：2 vCPU, 4GB RAM - 可考虑 OLTP</li></ul><h3 id=阿里云>阿里云</h3><ul><li><strong>ecs.t6-c1m1.small</strong>：1 vCPU, 1GB RAM - 适合 TINY</li><li><strong>ecs.t6-c1m2.small</strong>：1 vCPU, 2GB RAM - 适合 TINY</li><li><strong>ecs.t6-c1m4.small</strong>：1 vCPU, 4GB RAM - 适合 TINY</li></ul><h3 id=腾讯云>腾讯云</h3><ul><li><strong>SA2.SMALL1</strong>：1 vCPU, 1GB RAM - 适合 TINY</li><li><strong>SA2.SMALL2</strong>：1 vCPU, 2GB RAM - 适合 TINY</li><li><strong>SA2.SMALL4</strong>：1 vCPU, 4GB RAM - 适合 TINY</li></ul><hr><h2 id=边缘设备部署>边缘设备部署</h2><h3 id=树莓派-4>树莓派 4</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-pi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>192.168.1.100</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-pi</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_storage_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>SSD   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 建议使用 SSD 存储</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=docker-容器>Docker 容器</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-docker</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>172.17.0.2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-docker</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=升级到-oltp>升级到 OLTP</h2><p>当您的应用增长，需要更多资源时，可以轻松升级到 <a href=/docs/pgsql/template/oltp/><strong>OLTP 模板</strong></a>：</p><ol><li>升级虚拟机规格（4核 8GB 以上）</li><li>修改集群配置：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-growing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 从 tiny.yml 改为 oltp.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 从 tiny 改为 oltp</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ol start=3><li><a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>重新配置集群</a> 或重新部署</li></ol><hr><h2 id=参考资料>参考资料</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：PostgreSQL 配置模板选择参数</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/template/oltp/><strong>OLTP 模板</strong></a>：事务处理模板，4核8GB 以上可升级使用</li><li><a href=/docs/pgsql/template/olap/><strong>OLAP 模板</strong></a>：分析处理模板</li><li><a href=/docs/pgsql/template/crit/><strong>CRIT 模板</strong></a>：关键业务模板</li><li><a href=/docs/setup/install#%E9%83%A8%E7%BD%B2>单机部署</a>：Pigsty 单机安装指南</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-08a8dc2fb6ea8fd6936acfdf250bdc97>18 - 内核分支</h1><div class=lead>如何在 Pigsty 中使用其他 PostgreSQL 内核分支？例如 Citus，Babelfish，IvorySQL，PolarDB 等</div><p>在 Pigsty 中，您可以使用不同 &ldquo;<strong>风味</strong>&rdquo; 的 PostgreSQL 分支替换 &ldquo;原生PG内核&rdquo;，实现特殊的功能与效果。</p><p>Pigsty 支持各种 PostgreSQL 内核和兼容分支，使您能够模拟不同的数据库系统，同时利用 PostgreSQL 的生态系统。每个内核都能提供独特的功能和兼容性层。</p><table class=full-width><thead><tr><th style=text-align:left>内核</th><th style=text-align:left>关键特性</th><th style=text-align:left>描述</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql><strong>PostgreSQL</strong></a></td><td style=text-align:left><strong>451扩展</strong></td><td style=text-align:left>原版 PostgreSQL，配备 451 扩展</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/citus><strong>Citus</strong></a></td><td style=text-align:left><strong>水平扩展</strong></td><td style=text-align:left>通过原生扩展实现分布式 PostgreSQL</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/babelfish><strong>WiltonDB</strong></a></td><td style=text-align:left><strong>SQL Server 兼容</strong></td><td style=text-align:left>SQL Server 线协议兼容</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/ivorysql><strong>IvorySQL</strong></a></td><td style=text-align:left><strong>Oracle 兼容</strong></td><td style=text-align:left>Oracle 语法和 PL/SQL 兼容</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/openhalo><strong>OpenHalo</strong></a></td><td style=text-align:left><strong>MySQL 兼容</strong></td><td style=text-align:left>MySQL 线协议兼容</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/percona><strong>Percona</strong></a></td><td style=text-align:left><strong>透明数据加密</strong></td><td style=text-align:left>带有 pg_tde 的 Percona 发行版</td></tr><tr><td style=text-align:left><a href=/docs/ferret><strong>FerretDB</strong></a></td><td style=text-align:left><strong>MongoDB 迁移</strong></td><td style=text-align:left>MongoDB 线协议兼容</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/orioledb><strong>OrioleDB</strong></a></td><td style=text-align:left><strong>OLTP 优化</strong></td><td style=text-align:left>Zheap，无膨胀，S3 存储</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/polardb><strong>PolarDB</strong></a></td><td style=text-align:left><strong>Aurora 风格 RAC</strong></td><td style=text-align:left>RAC，中国国产合规</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/supabase><strong>Supabase</strong></a></td><td style=text-align:left><strong>后端即服务</strong></td><td style=text-align:left>基于 PostgreSQL 的 BaaS，Firebase 替代方案</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/kernel/cloudberry><strong>Cloudberry</strong></a></td><td style=text-align:left><strong>MPP数仓与数据分析</strong></td><td style=text-align:left>大规模并行处理数据仓库</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-6b647bd80a1130f992c12a77393a87c3>18.1 - PostgreSQL</h1><div class=lead>带有 451 扩展的原版 PostgreSQL 内核</div><p><a href=https://www.postgresql.org/>PostgreSQL</a> 是世界上最先进和最受欢迎的开源数据库。</p><p>Pigsty 支持 PostgreSQL 13 ~ 18，并提供 451 个 PG 扩展。</p><hr><h2 id=快速开始>快速开始</h2><p>使用 <a href=https://github.com/pgsty/pigsty/blob/main/conf/pgsql.yml><code>pgsql</code></a> 配置模板 <a href=/docs/setup/install><strong>安装</strong></a> Pigsty。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c pgsql     <span style=color:#8f5902;font-style:italic># 使用 postgres 内核</span>
</span></span><span style=display:flex><span>./deploy.yml             <span style=color:#8f5902;font-style:italic># 使用 pigsty 设置一切</span>
</span></span></code></pre></div><p>大多数 <a href=/docs/conf/>配置模板</a> 默认使用 PostgreSQL 内核，例如：</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/meta.yml><code>meta</code></a> : <strong>默认</strong>，带有核心扩展（vector、postgis、timescale）的 postgres</li><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/rich.yml><code>rich</code></a> : 安装了所有扩展的 postgres</li><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/slim.yml><code>slim</code></a> : 仅 postgres，无监控基础设施</li><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/full.yml><code>full</code></a> : 用于 HA 演示的 4 节点沙盒</li><li><a href=https://github.com/pgsty/pigsty/blob/main/conf/pgsql.yml><code>pgsql</code></a> : 最小的 postgres 内核配置示例</li></ul><hr><h2 id=配置>配置</h2><p>原版 PostgreSQL 内核不需要特殊调整：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin   ] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta, baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>vector ]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 每天凌晨 1 点进行全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main, pgsql-common ]  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg 内核和通用工具</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#pg_extensions: [ pg18-time ,pg18-gis ,pg18-rag ,pg18-fts ,pg18-olap ,pg18-feat ,pg18-lang ,pg18-type ,pg18-util ,pg18-func ,pg18-admin ,pg18-stat ,pg18-sec ,pg18-fdw ,pg18-sim ,pg18-etl]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=版本选择>版本选择</h2><p>要使用不同的 PostgreSQL 主版本，您可以使用 <code>-v</code> 参数进行配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./configure -c pgsql            <span style=color:#8f5902;font-style:italic># 默认就是 postgresql 18，无需显式指定</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>17</span>      <span style=color:#8f5902;font-style:italic># 使用 postgresql 17</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>16</span>      <span style=color:#8f5902;font-style:italic># 使用 postgresql 16</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>15</span>      <span style=color:#8f5902;font-style:italic># 使用 postgresql 15</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>14</span>      <span style=color:#8f5902;font-style:italic># 使用 postgresql 14</span>
</span></span><span style=display:flex><span>./configure -c pgsql -v <span style=color:#0000cf;font-weight:700>13</span>      <span style=color:#8f5902;font-style:italic># 使用 postgresql 13</span>
</span></span></code></pre></div><p>如果 PostgreSQL 集群已经安装，您需要在安装新版本之前卸载它：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml <span style=color:#8f5902;font-style:italic># -l pg-meta</span>
</span></span></code></pre></div><hr><h2 id=扩展生态>扩展生态</h2><p>Pigsty 为 PostgreSQL 提供了丰富的扩展生态，包括：</p><ul><li><strong>时序类</strong>：timescaledb, pg_cron, periods</li><li><strong>地理类</strong>：postgis, h3, pgrouting</li><li><strong>向量类</strong>：pgvector, pgml, vchord</li><li><strong>搜索类</strong>：pg_trgm, zhparser, pgroonga</li><li><strong>分析类</strong>：citus, pg_duckdb, pg_analytics</li><li><strong>特性类</strong>：age, pg_graphql, rum</li><li><strong>语言类</strong>：plpython3u, pljava, plv8</li><li><strong>类型类</strong>：hstore, ltree, citext</li><li><strong>工具类</strong>：http, pg_net, pgjwt</li><li><strong>函数类</strong>：pgcrypto, uuid-ossp, pg_uuidv7</li><li><strong>管理类</strong>：pg_repack, pgagent, pg_squeeze</li><li><strong>统计类</strong>：pg_stat_statements, pg_qualstats, auto_explain</li><li><strong>安全类</strong>：pgaudit, pgcrypto, pgsodium</li><li><strong>外部类</strong>：postgres_fdw, mysql_fdw, oracle_fdw</li><li><strong>兼容类</strong>：orafce, babelfishpg_tds</li><li><strong>数据类</strong>：pglogical, wal2json, decoderbufs</li></ul><p>详情请参考 <a href=https://pgext.cloud/zh/list>扩展目录</a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-2f9342f89a206383c945315b79c7967f>18.2 - Supabase</h1><div class=lead>如何使用Pigsty自建Supabase，一键拉起开源Firebase替代，后端全栈全家桶。</div><blockquote><p><a href=https://supabase.com/>Supabase</a> —— Build in a weekend, Scale to millions</p></blockquote><p>Supabase 是一个开源的 Firebase 替代，对 PostgreSQL 进行了封装，并提供了认证，开箱即用的 API，边缘函数，实时订阅，对象存储，向量嵌入能力。
这是一个低代码的一站式后端平台，能让你几乎告别大部分后端开发的工作，只需要懂数据库设计与前端即可快速出活！</p><p>Supabase 的口号是：“<strong>花个周末写写，随便扩容至百万</strong>”。诚然，在小微规模（4c8g）内的 Supabase <a href=https://supabase.com/pricing>极有性价比</a>，堪称赛博菩萨。
—— 但当你真的增长到百万用户时 —— 确实应该认真考虑托管自建 Supabase 了 —— 无论是出于功能，性能，还是成本上的考虑。</p><p>Pigsty 为您提供完整的 Supabase 一键自建方案。自建的 Supabase 可以享受完整的 PostgreSQL 监控，IaC，PITR 与高可用，
而且相比 Supabase 云服务，提供了多达 <a href=https://pgext.cloud><strong>451</strong></a> 个开箱即用的 PostgreSQL 扩展，并能够更充分地利用现代硬件的性能与成本优势。</p><p>完整自建教程，请参考：《<a href=/docs/app/supabase><strong>Supabase自建手册</strong></a>》</p><p><img src=/img/pigsty/supabase.webp alt></p><hr><h2 id=快速上手>快速上手</h2><p>Pigsty 默认提供的 <a href=https://github.com/Vonng/pigsty/blob/main/conf/supa.yml><code>supa.yml</code></a> 配置模板定义了一套单节点 Supabase。</p><p>首先，使用 Pigsty <a href=/docs/setup/install>标准安装流程</a> 安装 Supabase 所需的 MinIO 与 PostgreSQL 实例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash
</span></span><span style=display:flex><span>./bootstrap          <span style=color:#8f5902;font-style:italic># 环境检查，安装依赖</span>
</span></span><span style=display:flex><span>./configure -c supa  <span style=color:#8f5902;font-style:italic># 重要：请在配置文件中修改密码等关键信息！</span>
</span></span><span style=display:flex><span>./deploy.yml         <span style=color:#8f5902;font-style:italic># 安装 Pigsty，拉起 PGSQL 与 MINIO！</span>
</span></span></code></pre></div><p>请在部署 Supabase 前，根据您的实际情况，修改 <code>pigsty.yml</code> 配置文件中 <a href=#%E9%85%8D%E7%BD%AE%E7%BB%86%E8%8A%82>关于 Supabase 的参数</a>（主要是密码！）</p><p>然后，运行 <a href=https://github.com/Vonng/pigsty/blob/main/supabase.yml><code>supabase.yml</code></a> 完成剩余的工作，拉起 Supabase 容器</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./docker.yml       <span style=color:#8f5902;font-style:italic># 安装 Docker 模块</span>
</span></span><span style=display:flex><span>./app.yml          <span style=color:#8f5902;font-style:italic># 拉起 Supabase 无状态部分！</span>
</span></span></code></pre></div><p>中国区域用户注意，请您配置合适的 Docker 镜像站点或代理服务器绕过 GFW 以拉取 DockerHub 镜像。
对于 <a href=/docs/about/service>专业订阅</a> ，我们提供在没有互联网访问的情况下，<a href=/docs/setup/offline>离线安装</a> Pigsty 与 Supabase 的能力。</p><p>Pigsty 默认通过管理节点/INFRA节点上的 Nginx 对外暴露 Web 服务，您可以在本地添加 <code>supa.pigsty</code> 的 DNS 解析指向该节点，
然后通过浏览器访问 <code>https://supa.pigsty</code> 即可进入 Supabase Studio 管理界面。</p><blockquote><p>默认用户名与密码：supabase / pigsty</p></blockquote><link rel=stylesheet href=/css/asciinema-player.css><script src=/js/asciinema-player.min.js></script><div id=asciinema-913fe6b5e34ef94a5d10a82176a4fd69 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-913fe6b5e34ef94a5d10a82176a4fd69",o="/demo/supabase.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[0,"检查环境"],[11,"安装"],[43,"配置"],[307,"Docker"],[321,"域名"],[340,"App"],[350,"检查"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=配置细节>配置细节</h2><p><code>./configure -c supa</code> 会生成 <code>~/pigsty/pigsty.yml</code>。在执行 <code>./deploy.yml</code> 之前，请至少检查并修改其中的密码、密钥、域名等敏感配置。</p><p>更完整的配置说明请参阅：《<a href=/docs/app/supabase>Supabase自建手册</a>》。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-7200791b1d0ca9c1c30f1e8d7dc9ece2>18.3 - Citus</h1><div class=lead>使用 Pigsty 部署原生高可用的 Citus 水平分片集群，将 PostgreSQL 无缝伸缩到多套分片并加速 OLTP/OLAP 查询。</div><p>Pigsty 原生支持 Citus。这是一个基于原生 PostgreSQL 内核的分布式水平扩展插件。</p><p><img src=/img/pigsty/citus.jpg alt></p><hr><h2 id=安装>安装</h2><p>Citus 是一个 PostgreSQL <a href=/docs/pgsql/ext/>扩展插件</a>，可以按照标准插件安装的流程，在原生 PostgreSQL 集群上加装启用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_extension -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;:[&#34;citus&#34;]}&#39;</span>
</span></span></code></pre></div><hr><h2 id=配置>配置</h2><p>要定义一个 citus 集群，您需要指定以下参数：</p><ul><li><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a> 必须设置为 <code>citus</code>，而不是默认的 <code>pgsql</code></li><li>在每个分片集群上都必须定义分片名 <a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a> 和分片号 <a href=/docs/pgsql/param#pg_group><code>pg_group</code></a></li><li>必须定义 <a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a> 来指定由 Patroni 管理的 Citus 数据库。</li><li>如果您想使用 <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a> 的 <code>postgres</code> 而不是默认的 <a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a> 来执行管理命令，那么 <a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a> 必须设置为非空的纯文本密码</li></ul><p>此外，还需要额外的 hba 规则，允许从本地和其他数据节点进行 SSL 访问。</p><p>您可以将每个 Citus 集群分别定义为独立的分组，像标准的 PostgreSQL 集群一样，如 <a href=https://github.com/Vonng/pigsty/blob/main/conf/citus.yml><code>conf/dbms/citus.yml</code></a> 所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 0号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 1号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 2号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 3号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.14</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># 所有 Citus 集群的全局参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgsql 集群模式需要设置为： citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 水平分片名称： pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 数据库名称：meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 如果使用 dbsu ，那么需要为其配置一个密码</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您也可以在一个分组内指定所有 Citus 集群成员的身份参数，如 <a href=https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L298><code>prod.yml</code></a> 所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==========================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-citus: 10 node citus cluster (5 x primary-replica pair)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==========================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.50</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.51</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.52</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.53</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.54</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.55</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.56</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.57</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.58</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.59</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                    # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus postgis timescaledb pgvector&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: test ,password: test ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: test ,owner: test ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 10.10.10.0/24 ,auth: trust ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;trust citus cluster members&#39;</span><span style=color:#f8f8f8>        </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=使用>使用</h2><p>您可以像访问普通集群一样，访问任意节点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -i postgres://test:test@pg-citus0/test
</span></span><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus0/test
</span></span></code></pre></div><p>默认情况下，您对某一个 Shard 进行的变更，都只发生在这套集群上，而不会同步到其他 Shard。</p><p>如果你希望将写入分布到所有 Shard，可以使用 Citus 提供的 API 函数，将表标记为：</p><ul><li><strong>水平分片表</strong>（自动分区，需要指定分区键）</li><li><strong>引用表</strong>（全量复制：不需要指定分区键）：</li></ul><p>从 Citus 11.2 开始，任何 Citus 数据库节点都可以扮演协调者的角色，即，任意一个主节点都可以写入：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -h pg-citus0 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#34;SELECT create_distributed_table(&#39;pgbench_accounts&#39;, &#39;aid&#39;); SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_accounts&#39;);&#34;</span>
</span></span><span style=display:flex><span>psql -h pg-citus0 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#34;SELECT create_reference_table(&#39;pgbench_branches&#39;)         ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_branches&#39;);&#34;</span>
</span></span><span style=display:flex><span>psql -h pg-citus0 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#34;SELECT create_reference_table(&#39;pgbench_history&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_history&#39;);&#34;</span>
</span></span><span style=display:flex><span>psql -h pg-citus0 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#34;SELECT create_reference_table(&#39;pgbench_tellers&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_tellers&#39;);&#34;</span>
</span></span></code></pre></div><p>将表分布出去后，你可以在其他节点上也访问到：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -h pg-citus1 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#39;\dt+&#39;</span>
</span></span></code></pre></div><p>例如，全表扫描可以发现执行计划已经变为分布式计划</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>vagrant@meta-1:~$ psql -h pg-citus3 -d <span style=color:#204a87>test</span> -c <span style=color:#4e9a06>&#39;explain select * from pgbench_accounts&#39;</span>
</span></span><span style=display:flex><span>                                               QUERY PLAN
</span></span><span style=display:flex><span>---------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span> Custom Scan <span style=color:#ce5c00;font-weight:700>(</span>Citus Adaptive<span style=color:#ce5c00;font-weight:700>)</span>  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cost</span><span style=color:#ce5c00;font-weight:700>=</span>0.00..0.00 <span style=color:#000>rows</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>100000</span> <span style=color:#000>width</span><span style=color:#ce5c00;font-weight:700>=</span>352<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>   Task Count: <span style=color:#0000cf;font-weight:700>32</span>
</span></span><span style=display:flex><span>   Tasks Shown: One of <span style=color:#0000cf;font-weight:700>32</span>
</span></span><span style=display:flex><span>   -&gt;  Task
</span></span><span style=display:flex><span>         Node: <span style=color:#000>host</span><span style=color:#ce5c00;font-weight:700>=</span>10.10.10.52 <span style=color:#000>port</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>test</span>
</span></span><span style=display:flex><span>         -&gt;  Seq Scan on pgbench_accounts_102008 pgbench_accounts  <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>cost</span><span style=color:#ce5c00;font-weight:700>=</span>0.00..81.66 <span style=color:#000>rows</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3066</span> <span style=color:#000>width</span><span style=color:#ce5c00;font-weight:700>=</span>97<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>6</span> rows<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>你可以从几个不同的主节点发起写入：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus1/test
</span></span><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus2/test
</span></span><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus3/test
</span></span><span style=display:flex><span>pgbench -nv -P1 -T1000 -c <span style=color:#0000cf;font-weight:700>2</span> postgres://test:test@pg-citus4/test
</span></span></code></pre></div><p>当某个节点出现故障时，Patroni 提供的原生高可用支持会将备用节点提升并自动顶上。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>test</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># select * from  pg_dist_node;</span>
</span></span><span style=display:flex><span> nodeid <span style=color:#000;font-weight:700>|</span> groupid <span style=color:#000;font-weight:700>|</span>  nodename   <span style=color:#000;font-weight:700>|</span> nodeport <span style=color:#000;font-weight:700>|</span> noderack <span style=color:#000;font-weight:700>|</span> hasmetadata <span style=color:#000;font-weight:700>|</span> isactive <span style=color:#000;font-weight:700>|</span> noderole <span style=color:#000;font-weight:700>|</span> nodecluster <span style=color:#000;font-weight:700>|</span> metadatasynced <span style=color:#000;font-weight:700>|</span> shouldhaveshards
</span></span><span style=display:flex><span>--------+---------+-------------+----------+----------+-------------+----------+----------+-------------+----------------+------------------
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.51 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.54 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.52 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.58 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.56 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary  <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-86f570780ad542823d4ed958af36ce0f>18.4 - Babelfish</h1><div class=lead>使用 WiltonDB 与 Babelfish 创建兼容 Microsoft SQL Server 的 PostgreSQL 数据库集群！（线缆协议级仿真）</div><blockquote><p><a href=https://babelfishpg.org/>Babelfish</a> 是一个基于 PostgreSQL 的 MSSQL（微软 SQL Server）兼容性方案，由 AWS 开源。</p></blockquote><hr><h2 id=概览>概览</h2><p>Pigsty 允许用户使用 Babelfish 与 WiltonDB 创建 Microsoft SQL Server 兼容的 PostgreSQL 集群！</p><ul><li><a href=https://babelfishpg.org/>Babelfish</a> ：一个由 AWS 开源的 MSSQL（微软 SQL Server） 兼容性扩展插件</li><li><a href=https://github.com/wiltondb/wiltondb>WiltonDB</a>： 一个专注于整合 Babelfish 的 PostgreSQL 内核发行版</li></ul><p>Babelfish 是一个 PostgreSQL 扩展插件，但只能在一个轻微修改过的 PostgreSQL 内核 Fork 上工作，WiltonDB 在 EL/Ubuntu 系统下提供了编译后的Fork内核二进制与扩展二进制软件包。</p><p>Pigsty 可以使用 WiltonDB 替代原生的 PostgreSQL 内核，提供开箱即用的 MSSQL 兼容集群。MSSQL集群使用与管理与一套标准的 PostgreSQL 15 集群并无差异，您可以使用 Pigsty 提供的所有功能，如高可用，备份，监控等。</p><p>WiltonDB 带有包括 Babelfish 在内的若干扩展插件，但不能使用 PostgreSQL 原生的扩展插件。</p><p>MSSQL 兼容集群在启动后，除了监听 PostgreSQL 默认的端口外，还会监听 MSSQL 默认的 <code>1433</code> 端口，并在此端口上通过 TDS WireProtocol 提供 MSSQL 服务。
您可以用任何 MSSQL 客户端连接至 Pigsty 提供的 MSSQL 服务，如 SQL Server Management Studio，或者使用 <code>sqlcmd</code> 命令行工具。</p><p><img src=/img/pigsty/mssql.jpg alt></p><hr><h2 id=安装>安装</h2><p>WiltonDB 与原生 PostgreSQL 内核冲突，在一个节点上只能选择一个内核进行安装，使用以下命令在线安装 WiltonDB 内核。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_install -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;local,mssql&#34;,&#34;node_packages&#34;:[&#34;wiltondb&#34;]}&#39;</span>
</span></span></code></pre></div><p>请注意 WiltonDB 仅在 EL 与 Ubuntu 系统中可用，目前尚未提供 Debian 支持。</p><p>Pigsty 专业版提供了 WiltonDB 离线安装包，可以从本地软件源安装 WiltonDB。</p><hr><h2 id=配置>配置</h2><p>在安装部署 MSSQL 模块时需要特别注意以下事项：</p><ul><li>WiltonDB 在 EL (7/8/9) 和 Ubuntu (20.04/22.04) 中可用，<strong>在Debian系统中不可用</strong>。</li><li>WiltonDB 目前基于 PostgreSQL 15 编译，因此需要指定 <code>pg_version: 15</code> 。</li><li>在 EL 系统上，<code>wiltondb</code> 的二进制默认会安装至 <code>/usr/bin/</code> 目录下，而在 Ubuntu 系统上则会安装至 <code>/usr/lib/postgresql/15/bin/</code> 目录下，与 PostgreSQL 官方二进制文件放置位置不同。</li><li>WiltonDB 兼容模式下，HBA 密码认证规则需要使用 <code>md5</code>，而非 <code>scram-sha-256</code>，因此需要覆盖 Pigsty 默认的 HBA 规则集，将 SQL Server 需要的 <code>md5</code> 认证规则，插入到 <code>dbrole_readonly</code> 通配认证规则之前</li><li>WiltonDB 只能针对一个首要数据库启用，同时应当指定一个用户作为 Babelfish 的超级用户，以便 Babelfish 可以创建数据库和用户，默认为 <code>mssql</code> 与 <code>dbuser_myssql</code>，如果修改，请一并修改 <code>files/mssql.sql</code> 中的用户。</li><li>WiltonDB TDS 线缆协议兼容插件 <code>babelfishpg_tds</code> 需要在 <code>shared_preload_libraries</code> 中启用</li><li>WiltonDB 扩展在启用后，默认监听 MSSQL <code>1433</code> 端口，您可以覆盖 Pigsty 默认的服务定义，将 <code>primary</code> 与 <code>replica</code> 服务的端口指向 <code>1433</code> ，而不是 <code>5432</code> / <code>6432</code> 端口。</li></ul><p>以下参数需要针对 MSSQL 数据库集群进行配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL &amp; MSSQL (Babelfish &amp; Wilton)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PG Installation</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local,node,mssql</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add mssql and os upstream repos</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mssql                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># Microsoft SQL Server Compatible Mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;babelfishpg_tds, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add timescaledb to shared_preload_libraries</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># The current WiltonDB major version is 15</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>wiltondb                       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install forked version of postgresql with babelfishpg support</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># do not install any vanilla postgresql extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PG Provision</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># overwrite default HBA rules for babelfish cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu access via local os user ident&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbsu replication from local os ident&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from localhost&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator replication from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;replicator postgres db from intranet&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from localhost with password&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;monitor from infra host with password&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ infra nodes with pwd &amp; ssl&#39;</span><span style=color:#f8f8f8>   </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin @ everywhere with ssl &amp; pwd&#39;</span><span style=color:#f8f8f8>    </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user: dbuser_mssql ,db: mssql       ,addr: intra     ,auth: md5   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow mssql dbsu intranet access&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- use md5 auth method for mssql user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgbouncer read/write via local socket&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;read/write biz user via password&#39;</span><span style=color:#f8f8f8>     </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow etl offline tasks from intranet&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># route primary &amp; replica service to mssql port 1433</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: 1433  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: 1433  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您可以定义 MSSQL 业务数据库与业务用户：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgsql (singleton on current node)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># this is an example single-node postgres cluster with postgis &amp; timescaledb installed, with one biz database &amp; two biz users</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- primary instance with read-write capability</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># create MSSQL superuser</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_mssql ,password: DBUser.MSSQL ,superuser: true, pgbouncer: true ,roles: [dbrole_admin], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>superuser &amp; owner for babelfish  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mssql               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use `mssql` as the primary sql server database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mssql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mssql.sql            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># init babelfish database &amp; user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>uuid-ossp          }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfishpg_common }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfishpg_tsql   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfishpg_tds    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfishpg_money  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_hint_plan       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system_stats       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tds_fdw            }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_mssql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>&#39;babelfishpg_tsql.migration_mode&#39; </span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;multi-db&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>babelfish cluster, a MSSQL compatible pg cluster</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=访问>访问</h2><p>您可以使用任何 SQL Server 兼容的客户端工具来访问这个数据库集群。</p><p>Microsoft 提供了 <a href="https://learn.microsoft.com/en-us/sql/tools/sqlcmd/sqlcmd-use-utility?view=sql-server-ver16">sqlcmd</a> 作为官方的命令行工具。</p><p>除此之外，他们还提供了一个 Go 语言版本的命令行工具 <a href=https://github.com/microsoft/go-sqlcmd>go-sqlcmd</a>。</p><p>安装 <code>go-sqlcmd</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -LO https://github.com/microsoft/go-sqlcmd/releases/download/v1.4.0/sqlcmd-v1.4.0-linux-amd64.tar.bz2
</span></span><span style=display:flex><span>tar xjvf sqlcmd-v1.4.0-linux-amd64.tar.bz2
</span></span><span style=display:flex><span>sudo mv sqlcmd* /usr/bin/
</span></span></code></pre></div><p>快速上手 <code>go-sqlcmd</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sqlcmd -S 10.10.10.10,1433 -U dbuser_mssql -P DBUser.MSSQL
</span></span><span style=display:flex><span>1&gt; <span style=color:#204a87;font-weight:700>select</span> @@version
</span></span><span style=display:flex><span>2&gt; go
</span></span><span style=display:flex><span>version                                                                                                                                                                                                                                                         
</span></span><span style=display:flex><span>----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</span></span><span style=display:flex><span>Babelfish <span style=color:#204a87;font-weight:700>for</span> PostgreSQL with SQL Server Compatibility - 12.0.2000.8
</span></span><span style=display:flex><span>Oct <span style=color:#0000cf;font-weight:700>22</span> <span style=color:#0000cf;font-weight:700>2023</span> 17:48:32
</span></span><span style=display:flex><span>Copyright <span style=color:#ce5c00;font-weight:700>(</span>c<span style=color:#ce5c00;font-weight:700>)</span> Amazon Web Services
</span></span><span style=display:flex><span>PostgreSQL 15.4 <span style=color:#ce5c00;font-weight:700>(</span>EL 1:15.4.wiltondb3.3_2-2.el8<span style=color:#ce5c00;font-weight:700>)</span> on x86_64-redhat-linux-gnu <span style=color:#ce5c00;font-weight:700>(</span>Babelfish 3.3.0<span style=color:#ce5c00;font-weight:700>)</span>                                        
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> row affected<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>使用 Pigsty 提供的服务机制，可以使用 5433 / 5434 端口始终连接到主库/从库上的 1433 端口。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 访问任意集群成员上的 5433 端口，指向主库上的 1433 MSSQL 端口 </span>
</span></span><span style=display:flex><span>sqlcmd -S 10.10.10.11,5433 -U dbuser_mssql -P DBUser.MSSQL
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 访问任意集群成员上的 5434 端口，指向任意可读库上的 1433 MSSQL 端口</span>
</span></span><span style=display:flex><span>sqlcmd -S 10.10.10.11,5434 -U dbuser_mssql -P DBUser.MSSQL
</span></span></code></pre></div><hr><h2 id=扩展>扩展</h2><p>绝大多数 <strong>PGSQL</strong> 模块的 <a href=/docs/pgsql/ext/><strong>扩展插件</strong></a>（非纯 SQL 类）都无法直接在 MSSQL 模块的 WiltonDB 内核上使用，需要重新编译。</p><p>目前 WiltonDB 自带了以下扩展插件，除了 PostgreSQL Contrib 扩展，四个 BabelfishPG 核心扩展之外，还提供了 <code>pg_hint_pan</code>，<code>tds_fdw</code>，以及 <code>system_stats</code> 三个第三方扩展。</p><table class=full-width><thead><tr><th>扩展名</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>dblink</td><td>1.2</td><td>connect to other PostgreSQL databases from within a database</td></tr><tr><td>adminpack</td><td>2.1</td><td>administrative functions for PostgreSQL</td></tr><tr><td>dict_int</td><td>1.0</td><td>text search dictionary template for integers</td></tr><tr><td>intagg</td><td>1.1</td><td>integer aggregator and enumerator (obsolete)</td></tr><tr><td>dict_xsyn</td><td>1.0</td><td>text search dictionary template for extended synonym processing</td></tr><tr><td>amcheck</td><td>1.3</td><td>functions for verifying relation integrity</td></tr><tr><td>autoinc</td><td>1.0</td><td>functions for autoincrementing fields</td></tr><tr><td>bloom</td><td>1.0</td><td>bloom access method - signature file based index</td></tr><tr><td>fuzzystrmatch</td><td>1.1</td><td>determine similarities and distance between strings</td></tr><tr><td>intarray</td><td>1.5</td><td>functions, operators, and index support for 1-D arrays of integers</td></tr><tr><td>btree_gin</td><td>1.3</td><td>support for indexing common datatypes in GIN</td></tr><tr><td>btree_gist</td><td>1.7</td><td>support for indexing common datatypes in GiST</td></tr><tr><td>hstore</td><td>1.8</td><td>data type for storing sets of (key, value) pairs</td></tr><tr><td>hstore_plperl</td><td>1.0</td><td>transform between hstore and plperl</td></tr><tr><td>isn</td><td>1.2</td><td>data types for international product numbering standards</td></tr><tr><td>hstore_plperlu</td><td>1.0</td><td>transform between hstore and plperlu</td></tr><tr><td>jsonb_plperl</td><td>1.0</td><td>transform between jsonb and plperl</td></tr><tr><td>citext</td><td>1.6</td><td>data type for case-insensitive character strings</td></tr><tr><td>jsonb_plperlu</td><td>1.0</td><td>transform between jsonb and plperlu</td></tr><tr><td>jsonb_plpython3u</td><td>1.0</td><td>transform between jsonb and plpython3u</td></tr><tr><td>cube</td><td>1.5</td><td>data type for multidimensional cubes</td></tr><tr><td>hstore_plpython3u</td><td>1.0</td><td>transform between hstore and plpython3u</td></tr><tr><td>earthdistance</td><td>1.1</td><td>calculate great-circle distances on the surface of the Earth</td></tr><tr><td>lo</td><td>1.1</td><td>Large Object maintenance</td></tr><tr><td>file_fdw</td><td>1.0</td><td>foreign-data wrapper for flat file access</td></tr><tr><td>insert_username</td><td>1.0</td><td>functions for tracking who changed a table</td></tr><tr><td>ltree</td><td>1.2</td><td>data type for hierarchical tree-like structures</td></tr><tr><td>ltree_plpython3u</td><td>1.0</td><td>transform between ltree and plpython3u</td></tr><tr><td>pg_walinspect</td><td>1.0</td><td>functions to inspect contents of PostgreSQL Write-Ahead Log</td></tr><tr><td>moddatetime</td><td>1.0</td><td>functions for tracking last modification time</td></tr><tr><td>old_snapshot</td><td>1.0</td><td>utilities in support of old_snapshot_threshold</td></tr><tr><td>pgcrypto</td><td>1.3</td><td>cryptographic functions</td></tr><tr><td>pgrowlocks</td><td>1.2</td><td>show row-level locking information</td></tr><tr><td>pageinspect</td><td>1.11</td><td>inspect the contents of database pages at a low level</td></tr><tr><td>pg_surgery</td><td>1.0</td><td>extension to perform surgery on a damaged relation</td></tr><tr><td>seg</td><td>1.4</td><td>data type for representing line segments or floating-point intervals</td></tr><tr><td>pgstattuple</td><td>1.5</td><td>show tuple-level statistics</td></tr><tr><td>pg_buffercache</td><td>1.3</td><td>examine the shared buffer cache</td></tr><tr><td>pg_freespacemap</td><td>1.2</td><td>examine the free space map (FSM)</td></tr><tr><td>postgres_fdw</td><td>1.1</td><td>foreign-data wrapper for remote PostgreSQL servers</td></tr><tr><td>pg_prewarm</td><td>1.2</td><td>prewarm relation data</td></tr><tr><td>tcn</td><td>1.0</td><td>Triggered change notifications</td></tr><tr><td>pg_trgm</td><td>1.6</td><td>text similarity measurement and index searching based on trigrams</td></tr><tr><td>xml2</td><td>1.1</td><td>XPath querying and XSLT</td></tr><tr><td>refint</td><td>1.0</td><td>functions for implementing referential integrity (obsolete)</td></tr><tr><td>pg_visibility</td><td>1.2</td><td>examine the visibility map (VM) and page-level visibility info</td></tr><tr><td>pg_stat_statements</td><td>1.10</td><td>track planning and execution statistics of all SQL statements executed</td></tr><tr><td>sslinfo</td><td>1.2</td><td>information about SSL certificates</td></tr><tr><td>tablefunc</td><td>1.0</td><td>functions that manipulate whole tables, including crosstab</td></tr><tr><td>tsm_system_rows</td><td>1.0</td><td>TABLESAMPLE method which accepts number of rows as a limit</td></tr><tr><td>tsm_system_time</td><td>1.0</td><td>TABLESAMPLE method which accepts time in milliseconds as a limit</td></tr><tr><td>unaccent</td><td>1.1</td><td>text search dictionary that removes accents</td></tr><tr><td>uuid-ossp</td><td>1.1</td><td>generate universally unique identifiers (UUIDs)</td></tr><tr><td>plpgsql</td><td>1.0</td><td>PL/pgSQL procedural language</td></tr><tr><td>babelfishpg_money</td><td>1.1.0</td><td>babelfishpg_money</td></tr><tr><td>system_stats</td><td>2.0</td><td>EnterpriseDB system statistics for PostgreSQL</td></tr><tr><td>tds_fdw</td><td>2.0.3</td><td>Foreign data wrapper for querying a TDS database (Sybase or Microsoft SQL Server)</td></tr><tr><td>babelfishpg_common</td><td>3.3.3</td><td>Transact SQL Datatype Support</td></tr><tr><td>babelfishpg_tds</td><td>1.0.0</td><td>TDS protocol extension</td></tr><tr><td>pg_hint_plan</td><td>1.5.1</td><td></td></tr><tr><td>babelfishpg_tsql</td><td>3.3.1</td><td>Transact SQL compatibility</td></tr></tbody></table><ul><li>Pigsty 专业版提供离线安装 MSSQL 兼容模块的能力</li><li>Pigsty <a href=/docs/about/service/><strong>专业版</strong></a> 提供可选的 MSSQL 兼容内核扩展移植定制服务，可以将 PGSQL 模块中可用的 <a href=/docs/pgsql/ext/><strong>扩展</strong></a> 移植到 MSSQL 集群中。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d4592799fc81bf53d57e017444a325f6>18.5 - IvorySQL</h1><div class=lead>使用瀚高开源的 IvorySQL 内核，基于 PostgreSQL 集群实现 Oracle 语法/PLSQL 兼容性。</div><p><a href=https://www.ivorysql.org/>IvorySQL</a> 是一个开源的，旨在基于 PG 提供 “Oracle兼容性” 的 PostgreSQL 内核分支。</p><hr><h2 id=概览>概览</h2><p>IvorySQL 内核支持在 Pigsty 开源版本中提供，您的服务器需要互联网访问，直接从 IvorySQL 的官方仓库下载相关软件包。</p><p>请注意，直接将 IvorySQL 加入 Pigsty 默认软件仓库中会影响原生 PostgreSQL 内核的安装。Pigsty 专业版提供包括 IvorySQL 内核在内的离线安装解决方案。</p><p><img src=/img/pigsty/ivory.jpg alt></p><p>当前 IvorySQL 的最新版本为 <strong>5.0</strong>，对应的 PostgreSQL 版本为 <strong>18</strong>。请注意，IvorySQL 当前仅在 EL8/EL9 上可用。</p><blockquote><p>最后一个支持 EL7 的 IvorySQL 版本为 3.3，对应 PostgreSQL 16.3；最后一个基于 PostgreSQL 17 的版本为 IvorySQL 4.4</p></blockquote><hr><h2 id=安装>安装</h2><p>如果您的环境有互联网访问，您可以使用以下方式，直接将 IvorySQL 仓库加入到节点上，然后执行 PGSQL 剧本进行安装</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;local,node,pgsql,ivory&#34;}&#39;</span>
</span></span></code></pre></div><hr><h2 id=配置>配置</h2><p>以下参数需要针对 IvorySQL 数据库集群进行配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ivory SQL Configuration</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local,node,pgsql,ivory </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># add ivorysql upstream repo</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ivory                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># IvorySQL Oracle Compatible Mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;ivorysql patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;liboracle_parser, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># do not install any vanilla postgresql extensions</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>使用 Oracle 兼容性模式时，需要动态加载 <code>liboracle_parser</code> 扩展插件。</p></blockquote><hr><h2 id=客户端访问>客户端访问</h2><p>IvorySQL 等效于 PostgreSQL 16，任何兼容 PostgreSQL 线缆协议的客户端工具都可以访问 IvorySQL 集群。</p><hr><h2 id=扩展列表>扩展列表</h2><p>绝大多数 <strong>PGSQL</strong> 模块的 <a href=/docs/pgsql/ext/><strong>扩展插件</strong></a> （非纯 SQL 类）都无法直接在 IvorySQL 内核上使用，如果需要使用，请针对新内核从源码重新编译安装。</p><p>目前 IvorySQL 内核自带了以下 <strong>101</strong> 个扩展插件。</p><table class=full-width><thead><tr><th>name</th><th>version</th><th>comment</th></tr></thead><tbody><tr><td>hstore_plperl</td><td>1.0</td><td>transform between hstore and plperl</td></tr><tr><td>plisql</td><td>1.0</td><td>PL/iSQL procedural language</td></tr><tr><td>hstore_plperlu</td><td>1.0</td><td>transform between hstore and plperlu</td></tr><tr><td>adminpack</td><td>2.1</td><td>administrative functions for PostgreSQL</td></tr><tr><td>insert_username</td><td>1.0</td><td>functions for tracking who changed a table</td></tr><tr><td>dblink</td><td>1.2</td><td>connect to other PostgreSQL databases from within a database</td></tr><tr><td>dict_int</td><td>1.0</td><td>text search dictionary template for integers</td></tr><tr><td>amcheck</td><td>1.3</td><td>functions for verifying relation integrity</td></tr><tr><td>intagg</td><td>1.1</td><td>integer aggregator and enumerator (obsolete)</td></tr><tr><td>autoinc</td><td>1.0</td><td>functions for autoincrementing fields</td></tr><tr><td>bloom</td><td>1.0</td><td>bloom access method - signature file based index</td></tr><tr><td>dict_xsyn</td><td>1.0</td><td>text search dictionary template for extended synonym processing</td></tr><tr><td>btree_gin</td><td>1.3</td><td>support for indexing common datatypes in GIN</td></tr><tr><td>earthdistance</td><td>1.1</td><td>calculate great-circle distances on the surface of the Earth</td></tr><tr><td>file_fdw</td><td>1.0</td><td>foreign-data wrapper for flat file access</td></tr><tr><td>fuzzystrmatch</td><td>1.2</td><td>determine similarities and distance between strings</td></tr><tr><td>btree_gist</td><td>1.7</td><td>support for indexing common datatypes in GiST</td></tr><tr><td>intarray</td><td>1.5</td><td>functions, operators, and index support for 1-D arrays of integers</td></tr><tr><td>citext</td><td>1.6</td><td>data type for case-insensitive character strings</td></tr><tr><td>isn</td><td>1.2</td><td>data types for international product numbering standards</td></tr><tr><td>ivorysql_ora</td><td>1.0</td><td>Oracle Compatible extenison on Postgres Database</td></tr><tr><td>jsonb_plperl</td><td>1.0</td><td>transform between jsonb and plperl</td></tr><tr><td>cube</td><td>1.5</td><td>data type for multidimensional cubes</td></tr><tr><td>dummy_index_am</td><td>1.0</td><td>dummy_index_am - index access method template</td></tr><tr><td>dummy_seclabel</td><td>1.0</td><td>Test code for SECURITY LABEL feature</td></tr><tr><td>hstore</td><td>1.8</td><td>data type for storing sets of (key, value) pairs</td></tr><tr><td>jsonb_plperlu</td><td>1.0</td><td>transform between jsonb and plperlu</td></tr><tr><td>lo</td><td>1.1</td><td>Large Object maintenance</td></tr><tr><td>ltree</td><td>1.2</td><td>data type for hierarchical tree-like structures</td></tr><tr><td>moddatetime</td><td>1.0</td><td>functions for tracking last modification time</td></tr><tr><td>old_snapshot</td><td>1.0</td><td>utilities in support of old_snapshot_threshold</td></tr><tr><td>ora_btree_gin</td><td>1.0</td><td>support for indexing oracle datatypes in GIN</td></tr><tr><td>pg_trgm</td><td>1.6</td><td>text similarity measurement and index searching based on trigrams</td></tr><tr><td>ora_btree_gist</td><td>1.0</td><td>support for oracle indexing common datatypes in GiST</td></tr><tr><td>pg_visibility</td><td>1.2</td><td>examine the visibility map (VM) and page-level visibility info</td></tr><tr><td>pg_walinspect</td><td>1.1</td><td>functions to inspect contents of PostgreSQL Write-Ahead Log</td></tr><tr><td>pgcrypto</td><td>1.3</td><td>cryptographic functions</td></tr><tr><td>pgstattuple</td><td>1.5</td><td>show tuple-level statistics</td></tr><tr><td>pageinspect</td><td>1.12</td><td>inspect the contents of database pages at a low level</td></tr><tr><td>pgrowlocks</td><td>1.2</td><td>show row-level locking information</td></tr><tr><td>pg_buffercache</td><td>1.4</td><td>examine the shared buffer cache</td></tr><tr><td>pg_stat_statements</td><td>1.10</td><td>track planning and execution statistics of all SQL statements executed</td></tr><tr><td>pg_freespacemap</td><td>1.2</td><td>examine the free space map (FSM)</td></tr><tr><td>plsample</td><td>1.0</td><td>PL/Sample</td></tr><tr><td>pg_prewarm</td><td>1.2</td><td>prewarm relation data</td></tr><tr><td>pg_surgery</td><td>1.0</td><td>extension to perform surgery on a damaged relation</td></tr><tr><td>seg</td><td>1.4</td><td>data type for representing line segments or floating-point intervals</td></tr><tr><td>postgres_fdw</td><td>1.1</td><td>foreign-data wrapper for remote PostgreSQL servers</td></tr><tr><td>refint</td><td>1.0</td><td>functions for implementing referential integrity (obsolete)</td></tr><tr><td>test_ext_req_schema1</td><td>1.0</td><td>Required extension to be referenced</td></tr><tr><td>spgist_name_ops</td><td>1.0</td><td>Test opclass for SP-GiST</td></tr><tr><td>test_ext_req_schema2</td><td>1.0</td><td>Test schema referencing of required extensions</td></tr><tr><td>test_shm_mq</td><td>1.0</td><td>Test code for shared memory message queues</td></tr><tr><td>sslinfo</td><td>1.2</td><td>information about SSL certificates</td></tr><tr><td>test_slru</td><td>1.0</td><td>Test code for SLRU</td></tr><tr><td>tablefunc</td><td>1.0</td><td>functions that manipulate whole tables, including crosstab</td></tr><tr><td>bool_plperl</td><td>1.0</td><td>transform between bool and plperl</td></tr><tr><td>tcn</td><td>1.0</td><td>Triggered change notifications</td></tr><tr><td>test_ext_req_schema3</td><td>1.0</td><td>Test schema referencing of 2 required extensions</td></tr><tr><td>test_bloomfilter</td><td>1.0</td><td>Test code for Bloom filter library</td></tr><tr><td>test_copy_callbacks</td><td>1.0</td><td>Test code for COPY callbacks</td></tr><tr><td>test_ginpostinglist</td><td>1.0</td><td>Test code for ginpostinglist.c</td></tr><tr><td>test_custom_rmgrs</td><td>1.0</td><td>Test code for custom WAL resource managers</td></tr><tr><td>test_integerset</td><td>1.0</td><td>Test code for integerset</td></tr><tr><td>test_ddl_deparse</td><td>1.0</td><td>Test code for DDL deparse feature</td></tr><tr><td>tsm_system_rows</td><td>1.0</td><td>TABLESAMPLE method which accepts number of rows as a limit</td></tr><tr><td>test_ext1</td><td>1.0</td><td>Test extension 1</td></tr><tr><td>tsm_system_time</td><td>1.0</td><td>TABLESAMPLE method which accepts time in milliseconds as a limit</td></tr><tr><td>test_ext2</td><td>1.0</td><td>Test extension 2</td></tr><tr><td>unaccent</td><td>1.1</td><td>text search dictionary that removes accents</td></tr><tr><td>test_ext3</td><td>1.0</td><td>Test extension 3</td></tr><tr><td>test_ext4</td><td>1.0</td><td>Test extension 4</td></tr><tr><td>uuid-ossp</td><td>1.1</td><td>generate universally unique identifiers (UUIDs)</td></tr><tr><td>test_ext5</td><td>1.0</td><td>Test extension 5</td></tr><tr><td>worker_spi</td><td>1.0</td><td>Sample background worker</td></tr><tr><td>test_ext6</td><td>1.0</td><td>test_ext6</td></tr><tr><td>test_lfind</td><td>1.0</td><td>Test code for optimized linear search functions</td></tr><tr><td>xml2</td><td>1.1</td><td>XPath querying and XSLT</td></tr><tr><td>test_ext7</td><td>1.0</td><td>Test extension 7</td></tr><tr><td>plpgsql</td><td>1.0</td><td>PL/pgSQL procedural language</td></tr><tr><td>test_ext8</td><td>1.0</td><td>Test extension 8</td></tr><tr><td>test_parser</td><td>1.0</td><td>example of a custom parser for full-text search</td></tr><tr><td>test_pg_dump</td><td>1.0</td><td>Test pg_dump with an extension</td></tr><tr><td>test_ext_cine</td><td>1.0</td><td>Test extension using CREATE IF NOT EXISTS</td></tr><tr><td>test_predtest</td><td>1.0</td><td>Test code for optimizer/util/predtest.c</td></tr><tr><td>test_ext_cor</td><td>1.0</td><td>Test extension using CREATE OR REPLACE</td></tr><tr><td>test_rbtree</td><td>1.0</td><td>Test code for red-black tree library</td></tr><tr><td>test_ext_cyclic1</td><td>1.0</td><td>Test extension cyclic 1</td></tr><tr><td>test_ext_cyclic2</td><td>1.0</td><td>Test extension cyclic 2</td></tr><tr><td>test_ext_extschema</td><td>1.0</td><td>test @extschema@</td></tr><tr><td>test_regex</td><td>1.0</td><td>Test code for backend/regex/</td></tr><tr><td>test_ext_evttrig</td><td>1.0</td><td>Test extension - event trigger</td></tr><tr><td>bool_plperlu</td><td>1.0</td><td>transform between bool and plperlu</td></tr><tr><td>plperl</td><td>1.0</td><td>PL/Perl procedural language</td></tr><tr><td>plperlu</td><td>1.0</td><td>PL/PerlU untrusted procedural language</td></tr><tr><td>hstore_plpython3u</td><td>1.0</td><td>transform between hstore and plpython3u</td></tr><tr><td>jsonb_plpython3u</td><td>1.0</td><td>transform between jsonb and plpython3u</td></tr><tr><td>ltree_plpython3u</td><td>1.0</td><td>transform between ltree and plpython3u</td></tr><tr><td>plpython3u</td><td>1.0</td><td>PL/Python3U untrusted procedural language</td></tr><tr><td>pltcl</td><td>1.0</td><td>PL/Tcl procedural language</td></tr><tr><td>pltclu</td><td>1.0</td><td>PL/TclU untrusted procedural language</td></tr></tbody></table><p>请注意，Pigsty 不对使用 IvorySQL 内核承担任何质保责任，使用此内核遇到的任何问题与需求请联系原厂解决。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-293b566be2331c0d55a3457bdfb0a860>18.6 - PolarDB PG</h1><div class=lead>使用阿里云开源的 PolarDB for PostgreSQL 内核提供国产信创资质支持，与类似 Oracle RAC 的使用体验。</div><hr><h2 id=概览>概览</h2><p>Pigsty 允许使用 PolarDB 创建带有 “国产化信创资质” 的 PostgreSQL 集群！</p><p>PolarDB for PostgreSQL 基本等效于 PostgreSQL 15，任何兼容 PostgreSQL 线缆协议的客户端工具都可以访问 PolarDB 集群。</p><p>Pigsty 的 PGSQL 仓库中提供了 EL7 / EL8 的 PolarDB PG 开源版安装包，但不会在 Pigsty 安装时下载到本地软件仓库。</p><p>如果您需要 PolarDB PG 的离线安装支持，请考虑我们的 <a href=/docs/about/service>专业订阅服务</a></p><p><img src=/img/pigsty/polar.jpg alt></p><hr><h2 id=安装>安装</h2><p>如果您的环境有互联网访问，您可以使用以下方式，直接将 Pigsty PGSQL 及依赖仓库加入到节点上，</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_repo_modules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local,node,pgsql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>然后在 <code>pg_packages</code> 中，使用 <code>polardb</code> 替换原生的 <code>postgresql</code> 软件包。</p><hr><h2 id=配置>配置</h2><p>以下参数需要针对 PolarDB 数据库集群进行特殊配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGSQL &amp; PolarDB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>15</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;polardb patroni pgbouncer pgbackrest pg_exporter pgbadger vip-manager&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># do not install any vanilla postgresql extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>polar                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PolarDB Compatible Mode</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># default roles and users in postgres cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator   ,superuser: true  ,replication: true ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;- superuser is required for replication</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这里特别注意，PolarDB PG 要求 <code>replicator</code> 复制用户为 Superuser，与原生 PG 不同。</p><hr><h2 id=扩展列表>扩展列表</h2><p>绝大多数 <strong>PGSQL</strong> 模块的 <a href=/docs/pgsql/ext/><strong>扩展插件</strong></a> （非纯 SQL 类）都无法直接在 PolarDB 内核上使用，如果需要使用，请针对新内核从源码重新编译安装。</p><p>目前 PolarDB 内核自带了以下 <strong>61</strong> 个扩展插件，除去 Contrib 扩展外，提供的额外扩展包括：</p><ul><li><code>polar_csn</code> 1.0 : polar_csn</li><li><code>polar_monitor</code> 1.2 : examine the polardb information</li><li><code>polar_monitor_preload</code> 1.1 : examine the polardb information</li><li><code>polar_parameter_check</code> 1.0 : kernel extension for parameter validation</li><li><code>polar_px</code> 1.0 : Parallel Execution extension</li><li><code>polar_stat_env</code> 1.0 : env stat functions for PolarDB</li><li><code>polar_stat_sql</code> 1.3 : Kernel statistics gathering, and sql plan nodes information gathering</li><li><code>polar_tde_utils</code> 1.0 : Internal extension for TDE</li><li><code>polar_vfs</code> 1.0 : polar_vfs</li><li><code>polar_worker</code> 1.0 : polar_worker</li><li><code>timetravel</code> 1.0 : functions for implementing time travel</li><li><code>vector</code> 0.5.1 : vector data type and ivfflat and hnsw access methods</li><li><code>smlar</code> 1.0 : compute similary of any one-dimensional arrays</li></ul><p>PolarDB 可用的完整插件列表：</p><table class=full-width><thead><tr><th>name</th><th>version</th><th>comment</th></tr></thead><tbody><tr><td>hstore_plpython2u</td><td>1.0</td><td>transform between hstore and plpython2u</td></tr><tr><td>dict_int</td><td>1.0</td><td>text search dictionary template for integers</td></tr><tr><td>adminpack</td><td>2.0</td><td>administrative functions for PostgreSQL</td></tr><tr><td>hstore_plpython3u</td><td>1.0</td><td>transform between hstore and plpython3u</td></tr><tr><td>amcheck</td><td>1.1</td><td>functions for verifying relation integrity</td></tr><tr><td>hstore_plpythonu</td><td>1.0</td><td>transform between hstore and plpythonu</td></tr><tr><td>autoinc</td><td>1.0</td><td>functions for autoincrementing fields</td></tr><tr><td>insert_username</td><td>1.0</td><td>functions for tracking who changed a table</td></tr><tr><td>bloom</td><td>1.0</td><td>bloom access method - signature file based index</td></tr><tr><td>file_fdw</td><td>1.0</td><td>foreign-data wrapper for flat file access</td></tr><tr><td>dblink</td><td>1.2</td><td>connect to other PostgreSQL databases from within a database</td></tr><tr><td>btree_gin</td><td>1.3</td><td>support for indexing common datatypes in GIN</td></tr><tr><td>fuzzystrmatch</td><td>1.1</td><td>determine similarities and distance between strings</td></tr><tr><td>lo</td><td>1.1</td><td>Large Object maintenance</td></tr><tr><td>intagg</td><td>1.1</td><td>integer aggregator and enumerator (obsolete)</td></tr><tr><td>btree_gist</td><td>1.5</td><td>support for indexing common datatypes in GiST</td></tr><tr><td>hstore</td><td>1.5</td><td>data type for storing sets of (key, value) pairs</td></tr><tr><td>intarray</td><td>1.2</td><td>functions, operators, and index support for 1-D arrays of integers</td></tr><tr><td>citext</td><td>1.5</td><td>data type for case-insensitive character strings</td></tr><tr><td>cube</td><td>1.4</td><td>data type for multidimensional cubes</td></tr><tr><td>hstore_plperl</td><td>1.0</td><td>transform between hstore and plperl</td></tr><tr><td>isn</td><td>1.2</td><td>data types for international product numbering standards</td></tr><tr><td>jsonb_plperl</td><td>1.0</td><td>transform between jsonb and plperl</td></tr><tr><td>dict_xsyn</td><td>1.0</td><td>text search dictionary template for extended synonym processing</td></tr><tr><td>hstore_plperlu</td><td>1.0</td><td>transform between hstore and plperlu</td></tr><tr><td>earthdistance</td><td>1.1</td><td>calculate great-circle distances on the surface of the Earth</td></tr><tr><td>pg_prewarm</td><td>1.2</td><td>prewarm relation data</td></tr><tr><td>jsonb_plperlu</td><td>1.0</td><td>transform between jsonb and plperlu</td></tr><tr><td>pg_stat_statements</td><td>1.6</td><td>track execution statistics of all SQL statements executed</td></tr><tr><td>jsonb_plpython2u</td><td>1.0</td><td>transform between jsonb and plpython2u</td></tr><tr><td>jsonb_plpython3u</td><td>1.0</td><td>transform between jsonb and plpython3u</td></tr><tr><td>jsonb_plpythonu</td><td>1.0</td><td>transform between jsonb and plpythonu</td></tr><tr><td>pg_trgm</td><td>1.4</td><td>text similarity measurement and index searching based on trigrams</td></tr><tr><td>pgstattuple</td><td>1.5</td><td>show tuple-level statistics</td></tr><tr><td>ltree</td><td>1.1</td><td>data type for hierarchical tree-like structures</td></tr><tr><td>ltree_plpython2u</td><td>1.0</td><td>transform between ltree and plpython2u</td></tr><tr><td>pg_visibility</td><td>1.2</td><td>examine the visibility map (VM) and page-level visibility info</td></tr><tr><td>ltree_plpython3u</td><td>1.0</td><td>transform between ltree and plpython3u</td></tr><tr><td>ltree_plpythonu</td><td>1.0</td><td>transform between ltree and plpythonu</td></tr><tr><td>seg</td><td>1.3</td><td>data type for representing line segments or floating-point intervals</td></tr><tr><td>moddatetime</td><td>1.0</td><td>functions for tracking last modification time</td></tr><tr><td>pgcrypto</td><td>1.3</td><td>cryptographic functions</td></tr><tr><td>pgrowlocks</td><td>1.2</td><td>show row-level locking information</td></tr><tr><td>pageinspect</td><td>1.7</td><td>inspect the contents of database pages at a low level</td></tr><tr><td>pg_buffercache</td><td>1.3</td><td>examine the shared buffer cache</td></tr><tr><td>pg_freespacemap</td><td>1.2</td><td>examine the free space map (FSM)</td></tr><tr><td>tcn</td><td>1.0</td><td>Triggered change notifications</td></tr><tr><td>plperl</td><td>1.0</td><td>PL/Perl procedural language</td></tr><tr><td>uuid-ossp</td><td>1.1</td><td>generate universally unique identifiers (UUIDs)</td></tr><tr><td>plperlu</td><td>1.0</td><td>PL/PerlU untrusted procedural language</td></tr><tr><td>refint</td><td>1.0</td><td>functions for implementing referential integrity (obsolete)</td></tr><tr><td>xml2</td><td>1.1</td><td>XPath querying and XSLT</td></tr><tr><td>plpgsql</td><td>1.0</td><td>PL/pgSQL procedural language</td></tr><tr><td>plpython3u</td><td>1.0</td><td>PL/Python3U untrusted procedural language</td></tr><tr><td>pltcl</td><td>1.0</td><td>PL/Tcl procedural language</td></tr><tr><td>pltclu</td><td>1.0</td><td>PL/TclU untrusted procedural language</td></tr><tr><td>polar_csn</td><td>1.0</td><td>polar_csn</td></tr><tr><td>sslinfo</td><td>1.2</td><td>information about SSL certificates</td></tr><tr><td>polar_monitor</td><td>1.2</td><td>examine the polardb information</td></tr><tr><td>polar_monitor_preload</td><td>1.1</td><td>examine the polardb information</td></tr><tr><td>polar_parameter_check</td><td>1.0</td><td>kernel extension for parameter validation</td></tr><tr><td>polar_px</td><td>1.0</td><td>Parallel Execution extension</td></tr><tr><td>tablefunc</td><td>1.0</td><td>functions that manipulate whole tables, including crosstab</td></tr><tr><td>polar_stat_env</td><td>1.0</td><td>env stat functions for PolarDB</td></tr><tr><td>smlar</td><td>1.0</td><td>compute similary of any one-dimensional arrays</td></tr><tr><td>timetravel</td><td>1.0</td><td>functions for implementing time travel</td></tr><tr><td>tsm_system_rows</td><td>1.0</td><td>TABLESAMPLE method which accepts number of rows as a limit</td></tr><tr><td>polar_stat_sql</td><td>1.3</td><td>Kernel statistics gathering, and sql plan nodes information gathering</td></tr><tr><td>tsm_system_time</td><td>1.0</td><td>TABLESAMPLE method which accepts time in milliseconds as a limit</td></tr><tr><td>polar_tde_utils</td><td>1.0</td><td>Internal extension for TDE</td></tr><tr><td>polar_vfs</td><td>1.0</td><td>polar_vfs</td></tr><tr><td>polar_worker</td><td>1.0</td><td>polar_worker</td></tr><tr><td>unaccent</td><td>1.1</td><td>text search dictionary that removes accents</td></tr><tr><td>postgres_fdw</td><td>1.0</td><td>foreign-data wrapper for remote PostgreSQL servers</td></tr></tbody></table><ul><li>Pigsty 专业版提供 PolarDB 离线安装支持，扩展插件编译支持，以及针对 PolarDB 集群进行专门适配的监控与管控支持。</li><li>Pigsty 与阿里云内核团队有合作，可以提供有偿内核兜底支持服务。</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ffed78d77ebf7627086f9da938f9b9f6>18.7 - PolarDB Oracle</h1><div class=lead>使用阿里云商业版本的 PolarDB for Oracle 内核（闭源，PG14，仅在特殊企业版定制中可用）</div><p>Pigsty 允许使用 PolarDB 创建带有 “国产化信创资质” 的 PolarDB for Oracle 集群！</p><p>根据 【<a href=http://www.itsec.gov.cn/aqkkcp/cpgg/202312/t20231226_162074.html>安全可靠测评结果公告（2023年第1号）</a>】，附表三、集中式数据库。PolarDB v2.0 属于自主可控，安全可靠的国产信创数据库。</p><p>PolarDB for Oracle 是基于 PolarDB for PostgreSQL 进行二次开发的 Oracle 兼容版本，两者共用同一套内核，通过 <code>--compatibility-mode</code> 参数进行区分。</p><p>我们与阿里云内核团队合作，提供基于 PolarDB v2.0 内核与 Pigsty 的完整数据库解决方案，请联系销售咨询，或在阿里云市场自行采购。</p><p>PolarDB for Oracle 内核目前仅在 EL 系统中可用。</p><p><img src=/img/pigsty/polar.jpg alt></p><hr><h2 id=扩展>扩展</h2><p>目前 PolarDB 2.0 (Oracle兼容) 内核自带了以下 <strong>188</strong> 个扩展插件：</p><table class=full-width><thead><tr><th>name</th><th>default_version</th><th>comment</th></tr></thead><tbody><tr><td>cube</td><td>1.5</td><td>data type for multidimensional cubes</td></tr><tr><td>ip4r</td><td>2.4</td><td>NULL</td></tr><tr><td>adminpack</td><td>2.1</td><td>administrative functions for PostgreSQL</td></tr><tr><td>dict_xsyn</td><td>1.0</td><td>text search dictionary template for extended synonym processing</td></tr><tr><td>amcheck</td><td>1.4</td><td>functions for verifying relation integrity</td></tr><tr><td>autoinc</td><td>1.0</td><td>functions for autoincrementing fields</td></tr><tr><td>hstore</td><td>1.8</td><td>data type for storing sets of (key, value) pairs</td></tr><tr><td>bloom</td><td>1.0</td><td>bloom access method - signature file based index</td></tr><tr><td>earthdistance</td><td>1.1</td><td>calculate great-circle distances on the surface of the Earth</td></tr><tr><td>hstore_plperl</td><td>1.0</td><td>transform between hstore and plperl</td></tr><tr><td>bool_plperl</td><td>1.0</td><td>transform between bool and plperl</td></tr><tr><td>file_fdw</td><td>1.0</td><td>foreign-data wrapper for flat file access</td></tr><tr><td>bool_plperlu</td><td>1.0</td><td>transform between bool and plperlu</td></tr><tr><td>fuzzystrmatch</td><td>1.1</td><td>determine similarities and distance between strings</td></tr><tr><td>hstore_plperlu</td><td>1.0</td><td>transform between hstore and plperlu</td></tr><tr><td>btree_gin</td><td>1.3</td><td>support for indexing common datatypes in GIN</td></tr><tr><td>hstore_plpython2u</td><td>1.0</td><td>transform between hstore and plpython2u</td></tr><tr><td>btree_gist</td><td>1.6</td><td>support for indexing common datatypes in GiST</td></tr><tr><td>hll</td><td>2.17</td><td>type for storing hyperloglog data</td></tr><tr><td>hstore_plpython3u</td><td>1.0</td><td>transform between hstore and plpython3u</td></tr><tr><td>citext</td><td>1.6</td><td>data type for case-insensitive character strings</td></tr><tr><td>hstore_plpythonu</td><td>1.0</td><td>transform between hstore and plpythonu</td></tr><tr><td>hypopg</td><td>1.3.1</td><td>Hypothetical indexes for PostgreSQL</td></tr><tr><td>insert_username</td><td>1.0</td><td>functions for tracking who changed a table</td></tr><tr><td>dblink</td><td>1.2</td><td>connect to other PostgreSQL databases from within a database</td></tr><tr><td>decoderbufs</td><td>0.1.0</td><td>Logical decoding plugin that delivers WAL stream changes using a Protocol Buffer format</td></tr><tr><td>intagg</td><td>1.1</td><td>integer aggregator and enumerator (obsolete)</td></tr><tr><td>dict_int</td><td>1.0</td><td>text search dictionary template for integers</td></tr><tr><td>intarray</td><td>1.5</td><td>functions, operators, and index support for 1-D arrays of integers</td></tr><tr><td>isn</td><td>1.2</td><td>data types for international product numbering standards</td></tr><tr><td>jsonb_plperl</td><td>1.0</td><td>transform between jsonb and plperl</td></tr><tr><td>jsonb_plperlu</td><td>1.0</td><td>transform between jsonb and plperlu</td></tr><tr><td>jsonb_plpython2u</td><td>1.0</td><td>transform between jsonb and plpython2u</td></tr><tr><td>jsonb_plpython3u</td><td>1.0</td><td>transform between jsonb and plpython3u</td></tr><tr><td>jsonb_plpythonu</td><td>1.0</td><td>transform between jsonb and plpythonu</td></tr><tr><td>lo</td><td>1.1</td><td>Large Object maintenance</td></tr><tr><td>log_fdw</td><td>1.0</td><td>foreign-data wrapper for csvlog</td></tr><tr><td>ltree</td><td>1.2</td><td>data type for hierarchical tree-like structures</td></tr><tr><td>ltree_plpython2u</td><td>1.0</td><td>transform between ltree and plpython2u</td></tr><tr><td>ltree_plpython3u</td><td>1.0</td><td>transform between ltree and plpython3u</td></tr><tr><td>ltree_plpythonu</td><td>1.0</td><td>transform between ltree and plpythonu</td></tr><tr><td>moddatetime</td><td>1.0</td><td>functions for tracking last modification time</td></tr><tr><td>old_snapshot</td><td>1.0</td><td>utilities in support of old_snapshot_threshold</td></tr><tr><td>oracle_fdw</td><td>1.2</td><td>foreign data wrapper for Oracle access</td></tr><tr><td>oss_fdw</td><td>1.1</td><td>foreign-data wrapper for OSS access</td></tr><tr><td>pageinspect</td><td>2.1</td><td>inspect the contents of database pages at a low level</td></tr><tr><td>pase</td><td>0.0.1</td><td>ant ai similarity search</td></tr><tr><td>pg_bigm</td><td>1.2</td><td>text similarity measurement and index searching based on bigrams</td></tr><tr><td>pg_freespacemap</td><td>1.2</td><td>examine the free space map (FSM)</td></tr><tr><td>pg_hint_plan</td><td>1.4</td><td>controls execution plan with hinting phrases in comment of special form</td></tr><tr><td>pg_buffercache</td><td>1.5</td><td>examine the shared buffer cache</td></tr><tr><td>pg_prewarm</td><td>1.2</td><td>prewarm relation data</td></tr><tr><td>pg_repack</td><td>1.4.8-1</td><td>Reorganize tables in PostgreSQL databases with minimal locks</td></tr><tr><td>pg_sphere</td><td>1.0</td><td>spherical objects with useful functions, operators and index support</td></tr><tr><td>pg_cron</td><td>1.5</td><td>Job scheduler for PostgreSQL</td></tr><tr><td>pg_jieba</td><td>1.1.0</td><td>a parser for full-text search of Chinese</td></tr><tr><td>pg_stat_kcache</td><td>2.2.1</td><td>Kernel statistics gathering</td></tr><tr><td>pg_stat_statements</td><td>1.9</td><td>track planning and execution statistics of all SQL statements executed</td></tr><tr><td>pg_surgery</td><td>1.0</td><td>extension to perform surgery on a damaged relation</td></tr><tr><td>pg_trgm</td><td>1.6</td><td>text similarity measurement and index searching based on trigrams</td></tr><tr><td>pg_visibility</td><td>1.2</td><td>examine the visibility map (VM) and page-level visibility info</td></tr><tr><td>pg_wait_sampling</td><td>1.1</td><td>sampling based statistics of wait events</td></tr><tr><td>pgaudit</td><td>1.6.2</td><td>provides auditing functionality</td></tr><tr><td>pgcrypto</td><td>1.3</td><td>cryptographic functions</td></tr><tr><td>pgrowlocks</td><td>1.2</td><td>show row-level locking information</td></tr><tr><td>pgstattuple</td><td>1.5</td><td>show tuple-level statistics</td></tr><tr><td>pgtap</td><td>1.2.0</td><td>Unit testing for PostgreSQL</td></tr><tr><td>pldbgapi</td><td>1.1</td><td>server-side support for debugging PL/pgSQL functions</td></tr><tr><td>plperl</td><td>1.0</td><td>PL/Perl procedural language</td></tr><tr><td>plperlu</td><td>1.0</td><td>PL/PerlU untrusted procedural language</td></tr><tr><td>plpgsql</td><td>1.0</td><td>PL/pgSQL procedural language</td></tr><tr><td>plpython2u</td><td>1.0</td><td>PL/Python2U untrusted procedural language</td></tr><tr><td>plpythonu</td><td>1.0</td><td>PL/PythonU untrusted procedural language</td></tr><tr><td>plsql</td><td>1.0</td><td>Oracle compatible PL/SQL procedural language</td></tr><tr><td>pltcl</td><td>1.0</td><td>PL/Tcl procedural language</td></tr><tr><td>pltclu</td><td>1.0</td><td>PL/TclU untrusted procedural language</td></tr><tr><td>polar_bfile</td><td>1.0</td><td>The BFILE data type enables access to binary file LOBs that are stored in file systems outside Database</td></tr><tr><td>polar_bpe</td><td>1.0</td><td>polar_bpe</td></tr><tr><td>polar_builtin_cast</td><td>1.1</td><td>Internal extension for builtin casts</td></tr><tr><td>polar_builtin_funcs</td><td>2.0</td><td>implement polar builtin functions</td></tr><tr><td>polar_builtin_type</td><td>1.5</td><td>polar_builtin_type for PolarDB</td></tr><tr><td>polar_builtin_view</td><td>1.5</td><td>polar_builtin_view</td></tr><tr><td>polar_catalog</td><td>1.2</td><td>polardb pg extend catalog</td></tr><tr><td>polar_channel</td><td>1.0</td><td>polar_channel</td></tr><tr><td>polar_constraint</td><td>1.0</td><td>polar_constraint</td></tr><tr><td>polar_csn</td><td>1.0</td><td>polar_csn</td></tr><tr><td>polar_dba_views</td><td>1.0</td><td>polar_dba_views</td></tr><tr><td>polar_dbms_alert</td><td>1.2</td><td>implement polar_dbms_alert - supports asynchronous notification of database events.</td></tr><tr><td>polar_dbms_application_info</td><td>1.0</td><td>implement polar_dbms_application_info - record names of executing modules or transactions in the database.</td></tr><tr><td>polar_dbms_pipe</td><td>1.1</td><td>implements polar_dbms_pipe - package lets two or more sessions in the same instance communicate.</td></tr><tr><td>polar_dbms_aq</td><td>1.2</td><td>implement dbms_aq - provides an interface to Advanced Queuing.</td></tr><tr><td>polar_dbms_lob</td><td>1.3</td><td>implement dbms_lob - provides subprograms to operate on BLOBs, CLOBs, and NCLOBs.</td></tr><tr><td>polar_dbms_output</td><td>1.2</td><td>implement polar_dbms_output - enables you to send messages from stored procedures.</td></tr><tr><td>polar_dbms_lock</td><td>1.0</td><td>implement polar_dbms_lock - provides an interface to Oracle Lock Management services.</td></tr><tr><td>polar_dbms_aqadm</td><td>1.3</td><td>polar_dbms_aqadm - procedures to manage Advanced Queuing configuration and administration information.</td></tr><tr><td>polar_dbms_assert</td><td>1.0</td><td>implement polar_dbms_assert - provide an interface to validate properties of the input value.</td></tr><tr><td>polar_dbms_metadata</td><td>1.0</td><td>implement polar_dbms_metadata - provides a way for you to retrieve metadata from the database dictionary.</td></tr><tr><td>polar_dbms_random</td><td>1.0</td><td>implement polar_dbms_random - a built-in random number generator, not intended for cryptography</td></tr><tr><td>polar_dbms_crypto</td><td>1.1</td><td>implement dbms_crypto - provides an interface to encrypt and decrypt stored data.</td></tr><tr><td>polar_dbms_redact</td><td>1.0</td><td>implement polar_dbms_redact - provides an interface to mask data from queries by an application.</td></tr><tr><td>polar_dbms_debug</td><td>1.1</td><td>server-side support for debugging PL/SQL functions</td></tr><tr><td>polar_dbms_job</td><td>1.0</td><td>polar_dbms_job</td></tr><tr><td>polar_dbms_mview</td><td>1.1</td><td>implement polar_dbms_mview - enables to refresh materialized views.</td></tr><tr><td>polar_dbms_job_preload</td><td>1.0</td><td>polar_dbms_job_preload</td></tr><tr><td>polar_dbms_obfuscation_toolkit</td><td>1.1</td><td>implement polar_dbms_obfuscation_toolkit - enables an application to get data md5.</td></tr><tr><td>polar_dbms_rls</td><td>1.1</td><td>implement polar_dbms_rls - a fine-grained access control administrative built-in package</td></tr><tr><td>polar_multi_toast_utils</td><td>1.0</td><td>polar_multi_toast_utils</td></tr><tr><td>polar_dbms_session</td><td>1.2</td><td>implement polar_dbms_session - support to set preferences and security levels.</td></tr><tr><td>polar_odciconst</td><td>1.0</td><td>implement ODCIConst - Provide some built-in constants in Oracle.</td></tr><tr><td>polar_dbms_sql</td><td>1.2</td><td>implement polar_dbms_sql - provides an interface to execute dynamic SQL.</td></tr><tr><td>polar_osfs_toolkit</td><td>1.0</td><td>osfs library tools and functions extension</td></tr><tr><td>polar_dbms_stats</td><td>14.0</td><td>stabilize plans by fixing statistics</td></tr><tr><td>polar_monitor</td><td>1.5</td><td>monitor functions for PolarDB</td></tr><tr><td>polar_osfs_utils</td><td>1.0</td><td>osfs library utils extension</td></tr><tr><td>polar_dbms_utility</td><td>1.3</td><td>implement polar_dbms_utility - provides various utility subprograms.</td></tr><tr><td>polar_parameter_check</td><td>1.0</td><td>kernel extension for parameter validation</td></tr><tr><td>polar_dbms_xmldom</td><td>1.0</td><td>implement dbms_xmldom and dbms_xmlparser - support standard DOM interface and xml parser object</td></tr><tr><td>polar_parameter_manager</td><td>1.1</td><td>Extension to select parameters for manger.</td></tr><tr><td>polar_faults</td><td>1.0.0</td><td>simulate some database faults for end user or testing system.</td></tr><tr><td>polar_monitor_preload</td><td>1.1</td><td>examine the polardb information</td></tr><tr><td>polar_proxy_utils</td><td>1.0</td><td>Extension to provide operations about proxy.</td></tr><tr><td>polar_feature_utils</td><td>1.2</td><td>PolarDB feature utilization</td></tr><tr><td>polar_global_awr</td><td>1.0</td><td>PolarDB Global AWR Report</td></tr><tr><td>polar_publication</td><td>1.0</td><td>support polardb pg logical replication</td></tr><tr><td>polar_global_cache</td><td>1.0</td><td>polar_global_cache</td></tr><tr><td>polar_px</td><td>1.0</td><td>Parallel Execution extension</td></tr><tr><td>polar_serverless</td><td>1.0</td><td>polar serverless extension</td></tr><tr><td>polar_resource_manager</td><td>1.0</td><td>a background process that forcibly frees user session process memory</td></tr><tr><td>polar_sys_context</td><td>1.1</td><td>implement polar_sys_context - returns the value of parameter associated with the context namespace at the current instant.</td></tr><tr><td>polar_gpc</td><td>1.3</td><td>polar_gpc</td></tr><tr><td>polar_tde_utils</td><td>1.0</td><td>Internal extension for TDE</td></tr><tr><td>polar_gtt</td><td>1.1</td><td>polar_gtt</td></tr><tr><td>polar_utl_encode</td><td>1.2</td><td>implement polar_utl_encode - provides functions that encode RAW data into a standard encoded format</td></tr><tr><td>polar_htap</td><td>1.1</td><td>extension for PolarDB HTAP</td></tr><tr><td>polar_htap_db</td><td>1.0</td><td>extension for PolarDB HTAP database level operation</td></tr><tr><td>polar_io_stat</td><td>1.0</td><td>polar io stat in multi dimension</td></tr><tr><td>polar_utl_file</td><td>1.0</td><td>implement utl_file - support PL/SQL programs can read and write operating system text files</td></tr><tr><td>polar_ivm</td><td>1.0</td><td>polar_ivm</td></tr><tr><td>polar_sql_mapping</td><td>1.2</td><td>Record error sqls and mapping them to correct one</td></tr><tr><td>polar_stat_sql</td><td>1.0</td><td>Kernel statistics gathering, and sql plan nodes information gathering</td></tr><tr><td>tds_fdw</td><td>2.0.2</td><td>Foreign data wrapper for querying a TDS database (Sybase or Microsoft SQL Server)</td></tr><tr><td>xml2</td><td>1.1</td><td>XPath querying and XSLT</td></tr><tr><td>polar_upgrade_catalogs</td><td>1.1</td><td>Upgrade catalogs for old version instance</td></tr><tr><td>polar_utl_i18n</td><td>1.1</td><td>polar_utl_i18n</td></tr><tr><td>polar_utl_raw</td><td>1.0</td><td>implement utl_raw - provides SQL functions for manipulating RAW datatypes.</td></tr><tr><td>timescaledb</td><td>2.9.2</td><td>Enables scalable inserts and complex queries for time-series data</td></tr><tr><td>polar_vfs</td><td>1.0</td><td>polar virtual file system for different storage</td></tr><tr><td>polar_worker</td><td>1.0</td><td>polar_worker</td></tr><tr><td>postgres_fdw</td><td>1.1</td><td>foreign-data wrapper for remote PostgreSQL servers</td></tr><tr><td>refint</td><td>1.0</td><td>functions for implementing referential integrity (obsolete)</td></tr><tr><td>roaringbitmap</td><td>0.5</td><td>support for Roaring Bitmaps</td></tr><tr><td>tsm_system_time</td><td>1.0</td><td>TABLESAMPLE method which accepts time in milliseconds as a limit</td></tr><tr><td>vector</td><td>0.5.0</td><td>vector data type and ivfflat and hnsw access methods</td></tr><tr><td>rum</td><td>1.3</td><td>RUM index access method</td></tr><tr><td>unaccent</td><td>1.1</td><td>text search dictionary that removes accents</td></tr><tr><td>seg</td><td>1.4</td><td>data type for representing line segments or floating-point intervals</td></tr><tr><td>sequential_uuids</td><td>1.0.2</td><td>generator of sequential UUIDs</td></tr><tr><td>uuid-ossp</td><td>1.1</td><td>generate universally unique identifiers (UUIDs)</td></tr><tr><td>smlar</td><td>1.0</td><td>compute similary of any one-dimensional arrays</td></tr><tr><td>varbitx</td><td>1.1</td><td>varbit functions pack</td></tr><tr><td>sslinfo</td><td>1.2</td><td>information about SSL certificates</td></tr><tr><td>tablefunc</td><td>1.0</td><td>functions that manipulate whole tables, including crosstab</td></tr><tr><td>tcn</td><td>1.0</td><td>Triggered change notifications</td></tr><tr><td>zhparser</td><td>1.0</td><td>a parser for full-text search of Chinese</td></tr><tr><td>address_standardizer</td><td>3.3.2</td><td>Ganos PostGIS address standardizer</td></tr><tr><td>address_standardizer_data_us</td><td>3.3.2</td><td>Ganos PostGIS address standardizer data us</td></tr><tr><td>ganos_fdw</td><td>6.0</td><td>Ganos Spatial FDW extension for POLARDB</td></tr><tr><td>ganos_geometry</td><td>6.0</td><td>Ganos geometry lite extension for POLARDB</td></tr><tr><td>ganos_geometry_pyramid</td><td>6.0</td><td>Ganos Geometry Pyramid extension for POLARDB</td></tr><tr><td>ganos_geometry_sfcgal</td><td>6.0</td><td>Ganos geometry lite sfcgal extension for POLARDB</td></tr><tr><td>ganos_geomgrid</td><td>6.0</td><td>Ganos geometry grid extension for POLARDB</td></tr><tr><td>ganos_importer</td><td>6.0</td><td>Ganos Spatial importer extension for POLARDB</td></tr><tr><td>ganos_networking</td><td>6.0</td><td>Ganos networking</td></tr><tr><td>ganos_pointcloud</td><td>6.0</td><td>Ganos pointcloud extension For POLARDB</td></tr><tr><td>ganos_pointcloud_geometry</td><td>6.0</td><td>Ganos_pointcloud LIDAR data and ganos_geometry data for POLARDB</td></tr><tr><td>ganos_raster</td><td>6.0</td><td>Ganos raster extension for POLARDB</td></tr><tr><td>ganos_scene</td><td>6.0</td><td>Ganos scene extension for POLARDB</td></tr><tr><td>ganos_sfmesh</td><td>6.0</td><td>Ganos surface mesh extension for POLARDB</td></tr><tr><td>ganos_spatialref</td><td>6.0</td><td>Ganos spatial reference extension for POLARDB</td></tr><tr><td>ganos_trajectory</td><td>6.0</td><td>Ganos trajectory extension for POLARDB</td></tr><tr><td>ganos_vomesh</td><td>6.0</td><td>Ganos volumn mesh extension for POLARDB</td></tr><tr><td>postgis_tiger_geocoder</td><td>3.3.2</td><td>Ganos PostGIS tiger geocoder</td></tr><tr><td>postgis_topology</td><td>3.3.2</td><td>Ganos PostGIS topology</td></tr></tbody></table></div><div class=td-content style=page-break-before:always><h1 id=pg-5e2941fff6b5b682be30d52c9d82b986>18.8 - Percona</h1><div class=lead>支持 TDE 透明加密的 Percona Postgres 发行版</div><p><a href=https://www.percona.com/postgresql/software/postgresql-distribution>Percona Postgres</a> 是一个带有 <a href=https://docs.percona.com/pg-tde/index.html><code>pg_tde</code></a>（透明数据加密）扩展的补丁 Postgres 内核。</p><p>它与 PostgreSQL 18.1 兼容，在所有 Pigsty 支持的平台上都可用。</p><ul><li><a href=https://andreas.scherbaum.la/post/2025-06-30_performance-test-for-percona-transparent-data-encryption-tde/>Percona 透明数据加密（TDE）性能测试</a></li></ul><hr><h2 id=快速开始>快速开始</h2><p>使用 Pigsty <a href=/docs/setup/install><strong>标准安装流程</strong></a>，配合 <a href=https://github.com/pgsty/pigsty/blob/main/conf/pgtde.yml><code>pgtde</code></a> 配置模板。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>./configure -c pgtde     <span style=color:#8f5902;font-style:italic># 使用 percona postgres 内核</span>
</span></span><span style=display:flex><span>./deploy.yml             <span style=color:#8f5902;font-style:italic># 使用 pigsty 设置一切</span>
</span></span></code></pre></div><hr><h2 id=配置>配置</h2><p>需要调整以下参数来部署 Percona 集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin   ] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty tde database</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>vector, postgis, pg_tde ,pgaudit, { name: pg_stat_monitor, schema: monitor } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 每天凌晨 1 点进行全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># Percona PostgreSQL TDE 临时设置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>percona-main, pgsql-common ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装 percona postgres 包</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_tde, pgaudit, pg_stat_statements, pg_stat_monitor, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=扩展>扩展</h2><p>Percona 提供了 80 个可用的扩展，包括 <code>pg_tde</code>, <code>pgvector</code>, <code>postgis</code>, <code>pgaudit</code>, <code>set_user</code>, <code>pg_stat_monitor</code> 等实用三方扩展。</p><table class=full-width><thead><tr><th>扩展名</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td>pg_tde</td><td>2.1</td><td>Percona 透明数据加密访问方法</td></tr><tr><td>vector</td><td>0.8.1</td><td>向量数据类型及 ivfflat 和 hnsw 访问方法</td></tr><tr><td>postgis</td><td>3.5.4</td><td>PostGIS 几何和地理空间类型及函数</td></tr><tr><td>pgaudit</td><td>18.0</td><td>提供审计功能</td></tr><tr><td>pg_stat_monitor</td><td>2.3</td><td>PostgreSQL 查询性能监控工具</td></tr><tr><td>set_user</td><td>4.2.0</td><td>类似 SET ROLE 但带有额外日志记录</td></tr><tr><td>pg_repack</td><td>1.5.3</td><td>以最小锁定重组 PostgreSQL 数据库中的表</td></tr><tr><td>hstore</td><td>1.8</td><td>用于存储(键,值)对集合的数据类型</td></tr><tr><td>ltree</td><td>1.3</td><td>用于层次树状结构的数据类型</td></tr><tr><td>pg_trgm</td><td>1.6</td><td>基于三元组的文本相似度测量和索引搜索</td></tr></tbody></table><p>完整的 80 个扩展列表请参考 <a href=https://docs.percona.com/postgresql/18/extensions.html>Percona Postgres 官方文档</a>。</p><hr><h2 id=关键特性>关键特性</h2><ul><li><strong>透明数据加密</strong>：使用 pg_tde 扩展提供静态数据加密</li><li><strong>PostgreSQL 18 兼容</strong>：基于最新 PostgreSQL 18 版本</li><li><strong>企业级扩展</strong>：包含 pgaudit、pg_stat_monitor 等企业级功能</li><li><strong>完整生态</strong>：支持 pgvector、PostGIS 等流行扩展</li></ul><blockquote><p><strong>注意</strong>：目前处于稳定阶段 - 在生产使用前请彻底评估。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-e59a81d2edf1c2072f834e4d8ef376db>18.9 - PostgresML</h1><div class=lead>如何使用 Pigsty 部署 PostgresML，在数据库内进行机器学习、模型训练、推理、Embedding 与 RAG。</div><p><a href=https://postgresml.org/>PostgresML</a> 是一个 PostgreSQL 扩展，支持最新的大语言模型（LLM）、向量操作、经典机器学习以及传统的 Postgres 应用负载。</p><p>PostgresML (pgml) 是一个用 Rust 编写的 PostgreSQL 扩展。您可以运行独立的 Docker 镜像，但本文档不是 docker-compose 模板介绍，仅供参考。</p><p>PostgresML 官方支持 Ubuntu 22.04，但我们也为 EL 8/9 维护了 RPM 版本，如果您不需要 CUDA 和 NVIDIA 相关功能的话。</p><p>您需要在数据库节点上能够访问互联网，以便从 PyPI 下载 Python 依赖，并从 HuggingFace 下载模型。</p><hr><h2 id=配置>配置</h2><p>PostgresML 是一个用 Rust 编写的扩展，官方支持 Ubuntu。Pigsty 在 EL8 和 EL9 上维护了 PostgresML 的 RPM 版本。</p><p><strong>创建新集群</strong></p><p>PostgresML 2.7.9 可用于 PostgreSQL 15，支持 Ubuntu 22.04（官方）、Debian 12 和 EL 8/9（Pigsty 维护）。要启用 <code>pgml</code>，首先需要安装扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgml, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pgml_15 pgvector_15 wal2json_15 repack_15&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># ubuntu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#pg_extensions: [ &#39;postgresql-pgml-15 postgresql-15-pgvector postgresql-15-wal2json postgresql-15-repack&#39; ]  # ubuntu</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>在 EL 8/9 中，扩展名为 <code>pgml_15</code>，对应的 Ubuntu/Debian 名称为 <code>postgresql-pgml-15</code>。同时需要将 <code>pgml</code> 添加到 <code>pg_libs</code> 中。</p><p><strong>在现有集群上启用</strong></p><p>要在现有集群上启用 <code>pgml</code>，可以使用 Ansible 的 <code>package</code> 模块安装：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible pg-meta -m package -b -a <span style=color:#4e9a06>&#39;name=pgml_15&#39;</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ansible el8,el9 -m package -b -a &#39;name=pgml_15&#39;           # EL 8/9</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ansible u22 -m package -b -a &#39;name=postgresql-pgml-15&#39;    # Ubuntu 22.04 jammy</span>
</span></span></code></pre></div><hr><h2 id=python-依赖>Python 依赖</h2><p>您还需要在集群节点上安装 PostgresML 的 Python 依赖。官方教程：<a href=https://postgresml.org/docs/guides/developer-docs/installation>安装指南</a></p><p><strong>安装 Python 和 PIP</strong></p><p>确保已安装 <code>python3</code>、<code>pip</code> 和 <code>venv</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Ubuntu 22.04 (python3.10)，需要使用 apt 安装 pip 和 venv</span>
</span></span><span style=display:flex><span>sudo apt install -y python3 python3-pip python3-venv
</span></span></code></pre></div><p>对于 EL 8 / EL9 及兼容发行版，可以使用 python3.11：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 8/9，可以升级默认的 pip 和 virtualenv</span>
</span></span><span style=display:flex><span>sudo yum install -y python3.11 python3.11-pip       <span style=color:#8f5902;font-style:italic># 安装最新的 python3.11</span>
</span></span><span style=display:flex><span>python3.11 -m pip install --upgrade pip virtualenv  <span style=color:#8f5902;font-style:italic># 在 EL8 / EL9 上使用 python3.11</span>
</span></span></code></pre></div><details><summary>使用 PyPI 镜像</summary><p>对于中国大陆用户，建议使用清华大学 PyPI <a href=https://mirrors.tuna.tsinghua.edu.cn/help/pypi/>镜像</a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pip config <span style=color:#204a87>set</span> global.index-url https://pypi.tuna.tsinghua.edu.cn/simple    <span style=color:#8f5902;font-style:italic># 设置全局镜像（推荐）</span>
</span></span><span style=display:flex><span>pip install -i https://pypi.tuna.tsinghua.edu.cn/simple some-package        <span style=color:#8f5902;font-style:italic># 单次安装时使用</span>
</span></span></code></pre></div></details><p><strong>安装依赖包</strong></p><p>创建 Python 虚拟环境，并使用 <code>pip</code> 从 <a href=https://github.com/postgresml/postgresml/blob/master/pgml-extension/requirements.txt><code>requirements.txt</code></a> 和 <a href=https://github.com/postgresml/postgresml/blob/master/pgml-extension/requirements-xformers.txt><code>requirements-xformers.txt</code></a> 安装依赖。</p><blockquote><p>如果您使用的是 EL 8/9，需要将以下命令中的 <code>python3</code> 替换为 <code>python3.11</code>。</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>su - postgres<span style=color:#000;font-weight:700>;</span>                          <span style=color:#8f5902;font-style:italic># 使用数据库超级用户创建虚拟环境</span>
</span></span><span style=display:flex><span>mkdir -p /data/pgml<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> /data/pgml<span style=color:#000;font-weight:700>;</span>     <span style=color:#8f5902;font-style:italic># 创建虚拟环境目录</span>
</span></span><span style=display:flex><span>python3    -m venv /data/pgml           <span style=color:#8f5902;font-style:italic># 创建虚拟环境目录（Ubuntu 22.04）</span>
</span></span><span style=display:flex><span><span style=color:#204a87>source</span> /data/pgml/bin/activate          <span style=color:#8f5902;font-style:italic># 激活虚拟环境</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 写入 Python 依赖并使用 pip 安装</span>
</span></span><span style=display:flex><span>cat &gt; /data/pgml/requirments.txt <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>accelerate==0.22.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>auto-gptq==0.4.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>bitsandbytes==0.41.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>catboost==1.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>ctransformers==0.2.27
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>datasets==2.14.5
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deepspeed==0.10.3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>huggingface-hub==0.17.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>InstructorEmbedding==1.0.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>lightgbm==4.1.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>orjson==3.9.7
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>pandas==2.1.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>rich==13.5.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>rouge==1.0.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>sacrebleu==2.3.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>sacremoses==0.0.53
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>scikit-learn==1.3.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>sentencepiece==0.1.99
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>sentence-transformers==2.2.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>tokenizers==0.13.3
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>torch==2.0.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>torchaudio==2.0.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>torchvision==0.15.2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>tqdm==4.66.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>transformers==4.33.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>xgboost==2.0.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>langchain==0.0.287
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>einops==0.6.1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>pynvml==11.5.0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在虚拟环境中使用 pip 安装依赖</span>
</span></span><span style=display:flex><span>python3 -m pip install -r /data/pgml/requirments.txt
</span></span><span style=display:flex><span>python3 -m pip install <span style=color:#000>xformers</span><span style=color:#ce5c00;font-weight:700>==</span>0.0.21 --no-dependencies
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 此外，有 3 个 Python 包需要使用 sudo 全局安装！</span>
</span></span><span style=display:flex><span>sudo python3 -m pip install xgboost lightgbm scikit-learn
</span></span></code></pre></div><hr><h2 id=启用-postgresml>启用 PostgresML</h2><p>在所有集群节点上安装 <code>pgml</code> 扩展和 Python 依赖后，就可以在 PostgreSQL 集群上启用 <code>pgml</code> 了。</p><p>使用 <code>patronictl</code> 命令 <a href=https://pigsty.io/docs/pgsql/admin/#config-cluster>配置集群</a>，将 <code>pgml</code> 添加到 <code>shared_preload_libraries</code>，并在 <code>pgml.venv</code> 中指定您的虚拟环境目录：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgml, timescaledb, pg_stat_statements, auto_explain</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgml.venv</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/pgml&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>然后重启数据库集群，并使用 SQL 命令创建扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- 建议同时安装 pgvector！
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pgml</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- 在当前数据库中创建 PostgresML
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pgml</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- 打印 PostgresML 版本信息
</span></span></span></code></pre></div><p>如果一切正常，您应该会看到类似以下输出：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># create extension pgml;</span>
</span></span><span style=display:flex><span>INFO:  Python version: 3.11.2 <span style=color:#ce5c00;font-weight:700>(</span>main, Oct  <span style=color:#0000cf;font-weight:700>5</span> 2023, 16:06:03<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>[</span>GCC 8.5.0 <span style=color:#0000cf;font-weight:700>20210514</span> <span style=color:#ce5c00;font-weight:700>(</span>Red Hat 8.5.0-18<span style=color:#ce5c00;font-weight:700>)]</span>
</span></span><span style=display:flex><span>INFO:  Scikit-learn 1.3.0, XGBoost 2.0.0, LightGBM 4.1.0, NumPy 1.26.1
</span></span><span style=display:flex><span>CREATE EXTENSION
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># SELECT pgml.version(); -- 打印 PostgresML 版本信息</span>
</span></span><span style=display:flex><span> version
</span></span><span style=display:flex><span>---------
</span></span><span style=display:flex><span> 2.7.8
</span></span></code></pre></div><p>大功告成！更多详情请参阅 PostgresML 官方文档：https://postgresml.org/docs/guides/use-cases/</p></div><div class=td-content style=page-break-before:always><h1 id=pg-8b89390bfb5e407f5413ce18cede184b>18.10 - OpenHalo</h1><div class=lead>MySQL 兼容的 Postgres 14 分支</div><p><a href=https://www.openhalo.org/>OpenHalo</a> 是一个开源的 PostgreSQL 内核，提供 MySQL 线协议兼容性。</p><p>OpenHalo 基于 PostgreSQL 14.10 内核版本，提供与 MySQL 5.7.32-log / 8.0 版本的线协议兼容性。</p><p>Pigsty 在所有支持的 Linux 平台上为 OpenHalo 提供部署支持。</p><hr><h2 id=快速开始>快速开始</h2><p>使用 Pigsty 的 <a href=/docs/setup/install><strong>标准安装流程</strong></a> 和 <a href=https://github.com/pgsty/pigsty/blob/main/conf/mysql.yml><code>mysql</code></a> 配置模板。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>./configure -c mysql    <span style=color:#8f5902;font-style:italic># 使用 MySQL（openHalo）配置模板</span>
</span></span><span style=display:flex><span>./deploy.yml            <span style=color:#8f5902;font-style:italic># 安装，生产部署请先在 pigsty.yml 中修改密码</span>
</span></span></code></pre></div><p>对于生产部署，请确保在运行安装剧本之前修改 <code>pigsty.yml</code> 配置文件中的密码参数。</p><hr><h2 id=配置>配置</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: postgres, extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>aux_mysql]}</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># mysql 兼容数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 每天凌晨 1 点进行全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># OpenHalo 临时设置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mysql                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># HaloDB 的 MySQL 兼容模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 当前 HaloDB 兼容 PG 主版本 14</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>openhalodb, pgsql-common ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装 openhalodb 而不是 postgresql 内核</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=使用>使用</h2><p>访问 MySQL 时，实际连接使用的是 <code>postgres</code> 数据库。请注意，MySQL 中的"数据库"概念实际上对应于 PostgreSQL 中的"Schema"。因此，<code>use mysql</code> 实际上使用的是 <code>postgres</code> 数据库内的 <code>mysql</code> Schema。</p><p>用于 MySQL 的用户名和密码与 PostgreSQL 中的相同。您可以使用标准的 PostgreSQL 方法管理用户和权限。</p><h3 id=客户端访问>客户端访问</h3><p>OpenHalo 提供 MySQL 线协议兼容性，默认监听端口 3306，允许 MySQL 客户端和驱动程序直接连接。</p><p>Pigsty 的 <a href=https://github.com/pgsty/pigsty/blob/main/conf/mysql.yml><code>conf/mysql</code></a> 配置默认安装 <code>mysql</code> 客户端工具。</p><p>您可以使用以下命令访问 MySQL：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mysql -h 127.0.0.1 -u dbuser_dba
</span></span></code></pre></div><p>目前，OpenHalo 官方确保 Navicat 可以正常访问此 MySQL 端口，但 Intellij IDEA 的 DataGrip 访问会导致错误。</p><hr><h2 id=修改说明>修改说明</h2><p>Pigsty 安装的 <a href=https://github.com/pgsty/openHalo>OpenHalo</a> 内核基于 <a href=https://github.com/HaloTech-Co-Ltd/openHalo>HaloTech-Co-Ltd/openHalo</a> 内核进行了少量修改：</p><ul><li>将默认数据库名称从 <code>halo0root</code> 改回 <code>postgres</code></li><li>从默认版本号中删除 <code>1.0.</code> 前缀，恢复为 <code>14.10</code></li><li>修改默认配置文件以启用 MySQL 兼容性并默认监听端口 <code>3306</code></li></ul><p>请注意，Pigsty 不为使用 OpenHalo 内核提供任何保证。使用此内核时遇到的任何问题或需求应与原始供应商联系。</p><blockquote><p><strong>警告</strong>：目前处于实验阶段 - 在生产使用前请彻底评估。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-227e1bd7e26827efbe4f8ed91ee4c679>18.11 - Greenplum</h1><div class=lead>使用 Pigsty 部署/监控 Greenplum 集群，构建大规模并行处理（MPP）的 PostgreSQL 数据仓库集群！</div><p>Pigsty 支持部署 Greenplum 集群，及其衍生发行版 YMatrixDB，并提供了将现有 Greenplum 部署纳入 Pigsty 监控的能力。</p><hr><h2 id=概览>概览</h2><p>Greenplum / YMatrix 集群部署能力仅在专业版本/企业版本中提供，目前不对外开源。</p><hr><h2 id=安装>安装</h2><p>Pigsty 提供了 Greenplum 6 (@el7) 与 Greenplum 7 (@el8) 的安装包，开源版本用户可以自行安装配置。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 7 Only (Greenplum6)</span>
</span></span><span style=display:flex><span>./node.yml -t node_install  -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;open-source-greenplum-db-6&#34;]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 8 Only (Greenplum7)</span>
</span></span><span style=display:flex><span>./node.yml -t node_install  -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;open-source-greenplum-db-7&#34;]}&#39;</span>
</span></span></code></pre></div><hr><h2 id=配置>配置</h2><p>要定义 Greenplum 集群，需要用到 <code>pg_mode</code> = <code>gpsql</code>，并使用额外的身份参数 <code>pg_shard</code> 与 <code>gp_role</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#================================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#                        GPSQL Clusters                          #</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#================================================================#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cluster: mx-mdw (gp master)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>mx-mdw</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , nodename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-mdw-1 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>gp_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>master         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># this cluster is used as greenplum master</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgsql sharding name &amp; gpsql deployment name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-mdw      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># this master cluster name is mx-mdw</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: matrixmgr , extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>matrixdbts } ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta , password: DBUser.Meta , pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor , password: DBUser.Monitor , roles: [ dbrole_readonly ], superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># enable pgbouncer for greenplum master</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_exporter_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># enable pgbouncer_exporter for greenplum master</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporter_params</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;host=127.0.0.1&amp;sslmode=disable&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># use 127.0.0.1 as local monitor host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># cluster: mx-sdw (gp master)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#----------------------------------#</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>mx-sdw</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>nodename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-sdw-1       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># greenplum segment node</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># greenplum segment instances</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6000</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg1, pg_seq: 1, pg_role: primary , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9633</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg2, pg_seq: 2, pg_role: replica , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9634</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>nodename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-sdw-2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6000</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg2, pg_seq: 1, pg_role: primary , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9633</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg3, pg_seq: 2, pg_role: replica , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9634</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>nodename</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-sdw-3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_instances</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6000</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg3, pg_seq: 1, pg_role: primary , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9633</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>6001</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: mx-seg1, pg_seq: 2, pg_role: replica , pg_exporter_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9634</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>gp_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>segment              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># these are nodes for gp segments</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgsql sharding name &amp; gpsql deployment name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mx-sdw            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># these segment clusters name is mx-sdw</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_preflight_skip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># skip preflight check (since pg_seq &amp; pg_role &amp; pg_cluster not exists)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporter_config</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_exporter_basic.yml                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># use basic config to avoid segment server crash</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_exporter_params</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;options=-c%20gp_role%3Dutility&amp;sslmode=disable&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># use gp_role = utility to connect to segments</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>此外，PG Exporter 需要额外的连接参数，才能连接到 Greenplum Segment 实例上采集监控指标。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-311f723c83095a738bfb441159db0044>18.12 - OrioleDB</h1><div class=lead>PostgreSQL 的下一代 OLTP 引擎</div><p><a href=https://orioledb.com/>OrioleDB</a> 是一个 PostgreSQL 存储引擎扩展，声称能够提供 4 倍 OLTP 性能，没有 xid 环绕和表膨胀问题，并具有"云原生"（数据存储在 S3）能力。</p><p>OrioleDB 的最新版本基于 <a href=https://github.com/orioledb/postgres>补丁版 PostgreSQL 17.0</a> 和一个额外的 <a href=https://github.com/orioledb/orioledb>扩展</a></p><p>您可以使用 Pigsty 将 OrioleDB 作为 RDS 运行，它与 PG 17 兼容，在所有支持的 Linux 平台上都可用。
最新版本为 beta12，基于 PG 17_11 补丁。</p><hr><h2 id=快速开始>快速开始</h2><p>按照 Pigsty <a href=/docs/setup/install><strong>标准安装</strong></a> 流程，使用 <a href=https://github.com/pgsty/pigsty/blob/main/conf/oriole.yml><code>oriole</code></a> 配置模板。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>./configure -c oriole    <span style=color:#8f5902;font-style:italic># 使用 OrioleDB 配置模板</span>
</span></span><span style=display:flex><span>./deploy.yml             <span style=color:#8f5902;font-style:italic># 使用 OrioleDB 安装 Pigsty</span>
</span></span></code></pre></div><p>对于生产部署，请确保在运行 <code>install</code> 剧本之前修改 <code>pigsty.yml</code> 配置中的密码参数。</p><hr><h2 id=配置>配置</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta   ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view ,password: DBUser.Viewer ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty], extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>orioledb]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: dbuser_view , db: all ,addr: infra ,auth: pwd ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;allow grafana dashboard access cmdb from infra nodes&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 每天凌晨 1 点进行全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># OrioleDB 临时设置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oriole                                        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># oriole 兼容模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb, pgsql-common ]                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装 OrioleDB 内核</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;orioledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 加载 OrioleDB 扩展</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=使用>使用</h2><p>要使用 OrioleDB，您需要安装 <code>orioledb_17</code> 和 <code>oriolepg_17</code> 包（目前仅提供 RPM 版本）。</p><p>使用 <code>pgbench</code> 初始化类似 TPC-B 的表，包含 100 个仓库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -is <span style=color:#0000cf;font-weight:700>100</span> meta
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -S -T1000 meta
</span></span><span style=display:flex><span>pgbench -nv -P1 -c50 -S -T1000 meta
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10    -T1000 meta
</span></span><span style=display:flex><span>pgbench -nv -P1 -c50    -T1000 meta
</span></span></code></pre></div><p>接下来，您可以使用 <code>orioledb</code> 存储引擎重建这些表并观察性能差异：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 创建 OrioleDB 表
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts_o</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INCLUDING</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches_o</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INCLUDING</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history_o</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INCLUDING</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers_o</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INCLUDING</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USING</span><span style=color:#f8f8f8> </span><span style=color:#000>orioledb</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 从常规表复制数据到 OrioleDB 表
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8>  </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>INSERT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>INTO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 删除原始表并重命名 OrioleDB 表
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_accounts</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_branches</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_history</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers_o</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RENAME</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbench_tellers</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=关键特性>关键特性</h2><ul><li><strong>无 XID 回绕</strong>：消除事务 ID 回绕维护</li><li><strong>无表膨胀</strong>：高级存储管理防止表膨胀</li><li><strong>云存储</strong>：对 S3 兼容对象存储的原生支持</li><li><strong>OLTP 优化</strong>：专为事务工作负载设计</li><li><strong>改进性能</strong>：更好的空间利用率和查询性能</li></ul><blockquote><p><strong>注意</strong>：目前处于 Beta 阶段 - 在生产使用前请彻底评估。</p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-a970dfd99688547f0ffb0bf4d5c4de61>18.13 - Cloudberry</h1><div class=lead>使用 Pigsty 部署/监控 Cloudberry 集群，一个由 Greenplum 分叉而来的 MPP 数据仓库集群！</div><hr><h2 id=安装>安装</h2><p>Pigsty 提供了 Greenplum 6 (@el7) 与 Greenplum 7 (@el8) 的安装包，开源版本用户可以自行安装配置。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 7 Only (Greenplum6)</span>
</span></span><span style=display:flex><span>./node.yml -t node_install  -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;cloudberrydb&#34;]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 8 Only (Greenplum7)</span>
</span></span><span style=display:flex><span>./node.yml -t node_install  -e <span style=color:#4e9a06>&#39;{&#34;node_repo_modules&#34;:&#34;pgsql&#34;,&#34;node_packages&#34;:[&#34;cloudberrydb&#34;]}&#39;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-2342a2eaca8515e616cb1dfa8c4db39d>18.14 - Neon</h1><div class=lead>使用 Neon 开源的 Serverless 版本 PostgreSQL 内核，自建灵活伸缩，Scale To Zero，灵活分叉的PG服务。</div><p><a href=https://github.com/neondatabase/neon><strong>Neon</strong></a> 采用了存储与计算分离架构，提供了丝滑的自动扩缩容，Scale to Zero，以及数据库版本分叉等独家能力。</p><p>Neon 官网：https://neon.tech/</p><p>Neon 编译后的二进制产物过于庞大，目前不对开源版用户提供，目前处于试点阶段，有需求请联系 Pigsty 销售。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-06a73ab7adbd73b0e635c3d9403cab4e>19 - 常见问题</h1><div class=lead>PostgreSQL 常见问题答疑</div><hr><h2 id=我当前执行安装的用户为何不能使用-pg-管理别名>我当前执行安装的用户为何不能使用 <code>pg</code> 管理别名？</h2><p>从 Pigsty v4.0 开始，使用 <code>pg</code> 管理别名管理全局的 Patroni / PostgreSQL 集群的权限被收紧到了管理节点上的管理员分组（<code>admin</code>）。</p><p><a href=/docs/node/playbook#nodeyml><strong><code>node.yml</code></strong></a> 剧本创建的管理员（<code>dba</code>）默认具有此权限，而其他用户如果想要获得这个权限，需要你显式地将该用户加入到 <code>admin</code> 组中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo usermod -aG admin &lt;username&gt;
</span></span></code></pre></div><hr><h2 id=pgsql初始化失败fail-to-wait-for-postgrespatroni-primary>PGSQL初始化失败：Fail to wait for postgres/patroni primary</h2><p>这种错误信息存在多种可能，需要你 <a href=https://github.com/pgsty/pigsty/discussions/338>检查</a> Ansible，Systemd / Patroni / PostgreSQL 日志，找出真正的原因。</p><ul><li>可能性1：集群配置错误，找出错误的配置项修改并应用。</li><li>可能性2：在部署中存在同名集群，或者之前的同名集群主节点被不正确地移除</li><li>可能性3：在DCS中有同名集群残留的垃圾元数据：没有正确完成下线，你可以使用 <code>etcdctl del --prefix /pg/&lt;cls></code> 来手工删除残留数据（请小心）</li><li>可能性4：你的 PostgreSQL 或节点相关 RPM 包没有被成功安装</li><li>可能性5：你的 Watchdog 内核模块没有正确启用加载</li><li>可能性6：你在初始化数据库时指定的语言 Locale 不存在（例如，使用了 en_US.UTF8，但没有安装英文语言包或 Locale 支持）</li><li>如果你遇到了其他的原因，欢迎提交 Issue 或向社区求助。</li></ul><hr><h2 id=pgsql初始化失败fail-to-wait-for-postgrespatroni-replica>PGSQL初始化失败：Fail to wait for postgres/patroni replica</h2><p>存在几种可能的原因：</p><p><strong>立即失败</strong>：通常是由于配置错误、网络问题、损坏的DCS元数据等原因。你必须检查 <code>/pg/log</code> 找出实际原因。</p><p><strong>过了一会儿失败</strong>：这可能是由于源实例数据损坏。查看 PGSQL FAQ：如何在数据损坏时创建副本？</p><p><strong>过了很长时间再超时</strong>：如果 <code>wait for postgres replica</code> 任务耗时 30 分钟或更长时间并由于超时而失败，这对于大型集群（例如，1TB+，可能需要几小时创建一个副本）是很常见的。</p><p>在这种情况下，底层创建副本的过程仍在进行。你可以使用 <code>pg list &lt;cls></code> 检查集群状态并等待副本赶上主节点。然后使用以下命令继续以下任务，完成完整的从库初始化：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_hba,pg_reload,pg_backup,pgbouncer,pg_vip,pg_dns,pg_service,pg_exporter,pg_register -l &lt;problematic_replica&gt;
</span></span></code></pre></div><hr><h2 id=pgsql初始化失败abort-due-to-pg_safeguard-enabled>PGSQL初始化失败：ABORT due to pg_safeguard enabled</h2><p>这意味着正准备清理的 PostgreSQL 实例打开了防误删保险， 禁用 <code>pg_safeguard</code> 以移除 Postgres 实例。</p><p>如果防误删保险 <a href=/docs/pgsql/param#pg_safeguard><code>pg_safeguard</code></a> 打开，那么你就不能使用 <code>bin/pgsql-rm</code> 和 <code>pgsql-rm.yml</code> 剧本移除正在运行的 PGSQL 实例了。</p><p>要禁用 <code>pg_safeguard</code>，你可以在配置清单中将 <code>pg_safeguard</code> 设置为 <code>false</code>，或者在执行剧本时使用命令参数 <code>-e pg_safeguard=false</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> -l &lt;cls_to_remove&gt;    <span style=color:#8f5902;font-style:italic># 强制覆盖 pg_safeguard</span>
</span></span></code></pre></div><hr><h2 id=如何确保故障转移中数据不丢失>如何确保故障转移中数据不丢失？</h2><blockquote><p>使用 <code>crit.yml</code> 参数模板，设置 <code>pg_rpo</code> 为 <code>0</code>，或 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a> 为同步提交模式。</p></blockquote><p>考虑使用 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93><strong>同步备库</strong></a> 和 <a href=/docs/pgsql/config/cluster#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4><strong>法定多数提交</strong></a> 来确保故障转移过程中的零数据丢失。</p><p>更多细节，可以参考 <a href=/docs/deploy/security#%E5%8F%AF%E7%94%A8%E6%80%A7>安全考量 - 可用性</a> 的相关介绍。</p><hr><h2 id=磁盘写满了如何抢救>磁盘写满了如何抢救？</h2><p>如果磁盘写满了，连 Shell 命令都无法执行，<code>rm -rf /pg/dummy</code> 可以释放一些救命空间。</p><p>默认情况下，<a href=/docs/pgsql/param#pg_dummy_filesize><code>pg_dummy_filesize</code></a> 设置为 <code>64MB</code>。在生产环境中，建议将其增加到 <code>8GB</code> 或更大。</p><p>它将被放置在 PGSQL 主数据磁盘上的 <code>/pg/dummy</code> 路径下。你可以删除该文件以释放一些紧急空间：</p><p>至少可以让你在该节点上运行一些 shell 脚本来进一步回收其他空间（例如日志/WAL，过时数据，WAL归档与备份）。</p><hr><h2 id=当集群数据已经损坏时如何创建副本>当集群数据已经损坏时如何创建副本？</h2><p>Pigsty 在所有实例的 patroni 配置中设置了 <code>clonefrom: true</code> 标签，标记该实例可用于创建副本。</p><p>如果某个实例有损坏的数据文件，导致创建新副本的时候出错中断，那么你可以设置 <code>clonefrom: false</code> 来避免从损坏的实例中拉取数据。具体操作如下</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ vi /pg/bin/patroni.yml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tags:
</span></span><span style=display:flex><span>  nofailover: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>  clonefrom: <span style=color:#204a87>true</span>      <span style=color:#8f5902;font-style:italic># ----------&gt; change to false</span>
</span></span><span style=display:flex><span>  noloadbalance: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>  nosync: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>  version:  <span style=color:#4e9a06>&#39;15&#39;</span>
</span></span><span style=display:flex><span>  spec: <span style=color:#4e9a06>&#39;4C.8G.50G&#39;</span>
</span></span><span style=display:flex><span>  conf: <span style=color:#4e9a06>&#39;oltp.yml&#39;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>$ systemctl reload patroni    <span style=color:#8f5902;font-style:italic># 重新加载 Patroni 配置</span>
</span></span></code></pre></div><hr><h2 id=postgresql-监控的性能损耗如何>PostgreSQL 监控的性能损耗如何？</h2><p>一个常规 PostgreSQL 实例抓取耗时大约 200ms。抓取间隔默认为 10 秒，对于一个生产多核数据库实例来说几乎微不足道。</p><p>请注意，Pigsty 默认开启了库内对象监控，所以如果您的数据库内有数以十万计的表/索引对象，抓取可能耗时会增加到几秒。</p><p>您可以修改 Prometheus 的抓取频率，请确保一点：抓取周期应当显著高于一次抓取的时长。</p><hr><h2 id=如何监控一个现存的-postgresql-实例>如何监控一个现存的 PostgreSQL 实例？</h2><p>在 <a href=/docs/pgsql/monitor>PGSQL Monitor</a> 中提供了详细的监控配置说明。</p><hr><h2 id=如何手工从监控中移除-postgresql-监控目标>如何手工从监控中移除 PostgreSQL 监控目标？</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -t rm_metrics -l &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># 将集群 &#39;cls&#39; 的所有实例从 victoria 中移除</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgmon-rm &lt;ins&gt;     <span style=color:#8f5902;font-style:italic># 用于从 Victoria 中移除单个实例 &#39;ins&#39; 的监控对象，特别适合移除添加的外部实例</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ac541723370b0cdbf999a3eb82ccfc89>20 - 其他说明</h1><div class=lead>其他说明与杂项文档</div></div><div class=td-content><h1 id=pg-4d65100b9600fb960eb0de13b0e7c894>20.1 - 用户/角色</h1><div class=lead>用户/角色指的是使用 SQL 命令 <code>CREATE USER/ROLE</code> 创建的，数据库集簇内的逻辑对象。</div><blockquote><p>在这里的上下文中，用户指的是使用 SQL 命令 <code>CREATE USER/ROLE</code> 创建的，数据库集簇内的逻辑对象。</p></blockquote><p>在PostgreSQL中，用户直接隶属于数据库集簇而非某个具体的数据库。因此在创建业务数据库和业务用户时，应当遵循"先用户，后数据库"的原则。</p><hr><h2 id=定义用户>定义用户</h2><p>Pigsty通过两个配置参数定义数据库集群中的角色与用户：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>：定义全局统一使用的角色和用户</li><li><a href=/docs/pgsql/param#pg_users><code>pg_users</code></a>：在数据库集群层面定义业务用户和角色</li></ul><p>前者用于定义了整套环境中共用的角色与用户，后者定义单个集群中特有的业务角色与用户。二者形式相同，均为用户定义对象的数组。</p><p>你可以定义多个用户/角色，它们会按照先全局，后集群，最后按数组内排序的顺序依次创建，所以后面的用户可以属于前面定义的角色。</p><p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的业务用户定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_noco     ,password: DBUser.Noco     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for nocodb service      }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个用户/角色定义都是一个 object，可能包括以下字段，以 <code>dbuser_meta</code> 用户为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必需，`name` 是用户定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，密码，可以是 scram-sha-256 哈希字符串或明文</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，默认情况下可以登录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是超级用户吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，可以创建数据库吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，可以创建角色吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，默认情况下，此角色可以使用继承的权限吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，此角色可以进行复制吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，此角色可以绕过行级安全吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，将此用户添加到 pgbouncer 用户列表吗？（使用连接池的生产用户应该显式定义为 true）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，用户连接限制，默认 -1 禁用限制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，此角色过期时间：从创建时 + n天计算（优先级比 expire_at 更高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 可选，此角色过期的时间点，使用 YYYY-MM-DD 格式的字符串指定一个特定日期（优先级没 expire_in 高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，此用户/角色的说明与备注字符串</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认角色为：dbrole_{admin,readonly,readwrite,offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># 可选，使用 `ALTER ROLE SET` 针对这个角色，配置角色级的数据库参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认为 transaction 的 pgbouncer 池模式，用户级别</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，用户级别的最大数据库连接数，默认 -1 禁用限制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，根据 postgresql 文档的键值配置参数（例如：使用 pigsty 作为默认 search_path）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>唯一必需的字段是 <code>name</code>，它应该是 PostgreSQL 集群中的一个有效且唯一的用户名。</li><li>角色不需要 <code>password</code>，但对于可登录的业务用户，通常是需要指定一个密码的。</li><li><code>password</code> 可以是明文或 scram-sha-256 / md5 哈希字符串，请最好不要使用明文密码。</li><li>用户/角色按数组顺序逐一创建，因此，请确保角色/分组的定义在成员之前。</li><li><code>login</code>、<code>superuser</code>、<code>createdb</code>、<code>createrole</code>、<code>inherit</code>、<code>replication</code>、<code>bypassrls</code> 是布尔标志。</li><li><code>pgbouncer</code> 默认是禁用的：要将业务用户添加到 pgbouncer 用户列表，您应当显式将其设置为 <code>true</code>。</li></ul><p><strong>ACL系统</strong></p><p>Pigsty 具有一套内置的，开箱即用的访问控制 / <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7>ACL</a> 系统，您只需将以下四个默认角色分配给业务用户即可轻松使用：</p><ul><li><code>dbrole_readwrite</code>：全局读写访问的角色（主属业务使用的生产账号应当具有数据库读写权限）</li><li><code>dbrole_readonly</code>：全局只读访问的角色（如果别的业务想要只读访问，可以使用此角色）</li><li><code>dbrole_admin</code>：拥有DDL权限的角色 （业务管理员，需要在应用中建表的场景）</li><li><code>dbrole_offline</code>：受限的只读访问角色（只能访问 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>offline</a> 实例，通常是个人用户）</li></ul><p>如果您希望重新设计您自己的 ACL 系统，可以考虑定制以下参数和模板：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>：系统范围的角色和全局用户</li><li><a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a>：新建对象的默认权限</li><li><a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-role.sql><code>roles/pgsql/templates/pg-init-role.sql</code></a>：角色创建 SQL 模板</li><li><a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>roles/pgsql/templates/pg-init-template.sql</code></a>：权限 SQL 模板</li></ul><hr><h2 id=创建用户>创建用户</h2><p>在 <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> 和 <a href=/docs/pgsql/param#pg_users><code>pg_users</code></a> 中 <a href=#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7>定义</a> 的用户和角色，将在集群初始化的 PROVISION 阶段中自动逐一创建。
如果您希望在现有的集群上 <a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7>创建用户</a>，可以使用 <code>bin/pgsql-user</code> 工具。
将新用户/角色定义添加到 <code>all.children.&lt;cls>.pg_users</code>，并使用以下方法创建该数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>不同于数据库，创建用户的剧本总是幂等的。当目标用户已经存在时，Pigsty会修改目标用户的属性使其符合配置。所以在现有集群上重复运行它通常不会有问题。</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>请使用剧本创建用户</div><p>我们不建议您手工创建新的业务用户，特别当您想要创建的用户使用默认的 pgbouncer 连接池时：除非您愿意手工负责维护 Pgbouncer 中的用户列表并与 PostgreSQL 保持一致。
使用 <strong><code>bin/pgsql-user</code></strong> 工具或 <a href=/docs/pgsql/playbook#pgsql-useryml><strong><code>pgsql-user.yml</code></strong></a> 剧本创建新数据库时，会将此数据库一并添加到 <a href=#pgbouncer%E7%94%A8%E6%88%B7>Pgbouncer用户</a> 列表中。</p></div><hr><h2 id=修改用户>修改用户</h2><p>修改 PostgreSQL 用户的属性的方式与 <a href=#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7><strong>创建用户</strong></a> 相同。</p><p>首先，调整您的用户定义，修改需要调整的属性，然后执行以下命令应用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>请注意，修改用户不会删除用户，而是通过 <code>ALTER USER</code> 命令修改用户属性；也不会回收用户的权限与分组，并使用 <code>GRANT</code> 命令授予新的角色。</p><hr><h2 id=pgbouncer用户>Pgbouncer用户</h2><p>默认情况下启用 Pgbouncer，并作为连接池中间件，其用户默认被管理。</p><p>Pigsty 默认将 <a href=/docs/pgsql/param#pg_users><code>pg_users</code></a> 中显式带有 <code>pgbouncer: true</code> 标志的所有用户添加到 pgbouncer 用户列表中。</p><p>Pgbouncer 连接池中的用户在 <code>/etc/pgbouncer/userlist.txt</code> 中列出：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>&#34;postgres&#34; &#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_wiki&#34; &#34;SCRAM-SHA-256$4096:+77dyhrPeFDT/TptHs7/7Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$KeatuohpKIYzHPCt/tqBu85vI11o9mar/by0hHYM2W8=:X9gig4JtjoS8Y/o1vQsIX/gY1Fns8ynTXkbWOjUfbRQ=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_view&#34; &#34;SCRAM-SHA-256$4096:DFoZHU/DXsHL8MJ8regdEw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$gx9sUGgpVpdSM4o6A2R9PKAUkAsRPLhLoBDLBUYtKS0=:MujSgKe6rxcIUMv4GnyXJmV0YNbf39uFRZv724+X1FE=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_monitor&#34; &#34;SCRAM-SHA-256$4096:fwU97ZMO/KR0ScHO5+UuBg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$CrNsmGrx1DkIGrtrD1Wjexb/aygzqQdirTO1oBZROPY=:L8+dJ+fqlMQh7y4PmVR/gbAOvYWOr+KINjeMZ8LlFww=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_meta&#34; &#34;SCRAM-SHA-256$4096:leB2RQPcw1OIiRnPnOMUEg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$eyC+NIMKeoTxshJu314+BmbMFpCcspzI3UFZ1RYfNyU=:fJgXcykVPvOfro2MWNkl5q38oz21nSl1dTtM65uYR1Q=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_kong&#34; &#34;SCRAM-SHA-256$4096:bK8sLXIieMwFDz67/0dqXQ</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$P/tCRgyKx9MC9LH3ErnKsnlOqgNd/nn2RyvThyiK6e4=:CDM8QZNHBdPf97ztusgnE7olaKDNHBN0WeAbP/nzu5A=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_grafana&#34; &#34;SCRAM-SHA-256$4096:HjLdGaGmeIAGdWyn2gDt/Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$jgoyOB8ugoce+Wqjr0EwFf8NaIEMtiTuQTg1iEJs9BM=:ed4HUFqLyB4YpRr+y25FBT7KnlFDnan6JPVT9imxzA4=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_gitea&#34; &#34;SCRAM-SHA-256$4096:l1DBGCc4dtircZ8O8Fbzkw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$tpmGwgLuWPDog8IEKdsaDGtiPAxD16z09slvu+rHE74=:pYuFOSDuWSofpD9OZhG7oWvyAR0PQjJBffgHZLpLHds=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_dba&#34; &#34;SCRAM-SHA-256$4096:zH8niABU7xmtblVUo2QFew</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$Zj7/pq+ICZx7fDcXikiN7GLqkKFA+X5NsvAX6CMshF0=:pqevR2WpizjRecPIQjMZOm+Ap+x0kgPL2Iv5zHZs0+g=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_bytebase&#34; &#34;SCRAM-SHA-256$4096:OMoTM9Zf8QcCCMD0svK5gg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$kMchqbf4iLK1U67pVOfGrERa/fY818AwqfBPhsTShNQ=:6HqWteN+AadrUnrgC0byr5A72noqnPugItQjOLFw0Wk=&#34;</span>
</span></span></code></pre></div><p>而用户级别的连接池参数则是使用另一个单独的文件： <code>/etc/pgbouncer/useropts.txt</code> 进行维护，比如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>                  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>              <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><p>当您 <a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93>创建数据库</a> 时，Pgbouncer 的数据库列表定义文件将会被刷新，并通过在线重载配置的方式生效，不会影响现有的连接。</p><p>Pgbouncer 使用和 PostgreSQL 同样的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户，您可以使用 <code>pgb</code> 别名，使用 dbsu 访问 pgbouncer 管理功能。</p><p>Pigsty 还提供了一个实用函数 <code>pgb-route</code> ，可以将 pgbouncer 数据库流量快速切换至集群中的其他节点，用于零停机迁移：</p><p>连接池用户配置文件 <code>userlist.txt</code> 与 <code>useropts.txt</code> 会在您 <a href=#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7>创建用户</a> 时自动刷新，并通过在线重载配置的方式生效，正常不会影响现有的连接。</p><p>请注意，<a href=/docs/pgsql/param#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a> 参数允许你使用动态查询来完成连接池用户认证，当您懒得管理连接池中的用户时，这是一种折中的方案。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e73c12463833eb5e14e27191b7858ef7>20.2 - 数据库</h1><div class=lead>数据库指的是使用 SQL 命令 <code>CREATE DATABASE</code> 创建的，数据库集簇内的逻辑对象。</div><blockquote><p>在这里的上下文中，数据库指的是使用 SQL 命令 <code>CREATE DATABASE</code> 创建的，数据库集簇内的逻辑对象。</p></blockquote><p>一组 PostgreSQL 服务器可以同时服务于多个 <strong>数据库</strong> （Database）。在 Pigsty 中，你可以在集群配置中 <a href=#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>定义</a> 好所需的数据库。</p><p>Pigsty会对默认模板数据库<code>template1</code>进行修改与定制，创建默认模式，安装默认扩展，配置默认权限，新创建的数据库默认会从<code>template1</code>继承这些设置。</p><p>默认情况下，所有业务数据库都会被1:1添加到 Pgbouncer 连接池中；<code>pg_exporter</code> 默认会通过 <strong>自动发现</strong> 机制查找所有业务数据库并进行库内对象监控。</p><hr><h2 id=定义数据库>定义数据库</h2><p>业务数据库定义在数据库集群参数 <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> 中，这是一个数据库定义构成的对象数组。
数组内的数据库按照<strong>定义顺序</strong>依次创建，因此后面定义的数据库可以使用先前定义的数据库作为<strong>模板</strong>。</p><p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的数据库定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: noco     ,owner: dbuser_noco     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>nocodb database }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个数据库定义都是一个 object，可能包括以下字段，以 <code>meta</code> 数据库为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是数据库定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库 sql 的基线定义文件路径（ansible 搜索路径中的相对路径，如 files/）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库添加到 pgbouncer 数据库列表？默认为 true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要创建的附加模式，由模式名称字符串组成的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，要安装的附加扩展： 扩展对象的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可以指定将扩展安装到某个模式中，也可以不指定（不指定则安装到 search_path 首位模式中）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 例如有的扩展会创建并使用固定的模式，就不需要指定模式。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库的说明与备注信息</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库所有者，默认为 postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要使用的模板，默认为 template1，目标必须是一个模板数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库编码，默认为 UTF8（必须与模板数据库相同）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库地区设置，默认为 C（必须与模板数据库相同）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库 collate 排序规则，默认为 C（必须与模板数据库相同），没有理由不建议更改。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库 ctype 字符集，默认为 C（必须与模板数据库相同）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认表空间，默认为 &#39;pg_default&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库注册到 grafana 数据源？默认为 true，显式设置为 false 会跳过注册</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库连接限制，默认为 -1 ，不限制，设置为正整数则会限制连接数。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，连接到此 pgbouncer 数据库的所有连接都将使用此用户进行验证（启用 pgbouncer_auth_query 才有用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池化模式，默认为 transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 默认池子大小，默认为 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池子保留空间，默认为 32，当默认池子不够用时，最多再申请这么多条突发连接。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池的最小大小，默认为 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的最大数据库连接数，默认为 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>唯一必选的字段是 <code>name</code>，它应该是当前 PostgreSQL 集群中有效且唯一的数据库名称，其他参数都有合理的默认值。</p><ul><li><code>name</code>：数据库名称，<strong>必选项</strong>。</li><li><code>baseline</code>：SQL文件路径（Ansible搜索路径，通常位于<code>files</code>），用于初始化数据库内容。</li><li><code>owner</code>：数据库属主，默认为<code>postgres</code></li><li><code>template</code>：数据库创建时使用的模板，默认为<code>template1</code></li><li><code>encoding</code>：数据库默认字符编码，默认为<code>UTF8</code>，默认与实例保持一致。建议不要配置与修改。</li><li><code>locale</code>：数据库默认的本地化规则，默认为<code>C</code>，建议不要配置，与实例保持一致。</li><li><code>lc_collate</code>：数据库默认的本地化字符串排序规则，默认与实例设置相同，建议不要修改，必须与模板数据库一致。强烈建议不要配置，或配置为<code>C</code>。</li><li><code>lc_ctype</code>：数据库默认的LOCALE，默认与实例设置相同，建议不要修改或设置，必须与模板数据库一致。建议配置为C或<code>en_US.UTF8</code>。</li><li><code>allowconn</code>：是否允许连接至数据库，默认为<code>true</code>，不建议修改。</li><li><code>revokeconn</code>：是否回收连接至数据库的权限？默认为<code>false</code>。如果为<code>true</code>，则数据库上的<code>PUBLIC CONNECT</code>权限会被回收。只有默认用户（<code>dbsu|monitor|admin|replicator|owner</code>）可以连接。此外，<code>admin|owner</code> 会拥有GRANT OPTION，可以赋予其他用户连接权限。</li><li><code>tablespace</code>：数据库关联的表空间，默认为<code>pg_default</code>。</li><li><code>connlimit</code>：数据库连接数限制，默认为<code>-1</code>，即没有限制。</li><li><code>extensions</code>：对象数组 ，每一个对象定义了一个数据库中的<strong>扩展</strong>，以及其安装的<strong>模式</strong>。</li><li><code>parameters</code>：KV对象，每一个KV定义了一个需要针对数据库通过<code>ALTER DATABASE</code>修改的参数。</li><li><code>pgbouncer</code>：布尔选项，是否将该数据库加入到Pgbouncer中。所有数据库都会加入至Pgbouncer列表，除非显式指定<code>pgbouncer: false</code>。</li><li><code>comment</code>：数据库备注信息。</li><li><code>pool_auth_user</code>：启用 <a href=/docs/pgsql/param#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a> 时，连接到此 pgbouncer 数据库的所有连接都将使用这里指定的用户执行认证查询。你需要使用一个具有访问 <code>pg_shadow</code> 表权限的用户。</li><li><code>pool_mode</code>：数据库级别的 pgbouncer 池化模式，默认为 transaction，即事物池化。如果留空，会使用 <a href=/docs/pgsql/param#pgbouncer_poolmode><code>pgbouncer_poolmode</code></a> 参数作为默认值。</li><li><code>pool_size</code>：数据库级别的 pgbouncer 默认池子大小，默认为 64</li><li><code>pool_reserve</code>：数据库级别的 pgbouncer 池子保留空间，默认为 32，当默认池子不够用时，最多再申请这么多条突发连接。</li><li><code>pool_size_min</code>： 数据库级别的 pgbouncer 池的最小大小，默认为 0</li><li><code>pool_connlimit</code>： 数据库级别的 pgbouncer 连接池最大数据库连接数，默认为 100</li></ul><p>新创建的数据库默认会从 <code>template1</code> 数据库 Fork 出来，这个模版数据库会在 <a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a> 阶段进行定制修改：
配置好扩展，模式以及默认权限，因此新创建的数据库也会继承这些配置，除非您显式使用一个其他的数据库作为模板。</p><p>关于数据库的访问权限，请参考 <a href=/docs/concept/sec/ac/#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9A%94%E7%A6%BB>ACL：数据库权限</a> 一节。</p><hr><h2 id=创建数据库>创建数据库</h2><p>在 <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> 中 <a href=#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>定义</a> 的数据库将在集群初始化时自动创建。
如果您希望在现有集群上 <a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93>创建数据库</a>，可以使用 <code>bin/pgsql-db</code> 包装脚本。
将新的数据库定义添加到 <code>all.children.&lt;cls>.pg_databases</code> 中，并使用以下命令创建该数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style=color:#8f5902;font-style:italic># pgsql-db.yml -l &lt;cls&gt; -e dbname=&lt;dbname&gt;</span>
</span></span></code></pre></div><p>下面是新建数据库时的一些注意事项：</p><p>创建数据库的剧本默认为幂等剧本，不过当您当使用 <code>baseline</code> 脚本时就不一定了：这种情况下，通常不建议在现有数据库上重复执行此操作，除非您确定所提供的 baseline SQL也是幂等的。</p><p>我们不建议您手工创建新的数据库，特别当您使用默认的 pgbouncer 连接池时：除非您愿意手工负责维护 Pgbouncer 中的数据库列表并与 PostgreSQL 保持一致。
使用 <code>pgsql-db</code> 工具或 <code>pgsql-db.yml</code> 剧本创建新数据库时，会将此数据库一并添加到 <a href=#pgbouncer%E6%95%B0%E6%8D%AE%E5%BA%93>Pgbouncer 数据库</a> 列表中。</p><p>如果您的数据库定义有一个非常规 <code>owner</code>（默认为 dbsu <code>postgres</code>），那么请确保在创建该数据库前，属主用户已经存在。
最佳实践永远是在创建数据库之前 <a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7>创建</a> <a href=/docs/pgsql/config/user>用户</a>。</p><hr><h2 id=pgbouncer数据库>Pgbouncer数据库</h2><p>Pigsty 会默认为 PostgreSQL 实例 1:1 配置启用一个 Pgbouncer 连接池，使用 <code>/var/run/postgresql</code> Unix Socket 通信。</p><p>连接池可以优化短连接性能，降低并发征用，以避免过高的连接数冲垮数据库，并在数据库迁移时提供额外的灵活处理空间。</p><p>Pigsty 默认将 <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> 中的所有数据库都添加到 pgbouncer 的数据库列表中。
您可以通过在数据库 <a href=#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>定义</a> 中显式设置 <code>pgbouncer: false</code> 来禁用特定数据库的 pgbouncer 连接池支持。</p><p>Pgbouncer数据库列表在 <code>/etc/pgbouncer/database.txt</code> 中定义，数据库定义中关于连接池的参数会体现在这里：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>meta                        = host=/var/run/postgresql mode=session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>grafana                     = host=/var/run/postgresql mode=transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bytebase                    = host=/var/run/postgresql auth_user=dbuser_meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>kong                        = host=/var/run/postgresql pool_size=32 reserve_pool=64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>gitea                       = host=/var/run/postgresql min_pool_size=10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>wiki                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>noco                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>mongo                       = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>当您 <a href=#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93>创建数据库</a> 时，Pgbouncer 的数据库列表定义文件将会被刷新，并通过在线重载配置的方式生效，正常不会影响现有的连接。</p><p>Pgbouncer 使用和 PostgreSQL 同样的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户，您可以使用 <code>pgb</code> 别名，使用 dbsu 访问 pgbouncer 管理功能。</p><p>Pigsty 还提供了一个实用函数 <code>pgb-route</code> ，可以将 pgbouncer 数据库流量快速切换至集群中的其他节点，用于零停机迁移：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># route pgbouncer traffic to another cluster member</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pgb-route<span style=color:#ce5c00;font-weight:700>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>local</span> <span style=color:#000>ip</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>1</span><span style=color:#000;font-weight:700>-</span><span style=color:#4e9a06>&#39;\/var\/run\/postgresql&#39;</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>  sed -ie <span style=color:#4e9a06>&#34;s/host=[^[:space:]]\+/host=</span><span style=color:#4e9a06>${</span><span style=color:#000>ip</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-3a18781032fdda789d5f38d1dd1c01a2>20.3 - 服务/接入</h1><div class=lead>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</div><blockquote><p>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</p></blockquote><p><a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>服务</a> 是一种抽象：它是数据库集群对外提供能力的形式，并封装了底层集群的细节。</p><p>服务对于生产环境中的 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>稳定接入</a> 至关重要，在 <a href=/docs/concept/ha>高可用</a> 集群自动故障时方显其价值，<a href=#%E5%8D%95%E6%9C%BA%E7%94%A8%E6%88%B7>单机用户</a> 通常不需要操心这个概念。</p><hr><h2 id=单机用户>单机用户</h2><p>“服务” 的概念是给生产环境用的，个人用户/单机集群可以不折腾，直接拿实例名/IP地址访问数据库。</p><p>例如，Pigsty 默认的单节点 <code>pg-meta</code>.<code>meta</code> 数据库，就可以直接用下面三个不同的用户连接上去。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># 直接用 DBA 超级用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># 用默认的业务管理员用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># 用默认的只读用户走实例域名连上去</span>
</span></span></code></pre></div><hr><h2 id=服务概述>服务概述</h2><p>在真实世界生产环境中，我们会使用基于复制的主从数据库集群。集群中有且仅有一个实例作为领导者（<a href=/docs/pgsql/config/cluster#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93>主库</a>）可以接受写入。
而其他实例（<a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>从库</a>）则会从持续从集群领导者获取变更日志，与领导者保持一致。同时，从库还可以承载只读请求，在读多写少的场景下可以显著分担主库的负担，
因此对集群的写入请求与只读请求进行区分，是一种十分常见的实践。</p><p>此外对于高频短连接的生产环境，我们还会通过连接池中间件（Pgbouncer）对请求进行池化，减少连接与后端进程的创建开销。但对于ETL与变更执行等场景，我们又需要绕过连接池，直接访问数据库。
同时，高可用集群在故障时会出现故障切换（Failover），故障切换会导致集群的领导者出现变更。因此高可用的数据库方案要求写入流量可以自动适配集群的领导者变化。
这些不同的访问需求（读写分离，池化与直连，故障切换自动适配）最终抽象出 <strong>服务</strong> （Service）的概念。</p><p>通常来说，数据库集群都必须提供这种最基础的服务：</p><ul><li><strong>读写服务（primary）</strong> ：可以读写数据库</li></ul><p>对于生产数据库集群，至少应当提供这两种服务：</p><ul><li><strong>读写服务（primary）</strong> ：写入数据：只能由主库所承载。</li><li><strong>只读服务（replica）</strong> ：读取数据：可以由从库承载，没有从库时也可由主库承载</li></ul><p>此外，根据具体的业务场景，可能还会有其他的服务，例如：</p><ul><li><strong>默认直连服务（default）</strong> ：允许（管理）用户，绕过连接池直接访问数据库的服务</li><li><strong>离线从库服务（offline）</strong> ：不承接线上只读流量的专用从库，用于ETL与分析查询</li><li><strong>同步从库服务（standby）</strong> ：没有复制延迟的只读服务，由 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a>/主库处理只读查询</li><li><strong>延迟从库服务（delayed）</strong> ：访问同一个集群在一段时间之前的旧数据，由 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟从库</a> 来处理</li></ul><hr><h2 id=默认服务>默认服务</h2><p>Pigsty默认为每个 PostgreSQL 数据库集群提供四种不同的服务，以下是默认服务及其定义：</p><table class=full-width><thead><tr><th>服务</th><th>端口</th><th>描述</th></tr></thead><tbody><tr><td><a href=#primary%E6%9C%8D%E5%8A%A1>primary</a></td><td>5433</td><td>生产读写，连接到主库连接池（6432）</td></tr><tr><td><a href=#replica%E6%9C%8D%E5%8A%A1>replica</a></td><td>5434</td><td>生产只读，连接到备库连接池（6432）</td></tr><tr><td><a href=#default%E6%9C%8D%E5%8A%A1>default</a></td><td>5436</td><td>管理，ETL写入，直接访问主库（5432）</td></tr><tr><td><a href=#offline%E6%9C%8D%E5%8A%A1>offline</a></td><td>5438</td><td>OLAP、ETL、个人用户、交互式查询</td></tr></tbody></table><p>以默认的 <code>pg-meta</code> 集群为例，它提供四种默认服务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5433/meta   <span style=color:#8f5902;font-style:italic># pg-meta-primary : 通过主要的 pgbouncer(6432) 进行生产读写</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5434/meta   <span style=color:#8f5902;font-style:italic># pg-meta-replica : 通过备份的 pgbouncer(6432) 进行生产只读</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@pg-meta:5436/meta     <span style=color:#8f5902;font-style:italic># pg-meta-default : 通过主要的 postgres(5432) 直接连接</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_stats:DBUser.Stats@pg-meta:5438/meta <span style=color:#8f5902;font-style:italic># pg-meta-offline : 通过离线的 postgres(5432) 直接连接</span>
</span></span></code></pre></div><p>从示例集群 <a href=/docs/concept/arch/pgsql>架构图</a> 上可以看出这四种服务的工作方式：</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>注意在这里<code>pg-meta</code> 域名指向了集群的 L2 VIP，进而指向集群主库上的 haproxy 负载均衡器，它负责将流量路由到不同的实例上，详见 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>服务接入</a></p><hr><h2 id=服务实现>服务实现</h2><p>在 Pigsty 中，服务使用 <a href=/docs/node>节点</a> 上的 <a href=/docs/node/param#haproxy>haproxy</a> 来实现，通过主机节点上的不同端口进行区分。</p><p>Pigsty 所纳管的每个节点上都默认启用了 Haproxy 以对外暴露服务，而数据库节点也不例外。
集群中的节点尽管从数据库的视角来看有主从之分，但从服务的视角来看，每个节点都是相同的：
这意味着即使您访问的是从库节点，只要使用正确的服务端口，就依然可以使用到主库读写的服务。
这样的设计可以屏蔽复杂度：所以您只要可以访问 PostgreSQL 集群上的任意一个实例，就可以完整的访问到所有服务。</p><p>这样的设计类似于 Kubernetes 中的 NodePort 服务，同样在 Pigsty 中，每一个服务都包括以下两个核心要素：</p><ol><li>通过 NodePort 暴露的访问端点（端口号，从哪访问？）</li><li>通过 Selectors 选择的目标实例（实例列表，谁来承载？）</li></ol><p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器，请参考 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>接入服务</a>。</p><p>所有的服务都通过配置文件进行声明，例如，PostgreSQL 默认服务就是由 <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> 参数所定义的：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您也可以在 <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a> 中定义额外的服务，参数 <code>pg_default_services</code> 与 <code>pg_services</code> 都是由 <a href=#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1>服务定义</a> 对象组成的数组。</p><hr><h2 id=定义服务>定义服务</h2><p>Pigsty 允许您定义自己的服务：</p><ul><li><a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a>：所有 PostgreSQL 集群统一对外暴露的服务，默认有四个。</li><li><a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>：额外的 PostgreSQL 服务，可以视需求在全局或集群级别定义。</li><li><a href=/docs/node/param#haproxy_services><code>haproxy_servies</code></a>：直接定制 HAProxy 服务内容，可以用于其他组件的接入</li></ul><p>对于 PostgreSQL 集群来说，通常只需要关注前两者即可。
每一条服务定义都会在所有相关 HAProxy 实例的配置目录下生成一个新的配置文件：<a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/service.j2><code>/etc/haproxy/&lt;svcname>.cfg</code></a>
下面是一个自定义的服务样例 <code>standby</code>：当您想要对外提供没有复制延迟的只读服务时，就可以在 <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a> 新增这条记录：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>standby                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，服务名称，最终的 svc 名称会使用 `pg_cluster` 作为前缀，例如：pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 必选，暴露的服务端口（作为 kubernetes 服务节点端口模式）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># 可选，服务绑定的 IP 地址，默认情况下为所有 IP 地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># 必选，服务成员选择器，使用 JMESPath 来筛选配置清单</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 可选，服务成员选择器（备份），也就是当默认选择器选中的实例都宕机后，服务才会由这里选中的实例成员来承载</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，目标端口，default|postgres|pgbouncer|&lt;port_number&gt;，默认为 &#39;default&#39;，Default的意思就是使用 pg_default_service_dest 的取值来最终决定</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>check</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，健康检查 URL 路径，默认为 /，这里使用 Patroni API：/sync ，只有同步备库和主库才会返回 200 健康状态码 </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，允许的前端连接最大数，默认为5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>balance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>roundrobin            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，haproxy 负载均衡算法（默认为 roundrobin，其他选项：leastconn）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>而上面的服务定义，在样例的三节点 <code>pg-test</code> 上将会被转换为 haproxy 配置文件 <code>/etc/haproxy/pg-test-standby.conf</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service: pg-test-standby @ 10.10.10.11:5435</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service instances 10.10.10.11, 10.10.10.13, 10.10.10.12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service backups   10.10.10.11</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>listen pg-test-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5435           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 绑定了所有IP地址上的 5435 端口</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 负载均衡器工作在 TCP 协议上</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 最大连接数为 5000，可按需调大</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 负载均衡算法为 rr 轮询，还可以使用 leastconn </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 启用 HTTP 健康检查</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 保持HTTP连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /sync  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- 这里使用 /sync ，Patroni 健康检查 API ，只有同步备库和主库才会返回 200 健康状态码。 </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- 健康检查返回代码 200 代表正常</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers： # pg-test 集群全部三个实例都被 selector: &#34;[]&#34; 给圈中了，因为没有任何的筛选条件，所以都会作为 pg-test-replica 服务的后端服务器。但是因为还有 /sync 健康检查，所以只有主库和同步备库才能真正承载请求。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;----- 唯独主库满足条件 pg_role == `primary`， 被 backup selector 选中。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#        因此作为服务的兜底实例：平时不承载请求，其他从库全部宕机后，才会承载只读请求，从而最大避免了读写服务受到只读服务的影响</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#        </span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>在这里，<code>pg-test</code> 集群全部三个实例都被 <code>selector: "[]"</code> 给圈中了，渲染进入 <code>pg-test-replica</code> 服务的后端服务器列表中。但是因为还有 <code>/sync</code> 健康检查，Patroni Rest API只有在主库和 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a> 上才会返回代表健康的 HTTP 200 状态码，因此只有主库和同步备库才能真正承载请求。
此外，主库因为满足条件 <code>pg_role == primary</code>， 被 backup selector 选中，被标记为了备份服务器，只有当没有其他实例（也就是同步备库）可以满足需求时，才会顶上。</p><hr><h2 id=primary服务>Primary服务</h2><p>Primary服务可能是生产环境中最关键的服务，它在 5433 端口提供对数据库集群的读写能力，服务定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>选择器参数 <code>selector: "[]"</code> 意味着所有集群成员都将被包括在Primary服务中</li><li>但只有主库能够通过健康检查（<code>check: /primary</code>），实际承载Primary服务的流量。</li><li>目的地参数 <code>dest: default</code> 意味着Primary服务的目的地受到 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 参数的影响</li><li><code>dest</code> 默认值 <code>default</code> 会被替换为 <code>pg_default_service_dest</code> 的值，默认为 <code>pgbouncer</code>。</li><li>默认情况下 Primary 服务的目的地默认是主库上的连接池，也就是由 <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a> 指定的端口，默认为 6432</li></ul><p>如果 <code>pg_default_service_dest</code> 的值为 <code>postgres</code>，那么 primary 服务的目的地就会绕过连接池，直接使用 PostgreSQL 数据库的端口（<a href=/docs/pgsql/param#pg_port><code>pg_port</code></a>，默认值 5432），对于一些不希望使用连接池的场景，这个参数非常实用。</p><details><summary>示例：pg-test-primary 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>listen pg-test-primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5433        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary 服务默认使用 5433 端口</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /primary</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary 服务默认使用 Patroni RestAPI /primary 健康检查</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><p>Patroni 的 <a href=/docs/concept/ha>高可用</a> 机制确保任何时候最多只会有一个实例的 <code>/primary</code> 健康检查为真，因此Primary服务将始终将流量路由到主实例。</p><p>使用 Primary 服务而不是直连数据库的一个好处是，如果集群因为某种情况出现了双主（比如在没有watchdog的情况下kill -9杀死主库 Patroni），Haproxy在这种情况下仍然可以避免脑裂，因为它只会在 Patroni 存活且返回主库状态时才会分发流量。</p><hr><h2 id=replica服务>Replica服务</h2><p>Replica服务在生产环境中的重要性仅次于Primary服务，它在 5434 端口提供对数据库集群的只读能力，服务定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>选择器参数 <code>selector: "[]"</code> 意味着所有集群成员都将被包括在Replica服务中</li><li>所有实例都能够通过健康检查（<code>check: /read-only</code>），承载Replica服务的流量。</li><li>备份选择器：<code>[? pg_role == 'primary' || pg_role == 'offline' ]</code> 将主库和 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a> 标注为备份服务器。</li><li>只有当所有 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>普通从库</a> 都宕机后，Replica服务才会由主库或离线从库来承载。</li><li>目的地参数 <code>dest: default</code> 意味着Replica服务的目的地也受到 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 参数的影响</li><li><code>dest</code> 默认值 <code>default</code> 会被替换为 <code>pg_default_service_dest</code> 的值，默认为 <code>pgbouncer</code>，这一点和 <a href=#primary%E6%9C%8D%E5%8A%A1>Primary服务</a> 相同</li><li>默认情况下 Replica 服务的目的地默认是从库上的连接池，也就是由 <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a> 指定的端口，默认为 6432</li></ul><details><summary>示例：pg-test-replica 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5434</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /read-only</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><p>Replica服务非常灵活：如果有存活的专用 Replica 实例，那么它会优先使用这些实例来承载只读请求，只有当从库实例全部宕机后，才会由主库来兜底只读请求。对于常见的一主一从双节点集群就是：只要从库活着就用从库，从库挂了再用主库。</p><p>此外，除非专用只读实例全部宕机，Replica 服务也不会使用专用 Offline 实例，这样就避免了在线快查询与离线慢查询混在一起，相互影响。</p><hr><h3 id=default服务>Default服务</h3><p>Default服务在 5436 端口上提供服务，它是Primary服务的变体。</p><p>Default服务总是绕过连接池直接连到主库上的 PostgreSQL，这对于管理连接、ETL写入、CDC数据变更捕获等都很有用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果 <code>pg_default_service_dest</code> 被修改为 <code>postgres</code>，那么可以说 Default 服务除了端口和名称内容之外，与 Primary 服务是完全等价的。在这种情况下，您可以考虑将 Default 从默认服务中剔除。</p><details><summary>示例：pg-test-default 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-default</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5436         # &lt;--- 除了监听端口/目标端口和服务名，其他配置和 primary 服务一模一样</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><hr><h3 id=offline服务>Offline服务</h3><p>Default服务在 5438 端口上提供服务，它也绕开连接池直接访问 PostgreSQL 数据库，通常用于慢查询/分析查询/ETL读取/个人用户交互式查询，其服务定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Offline服务将流量直接路由到专用的 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a> 上，或者带有 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> 标记的普通 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读实例</a>。</p><ul><li>选择器参数从集群中筛选出了两种实例：<a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code> 的离线从库，或是带有 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code> 标记的普通 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读实例</a></li><li>专用离线从库和打标记的普通从库主要的区别在于：前者默认不承载 <a href=#replica%E6%9C%8D%E5%8A%A1>Replica服务</a> 的请求，避免快慢请求混在一起，而后者默认会承载。</li><li>备份选择器参数从集群中筛选出了一种实例：不带 offline 标记的普通从库，这意味着如果离线实例或者带Offline标记的普通从库挂了之后，其他普通的从库可以用来承载Offline服务。</li><li>健康检查 <code>/replica</code> 只会针对从库返回 200， 主库会返回错误，因此 Offline服务 永远不会将流量分发到主库实例上去，哪怕集群中只剩这一台主库。</li><li>同时，主库实例既不会被选择器圈中，也不会被备份选择器圈中，因此它永远不会承载Offline服务。因此 Offline 服务总是可以避免用户访问主库，从而避免对主库的影响。</li></ul><details><summary>示例：pg-test-offline 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-offline</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5438</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100 backup</span>
</span></span></code></pre></div></details><p>Offline服务提供受限的只读服务，通常用于两类查询：交互式查询（个人用户），慢查询长事务（分析/ETL）。</p><p>Offline 服务需要额外的维护照顾：当集群发生主从切换或故障自动切换时，集群的实例角色会发生变化，而 Haproxy 的配置却不会自动发生变化。对于有多个从库的集群来说，这通常并不是一个问题。
然而对于一主一从，从库跑Offline查询的精简小集群而言，主从切换意味着从库变成了主库（健康检查失效），原来的主库变成了从库（不在 Offline 后端列表中），于是没有实例可以承载 Offline 服务了，因此需要手动 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a> 以使变更生效。</p><p>如果您的业务模型较为简单，您可以考虑剔除 Default 服务与 Offline 服务，使用 Primary 服务与 Replica 服务直连数据库。</p><hr><h2 id=重载服务>重载服务</h2><p>当集群成员发生变化，如添加/删除副本、主备切换或调整相对权重时， 你需要 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a> 以使更改生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ip...<span style=color:#ce5c00;font-weight:700>]</span>         <span style=color:#8f5902;font-style:italic># 为 lb 集群或 lb 实例重载服务</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ./pgsql.yml -t pg_service         # 重载服务的实际 ansible 任务</span>
</span></span></code></pre></div><hr><h2 id=接入服务>接入服务</h2><p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器。</p><p>典型的做法是使用 DNS 或 VIP 接入，将其绑定在集群所有或任意数量的负载均衡器上。</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>你可以使用不同的 主机 & 端口 组合，它们以不同的方式提供 PostgreSQL 服务。</p><p><strong>主机</strong></p><table class=full-width><thead><tr><th>类型</th><th>样例</th><th>描述</th></tr></thead><tbody><tr><td>集群域名</td><td><code>pg-test</code></td><td>通过集群域名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>集群 VIP 地址</td><td><code>10.10.10.3</code></td><td>通过由 <code>vip-manager</code> 管理的 L2 VIP 地址访问，绑定到主节点</td></tr><tr><td>实例主机名</td><td><code>pg-test-1</code></td><td>通过任何实例主机名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>实例 IP 地址</td><td><code>10.10.10.11</code></td><td>访问任何实例的 IP 地址</td></tr></tbody></table><p><strong>端口</strong></p><p>Pigsty 使用不同的 <strong>端口</strong> 来区分 <a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>pg services</a></p><table class=full-width><thead><tr><th>端口</th><th>服务</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>数据库</td><td>直接访问 postgres 服务器</td></tr><tr><td>6432</td><td>pgbouncer</td><td>中间件</td><td>访问 postgres 前先通过连接池中间件</td></tr><tr><td>5433</td><td>primary</td><td>服务</td><td>访问主 pgbouncer (或 postgres)</td></tr><tr><td>5434</td><td>replica</td><td>服务</td><td>访问备份 pgbouncer (或 postgres)</td></tr><tr><td>5436</td><td>default</td><td>服务</td><td>访问主 postgres</td></tr><tr><td>5438</td><td>offline</td><td>服务</td><td>访问离线 postgres</td></tr></tbody></table><p><strong>组合</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群域名访问</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主直接连接</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群 VIP 直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例名</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 数据库实例直接连接 (单例访问)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库离线读/写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例 IP 访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># 数据库实例直接连接 (直接指定实例, 没有自动流量分配)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库离线读-写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 智能客户端：自动进行读写分离</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div><hr><h2 id=覆盖服务>覆盖服务</h2><p>你可以通过多种方式覆盖默认的服务配置，一种常见的需求是让 <a href=#primary%E6%9C%8D%E5%8A%A1>Primary服务</a> 与 <a href=#replica%E6%9C%8D%E5%8A%A1>Replica服务</a> 绕过Pgbouncer连接池，直接访问 PostgreSQL 数据库。</p><p>为了实现这一点，你可以将 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 更改为 <code>postgres</code>，这样所有服务定义中 <code>svc.dest='default'</code> 的服务都会使用 <code>postgres</code> 而不是默认的 <code>pgbouncer</code> 作为目标。</p><p>如果您已经将 <a href=#primary%E6%9C%8D%E5%8A%A1>Primary服务</a> 指向了 PostgreSQL，那么 <a href=#default%E6%9C%8D%E5%8A%A1>default服务</a> 就会比较多余，可以考虑移除。</p><p>如果您不需要区分个人交互式查询，分析/ETL慢查询，可以考虑从默认服务列表 <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> 中移除 <a href=#offline%E6%9C%8D%E5%8A%A1>Offline服务</a>。</p><p>如果您不需要只读从库来分担在线只读流量，也可以从默认服务列表中移除 <a href=#replica%E6%9C%8D%E5%8A%A1>Replica服务</a>。</p><hr><h2 id=委托服务>委托服务</h2><p>Pigsty 通过节点上的 haproxy 暴露 PostgreSQL 服务。整个集群中的所有 haproxy 实例都使用相同的 <a href=#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1>服务定义</a> 进行配置。</p><p>但是，你可以将 pg 服务委托给特定的节点分组（例如，专门的 haproxy 负载均衡器集群），而不是 PostgreSQL 集群成员上的 haproxy。</p><p>为此，你需要使用 <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> 覆盖默认的服务定义，并将 <a href=/docs/pgsql/param#pg_service_provider><code>pg_service_provider</code></a> 设置为代理组名称。</p><p>例如，此配置将在端口 10013 的 <code>proxy</code> haproxy 节点组上公开 pg 集群的主服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>proxy      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用端口 10013 上的 `proxy` 组的负载均衡器</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 10013 ,dest: postgres  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>用户需要确保每个委托服务的端口，在代理集群中都是<strong>唯一</strong>的。</p><p>在 43 节点生产环境仿真 <a href=/docs/deploy/sandbox><strong>沙箱</strong></a> 中提供了一个使用专用负载均衡器集群的例子：<a href=https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L111>prod.yml</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ba271faa49ebb08213e3b4f058522cdb>20.4 - 认证 / HBA</h1><div class=lead>Pigsty 中基于主机的身份认证 HBA（Host-Based Authentication）详解。</div><blockquote><p>Pigsty 中基于主机的身份认证 HBA（Host-Based Authentication）详解。</p></blockquote><p>认证是 <a href=/docs/concept/sec/ac/>访问控制</a> 与 <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E6%9D%83%E9%99%90%E7%AD%96%E7%95%A5>权限系统</a> 的基石，PostgreSQL 拥有多种 <a href=https://www.postgresql.org/docs/current/client-authentication.html>认证</a> 方法。</p><p>这里主要介绍 HBA：Host Based Authentication，HBA规则定义了哪些用户能够通过哪些方式从哪些地方访问哪些数据库。</p><hr><h2 id=客户端认证>客户端认证</h2><p>要连接到PostgreSQL数据库，用户必须先经过认证（默认使用密码）。</p><p>您可以在连接字符串中提供密码（不安全）或使用<code>PGPASSWORD</code>环境变量或<code>.pgpass</code>文件传递密码。参考 <a href=https://www.postgresql.org/docs/current/app-psql.html#usage><code>psql</code></a> 文档和 <a href=https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING>PostgreSQL连接字符串</a> 以获取更多详细信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;host=&lt;host&gt; port=&lt;port&gt; dbname=&lt;dbname&gt; user=&lt;username&gt; password=&lt;password&gt;&#39;</span>
</span></span><span style=display:flex><span>psql postgres://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;dbname&gt;
</span></span><span style=display:flex><span><span style=color:#000>PGPASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;password&gt;<span style=color:#000;font-weight:700>;</span> psql -U &lt;username&gt; -h &lt;host&gt; -p &lt;port&gt; -d &lt;dbname&gt;
</span></span></code></pre></div><p>例如，连接 Pigsty 默认的 <code>meta</code> 数据库，可以使用以下连接串：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;host=10.10.10.10 port=5432 dbname=meta user=dbuser_dba password=DBUser.DBA&#39;</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta
</span></span><span style=display:flex><span><span style=color:#000>PGPASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>DBUser.DBA<span style=color:#000;font-weight:700>;</span> psql -U dbuser_dba -h 10.10.10.10 -p <span style=color:#0000cf;font-weight:700>5432</span> -d meta
</span></span></code></pre></div><p>默认配置下，Pigsty会启用服务端 SSL 加密，但不验证客户端 SSL 证书。要使用客户端SSL证书连接，你可以使用<code>PGSSLCERT</code>和<code>PGSSLKEY</code>环境变量或<code>sslkey</code>和<code>sslcert</code>参数提供客户端参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta?sslkey=/path/to/dbuser_dba.key&amp;sslcert=/path/to/dbuser_dba.crt&#39;</span>
</span></span></code></pre></div><p>客户端证书（<code>CN</code> = 用户名）可以使用本地CA与 <a href=https://github.com/Vonng/pigsty/blob/main/cert.yml><code>cert.yml</code></a> 剧本签发。</p><hr><h2 id=定义hba>定义HBA</h2><p>在Pigsty中，有四个与HBA规则有关的参数：</p><ul><li><a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a>：postgres HBA规则</li><li><a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a>：postgres 全局默认HBA规则</li><li><a href=/docs/pgsql/param#pgb_hba_rules><code>pgb_hba_rules</code></a>：pgbouncer HBA规则</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a>：pgbouncer 全局默认HBA规则</li></ul><p>这些都是 HBA 规则对象的数组，每个HBA规则都是以下两种形式之一的对象：</p><h3 id=1-原始形式>1. 原始形式</h3><p>原始形式的 HBA 与 PostgreSQL <code>pg_hba.conf</code> 的格式几乎完全相同：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  10.0.0.0/8      md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  172.16.0.0/12   md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  192.168.0.0/16  md5</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>在这种形式中，<code>rules</code> 字段是字符串数组，每一行都是条原始形式的 <a href=https://www.postgresql.org/docs/current/auth-pg-hba-conf.html>HBA规则</a>。<code>title</code> 字段会被渲染为一条注释，解释下面规则的作用。</p><p><code>role</code> 字段用于说明该规则适用于哪些实例角色，当实例的 <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> 与<code>role</code>相同时，HBA规则将被添加到这台实例的 HBA 中。</p><ul><li><code>role: common</code>的HBA规则将被添加到所有实例上。</li><li><code>role: primary</code> 的 HBA 规则只会添加到主库实例上。</li><li><code>role: replica</code> 的 HBA 规则只会添加到从库实例上。</li><li><code>role: offline</code>的HBA规则将被添加到离线实例上（ <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code>或 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code>）</li></ul><h3 id=2-别名形式>2. 别名形式</h3><p>别名形式允许您用更简单清晰便捷的方式维护 HBA 规则：它用<code>addr</code>、<code>auth</code>、<code>user</code>和<code>db</code> 字段替换了 <code>rules</code>。 <code>title</code>、<code>role</code> 和 <code>order</code> 字段则仍然生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;intra&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># world|intra|infra|admin|local|localhost|cluster|&lt;cidr&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pwd&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># trust|pwd|ssl|cert|deny|&lt;official auth method&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># all|${dbsu}|${repl}|${admin}|${monitor}|&lt;user&gt;|&lt;group&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># all|replication|....</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># raw hba string precedence over above all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 排序权重，数字小的排前面（可选，默认追加到最后）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>addr</code>: <strong>where</strong> 哪些IP地址段受本条规则影响？<ul><li><code>world</code>: 所有的IP地址</li><li><code>intra</code>: 所有的内网IP地址段： <code>'10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16'</code></li><li><code>infra</code>: Infra节点的IP地址</li><li><code>admin</code>: <code>admin_ip</code> 管理节点的IP地址</li><li><code>local</code>: 本地 Unix Socket</li><li><code>localhost</code>: 本地 Unix Socket 以及TCP 127.0.0.1/32 环回地址</li><li><code>cluster</code>: 同一个 PostgresQL 集群所有成员的IP地址</li><li><code>&lt;cidr></code>: 一个特定的 CIDR 地址块或IP地址</li></ul></li><li><code>auth</code>: <strong>how</strong> 本条规则指定的认证方式？<ul><li><code>deny</code>: 拒绝访问</li><li><code>trust</code>: 直接信任，不需要认证</li><li><code>pwd</code>: 密码认证，根据 <a href=/docs/pgsql/param#pg_pwd_enc><code>pg_pwd_enc</code></a> 参数选用 <code>md5</code> 或 <code>scram-sha-256</code> 认证</li><li><code>sha</code>/<code>scram-sha-256</code>：强制使用 <code>scram-sha-256</code> 密码认证方式。</li><li><code>md5</code>: <code>md5</code> 密码认证方式，但也可以兼容 <code>scram-sha-256</code> 认证，不建议使用。</li><li><code>ssl</code>: 在密码认证 <code>pwd</code> 的基础上，强制要求启用SSL</li><li><code>ssl-md5</code>: 在密码认证 <code>md5</code> 的基础上，强制要求启用SSL</li><li><code>ssl-sha</code>: 在密码认证 <code>sha</code> 的基础上，强制要求启用SSL</li><li><code>os</code>/<code>ident</code>: 使用操作系统用户的身份进行 <code>ident</code> 认证</li><li><code>peer</code>: 使用 <code>peer</code> 认证方式，类似于 <code>os ident</code></li><li><code>cert</code>: 使用基于客户端SSL证书的认证方式，证书CN为用户名</li></ul></li><li><code>user</code>: <strong>who</strong>：哪些用户受本条规则影响？<ul><li><code>all</code>: 所有用户</li><li><code>${dbsu}</code>: 默认数据库超级用户 <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a></li><li><code>${repl}</code>: 默认数据库复制用户 <a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a></li><li><code>${admin}</code>: 默认数据库管理用户 <a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a></li><li><code>${monitor}</code>: 默认数据库监控用户 <a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a></li><li>其他特定的用户或者角色</li></ul></li><li><code>db</code>: <strong>which</strong>：哪些数据库受本条规则影响？<ul><li><code>all</code>: 所有数据库</li><li><code>replication</code>: 允许建立复制连接（不指定特定数据库）</li><li>某个特定的数据库</li></ul></li></ul><h3 id=3-定义位置>3. 定义位置</h3><p>通常，全局的HBA定义在 <code>all.vars</code> 中，如果您想要修改全局默认的HBA规则，可以从 <a href=https://github.com/Vonng/pigsty/blob/main/conf/full.yml#L690><code>full.yml</code></a> 模板中复制一份到 <code>all.vars</code> 中进行修改。</p><ul><li><a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a>：postgres 全局默认HBA规则</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a>：pgbouncer 全局默认HBA规则</li></ul><p>而集群特定的 HBA 规则定义在数据库的集群级配置中：</p><ul><li><a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a>：postgres HBA规则</li><li><a href=/docs/pgsql/param#pgb_hba_rules><code>pgb_hba_rules</code></a>：pgbouncer HBA规则</li></ul><p>下面是一些集群HBA规则的定义例子：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_view ,db: all    ,addr: infra        ,auth: pwd  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;允许 dbuser_view 从基础设施节点密码访问所有库&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: all         ,db: all    ,addr: 100.0.0.0/8  ,auth: pwd  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;允许所有用户从K8S网段密码访问所有库&#39;</span><span style=color:#f8f8f8>          </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>,db: world  ,addr: 0.0.0.0/0    ,auth: cert ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;允许管理员用户从任何地方用客户端证书登陆&#39;</span><span style=color:#f8f8f8>       </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=重载hba>重载HBA</h2><p>HBA 是一个静态的规则配置文件，修改后需要重载才能生效。默认的 HBA 规则集合因为不涉及 Role 与集群成员，所以通常不需要重载。</p><p>如果您设计的 HBA 使用了特定的实例角色限制，或者集群成员限制，那么当集群实例成员发生变化（新增/下线/主从切换），一部分HBA规则的生效条件/涉及范围发生变化，通常也需要 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0hba>重载HBA</a> 以反映最新变化。</p><p>要重新加载 postgres/pgbouncer 的 hba 规则：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;                 <span style=color:#8f5902;font-style:italic># 重新加载集群 `&lt;cls&gt;` 的 hba 规则</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; ip1 ip2...      <span style=color:#8f5902;font-style:italic># 重新加载特定实例的 hba 规则</span>
</span></span></code></pre></div><p>底层实际执行的 Ansible 剧本命令为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -t pg_hba,pg_reload
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -t pgbouncer_hba,pgbouncer_reload
</span></span></code></pre></div><hr><h2 id=默认hba>默认HBA</h2><p>Pigsty 有一套默认的 HBA 规则，对于绝大多数场景来说，它已经足够安全了。这些规则使用别名形式，因此基本可以自我解释。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres 全局默认的HBA规则，按 order 排序</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title: &#39;admin @ everywhere with ssl &amp; pwd&#39;    ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer 全局默认的HBA规则，按 order 排序</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p><strong>注意</strong>：<code>order</code> 字段控制规则渲染顺序。<code>0-99</code> 用于高优先规则（如黑名单），<code>100-650</code> 为默认规则区间，<code>1000+</code> 用于追加规则。详见 <a href=/docs/pgsql/config/hba/>HBA 配置</a>。</p></blockquote><details><summary>示例：渲染 pg_hba.conf</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># File      :   pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Desc      :   Postgres HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Time      :   2023-01-11 15:19</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Path      :   /pg/data/pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># License   :   Apache-2.0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># addr alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local     : /var/run/postgresql</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># infra     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># user alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu    :  postgres</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># repl    :  replicator</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor :  dbuser_monitor</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin   :  dbuser_dba</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu access via local os user ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                postgres                              ident</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu replication from local os ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    replication        postgres                              ident</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator replication from localhost [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    replication        replicator                            scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator replication from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator postgres db from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor from localhost with password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                dbuser_monitor                        scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor from infra host with password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     10.10.10.10/32     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin @ infra nodes with pwd &amp; ssl [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  all                dbuser_dba         10.10.10.10/32     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin @ everywhere with ssl &amp; pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  all                dbuser_dba         0.0.0.0/0          scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgbouncer read/write via local socket [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                +dbrole_readonly                      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># read/write biz user via password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow etl offline tasks from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow application database intranet access [common] [DISABLED]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    kong            dbuser_kong         10.0.0.0/8          md5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    bytebase        dbuser_bytebase     10.0.0.0/8          md5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    grafana         dbuser_grafana      10.0.0.0/8          md5</span>
</span></span></code></pre></div></details><details><summary>示例: 渲染 pgb_hba.conf</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># File      :   pgb_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Desc      :   Pgbouncer HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Time      :   2023-01-11 15:28</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Path      :   /etc/pgbouncer/pgb_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># License   :   Apache-2.0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGBOUNCER HBA RULES FOR pg-meta-1 @ 10.10.10.10:6432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ansible managed: 2023-01-11 14:30:58</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># addr alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local     : /var/run/postgresql</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># infra     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># user alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu    :  postgres</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># repl    :  replicator</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor :  dbuser_monitor</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin   :  dbuser_dba</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu local admin access with os ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    pgbouncer          postgres                              peer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow all user local access with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                all                                   scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor access via intranet with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># reject all other monitor access addr [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     0.0.0.0/0          reject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin access via intranet with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># reject all other admin access addr [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         0.0.0.0/0          reject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow all user intra access with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                192.168.0.0/16     scram-sha-256</span>
</span></span></code></pre></div></details><hr><h2 id=安全加固>安全加固</h2><p>对于那些需要更高安全性的场合，我们提供了一个安全加固的配置模板 <a href=https://github.com/Vonng/pigsty/blob/main/conf/safe.yml>security.yml</a>，使用了以下的默认 HBA 规则集：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres host-based auth rules by default, order by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: ssl   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: ssl   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: ssl   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: cert  ,title: &#39;admin @ everywhere with ssl &amp; cert&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer host-based authentication rules, order by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: ssl   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>更多信息，请参考 <a href=/docs/setup/security>安全加固</a> 一节。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0b7772f5fffba0123e7353706362f45e>20.5 - 访问控制</h1><div class=lead>Pigsty 提供的默认角色系统与权限模型</div><blockquote><p>Pigsty 提供了一套开箱即用的，基于 <a href=#%E8%A7%92%E8%89%B2%E7%B3%BB%E7%BB%9F>角色系统</a> 和 <a href=#%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F>权限系统</a> 的访问控制模型。</p></blockquote><p>权限控制很重要，但很多用户做不好。因此 Pigsty 提供了一套开箱即用的精简访问控制模型，为您的集群安全性提供一个兜底。</p><hr><h2 id=角色系统>角色系统</h2><p>Pigsty 默认的角色系统包含四个 <a href=#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2>默认角色</a> 和四个 <a href=#%E9%BB%98%E8%AE%A4%E7%94%A8%E6%88%B7>默认用户</a>：</p><table class=full-width><thead><tr><th>角色名称</th><th>属性</th><th>所属</th><th>描述</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td></td><td>角色：全局只读访问</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>dbrole_readonly</td><td>角色：全局读写访问</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>pg_monitor,dbrole_readwrite</td><td>角色：管理员/对象创建</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td></td><td>角色：受限的只读访问</td></tr><tr><td><code>postgres</code></td><td><code>SUPERUSER</code></td><td></td><td>系统超级用户</td></tr><tr><td><code>replicator</code></td><td><code>REPLICATION</code></td><td>pg_monitor,dbrole_readonly</td><td>系统复制用户</td></tr><tr><td><code>dbuser_dba</code></td><td><code>SUPERUSER</code></td><td>dbrole_admin</td><td>pgsql 管理用户</td></tr><tr><td><code>dbuser_monitor</code></td><td></td><td>pg_monitor</td><td>pgsql 监控用户</td></tr></tbody></table><p>这些 <a href=/docs/pgsql/config/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7>角色与用户</a> 的详细定义如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 全局默认的角色与系统用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=默认角色>默认角色</h2><p>Pigsty 中有四个默认角色：</p><ul><li>业务只读 (<code>dbrole_readonly</code>): 用于全局只读访问的角色。如果别的业务想要此库只读访问权限，可以使用此角色。</li><li>业务读写 (<code>dbrole_readwrite</code>): 用于全局读写访问的角色，主属业务使用的生产账号应当具有数据库读写权限</li><li>业务管理员 (<code>dbrole_admin</code>): 拥有DDL权限的角色，通常用于业务管理员，或者需要在应用中建表的场景（比如各种业务软件）</li><li>离线只读访问 (<code>dbrole_offline</code>): 受限的只读访问角色（只能访问 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>offline</a> 实例，通常是个人用户，ETL工具账号）</li></ul><p>默认角色在 <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> 中定义，除非您确实知道自己在干什么，建议不要更改默认角色的名称。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  , login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access  }                           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产环境的只读角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline ,   login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access (offline instance) }     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 受限的只读角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产环境的读写角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产环境的 DDL 更改角色</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=默认用户>默认用户</h2><p>Pigsty 也有四个默认用户（系统用户）：</p><ul><li>超级用户 (<code>postgres</code>)，集群的所有者和创建者，与操作系统 dbsu 名称相同。</li><li>复制用户 (<code>replicator</code>)，用于主-从复制的系统用户。</li><li>监控用户 (<code>dbuser_monitor</code>)，用于监控数据库和连接池指标的用户。</li><li>管理用户 (<code>dbuser_dba</code>)，执行日常操作和数据库更改的管理员用户。</li></ul><p>这4个默认用户的用户名/密码通过4对专用参数进行定义，并在很多地方引用：</p><ul><li><a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a>：操作系统 dbsu 名称，默认为 postgres，最好不要更改它</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>：dbsu 密码，默认为空字符串意味着不设置 dbsu 密码，最好不要设置。</li><li><a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a>：postgres 复制用户名，默认为 <code>replicator</code></li><li><a href=/docs/pgsql/param#pg_replication_password><code>pg_replication_password</code></a>：postgres 复制密码，默认为 <code>DBUser.Replicator</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a>：postgres 管理员用户名，默认为 <code>dbuser_dba</code></li><li><a href=/docs/pgsql/param#pg_admin_password><code>pg_admin_password</code></a>：postgres 管理员密码的明文，默认为 <code>DBUser.DBA</code></li><li><a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a>：postgres 监控用户名，默认为 <code>dbuser_monitor</code></li><li><a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a>：postgres 监控密码，默认为 <code>DBUser.Monitor</code></li></ul><blockquote><p><strong>在生产部署中记得更改这些密码，不要使用默认值！</strong></p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 数据库超级用户名，这个用户名建议不要修改。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 数据库超级用户密码，这个密码建议留空！禁止dbsu密码登陆。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统复制用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统复制密码，请务必修改此密码！</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统监控用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统监控密码，请务必修改此密码！</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统管理用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统管理密码，请务必修改此密码！</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果您修改默认用户的参数，在 <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> 中修改相应的角色 <a href=/docs/pgsql/config/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7>定义</a> 即可：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true                                          ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=权限系统>权限系统</h2><p>Pigsty 拥有一套开箱即用的权限模型，该模型与 <a href=#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2>默认角色</a> 一起配合工作。</p><ul><li>所有用户都可以访问所有模式。</li><li>只读用户（<code>dbrole_readonly</code>）可以从所有表中读取数据。（SELECT，EXECUTE）</li><li>读写用户（<code>dbrole_readwrite</code>）可以向所有表中写入数据并运行 DML。（INSERT，UPDATE，DELETE）。</li><li>管理员用户（<code>dbrole_admin</code>）可以创建对象并运行 DDL（CREATE，USAGE，TRUNCATE，REFERENCES，TRIGGER）。</li><li>离线用户（<code>dbrole_offline</code>）类似只读用户，但访问受到限制，只允许访问 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线实例</a>（<code>pg_role = 'offline'</code> 或 <code>pg_offline_query = true</code>）</li><li>由管理员用户创建的对象将具有正确的权限。</li><li>所有数据库上都配置了默认权限，包括模板数据库。</li><li>数据库连接权限由数据库 <a href=/docs/pgsql/config/db#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>定义</a> 管理。</li><li>默认撤销<code>PUBLIC</code>在数据库和<code>public</code>模式下的<code>CREATE</code>权限。</li></ul><hr><h2 id=对象权限>对象权限</h2><p>数据库中新建对象的默认权限由参数 <a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a> 所控制：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>由管理员<strong>新创建</strong>的对象，默认将会上述权限。使用 <code>\ddp+</code> 可以查看这些默认权限：</p><table class=full-width><thead><tr><th>类型</th><th>访问权限</th></tr></thead><tbody><tr><td>函数</td><td>=X</td></tr><tr><td></td><td>dbrole_readonly=X</td></tr><tr><td></td><td>dbrole_offline=X</td></tr><tr><td></td><td>dbrole_admin=X</td></tr><tr><td>模式</td><td>dbrole_readonly=U</td></tr><tr><td></td><td>dbrole_offline=U</td></tr><tr><td></td><td>dbrole_admin=UC</td></tr><tr><td>序列号</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=wU</td></tr><tr><td></td><td>dbrole_admin=rwU</td></tr><tr><td>表</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=awd</td></tr><tr><td></td><td>dbrole_admin=arwdDxt</td></tr></tbody></table><hr><h2 id=默认权限>默认权限</h2><p><a href=https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html><code>ALTER DEFAULT PRIVILEGES</code></a> 允许您设置将来创建的对象的权限。 它不会影响已经存在对象的权限，也不会影响非管理员用户创建的对象。</p><p>在 Pigsty 中，默认权限针对三个角色进行定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dbsu</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_admin_username</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对于其他业务管理员而言，它们应当在执行 DDL 前执行 SET ROLE dbrole_admin，从而使用对应的默认权限配置。
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这些内容将会被 PG集群初始化模板 <a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>pg-init-template.sql</code></a> 所使用，在集群初始化的过程中渲染并输出至 <code>/pg/tmp/pg-init-template.sql</code>。
该命令会在 <code>template1</code> 与 <code>postgres</code> 数据库中执行，新创建的数据库会通过模板 <code>template1</code> 继承这些默认权限配置。</p><p>也就是说，为了维持正确的对象权限，您必须用<strong>管理员用户</strong>来执行 DDL，它们可以是：</p><ol><li><a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>，默认为 <code>postgres</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>{{ pg_admin_username }}</code></a>，默认为 <code>dbuser_dba</code></li><li>授予了 <code>dbrole_admin</code> 角色的业务管理员用户（通过 <code>SET ROLE</code> 切换为 <code>dbrole_admin</code> 身份）。</li></ol><p>使用 <code>postgres</code> 作为全局对象所有者是明智的。如果您希望以业务管理员用户身份创建对象，创建之前必须使用 <code>SET ROLE dbrole_admin</code> 来维护正确的权限。</p><p>当然，您也可以在数据库中通过 <code>ALTER DEFAULT PRIVILEGE FOR ROLE &lt;some_biz_admin> XXX</code> 来显式对业务管理员授予默认权限。</p><hr><h2 id=数据库权限>数据库权限</h2><p>在 Pigsty 中，数据库（Database）层面的权限在 <a href=/docs/pgsql/config/db#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>数据库定义</a> 中被涵盖。</p><p>数据库有三个级别的权限：<code>CONNECT</code>、<code>CREATE</code>、<code>TEMP</code>，以及一个特殊的&rsquo;权限&rsquo;：<code>OWNERSHIP</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是数据库定义中唯一的必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库所有者，默认为 postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>如果 <code>owner</code> 参数存在，它作为数据库属主，替代默认的 <a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>（通常也就是<code>postgres</code>）</li><li>如果 <code>revokeconn</code> 为 <code>false</code>，所有用户都有数据库的 <code>CONNECT</code> 权限，这是默认的行为。</li><li>如果显式设置了 <code>revokeconn</code> 为 <code>true</code>：<ul><li>数据库的 <code>CONNECT</code> 权限将从 <code>PUBLIC</code> 中撤销：普通用户无法连接上此数据库</li><li><code>CONNECT</code> 权限将被显式授予 <code>{{ pg_replication_username }}</code>、<code>{{ pg_monitor_username }}</code> 和 <code>{{ pg_admin_username }}</code></li><li><code>CONNECT</code> 权限将 <code>GRANT OPTION</code> 被授予数据库属主，数据库属主用户可以自行授权其他用户连接权限。</li></ul></li><li><code>revokeconn</code> 选项可用于在同一个集群间隔离跨数据库访问，您可以为每个数据库创建不同的业务用户作为属主，并为它们设置 <code>revokeconn</code> 选项。</li></ul><details><summary>示例：数据库隔离</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.40</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.41</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_confluence, password: mc2iohos , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_gitlab, password: sdf23g22sfdd , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_readwrite ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_jira, password: sdpijfsfdsfdfs , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: confluence , revokeconn: true, owner: dbuser_confluence , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitlab , revokeconn: true, owner: dbuser_gitlab, connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: jira , revokeconn: true, owner: dbuser_jira , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=create权限>CREATE权限</h2><p>出于安全考虑，Pigsty 默认从 <code>PUBLIC</code> 撤销数据库上的 <code>CREATE</code> 权限，从 PostgreSQL 15 开始这也是默认行为。</p><p>数据库属主总是可以根据实际需要，来自行调整 CREATE 权限。</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>