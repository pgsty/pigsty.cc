<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/pgsql/template/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/pgsql/template/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>场景模板 | PIGSTY</title><meta name=description content="使用 Pigsty 预置的四种场景化 Patroni 模版，或者基于这些模板自定义您的配置模板"><meta property="og:url" content="https://pigsty.cc/docs/pgsql/template/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="场景模板"><meta property="og:description" content="使用 Pigsty 预置的四种场景化 Patroni 模版，或者基于这些模板自定义您的配置模板"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="场景模板"><meta itemprop=description content="使用 Pigsty 预置的四种场景化 Patroni 模版，或者基于这些模板自定义您的配置模板"><meta itemprop=dateModified content="2026-02-08T16:14:56+08:00"><meta itemprop=wordCount content="395"><meta itemprop=keywords content="参考,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="场景模板"><meta name=twitter:description content="使用 Pigsty 预置的四种场景化 Patroni 模版，或者基于这些模板自定义您的配置模板"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/pgsql/template/>返回本页常规视图</a>.</p></div><h1 class=title>场景模板</h1><div class=lead>使用 Pigsty 预置的四种场景化 Patroni 模版，或者基于这些模板自定义您的配置模板</div><ul><li>1: <a href=#pg-c343b4e12cd241ebdb244700f6f7ae20>默认配置模板的参数优化策略说明</a></li><li>2: <a href=#pg-04bbfb111fd00b28b14a77c5a5a92955>OLTP 模板</a></li><li>3: <a href=#pg-571aa5133064fa24ac707a69e4d84659>OLAP 模板</a></li><li>4: <a href=#pg-7cf828587f72da3b425e1bd025ccbacf>CRIT 模板</a></li><li>5: <a href=#pg-609856237df74f1f0f6e5fba1111e545>TINY 模板</a></li></ul><div class=content><p>Pigsty 提供四种预置的 Patroni/PostgreSQL 配置模板，针对不同的使用场景进行了参数优化：</p><table class=full-width><thead><tr><th style=text-align:left>模板</th><th style=text-align:left>CPU核心</th><th style=text-align:left>适用场景</th><th style=text-align:left>特点</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/template/oltp><strong><code>/docs/pgsql/template/oltp.yml</code></strong></a></td><td style=text-align:left>4-128C</td><td style=text-align:left>OLTP 事务处理</td><td style=text-align:left>高并发、低延迟、高吞吐</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/template/olap><strong><code>/docs/pgsql/template/olap.yml</code></strong></a></td><td style=text-align:left>4-128C</td><td style=text-align:left>OLAP 分析处理</td><td style=text-align:left>大查询、高并行、长事务</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/template/crit><strong><code>/docs/pgsql/template/crit.yml</code></strong></a></td><td style=text-align:left>4-128C</td><td style=text-align:left>核心/金融业务</td><td style=text-align:left>数据安全、审计合规、零丢失</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/template/tiny><strong><code>/docs/pgsql/template/tiny.yml</code></strong></a></td><td style=text-align:left>1-3C</td><td style=text-align:left>微型实例</td><td style=text-align:left>资源受限、低配环境</td></tr></tbody></table><p>您可以通过 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数来选择使用哪个配置模板，默认为 <a href=/docs/pgsql/template/oltp><strong><code>/docs/pgsql/template/oltp.yml</code></strong></a>。</p><blockquote><p>通常，数据库调优模板 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 应当与机器调优模板 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> 配套使用。</p></blockquote><hr><h2 id=使用模板>使用模板</h2><p>要使用特定的配置模板，只需在集群定义中设置 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数。
建议同时设置 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> 参数，使操作系统级别的调优与数据库调优保持一致：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 配置模板（默认值）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统调优模板（默认值）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>对于核心金融业务场景，您可以使用 <a href=/docs/pgsql/template/crit><strong><code>/docs/pgsql/template/crit.yml</code></strong></a> 模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-finance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.21</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.22</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.23</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-finance</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 关键业务模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统关键业务调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>对于低配虚拟机或开发环境，可以使用 <a href=/docs/pgsql/template/tiny><strong><code>/docs/pgsql/template/tiny.yml</code></strong></a> 模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-dev</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.31</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=模板对比>模板对比</h2><p>四种模板在关键参数上有显著差异，以适应不同的业务场景。以下是主要差异对比：</p><h3 id=连接与内存>连接与内存</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>max_connections</strong></td><td style=text-align:left>500/1000</td><td style=text-align:left>500</td><td style=text-align:left>500/1000</td><td style=text-align:left>250</td></tr><tr><td style=text-align:left><strong>work_mem</strong> 范围</td><td style=text-align:left>64MB-1GB</td><td style=text-align:left>64MB-8GB</td><td style=text-align:left>64MB-1GB</td><td style=text-align:left>16MB-256MB</td></tr><tr><td style=text-align:left><strong>maintenance_work_mem</strong></td><td style=text-align:left>25% 共享缓冲区</td><td style=text-align:left>50% 共享缓冲区</td><td style=text-align:left>25% 共享缓冲区</td><td style=text-align:left>25% 共享缓冲区</td></tr><tr><td style=text-align:left><strong>max_locks_per_transaction</strong></td><td style=text-align:left>1-2x maxconn</td><td style=text-align:left>2-4x maxconn</td><td style=text-align:left>1-2x maxconn</td><td style=text-align:left>1-2x maxconn</td></tr></tbody></table><h3 id=并行查询>并行查询</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>max_worker_processes</strong></td><td style=text-align:left>cpu+8</td><td style=text-align:left>cpu+12</td><td style=text-align:left>cpu+8</td><td style=text-align:left>cpu+4</td></tr><tr><td style=text-align:left><strong>max_parallel_workers</strong></td><td style=text-align:left>50% cpu</td><td style=text-align:left>80% cpu</td><td style=text-align:left>50% cpu</td><td style=text-align:left>50% cpu</td></tr><tr><td style=text-align:left><strong>max_parallel_workers_per_gather</strong></td><td style=text-align:left>20% cpu (max 8)</td><td style=text-align:left>50% cpu</td><td style=text-align:left>0（禁用）</td><td style=text-align:left>0（禁用）</td></tr><tr><td style=text-align:left><strong>parallel_setup_cost</strong></td><td style=text-align:left>2000</td><td style=text-align:left>1000</td><td style=text-align:left>2000</td><td style=text-align:left>1000</td></tr><tr><td style=text-align:left><strong>parallel_tuple_cost</strong></td><td style=text-align:left>0.2</td><td style=text-align:left>0.1</td><td style=text-align:left>0.2</td><td style=text-align:left>0.1</td></tr></tbody></table><h3 id=同步复制>同步复制</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>synchronous_mode</strong></td><td style=text-align:left>取决于 pg_rpo</td><td style=text-align:left>取决于 pg_rpo</td><td style=text-align:left>强制开启</td><td style=text-align:left>取决于 pg_rpo</td></tr><tr><td style=text-align:left><strong>data_checksums</strong></td><td style=text-align:left>可选</td><td style=text-align:left>可选</td><td style=text-align:left>强制开启</td><td style=text-align:left>可选</td></tr></tbody></table><h3 id=vacuum-配置>Vacuum 配置</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>vacuum_cost_delay</strong></td><td style=text-align:left>20ms</td><td style=text-align:left>10ms</td><td style=text-align:left>20ms</td><td style=text-align:left>20ms</td></tr><tr><td style=text-align:left><strong>vacuum_cost_limit</strong></td><td style=text-align:left>2000</td><td style=text-align:left>10000</td><td style=text-align:left>2000</td><td style=text-align:left>2000</td></tr><tr><td style=text-align:left><strong>autovacuum_max_workers</strong></td><td style=text-align:left>3</td><td style=text-align:left>3</td><td style=text-align:left>3</td><td style=text-align:left>2</td></tr></tbody></table><h3 id=超时与安全>超时与安全</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>idle_in_transaction_session_timeout</strong></td><td style=text-align:left>10min</td><td style=text-align:left>禁用</td><td style=text-align:left>1min</td><td style=text-align:left>10min</td></tr><tr><td style=text-align:left><strong>log_min_duration_statement</strong></td><td style=text-align:left>100ms</td><td style=text-align:left>1000ms</td><td style=text-align:left>100ms</td><td style=text-align:left>100ms</td></tr><tr><td style=text-align:left><strong>default_statistics_target</strong></td><td style=text-align:left>400</td><td style=text-align:left>1000</td><td style=text-align:left>400</td><td style=text-align:left>200</td></tr><tr><td style=text-align:left><strong>track_activity_query_size</strong></td><td style=text-align:left>8KB</td><td style=text-align:left>8KB</td><td style=text-align:left>32KB</td><td style=text-align:left>8KB</td></tr><tr><td style=text-align:left><strong>log_connections</strong></td><td style=text-align:left>仅授权</td><td style=text-align:left>仅授权</td><td style=text-align:left>全部阶段</td><td style=text-align:left>默认</td></tr></tbody></table><h3 id=io-配置pg17>IO 配置（PG17+）</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>OLTP</th><th style=text-align:left>OLAP</th><th style=text-align:left>CRIT</th><th style=text-align:left>TINY</th></tr></thead><tbody><tr><td style=text-align:left><strong>io_workers</strong></td><td style=text-align:left>25% cpu (4-16)</td><td style=text-align:left>50% cpu (4-32)</td><td style=text-align:left>25% cpu (4-8)</td><td style=text-align:left>3</td></tr><tr><td style=text-align:left><strong>temp_file_limit</strong></td><td style=text-align:left>1/20 磁盘</td><td style=text-align:left>1/5 磁盘</td><td style=text-align:left>1/20 磁盘</td><td style=text-align:left>1/20 磁盘</td></tr></tbody></table><hr><h2 id=选择建议>选择建议</h2><ul><li><p><a href=/docs/pgsql/template/oltp><strong>OLTP 模板</strong></a>：适用于大多数在线事务处理场景，是默认选择。适合电商、社交、游戏等高并发低延迟应用。</p></li><li><p><a href=/docs/pgsql/template/olap><strong>OLAP 模板</strong></a>：适用于数据仓库、BI 报表、ETL 等分析型负载。特点是允许大查询、高并行度、宽松的超时设置。</p></li><li><p><a href=/docs/pgsql/template/crit><strong>CRIT 模板</strong></a>：适用于金融交易、核心账务等对数据一致性和安全性有极高要求的场景。强制同步复制、数据校验和、完整审计日志。</p></li><li><p><a href=/docs/pgsql/template/tiny><strong>TINY 模板</strong></a>：适用于开发测试环境、资源受限的虚拟机、树莓派等场景。最小化资源占用，禁用并行查询。</p></li></ul><hr><h2 id=自定义模板>自定义模板</h2><p>您可以基于现有模板创建自定义配置模板。模板文件位于 Pigsty 安装目录的 <code>roles/pgsql/templates/</code> 下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>roles/pgsql/templates/
</span></span><span style=display:flex><span>├── oltp.yml    <span style=color:#8f5902;font-style:italic># OLTP 事务处理模板（默认）</span>
</span></span><span style=display:flex><span>├── olap.yml    <span style=color:#8f5902;font-style:italic># OLAP 分析处理模板</span>
</span></span><span style=display:flex><span>├── crit.yml    <span style=color:#8f5902;font-style:italic># CRIT 关键业务模板</span>
</span></span><span style=display:flex><span>└── tiny.yml    <span style=color:#8f5902;font-style:italic># TINY 微型实例模板</span>
</span></span></code></pre></div><p>创建自定义模板的步骤：</p><ol><li>复制一个现有模板作为基础</li><li>根据需要修改参数</li><li>将模板放置在 <code>roles/pgsql/templates/</code> 目录</li><li>在集群定义中通过 <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a> 引用新模板</li></ol><p>例如，创建一个名为 <code>myapp.yml</code> 的自定义模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cp roles/pgsql/templates/oltp.yml roles/pgsql/templates/myapp.yml
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 编辑 myapp.yml 进行自定义</span>
</span></span></code></pre></div><p>然后在集群中使用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-myapp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp.yml</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>请注意，模板文件使用 Jinja2 模板语法，参数值会根据节点的实际资源（CPU、内存、磁盘）动态计算。</p><hr><h2 id=参数优化策略>参数优化策略</h2><p>了解更多关于模板参数优化的技术细节，请参阅 <a href=/docs/pgsql/template/tune><strong>参数优化策略</strong></a>，其中详细介绍了：</p><ul><li>内存参数调整（共享缓冲区、工作内存、最大连接数）</li><li>CPU 参数调整（并行查询工作进程配置）</li><li>存储空间参数（WAL 大小、临时文件限制）</li><li>手工调整参数的方法</li></ul><hr><h2 id=相关参数>相关参数</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：指定使用的 PostgreSQL 配置模板</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：指定使用的操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/param#pg_rto><strong><code>pg_rto</code></strong></a>：恢复时间目标，影响故障切换超时</li><li><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a>：恢复点目标，影响同步复制模式</li><li><a href=/docs/pgsql/param#pg_max_conn><strong><code>pg_max_conn</code></strong></a>：覆盖模板的最大连接数</li><li><a href=/docs/pgsql/param#pg_shared_buffer_ratio><strong><code>pg_shared_buffer_ratio</code></strong></a>：共享缓冲区占内存比例</li><li><a href=/docs/pgsql/param#pg_storage_type><strong><code>pg_storage_type</code></strong></a>：存储类型，影响 IO 相关参数</li></ul></div></div><div class=td-content style=page-break-before:always><h1 id=pg-c343b4e12cd241ebdb244700f6f7ae20>1 - 默认配置模板的参数优化策略说明</h1><div class=lead>了解在 Pigsty 中，预置的四种 Patroni 场景化模板所采用的不同参数优化策略</div><p>Pigsty 默认提供了四套场景化参数模板，可以通过 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数指定并使用。</p><ul><li><a href=/docs/pgsql/template/tiny><strong><code>tiny.yml</code></strong></a>：为小节点、虚拟机、小型演示优化（1-8核，1-16GB）</li><li><a href=/docs/pgsql/template/oltp><strong><code>oltp.yml</code></strong></a>：为OLTP工作负载和延迟敏感应用优化（4C8GB+）（默认模板）</li><li><a href=/docs/pgsql/template/olap><strong><code>olap.yml</code></strong></a>：为OLAP工作负载和吞吐量优化（4C8G+）</li><li><a href=/docs/pgsql/template/crit><strong><code>crit.yml</code></strong></a>：为数据一致性和关键应用优化（4C8G+）</li></ul><p>Pigsty 会针对这四种默认场景，采取不同的参数优化策略，如下所示：</p><hr><h2 id=内存参数调整>内存参数调整</h2><p>Pigsty 默认会检测系统的内存大小，并以此为依据设定最大连接数量与内存相关参数。</p><ul><li><a href=/docs/pgsql/param#pg_max_conn><strong><code>pg_max_conn</code></strong></a>：postgres 最大连接数，<code>auto</code> 将使用不同场景下的推荐值</li><li><a href=/docs/pgsql/param#pg_shared_buffer_ratio><strong><code>pg_shared_buffer_ratio</code></strong></a>：内存共享缓冲区比例，默认为 0.25</li></ul><p>默认情况下，Pigsty 使用 25% 的内存作为 PostgreSQL 共享缓冲区，剩余的 75% 作为操作系统缓存。</p><p>默认情况下，如果用户没有设置一个 <a href=/docs/pgsql/param#pg_max_conn><code>pg_max_conn</code></a> 最大连接数，Pigsty 会根据以下规则使用默认值：</p><ul><li>oltp: 500 (pgbouncer) / 1000 (postgres)</li><li>crit: 500 (pgbouncer) / 1000 (postgres)</li><li>tiny: 300</li><li>olap: 300</li></ul><p>其中对于 OLTP 与 CRIT 模版来说，如果服务没有指向 pgbouncer 连接池，而是直接连接 postgres 数据库，最大连接会翻倍至 1000 条。</p><p>决定最大连接数后，<code>work_mem</code> 会根据共享内存数量 / 最大连接数计算得到，并限定在 64MB ~ 1GB 的范围内。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#000>% raw %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% if pg_max_conn != &#39;auto&#39; and pg_max_conn|int &gt;= 20 %}{% set pg_max_connections = pg_max_conn|int %}{% else %}{% if pg_default_service_dest|default(&#39;postgres&#39;) == &#39;pgbouncer&#39; %}{% set pg_max_connections = 500 %}{% else %}{% set pg_max_connections = 1000 %}{% endif %}{% endif %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_max_prepared_transactions = pg_max_connections if &#39;citus&#39; in pg_libs else 0 %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_max_locks_per_transaction = (2 * pg_max_connections)|int if &#39;citus&#39; in pg_libs or &#39;timescaledb&#39; in pg_libs else pg_max_connections %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_shared_buffers = (node_mem_mb|int * pg_shared_buffer_ratio|float) | round(0, &#39;ceil&#39;) | int %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_maintenance_mem = (pg_shared_buffers|int * 0.25)|round(0, &#39;ceil&#39;)|int %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_effective_cache_size = node_mem_mb|int - pg_shared_buffers|int  %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% set pg_workmem =  ([ ([ (pg_shared_buffers / pg_max_connections)|round(0,&#39;floor&#39;)|int , 64 ])|max|int , 1024])|min|int %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% endraw %}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=cpu参数调整>CPU参数调整</h2><p>在 PostgreSQL 中，有 4 个与并行查询相关的重要参数，Pigsty 会自动根据当前系统的 CPU 核数进行参数优化。
在所有策略中，总并行进程数量（总预算）通常设置为 CPU 核数 + 8，且保底为 16 个，从而为逻辑复制与扩展预留足够的后台 worker 数量，OLAP 和 TINY 模板根据场景略有不同。</p><table class=full-width><thead><tr><th>OLTP</th><th>设置逻辑</th><th>范围限制</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td><code>max(100% CPU + 8, 16)</code></td><td>核数 + 4，保底 1，</td></tr><tr><td><code>max_parallel_workers</code></td><td><code>max(ceil(50% CPU), 2)</code></td><td>1/2 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td><code>max(ceil(33% CPU), 2)</code></td><td>1/3 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td><code>min(max(ceil(20% CPU), 2),8)</code></td><td>1/5 CPU 下取整，最少两个，最多 8 个</td></tr></tbody></table><table class=full-width><thead><tr><th>OLAP</th><th>设置逻辑</th><th>范围限制</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td><code>max(100% CPU + 12, 20)</code></td><td>核数 + 12，保底 20</td></tr><tr><td><code>max_parallel_workers</code></td><td><code>max(ceil(80% CPU, 2))</code></td><td>4/5 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td><code>max(ceil(33% CPU), 2)</code></td><td>1/3 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td><code>max(floor(50% CPU), 2)</code></td><td>1/2 CPU 上取整，最少两个</td></tr></tbody></table><table class=full-width><thead><tr><th>CRIT</th><th>设置逻辑</th><th>范围限制</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td><code>max(100% CPU + 8, 16)</code></td><td>核数 + 8，保底 16</td></tr><tr><td><code>max_parallel_workers</code></td><td><code>max(ceil(50% CPU), 2)</code></td><td>1/2 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td><code>max(ceil(33% CPU), 2)</code></td><td>1/3 CPU 上取整，最少两个</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td><code>0</code>, 按需启用</td><td></td></tr></tbody></table><table class=full-width><thead><tr><th>TINY</th><th>设置逻辑</th><th>范围限制</th></tr></thead><tbody><tr><td><code>max_worker_processes</code></td><td><code>max(100% CPU + 4, 12)</code></td><td>核数 + 4，保底 12</td></tr><tr><td><code>max_parallel_workers</code></td><td><code>max(ceil(50% CPU) 1)</code></td><td>50% CPU 下取整，最少1个</td></tr><tr><td><code>max_parallel_maintenance_workers</code></td><td><code>max(ceil(33% CPU), 1)</code></td><td>33% CPU 下取整，最少1个</td></tr><tr><td><code>max_parallel_workers_per_gather</code></td><td>`0, 按需启用</td><td></td></tr></tbody></table><p>请注意，CRIT 和 TINY 模板直接通过设置 <code>max_parallel_workers_per_gather = 0 </code>关闭了并行查询。
用户可以按需在需要时设置此参数以启用并行查询。</p><p>OLTP 和 CRIT 模板都额外设置了以下参数，将并行查询的 Cost x 2，以降低使用并行查询的倾向。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_setup_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># double from 100 to increase parallel cost</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_tuple_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># double from 0.1 to increase parallel cost</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_table_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 4x default 8MB, prefer non-parallel scan</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_index_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>2MB  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 4x default 512kB, prefer non-parallel scan</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>请注意 <code>max_worker_processes</code> 参数的调整必须在重启后才能生效。此外，当从库的本参数配置值高于主库时，从库将无法启动。
此参数必须通过 patroni 配置管理进行调整，该参数由 Patroni 管理，用于确保主从配置一致，避免在故障切换时新从库无法启动。</p><hr><h2 id=存储空间参数>存储空间参数</h2><p>Pigsty 默认检测 <code>/data/postgres</code> 主数据目录所在磁盘的总空间，并以此作为依据指定下列参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>{<span style=color:#000>% raw %}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth, 200])|min }}GB                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 1/20 disk size, max 200GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth * 4, 2000])|min }}GB            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 2/10 disk size, max 2000GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_slot_wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth * 6, 3000])|min }}GB  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 3/10 disk size, max 3000GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>temp_file_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{{<span style=color:#f8f8f8> </span><span style=color:#000>([pg_size_twentieth, 200])|min }}GB              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 1/20 of disk size, max 200GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>{<span style=color:#000>% endraw %}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>temp_file_limit</code> 默认为磁盘空间的 5%，封顶不超过 200GB。</li><li><code>min_wal_size</code> 默认为磁盘空间的 5%，封顶不超过 200GB。</li><li><code>max_wal_size</code> 默认为磁盘空间的 20%，封顶不超过 2TB。</li><li><code>max_slot_wal_keep_size</code> 默认为磁盘空间的 30%，封顶不超过 3TB。</li></ul><p>作为特例， OLAP 模板允许 20% 的 <code>temp_file_limit</code> ，封顶不超过 2TB</p><hr><h2 id=手工调整参数>手工调整参数</h2><p>除了使用 Pigsty 自动配置的参数外，您还可以手工调整 PostgreSQL 参数。</p><p>使用 <code>pg edit-config &lt;cluster></code> 命令可以交互式编辑集群配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta
</span></span></code></pre></div><p>或者使用 <code>-p</code> 参数直接设置参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span> pg-meta
</span></span><span style=display:flex><span>pg edit-config --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_cron, pg_stat_statements, auto_explain&#39;</span> pg-meta
</span></span></code></pre></div><p>您也可以使用 Patroni REST API 来修改配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -u <span style=color:#4e9a06>&#39;postgres:Patroni.API&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    -d <span style=color:#4e9a06>&#39;{&#34;postgresql&#34;:{&#34;parameters&#34;: {&#34;log_min_duration_statement&#34;:200}}}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>    -s -X PATCH http://10.10.10.10:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-04bbfb111fd00b28b14a77c5a5a92955>2 - OLTP 模板</h1><div class=lead>针对在线事务处理负载优化的 PostgreSQL 配置模板</div><p><code>oltp.yml</code> 是 Pigsty 的默认配置模板，针对<strong>在线事务处理</strong>（OLTP）负载进行了优化。适用于 4-128 核 CPU 的服务器，特点是高并发连接、低延迟响应、高事务吞吐量。</p><blockquote><p>建议同时使用 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>oltp</code> 进行操作系统级别的配套调优。</p></blockquote><hr><h2 id=适用场景>适用场景</h2><p>OLTP 模板适用于以下场景：</p><ul><li><strong>电商系统</strong>：订单处理、库存管理、用户交易</li><li><strong>社交应用</strong>：用户动态、消息推送、关注关系</li><li><strong>游戏后端</strong>：玩家数据、排行榜、游戏状态</li><li><strong>SaaS 应用</strong>：多租户业务系统</li><li><strong>Web 应用</strong>：常规的 CRUD 操作密集型应用</li></ul><p><strong>特征负载</strong>：</p><ul><li>大量短事务（毫秒级）</li><li>高并发连接（数百到数千）</li><li>读写比例通常在 7:3 到 9:1</li><li>对延迟敏感，要求快速响应</li><li>数据一致性要求高</li></ul><hr><h2 id=使用方法>使用方法</h2><p><a href=/docs/pgsql/template/oltp/><strong><code>oltp.yml</code></strong></a> 是默认模板，无需显式指定：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-oltp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># pg_conf: oltp.yml  # PostgreSQL 配置模板（默认值）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># node_tune: oltp    # 操作系统调优模板（默认值）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>或显式指定：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 配置模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统调优模板</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=参数详解>参数详解</h2><h3 id=连接管理>连接管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#000>/1000  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 取决于是否使用 pgbouncer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>当 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 为 <code>pgbouncer</code> 时，<code>max_connections</code> 设为 500</li><li>当流量直连 PostgreSQL 时，<code>max_connections</code> 设为 1000</li><li>可通过 <a href=/docs/pgsql/param#pg_max_conn><code>pg_max_conn</code></a> 参数覆盖</li></ul><h3 id=内存配置>内存配置</h3><p>OLTP 模板的内存分配策略：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>计算公式</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>内存 × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>默认比例 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × 25%</td><td style=text-align:left>用于 VACUUM、CREATE INDEX</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>64MB - 1GB</td><td style=text-align:left>根据 shared_buffers/max_connections 计算</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>总内存 - shared_buffers</td><td style=text-align:left>可用于缓存的预估内存</td></tr></tbody></table><p><strong>work_mem 计算逻辑</strong>：</p><pre tabindex=0><code>work_mem = min(max(shared_buffers / max_connections, 64MB), 1GB)
</code></pre><p>这确保每个连接有足够的排序/哈希内存，但不会过度分配。</p><h3 id=并行查询>并行查询</h3><p>OLTP 模板对并行查询做了适度限制，以避免并行查询抢占过多资源影响其他事务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cpu + 8 (最小16)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000>% × cpu (最小2)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000>% × cpu (2-8)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_maintenance_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000>% × cpu (最小2)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>同时提高了并行查询的成本估算，让优化器倾向于串行执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_setup_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 默认值 1000 的两倍</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_tuple_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 默认值 0.1 的两倍</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_table_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认值 8MB 的四倍，倾向于不使用并行扫描</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_index_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>2MB   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认值 512kB 的四倍，倾向于不使用并行扫描</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=wal-配置>WAL 配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/20 (最大200GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/5 (最大2000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_slot_wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘×3/10 (最大3000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_flush_after</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>commit_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>commit_siblings</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>checkpoint_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>15min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>checkpoint_completion_target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.80</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这些设置平衡了数据安全性和写入性能。</p><h3 id=vacuum-配置>Vacuum 配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 每轮 vacuum 后休眠</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 每轮 vacuum 的代价上限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_max_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_naptime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_vacuum_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.08</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 8% 表变化触发 vacuum</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_analyze_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.04</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 4% 表变化触发 analyze</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_freeze_max_age</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000000000</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>OLTP 模板使用保守的 vacuum 设置，避免 vacuum 操作影响在线事务性能。</p><h3 id=查询优化>查询优化</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>random_page_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.1</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># SSD 优化</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>effective_io_concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># SSD 并发 IO</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>default_statistics_target</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 统计信息精度</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这些设置让优化器能够生成更好的查询计划。</p><h3 id=日志与监控>日志与监控</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 记录超过 100ms 的慢查询</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 记录 DDL 语句</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_checkpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_lock_waits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_temp_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 记录超过 1MB 的临时文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_autovacuum_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=客户端超时>客户端超时</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deadlock_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>10 分钟的空闲事务超时可以防止长时间持有锁的僵尸事务。</p><h3 id=扩展配置>扩展配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># auto_explain</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_analyze</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_verbose</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>auto_explain.log_nested_statements</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg_stat_statements</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.max</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_utility</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_planning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=与其他模板的对比>与其他模板的对比</h2><table class=full-width><thead><tr><th style=text-align:left>特性</th><th style=text-align:left><a href=/docs/pgsql/template/oltp/><strong>OLTP</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/olap/><strong>OLAP</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/crit/><strong>CRIT</strong></a></th></tr></thead><tbody><tr><td style=text-align:left>max_connections</td><td style=text-align:left>500-1000</td><td style=text-align:left>500</td><td style=text-align:left>500-1000</td></tr><tr><td style=text-align:left>work_mem</td><td style=text-align:left>64MB-1GB</td><td style=text-align:left>64MB-8GB</td><td style=text-align:left>64MB-1GB</td></tr><tr><td style=text-align:left>并行查询</td><td style=text-align:left>适度限制</td><td style=text-align:left>激进启用</td><td style=text-align:left>禁用</td></tr><tr><td style=text-align:left>vacuum 激进度</td><td style=text-align:left>保守</td><td style=text-align:left>激进</td><td style=text-align:left>保守</td></tr><tr><td style=text-align:left>事务超时</td><td style=text-align:left>10min</td><td style=text-align:left>禁用</td><td style=text-align:left>1min</td></tr><tr><td style=text-align:left>慢查询阈值</td><td style=text-align:left>100ms</td><td style=text-align:left>1000ms</td><td style=text-align:left>100ms</td></tr></tbody></table><h3 id=为什么选择-oltp-而非-olap>为什么选择 OLTP 而非 OLAP？</h3><ul><li>您的查询大多数是简单的点查和范围查询</li><li>事务响应时间要求在毫秒级</li><li>有大量并发连接</li><li>不需要执行复杂的分析查询</li></ul><h3 id=为什么选择-oltp-而非-crit>为什么选择 OLTP 而非 CRIT？</h3><ul><li>可以接受极小概率的数据丢失（异步复制）</li><li>不需要完整的审计日志</li><li>希望获得更好的写入性能</li></ul><hr><h2 id=性能调优建议>性能调优建议</h2><h3 id=连接池>连接池</h3><p>对于高并发场景，强烈建议使用 PgBouncer 连接池：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbouncer </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_poolmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 事务级池化</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=只读分离>只读分离</h3><p>使用只读从库分担读取负载：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-oltp</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=监控指标>监控指标</h3><p>关注以下监控指标：</p><ul><li><strong>连接数</strong>：活跃连接数、等待连接数</li><li><strong>事务率</strong>：TPS、提交/回滚比例</li><li><strong>响应时间</strong>：查询延迟百分位（p50/p95/p99）</li><li><strong>锁等待</strong>：锁等待时间、死锁次数</li><li><strong>复制延迟</strong>：从库延迟时间和字节数</li></ul><hr><h2 id=参考资料>参考资料</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：PostgreSQL 配置模板选择参数</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/template/olap/><strong>OLAP 模板</strong></a>：分析处理模板对比</li><li><a href=/docs/pgsql/template/crit/><strong>CRIT 模板</strong></a>：关键业务模板对比</li><li><a href=/docs/pgsql/template/tiny/><strong>TINY 模板</strong></a>：微型实例模板对比</li><li><a href=/docs/pgsql/config/cluster>集群配置</a>：PostgreSQL 集群类型配置</li><li><a href=/docs/concept/ha>高可用</a>：高可用架构设计</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-571aa5133064fa24ac707a69e4d84659>3 - OLAP 模板</h1><div class=lead>针对在线分析处理负载优化的 PostgreSQL 配置模板</div><p><code>olap.yml</code> 是针对<strong>在线分析处理</strong>（OLAP）负载优化的配置模板。适用于 4-128 核 CPU 的服务器，特点是支持大查询、高并行度、宽松的超时设置和激进的 Vacuum 策略。</p><blockquote><p>建议同时使用 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>olap</code> 进行操作系统级别的配套调优。</p></blockquote><hr><h2 id=适用场景>适用场景</h2><p>OLAP 模板适用于以下场景：</p><ul><li><strong>数据仓库</strong>：历史数据存储、多维分析</li><li><strong>BI 报表</strong>：复杂报表查询、仪表盘数据源</li><li><strong>ETL 处理</strong>：数据抽取、转换、加载</li><li><strong>数据分析</strong>：Ad-hoc 查询、数据探索</li><li><strong>HTAP 混合负载</strong>：分析型从库</li></ul><p><strong>特征负载</strong>：</p><ul><li>复杂查询（秒级到分钟级）</li><li>低并发连接（数十到数百）</li><li>读密集型，写入通常是批量操作</li><li>对吞吐量敏感，可以容忍较高延迟</li><li>需要扫描大量数据</li></ul><hr><h2 id=使用方法>使用方法</h2><p>在集群定义中指定 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <code>olap.yml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-olap</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-olap</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 分析处理模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统分析处理调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>也可以将 <a href=/docs/pgsql/template/olap/><strong><code>olap.yml</code></strong></a> 模板用于专用的离线从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-mixed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: offline, pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 离线分析从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-mixed</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 主库和在线从库使用 OLTP 模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统 OLTP 调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=参数详解>参数详解</h2><h3 id=连接管理>连接管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>OLAP 场景通常不需要大量连接，500 个连接足以应对大多数分析负载。</p><h3 id=内存配置>内存配置</h3><p>OLAP 模板的内存分配策略更为激进：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>计算公式</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>内存 × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>默认比例 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × <strong>50%</strong></td><td style=text-align:left>加速索引创建和 VACUUM</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>64MB - <strong>8GB</strong></td><td style=text-align:left>更大的排序/哈希内存</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>总内存 - shared_buffers</td><td style=text-align:left>可用于缓存的预估内存</td></tr></tbody></table><p><strong>work_mem 计算逻辑</strong>（与 OLTP 不同）：</p><pre tabindex=0><code>work_mem = min(max(shared_buffers / max_connections, 64MB), 8GB)
</code></pre><p>更大的 <code>work_mem</code> 允许更大的排序和哈希操作在内存中完成，避免磁盘溢出。</p><h3 id=锁与事务>锁与事务</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_locks_per_transaction</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span>-<span style=color:#000>4x maxconn  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLTP 是 1-2x</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>OLAP 查询可能涉及更多表（分区表、大量 JOIN），因此需要更多的锁槽。</p><h3 id=并行查询>并行查询</h3><p>OLAP 模板激进启用并行查询：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes: cpu + 12 (最小20)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cpu + 8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers: 80% × cpu (最小2)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000>%</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather: 50% × cpu   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>20</span><span style=color:#000>% (最大8)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_maintenance_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000>% × cpu</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>并行查询成本保持默认值，让优化器更倾向于选择并行计划：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># parallel_setup_cost: 1000    # 默认值，不加倍</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># parallel_tuple_cost: 0.1     # 默认值，不加倍</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>同时启用分区智能优化：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>enable_partitionwise_join</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 分区表智能 JOIN</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>enable_partitionwise_aggregate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 分区表智能聚合</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=io-配置pg17>IO 配置（PG17+）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>io_workers: 50% × cpu (4-32)    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000>% (4-16)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>更多的 IO 工作线程支持并行扫描大表。</p><h3 id=wal-配置>WAL 配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/20 (最大200GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_wal_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/5 (最大2000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_slot_wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘×3/10 (最大3000GB)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>temp_file_limit: 磁盘/5 (最大2000GB)   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>磁盘/20</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>更大的 <code>temp_file_limit</code> 允许更大的中间结果溢出到磁盘。</p><h3 id=vacuum-配置>Vacuum 配置</h3><p>OLAP 模板使用更激进的 vacuum 设置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_delay: 10ms         # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms，更快的 vacuum</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_limit: 10000        # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#000>，每轮更多工作</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_max_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_naptime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_vacuum_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.08</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_analyze_scale_factor</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.04</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>分析型数据库通常有大量批量写入，需要更激进的 vacuum 策略来回收空间。</p><h3 id=查询优化>查询优化</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>random_page_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>effective_io_concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>default_statistics_target: 1000    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#000>，更精确的统计信息</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>更高的 <code>default_statistics_target</code> 提供更精确的查询计划，对复杂分析查询尤为重要。</p><h3 id=日志与监控>日志与监控</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>100ms，放宽慢查询阈值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_checkpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_lock_waits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_temp_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_autovacuum_min_duration</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_cost_delay_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># PG18+，跟踪 vacuum 代价延迟</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=客户端超时>客户端超时</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deadlock_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout: 0   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min，禁用</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>分析查询可能需要长时间持有事务，因此禁用空闲事务超时。</p><hr><h2 id=与-oltp-模板的主要差异>与 OLTP 模板的主要差异</h2><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left><a href=/docs/pgsql/template/olap/><strong>OLAP</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/oltp/><strong>OLTP</strong></a></th><th style=text-align:left>差异原因</th></tr></thead><tbody><tr><td style=text-align:left>max_connections</td><td style=text-align:left>500</td><td style=text-align:left>500-1000</td><td style=text-align:left>分析负载连接数少</td></tr><tr><td style=text-align:left>work_mem 上限</td><td style=text-align:left>8GB</td><td style=text-align:left>1GB</td><td style=text-align:left>支持更大的内存排序</td></tr><tr><td style=text-align:left>maintenance_work_mem</td><td style=text-align:left>50% buffer</td><td style=text-align:left>25% buffer</td><td style=text-align:left>加速索引创建</td></tr><tr><td style=text-align:left>max_locks_per_transaction</td><td style=text-align:left>2-4x</td><td style=text-align:left>1-2x</td><td style=text-align:left>更多表参与查询</td></tr><tr><td style=text-align:left>max_parallel_workers</td><td style=text-align:left>80% cpu</td><td style=text-align:left>50% cpu</td><td style=text-align:left>激进并行</td></tr><tr><td style=text-align:left>max_parallel_workers_per_gather</td><td style=text-align:left>50% cpu</td><td style=text-align:left>20% cpu</td><td style=text-align:left>激进并行</td></tr><tr><td style=text-align:left>parallel_setup_cost</td><td style=text-align:left>1000</td><td style=text-align:left>2000</td><td style=text-align:left>默认值，鼓励并行</td></tr><tr><td style=text-align:left>parallel_tuple_cost</td><td style=text-align:left>0.1</td><td style=text-align:left>0.2</td><td style=text-align:left>默认值，鼓励并行</td></tr><tr><td style=text-align:left>enable_partitionwise_join</td><td style=text-align:left>on</td><td style=text-align:left>off</td><td style=text-align:left>分区表优化</td></tr><tr><td style=text-align:left>enable_partitionwise_aggregate</td><td style=text-align:left>on</td><td style=text-align:left>off</td><td style=text-align:left>分区表优化</td></tr><tr><td style=text-align:left>vacuum_cost_delay</td><td style=text-align:left>10ms</td><td style=text-align:left>20ms</td><td style=text-align:left>激进 vacuum</td></tr><tr><td style=text-align:left>vacuum_cost_limit</td><td style=text-align:left>10000</td><td style=text-align:left>2000</td><td style=text-align:left>激进 vacuum</td></tr><tr><td style=text-align:left>temp_file_limit</td><td style=text-align:left>1/5 磁盘</td><td style=text-align:left>1/20 磁盘</td><td style=text-align:left>允许更大临时文件</td></tr><tr><td style=text-align:left>io_workers</td><td style=text-align:left>50% cpu</td><td style=text-align:left>25% cpu</td><td style=text-align:left>更多并行 IO</td></tr><tr><td style=text-align:left>log_min_duration_statement</td><td style=text-align:left>1000ms</td><td style=text-align:left>100ms</td><td style=text-align:left>放宽慢查询阈值</td></tr><tr><td style=text-align:left>default_statistics_target</td><td style=text-align:left>1000</td><td style=text-align:left>400</td><td style=text-align:left>更精确统计</td></tr><tr><td style=text-align:left>idle_in_transaction_session_timeout</td><td style=text-align:left>禁用</td><td style=text-align:left>10min</td><td style=text-align:left>允许长事务</td></tr></tbody></table><hr><h2 id=性能调优建议>性能调优建议</h2><h3 id=结合-timescaledb>结合 TimescaleDB</h3><p>OLAP 模板与 TimescaleDB 配合使用效果极佳：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-timeseries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>timescaledb</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=结合-pg_duckdb>结合 pg_duckdb</h3><p>对于极致的分析性能，可以结合 pg_duckdb：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-analytics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_duckdb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=列式存储>列式存储</h3><p>考虑使用 Citus 的列式存储或 pg_mooncake：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>citus_columnar </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 或 pg_mooncake</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=资源隔离>资源隔离</h3><p>对于混合负载，建议将分析查询隔离到专用从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-mixed</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLTP 写入</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLTP 读取</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># OLAP 分析</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-mixed</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=监控指标>监控指标</h3><p>关注以下监控指标：</p><ul><li><strong>查询时间</strong>：长查询的执行时间分布</li><li><strong>并行度</strong>：并行工作进程的使用率</li><li><strong>临时文件</strong>：临时文件的大小和数量</li><li><strong>磁盘 IO</strong>：顺序扫描和索引扫描的 IO 量</li><li><strong>缓存命中率</strong>：shared_buffers 和 OS 缓存的命中率</li></ul><hr><h2 id=参考资料>参考资料</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：PostgreSQL 配置模板选择参数</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/template/oltp/><strong>OLTP 模板</strong></a>：事务处理模板对比</li><li><a href=/docs/pgsql/template/crit/><strong>CRIT 模板</strong></a>：关键业务模板对比</li><li><a href=/docs/pgsql/template/tiny/><strong>TINY 模板</strong></a>：微型实例模板对比</li><li><a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a>：专用分析实例</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-7cf828587f72da3b425e1bd025ccbacf>4 - CRIT 模板</h1><div class=lead>针对核心金融业务优化的 PostgreSQL 配置模板，强调数据安全与审计合规</div><p><code>crit.yml</code> 是针对<strong>核心金融业务</strong>优化的配置模板。适用于 4-128 核 CPU 的服务器，特点是强制同步复制、数据校验和、完整审计日志、严格的安全设置。这个模板牺牲一定的性能来换取最高级别的数据安全性。</p><blockquote><p>建议同时使用 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>crit</code> 进行操作系统级别的配套调优，优化脏页数量。</p></blockquote><hr><h2 id=适用场景>适用场景</h2><p>CRIT 模板适用于以下场景：</p><ul><li><strong>金融交易</strong>：银行转账、支付清算、证券交易</li><li><strong>核心账务</strong>：总账系统、会计系统</li><li><strong>合规审计</strong>：需要完整操作记录的业务</li><li><strong>关键业务</strong>：任何不能容忍数据丢失的场景</li></ul><p><strong>特征需求</strong>：</p><ul><li>零数据丢失（RPO = 0）</li><li>数据完整性校验</li><li>完整的审计日志</li><li>严格的安全策略</li><li>可以接受一定的性能损失</li></ul><hr><h2 id=使用方法>使用方法</h2><p>在集群定义中指定 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <code>crit.yml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-finance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-finance</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 关键业务模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统关键业务调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>建议</strong>：关键业务集群至少配置 3 个节点，以确保在一个节点故障时仍能保持同步复制。</p><hr><h2 id=核心特性>核心特性</h2><h3 id=强制同步复制>强制同步复制</h3><p>CRIT 模板<strong>强制启用同步复制</strong>，无论 <a href=/docs/pgsql/param#pg_rpo><code>pg_rpo</code></a> 设置为何值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 强制开启，不受 pg_rpo 影响</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这意味着每次事务提交都必须等待至少一个从库确认写入，确保 <strong>RPO = 0</strong>（零数据丢失）。</p><p><strong>代价</strong>：写入延迟会增加（通常增加 1-5ms，取决于网络延迟）。</p><h3 id=强制数据校验和>强制数据校验和</h3><p>CRIT 模板<strong>强制启用数据校验和</strong>，无论 <a href=/docs/pgsql/param#pg_checksum><code>pg_checksum</code></a> 设置为何值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>initdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>data-checksums  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 强制启用，不检查 pg_checksum 参数</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>数据校验和可以检测到磁盘静默损坏（bit rot），这对金融数据尤为重要。</p><h3 id=禁用并行查询>禁用并行查询</h3><p>CRIT 模板禁用了并行查询的 gather 操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 禁用并行查询</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>同时提高了并行查询的成本估算：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_setup_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>parallel_tuple_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0.2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_table_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>min_parallel_index_scan_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>2MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>原因</strong>：并行查询可能导致查询延迟不稳定，对于延迟敏感的金融交易场景，稳定可预测的性能更为重要。</p><hr><h2 id=参数详解>参数详解</h2><h3 id=连接管理>连接管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#000>/1000  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 取决于是否使用 pgbouncer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>与 OLTP 模板相同。</p><h3 id=内存配置>内存配置</h3><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>计算公式</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>内存 × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>默认比例 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × 25%</td><td style=text-align:left>用于 VACUUM、CREATE INDEX</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>64MB - 1GB</td><td style=text-align:left>与 OLTP 相同</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>总内存 - shared_buffers</td><td style=text-align:left>可用于缓存的预估内存</td></tr></tbody></table><h3 id=wal-配置关键差异>WAL 配置（关键差异）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_delay: 10ms              # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms，更频繁刷新</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>wal_writer_flush_after: 0           # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1MB，立即刷新，不缓冲</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_replication_slot_timeout: 3d   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>7d，更严格的槽位清理</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>wal_writer_flush_after: 0</code> 确保每次 WAL 写入都立即刷到磁盘，最大程度减少数据丢失风险。</p><h3 id=复制配置pg15->复制配置（PG15-）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_defer_cleanup_age</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500000</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 仅 PG15 及以下版本</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这个参数保留最近 50 万个事务的变更不被 vacuum 清理，为从库提供更多的追赶缓冲。</p><h3 id=审计日志关键差异>审计日志（关键差异）</h3><p>CRIT 模板启用完整的连接审计：</p><p><strong>PostgreSQL 18+</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;receipt,authentication,authorization&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>PostgreSQL 17 及以下</strong>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_disconnections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;on&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这记录了每个连接的完整生命周期，包括：</p><ul><li>连接接收</li><li>认证过程</li><li>授权结果</li><li>断开连接</li></ul><h3 id=查询日志>查询日志</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># 记录超过 100ms 的查询</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 记录所有 DDL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size: 32768    # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8192</span><span style=color:#000>，保存完整查询</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>32KB 的 <code>track_activity_query_size</code> 确保能捕获完整的长查询文本。</p><h3 id=统计跟踪>统计跟踪</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_cost_delay_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># PG18+，跟踪 vacuum 代价延迟</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>track_activity_query_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32768</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=客户端超时关键差异>客户端超时（关键差异）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout: 1min   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min，更严格</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>1 分钟的空闲事务超时可以快速释放持有锁的僵尸事务，避免阻塞其他交易。</p><h3 id=扩展配置>扩展配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;$libdir/passwordcheck, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>注意</strong>：CRIT 模板默认加载 <code>passwordcheck</code> 扩展，强制密码复杂度检查。</p><hr><h2 id=与-oltp-模板的主要差异>与 OLTP 模板的主要差异</h2><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left><a href=/docs/pgsql/template/crit/><strong>CRIT</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/oltp/><strong>OLTP</strong></a></th><th style=text-align:left>差异原因</th></tr></thead><tbody><tr><td style=text-align:left>synchronous_mode</td><td style=text-align:left><strong>强制 true</strong></td><td style=text-align:left>取决于 pg_rpo</td><td style=text-align:left>零数据丢失</td></tr><tr><td style=text-align:left>data-checksums</td><td style=text-align:left><strong>强制启用</strong></td><td style=text-align:left>可选</td><td style=text-align:left>数据完整性</td></tr><tr><td style=text-align:left>max_parallel_workers_per_gather</td><td style=text-align:left><strong>0</strong></td><td style=text-align:left>20% cpu</td><td style=text-align:left>稳定延迟</td></tr><tr><td style=text-align:left>wal_writer_delay</td><td style=text-align:left>10ms</td><td style=text-align:left>20ms</td><td style=text-align:left>更频繁刷新</td></tr><tr><td style=text-align:left>wal_writer_flush_after</td><td style=text-align:left><strong>0</strong></td><td style=text-align:left>1MB</td><td style=text-align:left>立即刷新</td></tr><tr><td style=text-align:left>idle_replication_slot_timeout</td><td style=text-align:left>3d</td><td style=text-align:left>7d</td><td style=text-align:left>更严格清理</td></tr><tr><td style=text-align:left>idle_in_transaction_session_timeout</td><td style=text-align:left><strong>1min</strong></td><td style=text-align:left>10min</td><td style=text-align:left>快速释放锁</td></tr><tr><td style=text-align:left>track_activity_query_size</td><td style=text-align:left><strong>32KB</strong></td><td style=text-align:left>8KB</td><td style=text-align:left>完整查询记录</td></tr><tr><td style=text-align:left>log_connections</td><td style=text-align:left><strong>完整记录</strong></td><td style=text-align:left>仅授权</td><td style=text-align:left>审计合规</td></tr><tr><td style=text-align:left>log_disconnections</td><td style=text-align:left><strong>on</strong></td><td style=text-align:left>off</td><td style=text-align:left>审计合规</td></tr><tr><td style=text-align:left>passwordcheck</td><td style=text-align:left><strong>启用</strong></td><td style=text-align:left>未启用</td><td style=text-align:left>密码安全</td></tr><tr><td style=text-align:left>vacuum_defer_cleanup_age</td><td style=text-align:left>500000</td><td style=text-align:left>0</td><td style=text-align:left>从库追赶缓冲</td></tr></tbody></table><hr><h2 id=性能影响>性能影响</h2><p>使用 CRIT 模板会带来以下性能影响：</p><h3 id=写入延迟增加>写入延迟增加</h3><p>同步复制会增加 1-5ms 的写入延迟（取决于网络）：</p><pre tabindex=0><code>异步复制: 提交 -&gt; 本地刷盘 -&gt; 返回客户端
同步复制: 提交 -&gt; 本地刷盘 -&gt; 等待从库确认 -&gt; 返回客户端
</code></pre><h3 id=写入吞吐量下降>写入吞吐量下降</h3><p>由于需要等待从库确认，写入 TPS 可能下降 10-30%。</p><h3 id=查询延迟更稳定>查询延迟更稳定</h3><p>禁用并行查询后，查询延迟更加可预测，没有并行查询启动的开销波动。</p><h3 id=资源开销略有增加>资源开销略有增加</h3><p>更频繁的 WAL 刷新和完整的审计日志会带来额外的 IO 开销。</p><hr><h2 id=高可用配置>高可用配置</h2><h3 id=最小推荐配置>最小推荐配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-critical</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-critical</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 关键业务模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统关键业务调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>3 节点配置确保在一个节点故障时仍能保持同步复制。</p><h3 id=跨机房部署>跨机房部署</h3><p>对于金融级别的容灾要求：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-critical</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 机房 A</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica, pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 机房 A</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.20.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica, pg_weight</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 机房 B（备用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-critical</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 关键业务模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统关键业务调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=法定人数提交>法定人数提交</h3><p>对于更高的一致性要求，可以配置多个同步从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-critical
</span></span><span style=display:flex><span>synchronous_mode: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>synchronous_node_count: <span style=color:#0000cf;font-weight:700>2</span>    <span style=color:#8f5902;font-style:italic># 需要 2 个从库确认</span>
</span></span></code></pre></div><hr><h2 id=安全加固建议>安全加固建议</h2><h3 id=密码策略>密码策略</h3><p>CRIT 模板已启用 <code>passwordcheck</code>，建议进一步配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 设置密码最小长度
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>password_encryption</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;scram-sha-256&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=审计扩展>审计扩展</h3><p>考虑启用 <code>pgaudit</code> 扩展进行更详细的审计：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain, pgaudit&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgaudit.log</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;ddl, role, write&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=网络隔离>网络隔离</h3><p>确保数据库网络与业务网络隔离，使用 <a href=/docs/pgsql/config/hba>HBA 规则</a> 限制访问。</p><hr><h2 id=监控指标>监控指标</h2><p>对于关键业务集群，重点关注：</p><ul><li><strong>复制延迟</strong>：同步复制延迟应接近 0</li><li><strong>事务提交时间</strong>：p99 延迟</li><li><strong>锁等待</strong>：长时间锁等待可能影响业务</li><li><strong>检查点</strong>：检查点持续时间和频率</li><li><strong>WAL 生成速率</strong>：预测磁盘空间需求</li></ul><hr><h2 id=参考资料>参考资料</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：PostgreSQL 配置模板选择参数</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/param#pg_rpo><strong><code>pg_rpo</code></strong></a>：恢复点目标参数</li><li><a href=/docs/pgsql/template/oltp/><strong>OLTP 模板</strong></a>：事务处理模板对比</li><li><a href=/docs/pgsql/template/olap/><strong>OLAP 模板</strong></a>：分析处理模板对比</li><li><a href=/docs/pgsql/template/tiny/><strong>TINY 模板</strong></a>：微型实例模板对比</li><li><a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a>：同步复制配置</li><li><a href=/docs/pgsql/config/cluster#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4>法定人数提交</a>：更高一致性级别</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-609856237df74f1f0f6e5fba1111e545>5 - TINY 模板</h1><div class=lead>针对微型实例和资源受限环境优化的 PostgreSQL 配置模板</div><p><code>tiny.yml</code> 是针对<strong>微型实例</strong>和资源受限环境优化的配置模板。适用于 1-3 核 CPU 的服务器，特点是最小化资源占用、保守的内存分配、禁用并行查询。</p><blockquote><p>建议同时使用 <a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a> = <code>tiny</code> 进行操作系统级别的配套调优。</p></blockquote><hr><h2 id=适用场景>适用场景</h2><p>TINY 模板适用于以下场景：</p><ul><li><strong>开发测试</strong>：本地开发环境、CI/CD 测试</li><li><strong>低配虚拟机</strong>：1-2 核 CPU、1-4GB 内存的云主机</li><li><strong>边缘计算</strong>：树莓派、嵌入式设备</li><li><strong>Demo 演示</strong>：快速体验 Pigsty 功能</li><li><strong>个人项目</strong>：资源有限的个人博客、小型应用</li></ul><p><strong>资源限制</strong>：</p><ul><li>1-3 核 CPU</li><li>1-8 GB 内存</li><li>有限的磁盘空间</li><li>可能与其他服务共享资源</li></ul><hr><h2 id=使用方法>使用方法</h2><p>在集群定义中指定 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> = <code>tiny.yml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-dev</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>单节点开发环境：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>127.0.0.1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-local</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=参数详解>参数详解</h2><h3 id=连接管理>连接管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections: 250   # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500-1000</span><span style=color:#000>，减少连接开销</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>superuser_reserved_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>微型实例不需要处理大量并发连接，250 个连接足以应对开发测试场景。</p><h3 id=内存配置>内存配置</h3><p>TINY 模板使用保守的内存分配策略：</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>计算公式</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>shared_buffers</code></td><td style=text-align:left>内存 × <code>pg_shared_buffer_ratio</code></td><td style=text-align:left>默认比例 0.25</td></tr><tr><td style=text-align:left><code>maintenance_work_mem</code></td><td style=text-align:left>shared_buffers × 25%</td><td style=text-align:left>用于 VACUUM、CREATE INDEX</td></tr><tr><td style=text-align:left><code>work_mem</code></td><td style=text-align:left>16MB - <strong>256MB</strong></td><td style=text-align:left>更小的排序/哈希内存</td></tr><tr><td style=text-align:left><code>effective_cache_size</code></td><td style=text-align:left>总内存 - shared_buffers</td><td style=text-align:left>可用于缓存的预估内存</td></tr></tbody></table><p><strong>work_mem 计算逻辑</strong>（与 OLTP 不同）：</p><pre tabindex=0><code>work_mem = min(max(shared_buffers / max_connections, 16MB), 256MB)
</code></pre><p>更小的 <code>work_mem</code> 上限（256MB vs OLTP 的 1GB）避免内存溢出。</p><h3 id=并行查询完全禁用>并行查询（完全禁用）</h3><p>TINY 模板完全禁用了并行查询：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes: cpu + 4 (最小12)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cpu + 8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers: 50% × cpu (最小1)      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000>% (最小2)</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_workers_per_gather</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 禁用并行查询</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_parallel_maintenance_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>33</span><span style=color:#000>% × cpu (最小1)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>max_parallel_workers_per_gather: 0</code> 确保查询不会启动并行工作进程，避免在低核心环境下争抢资源。</p><h3 id=io-配置pg17>IO 配置（PG17+）</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>io_workers: 3   # 固定值，OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>25</span><span style=color:#000>% cpu (4-16)</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>固定的低 IO 工作线程数量，适合资源受限环境。</p><h3 id=vacuum-配置>Vacuum 配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>vacuum_cost_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_max_workers: 2          # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000>，减少一个工作进程</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>autovacuum_naptime</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1min</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># autovacuum_vacuum_scale_factor 使用默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># autovacuum_analyze_scale_factor 使用默认值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>减少 autovacuum 工作进程数量，降低后台资源占用。</p><h3 id=查询优化>查询优化</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>random_page_cost</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1.1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>effective_io_concurrency</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>default_statistics_target: 200     # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#000>，降低统计精度以节省空间</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>较低的 <code>default_statistics_target</code> 减少 <code>pg_statistic</code> 表的大小。</p><h3 id=日志配置>日志配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 与 OLTP 相同</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_checkpoints</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_lock_waits</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>log_temp_files</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># log_connections 使用默认设置（不额外记录）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>TINY 模板不启用额外的连接日志，以减少日志量。</p><h3 id=客户端超时>客户端超时</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>deadlock_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>50ms</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>idle_in_transaction_session_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 与 OLTP 相同</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=扩展配置>扩展配置</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.max: 2500      # OLTP</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10000</span><span style=color:#000>，减少内存占用</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_utility</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_stat_statements.track_planning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>pg_stat_statements.max</code> 从 10000 降到 2500，减少约 75% 的内存占用。</p><hr><h2 id=与-oltp-模板的主要差异>与 OLTP 模板的主要差异</h2><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left><a href=/docs/pgsql/template/tiny/><strong>TINY</strong></a></th><th style=text-align:left><a href=/docs/pgsql/template/oltp/><strong>OLTP</strong></a></th><th style=text-align:left>差异原因</th></tr></thead><tbody><tr><td style=text-align:left>max_connections</td><td style=text-align:left><strong>250</strong></td><td style=text-align:left>500-1000</td><td style=text-align:left>减少连接开销</td></tr><tr><td style=text-align:left>work_mem 上限</td><td style=text-align:left><strong>256MB</strong></td><td style=text-align:left>1GB</td><td style=text-align:left>避免内存溢出</td></tr><tr><td style=text-align:left>max_worker_processes</td><td style=text-align:left>cpu+4</td><td style=text-align:left>cpu+8</td><td style=text-align:left>减少后台进程</td></tr><tr><td style=text-align:left>max_parallel_workers_per_gather</td><td style=text-align:left><strong>0</strong></td><td style=text-align:left>20% cpu</td><td style=text-align:left>禁用并行查询</td></tr><tr><td style=text-align:left>autovacuum_max_workers</td><td style=text-align:left><strong>2</strong></td><td style=text-align:left>3</td><td style=text-align:left>减少后台负载</td></tr><tr><td style=text-align:left>default_statistics_target</td><td style=text-align:left><strong>200</strong></td><td style=text-align:left>400</td><td style=text-align:left>节省空间</td></tr><tr><td style=text-align:left>pg_stat_statements.max</td><td style=text-align:left><strong>2500</strong></td><td style=text-align:left>10000</td><td style=text-align:left>减少内存占用</td></tr><tr><td style=text-align:left>io_workers</td><td style=text-align:left><strong>3</strong></td><td style=text-align:left>25% cpu</td><td style=text-align:left>固定低值</td></tr></tbody></table><hr><h2 id=资源估算>资源估算</h2><p>以下是 TINY 模板在不同配置下的资源使用估算：</p><h3 id=1-核-1gb-内存>1 核 1GB 内存</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~16MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~64MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~12</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>PostgreSQL 进程内存占用</strong>：约 400-600MB</p><h3 id=2-核-4gb-内存>2 核 4GB 内存</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~1GB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~32MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>max_worker_processes</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>~12</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>PostgreSQL 进程内存占用</strong>：约 1.5-2GB</p><h3 id=4-核-8gb-内存>4 核 8GB 内存</h3><p>此配置建议使用 OLTP 模板而非 TINY 模板：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-small</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 4核8GB可以使用OLTP模板</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=性能调优建议>性能调优建议</h2><h3 id=进一步减少资源>进一步减少资源</h3><p>如果资源极度受限，可以考虑：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>max_connections</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 进一步减少</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MB         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 进一步减少</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>32MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>8MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=禁用不需要的扩展>禁用不需要的扩展</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 只保留必要扩展</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=关闭不需要的功能>关闭不需要的功能</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>track_io_timing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 禁用 IO 时间跟踪</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>track_functions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>none         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 禁用函数跟踪</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=使用外部连接池>使用外部连接池</h3><p>即使在微型实例上，使用 PgBouncer 也能显著提高并发能力：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-tiny</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_service_dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbouncer</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer_poolmode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=云平台推荐规格>云平台推荐规格</h2><h3 id=aws>AWS</h3><ul><li><strong>t3.micro</strong>：1 vCPU, 1GB RAM - 适合 TINY</li><li><strong>t3.small</strong>：2 vCPU, 2GB RAM - 适合 TINY</li><li><strong>t3.medium</strong>：2 vCPU, 4GB RAM - 可考虑 OLTP</li></ul><h3 id=阿里云>阿里云</h3><ul><li><strong>ecs.t6-c1m1.small</strong>：1 vCPU, 1GB RAM - 适合 TINY</li><li><strong>ecs.t6-c1m2.small</strong>：1 vCPU, 2GB RAM - 适合 TINY</li><li><strong>ecs.t6-c1m4.small</strong>：1 vCPU, 4GB RAM - 适合 TINY</li></ul><h3 id=腾讯云>腾讯云</h3><ul><li><strong>SA2.SMALL1</strong>：1 vCPU, 1GB RAM - 适合 TINY</li><li><strong>SA2.SMALL2</strong>：1 vCPU, 2GB RAM - 适合 TINY</li><li><strong>SA2.SMALL4</strong>：1 vCPU, 4GB RAM - 适合 TINY</li></ul><hr><h2 id=边缘设备部署>边缘设备部署</h2><h3 id=树莓派-4>树莓派 4</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-pi</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>192.168.1.100</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-pi</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_storage_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>SSD   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 建议使用 SSD 存储</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=docker-容器>Docker 容器</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-docker</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>172.17.0.2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-docker</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny.yml      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PostgreSQL 微型实例模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>tiny        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 操作系统微型实例调优</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=升级到-oltp>升级到 OLTP</h2><p>当您的应用增长，需要更多资源时，可以轻松升级到 <a href=/docs/pgsql/template/oltp/><strong>OLTP 模板</strong></a>：</p><ol><li>升级虚拟机规格（4核 8GB 以上）</li><li>修改集群配置：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-growing</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp.yml   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 从 tiny.yml 改为 oltp.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_tune</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oltp     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 从 tiny 改为 oltp</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ol start=3><li><a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>重新配置集群</a> 或重新部署</li></ol><hr><h2 id=参考资料>参考资料</h2><ul><li><a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a>：PostgreSQL 配置模板选择参数</li><li><a href=/docs/node/param#node_tune><strong><code>node_tune</code></strong></a>：操作系统调优模板，应与 <code>pg_conf</code> 配套</li><li><a href=/docs/pgsql/template/oltp/><strong>OLTP 模板</strong></a>：事务处理模板，4核8GB 以上可升级使用</li><li><a href=/docs/pgsql/template/olap/><strong>OLAP 模板</strong></a>：分析处理模板</li><li><a href=/docs/pgsql/template/crit/><strong>CRIT 模板</strong></a>：关键业务模板</li><li><a href=/docs/setup/install#%E9%83%A8%E7%BD%B2>单机部署</a>：Pigsty 单机安装指南</li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>