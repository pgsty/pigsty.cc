<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/pgsql/config/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/pgsql/config/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>集群配置 | PIGSTY</title><meta name=description content="根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。"><meta property="og:url" content="https://pigsty.cc/docs/pgsql/config/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="集群配置"><meta property="og:description" content="根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="集群配置"><meta itemprop=description content="根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。"><meta itemprop=dateModified content="2026-01-11T11:42:23+08:00"><meta itemprop=wordCount content="190"><meta itemprop=keywords content="参考,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="集群配置"><meta name=twitter:description content="根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/pgsql/config/>返回本页常规视图</a>.</p></div><h1 class=title>集群配置</h1><div class=lead>根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。</div><ul><li>1: <a href=#pg-01e9f6eb810a0f6072913a962bfd631d>集群实例</a></li><li>2: <a href=#pg-64c78407e33d191b14a78a9a03369255>内核版本</a></li><li>3: <a href=#pg-ad5d6482cea01b850636a3033b3ec973>别名翻译</a></li><li>4: <a href=#pg-f3a29e30e1bcb1622450d4b2d3604bdc>用户/角色</a></li><li>5: <a href=#pg-662c4a4a95a52da3073eeed2f4407af9>数据库</a></li><li>6: <a href=#pg-be500246ccc4d0aea19a8d2e848cf128>HBA 规则</a></li><li>7: <a href=#pg-ff84fb35cef7a71a971ba3fb6712ed0c>参数配置</a></li><li>8: <a href=#pg-f26623b2f855e9bc5073aeb50aea422a>访问控制</a></li></ul><div class=content><p>Pigsty 是一个“配置驱动”的 PostgreSQL 平台：所有行为都来自 <code>~/pigsty/conf/*.yml</code> 清单与 <a href=/docs/pgsql/param><code>PGSQL</code> 参数</a> 的组合。</p><p>只要写好配置，你就能在几分钟内复刻出一套包含实例、用户、数据库、访问控制、扩展与调优策略的定制集群。</p><hr><h2 id=配置入口>配置入口</h2><ol><li><strong>准备清单</strong>：复制 <code>pigsty/conf/*.yml</code> 模板或从零开始编写 Ansible Inventory，将集群分组（<code>all.children.&lt;cls>.hosts</code>）与全局变量（<code>all.vars</code>）写入同一个文件。</li><li><strong>定义参数</strong>：在 <code>vars</code> 区块中覆盖需要的 <a href=/docs/pgsql/param><code>PGSQL</code> 参数</a>。全局 → 集群 → 主机的覆盖顺序决定了最终值。</li><li><strong>应用配置</strong>：运行 <code>./configure -c &lt;conf></code> 或 <code>bin/pgsql-add &lt;cls></code> 等剧本让配置落地。Pigsty 会根据参数生成 Patroni/pgbouncer/pgbackrest 等服务所需的配置文件。</li></ol><p>Pigsty 默认的 Demo 清单 <code>conf/pgsql.yml</code> 就是一份最小化示例：一个 <code>pg-meta</code> 集群、全局 <code>pg_version: 18</code>、少量业务用户与数据库定义。你可以在此基础上扩展更多集群。</p><hr><h2 id=关注点与文档索引>关注点与文档索引</h2><p>Pigsty 的 PostgreSQL 配置可以从以下几个维度组合，后续文档会逐一展开“如何配置”：</p><ul><li><strong><a href=/docs/pgsql/config/cluster>集群实例</a></strong>：通过 <code>pg_cluster / pg_role / pg_seq / pg_upstream</code> 定义实例拓扑（单机、主从、备份集群、延迟集群、Citus 等）。</li><li><strong><a href=/docs/pgsql/config/kernel>内核版本</a></strong>：使用 <code>pg_version</code>、<code>pg_mode</code>、<code>pg_packages</code>、<code>pg_extensions</code>、<code>pg_conf</code> 等参数挑选核心版本、风味和调优模板。</li><li><strong><a href=/docs/pgsql/config/user>用户/角色</a></strong>：在 <code>pg_default_roles</code> 与 <code>pg_users</code> 中声明系统角色、业务账号、密码策略以及连接池属性。</li><li><strong><a href=/docs/pgsql/config/db>数据库对象</a></strong>：借助 <code>pg_databases</code>、<code>baseline</code>、<code>schemas</code>、<code>extensions</code>、<code>pool_*</code> 字段按需创建数据库并自动接入 pgbouncer/Grafana。</li><li><strong><a href=/docs/pgsql/config/hba>访问控制 (HBA)</a></strong>：利用 <code>pg_default_hba_rules</code> 与 <code>pg_hba_rules</code> 维护主机级认证策略，保证不同角色/网络的访问边界。</li><li><strong><a href=/docs/pgsql/config/acl>权限模型 (ACL)</a></strong>：通过 <code>pg_default_privileges</code>、<code>pg_default_roles</code>、<code>pg_revoke_public</code> 等参数收敛对象权限，开箱即用地提供分层角色体系。</li></ul><p>理解这些参数之后，你就可以针对任意业务需求写出“配置即基础设施”的声明式清单，Pigsty 会负责执行并确保幂等。</p><hr><h2 id=一个典型示例>一个典型示例</h2><p>下面的片段展示了如何在同一个配置文件中同时控制实例拓扑、内核版本、扩展、用户以及数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-analytics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica, pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bi, owner: dbuser_bi, schemas: [mart], extensions: [timescaledb], pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_bi, password: DBUser.BI, roles: [dbrole_admin], pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main pgsql-common ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_bi, db: bi, addr: intra, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;BI 只允许内网 SSL 访问&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>pg-analytics</code> 集群包含一个主库和一个离线副本。</li><li>全局指定 <code>pg_version: 17</code> 与一套扩展示例，并加载 <code>olap.yml</code> 调优。</li><li>在 <code>pg_databases</code> 与 <code>pg_users</code> 中声明业务对象，自动生成 schema/extension 与连接池条目。</li><li>附加的 <code>pg_hba_rules</code> 限制了访问来源与认证方式。</li></ul><p>修改并应用这份清单即可得到一套定制化的 PostgreSQL 集群，而无需手工逐项配置。</p></div></div><div class=td-content style=page-break-before:always><h1 id=pg-01e9f6eb810a0f6072913a962bfd631d>1 - 集群实例</h1><div class=lead>根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。</div><blockquote><p>根据需求场景选择合适的实例与集群类型，配置出满足需求的 PostgreSQL 数据库集群。</p></blockquote><p>您可以定义不同类型的实例和集群，下面是 Pigsty 中常见的几种 PostgreSQL 实例/集群类型：</p><ul><li><a href=#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93>读写主库</a>：定义单一实例集群。</li><li><a href=#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读从库</a>：定义具有一个主库和一个副本的基本HA集群。</li><li><a href=#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a>：定义专用于OLAP/ETL/交互式查询的实例</li><li><a href=#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a>：启用同步提交以确保没有数据丢失。</li><li><a href=#%E6%B3%95%E5%AE%9A%E4%BA%BA%E6%95%B0%E6%8F%90%E4%BA%A4>法定人数提交</a>：使用多数同步提交获得更高的一致性级别。</li><li><a href=#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a>：克隆现有集群并跟随它</li><li><a href=#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟集群</a>：克隆现有集群用于紧急数据恢复</li><li><a href=#citus%E9%9B%86%E7%BE%A4>Citus集群</a>：定义一个Citus分布式数据库集群</li></ul><hr><h2 id=读写主库>读写主库</h2><p>我们从最简单的情况开始：由一个主库（Primary）组成的单实例集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这段配置言简意赅，自我描述，仅由 <a href=/docs/concept/model/pgsql#%E8%BA%AB%E4%BB%BD%E5%8F%82%E6%95%B0><strong>身份参数</strong></a> 构成，请注意 Ansible Group 分组名应当与 <a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a> 保持一致。</p><p>使用以下命令创建该集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test
</span></span></code></pre></div><p>Demo展示，开发测试，承载临时需求，进行无关紧要的计算分析任务时，使用单一数据库实例可能并没有太大问题。但这样的单机集群没有 <a href=/docs/concept/ha>高可用</a>，当出现硬件故障时，您需要使用 <a href=/docs/concept/pitr>PITR</a> 或其他恢复手段来确保集群的 RTO / RPO。为此，您可以考虑为集群添加若干个 <a href=#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读从库</a></p><hr><h2 id=只读从库>只读从库</h2><p>要添加一台只读从库（Replica）实例，您可以在 <code>pg-test</code> 中添加一个新节点，并将其 <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> 设置为<code>replica</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 新添加的从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果整个集群不存在，您可以直接 <a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4>创建</a> 这个完整的集群。 如果集群主库已经初始化好了，那么您可以向现有集群 <a href=/docs/pgsql/admin/cluster#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4>添加</a> 一个从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test               <span style=color:#8f5902;font-style:italic># 一次性初始化整个集群</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-test 10.10.10.12   <span style=color:#8f5902;font-style:italic># 添加从库到现有的集群</span>
</span></span></code></pre></div><p>当集群主库出现故障时，只读实例（Replica）可以在高可用系统的帮助下接管主库的工作。除此之外，只读实例还可以用于执行只读查询：许多业务的读请求要比写请求多很多，而大部分只读查询负载都可以由从库实例承担。</p><hr><h2 id=离线从库>离线从库</h2><p>离线实例（Offline）是专门用于服务慢查询、ETL、OLAP流量和交互式查询等的专用只读从库。慢查询/长事务对在线业务的性能与稳定性有不利影响，因此最好将它们与在线业务隔离开来。</p><p>要添加离线实例，请为其分配一个新实例，并将 <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> 设置为<code>offline</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 新添加的离线从库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>专用离线实例的工作方式与常见的从库实例类似，但它在 <code>pg-test-replica</code> 服务中用作备份服务器。 也就是说，只有当所有<code>replica</code>实例都宕机时，离线和主实例才会提供此项只读服务。</p><p>许多情况下，数据库资源有限，单独使用一台服务器作为离线实例是不经济的做法。作为折中，您可以选择一台现有的从库实例，打上 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> 标记，将其标记为一台可以承载"离线查询"的实例。在这种情况下，这台只读从库会同时承担在线只读请求与离线类查询。您可以使用 <a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a> 和 <a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a> 对离线实例进行额外的访问控制。</p><hr><h2 id=同步备库>同步备库</h2><p>当启用同步备库（Sync Standby）时，PostgreSQL 将选择一个从库作为<strong>同步备库</strong>，其他所有从库作为<strong>候选者</strong>。 主数据库会等待备库实例刷新到磁盘，然后才确认提交，备库实例始终拥有最新的数据，没有复制延迟，主从切换至同步备库不会有数据丢失。</p><p>PostgreSQL 默认使用异步流复制，这可能会有小的复制延迟（10KB / 10ms 数量级）。当主库失败时，可能会有一个小的数据丢失窗口（可以使用 <a href=/docs/pgsql/param#pg_rpo><code>pg_rpo</code></a> 来控制），但对于大多数场景来说，这是可以接受的。</p><p>但在某些关键场景中（例如，金融交易），数据丢失是完全不可接受的，或者，读取复制延迟是不可接受的。在这种情况下，您可以使用同步提交来解决这个问题。 要启用同步备库模式，您可以简单地使用 <a href=/docs/pgsql/param#pg_conf><code>pg_conf</code></a> 中的<code>crit.yml</code>模板。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 使用 crit 模板</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>要在现有集群上启用同步备库，请 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a> 并启用 <code>synchronous_mode</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test    <span style=color:#8f5902;font-style:italic># 在管理员节点以管理员用户身份运行</span>
</span></span><span style=display:flex><span>+++
</span></span><span style=display:flex><span>-synchronous_mode: <span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># &lt;--- 旧值</span>
</span></span><span style=display:flex><span>+synchronous_mode: <span style=color:#204a87>true</span>     <span style=color:#8f5902;font-style:italic># &lt;--- 新值</span>
</span></span><span style=display:flex><span> synchronous_mode_strict: <span style=color:#204a87>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>应用这些更改？<span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>在这种情况下，PostgreSQL 配置项 <a href=https://www.postgresql.org/docs/current/runtime-config-replication.html#synchronous_standby_names><code>synchronous_standby_names</code></a> 由 Patroni 自动管理。
一台从库将被选拔为同步从库，它的 <code>application_name</code> 将被写入 PostgreSQL 主库配置文件中并应用生效。</p><hr><h2 id=法定人数提交>法定人数提交</h2><p>法定人数提交（Quorum Commit）提供了比同步备库更强大的控制能力：特别是当您有多个从库时，您可以设定提交成功的标准，实现更高/更低的一致性级别（以及可用性之间的权衡）。</p><p>如果想要<strong>最少两个从</strong>库来确认提交，可以通过 Patroni <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a>，调整参数 <a href=https://patroni.readthedocs.io/en/latest/replication_modes.html#synchronous-replication-factor><code>synchronous_node_count</code></a> 并应用生效</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 确保同步提交已经启用</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_node_count</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 指定“至少”有多少个从库提交成功，才算提交成功</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果你想要使用更多的同步从库，修改 <code>synchronous_node_count</code> 的取值即可。当集群的规模发生变化时，您应当确保这里的配置仍然是有效的，以避免服务不可用。</p><p>在这种情况下，PostgreSQL 配置项 <a href=https://www.postgresql.org/docs/current/runtime-config-replication.html#synchronous_standby_names><code>synchronous_standby_names</code></a> 由 Patroni 自动管理。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>synchronous_standby_names = &#39;2 (&#34;pg-test-3&#34;,&#34;pg-test-2&#34;)&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><details><summary>示例：使用多个同步从库</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span>+synchronous_node_count: <span style=color:#0000cf;font-weight:700>2</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>应用配置后，出现两个同步备库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7080814403632534854<span style=color:#ce5c00;font-weight:700>)</span> +---------+----+-----------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role         <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB <span style=color:#000;font-weight:700>|</span> Tags            <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span> Leader       <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Sync Standby <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Sync Standby <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+--------------+---------+----+-----------+-----------------+
</span></span></code></pre></div></details><p>另一种情景是，使用 <strong>任意n个</strong> 从库来确认提交。在这种情况下，配置的方式略有不同，例如，假设我们只需要任意一个从库确认提交：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>synchronous_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>quorum       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用法定人数提交</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>postgresql</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 修改 PostgreSQL 的配置参数 synchronous_standby_names ，使用 `ANY n ()` 语法</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>synchronous_standby_names</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;ANY 1 (*)&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 你可以指定具体的从库列表，或直接使用 * 通配所有从库。</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><details><summary>示例：启用ANY法定人数提交</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>+    synchronous_standby_names: <span style=color:#4e9a06>&#39;ANY 1 (*)&#39;</span> <span style=color:#8f5902;font-style:italic># 在 ANY 模式下，需要使用此参数</span>
</span></span><span style=display:flex><span>- synchronous_node_count: <span style=color:#0000cf;font-weight:700>2</span>  <span style=color:#8f5902;font-style:italic># 在 ANY 模式下， 不需要使用此参数</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>应用后，配置生效，所有备库在 Patroni 中变为普通的 replica。但是在 <code>pg_stat_replication</code> 中可以看到 <code>sync_state</code> 会变为 <code>quorum</code>。</p></details><hr><h2 id=备份集群>备份集群</h2><p>您可以克隆现有的集群，并创建一个备份集群（Standby Cluster），用于数据迁移、水平拆分、多区域部署，或灾难恢复。</p><p>在正常情况下，备份集群将追随上游集群并保持内容同步，您可以将备份集群提升，作为真正地独立集群。</p><p>备份集群的定义方式与正常集群的定义基本相同，除了在主库上额外定义了 <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a> 参数，备份集群的主库被称为 <strong>备份集群领导者</strong> （Standby Leader）。</p><p>例如，下面定义了一个<code>pg-test</code>集群，以及其备份集群<code>pg-test2</code>，其配置清单可能如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test 是原始集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test2 是 pg-test 的备份集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- pg_upstream 在这里定义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test2 }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>而 <code>pg-test2</code> 集群的主节点 <code>pg-test2-1</code> 将是 <code>pg-test</code> 的下游从库，并在<code>pg-test2</code>集群中充当备份集群领导者（<strong>Standby Leader</strong>）。</p><p>只需确保备份集群的主节点上配置了 <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a> 参数，以便自动从原始上游拉取备份。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test     <span style=color:#8f5902;font-style:italic># 创建原始集群</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-test2    <span style=color:#8f5902;font-style:italic># 创建备份集群</span>
</span></span></code></pre></div><details><summary>示例：更改复制上游</summary><p>如有必要（例如，上游发生主从切换/故障转移），您可以通过 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置集群</a> 更改备份集群的复制上游。</p><p>要这样做，只需将<code>standby_cluster.host</code>更改为新的上游IP地址并应用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.13     <span style=color:#8f5902;font-style:italic># &lt;--- 旧的上游</span>
</span></span><span style=display:flex><span>+  host: 10.10.10.12     <span style=color:#8f5902;font-style:italic># &lt;--- 新的上游</span>
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><details><summary>示例：提升备份集群</summary><p>你可以随时将备份集群提升为独立集群，这样该集群就可以独立承载写入请求，并与原集群分叉。</p><p>为此，你必须 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置</a> 该集群并完全擦除<code>standby_cluster</code>部分，然后应用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>-standby_cluster:
</span></span><span style=display:flex><span>-  create_replica_methods:
</span></span><span style=display:flex><span>-  - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11
</span></span><span style=display:flex><span>-  port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><details><summary>示例：级联复制</summary><p>如果您在一台从库上指定了 <a href=/docs/pgsql/param#pg_upstream><code>pg_upstream</code></a>，而不是主库。那么可以配置集群的 <strong>级联复制</strong>（Cascade Replication）</p><p>在配置级联复制时，您必须使用集群中某一个实例的IP地址作为参数的值，否则初始化会报错。该从库从特定的实例进行流复制，而不是主库。</p><p>这台充当 WAL 中继器的实例被称为 <strong>桥接实例</strong>（Bridge Instance）。使用桥接实例可以分担主库发送 WAL 的负担，当您有几十台从库时，使用桥接实例级联复制是一个不错的注意。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pg-test-1 ---&gt; pg-test-2 ---&gt; pg-test-3</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 桥接实例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica, pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># ^--- 从 pg-test-2 (桥接)复制，而不是从 pg-test-1 (主节点) </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=延迟集群>延迟集群</h2><p>延迟集群（Delayed Cluster）是一种特殊类型的 <a href=#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a>，用于尽快恢复"意外删除"的数据。</p><p>例如，如果你希望有一个名为 <code>pg-testdelay</code> 的集群，其数据内容与一小时前的 <code>pg-test</code> 集群相同：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test 是原始集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-testdelay 是 pg-test 的延迟集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-testdelay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_upstream: 10.10.10.11, pg_delay</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1d }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-testdelay }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>你还可以在现有的 <a href=#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a> 上 <a href=/docs/pgsql/admin/cluster#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4>配置</a> 一个"复制延迟"。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-testdelay
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>   host: 10.10.10.11
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>+  recovery_min_apply_delay: 1h    <span style=color:#8f5902;font-style:italic># &lt;--- 在此处添加延迟时长，例如1小时</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>当某些元组和表格被意外删除时，你可以通过修改此参数的方式，将此延迟集群推进到适当的时间点，并从中读取数据，快速修复原始集群。</p><p>延迟集群需要额外的资源，但比起 <a href=/docs/concept/pitr#%E6%81%A2%E5%A4%8D>PITR</a> 要快得多，并且对系统的影响也小得多，对于非常关键的集群，可以考虑搭建延迟集群。</p><hr><h2 id=citus集群>Citus集群</h2><p>Pigsty 原生支持 Citus。可以参考 <a href=https://github.com/Vonng/pigsty/blob/main/conf/citus.yml><code>files/pigsty/citus.yml</code></a> 与 <a href=https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L298><code>prod.yml</code></a> 作为样例。</p><p>要定义一个 citus 集群，您需要指定以下参数：</p><ul><li><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a> 必须设置为 <code>citus</code>，而不是默认的 <code>pgsql</code></li><li>在每个分片集群上都必须定义分片名 <a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a> 和分片号 <a href=/docs/pgsql/param#pg_group><code>pg_group</code></a></li><li>必须定义 <a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a> 来指定由 Patroni 管理的 Citus 数据库。</li><li>如果您想使用 <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a> 的 <code>postgres</code> 而不是默认的 <a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a> 来执行管理命令，那么 <a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a> 必须设置为非空的纯文本密码</li></ul><p>此外，还需要额外的 hba 规则，允许从本地和其他数据节点进行 SSL 访问。如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 0号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 1号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 2号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus2 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 3号分片</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.14</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus3 , pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># 所有 Citus 集群的全局参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgsql 集群模式需要设置为： citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 水平分片名称： pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus 数据库名称：meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 如果使用 dbsu ，那么需要为其配置一个密码</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_meta ,password: DBUser.Meta ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus }, { name: postgis }, { name: timescaledb } ] } ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32 ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra        ,auth: ssl ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>在协调者节点上，您可以创建分布式表和引用表，并从任何数据节点查询它们。从 11.2 开始，任何 Citus 数据库节点都可以扮演协调者的角色了。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>SELECT create_distributed_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_accounts&#39;</span>, <span style=color:#4e9a06>&#39;aid&#39;</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_accounts<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>SELECT create_reference_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_branches&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>         <span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_branches<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>SELECT create_reference_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_history&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_history<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>SELECT create_reference_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#39;pgbench_tellers&#39;</span><span style=color:#ce5c00;font-weight:700>)</span>          <span style=color:#000;font-weight:700>;</span> SELECT truncate_local_data_after_distributing_table<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#000>$$</span>public.pgbench_tellers<span style=color:#000>$$</span><span style=color:#ce5c00;font-weight:700>)</span><span style=color:#000;font-weight:700>;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-64c78407e33d191b14a78a9a03369255>2 - 内核版本</h1><div class=lead>如何选择合适的 PostgreSQL 内核与大版本。</div><blockquote><p>在 Pigsty 中选择"内核"意味着确定 PostgreSQL 大版本、模式/发行版、需要安装的包以及要加载的调优模板。</p></blockquote><p>Pigsty v4.1 当前支持 PostgreSQL 13 - 18，默认使用 18。下方内容展示如何通过配置文件完成这些选择。</p><hr><h2 id=大版本与软件包>大版本与软件包</h2><ul><li><code>pg_version</code>：指定 PostgreSQL 主版本（默认 18）。Pigsty 会根据版本自动映射到正确的包名前缀。</li><li><code>pg_packages</code>：定义需要安装的核心包集合，支持使用 <a href=/docs/pgsql/config/alias>包别名</a>（默认 <code>pgsql-main pgsql-common</code>，包含内核 + patroni/pgbouncer/pgbackrest 等常用工具）。</li><li><code>pg_extensions</code>：额外需要安装的扩展包列表，同样支持别名；缺省为空表示只装核心依赖。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main pgsql-common ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector, pgml ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：Ansible 在安装阶段会拉取与 <code>pg_version=18</code> 对应的包，将扩展预装到系统中，随后数据库初始化脚本即可直接 <code>CREATE EXTENSION</code>。</p></blockquote><p>Pigsty 的离线仓库中不同版本的扩展支持范围不同：13 可用扩展相对较少，17/18 覆盖最广。若某扩展未预打包，可通过 <code>repo_packages_extra</code> 追加。</p><hr><h2 id=内核模式pg_mode>内核模式（pg_mode）</h2><p><code>pg_mode</code> 控制要部署的内核“风味”，默认 <code>pgsql</code> 表示标准 PostgreSQL。Pigsty 目前支持以下模式：</p><table class=full-width><thead><tr><th>模式</th><th>场景</th></tr></thead><tbody><tr><td><code>pgsql</code></td><td>标准 PostgreSQL，高可用 + 复制</td></tr><tr><td><code>citus</code></td><td>Citus 分布式集群，需要额外的 <code>pg_shard / pg_group</code></td></tr><tr><td><code>gpsql</code></td><td>Greenplum / MatrixDB</td></tr><tr><td><code>mssql</code></td><td>Babelfish for PostgreSQL</td></tr><tr><td><code>mysql</code></td><td>OpenGauss/HaloDB 兼容 MySQL 协议</td></tr><tr><td><code>polar</code></td><td>阿里 PolarDB（基于 pg <code>polar</code> 发行）</td></tr><tr><td><code>ivory</code></td><td>IvorySQL（Oracle 兼容语法）</td></tr><tr><td><code>oriole</code></td><td>OrioleDB 存储引擎</td></tr><tr><td><code>oracle</code></td><td>PostgreSQL + ora 兼容（<code>pg_mode: oracle</code>）</td></tr></tbody></table><p>选择模式后，Pigsty 会自动加载对应的模板、依赖包与 Patroni 配置。以部署 Citus 为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus0</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus0, pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-citus1</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster: pg-citus1, pg_group</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>patroni_citus_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：所有成员会安装 Citus 相关包，Patroni 以分片模式写入 etcd，并自动在 <code>meta</code> 数据库内 <code>CREATE EXTENSION citus</code>。</p></blockquote><hr><h2 id=扩展与预置对象>扩展与预置对象</h2><p>除了系统包，你还可以通过以下参数控制数据库启动后自动加载的组件：</p><ul><li><code>pg_libs</code>：写入 <code>shared_preload_libraries</code> 的列表。例如 <code>pg_libs: 'timescaledb, pg_stat_statements, auto_explain'</code>。</li><li><code>pg_default_extensions</code> / <code>pg_default_schemas</code>：控制初始化脚本对 <code>template1</code> 与 <code>postgres</code> 预创建的 schema、扩展。</li><li><code>pg_parameters</code>：为所有实例附加 <code>ALTER SYSTEM SET</code>（写入 <code>postgresql.auto.conf</code>）。</li></ul><p>示例：启用 TimescaleDB、pgvector 并自定义一些系统参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-analytics</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, pgml&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_default_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>timescaledb.max_background_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;&#39;timescaledb,pg_stat_statements,pgml&#39;&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：初始化时 <code>template1</code> 会创建扩展、Patroni 的 <code>postgresql.conf</code> 注入对应参数，所有业务库继承这些设置。</p></blockquote><hr><h2 id=调优模板-pg_conf>调优模板 (<code>pg_conf</code>)</h2><p><code>pg_conf</code> 指向 <code>roles/pgsql/templates/*.yml</code> 中的 Patroni 模板。Pigsty内置四套通用模板：</p><table class=full-width><thead><tr><th>模板</th><th>适用场景</th></tr></thead><tbody><tr><td><code>oltp.yml</code></td><td>默认模板，面向 4–128 核的 TP 负载</td></tr><tr><td><code>olap.yml</code></td><td>针对分析场景优化</td></tr><tr><td><code>crit.yml</code></td><td>强调同步提交/最小延迟，适合金融等零丢失场景</td></tr><tr><td><code>tiny.yml</code></td><td>轻量机 / 边缘场景 / 资源受限环境</td></tr></tbody></table><p>你可以直接替换模板或自定义一个 YAML 文件放在 <code>templates/</code> 下，然后在集群 <code>vars</code> 里指定。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-ledger</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.21</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-ledger</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>crit.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>synchronous_commit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;remote_apply&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>max_wal_senders</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>16</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>wal_keep_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2GB&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：拷贝 <code>crit.yml</code> 作为 Patroni 配置，叠加 <code>pg_parameters</code> 写入 <code>postgresql.auto.conf</code>，使实例立即以同步提交模式运行。</p></blockquote><hr><h2 id=组合实例一个完整示例>组合实例：一个完整示例</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-rag</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.31</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.32</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-rag</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_conf</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olap.yml</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql-main pgsql-common ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, pgml, postgis ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_stat_statements, pgvector, pgml&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>max_parallel_workers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>shared_buffers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;32GB&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>第一台主库 + 一台 replica，使用 <code>olap.yml</code> 调优。</li><li>安装 PG18 + RAG 常用扩展，自动在系统级加载 <code>pgvector/pgml</code>。</li><li>Patroni/pgbouncer/pgbackrest 由 Pigsty 生成，无需手工干预。</li></ul><p>根据业务需要替换上述参数即可完成内核层的全部定制。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ad5d6482cea01b850636a3033b3ec973>3 - 别名翻译</h1><div class=lead>Pigsty 提供软件包别名翻译机制，可以屏蔽底层操作系统的二进制包细节差异，让安装更简易。</div><p>PostgreSQL 在不同操作系统上的软件包命名规则存在显著差异：</p><ul><li><strong>EL 系统</strong>（RHEL/Rocky/Alma/&mldr;）使用 <code>pgvector_17</code>，<code>postgis36_17*</code> 这样的格式</li><li><strong>Debian/Ubuntu 系统</strong>使用 <code>postgresql-17-pgvector</code>，<code>postgresql-17-postgis-3</code> 这样的格式</li></ul><p>这种差异给用户带来了额外的认知负担：您需要记住不同系统的包名规则，还要处理 PostgreSQL 版本号嵌入的问题。</p><h2 id=软件包别名>软件包别名</h2><p>Pigsty 通过 <strong>软件包别名（Package Alias）</strong> 机制解决了这个问题：您只需使用统一的别名，Pigsty 会处理好所有细节：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用别名 —— 简单、统一、跨平台</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, pgvector, timescaledb ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 等效于 EL9 + PG17 上的实际包名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis36_17*, pgvector_17*, timescaledb-tsl_17* ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 等效于 Ubuntu 24 + PG17 上的实际包名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgresql-17-postgis-3, postgresql-17-pgvector, postgresql-17-timescaledb-tsl ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h2 id=别名翻译>别名翻译</h2><p>别名还可以将一组软件包归类为一个整体，例如 Pigsty 默认安装的软件包 —— <a href=/docs/pgsql/param#pg_packages><strong><code>pg_packages</code></strong></a> 的默认值是：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># pg packages to be installed, alias can be used</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pgsql-main pgsql-common</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 将查询当前的操作系统别名清单（假设为 <a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el10.x86_64.yml#L105><strong><code>el10.x86_64</code></strong></a>），将其翻译为 PGSQL 内核，扩展，以及工具包：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgsql-main</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>    </span><span style=color:#4e9a06>&#34;postgresql$v postgresql$v-server postgresql$v-libs postgresql$v-contrib postgresql$v-plperl postgresql$v-plpython3 postgresql$v-pltcl postgresql$v-llvmjit pg_repack_$v* wal2json_$v* pgvector_$v*&#34;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgsql-common</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;patroni patroni-etcd pgbouncer pgbackrest pg_exporter pgbackrest_exporter vip-manager&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>接下来，Pigsty 又进一步通过当前指定的 PG 大版本（假设 <a href=/docs/pgsql/param#pg_version><strong><code>pg_version</code></strong></a> = <code>18</code> ），将 <code>pgsql-main</code> 翻译为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg18-main</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>   </span><span style=color:#4e9a06>&#34;postgresql18 postgresql18-server postgresql18-libs postgresql18-contrib postgresql18-plperl postgresql18-plpython3 postgresql18-pltcl postgresql18-llvmjit pg_repack_18* wal2json_18* pgvector_18*&#34;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>通过这种方式，Pigsty 屏蔽了软件包的复杂性，让用户可以简单的指定自己想要的功能组件。</p><hr><h2 id=哪些变量可以使用别名>哪些变量可以使用别名？</h2><p>您可以在以下四个参数中使用包别名，别名会根据翻译流程自动转换为实际的软件包名称：</p><ul><li><a href=/docs/pgsql/param#pg_extensions><strong><code>pg_extensions</code></strong></a> - PG 扩展软件包</li><li><a href=/docs/pgsql/param#pg_extensions><strong><code>pg_packages</code></strong></a> - PG 内核/基础工具软件包</li><li><a href=/docs/infra/param#repo_packages><strong><code>repo_packages</code></strong></a> - 软件包下载参数：下载到本地软件仓库的软件包</li><li><a href=/docs/pgsql/param#pg_extensions><strong><code>repo_packages_extra</code></strong></a> - 扩展安装参数：额外下载到本地软件仓库的软件包</li></ul><hr><h2 id=别名列表>别名列表</h2><p>你可以在 Pigsty 项目源代码的 <a href=https://github.com/pgsty/pigsty/tree/main/roles/node_id/vars><code>roles/node_id/vars/</code></a> 目录下，找到各操作系统与架构对应的别名映射文件：</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el10.x86_64.yml#L85><code>el10.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el10.aarch64.yml#L85><code>el10.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el9.x86_64.yml#L85><code>el9.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el9.aarch64.yml#L85><code>el9.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el8.x86_64.yml#L85><code>el8.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/el8.aarch64.yml#L85><code>el8.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u24.x86_64.yml#L78><code>u24.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u24.aarch64.yml#L78><code>u24.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u22.x86_64.yml#L78><code>u22.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/u22.aarch64.yml#L78><code>u22.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d13.x86_64.yml#L78><code>d13.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d13.aarch64.yml#L78><code>d13.aarch64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d12.x86_64.yml#L78><code>d12.x86_64</code></a></li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/node_id/vars/d12.aarch64.yml#L78><code>d12.aarch64</code></a></li></ul><hr><h2 id=工作原理>工作原理</h2><h3 id=别名翻译流程>别名翻译流程</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>用户配置别名 --&gt; 检测操作系统 --&gt;  查找别名映射表 ---&gt; 替换<span style=color:#000>$v占位符</span> ---&gt; 安装实际软件包
</span></span><span style=display:flex><span>     ↓              ↓               ↓                               ↓
</span></span><span style=display:flex><span>  postgis      el9.x86_64      postgis36_<span style=color:#000>$v</span>*                postgis36_17*
</span></span><span style=display:flex><span>  postgis      u24.x86_64      postgresql-<span style=color:#000>$v</span>-postgis-3      postgresql-17-postgis-3
</span></span></code></pre></div><h3 id=版本占位符>版本占位符</h3><p>Pigsty 的别名系统使用 <code>$v</code> 作为 PostgreSQL 版本号的占位符。当您使用 <a href=/docs/pgsql/param#pg_version><code>pg_version</code></a> 指定了 PostgreSQL 版本后，所有别名中的 <code>$v</code> 都会被替换为实际版本号。</p><p>例如，当 <code>pg_version: 17</code> 时：</p><table class=full-width><thead><tr><th>别名定义 (EL)</th><th>展开结果</th></tr></thead><tbody><tr><td><code>postgresql$v*</code></td><td><code>postgresql17*</code></td></tr><tr><td><code>pgvector_$v*</code></td><td><code>pgvector_17*</code></td></tr><tr><td><code>timescaledb-tsl_$v*</code></td><td><code>timescaledb-tsl_17*</code></td></tr></tbody></table><table class=full-width><thead><tr><th>别名定义 (Debian/Ubuntu)</th><th>展开结果</th></tr></thead><tbody><tr><td><code>postgresql-$v</code></td><td><code>postgresql-17</code></td></tr><tr><td><code>postgresql-$v-pgvector</code></td><td><code>postgresql-17-pgvector</code></td></tr><tr><td><code>postgresql-$v-timescaledb-tsl</code></td><td><code>postgresql-17-timescaledb-tsl</code></td></tr></tbody></table><h3 id=通配符匹配>通配符匹配</h3><p>在 EL 系统上，许多别名使用 <code>*</code> 通配符来匹配相关的子包。例如：</p><ul><li><code>postgis36_17*</code> 会匹配 <code>postgis36_17</code>、<code>postgis36_17-client</code>、<code>postgis36_17-utils</code> 等</li><li><code>postgresql17*</code> 会匹配 <code>postgresql17</code>、<code>postgresql17-server</code>、<code>postgresql17-libs</code>、<code>postgresql17-contrib</code> 等</li></ul><p>这种设计确保您无需逐一列出每个子包，一个别名即可安装完整的扩展。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-f3a29e30e1bcb1622450d4b2d3604bdc>4 - 用户/角色</h1><div class=lead>如何通过配置来定制所需 PostgreSQL 用户与角色？</div><blockquote><p>在本文中，&ldquo;用户&rdquo;（User） 指的是使用 SQL 命令 <code>CREATE USER/ROLE</code> 创建的，数据库集簇内的逻辑对象。</p></blockquote><p>在 PostgreSQL 中，用户直接隶属于数据库集簇而非某个具体的数据库。因此在创建业务数据库和业务用户时，应当遵循"先用户，后数据库"的原则。</p><p>Pigsty 通过两个配置参数定义数据库集群中的角色与用户：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a>：定义全局统一使用的角色和用户</li><li><a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a>：在数据库集群层面定义业务用户和角色</li></ul><p>前者用于定义整套环境中共用的角色与用户，后者定义单个集群中特有的业务角色与用户。二者形式相同，均为用户定义对象的数组。
用户/角色按数组顺序逐一创建，因此后定义的用户可以属于先定义的角色。</p><p>默认情况下，所有带有 <code>pgbouncer: true</code> 标记的用户都会被添加到 <a href=/docs/concept/arch/pgsql#pgbouncer><strong>Pgbouncer</strong></a> 连接池用户列表中。</p><hr><h2 id=定义用户>定义用户</h2><p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的业务用户定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_noco     ,password: DBUser.Noco     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for nocodb service      }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_remove   ,state: absent }  # 使用 state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent 删除用户</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个用户/角色定义都是一个复杂对象，可能包括以下字段，除了 <code>name</code> 字段外，其他字段均为可选字段：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是用户定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>create                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户状态：create（创建，默认）、absent（删除）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，密码，可以是 scram-sha-256 哈希字符串或明文</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，默认为 true，是否可以登录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否是超级用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以创建数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以创建角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，默认为 true，是否自动继承所属角色权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以发起流复制连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是否可以绕过行级安全</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，用户连接数限制，默认 -1 不限制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，从创建时起 N 天后过期（优先级比 expire_at 高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 可选，过期日期，使用 YYYY-MM-DD 格式（优先级没 expire_in 高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户备注信息</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，所属角色数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，角色级配置参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否加入连接池用户列表，默认 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，用户级别的池化模式，默认 transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，用户级别的连接池最大连接数，默认 -1 不限制</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>用户级连接池限额字段统一使用 <code>pool_connlimit</code>（对应 Pgbouncer <code>max_user_connections</code>）。</p></blockquote><hr><h2 id=参数总览>参数总览</h2><p>所有参数中唯一 <strong>必选</strong> 的字段是 <code>name</code>，它应该是当前 PostgreSQL 集群中有效且唯一的用户名，其他参数都有合理的默认值，均为可选项。</p><table class=full-width><thead><tr><th>字段</th><th>分类</th><th>类型</th><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><a href=#name><strong><code>name</code></strong></a></td><td>基本</td><td><code>string</code></td><td>必选</td><td>用户名，必须是有效且唯一的标识符</td></tr><tr><td><a href=#state><strong><code>state</code></strong></a></td><td>基本</td><td><code>enum</code></td><td>可选</td><td>用户状态：<code>create</code>（默认）、<code>absent</code></td></tr><tr><td><a href=#password><strong><code>password</code></strong></a></td><td>基本</td><td><code>string</code></td><td>可变</td><td>用户密码，明文或哈希</td></tr><tr><td><a href=#comment><strong><code>comment</code></strong></a></td><td>基本</td><td><code>string</code></td><td>可变</td><td>用户备注信息</td></tr><tr><td><a href=#login><strong><code>login</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否允许登录，默认 <code>true</code></td></tr><tr><td><a href=#superuser><strong><code>superuser</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否为超级用户，默认 <code>false</code></td></tr><tr><td><a href=#createdb><strong><code>createdb</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否可创建数据库，默认 <code>false</code></td></tr><tr><td><a href=#createrole><strong><code>createrole</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否可创建角色，默认 <code>false</code></td></tr><tr><td><a href=#inherit><strong><code>inherit</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否继承所属角色权限，默认 <code>true</code></td></tr><tr><td><a href=#replication><strong><code>replication</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否可进行复制，默认 <code>false</code></td></tr><tr><td><a href=#bypassrls><strong><code>bypassrls</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否可绕过行级安全，默认 <code>false</code></td></tr><tr><td><a href=#connlimit><strong><code>connlimit</code></strong></a></td><td>权限</td><td><code>int</code></td><td>可变</td><td>连接数限制，<code>-1</code> 表示不限制</td></tr><tr><td><a href=#expire_in><strong><code>expire_in</code></strong></a></td><td>有效期</td><td><code>int</code></td><td>可变</td><td>从当前日期起 N 天后过期（优先级高于 <code>expire_at</code>）</td></tr><tr><td><a href=#expire_at><strong><code>expire_at</code></strong></a></td><td>有效期</td><td><code>string</code></td><td>可变</td><td>过期日期，<code>YYYY-MM-DD</code> 格式</td></tr><tr><td><a href=#roles><strong><code>roles</code></strong></a></td><td>角色</td><td><code>array</code></td><td>增量</td><td>所属角色数组，支持字符串或对象格式</td></tr><tr><td><a href=#parameters><strong><code>parameters</code></strong></a></td><td>参数</td><td><code>object</code></td><td>可变</td><td>角色级参数</td></tr><tr><td><a href=#pgbouncer><strong><code>pgbouncer</code></strong></a></td><td>连接池</td><td><code>bool</code></td><td>可变</td><td>是否加入连接池，默认 <code>false</code></td></tr><tr><td><a href=#pool_mode><strong><code>pool_mode</code></strong></a></td><td>连接池</td><td><code>enum</code></td><td>可变</td><td>池化模式：<code>transaction</code>（默认）</td></tr><tr><td><a href=#pool_connlimit><strong><code>pool_connlimit</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>连接池用户最大连接数</td></tr></tbody></table><hr><h2 id=参数详情>参数详情</h2><h3 id=name><code>name</code></h3><p>字符串，必选参数，表示用户的名称，在一个数据库集群内必须唯一。</p><p>用户名必须是有效的 PostgreSQL 标识符，必须匹配正则表达式 <strong><code>^[a-z_][a-z0-9_]{0,62}$</code></strong>：
以小写字母或下划线开头，只能包含小写字母、数字、下划线，最长 63 个字符。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 标准命名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_readonly      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 下划线分隔</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>_internal         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 下划线开头（用于内部角色）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=state><code>state</code></h3><p>枚举值，用于指定要对用户执行的操作，可以是 <code>create</code> 或 <code>absent</code>，默认值为 <code>create</code>。</p><table class=full-width><thead><tr><th>状态</th><th>说明</th></tr></thead><tbody><tr><td><code>create</code></td><td>默认，创建用户，如果已存在则更新属性</td></tr><tr><td><code>absent</code></td><td>删除用户，使用 <code>DROP ROLE</code></td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># state 默认为 create</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_old</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 删除用户</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>以下系统用户无法通过 <code>state: absent</code> 删除，这是为了防止误删关键系统用户导致集群故障：</p><ul><li><code>postgres</code>：数据库超级用户</li><li><code>replicator</code>：复制用户（或 <a href=/docs/pgsql/param#pg_replication_username><strong><code>pg_replication_username</code></strong></a> 配置的用户）</li><li><code>dbuser_dba</code>：管理员用户（或 <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a> 配置的用户）</li><li><code>dbuser_monitor</code>：监控用户（或 <a href=/docs/pgsql/param#pg_monitor_username><strong><code>pg_monitor_username</code></strong></a> 配置的用户）</li></ul><h3 id=password><code>password</code></h3><p>字符串，可变参数，用于设置用户密码，不指定则用户无法使用密码登录。</p><p>密码可以是以下格式之一：</p><table class=full-width><thead><tr><th>格式</th><th>示例</th><th>说明</th></tr></thead><tbody><tr><td>明文密码</td><td><code>DBUser.Meta</code></td><td>不推荐，会被记录到配置文件和日志</td></tr><tr><td>SCRAM-SHA-256</td><td><code>SCRAM-SHA-256$4096:xxx$yyy:zzz</code></td><td>推荐，PostgreSQL 10+ 默认认证方式</td></tr><tr><td>MD5 哈希</td><td><code>md5...</code></td><td>兼容旧版本，不推荐新项目使用</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 明文密码（不推荐，会被记录到配置和日志中）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>MySecretPassword</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># SCRAM-SHA-256 哈希（推荐）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;SCRAM-SHA-256$4096:xxx$yyy:zzz&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>设置密码时，Pigsty 会临时屏蔽当前会话的日志记录以避免密码泄露：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_statement</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;none&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>PASSWORD</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;xxx&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_statement</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果你不希望在配置文件中记录明文密码，可以使用 <code>SCRAM-SHA-256</code> 哈希字符串代替明文密码。生成 SCRAM-SHA-256 哈希的方法：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 PostgreSQL 生成（需要先连接到数据库，数据库有 pgcrypto 扩展）</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;SELECT encode(digest(&#39;password&#39; || &#39;username&#39;, &#39;sha256&#39;), &#39;hex&#39;)&#34;</span>
</span></span></code></pre></div><h3 id=comment><code>comment</code></h3><p>字符串，可变参数，用于设置用户的备注信息，如果不指定，默认值为 <code>business user {name}</code>。</p><p>用户备注信息通过 <code>COMMENT ON ROLE</code> 语句设置，支持中文和特殊字符（Pigsty 会自动转义单引号）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;业务应用主账号&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;业务应用主账号&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=login><code>login</code></h3><p>布尔值，可变参数，用于控制用户是否可以登录，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 则创建的是无法登陆的 <strong>角色</strong>（Role）而非用户（User），通常用于权限分组。</p><p>在 PostgreSQL 中，<code>CREATE USER</code> 等价于 <code>CREATE ROLE ... LOGIN</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建可登录用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 创建角色（不可登录，用于权限分组）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_custom</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>自定义权限角色</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>LOGIN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_custom&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>NOLOGIN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=superuser><code>superuser</code></h3><p>布尔值，可变参数，用于指定用户是否为超级用户，默认值为 <code>false</code>。</p><p>超级用户拥有数据库的全部权限，可以绕过所有权限检查。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 危险：拥有全部权限</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>SUPERUSER</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 已经提供了默认的超级用户 <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a> （<code>dbuser_dba</code>）
除非绝对必要，否则不应创建额外的超级用户。</p><h3 id=createdb><code>createdb</code></h3><p>布尔值，可变参数，用于指定用户是否可以创建数据库，默认值为 <code>false</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 允许创建数据库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_dev&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CREATEDB</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>一些应用软件可能会要求自己创建数据库，例如 <code>Gitea</code>，<code>Odoo</code> 等，因此您可能需要为这些应用的管理员用户启用 <code>CREATEDB</code> 权限。</p><h3 id=createrole><code>createrole</code></h3><p>布尔值，可变参数，用于指定用户是否可以创建其他角色，默认值为 <code>false</code>。</p><p>拥有 <code>CREATEROLE</code> 权限的用户可以创建、修改、删除其他非超级用户角色。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 允许管理其他角色</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>CREATEROLE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=inherit><code>inherit</code></h3><p>布尔值，可变参数，用于控制用户是否自动继承所属角色的权限，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 时，用户需要通过 <code>SET ROLE</code> 显式切换角色才能使用所属角色的权限。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 自动继承角色权限（默认）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 需要显式切换角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_special&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>NOINHERIT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 用户需要执行 SET ROLE dbrole_admin 才能获得该角色权限（必要但不充分）
</span></span></span></code></pre></div><h3 id=replication><code>replication</code></h3><p>布尔值，可变参数，用于指定用户是否可以发起流复制连接，默认值为 <code>false</code>。</p><p>通常只有复制用户（如 <code>replicator</code>）需要此权限。普通业务用户不应该拥有此权限，除非这是一个逻辑解码订阅者。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 允许流复制连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pg_monitor, dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;replicator&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>REPLICATION</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=bypassrls><code>bypassrls</code></h3><p>布尔值，可变参数，用于指定用户是否可以绕过行级安全（RLS）策略，默认值为 <code>false</code>。</p><p>启用此权限后，用户可以访问所有行，即使表上定义了行级安全策略。此权限通常只授予管理员用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myappadmin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 绕过行级安全策略</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_myappadmin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>BYPASSRLS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=connlimit><code>connlimit</code></h3><p>整数，可变参数，用于限制用户的最大并发连接数，默认值为 <code>-1</code>，表示不限制。</p><p>设置为正整数时，会限制该用户同时建立的最大数据库连接数。此限制不影响超级用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 最多 100 个并发连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_batch</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 批处理用户限制连接数</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=expire_in><code>expire_in</code></h3><p>整数，可变参数，用于指定用户从当前日期起多少天后过期。</p><p>此参数优先级高于 <a href=#expire_at><strong><code>expire_at</code></strong></a>，如果同时指定两者，只有 <code>expire_in</code> 生效。</p><p>每次执行剧本时会根据当前日期重新计算过期时间，适合用于临时用户或需要定期续期的场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 30 天后过期</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>90</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 90 天后过期</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>执行时会计算实际过期日期并生成对应的 SQL：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- expire_in: 30, 假设当前日期为 2025-01-01
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;temp_user&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALID</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UNTIL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-01-31&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=expire_at><code>expire_at</code></h3><p>字符串，可变参数，用于指定用户的过期日期，格式为 <code>YYYY-MM-DD</code> 或特殊值 <code>infinity</code>。</p><p>此参数优先级低于 <a href=#expire_in><strong><code>expire_in</code></strong></a>。使用 <code>infinity</code> 表示用户永不过期。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 指定日期过期</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>permanent_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 永不过期</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;contractor_user&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALID</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UNTIL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;permanent_user&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VALID</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UNTIL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=roles><code>roles</code></h3><p>数组，增量参数，用于定义用户所属的角色。数组元素可以是字符串或对象。</p><p>简单格式使用字符串直接指定角色名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>pg_read_all_data</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_readwrite&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;pg_read_all_data&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>完整格式使用对象定义，支持更精细的角色成员关系控制：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite                           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单字符串：GRANT 角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 带 ADMIN OPTION</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set: false }            # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>不允许 SET ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_signal_backend, inherit: false } # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>不自动继承权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 撤销角色成员关系</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>对象格式参数说明</strong>：</p><table class=full-width><thead><tr><th>参数</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>name</code></td><td>string</td><td>角色名称（必选）</td></tr><tr><td><code>state</code></td><td>enum</td><td><code>grant</code>（默认）或 <code>absent</code>/<code>revoke</code>：控制授予或撤销</td></tr><tr><td><code>admin</code></td><td>bool</td><td><code>true</code>：WITH ADMIN OPTION，<code>false</code>：REVOKE ADMIN</td></tr><tr><td><code>set</code></td><td>bool</td><td>PG16+：<code>true</code>：WITH SET TRUE，<code>false</code>：REVOKE SET</td></tr><tr><td><code>inherit</code></td><td>bool</td><td>PG16+：<code>true</code>：WITH INHERIT TRUE，<code>false</code>：REVOKE INHERIT</td></tr></tbody></table><p><strong>PostgreSQL 16+ 新特性</strong>：</p><p>PostgreSQL 16 引入了更细粒度的角色成员关系控制：</p><ul><li><strong>ADMIN OPTION</strong>：允许将角色授予其他用户</li><li><strong>SET OPTION</strong>：允许使用 <code>SET ROLE</code> 切换到该角色</li><li><strong>INHERIT OPTION</strong>：是否自动继承该角色的权限</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PostgreSQL 16+ 完整示例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 普通成员关系</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 可以将 dbrole_admin 授予其他用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 不能 SET ROLE 到 pg_monitor（只能通过继承使用权限）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 不自动继承 pg_execute_server_program 的权限（需要显式 SET ROLE）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_execute_server_program, inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 撤销 old_role 的成员关系</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>set</code> 和 <code>inherit</code> 选项仅在 PostgreSQL 16+ 中有效，在早期版本会被忽略并在生成的 SQL 中添加警告注释。</p><h3 id=parameters><code>parameters</code></h3><p>对象，可变参数，用于设置角色级别的配置参数。参数通过 <code>ALTER ROLE ... SET</code> 设置，会对该用户的所有会话生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;search_path&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;log_statement&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用特殊值 <code>DEFAULT</code>（大小写不敏感）可以将参数重置为 PostgreSQL 默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 设置新值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>常用角色级参数：</p><table class=full-width><thead><tr><th>参数</th><th>说明</th><th>示例值</th></tr></thead><tbody><tr><td><code>work_mem</code></td><td>查询工作内存</td><td><code>'64MB'</code></td></tr><tr><td><code>statement_timeout</code></td><td>语句超时时间</td><td><code>'30s'</code></td></tr><tr><td><code>lock_timeout</code></td><td>锁等待超时</td><td><code>'10s'</code></td></tr><tr><td><code>idle_in_transaction_session_timeout</code></td><td>空闲事务超时</td><td><code>'10min'</code></td></tr><tr><td><code>search_path</code></td><td>Schema 搜索路径</td><td><code>'app,public'</code></td></tr><tr><td><code>log_statement</code></td><td>日志记录级别</td><td><code>'ddl'</code></td></tr><tr><td><code>temp_file_limit</code></td><td>临时文件大小限制</td><td><code>'10GB'</code></td></tr></tbody></table><p>您可以从数据库的 <a href=https://www.postgresql.org/docs/current/view-pg-db-role-setting.html><strong><code>pg_db_role_setting</code></strong></a> 系统视图查询用户级别的参数设置。</p><h3 id=pgbouncer><code>pgbouncer</code></h3><p>布尔值，可变参数，用于控制是否将用户添加到 Pgbouncer 连接池用户列表，默认值为 <code>false</code>。</p><p>对于需要通过连接池访问数据库的生产用户，必须显式设置 <code>pgbouncer: true</code>。
默认为 <code>false</code> 是为了避免意外将内部用户暴露给连接池。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 生产用户：需要连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 内部用户：不需要连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 默认值，可省略</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>设置 <code>pgbouncer: true</code> 的用户会被添加到 <code>/etc/pgbouncer/userlist.txt</code> 文件中。</p><h3 id=pool_mode><code>pool_mode</code></h3><p>枚举值，可变参数，用于设置用户级别的池化模式，可选值为 <code>transaction</code>、<code>session</code> 或 <code>statement</code>，默认值为 <code>transaction</code>。</p><table class=full-width><thead><tr><th>模式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>transaction</code></td><td>事务结束后归还连接</td><td>大多数 OLTP 应用，默认推荐</td></tr><tr><td><code>session</code></td><td>会话结束后归还连接</td><td>需要会话状态的应用（如 SET 命令）</td></tr><tr><td><code>statement</code></td><td>每条语句后归还连接</td><td>简单无状态查询，极致复用</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># DBA 用户使用 session 模式（可能需要 SET 命令等会话状态）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 普通业务用户使用 transaction 模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>用户级别的连接池参数通过 <code>/etc/pgbouncer/useropts.txt</code> 文件配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><h3 id=pool_connlimit><code>pool_connlimit</code></h3><p>整数，可变参数，用于设置用户级别的连接池最大连接数，默认值为 <code>-1</code>，表示不限制。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 此用户最多使用 50 个连接池连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=acl-系统>ACL 系统</h2><p>Pigsty 提供了一套内置的、开箱即用的访问控制 / <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7><strong>ACL</strong></a> 系统，您只需将以下四个默认角色分配给业务用户即可轻松使用：</p><table class=full-width><thead><tr><th>角色</th><th>权限说明</th><th>典型使用场景</th></tr></thead><tbody><tr><td><code>dbrole_readwrite</code></td><td>全局读写访问</td><td>主属业务的生产账号</td></tr><tr><td><code>dbrole_readonly</code></td><td>全局只读访问</td><td>其他业务的只读访问</td></tr><tr><td><code>dbrole_admin</code></td><td>拥有 DDL 权限</td><td>业务管理员，需要建表的场景</td></tr><tr><td><code>dbrole_offline</code></td><td>受限只读访问（仅离线实例）</td><td>个人用户，ETL/分析任务</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 典型业务用户配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产账号，读写权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 只读账号</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 管理员，可执行 DDL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_etl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.ETL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_offline]     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 离线分析账号</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果您希望重新设计您自己的 ACL 系统，可以考虑定制以下参数和模板：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a>：系统范围的角色和全局用户</li><li><a href=/docs/pgsql/param#pg_default_privileges><strong><code>pg_default_privileges</code></strong></a>：新建对象的默认权限</li><li><a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-role.sql><strong><code>pg-init-role.sql</code></strong></a>：角色创建 SQL 模板</li><li><a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><strong><code>pg-init-template.sql</code></strong></a>：权限 SQL 模板</li></ul><hr><h2 id=pgbouncer-用户>Pgbouncer 用户</h2><p>默认情况下启用 Pgbouncer 作为连接池中间件。Pigsty 默认将 <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> 中显式带有 <code>pgbouncer: true</code> 标志的所有用户添加到 Pgbouncer 用户列表中。</p><p>Pgbouncer 连接池中的用户在 <code>/etc/pgbouncer/userlist.txt</code> 中列出：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>&#34;postgres&#34; &#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_wiki&#34; &#34;SCRAM-SHA-256$4096:+77dyhrPeFDT/TptHs7/7Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$KeatuohpKIYzHPCt/tqBu85vI11o9mar/by0hHYM2W8=:X9gig4JtjoS8Y/o1vQsIX/gY1Fns8ynTXkbWOjUfbRQ=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_view&#34; &#34;SCRAM-SHA-256$4096:DFoZHU/DXsHL8MJ8regdEw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$gx9sUGgpVpdSM4o6A2R9PKAUkAsRPLhLoBDLBUYtKS0=:MujSgKe6rxcIUMv4GnyXJmV0YNbf39uFRZv724+X1FE=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_monitor&#34; &#34;SCRAM-SHA-256$4096:fwU97ZMO/KR0ScHO5+UuBg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$CrNsmGrx1DkIGrtrD1Wjexb/aygzqQdirTO1oBZROPY=:L8+dJ+fqlMQh7y4PmVR/gbAOvYWOr+KINjeMZ8LlFww=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_meta&#34; &#34;SCRAM-SHA-256$4096:leB2RQPcw1OIiRnPnOMUEg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$eyC+NIMKeoTxshJu314+BmbMFpCcspzI3UFZ1RYfNyU=:fJgXcykVPvOfro2MWNkl5q38oz21nSl1dTtM65uYR1Q=&#34;</span>
</span></span></code></pre></div><p>用户级别的连接池参数使用另一个单独的文件 <code>/etc/pgbouncer/useropts.txt</code> 进行维护：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>      <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><p>当您 <a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7><strong>创建用户</strong></a> 时，Pgbouncer 的用户列表定义文件将会被刷新，并通过在线重载配置的方式生效，不会影响现有的连接。</p><p>Pgbouncer 使用和 PostgreSQL 相同的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户。您可以使用 <code>pgb</code> 别名，使用 dbsu 访问 Pgbouncer 管理功能。</p><p><a href=/docs/pgsql/param#pgbouncer_auth_query><strong><code>pgbouncer_auth_query</code></strong></a> 参数允许您使用动态查询来完成连接池用户认证，当您不想手动管理连接池中的用户时，这是一种便捷的方案。</p><hr><h2 id=相关资源>相关资源</h2><p>关于用户管理操作，请参考 <a href=/docs/pgsql/admin/user><strong>用户管理</strong></a> 一节。</p><p>关于用户的访问权限，请参考 <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7><strong>ACL：角色权限</strong></a> 一节。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-662c4a4a95a52da3073eeed2f4407af9>5 - 数据库</h1><div class=lead>如何通过配置来定制所需 PostgreSQL 数据库？</div><blockquote><p>在本文中，“数据库”（Database） 指的是使用 SQL 命令 <code>CREATE DATABASE</code> 创建的，数据库集簇内的逻辑对象。</p></blockquote><p>一组 PostgreSQL 服务器可以同时服务于多个 <strong>数据库</strong> （Database）。在 Pigsty 中，你可以在集群配置中 <a href=#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93><strong>定义</strong></a> 好所需的数据库。</p><p>Pigsty会对默认模板数据库<code>template1</code>进行修改与定制，创建默认模式，安装默认扩展，配置默认权限，新创建的数据库默认会从<code>template1</code>继承这些设置。
您也可以通过 <a href=#template><strong><code>template</code></strong></a> 参数指定其他模板数据库，实现瞬间 <a href=/docs/pgsql/admin/db#%E5%85%8B%E9%9A%86%E6%95%B0%E6%8D%AE%E5%BA%93><strong>数据库克隆</strong></a>。</p><p>默认情况下，所有业务数据库都会被 1:1 添加到 <a href=/docs/concept/arch/pgsql#pgbouncer><strong>Pgbouncer</strong></a> <a href=#%E8%BF%9E%E6%8E%A5%E6%B1%A0><strong>连接池</strong></a> 中；<a href=/docs/concept/arch/pgsql#pg_exporter><strong><code>pg_exporter</code></strong></a> 默认会通过 <strong>自动发现</strong> 机制查找所有业务数据库并进行库内对象监控。
所有数据库也会添加到所有 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA节点</strong></a> 上的 <a href=/docs/concept/arch/infra#grafana><strong>Grafana</strong></a> 中，
注册为 PostgreSQL 数据源供 PGCAT 监控面板使用。</p><hr><h2 id=定义数据库>定义数据库</h2><p>业务数据库定义在数据库集群参数 <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> 中，这是一个数据库定义构成的对象数组。
在集群初始化时，数组内的数据库按照 <strong>定义顺序</strong> 依次创建，因此后面定义的数据库可以使用先前定义的数据库作为<strong>模板</strong>。</p><p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的数据库定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: noco     ,owner: dbuser_noco     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>nocodb database }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个数据库定义都是一个复杂对象，可能包括以下字段，除了 <code>name</code> 字段外，其他字段均为可选字段：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是数据库定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>create                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库状态：create（创建，默认）、absent（删除）、recreate（重建）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库 sql 的基线定义文件路径（ansible 搜索路径中的相对路径，如 files/）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库添加到 pgbouncer 数据库列表？默认为 true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要创建的附加模式，由模式名称字符串组成的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，要安装的附加扩展： 扩展对象的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可以指定将扩展安装到某个模式中，也可以不指定（不指定则安装到 search_path 首位模式中）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 例如有的扩展会创建并使用固定的模式，就不需要指定模式。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库的说明与备注信息</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库所有者，不指定则为当前用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要使用的模板，默认为 template1，目标必须是一个模板数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，克隆策略：FILE_COPY 或 WAL_LOG（PG15+），不指定使用 PG 默认</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（UTF8）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（C）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（C）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，不指定则继承模板/集群配置（C）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>libc          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，本地化提供者：libc、icu、builtin（PG15+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，ICU 本地化规则（PG15+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，ICU 排序规则（PG16+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，内置本地化提供者规则（PG17+）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认表空间，默认为 &#39;pg_default&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>is_template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，是否标记为模板数据库，允许任何有 CREATEDB 权限的用户克隆</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库注册到 grafana 数据源？默认为 true，显式设置为 false 会跳过注册</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库连接限制，默认为 -1 ，不限制，设置为正整数则会限制连接数。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，数据库级参数，通过 ALTER DATABASE SET 设置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;64MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，连接到此 pgbouncer 数据库的所有连接都将使用此用户进行验证（启用 pgbouncer_auth_query 才有用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池化模式，默认为 transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 默认池子大小，默认为 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池子保留空间，默认为 32，当默认池子不够用时，最多再申请这么多条突发连接。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池的最小大小，默认为 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的最大数据库连接数，默认为 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>自 Pigsty <code>v4.1.0</code> 起，数据库连接池参数统一使用 <code>pool_reserve</code> 与 <code>pool_connlimit</code>，旧别名 <code>pool_size_reserve</code> / <code>pool_max_db_conn</code> 已收敛。</p></blockquote><hr><h2 id=参数总览>参数总览</h2><p>所有参数中唯一 <strong>必选</strong> 的字段是 <code>name</code>，它应该是当前 PostgreSQL 集群中有效且唯一的数据库名称，其他参数都有合理的默认值，均为可选项。
带有 “<strong>不可变</strong>” 标记的参数仅在数据库创建时生效，创建后无法修改，若需更改则必须删除并重建数据库。</p><table class=full-width><thead><tr><th>字段</th><th>分类</th><th>类型</th><th>属性</th><th>说明</th></tr></thead><tbody><tr><td><a href=#name><strong><code>name</code></strong></a></td><td>基本</td><td><code>string</code></td><td>必选</td><td>数据库名称，必须是有效且唯一的标识符</td></tr><tr><td><a href=#state><strong><code>state</code></strong></a></td><td>基本</td><td><code>enum</code></td><td>可选</td><td>数据库状态：<code>create</code>（默认）、<code>absent</code>、<code>recreate</code></td></tr><tr><td><a href=#owner><strong><code>owner</code></strong></a></td><td>基本</td><td><code>string</code></td><td>可变</td><td>数据库属主，不指定则为 <code>postgres</code></td></tr><tr><td><a href=#comment><strong><code>comment</code></strong></a></td><td>基本</td><td><code>string</code></td><td>可变</td><td>数据库备注信息</td></tr><tr><td><a href=#template><strong><code>template</code></strong></a></td><td>模板</td><td><code>string</code></td><td>不可变</td><td>创建时使用的模板数据库，默认 <code>template1</code></td></tr><tr><td><a href=#strategy><strong><code>strategy</code></strong></a></td><td>模板</td><td><code>enum</code></td><td>不可变</td><td>克隆策略：<code>FILE_COPY</code> 或 <code>WAL_LOG</code>（PG15+）</td></tr><tr><td><a href=#encoding><strong><code>encoding</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>字符编码，默认继承模板（<code>UTF8</code>）</td></tr><tr><td><a href=#locale><strong><code>locale</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>本地化规则，默认继承模板（<code>C</code>）</td></tr><tr><td><a href=#lc_collate><strong><code>lc_collate</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>排序规则，默认继承模板（<code>C</code>）</td></tr><tr><td><a href=#lc_ctype><strong><code>lc_ctype</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>字符分类，默认继承模板（<code>C</code>）</td></tr><tr><td><a href=#locale_provider><strong><code>locale_provider</code></strong></a></td><td>编码</td><td><code>enum</code></td><td>不可变</td><td>本地化提供者：<code>libc</code>、<code>icu</code>、<code>builtin</code>（PG15+）</td></tr><tr><td><a href=#icu_locale><strong><code>icu_locale</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>ICU 本地化规则（PG15+）</td></tr><tr><td><a href=#icu_rules><strong><code>icu_rules</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>ICU 排序定制规则（PG16+）</td></tr><tr><td><a href=#builtin_locale><strong><code>builtin_locale</code></strong></a></td><td>编码</td><td><code>string</code></td><td>不可变</td><td>内置本地化规则（PG17+）</td></tr><tr><td><a href=#tablespace><strong><code>tablespace</code></strong></a></td><td>存储</td><td><code>string</code></td><td>可变</td><td>默认表空间，修改会触发数据迁移</td></tr><tr><td><a href=#is_template><strong><code>is_template</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否标记为模板数据库</td></tr><tr><td><a href=#allowconn><strong><code>allowconn</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否允许连接，默认 <code>true</code></td></tr><tr><td><a href=#revokeconn><strong><code>revokeconn</code></strong></a></td><td>权限</td><td><code>bool</code></td><td>可变</td><td>是否回收 PUBLIC 的 CONNECT 权限</td></tr><tr><td><a href=#connlimit><strong><code>connlimit</code></strong></a></td><td>权限</td><td><code>int</code></td><td>可变</td><td>连接数限制，<code>-1</code> 表示不限制</td></tr><tr><td><a href=#baseline><strong><code>baseline</code></strong></a></td><td>初始化</td><td><code>string</code></td><td>可变</td><td>SQL 基线文件路径，仅首次创建时执行</td></tr><tr><td><a href=#schemas><strong><code>schemas</code></strong></a></td><td>初始化</td><td><code>(string|object)[]</code></td><td>可变</td><td>要创建的模式定义数组</td></tr><tr><td><a href=#extensions><strong><code>extensions</code></strong></a></td><td>初始化</td><td><code>(string|object)[]</code></td><td>可变</td><td>要安装的扩展定义数组</td></tr><tr><td><a href=#parameters><strong><code>parameters</code></strong></a></td><td>初始化</td><td><code>object</code></td><td>可变</td><td>数据库级参数</td></tr><tr><td><a href=#pgbouncer><strong><code>pgbouncer</code></strong></a></td><td>连接池</td><td><code>bool</code></td><td>可变</td><td>是否加入连接池，默认 <code>true</code></td></tr><tr><td><a href=#pool_mode><strong><code>pool_mode</code></strong></a></td><td>连接池</td><td><code>enum</code></td><td>可变</td><td>池化模式：<code>transaction</code>（默认）</td></tr><tr><td><a href=#pool_size><strong><code>pool_size</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>默认池大小，默认 <code>64</code></td></tr><tr><td><a href=#pool_size_min><strong><code>pool_size_min</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>最小池大小，默认 <code>0</code></td></tr><tr><td><a href=#pool_reserve><strong><code>pool_reserve</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>保留池大小，默认 <code>32</code></td></tr><tr><td><a href=#pool_connlimit><strong><code>pool_connlimit</code></strong></a></td><td>连接池</td><td><code>int</code></td><td>可变</td><td>最大数据库连接数，默认 <code>100</code></td></tr><tr><td><a href=#pool_auth_user><strong><code>pool_auth_user</code></strong></a></td><td>连接池</td><td><code>string</code></td><td>可变</td><td>认证查询用户</td></tr><tr><td><a href=#register_datasource><strong><code>register_datasource</code></strong></a></td><td>监控</td><td><code>bool</code></td><td>可变</td><td>是否注册到 Grafana 数据源，默认 <code>true</code></td></tr></tbody></table><hr><h2 id=参数详情>参数详情</h2><h3 id=name><code>name</code></h3><p>字符串，必选参数，表示数据库的名称，在一个数据库集群内集群内必须唯一。</p><p>数据库名称必须是有效的 PostgreSQL 标识符，长度不超过 63 个字符，不得使用 SQL 关键字，
形式上以字母或下划线开头，后续字符可以是字母、数字或下划线，不能包含空格或特殊字符。
形式应当满足正则表达式：<strong><code>^[A-Za-z_][A-Za-z0-9_$]{0,62}$</code></strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单命名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>my_application    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 下划线分隔</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_v2            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 包含版本号</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=state><code>state</code></h3><p>枚举值，用于指定要对数据库执行的操作，可以是 <code>create</code>、<code>absent</code> 或 <code>recreate</code>，默认值为 <code>create</code>。</p><table class=full-width><thead><tr><th>状态</th><th>说明</th></tr></thead><tbody><tr><td><code>create</code></td><td>默认，创建或修改数据库，如果已经存在，则将可变参数调整到描述的状态</td></tr><tr><td><code>absent</code></td><td>删除数据库，使用 <code>DROP DATABASE WITH (FORCE)</code></td></tr><tr><td><code>recreate</code></td><td>先删除再创建，用于重置数据库</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># state 默认为 create</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olddb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 删除数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>testdb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>recreate           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重建数据库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=owner><code>owner</code></h3><p>字符串，指定数据库的属主用户，默认不指定，不指定则为数据库 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a>，即 <code>postgres</code> 用户。</p><p>要指定数据库的 <code>owner</code>，被指定的用户必须已存在。修改 owner 会执行：旧 Owner 在数据库上的权限不会被撤回。</p><p>数据库属主具有对数据库的完全控制权限，包括创建模式、表、扩展等对象的权限，对于多租户场景尤为有用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>OWNER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;new_owner&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>GRANT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;new_owner&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=comment><code>comment</code></h3><p>字符串，用于设置数据库的备注信息，如果不指定，默认值为 <code>business database {name}</code>。</p><p>数据库备注信息通过 <code>COMMENT ON DATABASE</code> 语句设置，支持中文和特殊字符（Pigsty 会自动转义单引号）。
备注信息会存储在系统目录 <code>pg_database.datacl</code> 中，可以通过 <code>\l+</code> 命令查看。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>COMMENT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;我的应用主数据库&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>我的应用主数据库</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=template><code>template</code></h3><p>字符串，<strong>不可变参数</strong>，用于指定创建数据库时使用的模板数据库，默认值为 <code>template1</code>。</p><p>PostgreSQL 的 <code>CREATE DATABASE</code> 本质上是对模板数据库进行复制，新数据库会继承模板中的所有对象、扩展、模式、权限设置等。
Pigsty 会在集群初始化阶段对 <code>template1</code> 进行定制配置，因此新建数据库默认会继承这些设置。</p><table class=full-width><thead><tr><th>模板</th><th>说明</th></tr></thead><tbody><tr><td><code>template1</code></td><td>默认模板，包含 Pigsty 预配置的扩展、模式和权限设置</td></tr><tr><td><code>template0</code></td><td>干净模板，使用不同于集群默认的本地化提供者时，必须使用此模板</td></tr><tr><td>自定义数据库</td><td>可以使用已有数据库作为模板进行克隆</td></tr></tbody></table><p>使用 <code>icu</code> 或 <code>builtin</code> 本地化提供者时，必须指定 <code>template: template0</code>，因为 <code>template1</code> 已有本地化设置无法覆盖。
使用其他</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用 ICU 时必须指定 template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zh-Hans</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用 <code>template0</code> 时，监控所需的扩展与 Schema，以及角色的默认权限都不再自动创建，这允许你从一个完全干净的模板开始定制数据库。</p><h3 id=strategy><code>strategy</code></h3><p>枚举值，不可变参数，用于指定从模板克隆数据库的策略，可选值为 <code>FILE_COPY</code> 或 <code>WAL_LOG</code>，此参数在 PostgreSQL 15 及以上版本可用。</p><table class=full-width><thead><tr><th>策略</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>FILE_COPY</code></td><td>直接复制数据文件，PG15+ 默认</td><td>大模板，通用场景</td></tr><tr><td><code>WAL_LOG</code></td><td>通过 WAL 日志记录复制</td><td>小模板，不阻塞模板上的连接</td></tr></tbody></table><p><code>WAL_LOG</code> 策略的优势是复制过程中不会阻塞模板数据库上的连接，但对于较大的模板效率不如 <code>FILE_COPY</code>。
在 PostgreSQL 14 及更早版本中，此参数会被忽略。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cloned_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>source_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>WAL_LOG         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用 WAL 日志方式克隆</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=encoding><code>encoding</code></h3><p>字符串，不可变参数，用于指定数据库的字符编码，如果不指定则继承模板数据库的编码设置，通常为 <code>UTF8</code>。</p><p>如果没有特殊原因，强烈建议使用 <code>UTF8</code> 编码。字符编码在数据库创建后无法修改，如需更改必须重建数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>legacy_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指定非默认编码时使用 template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>LATIN1</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=locale><code>locale</code></h3><p>字符串，不可变参数，用于指定数据库的本地化规则，相当于同时设置 <code>lc_collate</code> 和 <code>lc_ctype</code>，如果不指定则继承模板数据库的设置，通常为 <code>C</code>。</p><p>本地化规则决定了字符串的排序顺序和字符分类行为。使用 <code>C</code> 或 <code>POSIX</code> 可获得最佳性能和跨平台一致性，
使用特定语言的本地化规则（如 <code>zh_CN.UTF-8</code>）可以获得符合该语言习惯的排序结果。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>chinese_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zh_CN.UTF-8       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 中文本地化</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=lc_collate><code>lc_collate</code></h3><p>字符串，不可变参数，用于指定字符串的排序规则，如果不指定则继承模板数据库的设置，通常为 <code>C</code>。</p><p>排序规则决定了 <code>ORDER BY</code> 和比较操作的结果。常用值包括：<code>C</code>（字节序，最快）、<code>C.UTF-8</code>、<code>en_US.UTF-8</code>、<code>zh_CN.UTF-8</code>。
此参数在数据库创建后无法修改。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en_US.UTF-8   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 英文排序规则</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en_US.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=lc_ctype><code>lc_ctype</code></h3><p>字符串，不可变参数，用于指定字符分类规则，决定字符的大小写、数字、字母等分类，如果不指定则继承模板数据库的设置，通常为 <code>C</code>。</p><p>字符分类规则影响 <code>upper()</code>、<code>lower()</code>、正则表达式中的 <code>\w</code> 等函数的行为。此参数在数据库创建后无法修改。</p><h3 id=locale_provider><code>locale_provider</code></h3><p>枚举值，不可变参数，用于指定本地化的实现提供者，可选值为 <code>libc</code>、<code>icu</code> 或 <code>builtin</code>，此参数在 PostgreSQL 15 及以上版本可用，默认值为 <code>libc</code>。</p><table class=full-width><thead><tr><th>提供者</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td><code>libc</code></td><td>-</td><td>使用操作系统 C 库，传统默认方式，行为因系统而异</td></tr><tr><td><code>icu</code></td><td>PG15+</td><td>使用 ICU 库，跨平台一致，支持更多语言</td></tr><tr><td><code>builtin</code></td><td>PG17+</td><td>PostgreSQL 内置实现，最高效，仅支持 C/C.UTF-8</td></tr></tbody></table><p>使用 <code>icu</code> 或 <code>builtin</code> 提供者时，必须指定 <code>template: template0</code>，并配合相应的 <code>icu_locale</code> 或 <code>builtin_locale</code> 参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>fast_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>builtin  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用内置提供者，最高效</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=icu_locale><code>icu_locale</code></h3><p>字符串，不可变参数，用于指定 ICU 本地化规则标识符，此参数在 PostgreSQL 15 及以上版本、且 <code>locale_provider</code> 为 <code>icu</code> 时可用。</p><p>ICU 本地化标识符遵循 BCP 47 标准，常用值包括：</p><table class=full-width><thead><tr><th>值</th><th>说明</th></tr></thead><tbody><tr><td><code>en-US</code></td><td>美式英语</td></tr><tr><td><code>en-GB</code></td><td>英式英语</td></tr><tr><td><code>zh-Hans</code></td><td>简体中文</td></tr><tr><td><code>zh-Hant</code></td><td>繁体中文</td></tr><tr><td><code>ja-JP</code></td><td>日语</td></tr><tr><td><code>ko-KR</code></td><td>韩语</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>chinese_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>zh-Hans       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简体中文 ICU 排序</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=icu_rules><code>icu_rules</code></h3><p>字符串，不可变参数，用于自定义 ICU 排序规则，此参数在 PostgreSQL 16 及以上版本可用。</p><p>ICU 规则允许对默认排序行为进行微调，使用 <a href=https://unicode-org.github.io/icu/userguide/collation/customization/><strong>ICU 排序规则语法</strong></a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom_sort_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&amp;V &lt;&lt; w &lt;&lt;&lt; W&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 自定义 V/W 排序顺序</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=builtin_locale><code>builtin_locale</code></h3><p>字符串，不可变参数，用于指定内置本地化提供者的规则，此参数在 PostgreSQL 17 及以上版本、且 <code>locale_provider</code> 为 <code>builtin</code> 时可用，可选值为 <code>C</code> 或 <code>C.UTF-8</code>。</p><p><code>builtin</code> 提供者是 PostgreSQL 17 新增的内置本地化实现，比 <code>libc</code> 更快，且行为跨平台完全一致。
适合只需要 <code>C</code> 或 <code>C.UTF-8</code> 排序规则的场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>fast_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>builtin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 内置 UTF-8 支持</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=tablespace><code>tablespace</code></h3><p>字符串，可变参数，用于指定数据库的默认表空间，默认值为 <code>pg_default</code>。</p><p>修改现有数据库的表空间会触发数据物理迁移，PostgreSQL 会将数据库中的所有对象移动到新表空间，对于大数据库可能需要较长时间，慎用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>archive_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>slow_hdd      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 归档数据使用慢速存储</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;archive_db&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>TABLESPACE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;slow_hdd&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=is_template><code>is_template</code></h3><p>布尔值，可变参数，用于指定是否将数据库标记为模板数据库，默认值为 <code>false</code>。</p><p>设置为 <code>true</code> 后，任何拥有 <code>CREATEDB</code> 权限的用户都可以使用此数据库作为模板克隆新数据库。
模板数据库通常用于预装标准模式、扩展和数据，方便快速创建具有相同配置的新数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_template</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>is_template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 标记为模板，允许普通用户克隆</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>core, api]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>postgis, pg_trgm]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>删除标记为 <code>is_template: true</code> 的数据库时，Pigsty 会先执行 <code>ALTER DATABASE ... IS_TEMPLATE false</code> 取消模板标记，然后再删除。</p><h3 id=allowconn><code>allowconn</code></h3><p>布尔值，可变参数，用于控制是否允许连接到此数据库，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 会在数据库层面完全禁止连接，任何用户（包括超级用户）都无法连接到此数据库。
此参数通常用于维护或归档用途。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>archive_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 禁止任何连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;archive_db&#34;</span><span style=color:#f8f8f8> </span><span style=color:#000>ALLOW_CONNECTIONS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=revokeconn><code>revokeconn</code></h3><p>布尔值，可变参数，用于控制是否回收 PUBLIC 角色的 <code>CONNECT</code> 权限，默认值为 <code>false</code>。</p><p>设置为 <code>true</code> 时，Pigsty 会执行以下权限变更：</p><ul><li>回收 PUBLIC 的 CONNECT 权限，普通用户将无法连接</li><li>授予复制用户（<code>replicator</code>）和监控用户（<code>dbuser_monitor</code>）连接权限</li><li>授予管理员用户（<code>dbuser_dba</code>）和数据库属主连接权限，并附带 <code>WITH GRANT OPTION</code></li></ul><p>设置为 <code>false</code> 时，会恢复 PUBLIC 的 CONNECT 权限。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>secure_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_secure</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 回收公共连接权限，只有指定用户可连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=connlimit><code>connlimit</code></h3><p>整数，可变参数，用于限制数据库的最大并发连接数，默认值为 <code>-1</code>，表示不限制。</p><p>设置为正整数时，会限制同时连接到此数据库的最大会话数。此限制不影响超级用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>limited_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 最多允许 50 个并发连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;limited_db&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIMIT</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=baseline><code>baseline</code></h3><p>字符串，一次性参数，用于指定数据库创建后要执行的 SQL 基线文件路径。</p><p>基线文件通常包含表结构定义、初始数据、存储过程等，用于初始化新数据库。
路径是相对于 Ansible 搜索路径的相对路径，通常放在 <code>files/</code> 目录下。</p><p>基线文件仅在首次创建数据库时执行；如果数据库已存在则跳过。使用 <code>state: recreate</code> 重建数据库时会重新执行基线文件。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_schema.sql </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 会查找 files/myapp_schema.sql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=schemas><code>schemas</code></h3><p>数组，可变参数（支持增删），用于定义要在数据库中创建或删除的模式。数组元素可以是字符串或对象。</p><p>简单格式使用字符串直接指定模式名，仅支持创建操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>api</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>core</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>完整格式使用对象定义，支持指定模式属主和删除操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 模式名（必选）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 模式属主（可选），生成 AUTHORIZATION 子句</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>deprecated</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 删除模式（使用 CASCADE）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>创建模式时使用 <code>IF NOT EXISTS</code>，已存在则跳过；删除模式时使用 <code>CASCADE</code>，会同时删除模式内的所有对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AUTHORIZATION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;deprecated&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=extensions><code>extensions</code></h3><p>数组，可变参数（支持增删），用于定义要在数据库中安装或卸载的扩展。数组元素可以是字符串或对象。</p><p>简单格式使用字符串直接指定扩展名，仅支持安装操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>postgis</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>pg_trgm</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>vector</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>完整格式使用对象定义，支持指定安装模式、版本和卸载操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>vector            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 扩展名（必选）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装到指定模式（可选）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.5.1&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 指定版本（可选）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>old_extension</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 卸载扩展（使用 CASCADE）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>安装扩展时使用 <code>CASCADE</code>，如果已存在则会报错但跳过，同时自动安装依赖扩展；卸载扩展时使用 <code>CASCADE</code>，会同时删除依赖此扩展的对象。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;vector&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WITH</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;public&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>VERSION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.5.1&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;old_extension&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=parameters><code>parameters</code></h3><p>对象，可变参数，用于设置数据库级别的配置参数。参数通过 <code>ALTER DATABASE ... SET</code> 设置，会对连接到此数据库的所有会话生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;512MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用特殊值 <code>DEFAULT</code>（大小写不敏感）可以将参数重置为 PostgreSQL 默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 设置新值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;myapp&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgbouncer><code>pgbouncer</code></h3><p>布尔值，可变参数，用于控制是否将数据库添加到 Pgbouncer 连接池列表，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 时，数据库不会出现在 Pgbouncer 的数据库列表中，客户端无法通过连接池访问此数据库。
适用于内部管理数据库或需要直连的特殊场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>internal_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 不通过连接池访问</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_mode><code>pool_mode</code></h3><p>枚举值，可变参数，用于设置此数据库在 Pgbouncer 中的池化模式，可选值为 <code>transaction</code>、<code>session</code> 或 <code>statement</code>，默认值为 <code>transaction</code>。</p><table class=full-width><thead><tr><th>模式</th><th>说明</th><th>适用场景</th></tr></thead><tbody><tr><td><code>transaction</code></td><td>事务结束后归还连接</td><td>大多数 OLTP 应用，默认推荐</td></tr><tr><td><code>session</code></td><td>会话结束后归还连接</td><td>需要会话级状态的应用</td></tr><tr><td><code>statement</code></td><td>每条语句后归还连接</td><td>简单无状态查询，极致复用</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用会话级池化</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_size><code>pool_size</code></h3><p>整数，可变参数，用于设置此数据库在 Pgbouncer 中的默认连接池大小，默认值为 <code>64</code>。</p><p>连接池大小决定了 Pgbouncer 为此数据库预留的后端连接数量。根据应用负载调整此值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>high_load_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>128</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 高负载应用使用更大的池</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_size_min><code>pool_size_min</code></h3><p>整数，可变参数，用于设置此数据库在 Pgbouncer 中的最小连接池大小，默认值为 <code>0</code>。</p><p>设置大于 0 的值会让 Pgbouncer 预先创建指定数量的后端连接，用于连接预热，减少首次请求的延迟。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latency_sensitive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 预热 10 个连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_reserve><code>pool_reserve</code></h3><p>整数，可变参数，用于设置此数据库在 Pgbouncer 中的保留连接数，默认值为 <code>32</code>。</p><p>当默认池不够用时，Pgbouncer 最多可以额外申请 <code>pool_reserve</code> 个连接来处理突发流量。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bursty_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 允许突发到 128 个连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_connlimit><code>pool_connlimit</code></h3><p>整数，可变参数，用于设置通过 Pgbouncer 连接池访问此数据库的最大连接数，默认值为 <code>100</code>。</p><p>此限制是 Pgbouncer 层面的限制，与数据库本身的 <code>connlimit</code> 参数独立。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>limited_pool_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 连接池最多 50 个连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pool_auth_user><code>pool_auth_user</code></h3><p>字符串，可变参数，用于指定 Pgbouncer 认证查询使用的用户。</p><p>此参数需要配合 <a href=/docs/pgsql/param#pgbouncer_auth_query><strong><code>pgbouncer_auth_query</code></strong></a> 参数启用才生效。
设置后，所有通过 Pgbouncer 连接到此数据库的请求都会使用指定用户执行认证查询来验证密码。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用监控用户执行认证查询</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=register_datasource><code>register_datasource</code></h3><p>布尔值，可变参数，用于控制是否将此数据库注册到 Grafana 作为 PostgreSQL 数据源，默认值为 <code>true</code>。</p><p>设置为 <code>false</code> 可以跳过 Grafana 数据源注册。适用于临时数据库、测试数据库，或不希望在监控系统中出现的内部数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_db</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 不注册到 Grafana</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=模板继承>模板继承</h2><p>许多参数如果不显式指定，会从模板数据库继承。默认模板是 <code>template1</code>，其编码设置由集群初始化参数决定：</p><table class=full-width><thead><tr><th>集群参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/param#pg_encoding><strong><code>pg_encoding</code></strong></a></td><td><code>UTF8</code></td><td>集群默认字符编码</td></tr><tr><td><a href=/docs/pgsql/param#pg_locale><strong><code>pg_locale</code></strong></a></td><td><code>C</code> / <code>C-UTF-8</code> (如果支持)</td><td>集群默认本地化</td></tr><tr><td><a href=/docs/pgsql/param#pg_lc_collate><strong><code>pg_lc_collate</code></strong></a></td><td><code>C</code> / <code>C-UTF-8</code> (如果支持)</td><td>集群默认排序规则</td></tr><tr><td><a href=/docs/pgsql/param#pg_lc_ctype><strong><code>pg_lc_ctype</code></strong></a></td><td><code>C</code> / <code>C-UTF-8</code> (如果支持)</td><td>集群默认字符分类</td></tr></tbody></table><p>新创建的数据库默认会从 <code>template1</code> 数据库 Fork 出来，这个模版数据库会在 <a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a> 阶段进行定制修改：
配置好扩展、模式以及默认权限，因此新创建的数据库也会继承这些配置，除非您显式使用一个其他的数据库作为模板。</p><hr><h2 id=深度定制>深度定制</h2><p>Pigsty 提供了丰富的定制参数与配置旋钮，如果你想定制模板数据库，请参考以下资源：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a> ：postgres 集群中的默认预定义角色和系统用户</li><li><a href=/docs/pgsql/param#pg_default_privileges><strong><code>pg_default_privileges</code></strong></a> ：由管理员用户创建数据库内对象时的默认权限</li><li><a href=/docs/pgsql/param#pg_default_schemas><strong><code>pg_default_schemas</code></strong></a> ：要创建的默认模式列表</li><li><a href=/docs/pgsql/param#pg_default_extensions><strong><code>pg_default_extensions</code></strong></a> ：要创建的默认扩展列表</li><li><a href=/docs/pgsql/param#pg_default_hba_rules><strong><code>pg_default_hba_rules</code></strong></a> ：postgres 基于主机的认证规则，全局PG默认HBA</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><strong><code>pgb_default_hba_rules</code></strong></a> ：pgbouncer 默认的基于主机的认证规则，全局PGB默认HBA</li></ul><p>如果上面这些配置仍然无法满足您的需求，您可以使用 <a href=/docs/pgsql/param#pg_init><strong><code>pg_init</code></strong></a> 指定自定义的集群初始化脚本进行定制：</p><ul><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init><strong><code>pg-init</code></strong></a> ：集群初始化脚本</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><strong><code>pg-init-template.sql</code></strong></a>：模板定制 SQL</li><li><a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pg-init-roles.sql><strong><code>pg-init-roles.sql</code></strong></a>：定制默认角色的 SQL</li></ul><hr><h2 id=本地化提供者>本地化提供者</h2><p>PostgreSQL 15+ 引入了 <strong><code>locale_provider</code></strong> 参数，支持不同的本地化实现。这些属性只能在数据库创建时指定，之后无法修改。</p><p>Pigsty 在 <a href=/docs/concept/iac/configure><strong><code>configure</code></strong></a> 配置向导中会根据 PG 与操作系统版本，优先使用 PG 内置的 C.UTF-8/C 本地化提供者。
数据库在默认情况下继承集群的本地化设置。如果您要为数据库指定一个不同于集群默认的本地化提供者，则必须使用 <code>template0</code> 作为模板数据库。</p><p><strong>使用 ICU 提供者（PG15+）</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ICU 必须使用 template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>icu</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>icu_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>en-US         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># ICU 本地化规则</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>使用内置提供者（PG17+）</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp_builtin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>builtin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>builtin_locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C.UTF-8   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 内置本地化规则</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>提供者对比</strong>：<code>libc</code>（传统方式，依赖操作系统）、<code>icu</code>（PG15+，跨平台一致，功能丰富）、<code>builtin</code>（PG17+，最高效的 C/C.UTF-8 排序）。</p><hr><h2 id=连接池>连接池</h2><p><a href=/docs/concept/arch/pgsql#pgbouncer><strong>Pgbouncer</strong></a> 连接池可以优化短连接性能，降低并发征用，以避免过高的连接数冲垮数据库，并在数据库迁移时提供额外的灵活处理空间。</p><p>Pigsty 会默认为 PostgreSQL 实例 1:1 配置启用一个连接池，
使用和 PostgreSQL 同样的 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> 运行，默认为 <code>postgres</code> 操作系统用户。
连接池与数据库使用 <code>/var/run/postgresql</code> Unix Socket 通信。</p><p>Pigsty 默认将 <a href=/docs/pgsql/param/#pg_databases><code>pg_databases</code></a> 中的所有数据库都添加到 pgbouncer 的数据库列表中。
您可以通过在数据库定义中显式设置 <a href=#pgbouncer><code>pgbouncer: false</code></a> 来禁用特定数据库的 pgbouncer 连接池支持。
pgbouncer 数据库列表与其配置参数在 <code>/etc/pgbouncer/database.txt</code> 中定义。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>meta                        = host=/var/run/postgresql mode=session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>grafana                     = host=/var/run/postgresql mode=transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bytebase                    = host=/var/run/postgresql auth_user=dbuser_meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>kong                        = host=/var/run/postgresql pool_size=32 reserve_pool=64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>gitea                       = host=/var/run/postgresql min_pool_size=10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>wiki                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>noco                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>mongo                       = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>当您 <a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93><strong>创建数据库</strong></a>时，Pgbouncer 的数据库列表定义文件将会被刷新，并通过在线重载配置的方式生效，正常不会影响现有的连接。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-be500246ccc4d0aea19a8d2e848cf128>6 - HBA 规则</h1><div class=lead>Pigsty 中 PostgreSQL 与 Pgbouncer 的 HBA（Host-Based Authentication）规则配置详解。</div><h2 id=概述>概述</h2><p>HBA（Host-Based Authentication）控制"谁可以从哪里、以什么方式连接到数据库"。
Pigsty 通过 <a href=#pg_default_hba_rules><strong><code>pg_default_hba_rules</code></strong></a> 与 <a href=#pg_hba_rules><strong><code>pg_hba_rules</code></strong></a> 让 HBA 规则也能以声明式配置形式管理。</p><p>Pigsty 在集群初始化或 HBA 刷新时渲染以下配置文件：</p><table><thead><tr><th style=text-align:left>配置文件</th><th style=text-align:left>路径</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>PostgreSQL HBA</td><td style=text-align:left><code>/pg/data/pg_hba.conf</code></td><td style=text-align:left>PostgreSQL 服务器的 HBA 规则</td></tr><tr><td style=text-align:left>Pgbouncer HBA</td><td style=text-align:left><code>/etc/pgbouncer/pgb_hba.conf</code></td><td style=text-align:left>连接池 Pgbouncer 的 HBA 规则</td></tr></tbody></table><p>HBA 规则由以下参数控制：</p><table><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>层级</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#pg_default_hba_rules><code>pg_default_hba_rules</code></a></td><td style=text-align:left>G</td><td style=text-align:left>PostgreSQL 全局默认 HBA 规则</td></tr><tr><td style=text-align:left><a href=#pg_hba_rules><code>pg_hba_rules</code></a></td><td style=text-align:left>G/C/I</td><td style=text-align:left>PostgreSQL 集群/实例级追加规则</td></tr><tr><td style=text-align:left><a href=#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a></td><td style=text-align:left>G</td><td style=text-align:left>Pgbouncer 全局默认 HBA 规则</td></tr><tr><td style=text-align:left><a href=#pgb_hba_rules><code>pgb_hba_rules</code></a></td><td style=text-align:left>G/C/I</td><td style=text-align:left>Pgbouncer 集群/实例级追加规则</td></tr></tbody></table><p>规则支持以下特性：</p><ul><li><strong>按角色过滤</strong>：规则支持 <code>role</code> 字段，根据实例的 <code>pg_role</code> 自动筛选生效</li><li><strong>按顺序排序</strong>：规则支持 <code>order</code> 字段，控制规则在最终配置文件中的位置</li><li><strong>两种写法</strong>：支持别名形式（简化语法）和原始形式（直接 HBA 文本）</li></ul><hr><h2 id=刷新-hba>刷新 HBA</h2><p>修改配置后，需要重新渲染配置文件并让服务重载：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;                   <span style=color:#8f5902;font-style:italic># 刷新整个集群的 HBA 规则（推荐）</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; &lt;ip&gt;...           <span style=color:#8f5902;font-style:italic># 刷新集群中指定实例的 HBA 规则</span>
</span></span></code></pre></div><p>脚本内部执行以下剧本命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><p><strong>仅刷新 PostgreSQL</strong>：<code>./pgsql.yml -l &lt;cls> -t pg_hba,pg_reload -e pg_reload=true</code></p><p><strong>仅刷新 Pgbouncer</strong>：<code>./pgsql.yml -l &lt;cls> -t pgbouncer_hba,pgbouncer_reload</code></p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>不要直接编辑配置文件</div><p>不要直接编辑 <code>/pg/data/pg_hba.conf</code> 或 <code>/etc/pgbouncer/pgb_hba.conf</code>，下次执行 playbook 时会被覆盖。
所有变更应在 <code>pigsty.yml</code> 中进行，然后执行 <code>bin/pgsql-hba</code> 刷新。</p></div><hr><h2 id=参数详解>参数详解</h2><h3 id=pg_default_hba_rules><code>pg_default_hba_rules</code></h3><p>PostgreSQL 全局默认 HBA 规则列表，通常定义在 <code>all.vars</code> 中，为所有 PostgreSQL 集群提供基础访问控制。</p><ul><li>类型：<code>rule[]</code>，层级：全局 (G)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title: &#39;admin @ everywhere with ssl &amp; pwd&#39;    ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pg_hba_rules><code>pg_hba_rules</code></h3><p>PostgreSQL 集群/实例级 HBA 追加规则，可在集群或实例级别覆盖，与默认规则合并后按 <code>order</code> 排序。</p><ul><li>类型：<code>rule[]</code>，层级：全局/集群/实例 (G/C/I)，默认值：<code>[]</code></li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: app_user, db: app_db, addr: intra, auth: pwd, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app user access&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgb_default_hba_rules><code>pgb_default_hba_rules</code></h3><p>Pgbouncer 全局默认 HBA 规则列表，通常定义在 <code>all.vars</code> 中。</p><ul><li>类型：<code>rule[]</code>，层级：全局 (G)</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=pgb_hba_rules><code>pgb_hba_rules</code></h3><p>Pgbouncer 集群/实例级 HBA 追加规则。</p><ul><li>类型：<code>rule[]</code>，层级：全局/集群/实例 (G/C/I)，默认值：<code>[]</code></li></ul><blockquote><p><strong>注意</strong>：Pgbouncer HBA 不支持 <code>db: replication</code>。</p></blockquote><hr><h2 id=规则字段>规则字段</h2><p>每条 HBA 规则是一个 YAML 字典，支持以下字段：</p><table><thead><tr><th style=text-align:left>字段</th><th style=text-align:left>类型</th><th style=text-align:left>必需</th><th style=text-align:left>默认值</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>user</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left><code>all</code></td><td style=text-align:left>用户名，支持 <code>all</code>、变量占位符、<code>+rolename</code> 等</td></tr><tr><td style=text-align:left><code>db</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left><code>all</code></td><td style=text-align:left>数据库名，支持 <code>all</code>、<code>replication</code>、具体库名</td></tr><tr><td style=text-align:left><code>addr</code></td><td style=text-align:left>string</td><td style=text-align:left>是*</td><td style=text-align:left>-</td><td style=text-align:left>地址别名或 CIDR，见 <a href=#%E5%9C%B0%E5%9D%80%E5%88%AB%E5%90%8D><strong>地址别名</strong></a></td></tr><tr><td style=text-align:left><code>auth</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left><code>pwd</code></td><td style=text-align:left>认证方式别名，见 <a href=#%E8%AE%A4%E8%AF%81%E6%96%B9%E5%BC%8F><strong>认证方式</strong></a></td></tr><tr><td style=text-align:left><code>title</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left>-</td><td style=text-align:left>规则说明/注释，会渲染为配置文件中的注释</td></tr><tr><td style=text-align:left><code>role</code></td><td style=text-align:left>string</td><td style=text-align:left>否</td><td style=text-align:left><code>common</code></td><td style=text-align:left>实例角色过滤，见 <a href=#%E8%A7%92%E8%89%B2%E8%BF%87%E6%BB%A4><strong>角色过滤</strong></a></td></tr><tr><td style=text-align:left><code>order</code></td><td style=text-align:left>int</td><td style=text-align:left>否</td><td style=text-align:left><code>1000</code></td><td style=text-align:left>排序权重，数字小的排前面，见 <a href=#%E6%8E%92%E5%BA%8F%E6%9C%BA%E5%88%B6><strong>排序机制</strong></a></td></tr><tr><td style=text-align:left><code>rules</code></td><td style=text-align:left>list</td><td style=text-align:left>是*</td><td style=text-align:left>-</td><td style=text-align:left>原始 HBA 文本行列表，与 <code>addr</code> 二选一</td></tr></tbody></table><blockquote><p><code>addr</code> 和 <code>rules</code> 必须指定其一。使用 <code>rules</code> 时可以直接写原始 HBA 格式。</p></blockquote><hr><h2 id=地址别名>地址别名</h2><p>Pigsty 提供地址别名，简化 HBA 规则编写：</p><table><thead><tr><th style=text-align:left>别名</th><th style=text-align:left>展开为</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>local</code></td><td style=text-align:left>Unix socket</td><td style=text-align:left>本地 Unix 套接字连接</td></tr><tr><td style=text-align:left><code>localhost</code></td><td style=text-align:left>Unix socket + <code>127.0.0.1/32</code> + <code>::1/128</code></td><td style=text-align:left>本地回环地址</td></tr><tr><td style=text-align:left><code>admin</code></td><td style=text-align:left><code>${admin_ip}/32</code></td><td style=text-align:left>管理员 IP 地址</td></tr><tr><td style=text-align:left><code>infra</code></td><td style=text-align:left>所有 infra 组节点 IP</td><td style=text-align:left>基础设施节点列表</td></tr><tr><td style=text-align:left><code>cluster</code></td><td style=text-align:left>当前集群所有成员 IP</td><td style=text-align:left>同一集群内的所有实例</td></tr><tr><td style=text-align:left><code>intra</code> / <code>intranet</code></td><td style=text-align:left><code>10.0.0.0/8</code>, <code>172.16.0.0/12</code>, <code>192.168.0.0/16</code></td><td style=text-align:left>内网 CIDR 网段</td></tr><tr><td style=text-align:left><code>world</code> / <code>all</code></td><td style=text-align:left><code>0.0.0.0/0</code> + <code>::/0</code></td><td style=text-align:left>任意地址（IPv4 + IPv6）</td></tr><tr><td style=text-align:left><code>&lt;CIDR></code></td><td style=text-align:left>直接使用</td><td style=text-align:left>如 <code>192.168.1.0/24</code>、<code>10.1.1.100/32</code></td></tr></tbody></table><p>内网 CIDR 可通过 <code>node_firewall_intranet</code> 参数自定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_firewall_intranet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>10.0.0.0</span><span style=color:#000>/8</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>172.16.0.0</span><span style=color:#000>/12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#0000cf;font-weight:700>192.168.0.0</span><span style=color:#000>/16</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=认证方式>认证方式</h2><p>Pigsty 提供认证方式别名，简化配置：</p><table><thead><tr><th style=text-align:left>别名</th><th style=text-align:left>实际方式</th><th style=text-align:left>连接类型</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>pwd</code></td><td style=text-align:left><code>scram-sha-256</code> 或 <code>md5</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>根据 <code>pg_pwd_enc</code> 自动选择</td></tr><tr><td style=text-align:left><code>ssl</code></td><td style=text-align:left><code>scram-sha-256</code> 或 <code>md5</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>强制 SSL + 密码</td></tr><tr><td style=text-align:left><code>ssl-sha</code></td><td style=text-align:left><code>scram-sha-256</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>强制 SSL + SCRAM-SHA-256</td></tr><tr><td style=text-align:left><code>ssl-md5</code></td><td style=text-align:left><code>md5</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>强制 SSL + MD5</td></tr><tr><td style=text-align:left><code>cert</code></td><td style=text-align:left><code>cert</code></td><td style=text-align:left><code>hostssl</code></td><td style=text-align:left>客户端证书认证</td></tr><tr><td style=text-align:left><code>trust</code></td><td style=text-align:left><code>trust</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>无条件信任（危险）</td></tr><tr><td style=text-align:left><code>deny</code> / <code>reject</code></td><td style=text-align:left><code>reject</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>拒绝连接</td></tr><tr><td style=text-align:left><code>ident</code></td><td style=text-align:left><code>ident</code></td><td style=text-align:left><code>host</code></td><td style=text-align:left>OS 用户映射（PostgreSQL）</td></tr><tr><td style=text-align:left><code>peer</code></td><td style=text-align:left><code>peer</code></td><td style=text-align:left><code>local</code></td><td style=text-align:left>OS 用户映射（Pgbouncer/本地）</td></tr></tbody></table><blockquote><p><code>pg_pwd_enc</code> 默认为 <code>scram-sha-256</code>，可设为 <code>md5</code> 以兼容老客户端。</p></blockquote><hr><h2 id=用户变量>用户变量</h2><p>HBA 规则支持以下用户占位符，渲染时自动替换为实际用户名：</p><table><thead><tr><th style=text-align:left>占位符</th><th style=text-align:left>默认值</th><th style=text-align:left>对应参数</th></tr></thead><tbody><tr><td style=text-align:left><code>${dbsu}</code></td><td style=text-align:left><code>postgres</code></td><td style=text-align:left><code>pg_dbsu</code></td></tr><tr><td style=text-align:left><code>${repl}</code></td><td style=text-align:left><code>replicator</code></td><td style=text-align:left><code>pg_replication_username</code></td></tr><tr><td style=text-align:left><code>${monitor}</code></td><td style=text-align:left><code>dbuser_monitor</code></td><td style=text-align:left><code>pg_monitor_username</code></td></tr><tr><td style=text-align:left><code>${admin}</code></td><td style=text-align:left><code>dbuser_dba</code></td><td style=text-align:left><code>pg_admin_username</code></td></tr></tbody></table><hr><h2 id=角色过滤>角色过滤</h2><p>HBA 规则的 <code>role</code> 字段控制规则在哪些实例上生效：</p><table><thead><tr><th style=text-align:left>角色</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>common</code></td><td style=text-align:left>默认值，所有实例都生效</td></tr><tr><td style=text-align:left><code>primary</code></td><td style=text-align:left>仅主库实例生效</td></tr><tr><td style=text-align:left><code>replica</code></td><td style=text-align:left>仅从库实例生效</td></tr><tr><td style=text-align:left><code>offline</code></td><td style=text-align:left>仅离线实例生效（<code>pg_role: offline</code> 或 <code>pg_offline_query: true</code>）</td></tr><tr><td style=text-align:left><code>standby</code></td><td style=text-align:left>备库实例</td></tr><tr><td style=text-align:left><code>delayed</code></td><td style=text-align:left>延迟从库实例</td></tr></tbody></table><p>角色过滤基于实例的 <code>pg_role</code> 变量进行匹配，不匹配的规则会被注释掉（以 <code>#</code> 开头）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 仅在主库生效：写入用户只能连主库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: writer, db: all, addr: intra, auth: pwd, role: primary, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;writer only on primary&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 仅在离线实例生效：ETL 任务专用网络</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39;, db: all, addr: &#39;172.20.0.0/16&#39;, auth: ssl, role: offline, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;offline dedicated&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=排序机制>排序机制</h2><p>PostgreSQL HBA 是 <strong>首条匹配生效</strong>，规则顺序至关重要。Pigsty 通过 <code>order</code> 字段控制规则渲染顺序。</p><p><strong>Order 区间约定</strong></p><table><thead><tr><th style=text-align:left>区间</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><code>0 - 99</code></td><td style=text-align:left>用户高优先规则（在所有默认规则之前）</td></tr><tr><td style=text-align:left><code>100 - 650</code></td><td style=text-align:left>默认规则区（间隔 50，便于插入）</td></tr><tr><td style=text-align:left><code>1000+</code></td><td style=text-align:left>用户规则默认值（不填 <code>order</code> 时追加到最后）</td></tr></tbody></table><p><strong>PostgreSQL 默认规则 Order 分配</strong></p><table><thead><tr><th style=text-align:left>Order</th><th style=text-align:left>规则说明</th></tr></thead><tbody><tr><td style=text-align:left>100</td><td style=text-align:left>dbsu local ident</td></tr><tr><td style=text-align:left>150</td><td style=text-align:left>dbsu replication local</td></tr><tr><td style=text-align:left>200</td><td style=text-align:left>replicator localhost</td></tr><tr><td style=text-align:left>250</td><td style=text-align:left>replicator intra replication</td></tr><tr><td style=text-align:left>300</td><td style=text-align:left>replicator intra postgres</td></tr><tr><td style=text-align:left>350</td><td style=text-align:left>monitor localhost</td></tr><tr><td style=text-align:left>400</td><td style=text-align:left>monitor infra</td></tr><tr><td style=text-align:left>450</td><td style=text-align:left>admin infra ssl</td></tr><tr><td style=text-align:left>500</td><td style=text-align:left>admin world ssl</td></tr><tr><td style=text-align:left>550</td><td style=text-align:left>dbrole_readonly localhost</td></tr><tr><td style=text-align:left>600</td><td style=text-align:left>dbrole_readonly intra</td></tr><tr><td style=text-align:left>650</td><td style=text-align:left>dbrole_offline intra</td></tr></tbody></table><p><strong>Pgbouncer 默认规则 Order 分配</strong></p><table><thead><tr><th style=text-align:left>Order</th><th style=text-align:left>规则说明</th></tr></thead><tbody><tr><td style=text-align:left>100</td><td style=text-align:left>dbsu local peer</td></tr><tr><td style=text-align:left>150</td><td style=text-align:left>all localhost pwd</td></tr><tr><td style=text-align:left>200</td><td style=text-align:left>monitor pgbouncer intra</td></tr><tr><td style=text-align:left>250</td><td style=text-align:left>monitor world deny</td></tr><tr><td style=text-align:left>300</td><td style=text-align:left>admin intra pwd</td></tr><tr><td style=text-align:left>350</td><td style=text-align:left>admin world deny</td></tr><tr><td style=text-align:left>400</td><td style=text-align:left>all intra pwd</td></tr></tbody></table><hr><h2 id=写法示例>写法示例</h2><p><strong>别名形式</strong>：使用 Pigsty 提供的简化语法</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow grafana view access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_view</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>渲染结果：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow grafana view access [primary]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  meta               dbuser_view        10.10.10.10/32     scram-sha-256</span>
</span></span></code></pre></div><p><strong>原始形式</strong>：直接使用 PostgreSQL HBA 语法</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>host all all 10.0.0.0/8 scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>host all all 172.16.0.0/12 scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>host all all 192.168.0.0/16 scram-sha-256</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>渲染结果：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow intranet password access [common]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host all all 10.0.0.0/8 scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host all all 172.16.0.0/12 scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host all all 192.168.0.0/16 scram-sha-256</span>
</span></span></code></pre></div><hr><h2 id=常见配置场景>常见配置场景</h2><p><strong>黑名单 IP</strong>：使用 <code>order: 0</code> 确保最先匹配</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: all, db: all, addr: &#39;10.1.1.100/32&#39;, auth: deny, order: 0, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;block bad ip&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>白名单应用服务器</strong>：高优先级允许特定 IP</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: app_user, db: app_db, addr: &#39;192.168.1.10/32&#39;, auth: ssl, order: 50, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app server&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理员强制证书</strong>：覆盖默认的 SSL 密码认证</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#204a87;font-weight:700>, db: all, addr: world, auth: cert, order: 10, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;admin cert only&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>离线实例专用网络</strong>：仅在 offline 实例生效</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39;, db: all, addr: &#39;172.20.0.0/16&#39;, auth: ssl-sha, role: offline, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etl network&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>按数据库限制访问</strong>：敏感库仅允许特定网段</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: fin_user, db: finance_db, addr: &#39;10.20.0.0/16&#39;, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;finance only&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: hr_user, db: hr_db, addr: &#39;10.30.0.0/16&#39;, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;hr only&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>Pgbouncer 专用规则</strong>：注意不支持 <code>db: replication</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readwrite&#39;, db: all, addr: world, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app via pgbouncer&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=完整集群示例>完整集群示例</h2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-prod</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-prod</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 黑名单：已知恶意 IP（最高优先级）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: all, db: all, addr: &#39;10.1.1.100/32&#39;, auth: deny, order: 0, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;blacklist&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 应用服务器白名单（高优先级）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: app_user, db: app_db, addr: &#39;192.168.1.0/24&#39;, auth: ssl, order: 50, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app servers&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># ETL 任务：仅离线实例</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: etl_user, db: all, addr: &#39;172.20.0.0/16&#39;, auth: pwd, role: offline, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etl tasks&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 集群内监控访问</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#204a87;font-weight:700>, db: all, addr: cluster, auth: pwd, order: 380, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;cluster monitor&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgb_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 应用通过连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readwrite&#39;, db: all, addr: &#39;192.168.1.0/24&#39;, auth: ssl, title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;app via pgbouncer&#39;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=验证与排查>验证与排查</h2><p><strong>查看当前 HBA 规则</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;TABLE pg_hba_file_rules&#34;</span>         <span style=color:#8f5902;font-style:italic># 通过 SQL 查看（推荐）</span>
</span></span><span style=display:flex><span>cat /pg/data/pg_hba.conf                  <span style=color:#8f5902;font-style:italic># 查看 PostgreSQL HBA 文件</span>
</span></span><span style=display:flex><span>cat /etc/pgbouncer/pgb_hba.conf           <span style=color:#8f5902;font-style:italic># 查看 Pgbouncer HBA 文件</span>
</span></span><span style=display:flex><span>grep <span style=color:#4e9a06>&#39;^#&#39;</span> /pg/data/pg_hba.conf <span style=color:#000;font-weight:700>|</span> head -20 <span style=color:#8f5902;font-style:italic># 查看规则标题（验证 order）</span>
</span></span></code></pre></div><p><strong>测试连接认证</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -h &lt;host&gt; -p <span style=color:#0000cf;font-weight:700>5432</span> -U &lt;user&gt; -d &lt;db&gt; -c <span style=color:#4e9a06>&#34;SELECT 1&#34;</span>
</span></span></code></pre></div><p><strong>常见问题排查</strong></p><table><thead><tr><th style=text-align:left>错误信息</th><th style=text-align:left>可能原因</th><th style=text-align:left>解决方案</th></tr></thead><tbody><tr><td style=text-align:left><code>no pg_hba.conf entry for host...</code></td><td style=text-align:left>没有匹配的 HBA 规则</td><td style=text-align:left>添加对应规则并刷新</td></tr><tr><td style=text-align:left><code>password authentication failed</code></td><td style=text-align:left>密码错误或加密方式不兼容</td><td style=text-align:left>检查密码和 <code>pg_pwd_enc</code></td></tr><tr><td style=text-align:left>规则不生效</td><td style=text-align:left>未刷新或 order 被覆盖</td><td style=text-align:left>执行 <code>bin/pgsql-hba</code> 并检查顺序</td></tr></tbody></table><hr><h2 id=注意事项>注意事项</h2><ol><li><strong>顺序敏感</strong>：PostgreSQL HBA 首条匹配生效，善用 <code>order</code> 字段</li><li><strong>角色匹配</strong>：确保 <code>role</code> 字段与目标实例的 <code>pg_role</code> 一致</li><li><strong>地址格式</strong>：CIDR 必须正确，如 <code>10.0.0.0/8</code> 而非 <code>10.0.0.0/255.0.0.0</code></li><li><strong>Pgbouncer 限制</strong>：不支持 <code>db: replication</code></li><li><strong>SSL 前提</strong>：使用 <code>ssl</code>、<code>cert</code> 认证前确保 SSL 已正确配置</li><li><strong>测试优先</strong>：修改 HBA 前建议先在测试环境验证</li><li><strong>扩缩容刷新</strong>：使用 <code>addr: cluster</code> 的规则在集群成员变化后需要刷新</li></ol><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/misc/hba/><strong>HBA 管理</strong></a>：HBA 规则的日常管理操作与故障排查</li><li><a href=/docs/pgsql/config/user/><strong>用户配置</strong></a>：用户与角色配置</li><li><a href=/docs/pgsql/config/acl/><strong>访问控制</strong></a>：角色体系与权限模型</li><li><a href=/docs/concept/sec/><strong>安全与合规</strong></a>：PostgreSQL 集群的安全特性</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-ff84fb35cef7a71a971ba3fb6712ed0c>7 - 参数配置</h1><div class=lead>如何配置集群、实例、用户和数据库级别的 PostgreSQL 参数</div><p>PostgreSQL 参数可以在多个层级进行配置，不同层级的参数设置具有不同的作用范围和优先级。
Pigsty 支持在四个层级配置 PostgreSQL 参数，从全局到局部依次为：</p><table class=full-width><thead><tr><th>层级</th><th>作用范围</th><th>配置方式</th><th>存储位置</th></tr></thead><tbody><tr><td><a href=#%E9%9B%86%E7%BE%A4%E7%BA%A7%E5%8F%82%E6%95%B0><strong>集群级</strong></a></td><td>整个集群所有实例</td><td>Patroni DCS / 调优模板</td><td>etcd + <code>postgresql.conf</code></td></tr><tr><td><a href=#%E5%AE%9E%E4%BE%8B%E7%BA%A7%E5%8F%82%E6%95%B0><strong>实例级</strong></a></td><td>单个 PostgreSQL 实例</td><td><code>pg_parameters</code> / <code>ALTER SYSTEM</code></td><td><code>postgresql.auto.conf</code></td></tr><tr><td><a href=#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BA%A7%E5%8F%82%E6%95%B0><strong>数据库级</strong></a></td><td>特定数据库的所有会话</td><td><code>pg_databases[].parameters</code></td><td><code>pg_db_role_setting</code></td></tr><tr><td><a href=#%E7%94%A8%E6%88%B7%E7%BA%A7%E5%8F%82%E6%95%B0><strong>用户级</strong></a></td><td>特定用户的所有会话</td><td><code>pg_users[].parameters</code></td><td><code>pg_db_role_setting</code></td></tr></tbody></table><p>参数优先级从低到高：<strong>集群级 &lt; 实例级 &lt; 数据库级 &lt; 用户级 &lt; 会话级</strong>（<code>SET</code> 命令）。
高优先级的设置会覆盖低优先级的设置。</p><blockquote><p>关于 PostgreSQL 参数的完整说明，请参阅 <a href=https://www.postgresql.org/docs/current/runtime-config.html><strong>PostgreSQL 官方文档：服务器配置</strong></a>。</p></blockquote><hr><h2 id=集群级参数>集群级参数</h2><p>集群级参数是整个 PostgreSQL 集群共享的配置，所有实例（主库和从库）都会使用相同的参数值。
在 Pigsty 中，集群级参数通过 <a href=/docs/pgsql/admin/patroni><strong>Patroni</strong></a> 管理，存储在分布式配置存储（DCS，默认为 etcd）中。</p><p>Pigsty 提供了四种预置的 <a href=/docs/pgsql/template><strong>Patroni 参数优化模板</strong></a>，针对不同的使用场景进行了优化，通过 <a href=/docs/pgsql/param#pg_conf><strong><code>pg_conf</code></strong></a> 参数指定：</p><table class=full-width><thead><tr><th>模板</th><th>适用场景</th><th>特点</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/template/oltp><strong><code>oltp.yml</code></strong></a></td><td>在线事务处理</td><td>低延迟、高并发，默认推荐</td></tr><tr><td><a href=/docs/pgsql/template/olap><strong><code>olap.yml</code></strong></a></td><td>在线分析处理</td><td>大查询、高吞吐，适合数仓</td></tr><tr><td><a href=/docs/pgsql/template/crit><strong><code>crit.yml</code></strong></a></td><td>核心金融业务</td><td>最大持久性，牺牲部分性能换取安全</td></tr><tr><td><a href=/docs/pgsql/template/tiny><strong><code>tiny.yml</code></strong></a></td><td>微型实例</td><td>资源受限环境，适合开发测试</td></tr></tbody></table><p>调优模板文件位于 Pigsty 安装目录的 <code>roles/pgsql/templates/</code> 目录下，包含了根据硬件规格自动计算的参数值。
这些模板会在集群初始化时渲染为 Patroni 配置文件 <code>/etc/patroni/patroni.yml</code>。更多详情请参阅 <a href=/docs/pgsql/template><strong>场景模板</strong></a>。</p><p>在集群创建前，您可以通过调整这些 Patroni 配置模板来修改集群的 <strong>初始化参数</strong>。
一旦集群初始化完成，后续的参数修改应通过 Patroni 的 <a href=/docs/pgsql/admin/patroni><strong>配置管理</strong></a> 机制进行。</p><h3 id=patroni-dcs-配置>Patroni DCS 配置</h3><p>Patroni 将集群配置存储在 DCS（分布式配置存储，默认为 etcd）中，确保集群所有成员使用一致的配置。</p><p><strong>配置存储结构</strong>：</p><pre tabindex=0><code>/pigsty/                          # 命名空间（patroni_namespace）
  └── pg-meta/                    # 集群名称（pg_cluster）
      ├── config                  # 集群配置（所有成员共享）
      ├── leader                  # 当前主库信息
      ├── members/                # 成员注册信息
      │   ├── pg-meta-1
      │   └── pg-meta-2
      └── ...
</code></pre><p><strong>配置渲染流程</strong>：</p><ol><li><strong>初始化阶段</strong>：调优模板（如 <code>oltp.yml</code>）通过 Jinja2 渲染为 <code>/etc/patroni/patroni.yml</code></li><li><strong>启动阶段</strong>：Patroni 读取本地配置，将 PostgreSQL 参数写入 DCS</li><li><strong>运行阶段</strong>：Patroni 定期从 DCS 同步配置到本地 PostgreSQL</li></ol><p><strong>本地缓存机制</strong>：</p><p>每个 Patroni 实例会在本地缓存 DCS 配置，位于 <code>/pg/conf/&lt;instance>.yml</code>：</p><ul><li>启动时：从 DCS 加载配置，缓存到本地</li><li>运行时：定期同步 DCS 配置到本地缓存</li><li>DCS 不可用时：使用本地缓存继续运行（但无法进行主从切换）</li></ul><h3 id=配置文件层次>配置文件层次</h3><p>Patroni 会将 DCS 中的配置渲染到本地 PostgreSQL 配置文件，形成以下层次结构：</p><pre tabindex=0><code>/pg/data/
├── postgresql.conf          # 主配置文件（由 Patroni 动态管理）
├── postgresql.base.conf     # 基础配置（通过 include 指令加载）
├── postgresql.auto.conf     # 实例级覆盖配置（ALTER SYSTEM 写入）
├── pg_hba.conf              # 客户端认证配置
└── pg_ident.conf            # 用户映射配置
</code></pre><p><strong>配置加载顺序</strong>（优先级从低到高）：</p><ol><li><code>postgresql.conf</code>：Patroni 动态生成，包含 DCS 中的集群参数</li><li><code>postgresql.base.conf</code>：通过 <code>include</code> 指令加载，包含静态基础配置</li><li><code>postgresql.auto.conf</code>：PostgreSQL 自动加载，用于实例级参数覆盖</li></ol><p>由于 <code>postgresql.auto.conf</code> <strong>最后加载</strong>，其中的参数会覆盖前面文件中的同名参数。</p><hr><h2 id=实例级参数>实例级参数</h2><p>实例级参数仅对单个 PostgreSQL 实例生效，用于覆盖集群级配置或设置实例特定的参数。
实例级参数会写入 <code>postgresql.auto.conf</code> 文件，由于该文件最后加载，可以覆盖集群级的任何参数。</p><p>这是一项非常有用的技术：您可以为特定实例设置不同于集群的参数值，例如：</p><ul><li>为从库设置 <code>hot_standby_feedback = on</code></li><li>为特定实例调整 <code>work_mem</code> 或 <code>maintenance_work_mem</code></li><li>为延迟从库设置 <code>recovery_min_apply_delay</code></li></ul><h3 id=使用-pg_parameters>使用 pg_parameters</h3><p>在 Pigsty 配置中，使用 <a href=/docs/pgsql/param#pg_parameters><strong><code>pg_parameters</code></strong></a> 参数定义实例级配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                              </span><span style=color:#8f5902;font-style:italic># 实例级参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all                       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 仅此实例记录所有 SQL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                                </span><span style=color:#8f5902;font-style:italic># 集群默认的实例参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>log_timezone</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Asia/Shanghai</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>log_min_duration_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用 <code>./pgsql.yml -l &lt;cls> -t pg_param</code> 子任务，可以将参数配置应用生效，这些参数会被渲染到 <code>postgresql.auto.conf</code> 文件中。</p><h3 id=参数覆盖层次>参数覆盖层次</h3><p><code>pg_parameters</code> 可以在 Ansible 配置的不同层次定义，优先级从低到高：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 全局默认</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>none</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 集群级覆盖</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ddl</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>          </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 实例级覆盖（最高优先级）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>            </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=使用-alter-system>使用 ALTER SYSTEM</h3><p>除了通过配置文件，还可以在运行时使用 SQL 命令 <a href=https://www.postgresql.org/docs/current/sql-altersystem.html><strong><code>ALTER SYSTEM</code></strong></a> 修改实例级参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 设置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>log_min_duration_statement</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>1000</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 重置为默认值
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SYSTEM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic>-- 重置所有 ALTER SYSTEM 设置
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 重新加载配置使其生效
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_reload_conf</span><span style=color:#000;font-weight:700>();</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><code>ALTER SYSTEM</code> 会将参数写入 <code>postgresql.auto.conf</code> 文件。</p><blockquote><p><strong>注意</strong>：在 Pigsty 管理的集群中，<code>postgresql.auto.conf</code> 由 Ansible 通过 <code>pg_parameters</code> 管理。
手动使用 <code>ALTER SYSTEM</code> 修改的参数可能会在下次执行 playbook 时被覆盖。
建议通过修改 <code>pigsty.yml</code> 中的 <code>pg_parameters</code> 来管理实例级参数。</p></blockquote><h3 id=列表类型参数>列表类型参数</h3><p>PostgreSQL 中有一类特殊的参数接受逗号分隔的列表值。在 YAML 配置文件中配置这类参数时，
<strong>整个值必须用引号包裹</strong>，否则 YAML 解析器会将其解释为数组而导致错误：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ✓ 正确：用引号包裹整个值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;$user&#34;, public, app&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ✗ 错误：不加引号会导致 YAML 解析错误</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb, pg_stat_statements  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># YAML 会解析为数组！</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Pigsty 会自动识别以下列表类型参数，在渲染到配置文件时<strong>不添加外层引号</strong>：</p><table class=full-width><thead><tr><th>参数</th><th>说明</th><th>示例值</th></tr></thead><tbody><tr><td><code>shared_preload_libraries</code></td><td>预加载共享库</td><td><code>'timescaledb, pg_stat_statements'</code></td></tr><tr><td><code>search_path</code></td><td>Schema 搜索路径</td><td><code>'"$user", public, app'</code></td></tr><tr><td><code>local_preload_libraries</code></td><td>本地预加载库</td><td><code>'auto_explain'</code></td></tr><tr><td><code>session_preload_libraries</code></td><td>会话预加载库</td><td><code>'pg_hint_plan'</code></td></tr><tr><td><code>log_destination</code></td><td>日志输出目标</td><td><code>'csvlog, stderr'</code></td></tr><tr><td><code>unix_socket_directories</code></td><td>Unix Socket 目录</td><td><code>'/var/run/postgresql, /tmp'</code></td></tr><tr><td><code>temp_tablespaces</code></td><td>临时表空间</td><td><code>'ssd_space, hdd_space'</code></td></tr><tr><td><code>debug_io_direct</code></td><td>直接 I/O 模式（PG16+）</td><td><code>'data, wal'</code></td></tr></tbody></table><p><strong>渲染示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pigsty.yml 配置（YAML 中需要引号）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>shared_preload_libraries</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;$user&#34;, public, app&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>64MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 渲染后的 postgresql.auto.conf（列表参数无外层引号）</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>shared_preload_libraries</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>timescaledb, pg_stat_statements</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>search_path</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;$user&#34;, public, app</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>work_mem</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;64MB&#39;</span>
</span></span></code></pre></div><hr><h2 id=数据库级参数>数据库级参数</h2><p>数据库级参数针对特定数据库生效，连接到该数据库的所有会话都会应用这些参数设置。
通过 <a href=https://www.postgresql.org/docs/current/sql-alterdatabase.html><strong><code>ALTER DATABASE ... SET</code></strong></a> 实现，存储在系统表 <code>pg_db_role_setting</code> 中。</p><h3 id=配置方式>配置方式</h3><p>在 <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> 中使用 <code>parameters</code> 字段定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>256MB                             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 分析库需要更多内存</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>1GB                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 大表维护操作</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>10min                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 允许长查询</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;$user&#34;, public, mart&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 列表参数需要引号</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>与实例级参数相同，列表类型参数值在 YAML 中需要用引号包裹。</p></blockquote><h3 id=参数渲染规则>参数渲染规则</h3><p>数据库级参数通过 <code>ALTER DATABASE ... SET</code> 语句设置。Pigsty 会根据参数类型自动选择正确的语法：</p><p><strong>列表类型参数</strong>（<code>search_path</code>、<code>temp_tablespaces</code>、<code>local_preload_libraries</code>、<code>session_preload_libraries</code>、<code>log_destination</code>）不加外层引号：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;analytics&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;search_path&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;$user&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>mart</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>标量参数</strong> 使用引号包裹值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;analytics&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;analytics&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;10min&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p><strong>注意</strong>：虽然 <code>log_destination</code> 在数据库级参数白名单中，但由于其 <code>context</code> 为 <code>sighup</code>，
实际上无法在数据库级别生效。此参数应在实例级（<code>pg_parameters</code>）配置。</p></blockquote><h3 id=查看数据库参数>查看数据库参数</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看特定数据库的参数设置
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>unnest</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>setconfig</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>setting</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_db_role_setting</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_database</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setdatabase</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setrole</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=手动管理>手动管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 设置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>search_path</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;$user&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>myschema</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 重置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=用户级参数>用户级参数</h2><p>用户级参数针对特定数据库用户生效，该用户的所有会话都会应用这些参数设置。
通过 <a href=https://www.postgresql.org/docs/current/sql-alterrole.html><strong><code>ALTER USER ... SET</code></strong></a> 实现，同样存储在系统表 <code>pg_db_role_setting</code> 中。</p><h3 id=配置方式-1>配置方式</h3><p>在 <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> 或 <a href=/docs/pgsql/param#pg_default_roles><strong><code>pg_default_roles</code></strong></a> 中使用 <code>parameters</code> 字段定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>256MB                             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 分析查询需要更多内存</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>5min                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 允许较长的查询时间</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#34;$user&#34;, public, analytics&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 列表参数需要引号</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>all                          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 记录所有 SQL</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=参数渲染规则-1>参数渲染规则</h3><p>用户级参数的渲染规则与数据库级参数相同：</p><p><strong>列表类型参数</strong>（<code>search_path</code>、<code>temp_tablespaces</code>、<code>local_preload_libraries</code>、<code>session_preload_libraries</code>）不加外层引号：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;search_path&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;$user&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>标量参数</strong> 使用引号包裹：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_analyst&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=特殊值-default>特殊值 DEFAULT</h3><p>使用 <code>DEFAULT</code>（大小写不敏感）可以将参数重置为 PostgreSQL 默认值：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>30s    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 设置具体值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;work_mem&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbuser_app&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;statement_timeout&#34;</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=查看用户参数>查看用户参数</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看特定用户的参数设置
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>unnest</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>setconfig</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>setting</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_db_role_setting</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>drs</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setrole</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbuser_analyst&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=手动管理-1>手动管理</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 设置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;128MB&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000>search_path</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;$user&#34;</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>myschema</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 重置参数
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#000>work_mem</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>USER</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>RESET</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=参数优先级>参数优先级</h2><p>当同一参数在多个层级设置时，PostgreSQL 按以下优先级应用（从低到高）：</p><pre tabindex=0><code>postgresql.conf           ← 集群级参数（Patroni DCS）
       ↓
postgresql.auto.conf      ← 实例级参数（pg_parameters / ALTER SYSTEM）
       ↓
数据库级                    ← ALTER DATABASE SET
       ↓
用户级                      ← ALTER USER SET
       ↓
会话级                      ← SET 命令
</code></pre><p><strong>关于数据库级与用户级的优先级</strong>：</p><p>当用户连接到特定数据库时，如果同一参数在数据库级和用户级都有设置，
PostgreSQL 会使用 <strong>用户级参数</strong>，因为用户级优先级更高。</p><p><strong>示例场景</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 数据库级：analytics 数据库 work_mem = 256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>analytics</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>256MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 用户级：analyst 用户 work_mem = 512MB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>512MB</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>当 <code>analyst</code> 用户连接到 <code>analytics</code> 数据库时：<code>work_mem = 512MB</code>（用户级优先）</li><li>当其他用户连接到 <code>analytics</code> 数据库时：<code>work_mem = 256MB</code>（数据库级生效）</li><li>当 <code>analyst</code> 用户连接到其他数据库时：<code>work_mem = 512MB</code>（用户级生效）</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-f26623b2f855e9bc5073aeb50aea422a>8 - 访问控制</h1><div class=lead>Pigsty 提供的默认角色系统与权限模型</div><blockquote><p>访问控制由“角色体系 + 权限模板 + HBA”共同决定。本节聚焦于如何通过配置参数声明角色与对象权限。</p></blockquote><p>Pigsty 预置了一套精简的 ACL 模型，全部通过以下参数描述：</p><ul><li><code>pg_default_roles</code>：系统角色与系统用户。</li><li><code>pg_users</code>：业务用户与角色。</li><li><code>pg_default_privileges</code>：管理员/属主新建对象时的默认权限。</li><li><code>pg_revoke_public</code>、<code>pg_default_schemas</code>、<code>pg_default_extensions</code>：控制 <code>template1</code> 的默认行为。</li></ul><p>理解这些参数后，你就可以写出完全可复现的权限配置。</p><hr><h2 id=默认角色体系pg_default_roles>默认角色体系（pg_default_roles）</h2><p>默认包含 4 个业务角色 + 4 个系统用户：</p><table class=full-width><thead><tr><th>名称</th><th>类型</th><th>说明</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td>所有业务共用，拥有 SELECT/USAGE</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>继承只读角色，并拥有 INSERT/UPDATE/DELETE</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>继承 <code>pg_monitor</code> + 读写角色，可建对象和触发器</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td>受限只读角色，仅允许访问离线实例</td></tr><tr><td><code>postgres</code></td><td>用户</td><td>系统超级用户，与 <code>pg_dbsu</code> 同名</td></tr><tr><td><code>replicator</code></td><td>用户</td><td>用于流复制与备份，继承监控与只读权限</td></tr><tr><td><code>dbuser_dba</code></td><td>用户</td><td>主要管理员账号，同时同步到 pgbouncer</td></tr><tr><td><code>dbuser_monitor</code></td><td>用户</td><td>监控账号，具备 <code>pg_monitor</code> 权限，默认记录慢 SQL</td></tr></tbody></table><p>这些定义位于 <code>pg_default_roles</code>，理论上可以自定义，但若要替换名称，必须同步更新 HBA/ACL/脚本中的引用。</p><p>示例：为离线任务额外加一个 <code>dbrole_etl</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_etl, login: false, roles: [dbrole_offline], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;etl read-only role&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, login: false, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pg_monitor, dbrole_readwrite, dbrole_etl] }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：所有继承 <code>dbrole_admin</code> 的用户自动拥有 <code>dbrole_etl</code> 权限，可访问 offline 实例并执行 ETL。</p></blockquote><hr><h2 id=默认用户与凭据参数>默认用户与凭据参数</h2><p>系统用户的用户名/密码由以下参数控制：</p><table class=full-width><thead><tr><th>参数</th><th>默认值</th><th>作用</th></tr></thead><tbody><tr><td><code>pg_dbsu</code></td><td><code>postgres</code></td><td>数据库/系统超级用户</td></tr><tr><td><code>pg_dbsu_password</code></td><td>空字符串</td><td>dbsu 密码（默认不启用）</td></tr><tr><td><code>pg_replication_username</code></td><td><code>replicator</code></td><td>复制用户名称</td></tr><tr><td><code>pg_replication_password</code></td><td><code>DBUser.Replicator</code></td><td>复制用户密码</td></tr><tr><td><code>pg_admin_username</code></td><td><code>dbuser_dba</code></td><td>管理员用户名</td></tr><tr><td><code>pg_admin_password</code></td><td><code>DBUser.DBA</code></td><td>管理员密码</td></tr><tr><td><code>pg_monitor_username</code></td><td><code>dbuser_monitor</code></td><td>监控用户</td></tr><tr><td><code>pg_monitor_password</code></td><td><code>DBUser.Monitor</code></td><td>监控用户密码</td></tr></tbody></table><blockquote><p>如果修改这些参数，请同步在 <code>pg_default_roles</code> 中更新对应用户的定义，以避免角色属性不一致。</p></blockquote><hr><h2 id=业务角色与授权pg_users>业务角色与授权（pg_users）</h2><p>业务用户通过 <code>pg_users</code> 声明（详细字段见 <a href=/docs/pgsql/config/user>用户配置</a>），其中 <code>roles</code> 字段控制授予的业务角色。</p><p>示例：创建只读/读写用户各一名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: app_reader,  password: DBUser.Reader,  roles: [dbrole_readonly],  pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: app_writer,  password: DBUser.Writer,  roles: [dbrole_readwrite], pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>通过继承 <code>dbrole_*</code> 来控制访问权限，无需为每个库单独 GRANT。配合 <a href=/docs/pgsql/config/hba><code>pg_hba_rules</code></a> 即可区分访问来源。</p></blockquote><p>若需要更细粒度的 ACL，可在 <code>baseline</code> SQL 中或后续剧本里使用标准 <code>GRANT/REVOKE</code>。Pigsty 不会阻止你额外授予权限。</p><hr><h2 id=默认权限模板pg_default_privileges>默认权限模板（pg_default_privileges）</h2><p><code>pg_default_privileges</code> 会在 <code>postgres</code>、<code>dbuser_dba</code>、<code>dbrole_admin</code>（业务管理员 <code>SET ROLE</code> 后）上设置 DEFAULT PRIVILEGE。默认模板如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>只要对象由上述管理员创建，就会自动携带对应权限，无需人为执行 GRANT。若业务需要自定义模板，直接替换该数组即可。</p></blockquote><p>额外提示：</p><ul><li><code>pg_revoke_public</code> 默认为 <code>true</code>，意味着自动撤销 <code>PUBLIC</code> 在数据库和 <code>public</code> schema 上的 <code>CREATE</code> 权限。</li><li><code>pg_default_schemas</code> 和 <code>pg_default_extensions</code> 控制在 <code>template1/postgres</code> 中预创建的 schema/扩展，通常用于监控对象（<code>monitor</code> schema、<code>pg_stat_statements</code> 等）。</li></ul><hr><h2 id=常见配置场景>常见配置场景</h2><h3 id=为合作方提供只读账号>为合作方提供只读账号</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>partner_ro</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>Partner.Read</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: partner_ro, db: analytics, addr: 203.0.113.0/24, auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ssl }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>效果：合作方账号登录后只具备默认只读权限，并且只能通过 TLS 从指定网段访问 <code>analytics</code> 库。</p></blockquote><h3 id=为业务管理员赋予-ddl-能力>为业务管理员赋予 DDL 能力</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>app_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.AppAdmin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>业务管理员通过 <code>SET ROLE dbrole_admin</code> 或直接以 <code>app_admin</code> 登录，即可继承默认的 DDL 权限模板。</p></blockquote><h3 id=自定义默认权限>自定义默认权限</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_privileges</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT INSERT,UPDATE,DELETE ON TABLES TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT,UPDATE ON SEQUENCES TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#000>GRANT SELECT ON TABLES TO reporting_group</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>替换默认模板后，所有由管理员创建的对象都会携带新的权限定义，避免逐对象授权。</p></blockquote><hr><h2 id=与其他组件的协同>与其他组件的协同</h2><ul><li><strong>HBA 规则</strong>：使用 <code>pg_hba_rules</code> 将角色与来源进行绑定（例如只让 <code>dbrole_offline</code> 访问离线实例）。</li><li><strong>Pgbouncer</strong>：<code>pgbouncer: true</code> 的用户会被写入 <code>userlist.txt</code>，<code>pool_mode/pool_connlimit</code> 可以控制连接池层面的配额。</li><li><strong>Grafana/监控</strong>：<code>dbuser_monitor</code> 的权限来自 <code>pg_default_roles</code>，如果你新增监控用户，记得赋予 <code>pg_monitor</code> + <code>monitor</code> schema 的访问权。</li></ul><p>通过这些参数，可以让权限体系与代码一起版本化，真正做到“配置即策略”。</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>