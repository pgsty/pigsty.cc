<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/pgsql/admin/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/pgsql/admin/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>日常管理 | PIGSTY</title><meta name=description content="数据库日常管理任务标准操作指南（SOP）"><meta property="og:url" content="https://pigsty.cc/docs/pgsql/admin/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="日常管理"><meta property="og:description" content="数据库日常管理任务标准操作指南（SOP）"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="日常管理"><meta itemprop=description content="数据库日常管理任务标准操作指南（SOP）"><meta itemprop=dateModified content="2026-01-16T00:52:04+08:00"><meta itemprop=keywords content="任务,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="日常管理"><meta name=twitter:description content="数据库日常管理任务标准操作指南（SOP）"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/pgsql/admin/>返回本页常规视图</a>.</p></div><h1 class=title>日常管理</h1><div class=lead>数据库日常管理任务标准操作指南（SOP）</div><ul><li>1: <a href=#pg-17b67ff7274e6ed5025cdb1b71ec35a4>管理 PostgreSQL 数据库集群</a></li><li>2: <a href=#pg-81e255f632d154a2662d19c783c4514a>管理 PostgreSQL 业务用户</a></li><li>3: <a href=#pg-9dd15cada3b5a59a9375eadbdeec7bf7>管理 PostgreSQL 业务数据库</a></li><li>4: <a href=#pg-0cd896e3522e4cf2db0a08ece91619f5>管理 Patroni 高可用</a></li><li>5: <a href=#pg-289eefb8da504803e0c1952004777bb0>Pgbouncer 连接池管理</a></li><li>6: <a href=#pg-ef5d737e5bae0aa77e9e8e5340965fd9>管理 PostgreSQL 组件服务</a></li><li>7: <a href=#pg-d6d9a4c3d54ca40e435a862870043f19>管理 PostgreSQL 定时任务</a></li><li>8: <a href=#pg-fda28727166c3a3a755b7258c9071594>升级 PostgreSQL 大小版本</a></li><li>9: <a href=#pg-2b2e08d4aed2707846688f2a5517519d>管理 PostgreSQL 扩展插件</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-17b67ff7274e6ed5025cdb1b71ec35a4>1 - 管理 PostgreSQL 数据库集群</h1><div class=lead>创建/销毁 PostgreSQL 集群，以及对现有集群进行扩容，缩容，克隆集群。</div><h2 id=速查手册>速查手册</h2><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>创建集群</strong></a></td><td style=text-align:left><code>bin/pgsql-add &lt;cls></code></td><td style=text-align:left>创建新的 PostgreSQL 集群</td></tr><tr><td style=text-align:left><a href=#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4><strong>扩容集群</strong></a></td><td style=text-align:left><code>bin/pgsql-add &lt;cls> &lt;ip...></code></td><td style=text-align:left>为现有集群添加从库副本</td></tr><tr><td style=text-align:left><a href=#%E7%BC%A9%E5%AE%B9%E9%9B%86%E7%BE%A4><strong>缩容集群</strong></a></td><td style=text-align:left><code>bin/pgsql-rm &lt;cls> &lt;ip...></code></td><td style=text-align:left>从集群中移除指定实例</td></tr><tr><td style=text-align:left><a href=#%E9%94%80%E6%AF%81%E9%9B%86%E7%BE%A4><strong>销毁集群</strong></a></td><td style=text-align:left><code>bin/pgsql-rm &lt;cls></code></td><td style=text-align:left>销毁整个 PostgreSQL 集群</td></tr><tr><td style=text-align:left><a href=#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1><strong>刷新服务</strong></a></td><td style=text-align:left><code>bin/pgsql-svc &lt;cls> [ip...]</code></td><td style=text-align:left>重载集群的负载均衡配置</td></tr><tr><td style=text-align:left><a href=#%E5%88%B7%E6%96%B0hba><strong>刷新HBA</strong></a></td><td style=text-align:left><code>bin/pgsql-hba &lt;cls> [ip...]</code></td><td style=text-align:left>重载集群的 HBA 访问规则</td></tr><tr><td style=text-align:left><a href=#%E5%85%8B%E9%9A%86%E9%9B%86%E7%BE%A4><strong>克隆集群</strong></a></td><td style=text-align:left>-</td><td style=text-align:left>通过备份集群或 PITR 克隆</td></tr></tbody></table><p>其他管理任务，请参考：<a href=/docs/pgsql/admin/patroni><strong>高可用管理</strong></a>，<a href=/docs/pgsql/admin/user/><strong>管理用户</strong></a>，<a href=/docs/pgsql/admin/db/><strong>管理数据库</strong></a>。</p><hr><h2 id=创建集群>创建集群</h2><p>要创建一个新的 PostgreSQL 集群，请首先在 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中 <a href=/docs/pgsql/config/cluster><strong>定义集群</strong></a>，然后 <a href=/docs/node/admin#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9><strong>纳管节点</strong></a>并进行初始化：</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-00-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-00-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-00-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add  &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># 添加分组 &lt;cls&gt; 下的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml  -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本添加分组 &lt;cls&gt; 下的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># 例子，添加 pg-test 分组下的节点，实际执行 ./node.yml -l pg-test</span>
</span></span></code></pre></div></div></div><p>在被纳管的节点上，可以使用以下命令创建集群：（针对 <strong><code>&lt;cls></code></strong> 分组执行 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> 剧本）</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-01-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-01-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-01-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add &lt;cls&gt;     <span style=color:#8f5902;font-style:italic># 创建 PostgreSQL 集群 &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本创建 PostgreSQL 集群 &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test   <span style=color:#8f5902;font-style:italic># 例子，创建 pg-test 集群</span>
</span></span></code></pre></div></div></div><p><strong>示例：创建三节点 PG 集群 <code>pg-test</code></strong></p><div id=asciinema-942dc186323899bcee0f4643447fbd01 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-942dc186323899bcee0f4643447fbd01",o="/demo/pgsql.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.3",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[4,"执行"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>针对已经存在的集群重新执行创建存在风险</div><p>如果您在已经存在的集群上重新执行创建操作，Pigsty 不会移除已有的数据文件，但现有服务配置会被覆盖，集群会发生 <strong>重启</strong>！
此外，如果你在 <a href=/docs/pgsql/config/db#baseline><strong>数据库定义</strong></a> 中指定了 <code>baseline</code> SQL ，它也会重新执行，如果里面包含删除/覆盖逻辑，可能会导致 <strong>数据丢失</strong>。</p></div><hr><h2 id=扩容集群>扩容集群</h2><p>若要将新从库添加到 <strong>现有的 PostgreSQL 集群</strong> 中，您需要将 <a href=/docs/pgsql/config/cluster><strong>实例定义</strong></a> 添加到 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a>：<code>all.children.&lt;cls>.hosts</code> 中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 已存在的成员</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 已存在的成员</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 新成员</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>扩容集群的操作与 <a href=#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>创建集群</strong></a> 非常类似，首先需要将扩容的节点纳入 Pigsty 管理：<a href=/docs/node/admin#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9><strong>添加节点</strong></a>：</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-04-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-04-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-04-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add &lt;ip&gt;       <span style=color:#8f5902;font-style:italic># 添加 IP 地址为 &lt;ip&gt; 的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -l &lt;ip&gt;      <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本添加 &lt;ip&gt; 对应的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-add 10.10.10.13    <span style=color:#8f5902;font-style:italic># 例子，添加 IP 为 10.10.10.13 的节点，实际执行 ./node.yml -l 10.10.10.13</span>
</span></span></code></pre></div></div></div><p>然后在新节点上运行以下命令以扩容集群（针对新节点安装 <a href=/docs/pgsql><strong>PGSQL 模块</strong></a>，使用与现有集群相同的 <a href=/docs/pgsql/param#pg_cluster><strong><code>pg_cluster</code></strong></a>）</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-05-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-05-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-05-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add &lt;cls&gt; &lt;ip&gt;  <span style=color:#8f5902;font-style:italic># 添加 IP 地址为 &lt;ip&gt; 的节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;       <span style=color:#8f5902;font-style:italic># 核心逻辑：使用 Ansible 剧本在 &lt;ip&gt; 节点上安装 PGSQL 模块</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test 10.10.10.13   <span style=color:#8f5902;font-style:italic># 示例，为 pg-test 集群扩容 IP 为 10.10.10.13 的节点</span>
</span></span></code></pre></div></div></div><p>扩容完成后，您应当 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1><strong>刷新服务</strong></a> 以将新成员添加至负载均衡器中以实际承载流量。</p><p><strong>示例：为两节点集群 <code>pg-test</code> 扩容一个新从库 <code>10.10.10.13</code></strong></p><div id=asciinema-05fce5eacdeb3446795df8299bfa61bb class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-05fce5eacdeb3446795df8299bfa61bb",o="/demo/pgsql-append.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=缩容集群>缩容集群</h2><p>若要从 <strong>现有的 PostgreSQL 集群</strong> 中移除副本，您需要从 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 的 <code>all.children.&lt;cls>.hosts</code> 中移除对应的 <a href=/docs/pgsql/config/cluster><strong>实例定义</strong></a>。</p><p>缩容集群首先需要卸载目标节点上的 PGSQL 模块（针对 <strong><code>&lt;ip></code></strong> 执行 <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> 剧本）：</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-07-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-07-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-07-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm &lt;cls&gt; &lt;ip&gt;   <span style=color:#8f5902;font-style:italic># 从集群 &lt;cls&gt; 中移除 &lt;ip&gt; 节点上的 PostgreSQL 实例</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;ip&gt;    <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本移除 &lt;ip&gt; 节点上的 PostgreSQL 实例</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-test 10.10.10.13  <span style=color:#8f5902;font-style:italic># 例子，从 pg-test 集群移除 10.10.10.13 节点</span>
</span></span></code></pre></div></div></div><p>移除 PGSQL 模块后，您可以选择将节点从 Pigsty 管理中移除：<a href=/docs/node/admin#%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9><strong>移除节点</strong></a>（可选）：</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-08-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-08-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-08-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm &lt;ip&gt;          <span style=color:#8f5902;font-style:italic># 从 Pigsty 管理中移除 &lt;ip&gt; 节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node-rm.yml -l &lt;ip&gt;     <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本从 Pigsty 管理中移除 &lt;ip&gt; 节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm 10.10.10.13   <span style=color:#8f5902;font-style:italic># 例子，从 Pigsty 管理中移除 10.10.10.13 节点</span>
</span></span></code></pre></div></div></div><p>缩容完成后，您应当从 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中移除该实例的定义，然后 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1><strong>刷新服务</strong></a> 以将已它从负载均衡器中踢除。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 执行后移除此行</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>示例：从三节点集群 <code>pg-test</code> 中缩容一个从库 <code>10.10.10.13</code></strong></p><div id=asciinema-89bfaa9d26b25502fcaa59352090b5f0 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-89bfaa9d26b25502fcaa59352090b5f0",o="/demo/pgsql-shrink.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=销毁集群>销毁集群</h2><p>销毁集群需要在集群的所有节点上卸载 PGSQL 模块（针对 <strong><code>&lt;cls></code></strong> 执行 <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> 剧本）：</p><ul class="nav nav-tabs" id=tabs-10 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-10-00-tab data-bs-toggle=tab data-bs-target=#tabs-10-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-10-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-10-01-tab data-bs-toggle=tab data-bs-target=#tabs-10-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-10-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-10-02-tab data-bs-toggle=tab data-bs-target=#tabs-10-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-10-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-10-content><div class="tab-body tab-pane fade show active" id=tabs-10-00 role=tabpanel aria-labelled-by=tabs-10-00-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm &lt;cls&gt;        <span style=color:#8f5902;font-style:italic># 销毁整个 PostgreSQL 集群 &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-01 role=tabpanel aria-labelled-by=tabs-10-01-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本销毁整个 PostgreSQL 集群 &lt;cls&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-10-02 role=tabpanel aria-labelled-by=tabs-10-02-tab tabindex=10><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-rm pg-test      <span style=color:#8f5902;font-style:italic># 例子，销毁 pg-test 集群</span>
</span></span></code></pre></div></div></div><p>销毁 PGSQL 模块后，您可以选择将节点一并从 Pigsty 管理中移除：<a href=/docs/node/admin#%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9><strong>移除节点</strong></a>（可选，如果还有其他服务可以保留）：</p><ul class="nav nav-tabs" id=tabs-11 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-11-00-tab data-bs-toggle=tab data-bs-target=#tabs-11-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-11-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-11-01-tab data-bs-toggle=tab data-bs-target=#tabs-11-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-11-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-11-02-tab data-bs-toggle=tab data-bs-target=#tabs-11-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-11-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-11-content><div class="tab-body tab-pane fade show active" id=tabs-11-00 role=tabpanel aria-labelled-by=tabs-11-00-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm &lt;cls&gt;         <span style=color:#8f5902;font-style:italic># 从 Pigsty 管理中移除 &lt;cls&gt; 分组下的所有节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-01 role=tabpanel aria-labelled-by=tabs-11-01-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node-rm.yml -l &lt;cls&gt;    <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本从 Pigsty 管理中移除 &lt;cls&gt; 分组下的所有节点</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-11-02 role=tabpanel aria-labelled-by=tabs-11-02-tab tabindex=11><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/node-rm pg-test       <span style=color:#8f5902;font-style:italic># 例子，从 Pigsty 管理中移除 pg-test 分组下的所有节点</span>
</span></span></code></pre></div></div></div><p>销毁结束后，建议及时从 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中移除整个 <a href=/docs/pgsql/config/cluster><strong>集群定义</strong></a>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 清理这个集群定义分组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>示例：销毁三节点 PG 集群 <code>pg-test</code></strong></p><div id=asciinema-4b148718963c7bab646e97087cabccda class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-4b148718963c7bab646e97087cabccda",o="/demo/pgsql-rm.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><p>注意：如果为这个集群配置了 <a href=/docs/pgsql/param#pg_safeguard><strong><code>pg_safeguard</code></strong></a>（或全局设置为 <code>true</code>），<code>pgsql-rm.yml</code> 将中止执行，以避免意外销毁集群。
您可以使用剧本命令行参数明确地覆盖它，以强制执行销毁。
此外默认情况下，集群的备份仓库将同集群一并删除。如果你希望保留备份（例如在使用集中式备份仓库时），可以设置 <a href=/docs/pgsql/param#pg_rm_backup><strong><code>pg_rm_backup=false</code></strong></a> 参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l pg-meta -e <span style=color:#000>pg_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># 强制销毁受保护的 pg 集群 pg-meta</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l pg-meta -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>    <span style=color:#8f5902;font-style:italic># 在销毁集群过程中保留其备份仓库</span>
</span></span></code></pre></div><hr><h2 id=刷新服务>刷新服务</h2><p>PostgreSQL 集群通过主机节点上的 <a href=/docs/concept/arch/pgsql#haproxy><strong>HAProxy</strong></a> 对外提供 <a href=/docs/pgsql/service/><strong>服务</strong></a>。
当服务定义变化，实例权重变化，或者集群成员发生变化时（例如，集群 <a href=#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4><strong>扩容</strong></a> / <a href=#%E7%BC%A9%E5%AE%B9%E9%9B%86%E7%BE%A4><strong>缩容</strong></a>，主从切换／故障转移），您需要择机刷新服务以更新负载均衡器的配置。</p><p>要在整个集群或特定实例上刷新服务配置（针对 <strong><code>&lt;cls></code></strong> 或 <strong><code>&lt;ip></code></strong> 执行 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> 的 <code>pg_service</code> 子任务）：</p><ul class="nav nav-tabs" id=tabs-13 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-13-00-tab data-bs-toggle=tab data-bs-target=#tabs-13-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-13-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-13-01-tab data-bs-toggle=tab data-bs-target=#tabs-13-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-13-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-13-02-tab data-bs-toggle=tab data-bs-target=#tabs-13-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-13-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-13-content><div class="tab-body tab-pane fade show active" id=tabs-13-00 role=tabpanel aria-labelled-by=tabs-13-00-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># 刷新整个集群 &lt;cls&gt; 的服务配置</span>
</span></span><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; &lt;ip...&gt;   <span style=color:#8f5902;font-style:italic># 刷新集群 &lt;cls&gt; 中指定实例的服务配置</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-13-01 role=tabpanel aria-labelled-by=tabs-13-01-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_service -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>        <span style=color:#8f5902;font-style:italic># 刷新整个集群的服务配置</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;  -t pg_service -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>        <span style=color:#8f5902;font-style:italic># 刷新指定实例的服务配置</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-13-02 role=tabpanel aria-labelled-by=tabs-13-02-tab tabindex=13><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc pg-test                 <span style=color:#8f5902;font-style:italic># 例子，刷新 pg-test 集群的服务配置</span>
</span></span><span style=display:flex><span>bin/pgsql-svc pg-test 10.10.10.13     <span style=color:#8f5902;font-style:italic># 例子，刷新 pg-test 集群中 10.10.10.13 实例的服务配置</span>
</span></span></code></pre></div></div></div><blockquote><p>备注：如果您使用集中式的专用负载均衡集群（<a href=/docs/pgsql/param#pg_service_provider><strong><code>pg_service_provider</code></strong></a>），那么只有刷新集群主库时才会更新负载均衡配置。</p></blockquote><p><strong>示例：刷新集群 <code>pg-test</code> 的服务配置</strong></p><div id=asciinema-d04ae8e428be2e84e61f51c21cb4556e class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-d04ae8e428be2e84e61f51c21cb4556e",o="/demo/pgsql-svc.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><details><summary>示例：重载PG服务以踢除一个实例</summary><p><a href=https://asciinema.org/a/568815><img src=https://asciinema.org/a/568815.svg alt=asciicast></a></p></details><hr><h2 id=刷新hba>刷新HBA</h2><p>当您修改了 HBA 相关配置后，需要刷新 HBA 规则以应用更改。（<a href=/docs/pgsql/param#pg_hba_rules><strong><code>pg_hba_rules</code></strong></a> / <a href=/docs/pgsql/param#pgb_hba_rules><strong><code>pgb_hba_rules</code></strong></a>）
如果您有任何特定于角色的 HBA 规则，或者在 IP 地址段中引用了集群成员的别名，那么当主从切换/集群扩缩容后也可能需要刷新 HBA。</p><p>要在整个集群或特定实例上刷新 PG 和 Pgbouncer 的 HBA 规则（针对 <strong><code>&lt;cls></code></strong> 或 <strong><code>&lt;ip></code></strong> 执行 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> 的 HBA 相关子任务）：</p><ul class="nav nav-tabs" id=tabs-15 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-15-00-tab data-bs-toggle=tab data-bs-target=#tabs-15-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-15-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-15-01-tab data-bs-toggle=tab data-bs-target=#tabs-15-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-15-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-15-02-tab data-bs-toggle=tab data-bs-target=#tabs-15-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-15-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-15-content><div class="tab-body tab-pane fade show active" id=tabs-15-00 role=tabpanel aria-labelled-by=tabs-15-00-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># 刷新整个集群 &lt;cls&gt; 的 HBA 规则</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; &lt;ip...&gt;   <span style=color:#8f5902;font-style:italic># 刷新集群 &lt;cls&gt; 中指定实例的 HBA 规则</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-15-01 role=tabpanel aria-labelled-by=tabs-15-01-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>   <span style=color:#8f5902;font-style:italic># 刷新整个集群</span>
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;ip&gt;  -t pg_hba,pg_reload,pgbouncer_hba,pgbouncer_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>   <span style=color:#8f5902;font-style:italic># 刷新指定实例</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-15-02 role=tabpanel aria-labelled-by=tabs-15-02-tab tabindex=15><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba pg-test                 <span style=color:#8f5902;font-style:italic># 例子，刷新 pg-test 集群的 HBA 规则</span>
</span></span><span style=display:flex><span>bin/pgsql-hba pg-test 10.10.10.13     <span style=color:#8f5902;font-style:italic># 例子，刷新 pg-test 集群中 10.10.10.13 实例的 HBA 规则</span>
</span></span></code></pre></div></div></div><p><strong>示例：刷新集群 <code>pg-test</code> 的 HBA 规则</strong></p><div id=asciinema-ff9b13ed062434f2b3b348cc9909ad10 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ff9b13ed062434f2b3b348cc9909ad10",o="/demo/pgsql-hba.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=配置集群>配置集群</h2><p>PostgreSQL 的配置参数由 Patroni 管理，初始参数由 <a href=/docs/pgsql/template/><strong>Patroni 配置模板</strong></a> 指定。
集群初始化之后，配置存储在 Etcd 中，并由 Patroni 进行动态管理，并在集群中同步与共享。
Patroni 本身的 <a href=/docs/pgsql/admin/patroni#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong>配置参数</strong></a> 大部分可以通过 <code>patronictl</code>命令行工具修改。
其余参数（例如，etcd DCS 配置，日志/RestAPI 等配置）则可以通过下面的子任务进行更新。例如，当 <a href=/docs/etcd><strong>etcd</strong></a> 集群成员发生变动时，你可以刷新 Patroni 配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-test -t pg_conf                   <span style=color:#8f5902;font-style:italic># 更新 Patroni 配置文件</span>
</span></span><span style=display:flex><span>ansible pg-test -b -a <span style=color:#4e9a06>&#39;systemctl reload patroni&#39;</span>    <span style=color:#8f5902;font-style:italic># 重载 Patroni 服务</span>
</span></span></code></pre></div><p>您可以在不同层次上覆盖 Patroni 集中管理的默认，例如单独 <a href=/docs/pgsql/param#pg_parameters><strong>为实例指定配置参数</strong></a>；
单独为 <a href=/docs/pgsql/admin/user><strong>为用户指定配置参数</strong></a>，或者 <a href=/docs/pgsql/admin/db><strong>为数据库指定配置参数</strong></a>。</p><hr><h2 id=克隆集群>克隆集群</h2><p>有两种克隆集群的方式：使用 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4><strong>备份集群</strong></a> 功能，或者使用 <a href=/docs/pgsql/backup/restore#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B><strong>时间点恢复</strong></a> 功能。
前者配置简单，无需依赖，但只能克隆指定集群的最新状态；后者依赖集中式的 <a href=/docs/pgsql/backup/repository><strong>备份仓库</strong></a>（例如 MinIO），但可以克隆到备份保留期内的任意时间点。</p><table><thead><tr><th style=text-align:left>方式</th><th style=text-align:left>优点</th><th style=text-align:left>缺点</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:left>备份集群</td><td style=text-align:left>配置简单，无需依赖</td><td style=text-align:left>只能克隆最新状态</td><td style=text-align:left>灾备，读写分离，迁移</td></tr><tr><td style=text-align:left>PITR</td><td style=text-align:left>可恢复到任意时间点</td><td style=text-align:left>依赖集中式备份仓库</td><td style=text-align:left>误操作恢复，数据审计</td></tr></tbody></table><h3 id=使用备份集群克隆>使用备份集群克隆</h3><p>备份集群（Standby Cluster）通过流复制从上游集群持续同步数据，是克隆集群最简单的方式。
只需在新集群主库上指定 <a href=/docs/pgsql/param#pg_upstream><strong><code>pg_upstream</code></strong></a> 参数，即可自动从上游集群拉取数据。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test 是原始集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pg-test2 是 pg-test 的备份集群（克隆）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary, pg_upstream</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.11</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 指定上游</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test2 }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用以下命令创建备份集群：</p><ul class="nav nav-tabs" id=tabs-17 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-17-00-tab data-bs-toggle=tab data-bs-target=#tabs-17-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-17-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-17-01-tab data-bs-toggle=tab data-bs-target=#tabs-17-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-17-01 aria-selected=false>
剧本</button></li></ul><div class=tab-content id=tabs-17-content><div class="tab-body tab-pane fade show active" id=tabs-17-00 role=tabpanel aria-labelled-by=tabs-17-00-tab tabindex=17><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-test2    <span style=color:#8f5902;font-style:italic># 创建备份集群，自动从上游 pg-test 克隆数据</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-17-01 role=tabpanel aria-labelled-by=tabs-17-01-tab tabindex=17><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-test2   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本创建备份集群</span>
</span></span></code></pre></div></div></div><p>备份集群会持续追随上游集群，保持数据同步。您可以随时将其 <strong>提升</strong> 为独立集群：</p><details><summary>示例：提升备份集群为独立集群</summary><p>通过 <a href=#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4><strong>配置集群</strong></a> 擦除 <code>standby_cluster</code> 配置段，即可将备份集群提升为独立集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>-standby_cluster:
</span></span><span style=display:flex><span>-  create_replica_methods:
</span></span><span style=display:flex><span>-  - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11
</span></span><span style=display:flex><span>-  port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div><p>提升后，<code>pg-test2</code> 将成为可以独立承载写入请求的独立集群，与原集群 <code>pg-test</code> 分叉。</p></details><details><summary>示例：更改复制上游</summary><p>如果上游集群发生主从切换，您可以通过 <a href=#%E9%85%8D%E7%BD%AE%E9%9B%86%E7%BE%A4><strong>配置集群</strong></a> 更改备份集群的复制上游：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg edit-config pg-test2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> standby_cluster:
</span></span><span style=display:flex><span>   create_replica_methods:
</span></span><span style=display:flex><span>   - basebackup
</span></span><span style=display:flex><span>-  host: 10.10.10.11     <span style=color:#8f5902;font-style:italic># &lt;--- 旧的上游</span>
</span></span><span style=display:flex><span>+  host: 10.10.10.14     <span style=color:#8f5902;font-style:italic># &lt;--- 新的上游</span>
</span></span><span style=display:flex><span>   port: <span style=color:#0000cf;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Apply these changes? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span></code></pre></div></details><h3 id=使用-pitr-克隆>使用 PITR 克隆</h3><p><a href=/docs/pgsql/backup/restore><strong>时间点恢复</strong></a>（PITR）允许您将集群恢复到备份保留期内的任意时间点。
此方式依赖集中式的 <a href=/docs/pgsql/backup/repository><strong>备份仓库</strong></a>（如 MinIO/S3），但功能更加强大。</p><p>要使用 PITR 克隆集群，在配置中添加 <a href=/docs/pgsql/backup/restore#pitr-%E5%8F%82%E6%95%B0%E5%AE%9A%E4%B9%89><strong><code>pg_pitr</code></strong></a> 参数指定恢复目标：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从 pg-meta 集群的备份克隆一个新集群 pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 从 pg-meta 的备份恢复</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-01-10 10:00:00+00&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># 恢复到指定时间点</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用 <code>pgsql-pitr.yml</code> 剧本执行克隆：</p><ul class="nav nav-tabs" id=tabs-18 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-18-00-tab data-bs-toggle=tab data-bs-target=#tabs-18-00 role=tab data-td-tp-persist=剧本 aria-controls=tabs-18-00 aria-selected=true>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-18-01-tab data-bs-toggle=tab data-bs-target=#tabs-18-01 role=tab data-td-tp-persist=命令行 aria-controls=tabs-18-01 aria-selected=false>
命令行</button></li></ul><div class=tab-content id=tabs-18-content><div class="tab-body tab-pane fade show active" id=tabs-18-00 role=tabpanel aria-labelled-by=tabs-18-00-tab tabindex=18><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2    <span style=color:#8f5902;font-style:italic># 从 pg-meta 备份克隆 pg-meta2</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-18-01 role=tabpanel aria-labelled-by=tabs-18-01-tab tabindex=18><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 也可以通过命令行参数指定 PITR 选项</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: {&#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-01-10 10:00:00+00&#34;}}&#39;</span>
</span></span></code></pre></div></div></div><p>PITR 支持多种恢复目标类型：</p><table><thead><tr><th style=text-align:left>目标类型</th><th style=text-align:left>参数示例</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>时间点</td><td style=text-align:left><code>time: "2025-01-10 10:00:00+00"</code></td><td style=text-align:left>恢复到指定时间戳</td></tr><tr><td style=text-align:left>事务ID</td><td style=text-align:left><code>xid: "250000"</code></td><td style=text-align:left>恢复到指定事务之前/之后</td></tr><tr><td style=text-align:left>恢复点</td><td style=text-align:left><code>name: "before_migration"</code></td><td style=text-align:left>恢复到命名恢复点</td></tr><tr><td style=text-align:left>LSN</td><td style=text-align:left><code>lsn: "0/4001C80"</code></td><td style=text-align:left>恢复到指定 WAL 位置</td></tr><tr><td style=text-align:left>最新</td><td style=text-align:left><code>type: "latest"</code></td><td style=text-align:left>恢复到 WAL 归档末尾</td></tr></tbody></table><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>PITR 恢复后处理</div><p>恢复后的集群会<strong>禁用</strong> <code>archive_mode</code>，以防止意外的 WAL 写入覆盖归档。
如果恢复后的数据库状态正常，您应当启用归档并执行新的全量备份：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode; SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>pg-backup full    <span style=color:#8f5902;font-style:italic># 执行新的全量备份</span>
</span></span></code></pre></div></div><p>更多 PITR 的详细用法，请参考 <a href=/docs/pgsql/backup/restore><strong>恢复操作</strong></a> 文档。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-81e255f632d154a2662d19c783c4514a>2 - 管理 PostgreSQL 业务用户</h1><div class=lead>用户管理：创建、修改、删除用户，管理角色成员关系，连接池用户配置</div><h2 id=快速上手>快速上手</h2><p>Pigsty 使用声明式管理方式，首先在 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中 <a href=/docs/pgsql/config/user><strong>定义用户</strong></a>，然后使用 <code>bin/pgsql-user &lt;cls> &lt;username></code> 创建或修改用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_app, password: &#39;DBUser.App&#39;, pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># &lt;--- 在这里定义用户列表！</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-00-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-00-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-00-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上创建/修改 &lt;username&gt; 用户</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l pg-meta -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_app    <span style=color:#8f5902;font-style:italic># 直接使用剧本在 &lt;cls&gt; 集群上创建/修改 &lt;username&gt; 用户</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上创建/修改 dbuser_app 用户</span>
</span></span></code></pre></div></div></div><p>关于用户定义参数的完整参考，请查阅 <a href=/docs/pgsql/config/user><strong>用户配置</strong></a>。关于用户的访问权限，请参考 <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7><strong>ACL：角色权限</strong></a>。</p><p>请注意，用户的 <code>name</code> 字段在创建后无法修改。如需更改用户名，请先删除原用户，再创建新用户。</p><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7><strong>创建用户</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>创建新的业务用户或角色</td></tr><tr><td style=text-align:left><a href=#%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7><strong>修改用户</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>修改已存在用户的属性</td></tr><tr><td style=text-align:left><a href=#%E5%88%A0%E9%99%A4%E7%94%A8%E6%88%B7><strong>删除用户</strong></a></td><td style=text-align:left><code>bin/pgsql-user &lt;cls> &lt;user></code></td><td style=text-align:left>安全删除用户（需设置 <code>state: absent</code>）</td></tr></tbody></table><div id=asciinema-ea4542a7c787faec4a82af4534ee61d2 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ea4542a7c787faec4a82af4534ee61d2",o="/demo/pgsql-user.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=创建用户>创建用户</h2><p>定义在 <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> 里面的用户会在 PostgreSQL <a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>集群创建</strong></a> 的时候在 <code>pg_user</code> 任务中自动创建。</p><p>要在现有的 PostgreSQL 集群上创建新的业务用户，请将 <a href=/docs/pgsql/config/user><strong>用户定义</strong></a> 添加到 <code>all.children.&lt;cls>.pg_users</code>，然后执行：</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-02-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-02-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-02-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;   <span style=color:#8f5902;font-style:italic># 创建用户 &lt;username&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;username&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本创建用户</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># 例子，在 pg-meta 集群中创建 dbuser_app 用户</span>
</span></span></code></pre></div></div></div><p><strong>示例配置：创建名为 <code>dbuser_app</code> 的业务用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars.pg_users: # 省略上级缩进</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>application user for myapp</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>执行效果</strong>：在主库上创建用户 <code>dbuser_app</code>，设置密码，授予 <code>dbrole_readwrite</code> 角色权限，
将用户添加到 Pgbouncer 连接池，在每个实例上重载 Pgbouncer 配置使其立即生效。</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>建议使用剧本创建用户</div><p>如果您需要手工创建用户，那么需要自行确保 Pgbouncer 连接池用户列表同步。</p></div><hr><h2 id=修改用户>修改用户</h2><p>修改用户与创建用户使用相同的命令，剧本是幂等的。当目标用户已存在时，Pigsty 会修改目标用户的属性使其符合配置。</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-04-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-04-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-04-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;user&gt;   <span style=color:#8f5902;font-style:italic># 修改用户 &lt;user&gt; 的属性</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;user&gt;   <span style=color:#8f5902;font-style:italic># 幂等操作，可重复执行</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_app    <span style=color:#8f5902;font-style:italic># 修改 dbuser_app 用户的属性使其符合配置</span>
</span></span></code></pre></div></div></div><p><strong>不可修改的属性</strong>：用户的 <code>name</code>（名称）在创建后无法修改，需要先删除再创建。</p><p>其他属性均可修改，以下是一些常见的修改示例：</p><p><strong>修改密码</strong>：更新配置中的 <code>password</code> 字段后执行剧本。密码修改时会临时禁用日志记录，避免密码泄露到日志中。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>NewSecretPassword    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 修改密码</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>修改权限属性</strong>：通过配置相应的布尔标志来修改用户权限。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 超级用户（谨慎使用！）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 允许创建数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 允许创建角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 自动继承角色权限</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 允许流复制连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 绕过行级安全策略</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 限制连接数，-1 不限制</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>修改用户有效期</strong>：使用 <code>expire_in</code> 设置相对过期时间（N 天后过期），或 <code>expire_at</code> 设置绝对过期日期。<code>expire_in</code> 优先级更高，每次执行剧本时会重新计算，适合需要定期续期的临时用户。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 30 天后过期（相对时间）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>contractor_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2024-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 指定日期过期（绝对时间）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>permanent_user</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;infinity&#39;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 永不过期</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>修改角色成员关系</strong>：通过 <code>roles</code> 数组配置角色成员关系，支持简单格式和扩展格式。角色成员关系是增量操作，不会移除未声明的现有角色。使用 <code>state: absent</code> 可以显式撤销角色。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单形式：授予角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 带 ADMIN OPTION（可以将此角色授予其他用户）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set: false }      # PG16+</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>不允许 SET ROLE</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: old_role, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 撤销角色成员关系</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理用户参数</strong>：通过 <code>parameters</code> 字典配置用户级参数，会生成 <code>ALTER USER ... SET</code> 语句。使用特殊值 <code>DEFAULT</code> 可将参数重置为 PostgreSQL 默认值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_analyst</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;5min&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;analytics,public&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>连接池配置</strong>：设置 <code>pgbouncer: true</code> 将用户添加到连接池，可选配置 <code>pool_mode</code>（池化模式：transaction/session/statement）和 <code>pool_connlimit</code>（用户最大连接数）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 添加到连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 池化模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 用户最大连接数</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=删除用户>删除用户</h2><p>要删除用户，将其 <code>state</code> 设置为 <code>absent</code> 并执行剧本：</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-05-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-05-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-05-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;user&gt;   <span style=color:#8f5902;font-style:italic># 删除用户 &lt;user&gt;（需在配置中设置 state: absent）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-user.yml -l &lt;cls&gt; -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;user&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本删除用户</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user pg-meta dbuser_old    <span style=color:#8f5902;font-style:italic># 删除 dbuser_old 用户（配置中已设置 state: absent）</span>
</span></span></code></pre></div></div></div><p><strong>配置示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_old</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>删除操作会</strong>：使用 <code>pg-drop-role</code> 脚本安全删除用户，自动禁用用户登录并终止活跃连接，自动转移数据库/表空间所有权到 <code>postgres</code>，自动处理所有数据库中的对象所有权和权限，撤销所有角色成员关系，创建审计日志，从 Pgbouncer 用户列表中移除并重载配置。</p><p><strong>保护机制</strong>：以下系统用户无法删除，会被自动跳过：<code>postgres</code>（超级用户）、<code>replicator</code>（或 <a href=/docs/pgsql/param#pg_replication_username><strong><code>pg_replication_username</code></strong></a> 配置的用户）、<code>dbuser_dba</code>（或 <a href=/docs/pgsql/param#pg_admin_username><strong><code>pg_admin_username</code></strong></a> 配置的用户）、<code>dbuser_monitor</code>（或 <a href=/docs/pgsql/param#pg_monitor_username><strong><code>pg_monitor_username</code></strong></a> 配置的用户）。</p><div class="alert alert-primary" role=alert><div class="h4 alert-heading" role=heading>安全删除</div><p>Pigsty 使用 <code>pg-drop-role</code> 脚本安全删除用户，该脚本会自动处理用户拥有的数据库、表空间、Schema、表等对象，自动终止用户的活跃连接，将对象所有权转移给 <code>postgres</code> 用户，并在 <code>/tmp/pg_drop_role_&lt;user>_&lt;timestamp>.log</code> 创建审计日志。无需手动处理依赖对象。</p></div><hr><h2 id=手工删除用户>手工删除用户</h2><p>如果需要手动删除用户，可以直接使用 <code>pg-drop-role</code> 脚本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 检查依赖关系（只读操作）</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --check
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 预览删除操作（不实际执行）</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --dry-run -v
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 删除用户，转移对象给 postgres</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 强制删除（终止活跃连接）</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 删除用户，转移对象给指定用户</span>
</span></span><span style=display:flex><span>pg-drop-role dbuser_old dbuser_new
</span></span></code></pre></div><hr><h2 id=常见用例>常见用例</h2><p>下面是一些常见的用户配置示例：</p><p><strong>创建基本业务用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readwrite]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>application user</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建只读用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建管理员用户（可执行 DDL）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>log_statement</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建临时用户（30天后过期）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>temp_contractor</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>TempPassword</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>30</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_readonly]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建角色（不可登录，用于权限分组）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom_role</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>custom role for special permissions</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>创建带高级角色选项的用户（PG16+）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Special</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin, admin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_monitor, set</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_execute_server_program, inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=查询用户>查询用户</h2><p>以下是一些常用的 SQL 查询，用于查看用户信息：</p><p><strong>查看所有用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolsuper</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolinherit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolcreaterole</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolcreatedb</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>       </span><span style=color:#000>rolcanlogin</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolreplication</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolbypassrls</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolconnlimit</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>LIKE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pg_%&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看用户的角色成员关系</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>member</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>admin_option</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>set_option</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>inherit_option</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_auth_members</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>member</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>g</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>m</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>roleid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>rolname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;dbuser_app&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看用户级参数设置</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>setconfig</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_db_role_setting</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>r</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setrole</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>s</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>setdatabase</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看即将过期的用户</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>rolname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>time_remaining</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_roles</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CURRENT_TIMESTAMP</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#f8f8f8> </span><span style=color:#204a87>INTERVAL</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30 days&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>rolvaliduntil</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=连接池管理>连接池管理</h2><p>在用户定义中配置的 <a href=/docs/pgsql/config/user#pgbouncer><strong>连接池参数</strong></a> 会在创建/修改用户时应用到 Pgbouncer 连接池中。</p><p>设置 <code>pgbouncer: true</code> 的用户会被添加到 <code>/etc/pgbouncer/userlist.txt</code> 文件中。用户级别的连接池参数（<code>pool_mode</code>、<code>pool_connlimit</code>）通过 <code>/etc/pgbouncer/useropts.txt</code> 文件配置。</p><p>您可以使用 <code>postgres</code> 操作系统用户，使用 <code>pgb</code> 别名访问 Pgbouncer 管理数据库。更多连接池管理操作，请参考 <a href=/docs/pgsql/admin/pgbouncer><strong>Pgbouncer 管理</strong></a>。</p><hr><h2 id=管理默认用户密码>管理默认用户密码</h2><p>要修改普通用户的密码， 按照上面 <a href=#%E4%BF%AE%E6%94%B9%E7%94%A8%E6%88%B7><strong>修改用户</strong></a> 的说明，更新配置中的 <code>password</code> 字段并执行剧本即可。
不过修改 <strong>默认用户</strong> 的密码会稍微复杂一些，因为它们的密码还在多个地方被其他服务引用。</p><table class=full-width><thead><tr><th style=text-align:left>参数</th><th style=text-align:left>默认值</th><th style=text-align:left>对应用户</th><th style=text-align:left>用途</th></tr></thead><tbody><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_admin_password><strong><code>pg_admin_password</code></strong></a></td><td style=text-align:left><code>DBUser.DBA</code></td><td style=text-align:left><code>dbuser_dba</code></td><td style=text-align:left>管理员用户密码</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_monitor_password><strong><code>pg_monitor_password</code></strong></a></td><td style=text-align:left><code>DBUser.Monitor</code></td><td style=text-align:left><code>dbuser_monitor</code></td><td style=text-align:left>监控用户密码</td></tr><tr><td style=text-align:left><a href=/docs/pgsql/param#pg_replication_password><strong><code>pg_replication_password</code></strong></a></td><td style=text-align:left><code>DBUser.Replicator</code></td><td style=text-align:left><code>replicator</code></td><td style=text-align:left>复制用户密码</td></tr></tbody></table><p>要修改 <a href=/docs/pgsql/param#pg_admin_password><strong><code>pg_admin_password</code></strong></a>，请执行以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 1: 修改配置文件中的密码 pg_admin_password 后（重要！），通过剧本批量修改密码</span>
</span></span><span style=display:flex><span>./pgsql-user.yml -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_dba -e <span style=color:#4e9a06>&#39;{&#34;pg_users&#34;:[{&#34;name&#34;:&#34;dbuser_dba&#34;,&#34;password&#34;:&#34;NewPass123&#34;}]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 2: 更新所有 PG 节点的 patroni 配置文件与 .pgpass，然后重载 patroni 配置</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_conf,pg_pass,patroni_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 3: 刷新 /infra/env/.pgpass 以及 /infra/conf/pg_service.conf 对管理员密码的引用</span>
</span></span><span style=display:flex><span>./infra.yml -t env_pgpass,env_pg_service
</span></span></code></pre></div><p>要修改 <a href=/docs/pgsql/param#pg_monitor_password><strong><code>pg_monitor_password</code></strong></a>，请执行以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 1: 修改配置文件中的密码 pg_monitor_password 后（重要！），通过剧本批量修改密码</span>
</span></span><span style=display:flex><span>./pgsql-user.yml -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>dbuser_monitor -e <span style=color:#4e9a06>&#39;{&#34;pg_users&#34;:[{&#34;name&#34;:&#34;dbuser_monitor&#34;,&#34;password&#34;:&#34;NewPass123&#34;}]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 2: 更新所有 PG 节点的 patroni 配置文件与 .pgpass，然后重载 patroni 配置</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_conf,pg_pass,patroni_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 3: 刷新 pg_exporter 与 pgbouncer_exporter 配置里面使用的密码，更新 Grafana 监控面板中数据源使用的密码</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_exporter,pgbouncer_exporter,add_ds
</span></span></code></pre></div><p>要修改 <a href=/docs/pgsql/param#pg_replication_password><strong><code>pg_replication_password</code></strong></a>，请执行以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 1: 修改配置文件中的密码 pg_replication_password 后（重要！），通过剧本批量修改密码</span>
</span></span><span style=display:flex><span>./pgsql-user.yml -e <span style=color:#000>username</span><span style=color:#ce5c00;font-weight:700>=</span>replicator -e <span style=color:#4e9a06>&#39;{&#34;pg_users&#34;:[{&#34;name&#34;:&#34;replicator&#34;,&#34;password&#34;:&#34;NewPass123&#34;}]}&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 2: 更新所有 PG 节点的 patorni 配置文件与 .pgpass，然后重载 patroni 配置</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_conf,pg_pass,patroni_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 3: 更新 Infra 节点的 .pgpass</span>
</span></span><span style=display:flex><span>./infra.yml -t env_pgpass
</span></span></code></pre></div><p>此外，Patroni 本身 RestAPI 的密码 <a href=/docs/pgsql/param#patroni_password><strong><code>patroni_password</code></strong></a> 可以通过以下命令进行修改：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 1: 刷新 patroni 配置文件里面配置的密码，并重载 patroni 配置应用生效</span>
</span></span><span style=display:flex><span>./pgsql.yml -t pg_conf,patroni_reload -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Step 2: 刷新 /infra/conf/patronictl.yml 对 patroni 密码的引用</span>
</span></span><span style=display:flex><span>./infra.yml -t env_patroni
</span></span></code></pre></div><blockquote><p>修改前三个密码前，需先用 SQL 修改对应 PostgreSQL 用户的密码：<code>ALTER USER &lt;username> PASSWORD '&lt;new_password>';</code></p></blockquote></div><div class=td-content style=page-break-before:always><h1 id=pg-9dd15cada3b5a59a9375eadbdeec7bf7>3 - 管理 PostgreSQL 业务数据库</h1><div class=lead>数据库管理：创建、修改、删除、重建数据库，使用模板克隆数据库</div><h2 id=快速上手>快速上手</h2><p>Pigsty 使用声明式管理方式，首先在 <a href=/docs/concept/iac/inventory><strong>配置清单</strong></a> 中 <a href=/docs/pgsql/config/db><strong>定义数据库</strong></a>，然后使用 <code>bin/pgsql-db &lt;cls> &lt;dbname></code> 创建或修改数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>some_db }] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 在这里定义数据库列表！</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-00-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-00-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-00-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上创建/修改 &lt;dbname&gt; 数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l pg-meta -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>some_db    <span style=color:#8f5902;font-style:italic># 直接使用剧本在 &lt;cls&gt; 集群上创建/修改 &lt;dbname&gt; 数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta some_db    <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上创建/修改 some_db 数据库</span>
</span></span></code></pre></div></div></div><p>关于数据库定义参数的完整参考，请查阅 <a href=/docs/pgsql/config/db><strong>数据库配置</strong></a>。关于数据库的访问权限，请参考 <a href=/docs/concept/sec/ac/#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9A%94%E7%A6%BB><strong>ACL：数据库权限</strong></a>。</p><p>请注意，部分数据库参数仅能在 <strong>创建时</strong> 指定。修改这些参数需要先删除再创建数据库（使用 <code>state: recreate</code> 重建数据库）。</p><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93><strong>创建数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>创建新的业务数据库</td></tr><tr><td style=text-align:left><a href=#%E4%BF%AE%E6%94%B9%E6%95%B0%E6%8D%AE%E5%BA%93><strong>修改数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>修改已存在数据库的属性</td></tr><tr><td style=text-align:left><a href=#%E5%88%A0%E9%99%A4%E6%95%B0%E6%8D%AE%E5%BA%93><strong>删除数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>删除数据库（需设置 <code>state: absent</code>）</td></tr><tr><td style=text-align:left><a href=#%E9%87%8D%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93><strong>重建数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>先删再建（需设置 <code>state: recreate</code>）</td></tr><tr><td style=text-align:left><a href=#%E5%85%8B%E9%9A%86%E6%95%B0%E6%8D%AE%E5%BA%93><strong>克隆数据库</strong></a></td><td style=text-align:left><code>bin/pgsql-db &lt;cls> &lt;db></code></td><td style=text-align:left>使用模板克隆数据库</td></tr></tbody></table><div id=asciinema-cd66826a3d08fab10d21e9ac82d386f7 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-cd66826a3d08fab10d21e9ac82d386f7",o="/demo/pgsql-db.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=创建数据库>创建数据库</h2><p>定义在 <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> 里面的数据库会在 PostgreSQL <a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>集群创建</strong></a> 的时候在 <code>pg_db</code> 任务中自动创建。</p><p>要在现有的 PostgreSQL 集群上创建新的业务数据库，请将 <a href=/docs/pgsql/config/db><strong>数据库定义</strong></a> 添加到 <code>all.children.&lt;cls>.pg_databases</code>，然后执行：</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-02-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-02-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-02-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;   <span style=color:#8f5902;font-style:italic># 创建数据库 &lt;dbname&gt;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;dbname&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本创建数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta myapp    <span style=color:#8f5902;font-style:italic># 例子，在 pg-meta 集群中创建 myapp 数据库</span>
</span></span></code></pre></div></div></div><p><strong>示例配置：创建名为 <code>myapp</code> 的业务数据库</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars.pg_databases: # 省略上级缩进</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>app]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_trgm }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>btree_gin }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>my application database</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>执行效果</strong>：在主库上创建数据库 <code>myapp</code>，设置数据库所有者为 <code>dbuser_myapp</code>，创建 schema <code>app</code>，
启用扩展 <code>pg_trgm</code> 和 <code>btree_gin</code>，数据库将默认添加到 Pgbouncer 连接池，并注册为 Grafana PG 数据源。</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>建议使用剧本创建数据库</div><p>如果您需要手工创建数据库，那么需要自行确保 pgbouncer 连接池 / grafana 数据源同步。</p></div><hr><h2 id=修改数据库>修改数据库</h2><p>修改数据库与创建数据库使用相同的命令，在没有定义 <code>baseline</code> SQL 的情况下剧本是幂等的。</p><p>当目标数据库已存在时，Pigsty 会修改目标数据库的属性使其符合配置。然而，一些属性只能在数据库创建时设置。</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-04-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-04-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-04-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># 修改数据库 &lt;db&gt; 的属性</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># 幂等操作，可重复执行</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta myapp    <span style=color:#8f5902;font-style:italic># 修改 myapp 数据库的属性使其符合配置</span>
</span></span></code></pre></div></div></div><p><strong>不可修改的属性</strong>：以下属性在数据库创建后无法修改，需要使用 <code>state: recreate</code> 重建数据库：</p><ul><li><code>name</code>（数据库名称）、<code>template</code>（模板数据库）、<code>strategy</code>（克隆策略）。</li><li><code>encoding</code>（字符编码）、<code>locale</code>/<code>lc_collate</code>/<code>lc_ctype</code>（本地化设置）、<code>locale_provider</code>/<code>icu_locale</code>/<code>icu_rules</code>/<code>builtin_locale</code>（本地化提供者设置）</li></ul><p>其他属性均可修改，以下是一些常见的修改示例：</p><p><strong>修改属主</strong>：更新配置中的 <code>owner</code> 字段后执行剧本，会执行 <code>ALTER DATABASE ... OWNER TO</code> 并授予相应权限。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_new_owner    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 修改为新属主</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>修改连接限制</strong>：通过 <code>connlimit</code> 限制数据库的最大连接数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 限制最大 100 个连接</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>回收公共连接权限</strong>：设置 <code>revokeconn: true</code> 会回收 PUBLIC 的 CONNECT 权限，仅允许属主、DBA、监控用户和复制用户连接。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 回收 PUBLIC 的 CONNECT 权限</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理数据库参数</strong>：通过 <code>parameters</code> 字典配置数据库级参数，会生成 <code>ALTER DATABASE ... SET</code> 语句。使用特殊值 <code>DEFAULT</code> 可将参数重置为默认值。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;256MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>maintenance_work_mem</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;512MB&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>statement_timeout</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;30s&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DEFAULT     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重置为默认值</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理模式（Schema）</strong>：通过 <code>schemas</code> 数组配置模式，支持简单格式和指定属主的完整格式。使用 <code>state: absent</code> 删除模式（CASCADE）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>app                                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单形式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: core, owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_myapp }  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指定属主</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: deprecated, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 删除模式</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>管理扩展（Extension）</strong>：通过 <code>extensions</code> 数组配置扩展，支持简单格式和指定 schema/版本的完整格式。使用 <code>state: absent</code> 卸载扩展（CASCADE）。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>postgis                                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单形式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: vector, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指定 schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pg_trgm, state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent }       </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 卸载扩展</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>CASCADE 警告</div><p>删除模式或卸载扩展使用 <code>CASCADE</code> 选项，会同时删除依赖该模式/扩展的所有对象。请确保理解影响范围后再执行删除操作。</p></div><p><strong>连接池配置</strong>：默认情况下所有业务数据库都会添加到 Pgbouncer 连接池。可配置 <code>pgbouncer</code>（是否加入连接池）、<code>pool_mode</code>（池化模式）、<code>pool_size</code>（默认池大小）、<code>pool_reserve</code>（保留连接数）、<code>pool_size_min</code>（最小池大小）、<code>pool_connlimit</code>（最大数据库连接）、<code>pool_auth_user</code>（认证查询用户）等参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>myapp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 是否加入连接池（默认 true）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 池化模式：transaction/session/statement</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 默认池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 保留池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 最小池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 最大数据库连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 认证查询使用用户（配合 pgbouncer_auth_query）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>自 Pigsty <code>v4.1.0</code> 起，数据库连接池参数统一使用 <code>pool_reserve</code> 与 <code>pool_connlimit</code>，旧别名 <code>pool_size_reserve</code> / <code>pool_max_db_conn</code> 已收敛。</p></blockquote><hr><h2 id=删除数据库>删除数据库</h2><p>要删除数据库，将其 <code>state</code> 设置为 <code>absent</code> 并执行剧本：</p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-06-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-06-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-06-02-tab data-bs-toggle=tab data-bs-target=#tabs-06-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-06-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># 删除数据库 &lt;db&gt;（需在配置中设置 state: absent）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本删除数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-02 role=tabpanel aria-labelled-by=tabs-06-02-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta olddb    <span style=color:#8f5902;font-style:italic># 删除 olddb 数据库（配置中已设置 state: absent）</span>
</span></span></code></pre></div></div></div><p><strong>配置示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>olddb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>absent</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>删除操作会</strong>：如果数据库标记为 <code>is_template: true</code>，先执行 <code>ALTER DATABASE ... IS_TEMPLATE false</code>；使用 <code>DROP DATABASE ... WITH (FORCE)</code> 强制删除数据库（PG13+）并终止所有活动连接；从 Pgbouncer 连接池中移除该数据库；从 Grafana 数据源中取消注册。</p><p><strong>保护机制</strong>：系统数据库 <code>postgres</code>、<code>template0</code>、<code>template1</code> 无法删除。删除操作仅在主库上执行，流复制会自动同步到从库。</p><div class="alert alert-danger" role=alert><div class="h4 alert-heading" role=heading>危险操作警告</div><p>删除数据库是<strong>不可逆</strong>操作，会永久删除该数据库中的所有数据。执行前请确保：已有最新的数据库备份、已确认没有业务在使用该数据库、已通知相关干系人。
Pigsty 不对任何因删除数据库导致的数据丢失承担责任，使用需自担风险。</p></div><hr><h2 id=重建数据库>重建数据库</h2><p><code>recreate</code> 状态用于重建数据库，等效于先删除再创建：</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-08-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-08-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-08-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># 重建数据库 &lt;db&gt;（需在配置中设置 state: recreate）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本重建数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta testdb    <span style=color:#8f5902;font-style:italic># 重建 testdb 数据库（配置中已设置 state: recreate）</span>
</span></span></code></pre></div></div></div><p><strong>配置示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>testdb</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>state</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>recreate</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test_init.sql   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 重建后执行初始化</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>适用场景</strong>：测试环境重置、清空开发数据库、修改不可变属性（编码、本地化等）、恢复数据库到初始状态。</p><p><strong>与手动 DROP + CREATE 的区别</strong>：单条命令完成，无需两次操作；自动保留 Pgbouncer 和 Grafana 配置；执行后自动加载 <code>baseline</code> 初始化脚本。</p><hr><h2 id=克隆数据库>克隆数据库</h2><p>你可以通过 PG 的 template 机制复制一个 PostgreSQL 数据库，在克隆期间，不允许有任何连接到模版数据库的活动连接。</p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-09-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-09-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-09-02-tab data-bs-toggle=tab data-bs-target=#tabs-09-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-09-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;db&gt;   <span style=color:#8f5902;font-style:italic># 克隆数据库 &lt;db&gt;（需在配置中指定 template）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-db.yml -l &lt;cls&gt; -e <span style=color:#000>dbname</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;db&gt;   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本克隆数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-02 role=tabpanel aria-labelled-by=tabs-09-02-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db pg-meta meta_dev    <span style=color:#8f5902;font-style:italic># 克隆创建 meta_dev 数据库（配置中已指定 template: meta）</span>
</span></span></code></pre></div></div></div><p><strong>配置示例</strong>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 源数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 以 meta 作为模板</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>strategy</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># PG15+ 克隆策略，PG18 瞬间生效</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>瞬间克隆（PG18+）</strong>：如果使用 PostgreSQL 18 以上版本，Pigsty 默认设置了 <a href=https://www.postgresql.org/docs/current/runtime-config-resource.html#GUC-FILE-COPY-METHOD><strong><code>file_copy_method</code></strong></a>，配合 <code>strategy: FILE_COPY</code> 可以在约 200ms 内完成数据库克隆，而不需要复制数据文件。例如克隆一个 30 GB 的数据库，普通克隆用时 18 秒，瞬间克隆仅需 200 毫秒。</p><p><strong>手动克隆</strong>：确保清理掉所有连接到模版数据库的连接后执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_terminate_backend</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>pid</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_activity</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>datname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;meta&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DATABASE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta_dev</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TEMPLATE</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8> </span><span style=color:#000>STRATEGY</span><span style=color:#f8f8f8> </span><span style=color:#000>FILE_COPY</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>局限性与注意事项</strong>：瞬间克隆仅在支持的文件系统上可用（xfs，brtfs，zfs，apfs）；不要使用 <code>postgres</code> 数据库作为模版数据库进行克隆；在高并发环境中使用瞬间克隆需要谨慎，需在克隆窗口（200ms）内清理掉所有连接到模版数据库的连接。</p><hr><h2 id=连接池管理>连接池管理</h2><p>在数据库定义中配置的 <a href=/docs/pgsql/config/db#%E8%BF%9E%E6%8E%A5%E6%B1%A0><strong>连接池参数</strong></a> 会在创建/修改数据库时应用到 Pgbouncer 连接池中。</p><p>默认情况下所有业务数据库都会添加到 Pgbouncer 连接池（<code>pgbouncer: true</code>）。数据库会被添加到 <code>/etc/pgbouncer/database.txt</code> 文件中，数据库级别的连接池参数（<code>pool_auth_user</code>、<code>pool_mode</code>、<code>pool_size</code>、<code>pool_reserve</code>、<code>pool_size_min</code>、<code>pool_connlimit</code>）通过此文件配置。</p><p>您可以使用 <code>postgres</code> 操作系统用户，使用 <code>pgb</code> 别名访问 Pgbouncer 管理数据库。更多连接池管理操作，请参考 <a href=/docs/pgsql/admin/pgbouncer><strong>Pgbouncer 管理</strong></a>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0cd896e3522e4cf2db0a08ece91619f5>4 - 管理 Patroni 高可用</h1><div class=lead>使用 Patroni 管理 PG 集群高可用，包括，修改参数，查看状态，主从切换，重启，重做从库等操作。</div><h2 id=概览>概览</h2><p>Pigsty 使用 Patroni 管理 PostgreSQL 集群，它可以用来修改集群配置，查看集群状态，执行主从切换，重启集群，重做从库等操作。</p><p>要使用 Patroni 进行管理，您需要有以下两种身份之一：</p><ul><li>从 <a href=/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9><strong>INFRA 节点</strong></a> 上使用 <a href=/docs/deploy/admin><strong>管理员用户</strong></a> ，可以管理环境中的所有集群。</li><li>从 <a href=/docs/concept/arch/node#pgsql%E8%8A%82%E7%82%B9><strong>PGSQL节点</strong></a> 上使用 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> （默认为 <code>postgres</code>），可以管理当前集群。</li></ul><p>Patroni 提供了 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html><strong><code>patronictl</code></strong></a> 命令行工具用于管理，Pigsty 提供了封装的快捷命令 <code>pg</code> 来简化其操作。</p><details><summary>通过 pg 别名使用 patronictl</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg <span style=color:#ce5c00;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>patroni_conf</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/infra/conf/patronictl.yml&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -r <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>        <span style=color:#000>patroni_conf</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;/etc/patroni/patroni.yml&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>if</span> <span style=color:#ce5c00;font-weight:700>[</span> ! -r <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#ce5c00;font-weight:700>]</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>then</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87>echo</span> <span style=color:#4e9a06>&#34;error: patronictl config not found&#34;</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>            <span style=color:#204a87;font-weight:700>return</span> 1<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87;font-weight:700>fi</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>fi</span><span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>    patronictl -c <span style=color:#4e9a06>${</span><span style=color:#000>patroni_conf</span><span style=color:#4e9a06>}</span> <span style=color:#4e9a06>&#34;</span><span style=color:#000>$@</span><span style=color:#4e9a06>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></details><hr><h2 id=可用命令>可用命令</h2><table class=full-width><thead><tr><th>命令</th><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><a href=#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong><code>edit-config</code></strong></a></td><td>修改配置</td><td>交互式修改集群的 Patroni/PostgreSQL 配置</td></tr><tr><td><a href=#%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81><strong><code>list</code></strong></a></td><td>查看状态</td><td>列出集群成员及其状态</td></tr><tr><td><a href=#%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2><strong><code>switchover</code></strong></a></td><td>主动切换</td><td>将主库角色切换到指定从库（计划内维护）</td></tr><tr><td><a href=#%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2><strong><code>failover</code></strong></a></td><td>故障切换</td><td>强制故障转移到指定从库（紧急情况）</td></tr><tr><td><a href=#%E9%87%8D%E5%90%AF%E5%AE%9E%E4%BE%8B><strong><code>restart</code></strong></a></td><td>重启实例</td><td>重启 PostgreSQL 实例以应用需要重启的参数</td></tr><tr><td><a href=#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE><strong><code>reload</code></strong></a></td><td>重载配置</td><td>重载 Patroni 配置（无需重启）</td></tr><tr><td><a href=#%E9%87%8D%E5%81%9A%E4%BB%8E%E5%BA%93><strong><code>reinit</code></strong></a></td><td>重做从库</td><td>重新初始化从库（擦除数据并重新复制）</td></tr><tr><td><a href=#%E6%9A%82%E5%81%9C%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2><strong><code>pause</code></strong></a></td><td>暂停自动切换</td><td>暂停 Patroni 的自动故障转移功能</td></tr><tr><td><a href=#%E6%81%A2%E5%A4%8D%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2><strong><code>resume</code></strong></a></td><td>恢复自动切换</td><td>恢复 Patroni 的自动故障转移功能</td></tr><tr><td><a href=#%E6%9F%A5%E7%9C%8B%E5%8E%86%E5%8F%B2><strong><code>history</code></strong></a></td><td>查看历史</td><td>显示集群的故障转移历史记录</td></tr><tr><td><a href=#%E6%98%BE%E7%A4%BA%E9%85%8D%E7%BD%AE><strong><code>show-config</code></strong></a></td><td>显示配置</td><td>显示集群当前的配置（只读）</td></tr><tr><td><a href=#%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2><strong><code>query</code></strong></a></td><td>执行查询</td><td>在集群成员上执行 SQL 查询</td></tr><tr><td><a href=#%E6%9F%A5%E7%9C%8B%E6%8B%93%E6%89%91><strong><code>topology</code></strong></a></td><td>查看拓扑</td><td>显示集群的复制拓扑结构</td></tr><tr><td><a href=#%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC><strong><code>version</code></strong></a></td><td>查看版本</td><td>显示 Patroni 版本信息</td></tr><tr><td><a href=#%E7%A7%BB%E9%99%A4%E6%88%90%E5%91%98><strong><code>remove</code></strong></a></td><td>移除成员</td><td>从 DCS 中移除集群成员（危险操作）</td></tr></tbody></table><hr><h2 id=修改配置>修改配置</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-edit-config><strong><code>edit-config</code></strong></a> 子命令可以交互式修改集群的 Patroni 与 PostgreSQL 配置。该命令会打开一个编辑器，让您修改存储在 DCS（分布式配置存储）中的集群配置，修改后会自动应用到所有集群成员。您可以更改 Patroni 本身的参数（如 <code>ttl</code>、<code>loop_wait</code>、<code>synchronous_mode</code> 等），以及 <code>postgresql.parameters</code> 中的 PostgreSQL 参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># 交互式编辑集群配置</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; --force          <span style=color:#8f5902;font-style:italic># 跳过确认提示直接应用</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; -p &lt;k&gt;<span style=color:#ce5c00;font-weight:700>=</span>&lt;v&gt;       <span style=color:#8f5902;font-style:italic># 修改 PostgreSQL 参数（--pg 简写）</span>
</span></span><span style=display:flex><span>pg edit-config &lt;cls&gt; -s &lt;k&gt;<span style=color:#ce5c00;font-weight:700>=</span>&lt;v&gt;       <span style=color:#8f5902;font-style:italic># 修改 Patroni 参数（--set 简写）</span>
</span></span></code></pre></div><div id=asciinema-7f7700930ae8f7d432a1cae8fb8bc426 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-7f7700930ae8f7d432a1cae8fb8bc426",o="/demo/pgsql-config.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,e.markers=[[7,"修改配置"],[9,"应用生效"],[11,"检验结果"],[13,"API修改"],[14,"API修改验证"]],i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><p>以下是一些常见的配置修改示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 PostgreSQL 参数：慢查询阈值（会询问是否应用）</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 PostgreSQL 参数并跳过确认</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>log_min_duration_statement</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>1000</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改多个 PostgreSQL 参数</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>work_mem</span><span style=color:#ce5c00;font-weight:700>=</span>256MB -p <span style=color:#000>maintenance_work_mem</span><span style=color:#ce5c00;font-weight:700>=</span>1GB --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 Patroni 参数：增大故障检测时间窗口（增大 RTO）</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>loop_wait</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>15</span> -s <span style=color:#000>ttl</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 Patroni 参数：启用同步复制模式</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>synchronous_mode</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改 Patroni 参数：启用严格同步模式（至少一个同步从库才允许写入）</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -s <span style=color:#000>synchronous_mode_strict</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改需要重启的参数（修改后需执行 pg restart）</span>
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>shared_buffers</span><span style=color:#ce5c00;font-weight:700>=</span>4GB --force
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements&#39;</span> --force
</span></span><span style=display:flex><span>pg edit-config pg-test -p <span style=color:#000>max_connections</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>200</span> --force
</span></span></code></pre></div><p>部分参数修改后需要重启 PostgreSQL 才能生效，您可以使用 <code>pg list</code> 检查集群状态，带 <code>*</code> 标记的实例表示需要重启。然后使用 <code>pg restart</code> 命令重启集群使配置生效。
您也可以使用 <code>curl</code> 或编写程序直接调用 Patroni 提供的 <a href=https://patroni.readthedocs.io/en/latest/rest_api.html><strong>REST API</strong></a> 来修改配置：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看当前配置</span>
</span></span><span style=display:flex><span>curl -s 10.10.10.11:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过 API 修改参数（需要认证）</span>
</span></span><span style=display:flex><span>curl -u <span style=color:#4e9a06>&#39;postgres:Patroni.API&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>     -d <span style=color:#4e9a06>&#39;{&#34;postgresql&#34;:{&#34;parameters&#34;: {&#34;log_min_duration_statement&#34;:200}}}&#39;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>     -s -X PATCH http://10.10.10.11:8008/config <span style=color:#000;font-weight:700>|</span> jq .
</span></span></code></pre></div><hr><h2 id=查看状态>查看状态</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-list><strong><code>list</code></strong></a> 子命令可以查看集群成员及其状态。输出结果会显示每个实例的名称、主机地址、角色、运行状态、时间线和复制延迟等信息。这是日常运维中最常用的命令之一，用于快速了解集群的健康状况。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list &lt;cls&gt;                         <span style=color:#8f5902;font-style:italic># 查看指定集群的状态</span>
</span></span><span style=display:flex><span>pg list                               <span style=color:#8f5902;font-style:italic># 列出所有集群（需要在管理节点上执行）</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -e                      <span style=color:#8f5902;font-style:italic># 显示扩展信息（--extended）</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -t                      <span style=color:#8f5902;font-style:italic># 显示时间戳（--timestamp）</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -f json                 <span style=color:#8f5902;font-style:italic># 以 JSON 格式输出（--format）</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt; -W <span style=color:#0000cf;font-weight:700>5</span>                    <span style=color:#8f5902;font-style:italic># 每 5 秒刷新一次（--watch）</span>
</span></span></code></pre></div><p>输出示例：</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) -----+----+--------------+
| Member    | Host        | Role    | State   | TL | Lag in MB    |
+-----------+-------------+---------+---------+----+--------------+
| pg-test-1 | 10.10.10.11 | Leader  | running |  1 |              |
| pg-test-2 | 10.10.10.12 | Replica | running |  1 |            0 |
| pg-test-3 | 10.10.10.13 | Replica | running |  1 |            0 |
+-----------+-------------+---------+---------+----+--------------+
</code></pre><p>输出列说明：<strong>Member</strong> 是实例名称，由 <code>pg_cluster</code>-<code>pg_seq</code> 组成；<strong>Host</strong> 是实例所在主机的 IP 地址；<strong>Role</strong> 表示角色，包括 Leader（主库）、Replica（从库）、Sync Standby（同步从库）、Standby Leader（级联复制的级联主库）等；<strong>State</strong> 表示运行状态，常见值包括 <code>running</code>（正常运行）、<code>streaming</code>（流复制中）、<code>in archive recovery</code>（归档恢复中）、<code>starting</code>（启动中）、<code>stopped</code>（已停止）等；<strong>TL</strong> 是时间线编号（Timeline），每次主从切换后会递增；<strong>Lag in MB</strong> 是复制延迟，以 MB 为单位，主库不显示此值。</p><p>如果某个实例需要重启才能应用配置更改，实例名称后会显示 <code>*</code> 标记：</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) -------+----+--------------+
| Member      | Host        | Role    | State   | TL | Lag in MB    |
+-------------+-------------+---------+---------+----+--------------+
| pg-test-1 * | 10.10.10.11 | Leader  | running |  1 |              |
| pg-test-2 * | 10.10.10.12 | Replica | running |  1 |            0 |
+-------------+-------------+---------+---------+----+--------------+
</code></pre><hr><h2 id=主动切换>主动切换</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-switchover><strong><code>switchover</code></strong></a> 子命令可以执行计划内的主从切换。Switchover 是一种优雅的切换方式：Patroni 会先确保从库完全同步，然后让主库降级为从库，最后提升目标从库为新主库。这个过程通常只需要几秒钟，期间会有短暂的写入不可用。适用于主库所在主机需要维护、升级、或者需要将主库迁移到性能更好的节点等场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg switchover &lt;cls&gt;                   <span style=color:#8f5902;font-style:italic># 交互式切换，会提示选择目标从库</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --leader &lt;old&gt;    <span style=color:#8f5902;font-style:italic># 指定当前主库名称</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --candidate &lt;new&gt; <span style=color:#8f5902;font-style:italic># 指定目标从库名称</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --scheduled &lt;time&gt; <span style=color:#8f5902;font-style:italic># 定时切换，格式如 2024-12-01T03:00</span>
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt; --force           <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span></code></pre></div><p>执行切换前请确保所有从库复制状态正常（状态为 <code>running</code> 或 <code>streaming</code>），复制延迟在可接受范围内，并已通知相关业务方。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 交互式切换（推荐，会显示当前拓扑并提示选择）</span>
</span></span><span style=display:flex><span>$ pg switchover pg-test
</span></span><span style=display:flex><span>Current cluster topology
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -----+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span>Primary <span style=color:#ce5c00;font-weight:700>[</span>pg-test-1<span style=color:#ce5c00;font-weight:700>]</span>:
</span></span><span style=display:flex><span>Candidate <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;pg-test-2&#39;</span>, <span style=color:#4e9a06>&#39;pg-test-3&#39;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[]</span>: pg-test-2
</span></span><span style=display:flex><span>When should the switchover take place <span style=color:#ce5c00;font-weight:700>(</span>e.g. 2024-01-01T12:00<span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>[</span>now<span style=color:#ce5c00;font-weight:700>]</span>:
</span></span><span style=display:flex><span>Are you sure you want to switchover cluster pg-test, demoting current leader pg-test-1? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 非交互式切换（指定主库和候选从库）</span>
</span></span><span style=display:flex><span>pg switchover pg-test --leader pg-test-1 --candidate pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 定时切换（在凌晨 3 点执行，适合维护窗口）</span>
</span></span><span style=display:flex><span>pg switchover pg-test --leader pg-test-1 --candidate pg-test-2 --scheduled <span style=color:#4e9a06>&#34;2024-12-01T03:00&#34;</span>
</span></span></code></pre></div><p>切换完成后，请使用 <code>pg list</code> 确认新的集群拓扑。</p><hr><h2 id=故障切换>故障切换</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-failover><strong><code>failover</code></strong></a> 子命令可以执行紧急故障切换。与 <code>switchover</code> 不同，<code>failover</code> 用于主库已经不可用的紧急情况。它会直接提升一个从库为新主库，而不等待原主库的确认。由于从库可能尚未完全同步所有数据，使用 <code>failover</code> 可能会导致少量数据丢失。因此，在非紧急情况下请优先使用 <code>switchover</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg failover &lt;cls&gt;                     <span style=color:#8f5902;font-style:italic># 交互式故障切换</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --leader &lt;old&gt;      <span style=color:#8f5902;font-style:italic># 指定原主库（用于验证，可选）</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --candidate &lt;new&gt;   <span style=color:#8f5902;font-style:italic># 指定要提升的从库</span>
</span></span><span style=display:flex><span>pg failover &lt;cls&gt; --force             <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span></code></pre></div><p>故障切换示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 交互式故障切换</span>
</span></span><span style=display:flex><span>$ pg failover pg-test
</span></span><span style=display:flex><span>Candidate <span style=color:#ce5c00;font-weight:700>[</span><span style=color:#4e9a06>&#39;pg-test-2&#39;</span>, <span style=color:#4e9a06>&#39;pg-test-3&#39;</span><span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[]</span>: pg-test-2
</span></span><span style=display:flex><span>Are you sure you want to failover cluster pg-test? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>Successfully failed over to <span style=color:#4e9a06>&#34;pg-test-2&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 非交互式故障切换（紧急情况快速执行）</span>
</span></span><span style=display:flex><span>pg failover pg-test --candidate pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 指定原主库进行验证（如果原主库名称不匹配会报错）</span>
</span></span><span style=display:flex><span>pg failover pg-test --leader pg-test-1 --candidate pg-test-2 --force
</span></span></code></pre></div><p><strong>Switchover 与 Failover 的区别</strong>：Switchover 用于计划内维护，要求原主库在线，执行前会确保数据完全同步，不会丢失数据；Failover 用于紧急故障恢复，原主库可以离线，会直接提升从库，可能丢失未同步的数据。日常维护、升级请使用 Switchover；只有在主库彻底故障无法恢复时才使用 Failover。</p><hr><h2 id=重启实例>重启实例</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-restart><strong><code>restart</code></strong></a> 子命令可以重启 PostgreSQL 实例，通常用于应用需要重启才能生效的参数更改。Patroni 会协调重启过程，对于整个集群的重启会采用滚动方式：先重启从库，最后重启主库，以最小化服务中断。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart &lt;cls&gt;                      <span style=color:#8f5902;font-style:italic># 重启整个集群的所有实例</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; &lt;member&gt;             <span style=color:#8f5902;font-style:italic># 重启指定实例</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --role leader        <span style=color:#8f5902;font-style:italic># 仅重启主库</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --role replica       <span style=color:#8f5902;font-style:italic># 仅重启所有从库</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --pending            <span style=color:#8f5902;font-style:italic># 仅重启标记为需要重启的实例</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --scheduled &lt;time&gt;   <span style=color:#8f5902;font-style:italic># 定时重启</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --timeout &lt;sec&gt;      <span style=color:#8f5902;font-style:italic># 设置重启超时时间（秒）</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; --force              <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span></code></pre></div><p>当您修改了需要重启才能生效的参数（如 <code>shared_buffers</code>、<code>shared_preload_libraries</code>、<code>max_connections</code>、<code>max_worker_processes</code> 等）后，需要使用此命令重启实例。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看哪些实例需要重启（名称后带 * 标记）</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 * <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 * <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重启单个从库实例</span>
</span></span><span style=display:flex><span>pg restart pg-test pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重启整个集群（滚动重启，先从库后主库）</span>
</span></span><span style=display:flex><span>pg restart pg-test --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 仅重启需要重启的实例</span>
</span></span><span style=display:flex><span>pg restart pg-test --pending --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 仅重启所有从库</span>
</span></span><span style=display:flex><span>pg restart pg-test --role replica --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 定时重启（在维护窗口执行）</span>
</span></span><span style=display:flex><span>pg restart pg-test --scheduled <span style=color:#4e9a06>&#34;2024-12-01T03:00&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 设置重启超时时间为 300 秒</span>
</span></span><span style=display:flex><span>pg restart pg-test --timeout <span style=color:#0000cf;font-weight:700>300</span> --force
</span></span></code></pre></div><hr><h2 id=重载配置>重载配置</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-reload><strong><code>reload</code></strong></a> 子命令可以重载 Patroni 配置，无需重启 PostgreSQL。该命令会让 Patroni 重新读取配置文件，并将不需要重启的参数变更应用到 PostgreSQL（通过 <code>pg_reload_conf()</code>）。相比 <code>restart</code>，<code>reload</code> 更加轻量，不会中断数据库连接和正在执行的查询。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg reload &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># 重载整个集群的配置</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; &lt;member&gt;              <span style=color:#8f5902;font-style:italic># 重载指定实例的配置</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --role leader         <span style=color:#8f5902;font-style:italic># 仅重载主库</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --role replica        <span style=color:#8f5902;font-style:italic># 仅重载所有从库</span>
</span></span><span style=display:flex><span>pg reload &lt;cls&gt; --force               <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span></code></pre></div><p>大多数 PostgreSQL 参数可以通过 <code>reload</code> 生效，只有少数参数（位于 postmaster 上下文的参数，例如 <code>shared_buffers</code>、<code>max_connections</code>、<code>shared_preload_libraries</code>，<code>archive_mode</code> 等）需要重启 PostgreSQL 才能生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重载整个集群</span>
</span></span><span style=display:flex><span>pg reload pg-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重载单个实例</span>
</span></span><span style=display:flex><span>pg reload pg-test pg-test-1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 强制重载，跳过确认</span>
</span></span><span style=display:flex><span>pg reload pg-test --force
</span></span></code></pre></div><hr><h2 id=重做从库>重做从库</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-reinit><strong><code>reinit</code></strong></a> 子命令可以重新初始化从库。该操作会删除从库上的所有数据，然后从主库重新执行 <code>pg_basebackup</code> 进行完整的数据复制。适用于从库数据损坏无法修复、从库落后太多导致 WAL 已被清理无法追赶、或从库配置错误需要重置等场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt;              <span style=color:#8f5902;font-style:italic># 重新初始化指定从库</span>
</span></span><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt; --force      <span style=color:#8f5902;font-style:italic># 跳过确认提示</span>
</span></span><span style=display:flex><span>pg reinit &lt;cls&gt; &lt;member&gt; --wait       <span style=color:#8f5902;font-style:italic># 等待重建完成后再返回</span>
</span></span></code></pre></div><blockquote><p>⚠️ <strong>警告</strong>：此操作会删除目标实例的所有数据！只能对从库执行，不能对主库执行。</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重新初始化从库（会提示确认）</span>
</span></span><span style=display:flex><span>$ pg reinit pg-test pg-test-2
</span></span><span style=display:flex><span>Are you sure you want to reinitialize members pg-test-2? <span style=color:#ce5c00;font-weight:700>[</span>y/N<span style=color:#ce5c00;font-weight:700>]</span>: y
</span></span><span style=display:flex><span>Success: reinitialize <span style=color:#204a87;font-weight:700>for</span> member pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 强制重新初始化，跳过确认</span>
</span></span><span style=display:flex><span>pg reinit pg-test pg-test-2 --force
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重新初始化并等待完成</span>
</span></span><span style=display:flex><span>pg reinit pg-test pg-test-2 --force --wait
</span></span></code></pre></div><p>重建过程中，可以使用 <code>pg list</code> 查看进度。从库状态会显示为 <code>creating replica</code>：</p><pre tabindex=0><code>+ Cluster: pg-test (7322261897169354773) --------------+----+------+
| Member    | Host        | Role    | State            | TL | Lag  |
+-----------+-------------+---------+------------------+----+------+
| pg-test-1 | 10.10.10.11 | Leader  | running          |  2 |      |
| pg-test-2 | 10.10.10.12 | Replica | creating replica |    |    ? |
+-----------+-------------+---------+------------------+----+------+
</code></pre><hr><h2 id=暂停自动切换>暂停自动切换</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-pause><strong><code>pause</code></strong></a> 子命令可以暂停 Patroni 的自动故障转移功能。暂停后，即使主库故障，Patroni 也不会自动提升从库为新主库。适用于计划内维护窗口（避免维护操作误触发切换）、调试问题时防止集群状态变化、或需要手动控制切换时机等场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg pause &lt;cls&gt;                        <span style=color:#8f5902;font-style:italic># 暂停自动故障转移</span>
</span></span><span style=display:flex><span>pg pause &lt;cls&gt; --wait                 <span style=color:#8f5902;font-style:italic># 暂停并等待所有成员确认</span>
</span></span></code></pre></div><blockquote><p>⚠️ <strong>警告</strong>：暂停期间如果主库故障，集群将不会自动恢复！请确保在维护完成后及时使用 <code>resume</code> 恢复。</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 暂停自动切换</span>
</span></span><span style=display:flex><span>$ pg pause pg-test
</span></span><span style=display:flex><span>Success: cluster management is paused
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看集群状态（底部会显示 Maintenance mode: on）</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -----+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member    <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-----------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span> Maintenance mode: on
</span></span></code></pre></div><hr><h2 id=恢复自动切换>恢复自动切换</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-resume><strong><code>resume</code></strong></a> 子命令可以恢复 Patroni 的自动故障转移功能。维护完成后应立即执行此命令，以确保集群在主库故障时能够自动恢复。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># 恢复自动故障转移</span>
</span></span><span style=display:flex><span>pg resume &lt;cls&gt; --wait                <span style=color:#8f5902;font-style:italic># 恢复并等待所有成员确认</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复自动切换</span>
</span></span><span style=display:flex><span>$ pg resume pg-test
</span></span><span style=display:flex><span>Success: cluster management is resumed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 确认已恢复（Maintenance mode 提示消失）</span>
</span></span><span style=display:flex><span>$ pg list pg-test
</span></span></code></pre></div><hr><h2 id=查看历史>查看历史</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-history><strong><code>history</code></strong></a> 子命令可以查看集群的故障转移历史记录。每次主从切换（无论是自动故障转移还是手动切换）都会生成一条新的时间线记录。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt;                      <span style=color:#8f5902;font-style:italic># 显示故障转移历史</span>
</span></span><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt; -f json              <span style=color:#8f5902;font-style:italic># 以 JSON 格式输出</span>
</span></span><span style=display:flex><span>pg <span style=color:#204a87>history</span> &lt;cls&gt; -f yaml              <span style=color:#8f5902;font-style:italic># 以 YAML 格式输出</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg <span style=color:#204a87>history</span> pg-test
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span>       LSN <span style=color:#000;font-weight:700>|</span> Reason                       <span style=color:#000;font-weight:700>|</span> Timestamp                 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 0/5000060 <span style=color:#000;font-weight:700>|</span> no recovery target specified <span style=color:#000;font-weight:700>|</span> 2024-01-15T10:30:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 0/6000000 <span style=color:#000;font-weight:700>|</span> switchover to pg-test-2      <span style=color:#000;font-weight:700>|</span> 2024-01-20T14:00:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#000;font-weight:700>|</span> 0/7000028 <span style=color:#000;font-weight:700>|</span> failover to pg-test-1        <span style=color:#000;font-weight:700>|</span> 2024-01-25T09:15:00+08:00 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+-----------+------------------------------+---------------------------+
</span></span></code></pre></div><p>输出列说明：<strong>TL</strong> 是时间线编号（Timeline），每次切换后递增，用于区分不同的主库历史；<strong>LSN</strong> 是切换时的日志序列号（Log Sequence Number），标识切换发生时的 WAL 位置；<strong>Reason</strong> 是切换原因，可能是 <code>switchover to xxx</code>（手动切换）、<code>failover to xxx</code>（故障转移）或 <code>no recovery target specified</code>（初始化）；<strong>Timestamp</strong> 是切换发生的时间戳。</p><hr><h2 id=显示配置>显示配置</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-show-config><strong><code>show-config</code></strong></a> 子命令可以查看集群当前存储在 DCS 中的配置。这是一个只读操作，如需修改配置请使用 <code>edit-config</code> 命令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg show-config &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># 显示集群配置</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg show-config pg-test
</span></span><span style=display:flex><span>loop_wait: <span style=color:#0000cf;font-weight:700>10</span>
</span></span><span style=display:flex><span>maximum_lag_on_failover: <span style=color:#0000cf;font-weight:700>1048576</span>
</span></span><span style=display:flex><span>postgresql:
</span></span><span style=display:flex><span>  parameters:
</span></span><span style=display:flex><span>    archive_command: pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-test archive-push %p
</span></span><span style=display:flex><span>    max_connections: <span style=color:#0000cf;font-weight:700>100</span>
</span></span><span style=display:flex><span>    shared_buffers: 256MB
</span></span><span style=display:flex><span>    log_min_duration_statement: <span style=color:#0000cf;font-weight:700>1000</span>
</span></span><span style=display:flex><span>  use_pg_rewind: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>  use_slots: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>retry_timeout: <span style=color:#0000cf;font-weight:700>10</span>
</span></span><span style=display:flex><span>ttl: <span style=color:#0000cf;font-weight:700>30</span>
</span></span><span style=display:flex><span>synchronous_mode: <span style=color:#204a87>false</span>
</span></span></code></pre></div><hr><h2 id=执行查询>执行查询</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-query><strong><code>query</code></strong></a> 子命令可以在集群成员上快速执行 SQL 查询。这是一个方便的调试工具，适合快速检查集群状态或执行简单查询。生产环境中的复杂查询建议使用 <code>psql</code> 或应用程序连接。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span>             <span style=color:#8f5902;font-style:italic># 在主库上执行查询</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -m &lt;member&gt; <span style=color:#8f5902;font-style:italic># 在指定实例上执行（--member）</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -r leader   <span style=color:#8f5902;font-style:italic># 在主库上执行（--role）</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -r replica  <span style=color:#8f5902;font-style:italic># 在所有从库上执行</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -f &lt;file&gt;              <span style=color:#8f5902;font-style:italic># 从文件读取 SQL 执行</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -U &lt;user&gt;   <span style=color:#8f5902;font-style:italic># 指定用户名（--username）</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> -d &lt;db&gt;     <span style=color:#8f5902;font-style:italic># 指定数据库（--dbname）</span>
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;&lt;sql&gt;&#34;</span> --format json  <span style=color:#8f5902;font-style:italic># 以 JSON 格式输出</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看主库当前连接数</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT count(*) FROM pg_stat_activity&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看 PostgreSQL 版本</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT version()&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在所有从库上查看复制状态</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT pg_is_in_recovery(), pg_last_wal_replay_lsn()&#34;</span> -r replica
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 在指定实例上执行</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT pg_is_in_recovery()&#34;</span> -m pg-test-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用指定用户和数据库</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT current_user, current_database()&#34;</span> -U postgres -d postgres
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 以 JSON 格式输出结果</span>
</span></span><span style=display:flex><span>pg query pg-test -c <span style=color:#4e9a06>&#34;SELECT * FROM pg_stat_replication&#34;</span> --format json
</span></span></code></pre></div><hr><h2 id=查看拓扑>查看拓扑</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-topology><strong><code>topology</code></strong></a> 子命令可以以树形结构查看集群的复制拓扑。与 <code>list</code> 相比，<code>topology</code> 更直观地展示了主从复制关系，特别适合级联复制（Cascading Replication）场景。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg topology &lt;cls&gt;                     <span style=color:#8f5902;font-style:italic># 显示复制拓扑</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg topology pg-test
</span></span><span style=display:flex><span>+ Cluster: pg-test <span style=color:#ce5c00;font-weight:700>(</span>7322261897169354773<span style=color:#ce5c00;font-weight:700>)</span> -------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State   <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> pg-test-1   <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>              <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> + pg-test-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> + pg-test-3 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> running <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>            <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------------+-------------+---------+---------+----+--------------+
</span></span></code></pre></div><p>在级联复制场景中，拓扑图会清晰展示复制链路层级，例如 <code>pg-test-3</code> 从 <code>pg-test-2</code> 复制，而 <code>pg-test-2</code> 从主库 <code>pg-test-1</code> 复制。</p><hr><h2 id=查看版本>查看版本</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-version><strong><code>version</code></strong></a> 子命令可以查看 patronictl 的版本信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg version                            <span style=color:#8f5902;font-style:italic># 显示 patronictl 版本</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg version
</span></span><span style=display:flex><span>patronictl version 4.1.0
</span></span></code></pre></div><hr><h2 id=移除成员>移除成员</h2><p>使用 <a href=https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-remove><strong><code>remove</code></strong></a> 子命令可以从 DCS（分布式配置存储）中移除集群或成员的元数据。这是一个危险操作，仅移除 DCS 中的元数据，不会停止 PostgreSQL 服务或删除数据文件。错误使用可能导致集群状态不一致。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg remove &lt;cls&gt;                       <span style=color:#8f5902;font-style:italic># 从 DCS 中移除整个集群的元数据</span>
</span></span></code></pre></div><p>通常情况下您不需要使用此命令。如需正确移除集群或实例，请使用 Pigsty 提供的 <a href=/docs/pgsql/admin/cluster#%E9%94%80%E6%AF%81%E9%9B%86%E7%BE%A4><strong><code>bin/pgsql-rm</code></strong></a> 脚本或 <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> 剧本。
只有在以下特殊情况下才考虑使用 <code>remove</code>：DCS 中存在孤立的元数据需要清理（例如节点已物理移除但元数据残留），或集群已通过其他方式销毁需要清理残留信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 移除整个集群的元数据（需要多次确认）</span>
</span></span><span style=display:flex><span>$ pg remove pg-test
</span></span><span style=display:flex><span>Please confirm the cluster name to remove: pg-test
</span></span><span style=display:flex><span>You are about to remove all information in DCS <span style=color:#204a87;font-weight:700>for</span> pg-test, please type: <span style=color:#4e9a06>&#34;Yes I am aware&#34;</span>: Yes I am aware
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-289eefb8da504803e0c1952004777bb0>5 - Pgbouncer 连接池管理</h1><div class=lead>使用 Pgbouncer 管理连接池，包括暂停、恢复、禁用、启用、重连、终止、重载等操作。</div><h2 id=概览>概览</h2><p>Pigsty 使用 <a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> 作为 PostgreSQL 的连接池中间件，默认监听 <code>6432</code> 端口，代理访问本机 <code>5432</code> 端口上的 PostgreSQL 实例。</p><p>这是一个 <strong>可选组件</strong>，如果您并没有海量链接，也不需要事务池化与查询监控指标，可以关闭连接池，直连数据库，或者保留但不使用。</p><hr><h2 id=用户与数据库管理>用户与数据库管理</h2><p>Pgbouncer 中的用户和数据库由 Pigsty 自动管理，并在 <a href=/docs/pgsql/admin/db><strong>创建数据库</strong></a> 与 <a href=/docs/pgsql/admin/user><strong>创建用户</strong></a> 时自动应用 <a href=/docs/pgsql/config/db><strong>数据库配置</strong></a> 与 <a href=/docs/pgsql/config/user><strong>用户配置</strong></a>。</p><p><strong>数据库管理</strong>：在 <a href=/docs/pgsql/param#pg_databases><strong><code>pg_databases</code></strong></a> 中定义的数据库，默认会自动添加到 Pgbouncer。设置 <a href=/docs/pgsql/admin/db#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%AE%A1%E7%90%86><strong><code>pgbouncer: false</code></strong></a> 可以排除特定数据库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>mydb               </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 默认加入连接池</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，认证查询用户（配合 pgbouncer_auth_query）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 数据库级池化模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 默认池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 保留池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 最小池大小</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 最大数据库连接数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>internal</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic># 不加入连接池</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>用户管理</strong>：在 <a href=/docs/pgsql/param#pg_users><strong><code>pg_users</code></strong></a> 中定义的用户，需要显式设置 <a href=/docs/pgsql/admin/user#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%AE%A1%E7%90%86><strong><code>pgbouncer: true</code></strong></a> 才会加入连接池用户列表。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_app</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.App</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 加入连接池用户列表</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 用户级池化模式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>50</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># 用户级最大连接数</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p>自 Pigsty <code>v4.1.0</code> 起，数据库连接池参数统一使用 <code>pool_reserve</code> 与 <code>pool_connlimit</code>，旧别名 <code>pool_size_reserve</code> / <code>pool_max_db_conn</code> 已收敛。</p></blockquote><hr><h2 id=服务管理>服务管理</h2><p>在 Pigsty 中，PostgreSQL 集群的 <a href=/docs/pgsql/service#primary%E6%9C%8D%E5%8A%A1><strong>Primary 服务</strong></a> 与 Replica 服务默认指向 Pgbouncer 6432 端口，
如果您想要让这两个服务绕过连接池直接访问 PostgreSQL 实例，可以定制 <a href=/docs/pgsql/param#pg_services><strong><code>pg_services</code></strong></a>，或将将 <a href=/docs/pgsql/param#pg_default_service_dest><strong><code>pg_default_service_dest</code></strong></a> 设置为 <code>postgres</code>。</p><hr><h2 id=配置管理>配置管理</h2><p>Pgbouncer 的配置文件位于 <code>/etc/pgbouncer/</code> 目录，由 Pigsty 统一生成与管理：</p><table class=full-width><thead><tr><th>文件</th><th>说明</th></tr></thead><tbody><tr><td><code>pgbouncer.ini</code></td><td>主配置文件，连接池级别参数</td></tr><tr><td><code>database.txt</code></td><td>数据库列表，数据库级别参数</td></tr><tr><td><code>userlist.txt</code></td><td>用户密码列表</td></tr><tr><td><code>useropts.txt</code></td><td>用户级别的连接池参数</td></tr><tr><td><code>pgb_hba.conf</code></td><td>HBA 访问控制规则</td></tr></tbody></table><p>Pigsty 会自动管理 <code>database.txt</code> 和 <code>userlist.txt</code>，在 <a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93><strong>创建数据库</strong></a> 或 <a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7><strong>创建用户</strong></a> 时自动更新这些文件。</p><p>您也可以手动编辑配置文件后执行 <code>RELOAD</code> 使其生效：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 编辑配置</span>
</span></span><span style=display:flex><span>$ vim /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重载生效：通过 systemctl</span>
</span></span><span style=display:flex><span>$ sudo systemctl reload pgbouncer
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 重载生效，本身是 pg_dbsu / postgres 用户</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>
</span></span></code></pre></div><hr><h2 id=连接池管理>连接池管理</h2><p>Pgbouncer 使用和 PostgreSQL 相同的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户。Pigsty 提供了快捷命令 <code>pgb</code> 来简化管理操作：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>alias</span> <span style=color:#000>pgb</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;psql -p 6432 -d pgbouncer -U postgres&#34;</span>
</span></span></code></pre></div><p>您可以在数据库节点上使用 <code>pgb</code> 命令连接到 Pgbouncer 管理控制台，执行管理命令和监控查询。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW POOLS;</span>
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW CLIENTS;</span>
</span></span><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#8f5902;font-style:italic># SHOW SERVERS;</span>
</span></span></code></pre></div><table class=full-width><thead><tr><th>命令</th><th>功能</th><th>说明</th></tr></thead><tbody><tr><td><a href=#pause><strong><code>PAUSE</code></strong></a></td><td>暂停</td><td>暂停数据库连接，等待事务完成后断开服务端连接</td></tr><tr><td><a href=#resume><strong><code>RESUME</code></strong></a></td><td>恢复</td><td>恢复被 PAUSE/KILL/SUSPEND 暂停的数据库</td></tr><tr><td><a href=#disable><strong><code>DISABLE</code></strong></a></td><td>禁用</td><td>拒绝指定数据库的新客户端连接</td></tr><tr><td><a href=#enable><strong><code>ENABLE</code></strong></a></td><td>启用</td><td>允许指定数据库的新客户端连接</td></tr><tr><td><a href=#reconnect><strong><code>RECONNECT</code></strong></a></td><td>重连</td><td>优雅地关闭并重建服务端连接</td></tr><tr><td><a href=#kill><strong><code>KILL</code></strong></a></td><td>终止</td><td>立即断开指定数据库的所有客户端和服务端连接</td></tr><tr><td><a href=#kill_client><strong><code>KILL_CLIENT</code></strong></a></td><td>杀客户端</td><td>终止指定的客户端连接</td></tr><tr><td><a href=#suspend><strong><code>SUSPEND</code></strong></a></td><td>挂起</td><td>刷新缓冲区并停止监听，用于在线重启</td></tr><tr><td><a href=#shutdown><strong><code>SHUTDOWN</code></strong></a></td><td>关闭</td><td>关闭 Pgbouncer 进程</td></tr><tr><td><a href=#reload><strong><code>RELOAD</code></strong></a></td><td>重载</td><td>重新加载配置文件</td></tr><tr><td><a href=#wait_close><strong><code>WAIT_CLOSE</code></strong></a></td><td>等待关闭</td><td>等待 RECONNECT/RELOAD 后的服务端连接释放</td></tr><tr><td><a href=#%E7%9B%91%E6%8E%A7%E5%91%BD%E4%BB%A4><strong>监控命令</strong></a></td><td>监控</td><td>查看连接池状态、客户端、服务端等信息</td></tr></tbody></table><hr><h3 id=pause>PAUSE</h3><p>使用 <code>PAUSE</code> 命令暂停数据库连接。Pgbouncer 会根据池化模式等待活动事务/会话完成后断开服务端连接。新的客户端请求会被阻塞直到执行 <code>RESUME</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>PAUSE</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 暂停指定数据库，不指定则暂停所有数据库
</span></span></span></code></pre></div><p>典型使用场景：</p><ul><li>在线切换后端数据库（如主从切换后更新连接目标）</li><li>执行需要断开所有连接的维护操作</li><li>配合 <code>SUSPEND</code> 实现 Pgbouncer 在线重启</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;PAUSE mydb;&#34;</span>        <span style=color:#8f5902;font-style:italic># 暂停 mydb 数据库</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;PAUSE;&#34;</span>             <span style=color:#8f5902;font-style:italic># 暂停所有数据库</span>
</span></span></code></pre></div><p>暂停后，<code>SHOW DATABASES</code> 会显示 <code>paused</code> 状态：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>pgbouncer</span><span style=color:#ce5c00;font-weight:700>=#</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>DATABASES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>   </span><span style=color:#000>name</span><span style=color:#f8f8f8>   </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>host</span><span style=color:#f8f8f8>    </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>port</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>database</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>paused</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>disabled</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>----------+-----------+------+----------+-----+--------+----------
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8> </span><span style=color:#000>mydb</span><span style=color:#f8f8f8>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>var</span><span style=color:#ce5c00;font-weight:700>/</span><span style=color:#000>run</span><span style=color:#f8f8f8>  </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000>mydb</span><span style=color:#f8f8f8>     </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>      </span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>|</span><span style=color:#f8f8f8>        </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h3 id=resume>RESUME</h3><p>使用 <code>RESUME</code> 命令恢复被 <code>PAUSE</code>、<code>KILL</code> 或 <code>SUSPEND</code> 暂停的数据库，允许新的连接请求并恢复正常服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RESUME</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- 恢复指定数据库，不指定则恢复所有数据库
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RESUME mydb;&#34;</span>       <span style=color:#8f5902;font-style:italic># 恢复 mydb 数据库</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RESUME;&#34;</span>            <span style=color:#8f5902;font-style:italic># 恢复所有数据库</span>
</span></span></code></pre></div><hr><h3 id=disable>DISABLE</h3><p>使用 <code>DISABLE</code> 命令禁用指定数据库，拒绝所有新的客户端连接请求。已存在的连接不受影响。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>DISABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 禁用指定数据库（必须指定数据库名）
</span></span></span></code></pre></div><p>典型使用场景：</p><ul><li>临时下线某个数据库进行维护</li><li>阻止新连接以便安全地进行数据库迁移</li><li>逐步下线即将删除的数据库</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;DISABLE mydb;&#34;</span>      <span style=color:#8f5902;font-style:italic># 禁用 mydb，新连接被拒绝</span>
</span></span></code></pre></div><hr><h3 id=enable>ENABLE</h3><p>使用 <code>ENABLE</code> 命令启用之前被 <code>DISABLE</code> 禁用的数据库，重新接受新的客户端连接。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>ENABLE</span><span style=color:#f8f8f8> </span><span style=color:#000>db</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>-- 启用指定数据库（必须指定数据库名）
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;ENABLE mydb;&#34;</span>       <span style=color:#8f5902;font-style:italic># 启用 mydb，允许新连接</span>
</span></span></code></pre></div><hr><h3 id=reconnect>RECONNECT</h3><p>使用 <code>RECONNECT</code> 命令优雅地重建服务端连接。Pgbouncer 会在连接释放回池后关闭它们，并在需要时建立新连接。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RECONNECT</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- 重建指定数据库的服务端连接，不指定则重建所有
</span></span></span></code></pre></div><p>典型使用场景：</p><ul><li>后端数据库 IP 地址变更后刷新连接</li><li>主从切换后重新路由流量</li><li>DNS 更新后重建连接</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT mydb;&#34;</span>    <span style=color:#8f5902;font-style:italic># 重建 mydb 的服务端连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT;&#34;</span>         <span style=color:#8f5902;font-style:italic># 重建所有服务端连接</span>
</span></span></code></pre></div><p>执行 <code>RECONNECT</code> 后，可以使用 <code>WAIT_CLOSE</code> 等待旧连接完全释放。</p><hr><h3 id=kill>KILL</h3><p>使用 <code>KILL</code> 命令立即断开指定数据库的所有客户端和服务端连接。与 <code>PAUSE</code> 不同，<code>KILL</code> 不等待事务完成，直接强制断开。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>KILL</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic>-- 终止指定数据库的所有连接，不指定则终止所有（admin 除外）
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL mydb;&#34;</span>         <span style=color:#8f5902;font-style:italic># 强制断开 mydb 的所有连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL;&#34;</span>              <span style=color:#8f5902;font-style:italic># 强制断开所有数据库的连接（admin 除外）</span>
</span></span></code></pre></div><p>执行 <code>KILL</code> 后，新连接会被阻塞直到执行 <code>RESUME</code>。</p><hr><h3 id=kill_client>KILL_CLIENT</h3><p>使用 <code>KILL_CLIENT</code> 命令终止指定的客户端连接。客户端 ID 可以从 <code>SHOW CLIENTS</code> 输出中获取。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>KILL_CLIENT</span><span style=color:#f8f8f8> </span><span style=color:#000>id</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- 终止指定 ID 的客户端连接
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看客户端连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW CLIENTS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 终止特定客户端（假设 ptr 列显示的 ID 为 0x1234567890）</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;KILL_CLIENT 0x1234567890;&#34;</span>
</span></span></code></pre></div><hr><h3 id=suspend>SUSPEND</h3><p>使用 <code>SUSPEND</code> 命令挂起 Pgbouncer。Pgbouncer 会刷新所有 socket 缓冲区并停止监听数据，直到执行 <code>RESUME</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SUSPEND</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- 挂起 Pgbouncer
</span></span></span></code></pre></div><p><code>SUSPEND</code> 主要用于实现 Pgbouncer 的在线重启（零停机升级）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 挂起当前 Pgbouncer</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SUSPEND;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 启动新的 Pgbouncer 进程（使用 -R 选项接管 socket）</span>
</span></span><span style=display:flex><span>$ pgbouncer -R /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 新进程接管后，旧进程自动退出</span>
</span></span></code></pre></div><hr><h3 id=shutdown>SHUTDOWN</h3><p>使用 <code>SHUTDOWN</code> 命令关闭 Pgbouncer 进程。支持多种关闭模式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic>-- 立即关闭
</span></span></span><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#f8f8f8> </span><span style=color:#000>WAIT_FOR_SERVERS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic>-- 等待服务端连接释放后关闭
</span></span></span><span style=display:flex><span><span style=color:#000>SHUTDOWN</span><span style=color:#f8f8f8> </span><span style=color:#000>WAIT_FOR_CLIENTS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic>-- 等待客户端断开后关闭（零停机滚动重启）
</span></span></span></code></pre></div><table class=full-width><thead><tr><th>模式</th><th>说明</th></tr></thead><tbody><tr><td><code>SHUTDOWN</code></td><td>立即关闭 Pgbouncer 进程</td></tr><tr><td><code>WAIT_FOR_SERVERS</code></td><td>停止接受新连接，等待服务端连接释放后退出</td></tr><tr><td><code>WAIT_FOR_CLIENTS</code></td><td>停止接受新连接，等待所有客户端断开后退出，适用于滚动重启</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHUTDOWN WAIT_FOR_CLIENTS;&#34;</span>   <span style=color:#8f5902;font-style:italic># 优雅关闭，等待客户端断开</span>
</span></span></code></pre></div><hr><h3 id=reload>RELOAD</h3><p>使用 <code>RELOAD</code> 命令重新加载 Pgbouncer 配置文件。可以动态更新大部分配置参数，无需重启进程。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>RELOAD</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic>-- 重载配置文件
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>              <span style=color:#8f5902;font-style:italic># 通过管理控制台重载</span>
</span></span><span style=display:flex><span>$ systemctl reload pgbouncer    <span style=color:#8f5902;font-style:italic># 通过 systemd 重载</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGHUP <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>  <span style=color:#8f5902;font-style:italic># 通过信号重载</span>
</span></span></code></pre></div><p>Pigsty 提供了重载 Pgbouncer 配置的剧本任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pgbouncer_reload    <span style=color:#8f5902;font-style:italic># 重载集群的 Pgbouncer 配置</span>
</span></span></code></pre></div><hr><h3 id=wait_close>WAIT_CLOSE</h3><p>使用 <code>WAIT_CLOSE</code> 命令等待服务端连接完成关闭。通常在 <code>RECONNECT</code> 或 <code>RELOAD</code> 后使用，确保旧连接已全部释放。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#000>WAIT_CLOSE</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>db</span><span style=color:#000;font-weight:700>];</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- 等待指定数据库的服务端连接关闭，不指定则等待所有
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 完整的连接重建流程</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT mydb;&#34;</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;WAIT_CLOSE mydb;&#34;</span>    <span style=color:#8f5902;font-style:italic># 等待旧连接释放</span>
</span></span></code></pre></div><hr><h3 id=监控命令>监控命令</h3><p>Pgbouncer 提供了丰富的 <code>SHOW</code> 命令用于监控连接池状态：</p><table class=full-width><thead><tr><th>命令</th><th>说明</th></tr></thead><tbody><tr><td><code>SHOW HELP</code></td><td>显示可用命令帮助</td></tr><tr><td><code>SHOW DATABASES</code></td><td>显示数据库配置和状态</td></tr><tr><td><code>SHOW POOLS</code></td><td>显示连接池统计信息</td></tr><tr><td><code>SHOW CLIENTS</code></td><td>显示客户端连接列表</td></tr><tr><td><code>SHOW SERVERS</code></td><td>显示服务端连接列表</td></tr><tr><td><code>SHOW USERS</code></td><td>显示用户配置</td></tr><tr><td><code>SHOW STATS</code></td><td>显示统计信息（请求数、字节数等）</td></tr><tr><td><code>SHOW STATS_TOTALS</code></td><td>显示累计统计信息</td></tr><tr><td><code>SHOW STATS_AVERAGES</code></td><td>显示平均统计信息</td></tr><tr><td><code>SHOW CONFIG</code></td><td>显示当前配置参数</td></tr><tr><td><code>SHOW MEM</code></td><td>显示内存使用情况</td></tr><tr><td><code>SHOW DNS_HOSTS</code></td><td>显示 DNS 缓存的主机名</td></tr><tr><td><code>SHOW DNS_ZONES</code></td><td>显示 DNS 缓存的区域</td></tr><tr><td><code>SHOW SOCKETS</code></td><td>显示打开的 socket 信息</td></tr><tr><td><code>SHOW ACTIVE_SOCKETS</code></td><td>显示活动的 socket</td></tr><tr><td><code>SHOW LISTS</code></td><td>显示内部列表计数</td></tr><tr><td><code>SHOW FDS</code></td><td>显示文件描述符使用情况</td></tr><tr><td><code>SHOW STATE</code></td><td>显示 Pgbouncer 运行状态</td></tr><tr><td><code>SHOW VERSION</code></td><td>显示 Pgbouncer 版本</td></tr></tbody></table><p>常用监控示例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看连接池状态</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW POOLS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看客户端连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW CLIENTS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看服务端连接</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW SERVERS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看统计信息</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW STATS;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看数据库状态</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;SHOW DATABASES;&#34;</span>
</span></span></code></pre></div><p>更多监控命令的详细说明，请参考 <a href=https://www.pgbouncer.org/usage.html><strong>Pgbouncer 官方文档</strong></a>。</p><hr><h3 id=unix-信号>Unix 信号</h3><p>Pgbouncer 支持通过 Unix 信号进行控制，这在无法连接管理控制台时非常有用：</p><table class=full-width><thead><tr><th>信号</th><th>等效命令</th><th>说明</th></tr></thead><tbody><tr><td><code>SIGHUP</code></td><td><code>RELOAD</code></td><td>重载配置文件</td></tr><tr><td><code>SIGTERM</code></td><td><code>SHUTDOWN WAIT_FOR_CLIENTS</code></td><td>优雅关闭，等待客户端断开</td></tr><tr><td><code>SIGINT</code></td><td><code>SHUTDOWN WAIT_FOR_SERVERS</code></td><td>优雅关闭，等待服务端释放</td></tr><tr><td><code>SIGQUIT</code></td><td><code>SHUTDOWN</code></td><td>立即关闭</td></tr><tr><td><code>SIGUSR1</code></td><td><code>PAUSE</code></td><td>暂停所有数据库</td></tr><tr><td><code>SIGUSR2</code></td><td><code>RESUME</code></td><td>恢复所有数据库</td></tr></tbody></table><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过信号重载配置</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGHUP <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过信号优雅关闭</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGTERM <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过信号暂停</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGUSR1 <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过信号恢复</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>kill</span> -SIGUSR2 <span style=color:#204a87;font-weight:700>$(</span>cat /var/run/pgbouncer/pgbouncer.pid<span style=color:#204a87;font-weight:700>)</span>
</span></span></code></pre></div><hr><h2 id=流量切换>流量切换</h2><p>Pigsty 提供了 <code>pgb-route</code> 实用函数，可以将 Pgbouncer 流量快速切换至其他节点，用于零停机迁移：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 定义（已在 /etc/profile.d/pg-alias.sh 中）</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pgb-route<span style=color:#ce5c00;font-weight:700>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>local</span> <span style=color:#000>ip</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>1</span><span style=color:#000;font-weight:700>-</span><span style=color:#4e9a06>&#39;\/var\/run\/postgresql&#39;</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>  sed -ie <span style=color:#4e9a06>&#34;s/host=[^[:space:]]\+/host=</span><span style=color:#4e9a06>${</span><span style=color:#000>ip</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用：将流量路由到 10.10.10.12</span>
</span></span><span style=display:flex><span>$ pgb-route 10.10.10.12
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT; WAIT_CLOSE;&#34;</span>
</span></span></code></pre></div><p>完整的零停机切换流程：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 修改路由目标</span>
</span></span><span style=display:flex><span>$ pgb-route 10.10.10.12
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 重载配置</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RELOAD;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 重建连接并等待旧连接释放</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;RECONNECT;&#34;</span>
</span></span><span style=display:flex><span>$ pgb -c <span style=color:#4e9a06>&#34;WAIT_CLOSE;&#34;</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-ef5d737e5bae0aa77e9e8e5340965fd9>6 - 管理 PostgreSQL 组件服务</h1><div class=lead>使用 systemctl 管理 PostgreSQL 集群中的各个组件服务：启动、停止、重启、重载与状态检查。</div><h2 id=概述>概述</h2><p>Pigsty 的 PGSQL 模块由多个组件构成，每个组件都以 systemd 服务的形式运行在节点上。（ <a href=/docs/concept/arch/pgsql#pgbackrest><strong>pgbackrest</strong></a> 除外）</p><p>了解这些组件及其管理方式，对于维护生产环境中的 PostgreSQL 集群非常重要。</p><table class=full-width><thead><tr><th style=text-align:left>组件</th><th style=text-align:left>端口</th><th style=text-align:left>服务名</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>Patroni</td><td style=text-align:left><strong><code>8008</code></strong></td><td style=text-align:left><code>patroni</code></td><td style=text-align:left>高可用管理器，负责 PostgreSQL 的生命周期管理</td></tr><tr><td style=text-align:left>PostgreSQL</td><td style=text-align:left><strong><code>5432</code></strong></td><td style=text-align:left><code>postgres</code></td><td style=text-align:left>占位服务，默认不使用，应急使用</td></tr><tr><td style=text-align:left>Pgbouncer</td><td style=text-align:left><strong><code>6432</code></strong></td><td style=text-align:left><code>pgbouncer</code></td><td style=text-align:left>连接池中间件，业务流量入口</td></tr><tr><td style=text-align:left>PgBackRest</td><td style=text-align:left>-</td><td style=text-align:left>-</td><td style=text-align:left>pgBackRest 没有守护服务</td></tr><tr><td style=text-align:left>HAProxy</td><td style=text-align:left><strong><code>543x</code></strong></td><td style=text-align:left><code>haproxy</code></td><td style=text-align:left>负载均衡器，暴露数据库服务</td></tr><tr><td style=text-align:left>pg_exporter</td><td style=text-align:left><strong><code>9630</code></strong></td><td style=text-align:left><code>pg_exporter</code></td><td style=text-align:left>PostgreSQL 监控指标导出器</td></tr><tr><td style=text-align:left>pgbouncer_exporter</td><td style=text-align:left><strong><code>9631</code></strong></td><td style=text-align:left><code>pgbouncer_exporter</code></td><td style=text-align:left>Pgbouncer 监控指标导出器</td></tr><tr><td style=text-align:left>vip-manager</td><td style=text-align:left>-</td><td style=text-align:left><code>vip-manager</code></td><td style=text-align:left>可选，管理 L2 VIP 地址漂移</td></tr></tbody></table><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>重要提示</div><p><strong>不要直接使用 systemctl 管理 PostgreSQL 服务</strong>。PostgreSQL 由 Patroni 托管，应通过 <a href=/docs/pgsql/admin/patroni><strong><code>patronictl</code></strong></a> 命令进行管理。
直接操作 PostgreSQL 可能导致 Patroni 状态不一致，触发意外的故障转移。<code>postgres</code> 服务是 Patroni 服务失效时的应急逃生窗口。</p></div><hr><h2 id=命令速查>命令速查</h2><table><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>命令</th></tr></thead><tbody><tr><td style=text-align:left>启动服务</td><td style=text-align:left><code>systemctl start &lt;service></code></td></tr><tr><td style=text-align:left>停止服务</td><td style=text-align:left><code>systemctl stop &lt;service></code></td></tr><tr><td style=text-align:left>重启服务</td><td style=text-align:left><code>systemctl restart &lt;service></code></td></tr><tr><td style=text-align:left>重载配置</td><td style=text-align:left><code>systemctl reload &lt;service></code></td></tr><tr><td style=text-align:left>查看状态</td><td style=text-align:left><code>systemctl status &lt;service></code></td></tr><tr><td style=text-align:left>查看日志</td><td style=text-align:left><code>journalctl -u &lt;service> -f</code></td></tr><tr><td style=text-align:left>开机启动</td><td style=text-align:left><code>systemctl enable &lt;service></code></td></tr><tr><td style=text-align:left>禁用启动</td><td style=text-align:left><code>systemctl disable &lt;service></code></td></tr></tbody></table><p>常用组件服务名：<code>patroni</code>、<code>pgbouncer</code>、<code>haproxy</code>、<code>pg_exporter</code>、<code>pgbouncer_exporter</code>、<code>vip-manager</code></p><hr><h2 id=patroni>Patroni</h2><p><a href=https://patroni.readthedocs.io/><strong>Patroni</strong></a> 是 PostgreSQL 的高可用管理器，负责 PostgreSQL 的启动、停止、故障检测与自动故障转移。
它是 PGSQL 模块的核心组件，PostgreSQL 进程由 Patroni 托管，不应直接通过 systemctl 管理 postgres 服务。</p><p><strong>启动 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start patroni     <span style=color:#8f5902;font-style:italic># 启动 Patroni（同时启动 PostgreSQL）</span>
</span></span></code></pre></div><p>启动 Patroni 后，它会自动拉起 PostgreSQL 进程。首次启动时，Patroni 会根据角色决定行为：</p><ul><li>主库：初始化或恢复数据目录</li><li>从库：从主库克隆数据并建立复制</li></ul><p><strong>停止 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop patroni      <span style=color:#8f5902;font-style:italic># 停止 Patroni（同时停止 PostgreSQL）</span>
</span></span></code></pre></div><p>停止 Patroni 时，它会优雅地关闭 PostgreSQL 进程。注意：如果这是主库，且未暂停自动切换，可能触发故障转移。</p><p><strong>重启 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni   <span style=color:#8f5902;font-style:italic># 重启 Patroni（同时重启 PostgreSQL）</span>
</span></span></code></pre></div><p>重启会导致短暂的服务中断。对于生产环境，建议使用 <code>pg restart</code> 命令进行滚动重启。</p><p><strong>重载 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload patroni    <span style=color:#8f5902;font-style:italic># 重载 Patroni 配置</span>
</span></span></code></pre></div><p>重载会让 Patroni 重新读取配置文件，并将可热加载的参数应用到 PostgreSQL。</p><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status patroni    <span style=color:#8f5902;font-style:italic># 查看 Patroni 服务状态</span>
</span></span><span style=display:flex><span>journalctl -u patroni -f    <span style=color:#8f5902;font-style:italic># 实时查看 Patroni 日志</span>
</span></span><span style=display:flex><span>journalctl -u patroni -n <span style=color:#0000cf;font-weight:700>100</span> --no-pager  <span style=color:#8f5902;font-style:italic># 查看最近 100 行日志</span>
</span></span></code></pre></div><p><strong>配置文件位置</strong>：<code>/etc/patroni/patroni.yml</code></p><blockquote><p><strong>最佳实践</strong>：使用 <a href=/docs/pgsql/admin/patroni><strong><code>patronictl</code></strong></a> 而非 systemctl 管理 PostgreSQL 集群。</p></blockquote><hr><h2 id=pgbouncer>Pgbouncer</h2><p><a href=https://www.pgbouncer.org/><strong>Pgbouncer</strong></a> 是轻量级的 PostgreSQL 连接池中间件。
业务流量通常通过 Pgbouncer（6432 端口）而非直接连接 PostgreSQL（5432 端口），以实现连接复用和保护数据库。</p><p><strong>启动 Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pgbouncer
</span></span></code></pre></div><p><strong>停止 Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pgbouncer
</span></span></code></pre></div><p>注意：停止 Pgbouncer 会中断所有通过连接池的业务连接。</p><p><strong>重启 Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart pgbouncer
</span></span></code></pre></div><p>重启会断开所有现有连接。如果只是配置变更，建议使用 <code>reload</code>。</p><p><strong>重载 Pgbouncer</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload pgbouncer
</span></span></code></pre></div><p>重载会重新读取配置文件（用户列表、连接池参数等），不会断开现有连接。</p><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pgbouncer
</span></span><span style=display:flex><span>journalctl -u pgbouncer -f
</span></span></code></pre></div><p><strong>配置文件位置</strong>：</p><ul><li>主配置：<code>/etc/pgbouncer/pgbouncer.ini</code></li><li>HBA 规则：<code>/etc/pgbouncer/pgb_hba.conf</code></li><li>用户列表：<code>/etc/pgbouncer/userlist.txt</code></li><li>数据库列表：<code>/etc/pgbouncer/database.txt</code></li></ul><p><strong>管理控制台</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>6432</span> -U postgres -d pgbouncer  <span style=color:#8f5902;font-style:italic># 连接到 Pgbouncer 管理控制台</span>
</span></span></code></pre></div><p>常用管理命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>POOLS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- 查看连接池状态
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>CLIENTS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- 查看客户端连接
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>SERVERS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- 查看后端服务器连接
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SHOW</span><span style=color:#f8f8f8> </span><span style=color:#000>STATS</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- 查看统计信息
</span></span></span><span style=display:flex><span><span style=color:#000>RELOAD</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- 重载配置
</span></span></span><span style=display:flex><span><span style=color:#000>PAUSE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 暂停所有连接池
</span></span></span><span style=display:flex><span><span style=color:#000>RESUME</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>          </span><span style=color:#8f5902;font-style:italic>-- 恢复所有连接池
</span></span></span></code></pre></div><hr><h2 id=haproxy>HAProxy</h2><p><a href=https://www.haproxy.org/><strong>HAProxy</strong></a> 是高性能的负载均衡器，负责将流量分发到正确的 PostgreSQL 实例。
Pigsty 使用 HAProxy 暴露 <a href=/docs/pgsql/service/><strong>服务</strong></a>，根据角色（主库/从库）和健康状态进行流量调度。</p><p><strong>启动 HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start haproxy
</span></span></code></pre></div><p><strong>停止 HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop haproxy
</span></span></code></pre></div><p>注意：停止 HAProxy 会中断所有通过负载均衡器的连接。</p><p><strong>重启 HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart haproxy
</span></span></code></pre></div><p><strong>重载 HAProxy</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload haproxy
</span></span></code></pre></div><p>HAProxy 支持优雅重载，不会断开现有连接。配置变更后推荐使用 <code>reload</code>。</p><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status haproxy
</span></span><span style=display:flex><span>journalctl -u haproxy -f
</span></span></code></pre></div><p><strong>配置文件位置</strong>：<code>/etc/haproxy/haproxy.cfg</code></p><p><strong>管理界面</strong></p><p>HAProxy 提供 Web 管理界面，默认监听在 9101 端口：</p><pre tabindex=0><code>http://&lt;node_ip&gt;:9101/haproxy
</code></pre><p>默认认证：用户名 <code>admin</code>，密码由 <a href=/docs/node/param#haproxy_admin_password><strong><code>haproxy_admin_password</code></strong></a> 配置。</p><hr><h2 id=pg_exporter>pg_exporter</h2><p><a href=https://github.com/Vonng/pg_exporter><strong>pg_exporter</strong></a> 是 PostgreSQL 的 Prometheus 监控指标导出器，负责采集数据库性能指标。</p><p><strong>启动 pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pg_exporter
</span></span></code></pre></div><p><strong>停止 pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pg_exporter
</span></span></code></pre></div><p>停止后，Prometheus 将无法采集该实例的 PostgreSQL 监控指标。</p><p><strong>重启 pg_exporter</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart pg_exporter
</span></span></code></pre></div><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pg_exporter
</span></span><span style=display:flex><span>journalctl -u pg_exporter -f
</span></span></code></pre></div><p><strong>配置文件位置</strong>：<code>/etc/pg_exporter.yml</code></p><p><strong>验证指标采集</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s localhost:9630/metrics <span style=color:#000;font-weight:700>|</span> head -20
</span></span></code></pre></div><hr><h2 id=pgbouncer_exporter>pgbouncer_exporter</h2><p><strong>pgbouncer_exporter</strong> 是 Pgbouncer 的 Prometheus 监控指标导出器。</p><p><strong>启动/停止/重启</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start pgbouncer_exporter
</span></span><span style=display:flex><span>systemctl stop pgbouncer_exporter
</span></span><span style=display:flex><span>systemctl restart pgbouncer_exporter
</span></span></code></pre></div><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status pgbouncer_exporter
</span></span><span style=display:flex><span>journalctl -u pgbouncer_exporter -f
</span></span></code></pre></div><p><strong>验证指标采集</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -s localhost:9631/metrics <span style=color:#000;font-weight:700>|</span> head -20
</span></span></code></pre></div><hr><h2 id=vip-manager>vip-manager</h2><p><a href=https://github.com/cybertec-postgresql/vip-manager><strong>vip-manager</strong></a> 是可选组件，用于管理 L2 VIP 地址漂移。
当启用 <a href=/docs/pgsql/param#pg_vip_enabled><strong><code>pg_vip_enabled</code></strong></a> 时，vip-manager 会将 VIP 绑定到当前主库节点。</p><p><strong>启动 vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start vip-manager
</span></span></code></pre></div><p><strong>停止 vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop vip-manager
</span></span></code></pre></div><p>停止后，VIP 地址会从当前节点释放。</p><p><strong>重启 vip-manager</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart vip-manager
</span></span></code></pre></div><p><strong>查看状态与日志</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status vip-manager
</span></span><span style=display:flex><span>journalctl -u vip-manager -f
</span></span></code></pre></div><p><strong>配置文件位置</strong>：<code>/etc/default/vip-manager</code></p><p><strong>验证 VIP 绑定</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ip addr show           <span style=color:#8f5902;font-style:italic># 查看网络接口，检查 VIP 是否绑定</span>
</span></span><span style=display:flex><span>pg list &lt;cls&gt;          <span style=color:#8f5902;font-style:italic># 确认主库位置</span>
</span></span></code></pre></div><hr><h2 id=启动顺序与依赖>启动顺序与依赖</h2><p>PGSQL 模块组件的推荐启动顺序：</p><pre tabindex=0><code>1. patroni          # 首先启动 Patroni（会自动启动 PostgreSQL）
2. pgbouncer        # 然后启动连接池
3. haproxy          # 启动负载均衡器
4. pg_exporter      # 启动监控导出器
5. pgbouncer_exporter
6. vip-manager      # 最后启动 VIP 管理器（如果启用）
</code></pre><p>停止顺序应相反。Pigsty 剧本会自动处理这些依赖关系。</p><p><strong>批量启动所有服务</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl start patroni pgbouncer haproxy pg_exporter pgbouncer_exporter
</span></span></code></pre></div><p><strong>批量停止所有服务</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl stop pgbouncer_exporter pg_exporter haproxy pgbouncer patroni
</span></span></code></pre></div><hr><h2 id=常见故障排查>常见故障排查</h2><p><strong>服务启动失败</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl status &lt;service&gt;        <span style=color:#8f5902;font-style:italic># 查看服务状态</span>
</span></span><span style=display:flex><span>journalctl -u &lt;service&gt; -n <span style=color:#0000cf;font-weight:700>50</span>     <span style=color:#8f5902;font-style:italic># 查看最近日志</span>
</span></span><span style=display:flex><span>journalctl -u &lt;service&gt; --since <span style=color:#4e9a06>&#34;5 min ago&#34;</span>  <span style=color:#8f5902;font-style:italic># 查看最近 5 分钟日志</span>
</span></span></code></pre></div><p><strong>Patroni 无法启动</strong></p><table><thead><tr><th style=text-align:left>现象</th><th style=text-align:left>可能原因</th><th style=text-align:left>解决方案</th></tr></thead><tbody><tr><td style=text-align:left>无法连接 etcd</td><td style=text-align:left>etcd 集群不可用</td><td style=text-align:left>检查 etcd 服务状态</td></tr><tr><td style=text-align:left>数据目录权限错误</td><td style=text-align:left>文件所有权不是 postgres</td><td style=text-align:left><code>chown -R postgres:postgres /pg/data</code></td></tr><tr><td style=text-align:left>端口被占用</td><td style=text-align:left>PostgreSQL 残留进程</td><td style=text-align:left><code>pg_ctl stop -D /pg/data</code> 或 <code>kill</code></td></tr></tbody></table><p><strong>Pgbouncer 无法启动</strong></p><table><thead><tr><th style=text-align:left>现象</th><th style=text-align:left>可能原因</th><th style=text-align:left>解决方案</th></tr></thead><tbody><tr><td style=text-align:left>配置文件语法错误</td><td style=text-align:left>INI 格式错误</td><td style=text-align:left>检查 <code>/etc/pgbouncer/pgbouncer.ini</code></td></tr><tr><td style=text-align:left>端口被占用</td><td style=text-align:left>6432 端口已被使用</td><td style=text-align:left><code>lsof -i :6432</code></td></tr><tr><td style=text-align:left>userlist.txt 权限</td><td style=text-align:left>文件权限不正确</td><td style=text-align:left><code>chmod 600 /etc/pgbouncer/userlist.txt</code></td></tr></tbody></table><p><strong>HAProxy 无法启动</strong></p><table><thead><tr><th style=text-align:left>现象</th><th style=text-align:left>可能原因</th><th style=text-align:left>解决方案</th></tr></thead><tbody><tr><td style=text-align:left>配置文件语法错误</td><td style=text-align:left>haproxy.cfg 格式错误</td><td style=text-align:left><code>haproxy -c -f /etc/haproxy/haproxy.cfg</code></td></tr><tr><td style=text-align:left>端口被占用</td><td style=text-align:left>服务端口冲突</td><td style=text-align:left><code>lsof -i :5433</code></td></tr></tbody></table><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni 管理</strong></a>：使用 patronictl 管理 PostgreSQL 高可用</li><li><a href=/docs/pgsql/admin/cluster/><strong>集群管理</strong></a>：集群的创建、扩缩容、销毁</li><li><a href=/docs/pgsql/service/><strong>服务配置</strong></a>：HAProxy 服务定义与配置</li><li><a href=/docs/pgsql/monitor/><strong>监控系统</strong></a>：PostgreSQL 监控与告警</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-d6d9a4c3d54ca40e435a862870043f19>7 - 管理 PostgreSQL 定时任务</h1><div class=lead>配置 Crontab 定期调度 PostgreSQL 备份任务，执行备份 / Vacuum Freeze / Analyze 任务，以及处理表膨胀</div><p>Pigsty 使用 crontab 来管理定时任务，用于执行例行备份，冻结老化事务，重整膨胀表索引等维护工作。</p><h2 id=速查手册>速查手册</h2><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1><strong>配置定时任务</strong></a></td><td style=text-align:left><code>./pgsql.yml -t pg_crontab -l &lt;cls></code></td><td style=text-align:left>应用 pg_crontab 配置</td></tr><tr><td style=text-align:left><a href=#%E6%9F%A5%E7%9C%8B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1><strong>查看定时任务</strong></a></td><td style=text-align:left><code>crontab -l</code></td><td style=text-align:left>以 postgres 用户查看</td></tr><tr><td style=text-align:left><a href=#pg-backup><strong>物理备份</strong></a></td><td style=text-align:left><code>pg-backup [full|diff|incr]</code></td><td style=text-align:left>使用 pgBackRest 执行备份</td></tr><tr><td style=text-align:left><a href=#pg-vacuum><strong>事务冻结</strong></a></td><td style=text-align:left><code>pg-vacuum [database...]</code></td><td style=text-align:left>冻结老化事务，预防 XID 回卷</td></tr><tr><td style=text-align:left><a href=#pg-repack><strong>膨胀治理</strong></a></td><td style=text-align:left><code>pg-repack [database...]</code></td><td style=text-align:left>在线重整膨胀的表与索引</td></tr></tbody></table><p>其他管理任务，请参考：<a href=/docs/pgsql/backup/><strong>备份管理</strong></a>，<a href=/docs/pgsql/monitor/><strong>监控系统</strong></a>，<a href=/docs/pgsql/admin/patroni><strong>高可用管理</strong></a>。</p><hr><h2 id=配置定时任务>配置定时任务</h2><p>使用 <a href=/docs/pgsql/param/#pg_crontab><strong><code>pg_crontab</code></strong></a> 参数配置 PostgreSQL 数据库超级用户（<a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a>，默认 <code>postgres</code>）的定时任务。</p><p>下面 <code>pg-meta</code> 集群配置了每天凌晨1点进行全量备份的定时任务，<code>pg-test</code> 配置了每周一全量备份，其余日期增量备份的定时任务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>推荐的维护计划</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 每天凌晨1点全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 03 * * 0 /pg/bin/pg-vacuum&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 每周日凌晨3点执行 vacuum freeze</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 04 * * 1 /pg/bin/pg-repack&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 每周一凌晨4点执行 repack</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><table class=full-width><thead><tr><th style=text-align:left>任务</th><th style=text-align:left>频率</th><th style=text-align:left>时机</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><code>pg-backup</code></td><td style=text-align:left>每天</td><td style=text-align:left>凌晨</td><td style=text-align:left>全量或增量备份，视业务需求而定</td></tr><tr><td style=text-align:left><code>pg-vacuum</code></td><td style=text-align:left>每周一次</td><td style=text-align:left>周日凌晨</td><td style=text-align:left>冻结老化事务，预防 XID 回卷</td></tr><tr><td style=text-align:left><code>pg-repack</code></td><td style=text-align:left>每周/每月</td><td style=text-align:left>业务低峰期</td><td style=text-align:left>重整膨胀表索引，回收空间</td></tr></tbody></table><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>仅在主库执行</div><p><code>pg-backup</code>、<code>pg-vacuum</code>、<code>pg-repack</code> 脚本会自动检测当前节点角色，只有主库才会实际执行，从库会直接退出。</p><p>因此可以安全地在所有节点配置相同的定时任务，故障切换后新主库会自动继续执行维护任务。</p></div><hr><h2 id=应用定时任务>应用定时任务</h2><p>定时任务会在 <a href=/docs/pgsql/playbook#pgsqlyml><strong><code>pgsql.yml</code></strong></a> 剧本执行时（<code>pg_crontab</code> 任务）自动写入对应操作系统发行版的默认位置：</p><ul><li>EL（RHEL/Rocky/Alma）：<code>/var/spool/cron/postgres</code></li><li>Debian/Ubuntu：<code>/var/spool/cron/crontabs/postgres</code></li></ul><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=剧本 aria-controls=tabs-01-00 aria-selected=true>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=手工 aria-controls=tabs-01-01 aria-selected=false>
手工</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_crontab     <span style=color:#8f5902;font-style:italic># 应用 pg_crontab 配置到指定集群</span>
</span></span><span style=display:flex><span>./pgsql.yml -l 10.10.10.10 -t pg_crontab <span style=color:#8f5902;font-style:italic># 仅针对特定主机</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 以 postgres 用户编辑定时任务</span>
</span></span><span style=display:flex><span>sudo -u postgres crontab -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或直接编辑 crontab 文件</span>
</span></span><span style=display:flex><span>sudo vi /var/spool/cron/postgres           <span style=color:#8f5902;font-style:italic># EL 系列</span>
</span></span><span style=display:flex><span>sudo vi /var/spool/cron/crontabs/postgres  <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><p>每次执行剧本都会 <strong>全量覆盖刷新</strong> 定时任务配置。</p><hr><h2 id=查看定时任务>查看定时任务</h2><p>使用 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> 操作系统用户执行以下命令查看定时任务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>crontab -l
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pigsty Managed Crontab for postgres</span>
</span></span><span style=display:flex><span><span style=color:#000>SHELL</span><span style=color:#ce5c00;font-weight:700>=</span>/bin/bash
</span></span><span style=display:flex><span><span style=color:#000>PATH</span><span style=color:#ce5c00;font-weight:700>=</span>/usr/pgsql/bin:/pg/bin:/usr/local/bin:/usr/bin:/usr/sbin:/bin:/sbin
</span></span><span style=display:flex><span><span style=color:#000>MAILTO</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#0000cf;font-weight:700>00</span> <span style=color:#0000cf;font-weight:700>01</span> * * * /pg/bin/pg-backup
</span></span></code></pre></div><p>如果您不熟悉 Crontab 的语法，可以参考 <a href=https://crontab.guru/>Crontab Guru</a> 的解释。</p><hr><h2 id=pg-backup>pg-backup</h2><p><code>pg-backup</code> 是 Pigsty 提供的物理备份脚本，基于 <a href=https://pgbackrest.org/><strong>pgBackRest</strong></a> 实现，支持全量、差异、增量三种备份模式。</p><p><strong>基本用法</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup                <span style=color:#8f5902;font-style:italic># 执行增量备份（默认），如果没有全量备份则自动执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup full           <span style=color:#8f5902;font-style:italic># 执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup diff           <span style=color:#8f5902;font-style:italic># 执行差异备份（基于最近的全量备份）</span>
</span></span><span style=display:flex><span>pg-backup incr           <span style=color:#8f5902;font-style:italic># 执行增量备份（基于最近的任意备份）</span>
</span></span></code></pre></div><p><strong>备份类型说明</strong></p><table class=full-width><thead><tr><th style=text-align:left>类型</th><th style=text-align:left>参数</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left>全量备份</td><td style=text-align:left><code>full</code></td><td style=text-align:left>完整备份所有数据，恢复时只需要该备份</td></tr><tr><td style=text-align:left>差异备份</td><td style=text-align:left><code>diff</code></td><td style=text-align:left>备份自上次全量备份以来的变更，恢复时需要全量+差异</td></tr><tr><td style=text-align:left>增量备份</td><td style=text-align:left><code>incr</code></td><td style=text-align:left>备份自上次任意备份以来的变更，恢复时需要完整链路</td></tr></tbody></table><p><strong>执行条件</strong></p><ul><li>脚本必须在 <strong>主库</strong> 上以 <strong>postgres</strong> 用户身份运行</li><li>脚本会自动检测当前节点角色，从库执行时会直接退出（exit 1）</li><li>从 <code>/etc/pgbackrest/pgbackrest.conf</code> 中自动获取 stanza 名称</li></ul><p><strong>常用定时任务配置</strong></p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=每日全量 aria-controls=tabs-02-00 aria-selected=true>
每日全量</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=周全量+日增量 aria-controls=tabs-02-01 aria-selected=false>
周全量+日增量</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=周全量+日差异 aria-controls=tabs-02-02 aria-selected=false>
周全量+日差异</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 每天凌晨1点全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 周一全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 其他日期增量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1            /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 周一全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7  /pg/bin/pg-backup diff&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 其他日期差异备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p>更多备份恢复操作，请参考 <a href=/docs/pgsql/backup/><strong>备份管理</strong></a> 章节。</p><hr><h2 id=pg-vacuum>pg-vacuum</h2><p><code>pg-vacuum</code> 是 Pigsty 提供的事务冻结脚本，用于执行 <code>VACUUM FREEZE</code> 操作，防止事务ID（XID）回卷导致数据库停机。</p><p><strong>基本用法</strong></p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist=基本 aria-controls=tabs-03-00 aria-selected=true>
基本</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist=选项 aria-controls=tabs-03-01 aria-selected=false>
选项</button></li><li class=nav-item><button class=nav-link id=tabs-03-02-tab data-bs-toggle=tab data-bs-target=#tabs-03-02 role=tab data-td-tp-persist=手工sql aria-controls=tabs-03-02 aria-selected=false>
手工SQL</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-vacuum                    <span style=color:#8f5902;font-style:italic># 冻结所有数据库中的老化表</span>
</span></span><span style=display:flex><span>pg-vacuum mydb               <span style=color:#8f5902;font-style:italic># 仅处理指定数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-vacuum -n mydb            <span style=color:#8f5902;font-style:italic># 空跑模式，只显示不执行</span>
</span></span><span style=display:flex><span>pg-vacuum -a <span style=color:#0000cf;font-weight:700>80000000</span> mydb   <span style=color:#8f5902;font-style:italic># 使用自定义年龄阈值（默认1亿）</span>
</span></span><span style=display:flex><span>pg-vacuum -r <span style=color:#0000cf;font-weight:700>50</span> mydb         <span style=color:#8f5902;font-style:italic># 使用自定义老化比例阈值（默认40%）</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-02 role=tabpanel aria-labelled-by=tabs-03-02-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对整个数据库执行 VACUUM FREEZE
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VACUUM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FREEZE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对特定表执行 VACUUM FREEZE
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>VACUUM</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FREEZE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#000;font-weight:700>.</span><span style=color:#204a87;font-weight:700>table_name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div></div><p><strong>命令选项</strong></p><table class=full-width><thead><tr><th style=text-align:left>选项</th><th style=text-align:left>说明</th><th style=text-align:left>默认值</th></tr></thead><tbody><tr><td style=text-align:left><code>-h, --help</code></td><td style=text-align:left>显示帮助信息</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>-n, --dry-run</code></td><td style=text-align:left>空跑模式，只显示不执行</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-a, --age</code></td><td style=text-align:left>年龄阈值，超过此值的表需要冻结</td><td style=text-align:left>100000000</td></tr><tr><td style=text-align:left><code>-r, --ratio</code></td><td style=text-align:left>老化比例阈值，超过则全库冻结（%）</td><td style=text-align:left>40</td></tr></tbody></table><p><strong>工作逻辑</strong></p><ol><li>检查数据库的 <code>datfrozenxid</code> 年龄，如果低于阈值则跳过该库</li><li>计算老化页面比例（超过年龄阈值的表页面占总页面的百分比）</li><li>如果老化比例 > 40%，执行全库 <code>VACUUM FREEZE ANALYZE</code></li><li>否则，仅对超过年龄阈值的表执行 <code>VACUUM FREEZE ANALYZE</code></li></ol><p>脚本会设置 <code>vacuum_cost_limit = 10000</code> 和 <code>vacuum_cost_delay = 1ms</code> 以控制 I/O 影响。</p><p><strong>执行条件</strong></p><ul><li>脚本必须在 <strong>主库</strong> 上以 <a href=/docs/pgsql/param#pg_dbsu><strong><code>pg_dbsu</code></strong></a> <strong>postgres</strong> 用户身份运行</li><li>使用文件锁 <code>/tmp/pg-vacuum.lock</code> 防止并发执行</li><li>自动跳过 <code>template0</code>、<code>template1</code>、<code>postgres</code> 系统数据库</li></ul><p><strong>常用定时任务配置</strong></p><p>建议将 vacuum 任务与备份/Repack 任务分开执行，避免冲突。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 03 * * 0 /pg/bin/pg-vacuum&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># 每周日凌晨3点执行</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=pg-repack>pg-repack</h2><p><code>pg-repack</code> 是 Pigsty 提供的膨胀治理脚本，基于 <a href=https://reorg.github.io/pg_repack/><strong>pg_repack</strong></a> 扩展实现，用于在线重整膨胀的表与索引。</p><p><strong>基本用法</strong></p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=基本 aria-controls=tabs-04-00 aria-selected=true>
基本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=选项 aria-controls=tabs-04-01 aria-selected=false>
选项</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab data-td-tp-persist=手工 aria-controls=tabs-04-02 aria-selected=false>
手工</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-repack                    <span style=color:#8f5902;font-style:italic># 重整所有数据库中的膨胀表与索引</span>
</span></span><span style=display:flex><span>pg-repack mydb               <span style=color:#8f5902;font-style:italic># 仅重整指定数据库</span>
</span></span><span style=display:flex><span>pg-repack mydb1 mydb2        <span style=color:#8f5902;font-style:italic># 重整多个数据库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-repack -n mydb            <span style=color:#8f5902;font-style:italic># 空跑模式，只显示不执行</span>
</span></span><span style=display:flex><span>pg-repack -t mydb            <span style=color:#8f5902;font-style:italic># 仅重整表</span>
</span></span><span style=display:flex><span>pg-repack -i mydb            <span style=color:#8f5902;font-style:italic># 仅重整索引</span>
</span></span><span style=display:flex><span>pg-repack -T <span style=color:#0000cf;font-weight:700>30</span> -j <span style=color:#0000cf;font-weight:700>4</span> mydb    <span style=color:#8f5902;font-style:italic># 自定义锁超时(秒)和并行度</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接使用 pg_repack 命令重整特定表</span>
</span></span><span style=display:flex><span>pg_repack dbname -t schema.table
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接使用 pg_repack 命令重整特定索引</span>
</span></span><span style=display:flex><span>pg_repack dbname -i schema.index
</span></span></code></pre></div></div></div><p><strong>命令选项</strong></p><table class=full-width><thead><tr><th style=text-align:left>选项</th><th style=text-align:left>说明</th><th style=text-align:left>默认值</th></tr></thead><tbody><tr><td style=text-align:left><code>-h, --help</code></td><td style=text-align:left>显示帮助信息</td><td style=text-align:left>-</td></tr><tr><td style=text-align:left><code>-n, --dry-run</code></td><td style=text-align:left>空跑模式，只显示不执行</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-t, --table</code></td><td style=text-align:left>仅重整表</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-i, --index</code></td><td style=text-align:left>仅重整索引</td><td style=text-align:left>false</td></tr><tr><td style=text-align:left><code>-T, --timeout</code></td><td style=text-align:left>锁等待超时时间（秒）</td><td style=text-align:left>10</td></tr><tr><td style=text-align:left><code>-j, --jobs</code></td><td style=text-align:left>并行作业数</td><td style=text-align:left>2</td></tr></tbody></table><p><strong>自动选择阈值</strong></p><p>脚本会根据表和索引的大小与膨胀率，自动选择需要重整的对象：</p><p><strong>表膨胀阈值</strong></p><table class=full-width><thead><tr><th style=text-align:left>大小范围</th><th style=text-align:center>膨胀率阈值</th><th style=text-align:center>最大数量</th></tr></thead><tbody><tr><td style=text-align:left>&lt; 256MB</td><td style=text-align:center>> 40%</td><td style=text-align:center>64</td></tr><tr><td style=text-align:left>256MB - 2GB</td><td style=text-align:center>> 30%</td><td style=text-align:center>16</td></tr><tr><td style=text-align:left>2GB - 8GB</td><td style=text-align:center>> 20%</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>8GB - 64GB</td><td style=text-align:center>> 15%</td><td style=text-align:center>1</td></tr></tbody></table><p><strong>索引膨胀阈值</strong></p><table class=full-width><thead><tr><th style=text-align:left>大小范围</th><th style=text-align:center>膨胀率阈值</th><th style=text-align:center>最大数量</th></tr></thead><tbody><tr><td style=text-align:left>&lt; 128MB</td><td style=text-align:center>> 40%</td><td style=text-align:center>64</td></tr><tr><td style=text-align:left>128MB - 1GB</td><td style=text-align:center>> 35%</td><td style=text-align:center>16</td></tr><tr><td style=text-align:left>1GB - 8GB</td><td style=text-align:center>> 30%</td><td style=text-align:center>4</td></tr><tr><td style=text-align:left>8GB - 64GB</td><td style=text-align:center>> 20%</td><td style=text-align:center>1</td></tr></tbody></table><p>超过 64GB 的巨型表/索引会被跳过并给出提示，需要手动处理。</p><p><strong>执行条件</strong></p><ul><li>脚本必须在 <strong>主库</strong> 上以 <strong>postgres</strong> 用户身份运行</li><li>需要安装 <code>pg_repack</code> 扩展（Pigsty 默认安装）</li><li>需要 <code>monitor</code> schema 中的 <code>pg_table_bloat</code> 和 <code>pg_index_bloat</code> 视图</li><li>使用文件锁 <code>/tmp/pg-repack.lock</code> 防止并发执行</li><li>自动跳过 <code>template0</code>、<code>template1</code>、<code>postgres</code> 系统数据库</li></ul><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>锁等待</div><p>重整期间不会影响正常读写，但重整完毕的 <strong>切换瞬间</strong> 需要获取表上的 AccessExclusive 锁阻塞一切访问。对于高吞吐量业务，建议在业务低峰期或维护窗口进行。</p></div><p><strong>常用定时任务配置</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 04 * * 1 /pg/bin/pg-repack&#39;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># 每周一凌晨4点执行</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您可以通过 Pigsty 的 <a href=https://demo.pigsty.cc/d/pgcat-database><strong>PGCAT Database - Table Bloat</strong></a> 面板确认数据库中的膨胀情况，并选择膨胀率较高的表与索引进行重整。</p><p>更多细节请参考：<a href=https://vonng.com/pg/bloat/><strong>关系膨胀的治理</strong></a></p><hr><h2 id=移除定时任务>移除定时任务</h2><p>当使用 <a href=/docs/pgsql/playbook#pgsql-rmyml><strong><code>pgsql-rm.yml</code></strong></a> 剧本移除 PostgreSQL 集群时，会自动删除 postgres 用户的 crontab 文件。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt; -t pg_crontab    <span style=color:#8f5902;font-style:italic># 仅移除定时任务</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -l &lt;cls&gt;                  <span style=color:#8f5902;font-style:italic># 移除整个集群（包含定时任务）</span>
</span></span></code></pre></div><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/backup/><strong>备份管理</strong></a>：PostgreSQL 备份与恢复</li><li><a href=/docs/pgsql/monitor/><strong>监控系统</strong></a>：PostgreSQL 监控与告警</li><li><a href=/docs/pgsql/admin/cluster/><strong>集群管理</strong></a>：集群的创建、扩缩容、销毁</li><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni 管理</strong></a>：高可用集群管理</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-fda28727166c3a3a755b7258c9071594>8 - 升级 PostgreSQL 大小版本</h1><div class=lead>版本升级：小版本滚动升级、大版本迁移、扩展升级</div><h2 id=快速上手>快速上手</h2><p>PostgreSQL 版本升级分为两种类型：<strong>小版本升级</strong> 和 <strong>大版本升级</strong>，两者的风险和复杂度差异很大。</p><table class=full-width><thead><tr><th style=text-align:left>类型</th><th style=text-align:left>示例</th><th style=text-align:left>停机时间</th><th style=text-align:left>数据兼容性</th><th style=text-align:left>风险等级</th></tr></thead><tbody><tr><td style=text-align:left>小版本升级</td><td style=text-align:left>17.2 → 17.3</td><td style=text-align:left>秒级（滚动重启）</td><td style=text-align:left>完全兼容</td><td style=text-align:left>低</td></tr><tr><td style=text-align:left>大版本升级</td><td style=text-align:left>17 → 18</td><td style=text-align:left>分钟级</td><td style=text-align:left>需要升级数据目录</td><td style=text-align:left>中</td></tr></tbody></table><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=小版本 aria-controls=tabs-00-00 aria-selected=true>
小版本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=大版本 aria-controls=tabs-00-01 aria-selected=false>
大版本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=扩展 aria-controls=tabs-00-02 aria-selected=false>
扩展</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 滚动升级：先从库后主库</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span><span style=display:flex><span>pg restart --role replica --force &lt;cls&gt;
</span></span><span style=display:flex><span>pg switchover &lt;cls&gt;
</span></span><span style=display:flex><span>pg restart &lt;cls&gt; &lt;old-primary&gt; --force
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 推荐：逻辑复制迁移</span>
</span></span><span style=display:flex><span>bin/pgsql-add pg-new              <span style=color:#8f5902;font-style:italic># 创建新版本集群</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 配置逻辑复制同步数据...</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 切换流量到新集群</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgis36_17*&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER EXTENSION postgis UPDATE;&#39;</span>
</span></span></code></pre></div></div></div><p>关于在线迁移的详细流程，请参考 <a href=/docs/pgsql/migration><strong>在线迁移</strong></a> 文档。</p><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>说明</th><th style=text-align:left>风险</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E5%B0%8F%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7><strong>小版本升级</strong></a></td><td style=text-align:left>更新软件包，滚动重启</td><td style=text-align:left>低</td></tr><tr><td style=text-align:left><a href=#%E5%B0%8F%E7%89%88%E6%9C%AC%E9%99%8D%E7%BA%A7><strong>小版本降级</strong></a></td><td style=text-align:left>回退到之前的小版本</td><td style=text-align:left>低</td></tr><tr><td style=text-align:left><a href=#%E5%A4%A7%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7><strong>大版本升级</strong></a></td><td style=text-align:left>逻辑复制或 pg_upgrade</td><td style=text-align:left>中</td></tr><tr><td style=text-align:left><a href=#%E6%89%A9%E5%B1%95%E5%8D%87%E7%BA%A7><strong>扩展升级</strong></a></td><td style=text-align:left>升级扩展软件包和扩展对象</td><td style=text-align:left>低</td></tr></tbody></table><hr><h2 id=小版本升级>小版本升级</h2><p>小版本升级（如 17.2 → 17.3）是最常见的升级场景，通常用于应用安全补丁和 Bug 修复。数据目录完全兼容，通过滚动重启即可完成。</p><p><strong>升级策略</strong>：推荐采用 <strong>滚动升级</strong> 方式：先升级从库，再通过主从切换升级原主库，最小化服务中断。</p><pre tabindex=0><code>1. 更新软件仓库 → 2. 升级从库软件包 → 3. 重启从库
4. 主从切换 → 5. 升级原主库软件包 → 6. 重启原主库
</code></pre><p><strong>步骤一：准备软件包</strong></p><p>确保本地软件仓库中有最新版本的 PostgreSQL 包，并刷新节点缓存：</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab data-td-tp-persist=仓库 aria-controls=tabs-01-00 aria-selected=true>
仓库</button></li><li class=nav-item><button class=nav-link id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab data-td-tp-persist=el aria-controls=tabs-01-01 aria-selected=false>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab data-td-tp-persist=debian aria-controls=tabs-01-02 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-body tab-pane fade show active" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty
</span></span><span style=display:flex><span>./infra.yml -t repo_upstream      <span style=color:#8f5902;font-style:italic># 添加上游仓库（需要互联网）</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build         <span style=color:#8f5902;font-style:italic># 重建本地仓库</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum clean all&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum makecache&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt clean&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt update&#39;</span>
</span></span></code></pre></div></div></div><p><strong>步骤二：升级从库</strong></p><p>在所有从库上升级软件包并验证版本：</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=el aria-controls=tabs-02-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=debian aria-controls=tabs-02-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;/usr/pgsql/bin/pg_ctl --version&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;/usr/lib/postgresql/17/bin/pg_ctl --version&#39;</span>
</span></span></code></pre></div></div></div><p>重启所有从库以应用新版本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart --role replica --force &lt;cls&gt;
</span></span></code></pre></div><p><strong>步骤三：切换主库</strong></p><p>执行主从切换，将主库角色转移到已升级的从库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg switchover &lt;cls&gt;
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 或非交互式：</span>
</span></span><span style=display:flex><span>pg switchover --leader &lt;old-primary&gt; --candidate &lt;new-primary&gt; --scheduled<span style=color:#ce5c00;font-weight:700>=</span>now --force &lt;cls&gt;
</span></span></code></pre></div><p><strong>步骤四：升级原主库</strong></p><p>原主库现在已降级为从库，升级软件包并重启：</p><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab data-td-tp-persist=el aria-controls=tabs-03-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab data-td-tp-persist=debian aria-controls=tabs-03-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-body tab-pane fade show active" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;old-primary-ip&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgresql17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;old-primary-ip&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17&#39;</span>
</span></span></code></pre></div></div></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart &lt;cls&gt; &lt;old-primary-name&gt; --force
</span></span></code></pre></div><p><strong>步骤五：验证</strong></p><p>确认所有实例版本一致：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list &lt;cls&gt;
</span></span><span style=display:flex><span>pg query &lt;cls&gt; -c <span style=color:#4e9a06>&#34;SELECT version()&#34;</span>
</span></span></code></pre></div><hr><h2 id=小版本降级>小版本降级</h2><p>在极少数情况下（如新版本引入 Bug），可能需要将 PostgreSQL 降级到之前的版本。</p><p><strong>步骤一：获取旧版本包</strong></p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=el aria-controls=tabs-04-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=刷新缓存 aria-controls=tabs-04-01 aria-selected=false>
刷新缓存</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span> ./infra.yml -t repo_upstream     <span style=color:#8f5902;font-style:italic># 添加上游仓库</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> /www/pigsty<span style=color:#000;font-weight:700>;</span> repotrack postgresql17-*-17.1 <span style=color:#8f5902;font-style:italic># 下载指定版本的包</span>
</span></span><span style=display:flex><span><span style=color:#204a87>cd</span> ~/pigsty<span style=color:#000;font-weight:700>;</span> ./infra.yml -t repo_create       <span style=color:#8f5902;font-style:italic># 重建仓库元数据</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum clean all&#39;</span>
</span></span><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum makecache&#39;</span>
</span></span></code></pre></div></div></div><p><strong>步骤二：执行降级</strong></p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=el aria-controls=tabs-05-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=debian aria-controls=tabs-05-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum downgrade -y postgresql17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17=17.1*&#39;</span>
</span></span></code></pre></div></div></div><p><strong>步骤三：重启集群</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg restart --force &lt;cls&gt;
</span></span></code></pre></div><hr><h2 id=大版本升级>大版本升级</h2><p>大版本升级（如 17 → 18）涉及数据格式变更，需要使用专用工具进行数据迁移。</p><table class=full-width><thead><tr><th style=text-align:left>方式</th><th style=text-align:left>停机时间</th><th style=text-align:left>复杂度</th><th style=text-align:left>适用场景</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E9%80%BB%E8%BE%91%E5%A4%8D%E5%88%B6%E8%BF%81%E7%A7%BB><strong>逻辑复制迁移</strong></a></td><td style=text-align:left>秒级切换</td><td style=text-align:left>高</td><td style=text-align:left>生产环境，要求最小停机</td></tr><tr><td style=text-align:left><a href=#pg_upgrade-%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7><strong>pg_upgrade 原地升级</strong></a></td><td style=text-align:left>分钟~小时</td><td style=text-align:left>中</td><td style=text-align:left>测试环境，数据量较小</td></tr></tbody></table><div class="alert alert-success" role=alert><div class="h4 alert-heading" role=heading>推荐方案</div><p>对于生产环境，推荐使用 <strong>逻辑复制迁移</strong> 方式：创建新版本集群，通过逻辑复制同步数据，然后进行蓝绿切换。这种方式停机时间最短，且可以随时回滚。详见 <a href=/docs/pgsql/migration><strong>在线迁移</strong></a>。</p></div><h3 id=逻辑复制迁移>逻辑复制迁移</h3><p>逻辑复制迁移是生产环境大版本升级的推荐方式，核心步骤：</p><pre tabindex=0><code>1. 创建新版本目标集群 → 2. 配置逻辑复制同步数据 → 3. 验证数据一致性
4. 切换应用流量到新集群 → 5. 下线旧集群
</code></pre><p><strong>步骤一：创建新版本集群</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta-new</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta-new</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>18</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 新版本</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-add pg-meta-new
</span></span></code></pre></div><p><strong>步骤二：配置逻辑复制</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 源集群（旧版本）主库：创建发布
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>PUBLICATION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_pub</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ALL</span><span style=color:#f8f8f8> </span><span style=color:#000>TABLES</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 目标集群（新版本）主库：创建订阅
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>SUBSCRIPTION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_sub</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>CONNECTION</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;host=10.10.10.11 port=5432 dbname=mydb user=replicator password=xxx&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#000>PUBLICATION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_pub</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>步骤三：等待同步完成</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 目标集群：检查订阅状态
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_stat_subscription</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 源集群：检查复制槽 LSN
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>slot_name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>confirmed_flush_lsn</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_replication_slots</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>步骤四：切换流量</strong></p><p>确认数据同步完成后：停止应用写入源集群 → 等待最后的数据同步 → 切换应用连接到新集群 → 删除订阅，下线源集群。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 目标集群：删除订阅
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>SUBSCRIPTION</span><span style=color:#f8f8f8> </span><span style=color:#000>upgrade_sub</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>详细的迁移流程请参考 <a href=/docs/pgsql/migration><strong>在线迁移</strong></a> 文档。</p><h3 id=pg_upgrade-原地升级>pg_upgrade 原地升级</h3><p><code>pg_upgrade</code> 是 PostgreSQL 官方提供的大版本升级工具，适用于测试环境或可接受较长停机时间的场景。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>重要警告</div><p>原地升级会导致较长的停机时间，且回滚困难。生产环境请优先考虑逻辑复制迁移方式。</p></div><p><strong>步骤一：安装新版本软件包</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_pkg -e <span style=color:#000>pg_version</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>18</span>
</span></span></code></pre></div><p><strong>步骤二：停止 Patroni</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg pause &lt;cls&gt;                        <span style=color:#8f5902;font-style:italic># 暂停自动故障转移</span>
</span></span><span style=display:flex><span>systemctl stop patroni                <span style=color:#8f5902;font-style:italic># 停止 Patroni（会停止 PostgreSQL）</span>
</span></span></code></pre></div><p><strong>步骤三：运行 pg_upgrade</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres
</span></span><span style=display:flex><span>mkdir -p /data/postgres/pg-meta-18/data
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 预检（-c 参数只检查不执行）</span>
</span></span><span style=display:flex><span>/usr/pgsql-18/bin/pg_upgrade <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -b /usr/pgsql-17/bin -B /usr/pgsql-18/bin <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -d /data/postgres/pg-meta-17/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -D /data/postgres/pg-meta-18/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -v -c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 执行升级</span>
</span></span><span style=display:flex><span>/usr/pgsql-18/bin/pg_upgrade <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -b /usr/pgsql-17/bin -B /usr/pgsql-18/bin <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -d /data/postgres/pg-meta-17/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  -D /data/postgres/pg-meta-18/data <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span>  --link -j <span style=color:#0000cf;font-weight:700>8</span> -v
</span></span></code></pre></div><p><strong>步骤四：更新链接并启动</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>rm -rf /usr/pgsql <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ln -s /usr/pgsql-18 /usr/pgsql
</span></span><span style=display:flex><span>rm -rf /pg <span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> ln -s /data/postgres/pg-meta-18 /pg
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 编辑 /etc/patroni/patroni.yml 更新路径</span>
</span></span><span style=display:flex><span>systemctl start patroni
</span></span><span style=display:flex><span>pg resume &lt;cls&gt;
</span></span></code></pre></div><p><strong>步骤五：后处理</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>/usr/pgsql-18/bin/vacuumdb --all --analyze-in-stages
</span></span><span style=display:flex><span>./delete_old_cluster.sh   <span style=color:#8f5902;font-style:italic># pg_upgrade 生成的清理脚本</span>
</span></span></code></pre></div><hr><h2 id=扩展升级>扩展升级</h2><p>升级 PostgreSQL 版本时，通常也需要升级相关扩展插件。</p><p><strong>升级扩展软件包</strong></p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab data-td-tp-persist=el aria-controls=tabs-08-00 aria-selected=true>
EL</button></li><li class=nav-item><button class=nav-link id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab data-td-tp-persist=debian aria-controls=tabs-08-01 aria-selected=false>
Debian</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-body tab-pane fade show active" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;yum upgrade -y postgis36_17 timescaledb-2-postgresql-17* pgvector_17*&#39;</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ansible &lt;cls&gt; -b -a <span style=color:#4e9a06>&#39;apt install -y postgresql-17-postgis-3 postgresql-17-pgvector&#39;</span>
</span></span></code></pre></div></div></div><p><strong>升级扩展版本</strong></p><p>软件包升级后，在数据库中执行扩展升级：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看可升级的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 升级扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 检查扩展版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>扩展兼容性</div><p>大版本升级前，请确认所有使用的扩展都支持目标 PostgreSQL 版本。某些扩展可能需要先卸载再重新安装，请查阅扩展文档。</p></div><hr><h2 id=注意事项>注意事项</h2><ol><li><strong>备份优先</strong>：任何升级操作前都应进行完整备份</li><li><strong>测试验证</strong>：先在测试环境验证升级流程</li><li><strong>扩展兼容</strong>：确认所有扩展支持目标版本</li><li><strong>回滚预案</strong>：准备好回滚方案，特别是大版本升级</li><li><strong>监控观察</strong>：升级后密切监控数据库性能和错误日志</li><li><strong>文档记录</strong>：记录升级过程中的所有操作和问题</li></ol><hr><h2 id=相关文档>相关文档</h2><ul><li><a href=/docs/pgsql/migration/><strong>在线迁移</strong></a>：使用逻辑复制进行零停机迁移</li><li><a href=/docs/pgsql/admin/patroni/><strong>Patroni 管理</strong></a>：使用 patronictl 管理集群</li><li><a href=/docs/pgsql/admin/cluster/><strong>集群管理</strong></a>：集群的创建、扩缩容、销毁</li><li><a href=/docs/pgsql/backup/><strong>备份恢复</strong></a>：PostgreSQL 备份与恢复</li><li><a href=/docs/pgsql/admin/ext/><strong>扩展管理</strong></a>：扩展的安装与管理</li></ul></div><div class=td-content style=page-break-before:always><h1 id=pg-2b2e08d4aed2707846688f2a5517519d>9 - 管理 PostgreSQL 扩展插件</h1><div class=lead>扩展管理：下载、安装、配置、启用、更新、卸载扩展</div><h2 id=快速上手>快速上手</h2><p>Pigsty 提供 <a href=https://pgext.cloud/zh/list><strong>451 扩展</strong></a>，使用扩展涉及四个步骤：<strong>下载</strong>、<strong>安装</strong>、<strong>配置</strong>、<strong>启用</strong>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 安装扩展软件包</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># &lt;--- 配置预加载扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, vector ]           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 在数据库中启用</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-00-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-00-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-00-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-body tab-pane fade show active" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt;           <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上安装配置中定义的扩展</span>
</span></span><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ext...<span style=color:#ce5c00;font-weight:700>]</span>  <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上安装命令行参数给出的扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_ext    <span style=color:#8f5902;font-style:italic># 使用剧本安装扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta                         <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上安装定义的扩展</span>
</span></span><span style=display:flex><span>bin/pgsql-ext pg-meta pg_duckdb pg_mooncake   <span style=color:#8f5902;font-style:italic># 安装指定扩展</span>
</span></span></code></pre></div></div></div><p>关于扩展的完整参考，请查阅 <a href=/docs/pgsql/ext/><strong>扩展插件</strong></a> 章节。关于可用扩展列表，请参考 <a href=https://pgext.cloud/zh/list><strong>扩展目录</strong></a>。</p><table class=full-width><thead><tr><th style=text-align:left>操作</th><th style=text-align:left>快捷命令</th><th style=text-align:left>说明</th></tr></thead><tbody><tr><td style=text-align:left><a href=#%E4%B8%8B%E8%BD%BD%E6%89%A9%E5%B1%95><strong>下载扩展</strong></a></td><td style=text-align:left><code>./infra.yml -t repo_build</code></td><td style=text-align:left>将扩展下载到本地仓库</td></tr><tr><td style=text-align:left><a href=#%E5%AE%89%E8%A3%85%E6%89%A9%E5%B1%95><strong>安装扩展</strong></a></td><td style=text-align:left><code>bin/pgsql-ext &lt;cls></code></td><td style=text-align:left>在集群节点上安装扩展软件包</td></tr><tr><td style=text-align:left><a href=#%E9%85%8D%E7%BD%AE%E6%89%A9%E5%B1%95><strong>配置扩展</strong></a></td><td style=text-align:left><code>pg edit-config &lt;cls> -p</code></td><td style=text-align:left>将扩展添加到预加载库（需重启）</td></tr><tr><td style=text-align:left><a href=#%E5%90%AF%E7%94%A8%E6%89%A9%E5%B1%95><strong>启用扩展</strong></a></td><td style=text-align:left><code>psql -c 'CREATE EXT ...'</code></td><td style=text-align:left>在数据库中创建扩展对象</td></tr><tr><td style=text-align:left><a href=#%E6%9B%B4%E6%96%B0%E6%89%A9%E5%B1%95><strong>更新扩展</strong></a></td><td style=text-align:left><code>ALTER EXTENSION UPDATE</code></td><td style=text-align:left>更新扩展软件包与扩展对象</td></tr><tr><td style=text-align:left><a href=#%E7%A7%BB%E9%99%A4%E6%89%A9%E5%B1%95><strong>移除扩展</strong></a></td><td style=text-align:left><code>DROP EXTENSION</code></td><td style=text-align:left>删除扩展对象，卸载软件包</td></tr></tbody></table><div id=asciinema-ec8f712cd845ce138b45a5d9d91243a9 class="asciinema-container td-max-width-on-larger-screens" style="margin:1em 0"></div><script>(function(){var n,s="asciinema-ec8f712cd845ce138b45a5d9d91243a9",o="/demo/pgsql-ext.cast",e="auto",i=null;function a(){var e=document.documentElement.getAttribute("data-bs-theme");return e==="dark"?"solarized-dark":e==="light"?"solarized-light":window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"solarized-dark":"solarized-light"}function r(){return e==="auto"?a():e}function t(){var e,t=document.getElementById(s);t.innerHTML="",e={theme:r(),speed:"1.2",startAt:0,fit:"width"},e.autoPlay=!0,e.loop=!0,i=AsciinemaPlayer.create(o,t,e)}t(),e==="auto"&&(n=new MutationObserver(function(e){e.forEach(function(e){e.attributeName==="data-bs-theme"&&t()})}),n.observe(document.documentElement,{attributes:!0}),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(){var e=document.documentElement.getAttribute("data-bs-theme");(!e||e==="auto")&&t()}))})()</script><hr><h2 id=安装扩展>安装扩展</h2><p>定义在 <a href=/docs/pgsql/param#pg_extensions><strong><code>pg_extensions</code></strong></a> 里面的扩展会在 PostgreSQL <a href=/docs/pgsql/admin/cluster#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4><strong>集群创建</strong></a> 的时候在 <code>pg_extension</code> 任务中自动安装。</p><p>要在现有的 PostgreSQL 集群上安装扩展，请将扩展添加到 <code>all.children.&lt;cls>.pg_extensions</code>，然后执行：</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-02-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-02-01 aria-selected=false>
剧本</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab data-td-tp-persist=示例 aria-controls=tabs-02-02 aria-selected=false>
示例</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-body tab-pane fade show active" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext &lt;cls&gt;   <span style=color:#8f5902;font-style:italic># 在 &lt;cls&gt; 集群上安装扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -t pg_extension   <span style=color:#8f5902;font-style:italic># 直接使用 Ansible 剧本安装扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta    <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上安装配置中定义的扩展</span>
</span></span></code></pre></div></div></div><p><strong>示例配置：在集群上安装 PostGIS、TimescaleDB 和 PGVector</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#all.children.pg-meta.vars: # 省略上级缩进</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis, timescaledb, pgvector ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>执行效果</strong>：在集群所有节点上安装扩展软件包。Pigsty 会自动将 <a href=/docs/pgsql/config/alias><strong>包别名</strong></a> 翻译为对应操作系统和 PostgreSQL 版本的实际包名。</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>安装前，确保软件源可用</div><p>安装扩展前请确保节点已配置正确的软件源 —— 扩展已经在本地仓库中 <a href=#%E4%B8%8B%E8%BD%BD%E6%89%A9%E5%B1%95><strong>下载好</strong></a>，或者已经 <a href=#%E9%85%8D%E7%BD%AE%E4%BB%93%E5%BA%93><strong>配置扩展仓库</strong></a>。</p></div><hr><h2 id=手工安装>手工安装</h2><p>如果您不想使用 Pigsty 配置来管理 PostgreSQL 扩展，可以在命令行中直接传递要安装的扩展列表：</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-04-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-04-01 aria-selected=false>
剧本</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-body tab-pane fade show active" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-ext pg-meta pg_duckdb pg_mooncake   <span style=color:#8f5902;font-style:italic># 在 pg-meta 集群上安装指定扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-meta -t pg_ext -e <span style=color:#4e9a06>&#39;{&#34;pg_extensions&#34;: [&#34;pg_duckdb&#34;, &#34;pg_mooncake&#34;]}&#39;</span>
</span></span></code></pre></div></div></div><p>您也可以使用 <a href=/docs/pig><strong>pig</strong></a> 包管理器命令行工具在单个节点上安装扩展，同样会自动进行 <a href=/docs/pgsql/config/alias><strong>包别名</strong></a> 解析。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig install postgis timescaledb       <span style=color:#8f5902;font-style:italic># 安装多个扩展</span>
</span></span><span style=display:flex><span>pig install pgvector -v <span style=color:#0000cf;font-weight:700>17</span>            <span style=color:#8f5902;font-style:italic># 针对特定 PG 大版本安装</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ansible pg-test -b -a <span style=color:#4e9a06>&#39;pig install pg_duckdb&#39;</span>   <span style=color:#8f5902;font-style:italic># 使用 Ansible 在集群上批量安装</span>
</span></span></code></pre></div><p>您也可以 <strong>直接使用操作系统包管理器</strong> (<code>apt/dnf</code>) 进行安装，但您必须知道具体操作系统/PG下的 RPM/DEB 包名：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># EL 系统（RHEL、Rocky、Alma、Oracle Linux）</span>
</span></span><span style=display:flex><span>sudo yum install -y pgvector_17*
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Debian / Ubuntu 系统</span>
</span></span><span style=display:flex><span>sudo apt install -y postgresql-17-pgvector
</span></span></code></pre></div><hr><h2 id=下载扩展>下载扩展</h2><p>要想安装扩展，您需要确保节点上配置的 <a href=/docs/repo/pgsql><strong>扩展仓库</strong></a> 包含待安装的扩展：</p><ul><li><a href=/docs/setup/install><strong>单机安装</strong></a> 时无需操心，上游仓库已经直接添加到节点上。</li><li><a href=/docs/setup/offline><strong>离线安装</strong></a> 时无需操心，绝大部分扩展都已经包含在离线安装包里，个别扩展需要在线安装。</li><li>使用本地仓库的 <a href=/docs/deploy/install><strong>生产多节点部署</strong></a>，要看情况，如果在本地仓库创建的时候 <a href=/docs/infra/param/#repo_packages><code>repo_packages</code></a> / <a href=/docs/infra/param/#repo_extra_packages><code>repo_extra_packages</code></a> 中包含了扩展包，
则意味着已经下载到了本地，可以直接安装，否则需要先下载扩展包到本地仓库。或者直接为节点 <a href=#%E9%85%8D%E7%BD%AE%E4%BB%93%E5%BA%93><strong>配置上游仓库</strong></a> 在线安装。</li></ul><p>Pigsty 的默认配置在安装过程中会自动下载主流扩展到本地仓库。如需额外扩展，添加到 <a href=/docs/infra/param#repo_extra_packages><strong><code>repo_extra_packages</code></strong></a> 后重建仓库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>repo_extra_packages</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>pgvector, postgis, timescaledb ]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab data-td-tp-persist=脚本 aria-controls=tabs-05-00 aria-selected=true>
脚本</button></li><li class=nav-item><button class=nav-link id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab data-td-tp-persist=剧本 aria-controls=tabs-05-01 aria-selected=false>
剧本</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-body tab-pane fade show active" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make repo         <span style=color:#8f5902;font-style:italic># 快捷方式 = repo-build + node-repo</span>
</span></span><span style=display:flex><span>make repo-build   <span style=color:#8f5902;font-style:italic># 快捷方式，重建 Infra 上的软件仓库（下载软件包与依赖）</span>
</span></span><span style=display:flex><span>make node-repo    <span style=color:#8f5902;font-style:italic># 快捷方式，刷新节点上的软件源缓存，更新对 Infra 软件仓库的引用</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./deploy.yml -t repo_build,node_repo  <span style=color:#8f5902;font-style:italic># 一次性执行两个任务</span>
</span></span><span style=display:flex><span>./infra.yml -t repo_build     <span style=color:#8f5902;font-style:italic># 重新下载软件包到本地仓库</span>
</span></span><span style=display:flex><span>./node.yml  -t node_repo      <span style=color:#8f5902;font-style:italic># 刷新节点软件源缓存</span>
</span></span></code></pre></div></div></div><hr><h2 id=配置仓库>配置仓库</h2><p>您也可以选择直接让所有节点都使用上游仓库（生产环境不推荐），跳过下载步骤，直接从互联网 <a href=/docs/repo/pgsql><strong>上游扩展仓库</strong></a> 安装</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql   <span style=color:#8f5902;font-style:italic># 添加 PGDG 与 Pigsty 上游仓库</span>
</span></span></code></pre></div><hr><h2 id=配置扩展>配置扩展</h2><p>部分扩展需要预加载到 <a href=https://www.postgresql.org/docs/9.0/runtime-config-resource.html#GUC-SHARED-PRELOAD-LIBRARIES><strong><code>shared_preload_libraries</code></strong></a> 才能使用，修改后需要 <strong>重启数据库</strong> 生效。</p><p>您可以用 <a href=/docs/pgsql/param#pg_libs><strong><code>pg_libs</code></strong></a> 参数作为它的默认值，在配置预加载的扩展，但是这个参数只在集群初始化时生效，后面修改就无效了。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 预加载扩展</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb, postgis, pgvector ]         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 安装扩展包</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>对于已有集群，您可以参考 <a href=/docs/pgsql/admin/patroni#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE><strong>修改配置</strong></a> 的介绍，修改 <code>shared_preload_libraries</code>参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;timescaledb, pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>pg restart pg-meta   <span style=color:#8f5902;font-style:italic># 修改 pg-meta 集群的参数，并重启集群使配置生效</span>
</span></span></code></pre></div><p>请确保扩展软件包已正确安装后再添加预加载配置，如果 <code>shared_preload_libraries</code> 中的扩展不存在或加载失败，PostgreSQL 将 <strong>无法启动</strong>。
此外，请通过 Patroni 管理集群的配置变更，避免使用 <code>ALTER SYSTEM</code> 或者 <a href=/docs/pgsql/param#pg_parameters><strong><code>pg_parameters</code></strong></a> 单独修改实例配置。
如果主库和从库配置不一致，可能导致启动失败或复制中断。</p><hr><h2 id=启用扩展>启用扩展</h2><p>安装扩展软件包后，需要在数据库中执行 <code>CREATE EXTENSION</code> 才能使用扩展提供的功能。</p><p><strong>集群初始化时启用</strong></p><p>在 <a href=/docs/pgsql/config/db><strong>数据库定义</strong></a> 中通过 <code>extensions</code> 数组声明要启用的扩展：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- <span style=color:#000>vector                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 简单形式</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 指定 Schema</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>手动启用</strong></p><ul class="nav nav-tabs" id=tabs-6 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-06-00-tab data-bs-toggle=tab data-bs-target=#tabs-06-00 role=tab data-td-tp-persist=sql aria-controls=tabs-06-00 aria-selected=true>
SQL</button></li><li class=nav-item><button class=nav-link id=tabs-06-01-tab data-bs-toggle=tab data-bs-target=#tabs-06-01 role=tab data-td-tp-persist=psql aria-controls=tabs-06-01 aria-selected=false>
psql</button></li><li class=nav-item><button class=nav-link id=tabs-06-02-tab data-bs-toggle=tab data-bs-target=#tabs-06-02 role=tab data-td-tp-persist=剧本 aria-controls=tabs-06-02 aria-selected=false>
剧本</button></li></ul><div class=tab-content id=tabs-6-content><div class="tab-body tab-pane fade show active" id=tabs-06-00 role=tabpanel aria-labelled-by=tabs-06-00-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic>-- 创建扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SCHEMA</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic>-- 指定 Schema
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IF</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>EXISTS</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>-- 幂等创建
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>-- 自动安装依赖
</span></span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-01 role=tabpanel aria-labelled-by=tabs-06-01-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION vector;&#39;</span>                  <span style=color:#8f5902;font-style:italic># 在 meta 数据库创建扩展</span>
</span></span><span style=display:flex><span>psql -d meta -c <span style=color:#4e9a06>&#39;CREATE EXTENSION postgis SCHEMA public;&#39;</span>   <span style=color:#8f5902;font-style:italic># 指定 Schema</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-06-02 role=tabpanel aria-labelled-by=tabs-06-02-tab tabindex=6><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改数据库定义后使用剧本启用扩展</span>
</span></span><span style=display:flex><span>bin/pgsql-db pg-meta meta    <span style=color:#8f5902;font-style:italic># 创建/修改数据库会自动启用定义的扩展</span>
</span></span></code></pre></div></div></div><p><strong>执行效果</strong>：在数据库中创建扩展对象（函数、类型、操作符、索引方法等），之后即可使用扩展提供的功能。</p><hr><h2 id=更新扩展>更新扩展</h2><p>扩展更新涉及两个层面：<strong>软件包更新</strong> 和 <strong>扩展对象更新</strong>。</p><p><strong>更新软件包</strong></p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab data-td-tp-persist=pig aria-controls=tabs-07-00 aria-selected=true>
pig</button></li><li class=nav-item><button class=nav-link id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab data-td-tp-persist=yum aria-controls=tabs-07-01 aria-selected=false>
yum</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab data-td-tp-persist=apt aria-controls=tabs-07-02 aria-selected=false>
apt</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-body tab-pane fade show active" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig update pgvector                           <span style=color:#8f5902;font-style:italic># 使用 pig 更新扩展</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum update pgvector_18 <span style=color:#8f5902;font-style:italic># EL</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt upgrade postgresql-18-pgvector  <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><p><strong>更新扩展对象</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 查看可升级的扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>&lt;&gt;</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 更新扩展到最新版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 更新到指定版本
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>UPDATE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TO</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;0.8.1&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>更新注意事项</div><p>更新扩展前建议备份数据库。预加载扩展更新后可能需要重启 PostgreSQL。某些扩展版本升级可能不兼容，请查阅扩展文档。</p></div><hr><h2 id=移除扩展>移除扩展</h2><p>移除扩展涉及两个层面：<strong>删除扩展对象</strong> 和 <strong>卸载软件包</strong>。</p><p><strong>删除扩展对象</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic>-- 删除扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>DROP</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>vector</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic>-- 级联删除（删除依赖对象）
</span></span></span></code></pre></div><p><strong>移除预加载</strong></p><p>如果是预加载扩展，需从 <code>shared_preload_libraries</code> 中移除并重启：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg edit-config pg-meta --force -p <span style=color:#000>shared_preload_libraries</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;pg_stat_statements, auto_explain&#39;</span>
</span></span><span style=display:flex><span>pg restart pg-meta   <span style=color:#8f5902;font-style:italic># 重启使配置生效</span>
</span></span></code></pre></div><p><strong>卸载软件包（可选）</strong></p><ul class="nav nav-tabs" id=tabs-9 role=tablist><li class=nav-item><button class="nav-link active" id=tabs-09-00-tab data-bs-toggle=tab data-bs-target=#tabs-09-00 role=tab data-td-tp-persist=pig aria-controls=tabs-09-00 aria-selected=true>
pig</button></li><li class=nav-item><button class=nav-link id=tabs-09-01-tab data-bs-toggle=tab data-bs-target=#tabs-09-01 role=tab data-td-tp-persist=yum aria-controls=tabs-09-01 aria-selected=false>
yum</button></li><li class=nav-item><button class=nav-link id=tabs-09-02-tab data-bs-toggle=tab data-bs-target=#tabs-09-02 role=tab data-td-tp-persist=apt aria-controls=tabs-09-02 aria-selected=false>
apt</button></li></ul><div class=tab-content id=tabs-9-content><div class="tab-body tab-pane fade show active" id=tabs-09-00 role=tabpanel aria-labelled-by=tabs-09-00-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pig remove pgvector                           <span style=color:#8f5902;font-style:italic># 使用 pig 卸载</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-01 role=tabpanel aria-labelled-by=tabs-09-01-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo yum remove pgvector_17*                  <span style=color:#8f5902;font-style:italic># EL 系统</span>
</span></span></code></pre></div></div><div class="tab-body tab-pane fade" id=tabs-09-02 role=tabpanel aria-labelled-by=tabs-09-02-tab tabindex=9><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt remove postgresql-17-pgvector        <span style=color:#8f5902;font-style:italic># Debian/Ubuntu</span>
</span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>CASCADE 警告</div><p>使用 <code>CASCADE</code> 删除扩展会同时删除所有依赖该扩展的对象（表、索引、视图等）。请先检查依赖关系再执行删除。</p></div><hr><h2 id=查询扩展>查询扩展</h2><p>以下是一些常用的 SQL 查询，用于查看扩展信息：</p><p><strong>查看已启用的扩展</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>extversion</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>nspname</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>schema</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_namespace</span><span style=color:#f8f8f8> </span><span style=color:#000>n</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extnamespace</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>n</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看可用扩展</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>default_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>installed_version</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>IS</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NOT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>NULL</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- 仅显示已安装的
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ORDER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>BY</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>检查扩展是否可用</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extensions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看扩展依赖关系</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extname</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>refobjid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>depends_on</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>JOIN</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ON</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>objid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>oid</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>d</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>deptype</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;e&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AND</span><span style=color:#f8f8f8> </span><span style=color:#000>e</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;postgis_topology&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>查看扩展对象</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>classid</span><span style=color:#000;font-weight:700>::</span><span style=color:#000>regclass</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>objid</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>deptype</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_depend</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>refobjid</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>oid</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_extension</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>extname</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p><strong>psql 快捷命令</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#4e9a06>\d</span>x                    <span style=color:#8f5902;font-style:italic># 列出已启用的扩展</span>
</span></span><span style=display:flex><span><span style=color:#4e9a06>\d</span>x+ vector            <span style=color:#8f5902;font-style:italic># 显示扩展详情</span>
</span></span></code></pre></div><hr><h2 id=添加仓库>添加仓库</h2><p>如需直接从上游安装扩展，可手动添加软件仓库。</p><p><strong>使用 Pigsty 剧本添加</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql        <span style=color:#8f5902;font-style:italic># 添加 PGDG 与 Pigsty 仓库</span>
</span></span><span style=display:flex><span>./node.yml -t node_repo -e <span style=color:#000>node_repo_modules</span><span style=color:#ce5c00;font-weight:700>=</span>node,pgsql,local  <span style=color:#8f5902;font-style:italic># 包括本地仓库</span>
</span></span></code></pre></div><p><strong>YUM 仓库（EL 系统）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Pigsty 仓库</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 中国大陆镜像</span>
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/key <span style=color:#000;font-weight:700>|</span> sudo tee /etc/pki/rpm-gpg/RPM-GPG-KEY-pigsty &gt;/dev/null
</span></span><span style=display:flex><span>curl -fsSL https://repo.pigsty.cc/yum/repo <span style=color:#000;font-weight:700>|</span> sudo tee /etc/yum.repos.d/pigsty.repo &gt;/dev/null
</span></span></code></pre></div><p><strong>APT 仓库（Debian/Ubuntu）</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -fsSL https://repo.pigsty.io/key <span style=color:#000;font-weight:700>|</span> sudo gpg --dearmor -o /etc/apt/keyrings/pigsty.gpg
</span></span><span style=display:flex><span>sudo tee /etc/apt/sources.list.d/pigsty.list &gt; /dev/null <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/infra generic main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>deb [signed-by=/etc/apt/keyrings/pigsty.gpg] https://repo.pigsty.io/apt/pgsql $(lsb_release -cs) main
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>sudo apt update
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 中国大陆镜像：将 repo.pigsty.io 替换为 repo.pigsty.cc</span>
</span></span></code></pre></div><hr><h2 id=常见问题>常见问题</h2><p><strong>扩展名与包名的区别</strong></p><table class=full-width><thead><tr><th style=text-align:left>名称</th><th style=text-align:left>说明</th><th style=text-align:left>示例</th></tr></thead><tbody><tr><td style=text-align:left>扩展名</td><td style=text-align:left><code>CREATE EXTENSION</code> 使用的名称</td><td style=text-align:left><code>vector</code></td></tr><tr><td style=text-align:left>包别名</td><td style=text-align:left>Pigsty 配置中使用的标准化名称</td><td style=text-align:left><code>pgvector</code></td></tr><tr><td style=text-align:left>包名</td><td style=text-align:left>操作系统实际的包名</td><td style=text-align:left><code>pgvector_17*</code> 或 <code>postgresql-17-pgvector</code></td></tr></tbody></table><p><strong>预加载扩展无法启动</strong></p><p>如果 <code>shared_preload_libraries</code> 中的扩展不存在或加载失败，PostgreSQL 将无法启动。解决方法：</p><ol><li>确保扩展软件包已正确安装</li><li>或从 <code>shared_preload_libraries</code> 中移除该扩展（编辑 <code>/pg/data/postgresql.conf</code>）</li></ol><p><strong>扩展依赖问题</strong></p><p>某些扩展依赖于其他扩展，需按顺序创建或使用 <code>CASCADE</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic>-- 先创建基础扩展
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic>-- 再创建依赖扩展
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 或
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>postgis_topology</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>CASCADE</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic>-- 自动创建依赖
</span></span></span></code></pre></div><p><strong>扩展版本不兼容</strong></p><p>查看当前 PostgreSQL 版本支持的扩展版本：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_available_extension_versions</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>WHERE</span><span style=color:#f8f8f8> </span><span style=color:#000>name</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;vector&#39;</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=相关资源>相关资源</h2><ul><li><a href=/docs/pgsql/ext/><strong>扩展插件</strong></a>：扩展管理的详细文档</li><li><a href=https://pgext.cloud/zh/list><strong>扩展目录</strong></a>：查阅 451 可用扩展</li><li><a href=https://pgext.cloud/pig><strong>pig 包管理器</strong></a>：扩展安装命令行工具</li><li><a href=/docs/pgsql/admin/db/><strong>数据库管理</strong></a>：在数据库中启用扩展</li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>