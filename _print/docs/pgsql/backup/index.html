<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/pgsql/backup/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/pgsql/backup/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>备份恢复 | PIGSTY</title><meta name=description content="时间点恢复（PITR）备份与恢复"><meta property="og:url" content="https://pigsty.cc/docs/pgsql/backup/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="备份恢复"><meta property="og:description" content="时间点恢复（PITR）备份与恢复"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="备份恢复"><meta itemprop=description content="时间点恢复（PITR）备份与恢复"><meta itemprop=dateModified content="2026-02-08T16:14:56+08:00"><meta itemprop=wordCount content="61"><meta itemprop=keywords content="任务,参考"><meta name=twitter:card content="summary"><meta name=twitter:title content="备份恢复"><meta name=twitter:description content="时间点恢复（PITR）备份与恢复"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/pgsql/backup/>返回本页常规视图</a>.</p></div><h1 class=title>备份恢复</h1><div class=lead>时间点恢复（PITR）备份与恢复</div><ul><li>1: <a href=#pg-4c34e733cec9746048fccac02c01fd36>备份策略</a></li><li>2: <a href=#pg-931bd9f9bf4846ff58a1265e886414d1>备份机制</a></li><li>3: <a href=#pg-e2aad9fad6e8fd1fba46059ad4ea7613>备份仓库</a></li><li>4: <a href=#pg-bd9fc4fbfbb9e33698d751afa14c6077>管理命令</a></li><li>5: <a href=#pg-ee98f0d297c9a6847c501efbbbed8fa6>恢复操作</a></li><li>6: <a href=#pg-f811d9356784e47cdedcf860a7ba394a>克隆数据库集群</a></li></ul><div class=content><p>Pigsty 使用 <a href=https://pgbackrest.org/>pgBackRest</a> 管理 PostgreSQL 备份，这可能是生态系统中最强大的开源备份工具。
它支持增量/并行备份与恢复、加密、<a href=/docs/minio>MinIO</a>/S3 等众多特性。Pigsty 默认为每个 <a href=/docs/pgsql>PGSQL</a> 集群预配置了备份功能。</p><table class=full-width><thead><tr><th>章节</th><th>内容</th></tr></thead><tbody><tr><td><a href=/docs/pgsql/backup/mechanism>机制</a></td><td>备份脚本、定时任务、pgbackrest、仓库与管理</td></tr><tr><td><a href=/docs/pgsql/backup/policy>策略</a></td><td>备份策略、磁盘规划、恢复窗口权衡</td></tr><tr><td><a href=/docs/pgsql/backup/repository>仓库</a></td><td>配置备份仓库：本地、MinIO、S3</td></tr><tr><td><a href=/docs/pgsql/backup/admin>管理</a></td><td>常用备份管理命令</td></tr><tr><td><a href=/docs/pgsql/backup/restore>恢复</a></td><td>使用剧本恢复到特定时间点</td></tr><tr><td><a href=/docs/pgsql/backup/restore#%E5%88%86%E6%AD%A5%E6%89%A7%E8%A1%8C>示例</a></td><td>沙箱示例：手工执行恢复操作</td></tr></tbody></table><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>免责声明</div><blockquote><p>Pigsty 尽最大努力提供可靠的 PITR 解决方案，但我们不对 PITR 操作导致的数据丢失承担任何责任，使用需自担风险。如需专业支持，请考虑我们的 <a href=/docs/about/service>专业服务</a>。</p></blockquote></div><hr><h2 id=快速上手>快速上手</h2><ol><li><a href=/docs/pgsql/backup/mechanism>备份策略</a>：使用 Crontab 调度基础备份</li><li><a href=/docs/pgsql/backup/policy>WAL 归档</a>：持续记录写入活动</li><li><a href=/docs/pgsql/backup/restore>恢复与还原</a>：从备份和 WAL 归档中恢复</li></ol><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;time&#34;: &#34;2025-07-13 10:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div></div></div><div class=td-content style=page-break-before:always><h1 id=pg-4c34e733cec9746048fccac02c01fd36>1 - 备份策略</h1><div class=lead>根据您的需求设计备份策略</div><p>下图将“恢复窗口”与“存储空间占用”合并到同一时间轴（<code>0~108h</code>）中，便于一起观察。</p><p>在相同假设（数据库 <code>100GB</code>、日写入 <code>10GB</code>）下，下图展示“每 7 天全量 + 每日增量、全量保留 14 天”时，30 天内恢复窗口与存储占用变化。</p><ul><li><strong>何时</strong>：备份策略</li><li><strong>何处</strong>：备份仓库</li><li><strong>如何</strong>：备份方法</li></ul><hr><h2 id=何时备份>何时备份</h2><p>第一个问题是<strong>何时</strong>备份您的数据库——这是备份频率和恢复时间之间的权衡。
由于您需要从上一次备份开始重放 WAL 日志到恢复目标点，备份越频繁，需要重放的 WAL 日志就越少，恢复速度就越快。</p><h3 id=每日全量备份>每日全量备份</h3><p>对于生产数据库，建议从最简单的每日全量备份策略开始。
这也是 Pigsty 的默认备份策略，通过 <a href=/docs/pgsql/backup/mechanism#%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD>crontab</a> 实现。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 选择备份仓库方法：`local`、`minio` 或其他自定义仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 使用本地 POSIX 文件系统的默认 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按数量保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，保留2个，最多3个全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>假设您的数据库大小为 100GB，每天更新写入 10GB 数据，备份耗时1小时，那么在每日全量备份，使用本地仓库的策略下，恢复窗口与备份空间随时间的变化如下图所示：</p><p>恢复窗口会在 25-49 小时之间循环，备份消耗的存储空间约为全量基础备份的 <code>2</code> 倍加上 2 天的 WAL 日志。
在实践中，您可能需要准备至少 <code>3~5</code> 倍基础数据库大小的备份磁盘才能使用默认备份策略。</p><script src=/js/echarts.min.js></script><div id=echarts-557a63f9d722fa407e500e69783e10e8 class="echarts-container td-max-width-on-larger-screens" style=height:640px></div><script>(function(){var e,t,n,s,o,r,c,l,d,u,h,a=document.getElementById("echarts-557a63f9d722fa407e500e69783e10e8");if(!a)return;window._echartsFns=window._echartsFns||{},e=function(e){return Math.round(Number(e))},u=function(t){return e(t)===0?"0":e(t)+"h"},o=function(t){return e(t)+"h"},t=function(e){return Number(e)===0?"0":(Number(e)>=100?Number(e).toFixed(0):Number(e)>=10?Number(e).toFixed(1):Number(e).toFixed(2)).replace(/\.00$/,"").replace(/(\.\d)0$/,"$1")+"GB"},d=function(t){return e(t)===0?"0":""+e(t)},r=function(n){return!n||!n.length?"":function(s){return["时间: "+e(n[0].axisValue)+"h"].concat(s.win===null?[]:["恢复窗口: "+o(s.win)]).concat(["首要备份: "+t(s.p),"次要备份: "+t(s.s),"WAL归档: "+t(s.w)]).concat(s.t>0?["瞬时备份: "+t(s.t)]:[]).concat(["备份存储: "+t(s.p+s.s+s.w+s.t)]).join("<br/>")}(n.reduce(function(e,t){return t.seriesName==="恢复窗口"?{win:Number(t.data[1]),p:e.p,s:e.s,w:e.w,t:e.t}:t.seriesName==="首要备份"?{win:e.win,p:Number(t.value),s:e.s,w:e.w,t:e.t}:t.seriesName==="次要备份"?{win:e.win,p:e.p,s:Number(t.value),w:e.w,t:e.t}:t.seriesName==="WAL归档"?{win:e.win,p:e.p,s:e.s,w:Number(t.value),t:e.t}:t.seriesName==="瞬时备份"?{win:e.win,p:e.p,s:e.s,w:e.w,t:Number(t.value)}:e},{win:null,p:0,s:0,w:0,t:0}))},window._echartsFns.int1=e,window._echartsFns.fmtHour=u,window._echartsFns.fmtWin=o,window._echartsFns.fmtGb=t,window._echartsFns.fmtGbTick=d,window._echartsFns.tipMerged=r,c=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,n=echarts.init(a,c),l={axisPointer:{link:[{xAxisIndex:[0,1]}]},grid:[{containLabel:!1,height:218,left:82,right:"10%",top:42},{containLabel:!1,height:218,left:82,right:"10%",top:286}],legend:{bottom:10,data:["首要备份","次要备份","WAL归档","瞬时备份"],itemGap:18,show:!1},series:[{data:[[0,0],[1,0],[1,1],[2,2],[3,3],[4,4],[5,5],[6,6],[7,7],[8,8],[9,9],[10,10],[11,11],[12,12],[13,13],[14,14],[15,15],[16,16],[17,17],[18,18],[19,19],[20,20],[21,21],[22,22],[23,23],[24,24],[25,25],[26,26],[27,27],[28,28],[29,29],[30,30],[31,31],[32,32],[33,33],[34,34],[35,35],[36,36],[37,37],[38,38],[39,39],[40,40],[41,41],[42,42],[43,43],[44,44],[45,45],[46,46],[47,47],[48,48],[49,49],[49,25],[50,26],[51,27],[52,28],[53,29],[54,30],[55,31],[56,32],[57,33],[58,34],[59,35],[60,36],[61,37],[62,38],[63,39],[64,40],[65,41],[66,42],[67,43],[68,44],[69,45],[70,46],[71,47],[72,48],[73,49],[73,25],[74,26],[75,27],[76,28],[77,29],[78,30],[79,31],[80,32],[81,33],[82,34],[83,35],[84,36],[85,37],[86,38],[87,39],[88,40],[89,41],[90,42],[91,43],[92,44],[93,45],[94,46],[95,47],[96,48],[97,49],[97,25],[98,26],[99,27],[100,28],[101,29],[102,30],[103,31],[104,32],[105,33],[106,34],[107,35],[108,36]],itemStyle:{color:"#f2a000"},lineStyle:{color:"#f2a000",width:3},markLine:{data:[{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:0},{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:24},{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:48},{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:72},{lineStyle:{color:"#59a14f",opacity:.75,type:"solid",width:1.4},xAxis:96},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:1},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:25},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:49},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:73},{lineStyle:{color:"#336791",opacity:.8,type:"solid",width:1.4},xAxis:97},{label:{color:"#2563eb",distance:12,formatter:"稳态下限 25h",position:"end",show:!0},lineStyle:{color:"#2563eb",opacity:.75,type:"dashdot",width:1.4},yAxis:25},{label:{color:"#7c3aed",distance:12,formatter:"窗口峰值 49h",position:"end",show:!0},lineStyle:{color:"#7c3aed",opacity:.75,type:"dashdot",width:1.4},yAxis:49}],label:{show:!1},symbol:"none"},name:"恢复窗口",showSymbol:!1,smooth:!1,symbol:"none",type:"line",xAxisIndex:0,yAxisIndex:0},{barWidth:5,data:[0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],itemStyle:{color:"#59a14f"},name:"首要备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:5,data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],itemStyle:{color:"#4e79a7"},name:"次要备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:5,data:[0,0,.42,.83,1.25,1.67,2.08,2.5,2.92,3.33,3.75,4.17,4.58,5,5.42,5.83,6.25,6.67,7.08,7.5,7.92,8.33,8.75,9.17,9.58,10,10.42,10.83,11.25,11.67,12.08,12.5,12.92,13.33,13.75,14.17,14.58,15,15.42,15.83,16.25,16.67,17.08,17.5,17.92,18.33,18.75,19.17,19.58,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20],itemStyle:{color:"#edc949"},name:"WAL归档",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:5,data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,100,0,0,0,0,0,0,0,0,0,0,0,0],itemStyle:{color:"#9ca3af",opacity:.75},name:"瞬时备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1}],tooltip:{axisPointer:{label:{show:!1},snap:!0,type:"line"},formatter:"$fn:tipMerged",trigger:"axis"},xAxis:[{axisLabel:{formatter:"$fn:fmtHour",interval:11},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["none","arrow"],symbolSize:[10,14]},axisTick:{length:6,show:!0},boundaryGap:!1,data:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108],gridIndex:0,minorSplitLine:{lineStyle:{color:"#9ca3af",opacity:.14,type:"dotted",width:1},show:!0},minorTick:{length:3,show:!0,splitNumber:12},name:"时间 h",nameGap:10,nameLocation:"end",nameTextStyle:{align:"left",padding:[8,0,0,0],verticalAlign:"top"},position:"bottom",splitLine:{lineStyle:{color:"#9ca3af",opacity:.28,type:"dashed",width:1},show:!0},type:"category"},{axisLabel:{show:!1},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0},axisTick:{length:6,show:!0},boundaryGap:!0,data:[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108],gridIndex:1,position:"top",splitLine:{lineStyle:{color:"#9ca3af",opacity:.22,type:"dashed",width:1},show:!0},type:"category"}],yAxis:[{axisLabel:{formatter:"$fn:fmtWin"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["none","arrow"],symbolSize:[10,14]},axisTick:{length:6,show:!0},gridIndex:0,interval:5,max:52,min:0,minorSplitLine:{lineStyle:{color:"#9ca3af",opacity:.18,type:"dotted",width:1},show:!0},minorTick:{length:3,show:!0,splitNumber:5},name:"恢复窗口 h",nameGap:8,nameLocation:"end",nameRotate:0,nameTextStyle:{align:"left",padding:[0,0,8,4],verticalAlign:"bottom"},splitLine:{lineStyle:{color:"#9ca3af",opacity:.35,type:"dashed",width:1},show:!0},type:"value"},{axisLabel:{formatter:"$fn:fmtGbTick"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["arrow","none"],symbolSize:[10,14]},axisTick:{length:6,show:!0},gridIndex:1,interval:50,inverse:!0,max:350,min:0,name:"存储空间 GB",nameGap:8,nameLocation:"end",nameRotate:0,nameTextStyle:{align:"left",padding:[10,0,0,4],verticalAlign:"top"},splitLine:{lineStyle:{color:"#9ca3af",opacity:.32,type:"dashed",width:1},show:!0},type:"value"}]};function i(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,n,s=e.substring(4);return window._echartsFns[s]}if(Array.isArray(e))return e.map(i);if(e&&typeof e=="object"){t={};for(n in e)t[n]=i(e[n]);return t}return e}s=i(l),n.setOption(s),window.addEventListener("resize",function(){n.resize()}),h=new MutationObserver(function(e){e.forEach(function(e){if(e.attributeName==="data-bs-theme"){var t=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;n.dispose(),n=echarts.init(a,t),n.setOption(s)}})}),h.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><h3 id=全量--增量备份>全量 + 增量备份</h3><p>您可以通过调整这些参数来优化备份空间使用。</p><p>如果使用 MinIO / S3 作为集中式备份仓库，您可以使用超出本地磁盘限制的存储空间。
此时可以考虑使用全量 + 增量备份配合 2 周保留策略：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 周一凌晨1点全量备份，工作日增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1           /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 可选的 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 兼容 S3 协议</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认 us-east-1，对 minio 无实际意义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 使用路径风格 URI 而非主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA 证书路径，默认 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 启用块级增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成单个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包大小限制，对象存储建议 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包目标大小，对象存储建议 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按时间保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留最近 14 天的全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>配合内置的 <code>minio</code> 备份仓库使用时，可提供保证 1 周的 PITR 恢复窗口。</p><p>假设您的数据库大小为 100GB，每天写入 10GB 数据，则备份大小如下：</p><div id=echarts-6f3bb4973b1a377a2bad89e57d6ca334 class="echarts-container td-max-width-on-larger-screens" style=height:640px></div><script>(function(){var e,t,n,s,o,r,c,l,d,u,h,m,i=document.getElementById("echarts-6f3bb4973b1a377a2bad89e57d6ca334");if(!i)return;window._echartsFns=window._echartsFns||{},e=function(e){return Math.round(Number(e))},l=function(t){return e(t)<1||e(t)>30?"":""+e(t)},o=function(t){return e(t)+"h"},t=function(e){return Number(e)===0?"0":(Number(e)>=100?Number(e).toFixed(0):Number(e)>=10?Number(e).toFixed(1):Number(e).toFixed(2)).replace(/\.00$/,"").replace(/(\.\d)0$/,"$1")+"GB"},c=function(t){return e(t)===0?"0":""+e(t)},n=function(e){return Number(Array.isArray(e)?e[1]:e)},d=function(s){return!s||!s.length?"":function(n){return["第"+e(s[0].axisValue)+"天"].concat(n.win===null?[]:["恢复窗口: "+o(n.win)]).concat(["首要备份: "+t(n.p),"次要备份: "+t(n.s),"增量备份: "+t(n.i),"WAL归档: "+t(n.w)]).concat(n.t>0?["瞬时备份: "+t(n.t)]:[]).concat(["备份存储: "+t(n.p+n.s+n.i+n.w+n.t)]).join("<br/>")}(s.reduce(function(e,t){return t.seriesName==="恢复窗口"?{win:n(t.value),p:e.p,s:e.s,i:e.i,w:e.w,t:e.t}:t.seriesName==="首要备份"?{win:e.win,p:n(t.value),s:e.s,i:e.i,w:e.w,t:e.t}:t.seriesName==="次要备份"?{win:e.win,p:e.p,s:n(t.value),i:e.i,w:e.w,t:e.t}:t.seriesName==="增量备份"?{win:e.win,p:e.p,s:e.s,i:n(t.value),w:e.w,t:e.t}:t.seriesName==="WAL归档"?{win:e.win,p:e.p,s:e.s,i:e.i,w:n(t.value),t:e.t}:t.seriesName==="瞬时备份"?{win:e.win,p:e.p,s:e.s,i:e.i,w:e.w,t:n(t.value)}:e},{win:null,p:0,s:0,i:0,w:0,t:0}))},window._echartsFns.int30d=e,window._echartsFns.fmtDay30=l,window._echartsFns.fmtWin30=o,window._echartsFns.fmtGb30=t,window._echartsFns.fmtGbTick30=c,window._echartsFns.valY30=n,window._echartsFns.tipMerged30=d,u=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null,s=echarts.init(i,u),h={axisPointer:{link:[{xAxisIndex:[0,1]}]},grid:[{containLabel:!1,height:218,left:82,right:"10%",top:42},{containLabel:!1,height:218,left:82,right:"10%",top:302}],legend:{bottom:10,data:["首要备份","次要备份","增量备份","WAL归档","瞬时备份"],itemGap:18,show:!1},series:[{data:[[1,24],[2,48],[3,72],[4,96],[5,120],[6,144],[7,168],[8,192],[9,216],[10,240],[11,264],[12,288],[13,312],[14,336],[14,168],[15,192],[16,216],[17,240],[18,264],[19,288],[20,312],[21,336],[21,168],[22,192],[23,216],[24,240],[25,264],[26,288],[27,312],[28,336],[28,168],[29,192],[30,216]],itemStyle:{color:"#f28e2c"},lineStyle:{color:"#f28e2c",width:3},markLine:{data:[{lineStyle:{color:"#336791",opacity:.65,type:"solid",width:1.4},xAxis:7},{lineStyle:{color:"#336791",opacity:.65,type:"solid",width:1.4},xAxis:14},{lineStyle:{color:"#336791",opacity:.65,type:"solid",width:1.4},xAxis:21},{lineStyle:{color:"#336791",opacity:.65,type:"solid",width:1.4},xAxis:28},{label:{color:"#2563eb",distance:12,formatter:"窗口下限 7d",position:"end",show:!0},lineStyle:{color:"#2563eb",opacity:.72,type:"dashdot",width:1.4},yAxis:168},{label:{color:"#7c3aed",distance:12,formatter:"窗口上限 14d",position:"end",show:!0},lineStyle:{color:"#7c3aed",opacity:.72,type:"dashdot",width:1.4},yAxis:336}],label:{show:!1},symbol:"none"},name:"恢复窗口",showSymbol:!1,smooth:!1,symbol:"none",type:"line",xAxisIndex:0,yAxisIndex:0},{barWidth:16,data:[100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],itemStyle:{color:"#59a14f"},name:"首要备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:16,data:[0,0,0,0,0,0,0,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100],itemStyle:{color:"#4e79a7"},name:"次要备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:16,data:[0,10,20,30,40,50,60,70,80,90,100,110,120,130,70,80,90,100,110,120,130,70,80,90,100,110,120,130,70,80],itemStyle:{color:"#76b7b2"},name:"增量备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:16,data:[10,20,30,40,50,60,70,80,90,100,110,120,130,140,80,90,100,110,120,130,140,80,90,100,110,120,130,140,80,90],itemStyle:{color:"#edc949"},name:"WAL归档",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1},{barWidth:16,data:[0,0,0,0,0,0,0,0,0,0,0,0,0,110,0,0,0,0,0,0,110,0,0,0,0,0,0,110,0,0],itemStyle:{color:"#9ca3af",opacity:.75},name:"瞬时备份",stack:"used",type:"bar",xAxisIndex:1,yAxisIndex:1}],tooltip:{axisPointer:{label:{show:!1},snap:!0,type:"line"},formatter:"$fn:tipMerged30",trigger:"axis"},xAxis:[{axisLabel:{formatter:"$fn:fmtDay30"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["none","arrow"],symbolSize:[10,14]},axisTick:{length:6,show:!0},boundaryGap:!1,gridIndex:0,interval:1,max:31,min:0,minorSplitLine:{lineStyle:{color:"#9ca3af",opacity:.14,type:"dotted",width:1},show:!0},minorTick:{length:3,show:!0,splitNumber:4},name:"时间",nameGap:10,nameLocation:"end",nameTextStyle:{align:"left",padding:[8,0,0,0],verticalAlign:"top"},position:"bottom",splitLine:{lineStyle:{color:"#9ca3af",opacity:.28,type:"dashed",width:1},show:!0},type:"value"},{axisLabel:{show:!1},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0},axisTick:{alignWithLabel:!0,length:6,show:!0},boundaryGap:!0,data:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],gridIndex:1,position:"top",splitLine:{lineStyle:{color:"#9ca3af",opacity:.22,type:"dashed",width:1},show:!0},type:"category",z:10}],yAxis:[{axisLabel:{formatter:"$fn:fmtWin30"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["none","arrow"],symbolSize:[10,14]},axisTick:{length:6,show:!0},gridIndex:0,interval:48,max:360,min:0,minorSplitLine:{lineStyle:{color:"#9ca3af",opacity:.18,type:"dotted",width:1},show:!0},minorTick:{length:3,show:!0,splitNumber:4},name:"恢复窗口 h",nameGap:8,nameLocation:"end",nameRotate:0,nameTextStyle:{align:"left",padding:[0,0,8,4],verticalAlign:"bottom"},splitLine:{lineStyle:{color:"#9ca3af",opacity:.35,type:"dashed",width:1},show:!0},type:"value"},{axisLabel:{formatter:"$fn:fmtGbTick30"},axisLine:{lineStyle:{color:"#4b5563",width:1.6},show:!0,symbol:["arrow","none"],symbolSize:[10,14]},axisTick:{length:6,show:!0},gridIndex:1,interval:50,inverse:!0,max:600,min:0,name:"存储空间 GB",nameGap:8,nameLocation:"end",nameRotate:0,nameTextStyle:{align:"left",padding:[10,0,0,4],verticalAlign:"top"},splitLine:{lineStyle:{color:"#9ca3af",opacity:.32,type:"dashed",width:1},show:!0},type:"value",z:10}]};function a(e){if(typeof e=="string"&&e.startsWith("$fn:")){var t,n,s=e.substring(4);return window._echartsFns[s]}if(Array.isArray(e))return e.map(a);if(e&&typeof e=="object"){t={};for(n in e)t[n]=a(e[n]);return t}return e}r=a(h),s.setOption(r),window.addEventListener("resize",function(){s.resize()}),m=new MutationObserver(function(e){e.forEach(function(e){if(e.attributeName==="data-bs-theme"){var t=document.documentElement.getAttribute("data-bs-theme")==="dark"?"dark":null;s.dispose(),s=echarts.init(i,t),s.setOption(r)}})}),m.observe(document.documentElement,{attributes:!0,attributeFilter:["data-bs-theme"]})})()</script><hr><h2 id=备份位置>备份位置</h2><p>默认情况下，Pigsty 提供两个默认备份仓库定义：<code>local</code> 和 <code>minio</code> 备份仓库。</p><ul><li><code>local</code>：<strong>默认选项</strong>，使用本地 <code>/pg/backup</code> 目录（软链接指向 <a href=/docs/pgsql/param/#pg_fs_backup><code>pg_fs_backup</code></a>：<code>/data/backups</code>）</li><li><code>minio</code>：使用 SNSD 单节点 MinIO 集群（Pigsty 支持，但默认不启用）</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 选择备份仓库方法：`local`、`minio` 或其他自定义仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 使用本地 POSIX 文件系统的默认 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按数量保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，保留2个，最多3个全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 可选的 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 兼容 S3 协议</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认 us-east-1，对 minio 无实际意义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 使用路径风格 URI 而非主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA 证书路径，默认 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 启用块级增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成单个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包大小限制，对象存储建议 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包目标大小，对象存储建议 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按时间保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留最近 14 天的全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-931bd9f9bf4846ff58a1265e886414d1>2 - 备份机制</h1><div class=lead>备份脚本、定时任务、备份仓库与基础设施</div><p>备份可以通过内置 <a href=#%E8%84%9A%E6%9C%AC>脚本</a> 调用，使用节点 <a href=#%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD>crontab</a> 定时执行，
由 <a href=https://pgbackrest.org/>pgbackrest</a> 管理，存储在备份仓库中，
仓库可以是本地磁盘文件系统或 MinIO / S3，并支持不同的 <a href=/docs/pgsql/backup/repository#%E4%BB%93%E5%BA%93%E4%BF%9D%E7%95%99%E7%AD%96%E7%95%A5>保留</a> 策略。</p><hr><h2 id=脚本>脚本</h2><p>您可以使用 <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a> 用户（默认为 <code>postgres</code>）执行 <code>pgbackrest</code> 命令创建备份：</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
备份命令</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
backup</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
full</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
diff</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
incr</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
info</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>full backup   <span style=color:#8f5902;font-style:italic># 为集群 pg-meta 创建全量备份</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>full backup
</span></span><span style=display:flex><span>2025-07-15 01:36:57.007 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: --annotation<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>pg_cluster</span><span style=color:#ce5c00;font-weight:700>=</span>pg-meta ...
</span></span><span style=display:flex><span>2025-07-15 01:36:57.030 P00   INFO: execute non-exclusive backup start: backup begins after the requested immediate checkpoint completes
</span></span><span style=display:flex><span>2025-07-15 01:36:57.105 P00   INFO: backup start <span style=color:#000>archive</span> <span style=color:#ce5c00;font-weight:700>=</span> 000000010000000000000006, <span style=color:#000>lsn</span> <span style=color:#ce5c00;font-weight:700>=</span> 0/6000028
</span></span><span style=display:flex><span>2025-07-15 01:36:58.540 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F
</span></span><span style=display:flex><span>2025-07-15 01:36:58.588 P00   INFO: full backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 44.5MB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:36:58.589 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1584ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>diff backup
</span></span><span style=display:flex><span>2025-07-15 01:37:24.952 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-15 01:37:24.985 P00   INFO: last backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F, <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> 2.54.2
</span></span><span style=display:flex><span>2025-07-15 01:37:26.337 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013724D
</span></span><span style=display:flex><span>2025-07-15 01:37:26.381 P00   INFO: diff backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 424.3KB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:37:26.381 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1431ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span>incr backup
</span></span><span style=display:flex><span>2025-07-15 01:37:30.305 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-15 01:37:30.337 P00   INFO: last backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013724D, <span style=color:#000>version</span> <span style=color:#ce5c00;font-weight:700>=</span> 2.54.2
</span></span><span style=display:flex><span>2025-07-15 01:37:31.356 P00   INFO: new backup <span style=color:#000>label</span> <span style=color:#ce5c00;font-weight:700>=</span> 20250715-013657F_20250715-013730I
</span></span><span style=display:flex><span>2025-07-15 01:37:31.403 P00   INFO: incr backup <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 8.3KB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1437</span>
</span></span><span style=display:flex><span>2025-07-15 01:37:31.403 P00   INFO: backup <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1099ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta info
</span></span><span style=display:flex><span>stanza: pg-meta
</span></span><span style=display:flex><span>    status: ok
</span></span><span style=display:flex><span>    cipher: aes-256-cbc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    db <span style=color:#ce5c00;font-weight:700>(</span>current<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>        wal archive min/max <span style=color:#ce5c00;font-weight:700>(</span>17<span style=color:#ce5c00;font-weight:700>)</span>: 000000010000000000000001/00000001000000000000000A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        full backup: 20250715-013657F
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:36:57+00 / 2025-07-15 01:36:58+00
</span></span><span style=display:flex><span>            wal start/stop: <span style=color:#0000cf;font-weight:700>000000010000000000000006</span> / <span style=color:#0000cf;font-weight:700>000000010000000000000006</span>
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 44.5MB
</span></span><span style=display:flex><span>            repo1: backup size: 8.7MB
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        diff backup: 20250715-013657F_20250715-013724D
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:37:24+00 / 2025-07-15 01:37:26+00
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 424.3KB
</span></span><span style=display:flex><span>            repo1: backup size: 94KB
</span></span><span style=display:flex><span>            backup reference total: <span style=color:#0000cf;font-weight:700>1</span> full
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        incr backup: 20250715-013657F_20250715-013730I
</span></span><span style=display:flex><span>            timestamp start/stop: 2025-07-15 01:37:30+00 / 2025-07-15 01:37:31+00
</span></span><span style=display:flex><span>            database size: 44.5MB, database backup size: 8.3KB
</span></span><span style=display:flex><span>            repo1: backup size: 504B
</span></span><span style=display:flex><span>            backup reference total: <span style=color:#0000cf;font-weight:700>1</span> full, <span style=color:#0000cf;font-weight:700>1</span> diff</span></span></code></pre></div></div></div><p>这里的 <code>stanza</code> 是数据库集群名称：<a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a>，在默认配置中为 <code>pg-meta</code>。</p><p>Pigsty 提供了 <code>pb</code> 别名和 <code>pg-backup</code> 包装脚本，会自动填充当前集群名称作为 stanza：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pb<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>stanza</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>grep -o <span style=color:#4e9a06>&#39;\[[^][]*]&#39;</span> /etc/pgbackrest/pgbackrest.conf <span style=color:#000;font-weight:700>|</span> head -n1 <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/.*\[\([^]]*\)].*/\1/&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$stanza</span> <span style=color:#000>$@</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>pb ...    <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta ...</span>
</span></span><span style=display:flex><span>pb info   <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta info</span>
</span></span><span style=display:flex><span>pb backup <span style=color:#8f5902;font-style:italic># pgbackrest --stanza=pg-meta backup</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># 执行全量备份         = pgbackrest --stanza=pg-meta --type=full backup</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># 执行增量备份         = pgbackrest --stanza=pg-meta --type=incr backup</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># 执行差异备份         = pgbackrest --stanza=pg-meta --type=diff backup</span>
</span></span></code></pre></div><hr><h2 id=定时备份>定时备份</h2><p>Pigsty 利用 Linux crontab 来调度备份任务。您可以用它定义备份策略。</p><p>例如，大多数单节点配置模板都有以下用于备份的 <a href=/docs/node/param#node_crontab><code>node_crontab</code></a>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;00 01 * * * postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您可以使用 crontab 和 <code>pg-backup</code> 脚本设计更复杂的备份策略，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>node_crontab</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 周一凌晨1点全量备份，工作日增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 1 postgres /pg/bin/pg-backup full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- <span style=color:#4e9a06>&#39;00 01 * * 2,3,4,5,6,7 postgres /pg/bin/pg-backup&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>要应用 crontab 变更，使用 <a href=/docs/node/playbook/#nodeyml><code>node.yml</code></a> 更新所有节点的 crontab：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_crontab -l pg-meta    <span style=color:#8f5902;font-style:italic># 将 crontab 变更应用到 pg-meta 组</span>
</span></span></code></pre></div><hr><h2 id=pgbackrest>pgbackrest</h2><p>以下是 Pigsty 对 pgbackrest 的配置细节：</p><ul><li>pgbackrest 备份工具默认已启用并配置（<a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a>）</li><li>在 <a href=/docs/pgsql/playbook/#pgsqlyml><code>pgsql.yml</code></a> 剧本的 <code>pg_install</code> 任务中安装，定义在 <a href=/docs/pgsql/param/#pg_packages><code>pg_packages</code></a></li><li>在 <a href=/docs/pgsql/playbook/#pgsqlyml><code>pgsql.yml</code></a> 剧本的 <code>pg_backup</code> 任务中配置，参见 <a href=/docs/pgsql/param/#pg_backup>参数：PG_BACKUP</a></li><li>在 <code>pgbackrest_init</code> 任务中初始化备份仓库，如果仓库已存在会失败（错误可忽略）</li><li>在 <code>pgbackrest_backup</code> 任务中创建初始备份，由 <a href=/docs/pgsql/param/#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a> 控制</li></ul><h3 id=文件层次结构>文件层次结构</h3><ul><li>bin：<code>/usr/bin/pgbackrest</code>，来自 PGDG 的 <code>pgbackrest</code> 包，在组别名 <code>pgsql-common</code> 中。</li><li>conf：<code>/etc/pgbackrest</code>，主配置文件是 <a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/pgbackrest.conf><code>/etc/pgbackrest/pgbackrest.conf</code></a>。</li><li>logs：<code>/pg/log/pgbackrest/*</code>，由 <a href=/docs/pgsql/param/#pgbackrest_log_dir><code>pgbackrest_log_dir</code></a> 控制</li><li>tmp：<code>/pg/spool</code> 用作 pgbackrest 的临时 spool 目录</li><li>data：<code>/pg/backup</code> 用于存储数据（当选择默认的 <code>local</code> 文件系统备份仓库时）</li></ul><p>此外，在 <a href=/docs/pgsql/backup/restore>PITR 恢复</a> 过程中，Pigsty 会创建临时的 <code>/pg/conf/pitr.conf</code> pgbackrest 配置文件，
并将 postgres 恢复日志写入 <code>/pg/tmp/recovery.log</code> 文件。</p><h3 id=监控>监控</h3><p>有一个 <code>pgbackrest_exporter</code> 服务运行在 <a href=/docs/pgsql/param/#pgbackrest_exporter_port><code>pgbackrest_exporter_port</code></a>（<code>9854</code>）端口上，用于导出 pgbackrest 指标。
您可以通过 <a href=/docs/pgsql/param/#pgbackrest_exporter_options><code>pgbackrest_exporter_options</code></a> 自定义它，
或将 <a href=/docs/pgsql/param/#pgbackrest_exporter_enabled><code>pgbackrest_exporter_enabled</code></a> 设置为 <code>false</code> 来禁用它。</p><h3 id=初始备份>初始备份</h3><p>当创建 postgres 集群时，Pigsty 会自动创建初始备份。
由于新集群几乎为空，这是一个很小的备份。
它会留下一个 <code>/etc/pgbackrest/initial.done</code> 标记文件，以避免重复创建初始备份。
如果不需要初始备份，请将 <a href=/docs/pgsql/param/#pgbackrest_init_backup><code>pgbackrest_init_backup</code></a> 设置为 <code>false</code>。</p><hr><h2 id=管理>管理</h2><h3 id=启用备份>启用备份</h3><p>如果数据库集群创建时 <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> 设置为 <code>true</code>，备份将自动启用。</p><p>如果创建时该值为 <code>false</code>，您可以使用以下命令启用 pgbackrest 组件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># 运行 pgbackrest 子任务</span>
</span></span></code></pre></div><h3 id=删除备份>删除备份</h3><p>当移除主实例（<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>）时，Pigsty 会删除 pgbackrest 备份 stanza。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># 保留备份</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># 仅删除备份</span>
</span></span></code></pre></div><p>使用 <code>pg_backup</code> 子任务仅删除备份，使用 <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> 参数（设为 <code>false</code>）保留备份。</p><p>如果您的备份仓库被<strong>锁定</strong>（例如 S3 / MinIO 有锁定选项），此操作将失败。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>备份删除</div><p>删除备份可能导致永久性数据丢失，这是一个危险操作，请务必谨慎。</p></div><h3 id=列出备份>列出备份</h3><p>此命令将列出 pgbackrest 仓库中的所有备份（所有集群共享）</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><h3 id=手动备份>手动备份</h3><p>Pigsty 提供了内置脚本 <code>/pg/bin/pg-backup</code>，封装了 <code>pgbackrest</code> 备份命令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># 执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># 执行差异备份</span>
</span></span></code></pre></div><h3 id=基础备份>基础备份</h3><p>Pigsty 提供了一个替代备份脚本 <code>/pg/bin/pg-basebackup</code>，它不依赖 <code>pgbackrest</code>，直接提供数据库集群的物理副本。
默认备份目录为 <code>/pg/backup</code>。</p><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     备份源 URL，可选，默认为 <span style=color:#4e9a06>&#34;postgres:///&#34;</span>，如需密码应在 url、ENV 或 .pgpass 中提供
</span></span><span style=display:flex><span>-d, --dst, --dir     备份文件存放位置，默认为 <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           覆盖默认备份文件名，<span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         删除 n 分钟前的 .lz4 文件，默认 1200（20小时）
</span></span><span style=display:flex><span>-t, --tag            备份文件标签，未设置时使用目标集群名或本地 IP 地址，也用于默认文件名
</span></span><span style=display:flex><span>-k, --key            指定 --encrypt 时的加密密钥，默认密钥为 <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         上传备份文件到云存储（需自行实现）
</span></span><span style=display:flex><span>-e, --encryption     使用 OpenSSL RC4 加密，未指定密钥时使用 tag 作为密钥
</span></span><span style=display:flex><span>-h, --help           打印此帮助信息</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>备份使用 <code>lz4</code> 压缩。您可以使用以下命令解压并提取 tarball：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># 将备份提取到此目录</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><h3 id=逻辑备份>逻辑备份</h3><p>您也可以使用 <code>pg_dump</code> 命令执行逻辑备份。</p><p>逻辑备份不能用于 PITR（时间点恢复），但对于在不同主版本之间迁移数据或实现灵活的数据导出逻辑非常有用。</p><h3 id=从仓库引导>从仓库引导</h3><p>假设您有一个现有集群 <code>pg-meta</code>，想要将其<strong>克隆</strong>为 <code>pg-meta2</code>：</p><p>您需要创建新的 <code>pg-meta2</code> 集群分支，然后在其上运行 <code>pitr</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e2aad9fad6e8fd1fba46059ad4ea7613>3 - 备份仓库</h1><div class=lead>PostgreSQL 备份存储仓库配置</div><p>您可以通过指定 <a href=/docs/pgsql/param/#pgbackrest_repo><code>pgbackrest_repo</code></a> 参数来配置备份<strong>存储位置</strong>。
您可以在此定义多个仓库，Pigsty 会根据 <a href=/docs/pgsql/param/#pgbackrest_method><code>pgbackrest_method</code></a> 的值选择使用哪个。</p><h2 id=默认仓库>默认仓库</h2><p>默认情况下，Pigsty 提供两个默认备份仓库定义：<code>local</code> 和 <code>minio</code> 备份仓库。</p><ul><li><code>local</code>：<strong>默认选项</strong>，使用本地 <code>/pg/backup</code> 目录（软链接指向 <a href=/docs/pgsql/param/#pg_fs_backup><code>pg_fs_backup</code></a>：<code>/data/backups</code>）</li><li><code>minio</code>：使用 SNSD 单节点 MinIO 集群（Pigsty 支持，但默认不启用）</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>local         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 选择备份仓库方法：`local`、`minio` 或其他自定义仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 使用本地 POSIX 文件系统的默认 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按数量保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，保留2个，最多3个全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 可选的 minio 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 兼容 S3 协议</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>sss.pigsty      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 端点域名，默认为 `sss.pigsty`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>us-east-1         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 区域，默认 us-east-1，对 minio 无实际意义</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 桶名，默认为 `pgsql`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgbackrest           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户访问密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>S3User.Backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># pgbackrest 的 minio 用户密钥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>path           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 使用路径风格 URI 而非主机风格</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio 备份路径，默认为 `/pgbackrest`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>9000</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># minio 端口，默认 9000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>storage_ca_file</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/etc/pki/ca.crt </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># minio CA 证书路径，默认 `/etc/pki/ca.crt`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>block</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 启用块级增量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成单个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包大小限制，对象存储建议 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包目标大小，对象存储建议 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按时间保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留最近 14 天的全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=仓库保留策略>仓库保留策略</h2><p>如果每天备份但不删除旧备份，备份仓库会不断增长并耗尽磁盘空间。
您需要定义保留策略，只保留有限数量的备份。</p><p>默认备份策略定义在 <a href=/docs/pgsql/param/#pgbackrest_repo><code>pgbackrest_repo</code></a> 参数中，可按需调整。</p><ul><li><code>local</code>：保留最近 <strong>2</strong> 个全量备份，备份期间最多允许 3 个</li><li><code>minio</code>：保留最近 <strong>14</strong> 天的所有全量备份</li></ul><hr><h2 id=空间规划>空间规划</h2><p>对象存储提供几乎无限的存储容量，因此无需担心磁盘空间。
您可以使用混合的全量 + 差异备份策略来优化空间使用。</p><p>对于本地磁盘备份仓库，Pigsty 建议使用保留最近 <strong>2</strong> 个全量备份的策略，
这意味着磁盘上保留两个最新的全量备份（运行新备份时可能存在第三个副本）。</p><p>这可保证至少 24 小时的恢复窗口。详情请参阅 <a href=/docs/pgsql/backup/policy/>备份策略</a>。</p><hr><h2 id=其他仓库选项>其他仓库选项</h2><p>您也可以使用其他服务作为备份仓库，详情请参阅 <a href=https://pgbackrest.org/user-guide.html>pgbackrest 文档</a>：</p><ul><li><a href=https://pgbackrest.org/user-guide.html#s3-support>S3 兼容对象存储</a></li><li><a href=https://pgbackrest.org/user-guide.html#azure-support>Azure 兼容对象存储</a></li><li><a href=https://pgbackrest.org/user-guide.html#gcs-support>GCS 兼容对象存储</a></li><li><a href=https://pgbackrest.org/user-guide.html#sftp-support>SFTP 支持</a></li></ul><hr><h2 id=仓库版本控制>仓库版本控制</h2><p>您甚至可以指定 <a href=https://pgbackrest.org/user-guide.html#sftp-support#repo-target-time>repo target time</a> 来获取对象存储的快照。</p><p>您可以通过在 <a href=/docs/minio/param#minio_buckets><code>minio_buckets</code></a> 中添加 <code>versioning</code> 标志来启用 MinIO 版本控制：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_buckets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgsql ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta  ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>data }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=仓库锁定>仓库锁定</h2><p>某些对象存储服务（S3、MinIO 等）支持<strong>锁定</strong>功能，可以防止备份被删除，即使是 DBA 本人也无法删除。</p><ul><li><a href=https://min.io/docs/minio/linux/administration/object-management/object-retention.html>MinIO 对象锁定</a></li><li><a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/object-lock.html>AWS S3：使用 Object Lock 锁定对象</a></li></ul><p>您可以通过在 <a href=/docs/minio/param#minio_buckets><code>minio_buckets</code></a> 中添加 <code>lock</code> 标志来启用 MinIO 锁定功能：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>minio_buckets</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: pgsql , lock</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,versioning</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>data }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=使用对象存储>使用对象存储</h2><p>对象存储服务提供几乎无限的存储容量，并为您的系统提供远程容灾能力。
如果您没有对象存储服务，Pigsty 内置了 <a href=/docs/minio>MinIO</a> 支持。</p><h3 id=minio>MinIO</h3><p>您可以通过取消注释以下设置来启用 MinIO 备份仓库。
请注意 pgbackrest 只支持 HTTPS / 域名，因此您必须使用域名和 HTTPS 端点运行 MinIO。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用 minio 作为默认备份仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># 定义一个单节点 minio SNSD 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>minio</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_seq: 1 }} ,vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>minio_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>minio }}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h3 id=s3>S3</h3><p>如果您只有<strong>一个</strong>节点，有意义的备份策略可以是使用云厂商的对象存储服务，如 AWS S3、阿里云 OSS 或 Google Cloud 等。
为此，您可以定义一个新仓库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_method</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用 &#39;pgbackrest_repo.s3&#39; 作为备份仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgbackrest_repo:                  # pgbackrest 仓库配置</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>https://pgbackrest.org/configuration.html#section-repository</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>s3</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                             </span><span style=color:#8f5902;font-style:italic># 阿里云 OSS（S3 兼容）对象存储服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>s3                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># oss 兼容 S3 协议</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_endpoint</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oss-cn-beijing-internal.aliyuncs.com</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_region</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>oss-cn-beijing</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_bucket</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_bucket_name&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_access_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_key_secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>&lt;your_secret_key&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>s3_uri_style</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>host</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pgbackrest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>y</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 将小文件打包成单个文件</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_limit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>20MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包大小限制，对象存储建议 20MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>bundle_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>128MiB          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 文件包目标大小，对象存储建议 128MiB</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>aes-256-cbc     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 为远程备份仓库启用 AES 加密</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cipher_pass</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgBackRest      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># AES 加密密码，默认为 &#39;pgBackRest&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>time    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按时间保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>14</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># 保留最近 14 天的全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>local</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 使用本地 POSIX 文件系统的默认 pgbackrest 仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/backup             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 本地备份目录，默认为 `/pg/backup`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full_type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>count   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 按数量保留全量备份</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>retention_full</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># 使用本地文件系统仓库时，保留2个，最多3个全量备份</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=管理备份>管理备份</h2><h3 id=启用备份>启用备份</h3><p>如果数据库集群创建时 <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> 设置为 <code>true</code>，备份将自动启用。</p><p>如果创建时该值为 <code>false</code>，您可以使用以下命令启用 pgbackrest 组件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># 运行 pgbackrest 子任务</span>
</span></span></code></pre></div><h3 id=删除备份>删除备份</h3><p>当移除主实例（<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>）时，Pigsty 会删除 pgbackrest 备份 stanza。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># 保留备份</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># 仅删除备份</span>
</span></span></code></pre></div><p>使用 <code>pg_backup</code> 子任务仅删除备份，使用 <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> 参数（设为 <code>false</code>）保留备份。</p><p>如果您的备份仓库被<strong>锁定</strong>（例如 S3 / MinIO 有锁定选项），此操作将失败。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>备份删除</div><p>删除备份可能导致永久性数据丢失，这是一个危险操作，请务必谨慎。</p></div><h3 id=列出备份>列出备份</h3><p>此命令将列出 pgbackrest 仓库中的所有备份（所有集群共享）</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><h3 id=手动备份>手动备份</h3><p>Pigsty 提供了内置脚本 <code>/pg/bin/pg-backup</code>，封装了 <code>pgbackrest</code> 备份命令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># 执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># 执行差异备份</span>
</span></span></code></pre></div><h3 id=基础备份>基础备份</h3><p>Pigsty 提供了一个替代备份脚本 <code>/pg/bin/pg-basebackup</code>，它不依赖 <code>pgbackrest</code>，直接提供数据库集群的物理副本。
默认备份目录为 <code>/pg/backup</code>。</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     备份源 URL，可选，默认为 <span style=color:#4e9a06>&#34;postgres:///&#34;</span>，如需密码应在 url、ENV 或 .pgpass 中提供
</span></span><span style=display:flex><span>-d, --dst, --dir     备份文件存放位置，默认为 <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           覆盖默认备份文件名，<span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         删除 n 分钟前的 .lz4 文件，默认 1200（20小时）
</span></span><span style=display:flex><span>-t, --tag            备份文件标签，未设置时使用目标集群名或本地 IP 地址，也用于默认文件名
</span></span><span style=display:flex><span>-k, --key            指定 --encrypt 时的加密密钥，默认密钥为 <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         上传备份文件到云存储（需自行实现）
</span></span><span style=display:flex><span>-e, --encryption     使用 OpenSSL RC4 加密，未指定密钥时使用 tag 作为密钥
</span></span><span style=display:flex><span>-h, --help           打印此帮助信息</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>备份使用 <code>lz4</code> 压缩。您可以使用以下命令解压并提取 tarball：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># 将备份提取到此目录</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><h3 id=逻辑备份>逻辑备份</h3><p>您也可以使用 <code>pg_dump</code> 命令执行逻辑备份。</p><p>逻辑备份不能用于 PITR（时间点恢复），但对于在不同主版本之间迁移数据或实现灵活的数据导出逻辑非常有用。</p><h3 id=从仓库引导>从仓库引导</h3><p>假设您有一个现有集群 <code>pg-meta</code>，想要将其<strong>克隆</strong>为 <code>pg-meta2</code>：</p><p>您需要创建新的 <code>pg-meta2</code> 集群分支，然后在其上运行 <code>pitr</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-bd9fc4fbfbb9e33698d751afa14c6077>4 - 管理命令</h1><div class=lead>管理备份仓库和备份</div><h2 id=启用备份>启用备份</h2><p>如果数据库集群创建时 <a href=/docs/pgsql/param/#pgbackrest_enabled><code>pgbackrest_enabled</code></a> 设置为 <code>true</code>，备份将自动启用。</p><p>如果创建时该值为 <code>false</code>，您可以使用以下命令启用 pgbackrest 组件：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_backup    <span style=color:#8f5902;font-style:italic># 运行 pgbackrest 子任务</span>
</span></span></code></pre></div><hr><h2 id=删除备份>删除备份</h2><p>当移除主实例（<a href=/docs/pgsql/param/#pg_role><code>pg_role</code></a> = <code>primary</code>）时，Pigsty 会删除 pgbackrest 备份 stanza。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml
</span></span><span style=display:flex><span>./pgsql-rm.yml -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span>   <span style=color:#8f5902;font-style:italic># 保留备份</span>
</span></span><span style=display:flex><span>./pgsql-rm.yml -t pg_backup            <span style=color:#8f5902;font-style:italic># 仅删除备份</span>
</span></span></code></pre></div><p>使用 <code>pg_backup</code> 子任务仅删除备份，使用 <a href=/docs/pgsql/param/#pg_rm_backup><code>pg_rm_backup</code></a> 参数（设为 <code>false</code>）保留备份。</p><p>如果您的备份仓库被<strong>锁定</strong>（例如 S3 / MinIO 有锁定选项），此操作将失败。</p><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>备份删除</div><p>删除备份可能导致永久性数据丢失，这是一个危险操作，请务必谨慎。</p></div><hr><h2 id=列出备份>列出备份</h2><p>此命令将列出 pgbackrest 仓库中的所有备份（所有集群共享）</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest info
</span></span></code></pre></div><hr><h2 id=手动备份>手动备份</h2><p>Pigsty 提供了内置脚本 <code>/pg/bin/pg-backup</code>，封装了 <code>pgbackrest</code> 备份命令。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-backup        <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup full   <span style=color:#8f5902;font-style:italic># 执行全量备份</span>
</span></span><span style=display:flex><span>pg-backup incr   <span style=color:#8f5902;font-style:italic># 执行增量备份</span>
</span></span><span style=display:flex><span>pg-backup diff   <span style=color:#8f5902;font-style:italic># 执行差异备份</span>
</span></span></code></pre></div><hr><h2 id=基础备份>基础备份</h2><p>Pigsty 提供了一个替代备份脚本 <code>/pg/bin/pg-basebackup</code>，它不依赖 <code>pgbackrest</code>，直接提供数据库集群的物理副本。
默认备份目录为 <code>/pg/backup</code>。</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pg-basebackup</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
help</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>NAME
</span></span><span style=display:flex><span>  pg-basebackup  -- make base backup from PostgreSQL instance
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>SYNOPSIS
</span></span><span style=display:flex><span>  pg-basebackup -sdfeukr
</span></span><span style=display:flex><span>  pg-basebackup --src postgres:/// --dst . --file backup.tar.lz4
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>DESCRIPTION
</span></span><span style=display:flex><span>-s, --src, --url     备份源 URL，可选，默认为 <span style=color:#4e9a06>&#34;postgres:///&#34;</span>，如需密码应在 url、ENV 或 .pgpass 中提供
</span></span><span style=display:flex><span>-d, --dst, --dir     备份文件存放位置，默认为 <span style=color:#4e9a06>&#34;/pg/backup&#34;</span>
</span></span><span style=display:flex><span>-f, --file           覆盖默认备份文件名，<span style=color:#4e9a06>&#34;backup_</span><span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>_</span><span style=color:#4e9a06>${</span><span style=color:#000>date</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>.tar.lz4&#34;</span>
</span></span><span style=display:flex><span>-r, --remove         删除 n 分钟前的 .lz4 文件，默认 1200（20小时）
</span></span><span style=display:flex><span>-t, --tag            备份文件标签，未设置时使用目标集群名或本地 IP 地址，也用于默认文件名
</span></span><span style=display:flex><span>-k, --key            指定 --encrypt 时的加密密钥，默认密钥为 <span style=color:#4e9a06>${</span><span style=color:#000>tag</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>-u, --upload         上传备份文件到云存储（需自行实现）
</span></span><span style=display:flex><span>-e, --encryption     使用 OpenSSL RC4 加密，未指定密钥时使用 tag 作为密钥
</span></span><span style=display:flex><span>-h, --help           打印此帮助信息</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pg-basebackup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> pg-basebackup begin, checking parameters
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> filename  <span style=color:#ce5c00;font-weight:700>(</span>-f<span style=color:#ce5c00;font-weight:700>)</span>    :   backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> src       <span style=color:#ce5c00;font-weight:700>(</span>-s<span style=color:#ce5c00;font-weight:700>)</span>    :   postgres:///
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>DEBUG<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>INIT<span style=color:#ce5c00;font-weight:700>]</span> dst       <span style=color:#ce5c00;font-weight:700>(</span>-d<span style=color:#ce5c00;font-weight:700>)</span>    :   /pg/backup
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>LOCK<span style=color:#ce5c00;font-weight:700>]</span> lock acquired success on /tmp/backup.lock, <span style=color:#000>pid</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>107417</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:05<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup begin, from postgres:/// to /pg/backup/backup_pg-meta_20250713.tar.lz4
</span></span><span style=display:flex><span>pg_basebackup: initiating base backup, waiting <span style=color:#204a87;font-weight:700>for</span> checkpoint to <span style=color:#204a87>complete</span>
</span></span><span style=display:flex><span>pg_basebackup: checkpoint completed
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log start point: 0/7000028 on timeline <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>pg_basebackup: write-ahead log end point: 0/7000FD8
</span></span><span style=display:flex><span>pg_basebackup: syncing data to disk ...
</span></span><span style=display:flex><span>pg_basebackup: base backup completed
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>BKUP<span style=color:#ce5c00;font-weight:700>]</span> backup complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>DONE<span style=color:#ce5c00;font-weight:700>]</span> backup procedure complete!
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2025-07-13 06:16:06<span style=color:#ce5c00;font-weight:700>][</span>INFO<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>================================================================</span></span></span></code></pre></div></div></div><p>备份使用 <code>lz4</code> 压缩。您可以使用以下命令解压并提取 tarball：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir -p /tmp/data   <span style=color:#8f5902;font-style:italic># 将备份提取到此目录</span>
</span></span><span style=display:flex><span>cat /pg/backup/backup_pg-meta_20250713.tar.lz4 <span style=color:#000;font-weight:700>|</span> unlz4 -d -c <span style=color:#000;font-weight:700>|</span> tar -xC /tmp/data
</span></span></code></pre></div><hr><h2 id=逻辑备份>逻辑备份</h2><p>您也可以使用 <code>pg_dump</code> 命令执行逻辑备份。</p><p>逻辑备份不能用于 PITR（时间点恢复），但对于在不同主版本之间迁移数据或实现灵活的数据导出逻辑非常有用。</p><hr><h2 id=从仓库引导>从仓库引导</h2><p>假设您有一个现有集群 <code>pg-meta</code>，想要将其<strong>克隆</strong>为 <code>pg-meta2</code>：</p><p>您需要创建新的 <code>pg-meta2</code> 集群分支，然后在其上运行 <code>pitr</code>。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ee98f0d297c9a6847c501efbbbed8fa6>5 - 恢复操作</h1><div class=lead>从备份恢复 PostgreSQL</div><p>您可以使用预配置的 pgbackrest 在 Pigsty 中执行时间点恢复（PITR）。</p><ul><li><a href=#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B><strong>剧本方式</strong></a>：使用 <code>pgsql-pitr.yml</code> 剧本自动执行 PITR</li><li><a href=/docs/pgsql/tutorial/pg-fork#pg-pitr><strong>手动方式</strong></a>：使用 <code>pg-pitr</code> 脚本手动执行 PITR</li></ul><hr><h2 id=快速上手>快速上手</h2><p>如果您想将 <code>pg-meta</code> 集群回滚到之前的时间点，添加 <code>pg_pitr</code> 参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-07-13 10:00:00+00&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 从最新备份恢复</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>然后运行 <code>pgsql-pitr.yml</code> 剧本，它将把 <code>pg-meta</code> 集群回滚到指定时间点。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta
</span></span></code></pre></div><hr><h2 id=恢复后处理>恢复后处理</h2><p>恢复后的集群会<strong>禁用</strong> <code>archive_mode</code>，以防止意外的 WAL 写入。
如果恢复后的数据库状态正常，您可以启用 <code>archive_mode</code> 并执行全量备份。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode; SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>pg-backup full    <span style=color:#8f5902;font-style:italic># 执行新的全量备份</span>
</span></span></code></pre></div><hr><h2 id=恢复目标>恢复目标</h2><p>您可以在 <code>pg_pitr</code> 中指定不同类型的恢复目标，但它们是互斥的：</p><ul><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TIME><code>time</code></a>：恢复到哪个时间点？</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-NAME><code>name</code></a>：恢复到命名的恢复点（由 <code>pg_create_restore_point</code> 创建）</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-XID><code>xid</code></a>：恢复到特定的事务 ID（TXID/XID）</li><li><a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-LSN><code>lsn</code></a>：恢复到特定的 LSN（日志序列号）点</li></ul><p>如果指定了上述任何参数，恢复 <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TYPE><code>类型</code></a> 会相应设置，
否则将设置为 <code>latest</code>（WAL 归档流的末尾）。
特殊的 <code>immediate</code> 类型可用于指示 pgbackrest 通过在第一个一致点停止来最小化恢复时间。</p><h3 id=目标类型>目标类型</h3><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
恢复目标类型</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
latest</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
time</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
lsn</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
xid</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
name</button></li><li class=nav-item><button class=nav-link id=tabs-00-06-tab data-bs-toggle=tab data-bs-target=#tabs-00-06 role=tab aria-controls=tabs-00-06 aria-selected=false>
immediate</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 恢复到最新状态（WAL 归档流末尾）</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-07-13 10:00:00+00&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;0/4001C80&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;250000&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-06 role=tabpanel aria-labelled-by=tabs-00-06-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;immediate&#34;</span><span style=color:#f8f8f8> </span>}</span></span></code></pre></div></div></div><h3 id=按时间恢复>按时间恢复</h3><p>最常用的目标是时间点；您可以指定要恢复到的时间点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;time&#34;: &#34;2025-12-27 15:50:00+00&#34; }}&#39;</span>
</span></span></code></pre></div><p>时间应该是有效的 PostgreSQL <a href=https://www.postgresql.org/docs/current/datatype-datetime.html#DATATYPE-DATETIME-INPUT-TIME-STAMPS><code>TIMESTAMP</code></a> 格式，建议使用 <code>YYYY-MM-DD HH:MM:SS+TZ</code>。</p><h3 id=按名称恢复>按名称恢复</h3><p>您可以使用 <a href=https://www.postgresql.org/docs/current/functions-admin.html#id-1.5.8.34.5.5.2.2.1.1.1.1><code>pg_create_restore_point</code></a> 创建命名恢复点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_create_restore_point</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;shit_incoming&#39;</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>然后在 PITR 中使用该命名恢复点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;name&#34;: &#34;shit_incoming&#34; }}&#39;</span>
</span></span></code></pre></div><h3 id=按-xid-恢复>按 XID 恢复</h3><p>如果您有一个事务意外删除了某些数据，最好的恢复方式是将数据库恢复到该事务之前的状态。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;xid&#34;: &#34;250000&#34;, exclusive: true }}&#39;</span>
</span></span></code></pre></div><p>您可以从监控仪表盘找到确切的事务 ID，或从 CSVLOG 中的 <code>TXID</code> 字段获取。</p><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>包含与排除</div><p>目标参数默认是"包含"的，这意味着恢复会包含目标点。
<code>exclusive</code> 标志会排除该确切目标，例如 xid 24999 将是最后一个被重放的事务。</p><p>这仅适用于 <code>time</code>、<code>xid</code>、<code>lsn</code> 恢复目标，详情请参阅 <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-INCLUSIVE><code>recovery_target_inclusive</code></a>。</p></div><h3 id=按-lsn-恢复>按 LSN 恢复</h3><p>PostgreSQL 使用 <a href=https://www.postgresql.org/docs/current/datatype-pg-lsn.html>LSN</a>（日志序列号）来标识 WAL 记录的位置。
您可以在很多地方找到它，比如 Pigsty 仪表盘的 PG LSN 面板。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;lsn&#34;: &#34;0/4001C80&#34;, timeline: &#34;1&#34; }}&#39;</span>
</span></span></code></pre></div><p>要恢复到 WAL 流中的确切位置，您还可以指定 <a href=https://www.postgresql.org/docs/current/runtime-config-wal.html#RECOVERY-TARGET-TIMELINE><code>timeline</code></a> 参数（默认为 <code>latest</code>）</p><hr><h2 id=恢复来源>恢复来源</h2><ul><li><code>cluster</code>：从哪个集群恢复？默认使用当前的 <code>pg_cluster</code>，您可以使用同一 pgbackrest 仓库中的任何其他集群</li><li><code>repo</code>：覆盖备份仓库，使用与 <code>pgbackrest_repo</code> 相同的格式</li><li><code>set</code>：默认使用 <code>latest</code> 备份集，但您可以通过标签指定特定的 pgbackrest 备份</li></ul><p>Pigsty 将从 pgbackrest 备份仓库恢复。如果您使用集中式备份仓库（如 MinIO/S3），
可以指定另一个 &ldquo;stanza&rdquo;（另一个集群的备份目录）作为恢复来源。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta2</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 从 pg-meta 集群备份恢复</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>上述配置将标记 PITR 过程使用 <code>pg-meta</code> stanza。
您也可以通过 CLI 参数传递 <code>pg_pitr</code> 参数：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34; }}&#39;</span>
</span></span></code></pre></div><p>从另一个集群 PITR 时也可以使用这些目标：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta2 -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-07-14 08:00:00+00&#34; }}&#39;</span>
</span></span></code></pre></div><hr><h2 id=分步执行>分步执行</h2><p>这种方式是半自动的，您将参与 PITR 过程以做出关键决策。</p><p>例如，此配置将把 <code>pg-meta</code> 集群本身恢复到指定时间点：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta2</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2025-07-13 10:00:00+00&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 从最新备份恢复</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>让我们逐步执行：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t down     <span style=color:#8f5902;font-style:italic># 暂停 patroni 高可用</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t pitr     <span style=color:#8f5902;font-style:italic># 运行 pitr 过程</span>
</span></span><span style=display:flex><span>./pgsql-pitr.yml -l pg-meta -t up       <span style=color:#8f5902;font-style:italic># 生成 pgbackrest 配置和恢复脚本</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic># down                 : # 停止高可用并关闭 patroni 和 postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - pause            : # 暂停 patroni 自动故障切换</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - stop             : # 停止 patroni 和 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_patroni   : # 停止 patroni 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - stop_postgres  : # 停止 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pitr                 : # 执行 PITR 过程</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - config           : # 生成 pgbackrest 配置和恢复脚本</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - restore          : # 运行 pgbackrest 恢复命令</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - recovery         : # 启动 postgres 并完成恢复</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - verify           : # 验证恢复后的集群控制数据</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># up:                  : # 启动 postgres / patroni 并恢复高可用</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - etcd             : # 启动前清理 etcd 元数据</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - start            : # 启动 patroni 和 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_postgres : # 启动 postgres 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#     - start_patroni  : # 启动 patroni 服务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   - resume           : # 恢复 patroni 自动故障切换</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=pitr-参数定义>PITR 参数定义</h2><p><code>pg_pitr</code> 参数还有更多可用选项：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_pitr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                           </span><span style=color:#8f5902;font-style:italic># 定义 PITR 任务</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_pg_cls_name&#34;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 源集群名称</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 恢复目标类型：time, xid, name, lsn, immediate, default</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>time</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;2025-01-01 10:00:00+00&#34;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 恢复目标：时间，与 xid, name, lsn 互斥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;some_restore_point&#34;</span><span style=color:#f8f8f8>     </span><span style=color:#8f5902;font-style:italic># 恢复目标：命名恢复点，与 time, xid, lsn 互斥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>xid</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;100000&#34;</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 恢复目标：事务 ID，与 time, name, lsn 互斥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>lsn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#4e9a06>&#34;0/3000000&#34;</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 恢复目标：日志序列号，与 time, name, xid 互斥</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>timeline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>latest              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 目标时间线，可以是整数，默认为 latest</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>exclusive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 是否排除目标点，默认为 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>action</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pause                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 恢复后操作：pause, promote, shutdown</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>archive</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 是否保留归档设置？默认为 false</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db_exclude</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>template0, template1 ]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>db_include</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>link_map</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_wal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/wal&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>pg_xact</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;/data/pg_xact&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>process</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 并行恢复进程数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>repo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                       </span><span style=color:#8f5902;font-style:italic># 恢复来源仓库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/pg/data                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 数据恢复位置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5432</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 恢复实例的监听端口</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-f811d9356784e47cdedcf860a7ba394a>6 - 克隆数据库集群</h1><div class=lead>如何利用 PITR 创建一个新的 PostgreSQL 集群，并恢复到指定时间点？</div><h2 id=快速上手>快速上手</h2><ul><li>利用 Standby Cluster 创建现有集群的在线副本</li><li>利用 PITR 创建现有集群的时间点快照</li><li>在 PITR 完成后进行善后，确保新集群的备份流程正常运行</li></ul><p>您可以使用 PG PITR 机制克隆整个数据库集群。</p><h2 id=重置一个集群的状态>重置一个集群的状态</h2><p>您也可以考虑创建一个全新的空集群，然后利用 PITR，将其重置为 <code>pg-meta</code> 集群的特定状态。</p><p>利用这种技术，您可以将现有集群 <code>pg-meta</code> 的任意时间点（备份保留期内）状态克隆到一个新的集群中。</p><p>我们依然以 Pigsty 4 节点沙箱环境为例，使用以下命令将 <code>pg-test</code> 集群重置为 <code>pg-meta</code> 集群的最新状态：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34; }}&#39;</span>
</span></span></code></pre></div><h2 id=pitr-善后工作>PITR 善后工作</h2><p>当你使用 PITR 恢复一个集群后，这个新集群本身的 PITR 功能是被禁用的。
因为如果它也尝试去生成备份，归档 WAL，有可能会写脏数据之前集群的备份仓库。</p><p>因此，当你确认这个 PITR 恢复出来的新集群状态符合预期后，你需要执行以下善后工作。</p><ul><li>升级备份仓库 Stanza，允许它接纳来自不同集群的新备份（仅当从别的集群恢复时）。</li><li>启用 <code>archive_mode</code>，允许新集群归档 WAL 日志（需要重启集群）</li><li>执行一个新的全量备份，确保新集群的数据被纳入（可选，也可以等 crontab 定时执行）</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pb stanza-upgrade
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode;&#39;</span>
</span></span><span style=display:flex><span>pg-backup full
</span></span></code></pre></div><p>通过这些操作，你的新集群将从第一次全量备份开始时，拥有自己的备份历史。
如果你跳过这些步骤，新集群本身的备份将无法进行，WAL 归档也不会生效。
意味着你将无法对新集群执行任何备份或 PITR 操作。</p><h2 id=不善后的后果>不善后的后果</h2><p>假设您在 <code>pg-test</code> 集群上执行了 PITR 恢复，使用了另外一个集群 <code>pg-meta</code> 的数据，但没有进行善后工作。</p><p>那么在下一次例行备份的时候，你会看到下面的错误：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-test-1:~$ pb backup
</span></span><span style=display:flex><span>2025-12-27 10:20:29.336 P00   INFO: backup <span style=color:#204a87>command</span> begin 2.57.0: --annotation<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>pg_cluster</span><span style=color:#ce5c00;font-weight:700>=</span>pg-test --compress-type<span style=color:#ce5c00;font-weight:700>=</span>lz4 --delta --exec-id<span style=color:#ce5c00;font-weight:700>=</span>21034-171fb30b --expire-auto --log-level-console<span style=color:#ce5c00;font-weight:700>=</span>info --log-level-file<span style=color:#ce5c00;font-weight:700>=</span>info --log-path<span style=color:#ce5c00;font-weight:700>=</span>/pg/log/pgbackrest --pg1-path<span style=color:#ce5c00;font-weight:700>=</span>/pg/data --pg1-port<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5432</span> --repo1-block --repo1-bundle --repo1-bundle-limit<span style=color:#ce5c00;font-weight:700>=</span>20MiB --repo1-bundle-size<span style=color:#ce5c00;font-weight:700>=</span>128MiB --repo1-cipher-pass<span style=color:#ce5c00;font-weight:700>=</span>&lt;redacted&gt; --repo1-cipher-type<span style=color:#ce5c00;font-weight:700>=</span>aes-256-cbc --repo1-path<span style=color:#ce5c00;font-weight:700>=</span>/pgbackrest --repo1-retention-full<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>14</span> --repo1-retention-full-type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --repo1-s3-bucket<span style=color:#ce5c00;font-weight:700>=</span>pgsql --repo1-s3-endpoint<span style=color:#ce5c00;font-weight:700>=</span>sss.pigsty --repo1-s3-key<span style=color:#ce5c00;font-weight:700>=</span>&lt;redacted&gt; --repo1-s3-key-secret<span style=color:#ce5c00;font-weight:700>=</span>&lt;redacted&gt; --repo1-s3-region<span style=color:#ce5c00;font-weight:700>=</span>us-east-1 --repo1-s3-uri-style<span style=color:#ce5c00;font-weight:700>=</span>path --repo1-storage-ca-file<span style=color:#ce5c00;font-weight:700>=</span>/etc/pki/ca.crt --repo1-storage-port<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>9000</span> --repo1-type<span style=color:#ce5c00;font-weight:700>=</span>s3 --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-test --start-fast
</span></span><span style=display:flex><span>2025-12-27 10:20:29.357 P00  ERROR: <span style=color:#ce5c00;font-weight:700>[</span>051<span style=color:#ce5c00;font-weight:700>]</span>: PostgreSQL version 18, system-id <span style=color:#0000cf;font-weight:700>7588470953413201282</span> <span style=color:#204a87;font-weight:700>do</span> not match stanza version 18, system-id <span style=color:#0000cf;font-weight:700>7588470974940466058</span>
</span></span><span style=display:flex><span>                                    HINT: is this the correct stanza?
</span></span><span style=display:flex><span>2025-12-27 10:20:29.357 P00   INFO: backup <span style=color:#204a87>command</span> end: aborted with exception <span style=color:#ce5c00;font-weight:700>[</span>051<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>postgres@pg-test-1:~$
</span></span></code></pre></div><p>WAL 日志归档被 pgBackrest 关闭了，因此也不会有 WAL 归档。</p><h2 id=克隆一个新集群>克隆一个新集群</h2><p>例如，假设您有一个集群 <code>pg-meta</code>，现在你想要从 <code>pg-meta</code> 克隆一个 <code>pg-meta2</code> 的新集群。</p><p>您可以考虑使用 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4><strong>备份集群</strong></a> 的方式创建一个新的集群 <code>pg-meta2</code>。</p><p>pgBackrest 支持增量备份/还原，因此如果您已经通过物理复制拉取了 <code>pg-meta</code> 的数据，通常增量 PITR 还原会非常快。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>
</span></span><span style=display:flex><span>pb stop --force
</span></span><span style=display:flex><span>pb stanza-delete --force
</span></span><span style=display:flex><span>pb start
</span></span><span style=display:flex><span>pb stanza-create
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-rm.yml -t pg_backup -l pg-test -e <span style=color:#000>pg_rm_backup</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>./pgsql.yml    -t pg_backup -l pg-test
</span></span></code></pre></div><p>如果您想要将 <code>pg-test</code> 集群重置为 <code>pg-meta</code> 集群在 2025 年 12 月 26 日 15:30 的状态，可以使用以下命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql-pitr.yml -l pg-test -e <span style=color:#4e9a06>&#39;{&#34;pg_pitr&#34;: { &#34;cluster&#34;: &#34;pg-meta&#34;, &#34;time&#34;: &#34;2025-12-27 17:50:00+08&#34; ,archive: true }}&#39;</span>
</span></span></code></pre></div><p>当然，您也可以直接创建一个全新的集群，然后使用 <code>pgsql-pitr.yml</code> 剧本从 <code>pg-meta</code> 恢复数据到新集群 <code>pg-meta2</code> 并顶替新集群的数据目录。</p><p>使用这种技术，您不仅可以克隆 <code>pg-meta</code> 集群的最新状态，还可以克隆到任意时间点，例如：</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>