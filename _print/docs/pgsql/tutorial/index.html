<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/pgsql/tutorial/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/pgsql/tutorial/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>任务教程 | PIGSTY</title><meta name=description content="如何去完成单个任务。每个任务页面是一般通过给出若干步骤展示如何执行完成某事。"><meta property="og:url" content="https://pigsty.cc/docs/pgsql/tutorial/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="任务教程"><meta property="og:description" content="如何去完成单个任务。每个任务页面是一般通过给出若干步骤展示如何执行完成某事。"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="任务教程"><meta itemprop=description content="如何去完成单个任务。每个任务页面是一般通过给出若干步骤展示如何执行完成某事。"><meta itemprop=dateModified content="2026-02-05T14:43:56+08:00"><meta itemprop=keywords content="任务,参考,PIGSTY"><meta name=twitter:card content="summary"><meta name=twitter:title content="任务教程"><meta name=twitter:description content="如何去完成单个任务。每个任务页面是一般通过给出若干步骤展示如何执行完成某事。"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/pgsql/tutorial/>返回本页常规视图</a>.</p></div><h1 class=title>任务教程</h1><div class=lead>如何去完成单个任务。每个任务页面是一般通过给出若干步骤展示如何执行完成某事。</div><ul><li>1: <a href=#pg-39a4da4f2254a96928c0e56a6cb63c63>故障排查</a></li><li>2: <a href=#pg-e6716a8d517caddd0851177927c9c69c>误删处理</a></li><li>3: <a href=#pg-23871ed725b644a5e3d037862c0c13aa>手工恢复</a></li><li>4: <a href=#pg-febcd9ad443b4eae6bee9e48b3f2d10e>利用 xfs 实现实例 Fork</a></li><li>5: <a href=#pg-ec3ed8119ef85413c277384f41ca7b27>为 PostgreSQL 集群启用 HugePage</a></li><li>6: <a href=#pg-677d9d9a118e237b46693da04151cde7>3坏2应急处理</a></li><li>7: <a href=#pg-b4eeb541b5d47f6b2e5017106913ea72>使用 VIP-Manager 为 PostgreSQL 集群配置二层 VIP</a></li><li>8: <a href=#pg-1a6ecaf250187005e255b6c6eafd53e2>Citus 集群部署</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-39a4da4f2254a96928c0e56a6cb63c63>1 - 故障排查</h1><div class=lead>常见故障与分析排查思路</div><p>本文档列举了 PostgreSQL 和 Pigsty 中可能出现的故障，以及定位、处理、分析问题的 SOP。</p><hr><h2 id=磁盘空间写满>磁盘空间写满</h2><p>磁盘空间写满是最常见的故障类型。</p><h3 id=现象>现象</h3><p>当数据库所在磁盘空间耗尽时，PostgreSQL 将无法正常工作，可能出现以下现象：数据库日志反复报错"no space left on device"（磁盘空间不足），
新数据无法写入，甚至 PostgreSQL 可能触发 PANIC 强制关闭。</p><p>Pigsty 带有 NodeFsSpaceFull 告警规则，当文件系统可用空间不足 10% 时触发告警。
使用监控系统 NODE Instance 面板查阅 FS 指标面板定位问题。</p><h3 id=诊断>诊断</h3><p>您也可以登录数据库节点，使用 <code>df -h</code> 查看各挂载盘符使用率，确定哪个分区被写满。
对于数据库节点，重点检查以下目录及其大小，以判断是哪个类别的文件占满了空间：</p><ul><li><strong>数据目录</strong>（<code>/pg/data/base</code>）：存放表和索引的数据文件，大量写入与临时文件需要关注</li><li><strong>WAL目录</strong>（如 <code>pg/data/pg_wal</code>）：存放 PG WAL，WAL 堆积/复制槽保留是常见的磁盘写满原因。</li><li><strong>数据库日志目录</strong>（如 <code>pg/log</code>）：如果 PG 日志未及时轮转写大量报错写入，也可能占用大量空间。</li><li><strong>本地备份目录</strong>（如 <code>data/backups</code>）：使用 pgBackRest 等在本机保存备份时，也有可能撑满磁盘。</li></ul><p>如果问题出在 Pigsty 管理节点或监控节点，还需考虑：</p><ul><li><strong>监控数据</strong>：VictoriaMetrics 的时序指标和 VictoriaLogs 日志存储都会占用磁盘，可检查保留策略。</li><li><strong>对象存储数据</strong>：Pigsty 集成的 MinIO 对象存储可能会被用于 PG 备份保存。</li></ul><p>明确占用空间最大的目录后，可进一步使用 <code>du -sh &lt;目录></code> 深入查找特定大型文件或子目录。</p><h3 id=处理>处理</h3><p>磁盘写满属于紧急问题，需立即采取措施释放空间并保证数据库继续运行。
当数据盘并未与系统盘区分时，写满磁盘可能导致 Shell 命令无法执行。这种情况下，可以删除 <code>/pg/dummy</code> 占位文件，释放少量应急空间以便 shell 命令恢复正常。
如果数据库由于 pg_wal 写满已经宕机，清理空间后需要重启数据库服务并仔细检查数据完整性。</p><hr><h2 id=事务号回卷>事务号回卷</h2><p>PostgreSQL 循环使用 32 位事务ID (XID)，耗尽时会出现"事务号回卷"故障（XID Wraparound）。</p><h3 id=现象-1>现象</h3><p>第一阶段的典型征兆是 <a href=https://demo.pigsty.cc/d/pgsql-persist>PGSQL Persist - Age Usage</a> 面板年龄饱和度进入警告区域。
数据库日志开始出现：<code>WARNING: database "postgres" must be vacuumed within xxxxxxxx transactions</code> 字样的信息。</p><p>若问题持续恶化，PostgreSQL 会进入保护模式：当剩余事务ID不到约100万时数据库切换为只读模式；达到上限约21亿（2^31）时则拒绝任何新事务并迫使服务器停机以避免数据错误。</p><h3 id=诊断-1>诊断</h3><p>PostgreSQL 与 Pigsty 默认启用自动垃圾回收（AutoVacuum），因此此类故障出现通常有更深层次的根因。
常见的原因包括：超长事务（SAGE），Autovacuum 配置失当，复制槽阻塞，资源不足，存储引擎/扩展BUG，磁盘坏块。</p><p>首先定位年龄最大的数据库，然后可通过 Pigsty PGCAT Database - Tables 面板来确认表的年龄分布。
同时查阅数据库错误日志，通常可以找到定位根因的线索。</p><h3 id=处理-1>处理</h3><ol><li><strong>立即冻结老事务</strong>：如果数据库尚未进入只读保护状态，立刻对受影响的库执行一次手动 VACUUM FREEZE。可以从老化最严重的表开始逐个冻结，而不是整库一起做，以加快效果。使用超级用户连接数据库，针对识别出的 <code>relfrozenxid</code> 最大的表运行 <code>VACUUM FREEZE 表名;</code>，优先冻结那些XID年龄最大的表元组。这样可以迅速回收大量事务ID空间。</li><li><strong>单用户模式救援</strong>：如果数据库已经拒绝写入或宕机保护，此时需要启动数据库到单用户模式执行冻结操作。在单用户模式下运行 <code>VACUUM FREEZE database_name;</code> 对整个数据库进行冻结清理。完成后再以多用户模式重启数据库。这样做可以解除回卷锁定，让数据库重新可写。需要注意在单用户模式下操作要非常谨慎，并确保有足够的事务ID余量完成冻结。</li><li><strong>备用节点接管</strong>：在某些复杂场景（例如遭遇硬件问题导致 vacuum 无法完成），可考虑提升集群中的只读备节点为主，以获取一个相对干净的环境来处理冻结。例如主库因坏块导致无法 vacuum，此时可以手动Failover提升备库为新的主库，再对其进行紧急 vacuum freeze。确保新主库已冻结老事务后，再将负载切回来。</li></ol><hr><h2 id=连接耗尽>连接耗尽</h2><p>PostgreSQL 有一个最大连接数配置 (<code>max_connections</code>)，当客户端连接数超过此上限时，新的连接请求将被拒绝。典型现象是在应用端看到数据库无法连接，并报出类似
<strong>FATAL: remaining connection slots are reserved for non-replication superuser connections</strong> 或 <strong>too many clients already</strong> 的错误。
这表示普通连接数已用完，仅剩下保留给超管或复制的槽位</p><h3 id=诊断-2>诊断</h3><p>连接耗尽通常由客户端大量并发请求引起。您可以通过 PGCAT Instance / PGCAT Database / PGCAT Locks 直接查阅数据库当前的活跃会话。
并判断是什么样的查询填满了系统，并进行进一步的处理。特别需要关注是否存在大量 Idle in Transaction 状态的连接以及长时间运行的事务（以及慢查询）。</p><h3 id=处理-2>处理</h3><p><strong>杀查询</strong>：对于已经耗尽导致业务受阻的情况，通常立即使用 <code>pg_terminate_backend(pid)</code> 进行紧急降压。
对于使用连接池的情况，则可以调整连接池大小参数，并执行 reload 重载的方式减少数据库层面的连接数量。</p><p>您也可以修改 <code>max_connections</code> 参数为更大的值，但本参数需要重启数据库后才能生效。</p><hr><h2 id=etcd-配额写满>etcd 配额写满</h2><p>etcd 配额写满将导致 PG 高可用控制面失效，无法进行配置变更。</p><h3 id=诊断-3>诊断</h3><p>Pigsty 在实现高可用时使用 etcd 作为分布式配置存储(DCS)，etcd 自身有一个存储配额（默认约为2GB）。
当 etcd 存储用量达到配额上限时，etcd 将拒绝写入操作，报错 &ldquo;<strong>etcdserver: mvcc: database space exceeded</strong>"。在这种情况下，Patroni 无法向 etcd 写入心跳或更新配置，从而导致集群管理功能失效。</p><h3 id=解决>解决</h3><p>在 Pigsty v2.0.0 - v2.5.1 之间的版本默认受此问题影响。Pigsty v2.6.0 为部署的 etcd 新增了自动压实的配置项，如果您仅将其用于 PG 高可用租约，则常规用例下不会再有此问题。</p><hr><h2 id=有缺陷的存储引擎>有缺陷的存储引擎</h2><p>目前，TimescaleDB 的试验性存储引擎 Hypercore 被证实存在缺陷，已经出现 VACUUM 无法回收出现 XID 回卷故障的案例。
请使用该功能的用户及时迁移至 PostgreSQL 原生表或者 TimescaleDB 默认引擎</p><p>详细介绍：《<a href=https://mp.weixin.qq.com/s/LdZVVyOj4BA9C892I25lQw>PG新存储引擎故障案例</a>》</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e6716a8d517caddd0851177927c9c69c>2 - 误删处理</h1><div class=lead>处理误删数据，误删表，误删数据库</div><h2 id=误删数据>误删数据</h2><p>如果是小批量 <code>DELETE</code> 误操作，可以考虑使用 <a href=https://pgext.cloud/e/pg_surgery><code>pg_surgery</code></a> 或者 <a href=https://pgext.cloud/e/pg_dirtyread><code>pg_dirtyread</code></a> 扩展进行原地手术恢复。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 立即关闭此表上的 Auto Vacuum 并中止 Auto Vacuum 本表的 worker 进程
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>TABLE</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>public</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>some_table</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>SET</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>(</span><span style=color:#000>autovacuum_enabled</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>toast</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>autovacuum_enabled</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>off</span><span style=color:#000;font-weight:700>);</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>CREATE</span><span style=color:#f8f8f8> </span><span style=color:#000>EXTENSION</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dirtyread</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>SELECT</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dirtyread</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#39;tablename&#39;</span><span style=color:#000;font-weight:700>)</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>AS</span><span style=color:#f8f8f8> </span><span style=color:#000>t</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>col1</span><span style=color:#f8f8f8> </span><span style=color:#000>type1</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000>col2</span><span style=color:#f8f8f8> </span><span style=color:#000>type2</span><span style=color:#000;font-weight:700>,</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>...);</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果被删除的数据已经被 VACUUM 回收，那么使用通用的误删处理流程。</p><h2 id=误删对象>误删对象</h2><p>当出现 <code>DROP/DELETE</code> 类误操作，通常按照以下流程决定恢复方案。</p><ol><li>确认此数据是否可以通过业务系统或其他数据系统找回，如果可以，直接从业务侧修复。</li><li>确认是否有延迟从库，如果有，推进延迟从库至误删时间点，查询出来恢复。</li><li>如果数据已经确认删除，确认备份信息，恢复范围是否覆盖误删时间点，如果覆盖，开始 PITR</li><li>确认是整集群原地 <a href=/docs/pgsql/backup/restore>PITR 回滚</a>，还是新开服务器重放，还是用从库来重放，并执行恢复策略</li></ol><h2 id=误删集群>误删集群</h2><p>如果出现整个数据库集群通过 Pigsty 管理命令被误删的情况，例如错误的执行 <a href=/docs/pgsql/playbook#pgsql-rmyml><code>pgsql-rm.yml</code></a> 剧本或 <code>bin/pgsql-rm</code> 命令。
除非您指定了 <a href=/docs/pgsql/param#pg_rm_backup><code>pg_rm_backup</code></a> 参数为 <code>false</code>，否则备份会与数据库集群一起被删除。</p><blockquote><p><strong>警告</strong>：在这种情况，您的数据将无法找回！<strong>请务必三思而后行！</strong></p></blockquote><p>建议：对于生产环境，您可以在配置清单中全局配置此参数为 <code>false</code>，在移除集群时保留备份。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-23871ed725b644a5e3d037862c0c13aa>3 - 手工恢复</h1><div class=lead>在沙箱环境中按照提示脚本手动执行 PITR</div><p>您可以使用 <code>pgsql-pitr.yml</code> 剧本执行 PITR，但在某些情况下，您可能希望手动执行 PITR，直接使用 pgbackrest 原语实现精细的控制。
我们将使用带有 MinIO 备份仓库的 <a href=/docs/deploy/sandbox><strong>四节点沙箱</strong></a> 集群来演示该过程。</p><p><img src=/img/pigsty/sandbox.png alt=pigsty-sandbox></p><hr><h2 id=初始化沙箱>初始化沙箱</h2><p>使用 <a href=/docs/deploy/vagrant><strong>vagrant</strong></a> 或 <a href=/docs/deploy/terraform><strong>terraform</strong></a> 准备四节点沙箱环境，然后：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl https://repo.pigsty.io/get <span style=color:#000;font-weight:700>|</span> bash<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>cd</span> ~/pigsty/
</span></span><span style=display:flex><span>./configure -c full
</span></span><span style=display:flex><span>./install
</span></span></code></pre></div><p>现在以管理节点上的管理员用户（或 dbsu）身份操作。</p><hr><h2 id=检查备份>检查备份</h2><p>要检查备份状态，您需要切换到 <code>postgres</code> 用户并使用 <code>pb</code> 命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres    <span style=color:#8f5902;font-style:italic># 切换到 dbsu: postgres 用户</span>
</span></span><span style=display:flex><span>pb info               <span style=color:#8f5902;font-style:italic># 打印 pgbackrest 备份信息</span>
</span></span></code></pre></div><p><code>pb</code> 是 <code>pgbackrest</code> 的别名，会自动从 pgbackrest 配置中获取 <code>stanza</code> 名称。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pb<span style=color:#ce5c00;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87>local</span> <span style=color:#000>stanza</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87;font-weight:700>$(</span>grep -o <span style=color:#4e9a06>&#39;\[[^][]*]&#39;</span> /etc/pgbackrest/pgbackrest.conf <span style=color:#000;font-weight:700>|</span> head -n1 <span style=color:#000;font-weight:700>|</span> sed <span style=color:#4e9a06>&#39;s/.*\[\([^]]*\)].*/\1/&#39;</span><span style=color:#204a87;font-weight:700>)</span>
</span></span><span style=display:flex><span>    pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$stanza</span> <span style=color:#000>$@</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><p>您可以看到初始备份信息，这是一个全量备份：</p><pre tabindex=0><code>root@pg-meta-1:~# pb info
stanza: pg-meta
    status: ok
    cipher: aes-256-cbc

    db (current)
        wal archive min/max (17): 000000010000000000000001/000000010000000000000007

        full backup: 20250713-022731F
            timestamp start/stop: 2025-07-13 02:27:31+00 / 2025-07-13 02:27:33+00
            wal start/stop: 000000010000000000000004 / 000000010000000000000004
            database size: 44MB, database backup size: 44MB
            repo1: backup size: 8.4MB
</code></pre><p>备份完成于 <code>2025-07-13 02:27:33+00</code>，这是您可以恢复到的最早时间。
由于 WAL 归档处于活动状态，您可以恢复到备份之后的任何时间点，直到 WAL 结束（即现在）。</p><hr><h2 id=生成心跳>生成心跳</h2><p>您可以生成一些心跳来模拟工作负载。<code>/pg-bin/pg-heartbeat</code> 就是用于此目的的，
它每秒向 <code>monitor.heartbeat</code> 表写入一个心跳时间戳。</p><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
心跳生成</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
alias</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
pgbench</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make rh     <span style=color:#8f5902;font-style:italic># 运行心跳: ssh 10.10.10.10 &#39;sudo -iu postgres /pg/bin/pg-heartbeat&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ssh 10.10.10.10 <span style=color:#4e9a06>&#39;sudo -iu postgres /pg/bin/pg-heartbeat&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>   cls   <span style=color:#000;font-weight:700>|</span>              ts               <span style=color:#000;font-weight:700>|</span>    lsn     <span style=color:#000;font-weight:700>|</span>  lsn_int  <span style=color:#000;font-weight:700>|</span> txid <span style=color:#000;font-weight:700>|</span> status  <span style=color:#000;font-weight:700>|</span>       now       <span style=color:#000;font-weight:700>|</span>  elapse
</span></span><span style=display:flex><span>---------+-------------------------------+------------+-----------+------+---------+-----------------+----------
</span></span><span style=display:flex><span> pg-meta <span style=color:#000;font-weight:700>|</span> 2025-07-13 03:01:20.318234+00 <span style=color:#000;font-weight:700>|</span> 0/115BF5C0 <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>291239360</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4812</span> <span style=color:#000;font-weight:700>|</span> leading <span style=color:#000;font-weight:700>|</span> 03:01:20.318234 <span style=color:#000;font-weight:700>|</span> 00:00:00</span></span></code></pre></div></div></div><p>您甚至可以向集群添加更多工作负载，让我们使用 <code>pgbench</code> 生成一些随机写入：</p><ul class="nav nav-tabs" id=tabs-1 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-01-00-tab data-bs-toggle=tab data-bs-target=#tabs-01-00 role=tab aria-controls=tabs-01-00 aria-selected=false>
pgbench 负载</button></li><li class=nav-item><button class="nav-link active" id=tabs-01-01-tab data-bs-toggle=tab data-bs-target=#tabs-01-01 role=tab aria-controls=tabs-01-01 aria-selected=true>
alias</button></li><li class=nav-item><button class=nav-link id=tabs-01-02-tab data-bs-toggle=tab data-bs-target=#tabs-01-02 role=tab aria-controls=tabs-01-02 aria-selected=false>
pgbench</button></li><li class=nav-item><button class=nav-link id=tabs-01-03-tab data-bs-toggle=tab data-bs-target=#tabs-01-03 role=tab aria-controls=tabs-01-03 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-1-content><div class="tab-pane fade" id=tabs-01-00 role=tabpanel aria-labelled-by=tabs-01-00-tab tabindex=1><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-01-01 role=tabpanel aria-labelled-by=tabs-01-01-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>make ri     <span style=color:#8f5902;font-style:italic># 初始化 pgbench</span>
</span></span><span style=display:flex><span>make rw     <span style=color:#8f5902;font-style:italic># 运行 pgbench 读写工作负载</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-02 role=tabpanel aria-labelled-by=tabs-01-02-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -is10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> pgbench -nv -P1 -c4 --rate<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> -T10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-01-03 role=tabpanel aria-labelled-by=tabs-01-03-tab tabindex=1><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#204a87;font-weight:700>while</span> true<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>do</span> pgbench -nv -P1 -c4 --rate<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>64</span> -T10 postgres://dbuser_meta:DBUser.Meta@10.10.10.10:5433/meta<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>pgbench <span style=color:#ce5c00;font-weight:700>(</span>17.5 <span style=color:#ce5c00;font-weight:700>(</span>Homebrew<span style=color:#ce5c00;font-weight:700>)</span>, server 17.4 <span style=color:#ce5c00;font-weight:700>(</span>Ubuntu 17.4-1.pgdg24.04+2<span style=color:#ce5c00;font-weight:700>))</span>
</span></span><span style=display:flex><span>progress: 1.0 s, 60.9 tps, lat 7.295 ms stddev 4.219, <span style=color:#0000cf;font-weight:700>0</span> failed, lag 1.818 ms
</span></span><span style=display:flex><span>progress: 2.0 s, 69.1 tps, lat 6.296 ms stddev 1.983, <span style=color:#0000cf;font-weight:700>0</span> failed, lag 1.397 ms
</span></span><span style=display:flex><span>...</span></span></code></pre></div></div></div><hr><h2 id=pitr-手册>PITR 手册</h2><p>现在让我们选择一个恢复时间点，比如 <code>2025-07-13 03:03:03+00</code>，这是初始备份（和心跳）之后的一个时间点。
要执行手动 PITR，使用 <code>pg-pitr</code> 工具：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg-pitr -t <span style=color:#4e9a06>&#34;2025-07-13 03:03:00+00&#34;</span>
</span></span></code></pre></div><p>它会为您生成执行恢复的指令，通常需要四个步骤：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>Perform <span style=color:#204a87>time</span> PITR on pg-meta
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>1. Stop PostgreSQL<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   1.1 Pause Patroni <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> there are any replicas<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ pg pause &lt;cls&gt;  <span style=color:#8f5902;font-style:italic># 暂停 patroni 自动故障切换</span>
</span></span><span style=display:flex><span>   1.2 Shutdown Patroni
</span></span><span style=display:flex><span>       $ pt-stop         <span style=color:#8f5902;font-style:italic># sudo systemctl stop patroni</span>
</span></span><span style=display:flex><span>   1.3 Shutdown Postgres
</span></span><span style=display:flex><span>       $ pg-stop         <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data stop -m fast</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>2. Perform PITR<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   2.1 Restore Backup
</span></span><span style=display:flex><span>       $ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>   2.2 Start PG to Replay WAL
</span></span><span style=display:flex><span>       $ pg-start        <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data start</span>
</span></span><span style=display:flex><span>   2.3 Validate and Promote
</span></span><span style=display:flex><span>     - If database content is ok, promote it to finish recovery, otherwise goto 2.1
</span></span><span style=display:flex><span>       $ pg-promote      <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data promote</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>3. Restore Primary<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   3.1 Enable Archive Mode <span style=color:#ce5c00;font-weight:700>(</span>Restart Required<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM SET archive_mode = on;&#39;</span>
</span></span><span style=display:flex><span>   3.1 Restart Postgres to Apply Changes
</span></span><span style=display:flex><span>       $ pg-restart      <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data restart</span>
</span></span><span style=display:flex><span>   3.3 Restart Patroni
</span></span><span style=display:flex><span>       $ pt-restart      <span style=color:#8f5902;font-style:italic># sudo systemctl restart patroni</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>[</span>4. Restore Cluster<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>===========================================</span>
</span></span><span style=display:flex><span>   4.1 Re-Init All <span style=color:#ce5c00;font-weight:700>[</span>**REPLICAS**<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>(</span><span style=color:#204a87;font-weight:700>if</span> any<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       - 4.1.1 option 1: restore replicas with same pgbackrest cmd <span style=color:#ce5c00;font-weight:700>(</span>require central backup repo<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           $ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>       - 4.1.2 option 2: nuke the replica data dir and restart patroni <span style=color:#ce5c00;font-weight:700>(</span>may take long <span style=color:#204a87>time</span> to restore<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>           $ rm -rf /pg/data/*<span style=color:#000;font-weight:700>;</span> pt-restart
</span></span><span style=display:flex><span>       - 4.1.3 option 3: reinit with patroni, which may fail <span style=color:#204a87;font-weight:700>if</span> primary lsn &lt; replica lsn
</span></span><span style=display:flex><span>           $ pg reinit pg-meta
</span></span><span style=display:flex><span>   4.2 Resume Patroni
</span></span><span style=display:flex><span>       $ pg resume pg-meta
</span></span><span style=display:flex><span>   4.3 Full Backup <span style=color:#ce5c00;font-weight:700>(</span>optional<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>       $ pg-backup full      <span style=color:#8f5902;font-style:italic># 建议在 PITR 后执行新的全量备份</span>
</span></span></code></pre></div><hr><h2 id=单节点示例>单节点示例</h2><p>让我们从简单的单节点 <code>pg-meta</code> 集群开始，作为一个更简单的示例。</p><h3 id=关闭数据库>关闭数据库</h3><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
关闭服务</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
shutdown patroni</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
shutdown postgres</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pt-stop         <span style=color:#8f5902;font-style:italic># sudo systemctl stop patroni，关闭 patroni（和 postgres）</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 可选，因为如果 patroni 未暂停，postgres 会被 patroni 关闭</span>
</span></span><span style=display:flex><span>$ pg_stop        <span style=color:#8f5902;font-style:italic># pg_ctl -D /pg/data stop -m fast，关闭 postgres</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pg_ctl: PID file <span style=color:#4e9a06>&#34;/pg/data/postmaster.pid&#34;</span> does not exist
</span></span><span style=display:flex><span>Is server running?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ pg-ps           <span style=color:#8f5902;font-style:italic># 打印 postgres 相关进程</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> UID         PID   PPID  C STIME TTY      STAT   TIME CMD
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>31048</span>      <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0</span> 02:27 ?        Ssl    0:19 /usr/sbin/pgbouncer /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>32026</span>      <span style=color:#0000cf;font-weight:700>1</span>  <span style=color:#0000cf;font-weight:700>0</span> 02:28 ?        Ssl    0:03 /usr/bin/pg_exporter ...
</span></span><span style=display:flex><span>postgres  <span style=color:#0000cf;font-weight:700>35510</span>  <span style=color:#0000cf;font-weight:700>35480</span>  <span style=color:#0000cf;font-weight:700>0</span> 03:01 pts/2    S+     0:00 /bin/bash /pg/bin/pg-heartbeat</span></span></code></pre></div></div></div><p>确保本地 postgres 没有运行，然后执行手册中给出的恢复命令：</p><h3 id=恢复备份>恢复备份</h3><ul class="nav nav-tabs" id=tabs-3 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-03-00-tab data-bs-toggle=tab data-bs-target=#tabs-03-00 role=tab aria-controls=tabs-03-00 aria-selected=false>
恢复备份</button></li><li class=nav-item><button class="nav-link active" id=tabs-03-01-tab data-bs-toggle=tab data-bs-target=#tabs-03-01 role=tab aria-controls=tabs-03-01 aria-selected=true>
restore</button></li><li class=nav-item><button class=nav-link id=tabs-03-02-tab data-bs-toggle=tab data-bs-target=#tabs-03-02 role=tab aria-controls=tabs-03-02 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-3-content><div class="tab-pane fade" id=tabs-03-00 role=tabpanel aria-labelled-by=tabs-03-00-tab tabindex=3><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-03-01 role=tabpanel aria-labelled-by=tabs-03-01-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-03-02 role=tabpanel aria-labelled-by=tabs-03-02-tab tabindex=3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ pgbackrest --stanza<span style=color:#ce5c00;font-weight:700>=</span>pg-meta --type<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>time</span> --target<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span> restore
</span></span><span style=display:flex><span>2025-07-13 03:17:07.443 P00   INFO: restore <span style=color:#204a87>command</span> begin 2.54.2: ...
</span></span><span style=display:flex><span>2025-07-13 03:17:07.470 P00   INFO: repo1: restore backup <span style=color:#204a87>set</span> 20250713-022731F, recovery will start at 2025-07-13 02:27:31
</span></span><span style=display:flex><span>2025-07-13 03:17:07.471 P00   INFO: remove invalid files/links/paths from <span style=color:#4e9a06>&#39;/pg/data&#39;</span>
</span></span><span style=display:flex><span>2025-07-13 03:17:08.523 P00   INFO: write updated /pg/data/postgresql.auto.conf
</span></span><span style=display:flex><span>2025-07-13 03:17:08.527 P00   INFO: restore <span style=color:#000>size</span> <span style=color:#ce5c00;font-weight:700>=</span> 44MB, file <span style=color:#000>total</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>1436</span>
</span></span><span style=display:flex><span>2025-07-13 03:17:08.527 P00   INFO: restore <span style=color:#204a87>command</span> end: completed successfully <span style=color:#ce5c00;font-weight:700>(</span>1087ms<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div></div><h3 id=验证数据>验证数据</h3><p>我们不希望 patroni HA 接管，直到确定数据正确，所以手动启动 postgres：</p><ul class="nav nav-tabs" id=tabs-4 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-04-00-tab data-bs-toggle=tab data-bs-target=#tabs-04-00 role=tab aria-controls=tabs-04-00 aria-selected=false>
验证数据</button></li><li class=nav-item><button class="nav-link active" id=tabs-04-01-tab data-bs-toggle=tab data-bs-target=#tabs-04-01 role=tab aria-controls=tabs-04-01 aria-selected=true>
start postgres</button></li><li class=nav-item><button class=nav-link id=tabs-04-02-tab data-bs-toggle=tab data-bs-target=#tabs-04-02 role=tab aria-controls=tabs-04-02 aria-selected=false>
output</button></li></ul><div class=tab-content id=tabs-4-content><div class="tab-pane fade" id=tabs-04-00 role=tabpanel aria-labelled-by=tabs-04-00-tab tabindex=4><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-04-01 role=tabpanel aria-labelled-by=tabs-04-01-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-start</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-04-02 role=tabpanel aria-labelled-by=tabs-04-02-tab tabindex=4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>waiting <span style=color:#204a87;font-weight:700>for</span> server to start....2025-07-13 03:19:33.133 UTC <span style=color:#ce5c00;font-weight:700>[</span>39294<span style=color:#ce5c00;font-weight:700>]</span> LOG:  redirecting log output to logging collector process
</span></span><span style=display:flex><span>2025-07-13 03:19:33.133 UTC <span style=color:#ce5c00;font-weight:700>[</span>39294<span style=color:#ce5c00;font-weight:700>]</span> HINT:  Future log output will appear in directory <span style=color:#4e9a06>&#34;/pg/log/postgres&#34;</span>.
</span></span><span style=display:flex><span> <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>server started</span></span></code></pre></div></div></div><p>现在您可以检查数据，看看是否处于您想要的时间点。
您可以通过检查业务表中的最新时间戳来验证，或者在本例中通过心跳表检查。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>postgres@pg-meta-1:~$ psql -c <span style=color:#4e9a06>&#39;table monitor.heartbeat&#39;</span>
</span></span><span style=display:flex><span>   id    <span style=color:#000;font-weight:700>|</span>              ts               <span style=color:#000;font-weight:700>|</span>    lsn    <span style=color:#000;font-weight:700>|</span> txid
</span></span><span style=display:flex><span>---------+-------------------------------+-----------+------
</span></span><span style=display:flex><span> pg-meta <span style=color:#000;font-weight:700>|</span> 2025-07-13 03:02:59.214104+00 <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>302005504</span> <span style=color:#000;font-weight:700>|</span> <span style=color:#0000cf;font-weight:700>4912</span>
</span></span></code></pre></div><p>时间戳正好在我们指定的时间点之前！（<code>2025-07-13 03:03:00+00</code>）。
如果这不是您想要的时间点，可以使用不同的时间点重复恢复。
由于恢复是以增量和并行方式执行的，速度非常快。
可以重试直到找到正确的时间点。</p><h3 id=提升主库>提升主库</h3><p>恢复后的 postgres 集群处于 <code>recovery</code> 模式，因此在提升为主库之前会拒绝任何写操作。
这些恢复参数是由 pgBackRest 在配置文件中生成的。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>postgres@pg-meta-1:~$ cat /pg/data/postgresql.auto.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Do not edit this file or use ALTER SYSTEM manually!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># It is managed by Pigsty &amp; Ansible automatically!</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Recovery settings generated by pgBackRest restore on 2025-07-13 03:17:08</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>archive_mode</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;off&#39;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>restore_command</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;pgbackrest --stanza=pg-meta archive-get %f &#34;%p&#34;&#39;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>recovery_target_time</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#39;2025-07-13 03:03:00+00&#39;</span>
</span></span></code></pre></div><p>如果数据正确，您可以<strong>提升</strong>它为主库，将其标记为新的领导者并准备接受写入。</p><ul class="nav nav-tabs" id=tabs-5 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-05-00-tab data-bs-toggle=tab data-bs-target=#tabs-05-00 role=tab aria-controls=tabs-05-00 aria-selected=false>
提升主库</button></li><li class=nav-item><button class="nav-link active" id=tabs-05-01-tab data-bs-toggle=tab data-bs-target=#tabs-05-01 role=tab aria-controls=tabs-05-01 aria-selected=true>
promote</button></li><li class=nav-item><button class=nav-link id=tabs-05-02-tab data-bs-toggle=tab data-bs-target=#tabs-05-02 role=tab aria-controls=tabs-05-02 aria-selected=false>
check</button></li></ul><div class=tab-content id=tabs-5-content><div class="tab-pane fade" id=tabs-05-00 role=tabpanel aria-labelled-by=tabs-05-00-tab tabindex=5><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-05-01 role=tabpanel aria-labelled-by=tabs-05-01-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-promote
</span></span><span style=display:flex><span>waiting <span style=color:#204a87;font-weight:700>for</span> server to promote.... <span style=color:#204a87;font-weight:700>done</span>
</span></span><span style=display:flex><span>server promoted</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-05-02 role=tabpanel aria-labelled-by=tabs-05-02-tab tabindex=5><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_is_in_recovery()&#39;</span>   <span style=color:#8f5902;font-style:italic># &#39;f&#39; 表示已提升为主库</span>
</span></span><span style=display:flex><span> pg_is_in_recovery
</span></span><span style=display:flex><span>-------------------
</span></span><span style=display:flex><span> f
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>1</span> row<span style=color:#ce5c00;font-weight:700>)</span></span></span></code></pre></div></div></div><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>新时间线和脑裂</div><p>一旦提升，数据库集群将进入新的时间线（领导者纪元）。
如果有任何写流量，将写入新的时间线。</p></div><h3 id=恢复集群>恢复集群</h3><p>最后，不仅需要恢复数据，还需要恢复集群状态，例如：</p><ul><li>patroni 接管</li><li>归档模式</li><li>备份集</li><li>从库</li></ul><h4 id=patroni-接管>Patroni 接管</h4><p>您的 postgres 是直接启动的，要恢复 HA 接管，您需要启动 patroni 服务：</p><ul class="nav nav-tabs" id=tabs-7 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-07-00-tab data-bs-toggle=tab data-bs-target=#tabs-07-00 role=tab aria-controls=tabs-07-00 aria-selected=false>
Patroni 接管</button></li><li class=nav-item><button class="nav-link active" id=tabs-07-01-tab data-bs-toggle=tab data-bs-target=#tabs-07-01 role=tab aria-controls=tabs-07-01 aria-selected=true>
launch patroni</button></li><li class=nav-item><button class=nav-link id=tabs-07-02-tab data-bs-toggle=tab data-bs-target=#tabs-07-02 role=tab aria-controls=tabs-07-02 aria-selected=false>
resume patroni</button></li></ul><div class=tab-content id=tabs-7-content><div class="tab-pane fade" id=tabs-07-00 role=tabpanel aria-labelled-by=tabs-07-00-tab tabindex=7><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-07-01 role=tabpanel aria-labelled-by=tabs-07-01-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pt-start   <span style=color:#8f5902;font-style:italic># sudo systemctl start patroni</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-07-02 role=tabpanel aria-labelled-by=tabs-07-02-tab tabindex=7><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume pg-meta      <span style=color:#8f5902;font-style:italic># 恢复 patroni 自动故障切换（如果之前暂停过）</span></span></span></code></pre></div></div></div><h4 id=归档模式>归档模式</h4><p><code>archive_mode</code> 在恢复期间被 pgbackrest 禁用。
如果您希望新领导者的写入归档到备份仓库，还需要启用 <code>archive_mode</code> 配置。</p><ul class="nav nav-tabs" id=tabs-8 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-08-00-tab data-bs-toggle=tab data-bs-target=#tabs-08-00 role=tab aria-controls=tabs-08-00 aria-selected=false>
归档模式</button></li><li class=nav-item><button class="nav-link active" id=tabs-08-01-tab data-bs-toggle=tab data-bs-target=#tabs-08-01 role=tab aria-controls=tabs-08-01 aria-selected=true>
check archive_mode</button></li><li class=nav-item><button class=nav-link id=tabs-08-02-tab data-bs-toggle=tab data-bs-target=#tabs-08-02 role=tab aria-controls=tabs-08-02 aria-selected=false>
reset archive_mode</button></li><li class=nav-item><button class=nav-link id=tabs-08-03-tab data-bs-toggle=tab data-bs-target=#tabs-08-03 role=tab aria-controls=tabs-08-03 aria-selected=false>
edit directly</button></li></ul><div class=tab-content id=tabs-8-content><div class="tab-pane fade" id=tabs-08-00 role=tabpanel aria-labelled-by=tabs-08-00-tab tabindex=8><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-08-01 role=tabpanel aria-labelled-by=tabs-08-01-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;show archive_mode&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> archive_mode
</span></span><span style=display:flex><span>--------------
</span></span><span style=display:flex><span> off</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-08-02 role=tabpanel aria-labelled-by=tabs-08-02-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;ALTER SYSTEM RESET archive_mode;&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_reload_conf();&#39;</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;show archive_mode&#39;</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-08-03 role=tabpanel aria-labelled-by=tabs-08-03-tab tabindex=8><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 您也可以直接编辑 postgresql.auto.conf 并使用 pg_ctl 重载</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;/archive_mode/d&#39;</span> /pg/data/postgresql.auto.conf
</span></span><span style=display:flex><span>pg_ctl -D /pg/data reload</span></span></code></pre></div></div></div><h4 id=备份集>备份集</h4><p>通常建议在 PITR 后执行新的全量备份，但这是可选的。</p><h4 id=从库>从库</h4><p>如果您的 postgres 集群有从库，您也需要在每个从库上执行 PITR。
或者，更简单的方法是删除从库数据目录并重启 patroni，这将从主库重新初始化从库。
我们将在下一个多节点集群示例中介绍这种情况。</p><hr><h2 id=多节点示例>多节点示例</h2><p>现在让我们以三节点 <code>pg-test</code> 集群作为 PITR 示例。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-febcd9ad443b4eae6bee9e48b3f2d10e>4 - 利用 xfs 实现实例 Fork</h1><div class=lead>在同一台机器上克隆实例并执行时间点恢复</div><p>Pigsty 提供了两个实用脚本，用于在同一台机器上快速克隆实例并执行时间点恢复：</p><ul><li><a href=#pg-fork><code>pg-fork</code></a>：在同一台机器上快速克隆一个新的 PostgreSQL 实例</li><li><a href=#pg-pitr><code>pg-pitr</code></a>：使用 pgbackrest 手动执行时间点恢复</li></ul><p>这两个脚本可以配合使用：先用 <code>pg-fork</code> 克隆实例，再用 <code>pg-pitr</code> 将克隆实例恢复到指定时间点。</p><hr><h2 id=pg-fork>pg-fork</h2><p><a href=https://github.com/pgsty/pigsty/blob/main/files/postgres/pg-fork><code>pg-fork</code></a> 可以在同一台机器上快速克隆一个新的 PostgreSQL 实例。</p><h3 id=快速上手>快速上手</h3><p>使用 <code>postgres</code> 用户（dbsu）执行以下命令，即可创建一个新的实例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span>                         <span style=color:#8f5902;font-style:italic># 从 /pg/data 克隆到 /pg/data1，端口 15432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>2</span> -d /pg/data1            <span style=color:#8f5902;font-style:italic># 从 /pg/data1 克隆到 /pg/data2，端口 25432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>3</span> -D /tmp/test -P <span style=color:#0000cf;font-weight:700>5555</span>    <span style=color:#8f5902;font-style:italic># 克隆到自定义目录和端口</span>
</span></span></code></pre></div><p>克隆完成后，可以启动并访问新实例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg_ctl -D /pg/data1 start         <span style=color:#8f5902;font-style:italic># 启动克隆实例</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span>                     <span style=color:#8f5902;font-style:italic># 连接克隆实例</span>
</span></span></code></pre></div><h3 id=命令语法>命令语法</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-fork &lt;FORK_ID&gt; <span style=color:#ce5c00;font-weight:700>[</span>options<span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><p><strong>必填参数：</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>&lt;FORK_ID></code></td><td>克隆实例编号（1-9），决定默认端口和数据目录</td></tr></tbody></table><p><strong>可选参数：</strong></p><table><thead><tr><th>参数</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>-d, --data &lt;datadir></code></td><td>源实例数据目录</td><td><code>/pg/data</code> 或 <code>$PG_DATA</code></td></tr><tr><td><code>-D, --dst &lt;dst_dir></code></td><td>目标数据目录</td><td><code>/pg/data&lt;FORK_ID></code></td></tr><tr><td><code>-p, --port &lt;port></code></td><td>源实例端口</td><td><code>5432</code> 或 <code>$PG_PORT</code></td></tr><tr><td><code>-P, --dst-port &lt;port></code></td><td>目标实例端口</td><td><code>&lt;FORK_ID>5432</code></td></tr><tr><td><code>-s, --skip</code></td><td>跳过备份 API，使用冷拷贝模式</td><td>-</td></tr><tr><td><code>-y, --yes</code></td><td>跳过确认提示</td><td>-</td></tr><tr><td><code>-h, --help</code></td><td>显示帮助信息</td><td>-</td></tr></tbody></table><h3 id=使用示例>使用示例</h3><ul class="nav nav-tabs" id=tabs-0 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-00-00-tab data-bs-toggle=tab data-bs-target=#tabs-00-00 role=tab aria-controls=tabs-00-00 aria-selected=false>
pg-fork 示例</button></li><li class=nav-item><button class="nav-link active" id=tabs-00-01-tab data-bs-toggle=tab data-bs-target=#tabs-00-01 role=tab aria-controls=tabs-00-01 aria-selected=true>
基础克隆</button></li><li class=nav-item><button class=nav-link id=tabs-00-02-tab data-bs-toggle=tab data-bs-target=#tabs-00-02 role=tab aria-controls=tabs-00-02 aria-selected=false>
指定源端口</button></li><li class=nav-item><button class=nav-link id=tabs-00-03-tab data-bs-toggle=tab data-bs-target=#tabs-00-03 role=tab aria-controls=tabs-00-03 aria-selected=false>
链式克隆</button></li><li class=nav-item><button class=nav-link id=tabs-00-04-tab data-bs-toggle=tab data-bs-target=#tabs-00-04 role=tab aria-controls=tabs-00-04 aria-selected=false>
自定义位置</button></li><li class=nav-item><button class=nav-link id=tabs-00-05-tab data-bs-toggle=tab data-bs-target=#tabs-00-05 role=tab aria-controls=tabs-00-05 aria-selected=false>
冷拷贝模式</button></li></ul><div class=tab-content id=tabs-0-content><div class="tab-pane fade" id=tabs-00-00 role=tabpanel aria-labelled-by=tabs-00-00-tab tabindex=0><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-00-01 role=tabpanel aria-labelled-by=tabs-00-01-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从默认实例克隆到 /pg/data1，端口 15432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从默认实例克隆到 /pg/data2，端口 25432</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>2</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-02 role=tabpanel aria-labelled-by=tabs-00-02-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从端口 5433 的实例克隆</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -p <span style=color:#0000cf;font-weight:700>5433</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用环境变量指定源端口</span>
</span></span><span style=display:flex><span><span style=color:#000>PG_PORT</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>5433</span> pg-fork <span style=color:#0000cf;font-weight:700>1</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-03 role=tabpanel aria-labelled-by=tabs-00-03-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从 /pg/data1 克隆到 /pg/data2</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>2</span> -d /pg/data1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 从 /pg/data2 克隆到 /pg/data3</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>3</span> -d /pg/data2</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-04 role=tabpanel aria-labelled-by=tabs-00-04-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 克隆到自定义目录和端口</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -D /tmp/pgtest -P <span style=color:#0000cf;font-weight:700>5555</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 完全自定义</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -d /pg/data -D /mnt/backup/pgclone -P <span style=color:#0000cf;font-weight:700>6543</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-00-05 role=tabpanel aria-labelled-by=tabs-00-05-tab tabindex=0><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 源实例已停止时使用冷拷贝</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 跳过确认直接执行</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -s -y</span></span></code></pre></div></div></div><h3 id=工作原理>工作原理</h3><p><code>pg-fork</code> 支持两种工作模式：</p><p><strong>热备份模式</strong>（默认，源实例运行中）：</p><ol><li>调用 <code>pg_backup_start()</code> 开始备份</li><li>使用 <code>cp --reflink=auto</code> 拷贝数据目录</li><li>调用 <code>pg_backup_stop()</code> 结束备份</li><li>修改配置文件，避免与源实例冲突</li></ol><p><strong>冷拷贝模式</strong>（使用 <code>-s</code> 参数或源实例未运行）：</p><ol><li>直接使用 <code>cp --reflink=auto</code> 拷贝数据目录</li><li>修改配置文件</li></ol><div class="alert alert-info" role=alert><div class="h4 alert-heading" role=heading>CoW 快速克隆</div><p>如果您使用 XFS（启用 reflink）、Btrfs 或 ZFS 文件系统，<code>pg-fork</code> 会利用 <strong>Copy-on-Write</strong> 特性，
数据目录拷贝在几百毫秒内完成，且几乎不占用额外存储空间。只有在数据被修改时才会分配新的存储块。</p></div><h3 id=克隆后配置>克隆后配置</h3><p><code>pg-fork</code> 会自动修改克隆实例的以下配置：</p><table><thead><tr><th>配置项</th><th>修改内容</th></tr></thead><tbody><tr><td><code>port</code></td><td>改为目标端口（避免冲突）</td></tr><tr><td><code>archive_mode</code></td><td>设为 <code>off</code>（避免污染 WAL 归档）</td></tr><tr><td><code>log_directory</code></td><td>设为 <code>log</code>（使用数据目录下的日志）</td></tr><tr><td><code>primary_conninfo</code></td><td>移除（创建独立实例）</td></tr><tr><td><code>standby.signal</code></td><td>移除（创建独立实例）</td></tr><tr><td><code>pg_replslot/*</code></td><td>清空（避免复制槽冲突）</td></tr></tbody></table><h3 id=典型工作流>典型工作流</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 克隆实例用于测试</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 启动克隆实例</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 在克隆实例上测试（不影响生产）</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span> -c <span style=color:#4e9a06>&#34;DROP TABLE important_data;&#34;</span>  <span style=color:#8f5902;font-style:italic># 安全测试</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. 测试完成后清理</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 stop
</span></span><span style=display:flex><span>rm -rf /pg/data1
</span></span></code></pre></div><hr><h2 id=pg-pitr>pg-pitr</h2><p><a href=https://github.com/pgsty/pigsty/blob/main/files/postgres/pg-pitr><code>pg-pitr</code></a> 是一个用于手动执行时间点恢复的脚本，基于 pgbackrest。</p><h3 id=快速上手-1>快速上手</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr -d                                  <span style=color:#8f5902;font-style:italic># 恢复到最新状态</span>
</span></span><span style=display:flex><span>pg-pitr -i                                  <span style=color:#8f5902;font-style:italic># 恢复到备份完成时间</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-01-01 12:00:00+08&#34;</span>         <span style=color:#8f5902;font-style:italic># 恢复到指定时间点</span>
</span></span><span style=display:flex><span>pg-pitr -n my-savepoint                     <span style=color:#8f5902;font-style:italic># 恢复到命名恢复点</span>
</span></span><span style=display:flex><span>pg-pitr -l <span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span>                      <span style=color:#8f5902;font-style:italic># 恢复到指定 LSN</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>12345678</span> -X                      <span style=color:#8f5902;font-style:italic># 恢复到事务之前</span>
</span></span><span style=display:flex><span>pg-pitr -b 20251225-120000F                 <span style=color:#8f5902;font-style:italic># 恢复到指定备份集</span>
</span></span></code></pre></div><h3 id=命令语法-1>命令语法</h3><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg-pitr <span style=color:#ce5c00;font-weight:700>[</span>options<span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>[</span>recovery_target<span style=color:#ce5c00;font-weight:700>]</span>
</span></span></code></pre></div><p><strong>恢复目标（选择一个）：</strong></p><table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>-d, --default</code></td><td>恢复到 WAL 归档流末尾（最新状态）</td></tr><tr><td><code>-i, --immediate</code></td><td>恢复到数据库一致性点（最快恢复）</td></tr><tr><td><code>-t, --time &lt;timestamp></code></td><td>恢复到指定时间点</td></tr><tr><td><code>-n, --name &lt;restore_point></code></td><td>恢复到命名恢复点</td></tr><tr><td><code>-l, --lsn &lt;lsn></code></td><td>恢复到指定 LSN</td></tr><tr><td><code>-x, --xid &lt;xid></code></td><td>恢复到指定事务 ID</td></tr><tr><td><code>-b, --backup &lt;label></code></td><td>恢复到指定备份集</td></tr></tbody></table><p><strong>可选参数：</strong></p><table><thead><tr><th>参数</th><th>说明</th><th>默认值</th></tr></thead><tbody><tr><td><code>-D, --data &lt;path></code></td><td>恢复目标数据目录</td><td><code>/pg/data</code></td></tr><tr><td><code>-s, --stanza &lt;name></code></td><td>pgbackrest stanza 名称</td><td>自动检测</td></tr><tr><td><code>-X, --exclusive</code></td><td>排除目标点（恢复到目标之前）</td><td>-</td></tr><tr><td><code>-P, --promote</code></td><td>恢复后自动提升（默认暂停）</td><td>-</td></tr><tr><td><code>-c, --check</code></td><td>干运行模式，仅打印命令</td><td>-</td></tr><tr><td><code>-y, --yes</code></td><td>跳过确认和倒计时</td><td>-</td></tr><tr><td><code>-h, --help</code></td><td>显示帮助信息</td><td>-</td></tr></tbody></table><h3 id=恢复目标类型>恢复目标类型</h3><ul class="nav nav-tabs" id=tabs-2 role=tablist><li class=nav-item><button class="nav-link disabled" id=tabs-02-00-tab data-bs-toggle=tab data-bs-target=#tabs-02-00 role=tab aria-controls=tabs-02-00 aria-selected=false>
恢复目标</button></li><li class=nav-item><button class="nav-link active" id=tabs-02-01-tab data-bs-toggle=tab data-bs-target=#tabs-02-01 role=tab aria-controls=tabs-02-01 aria-selected=true>
latest</button></li><li class=nav-item><button class=nav-link id=tabs-02-02-tab data-bs-toggle=tab data-bs-target=#tabs-02-02 role=tab aria-controls=tabs-02-02 aria-selected=false>
immediate</button></li><li class=nav-item><button class=nav-link id=tabs-02-03-tab data-bs-toggle=tab data-bs-target=#tabs-02-03 role=tab aria-controls=tabs-02-03 aria-selected=false>
time</button></li><li class=nav-item><button class=nav-link id=tabs-02-04-tab data-bs-toggle=tab data-bs-target=#tabs-02-04 role=tab aria-controls=tabs-02-04 aria-selected=false>
name</button></li><li class=nav-item><button class=nav-link id=tabs-02-05-tab data-bs-toggle=tab data-bs-target=#tabs-02-05 role=tab aria-controls=tabs-02-05 aria-selected=false>
lsn</button></li><li class=nav-item><button class=nav-link id=tabs-02-06-tab data-bs-toggle=tab data-bs-target=#tabs-02-06 role=tab aria-controls=tabs-02-06 aria-selected=false>
xid</button></li><li class=nav-item><button class=nav-link id=tabs-02-07-tab data-bs-toggle=tab data-bs-target=#tabs-02-07 role=tab aria-controls=tabs-02-07 aria-selected=false>
backup</button></li></ul><div class=tab-content id=tabs-2-content><div class="tab-pane fade" id=tabs-02-00 role=tabpanel aria-labelled-by=tabs-02-00-tab tabindex=2><pre tabindex=0><code></code></pre></div><div class="tab-pane fade show active" id=tabs-02-01 role=tabpanel aria-labelled-by=tabs-02-01-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到 WAL 归档流末尾（最新状态）</span>
</span></span><span style=display:flex><span>pg-pitr -d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 这是默认行为，会重放所有可用的 WAL</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-02 role=tabpanel aria-labelled-by=tabs-02-02-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到数据库一致性点</span>
</span></span><span style=display:flex><span>pg-pitr -i
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 最快的恢复方式，不重放额外的 WAL</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 适用于快速验证备份是否可用</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-03 role=tabpanel aria-labelled-by=tabs-02-03-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定时间点</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-01-01 12:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 使用 UTC 时间</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-01-01 04:00:00+00&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 时间格式：YYYY-MM-DD HH:MM:SS[.usec][+/-TZ]</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-04 role=tabpanel aria-labelled-by=tabs-02-04-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到命名恢复点</span>
</span></span><span style=display:flex><span>pg-pitr -n my-savepoint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复点需要事先使用 pg_create_restore_point() 创建</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># SELECT pg_create_restore_point(&#39;my-savepoint&#39;);</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-05 role=tabpanel aria-labelled-by=tabs-02-05-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定 LSN</span>
</span></span><span style=display:flex><span>pg-pitr -l <span style=color:#4e9a06>&#34;0/7C82CB8&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># LSN 可以从监控面板或 pg_current_wal_lsn() 获取</span></span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-06 role=tabpanel aria-labelled-by=tabs-02-06-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定事务 ID</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>12345678</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到事务之前（不包含该事务）</span>
</span></span><span style=display:flex><span>pg-pitr -x <span style=color:#0000cf;font-weight:700>12345678</span> -X</span></span></code></pre></div></div><div class="tab-pane fade" id=tabs-02-07 role=tabpanel aria-labelled-by=tabs-02-07-tab tabindex=2><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 恢复到指定备份集</span>
</span></span><span style=display:flex><span>pg-pitr -b 20251225-120000F
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 查看可用备份集</span>
</span></span><span style=display:flex><span>pgbackrest info</span></span></code></pre></div></div></div><h3 id=使用示例-1>使用示例</h3><p><strong>恢复到指定时间点：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 停止 PostgreSQL</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data stop -m fast
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 执行 PITR</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 启动并验证</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data start
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;SELECT * FROM important_table;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. 确认无误后提升</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data promote
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. 启用归档并执行新备份</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#34;ALTER SYSTEM SET archive_mode = on;&#34;</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data restart
</span></span><span style=display:flex><span>pg-backup full
</span></span></code></pre></div><p><strong>恢复到克隆实例：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 克隆实例</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 在克隆实例上执行 PITR</span>
</span></span><span style=display:flex><span>pg-pitr -D /pg/data1 -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 启动克隆实例验证</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 start
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span>
</span></span></code></pre></div><p><strong>干运行模式：</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 仅打印命令，不执行</span>
</span></span><span style=display:flex><span>pg-pitr -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span> -c
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 输出示例：</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Command:</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#   pgbackrest --stanza=pg-meta --delta --force --type=time --target=&#34;2025-12-27 10:00:00+08&#34; restore</span>
</span></span></code></pre></div><h3 id=恢复后处理>恢复后处理</h3><p>恢复完成后，实例会处于<strong>恢复暂停</strong>状态（除非使用 <code>-P</code> 参数）。您需要：</p><ol><li><strong>启动实例</strong>：<code>pg_ctl -D /pg/data start</code></li><li><strong>验证数据</strong>：检查数据是否符合预期</li><li><strong>提升实例</strong>：<code>pg_ctl -D /pg/data promote</code></li><li><strong>启用归档</strong>：<code>psql -c "ALTER SYSTEM SET archive_mode = on;"</code></li><li><strong>重启实例</strong>：<code>pg_ctl -D /pg/data restart</code></li><li><strong>执行备份</strong>：<code>pg-backup full</code></li></ol><div class="alert alert-warning" role=alert><div class="h4 alert-heading" role=heading>重要提示</div><p>恢复后的实例 <code>archive_mode</code> 被设为 <code>off</code>，以防止意外的 WAL 写入污染归档仓库。
确认数据正确后，务必重新启用归档并执行全量备份。</p></div><hr><h2 id=组合使用>组合使用</h2><p><code>pg-fork</code> 和 <code>pg-pitr</code> 可以组合使用，实现安全的 PITR 验证流程：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 1. 克隆当前实例</span>
</span></span><span style=display:flex><span>pg-fork <span style=color:#0000cf;font-weight:700>1</span> -y
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 2. 在克隆实例上执行 PITR（不影响生产）</span>
</span></span><span style=display:flex><span>pg-pitr -D /pg/data1 -t <span style=color:#4e9a06>&#34;2025-12-27 10:00:00+08&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 3. 启动克隆实例</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 start
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 4. 验证恢复结果</span>
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>15432</span> -c <span style=color:#4e9a06>&#34;SELECT count(*) FROM orders WHERE created_at &lt; &#39;2025-12-27 10:00:00&#39;;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 5. 确认无误后，可以选择：</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#    - 方案A：在生产实例上执行相同的 PITR</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#    - 方案B：将克隆实例提升为新的生产实例</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 6. 清理测试实例</span>
</span></span><span style=display:flex><span>pg_ctl -D /pg/data1 stop
</span></span><span style=display:flex><span>rm -rf /pg/data1
</span></span></code></pre></div><hr><h2 id=注意事项>注意事项</h2><h3 id=运行要求>运行要求</h3><ul><li>必须以 <code>postgres</code> 用户（或 postgres 组成员）执行</li><li><code>pg-pitr</code> 执行前必须停止目标实例的 PostgreSQL</li><li><code>pg-fork</code> 热备份模式需要源实例正在运行</li></ul><h3 id=文件系统>文件系统</h3><ul><li>推荐使用 XFS（启用 reflink）或 Btrfs 文件系统</li><li>CoW 文件系统上克隆几乎瞬间完成，且不占用额外空间</li><li>非 CoW 文件系统会执行完整拷贝，耗时较长</li></ul><h3 id=端口规划>端口规划</h3><table><thead><tr><th>FORK_ID</th><th>默认端口</th><th>默认数据目录</th></tr></thead><tbody><tr><td>1</td><td>15432</td><td>/pg/data1</td></tr><tr><td>2</td><td>25432</td><td>/pg/data2</td></tr><tr><td>3</td><td>35432</td><td>/pg/data3</td></tr><tr><td>&mldr;</td><td>&mldr;</td><td>&mldr;</td></tr><tr><td>9</td><td>95432</td><td>/pg/data9</td></tr></tbody></table><h3 id=安全建议>安全建议</h3><ul><li>克隆实例仅用于测试和验证，不应长期运行</li><li>验证完成后及时清理克隆实例</li><li>生产环境 PITR 建议使用 <code>pgsql-pitr.yml</code> 剧本</li><li>重要操作前先使用 <code>-c</code> 干运行模式确认命令</li></ul><h2 id=原理剖析>原理剖析</h2><p>有时候，您想要用现有的 PostgreSQL 实例在 <strong>同一台机器</strong> 上创建一个新的实例 （用于测试，PITR 恢复），可以使用 <code>postgres</code> 用户执行下面的命令：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&lt;&lt;EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>CHECKPOINT;
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT pg_backup_start(&#39;pgfork&#39;, true);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>\! rm -rf /pg/data2 &amp;&amp; cp -r --reflink=auto /pg/data /pg/data2 &amp;&amp; ls -alhd /pg/data2
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT * FROM pg_backup_stop(false);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 修改配置，避免与现有实例冲突：端口，日志，归档等</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;s/^port.*/port = 5431/&#39;</span> /pg/data2/postgresql.conf<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;s/^log_destination.*/log_destination = stderr/&#39;</span> /pg/data2/postgresql.conf<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>sed -i <span style=color:#4e9a06>&#39;s/^archive_mode.*/archive_mode = off/&#39;</span> /pg/data2/postgresql.conf<span style=color:#000;font-weight:700>;</span>
</span></span><span style=display:flex><span>rm -rf /pg/data2/postmaster.pid /pg/data2/postmaster.opts
</span></span><span style=display:flex><span>pg_ctl -D /pg/data2 start -l /pg/log/pgfork.log
</span></span><span style=display:flex><span>pg_ctl -D /pg/data2 stop
</span></span><span style=display:flex><span>psql -p <span style=color:#0000cf;font-weight:700>5431</span>  <span style=color:#8f5902;font-style:italic># 访问新实例</span>
</span></span></code></pre></div><p>上面的命令会创建一个新的数据目录 <code>/pg/data2</code>，它是现有数据目录 <code>/pg/data</code> 的一个完整拷贝。
如果您使用的是 XFS （启用了 reflink COW 特性），那么同磁盘拷贝目录会非常快，通常几百毫秒的常数时间内即可完成。</p><p>您在原地拉起新实例前，<strong>务必</strong> 修改 <code>postgresql.conf</code> 里的 <code>port</code> / <code>archive_mode</code> / <code>log_destination</code> 参数，避免影响现有生产实例等运行。
您可以使用一个没有被占用的端口，例如 <code>5431</code>，并将日志输出到 <code>/pg/log/xxxx.log</code> 避免写脏现有实例的日志文件。</p><p>我们建议同时修改 <code>shared_buffers</code> Pigsty 默认情况通常分配 25% 的系统内存给 PostgreSQL 实例，
开启新实例时，会与现有实例争夺内存资源。您可以适当调小，以减小对现有生产实例的影响。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-ec3ed8119ef85413c277384f41ca7b27>5 - 为 PostgreSQL 集群启用 HugePage</h1><div class=lead>为 PostgreSQL 集群启用大页，减少大内存实例的页表开销并提高性能</div><blockquote><p>使用 <code>node_hugepage_count</code> 和 <code>node_hugepage_ratio</code> 或 <code>/pg/bin/pg-tune-hugepage</code></p></blockquote><p>如果你计划启用大页（HugePage），请考虑使用 <a href=/docs/node/param#node_hugepage_count><code>node_hugepage_count</code></a> 和 <a href=/docs/node/param#node_hugepage_ratio><code>node_hugepage_ratio</code></a>，并配合 <code>./node.yml -t node_tune</code> 进行应用。</p><p>大页对于数据库来说有利有弊，利是内存是专门管理的，不用担心被挪用，降低数据库 OOM 风险。缺点是某些场景下可能对性能由负面影响。</p><p>在 PostgreSQL 启动前，您需要分配 <strong>足够多的</strong> 大页，浪费的部分可以使用 <code>pg-tune-hugepage</code> 脚本对其进行回收，不过此脚本仅 PostgreSQL 15+ 可用。</p><p>如果你的 PostgreSQL 已经在运行，你可以使用下面的办法启动大页（仅 PG15+ 可用）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sync<span style=color:#000;font-weight:700>;</span> <span style=color:#204a87>echo</span> <span style=color:#0000cf;font-weight:700>3</span> &gt; /proc/sys/vm/drop_caches   <span style=color:#8f5902;font-style:italic># 刷盘，释放系统缓存（请做好数据库性能受到冲击的准备）</span>
</span></span><span style=display:flex><span>sudo /pg/bin/pg-tune-hugepage             <span style=color:#8f5902;font-style:italic># 将 nr_hugepages 写入 /etc/sysctl.d/hugepage.conf</span>
</span></span><span style=display:flex><span>pg restart &lt;cls&gt;                          <span style=color:#8f5902;font-style:italic># 重启 postgres 以使用 hugepage</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-677d9d9a118e237b46693da04151cde7>6 - 3坏2应急处理</h1><div class=lead>高可用典型场景处理预案：三节点坏了两个节点，高可用不生效了，怎么从紧急状态中恢复？</div><p>如果经典3节点高可用部署同时出现两台（多数主体）故障，系统通常无法自动完成故障切换，需要人工介入：</p><p>首先判断另外两台服务器的情况，如果短时间内可以拉起，优先选择拉起另外两台服务。否则进入 <strong>紧急止血流程</strong></p><p><strong>紧急止血流程假设您的管理节点故障</strong>，只有单台普通数据库节点存活，在这种情况下，最快的恢复操作流程为：</p><ul><li>调整 HAProxy 配置，将流量指向主库。</li><li>关闭 Patroni，手动提升 PostgreSQL 从库为主库。</li></ul><hr><h2 id=调整haproxy配置>调整HAProxy配置</h2><p>如果你通过其他方式绕开 HAProxy 访问集群，那么可以跳过这一步。
如果你通过 HAProxy 方式访问数据库集群，那么你需要调整负载均衡配置，将读写流量手工指向主库。</p><ul><li>编辑 <code>/etc/haproxy/&lt;pg_cluster>-primary.cfg</code> 配置文件，其中 <code>&lt;pg_cluster></code> 为你的 PostgreSQL 集群名称，例如 <code>pg-meta</code>。</li><li>将健康检查配置选项注释，停止进行健康鉴擦好</li><li>将服务器列表中，其他两台故障的机器注释掉，只保留当前主库服务器。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-meta-primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5433</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 注释掉以下四行健康检查配置</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#option httpchk                               # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#option http-keep-alive                       # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#http-check send meth OPTIONS uri /primary    # &lt;---- remove this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#http-check expect status 200                 # &lt;---- remove this</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-meta-1 10.10.10.10:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 注释掉其他两台故障的机器</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#server pg-meta-2 10.10.10.11:6432 check port 8008 weight 100 &lt;---- comment this</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>#server pg-meta-3 10.10.10.12:6432 check port 8008 weight 100 &lt;---- comment this</span>
</span></span></code></pre></div><p>配置调整完成后，先不着急执行 <code>systemctl reload haproxy</code> 重载生效，等待后续主库提升后一起执行。
以上配置的效果是，HAProxy 将不再进行主库健康检查（默认使用 Patroni），而是直接将写入流量指向当前主库</p><hr><h2 id=手工提升备库>手工提升备库</h2><p>登陆目标服务器，切换至 dbsu 用户，执行 <code>CHECKPOINT</code> 刷盘后，关闭 Patroni，重启 PostgreSQL 并执行 Promote。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo su - postgres                     <span style=color:#8f5902;font-style:italic># 切换到数据库 dbsu 用户</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;checkpoint; checkpoint;&#39;</span>      <span style=color:#8f5902;font-style:italic># 两次 Checkpoint 刷脏页，避免PG后重启耗时过久</span>
</span></span><span style=display:flex><span>sudo systemctl stop patroni            <span style=color:#8f5902;font-style:italic># 关闭 Patroni</span>
</span></span><span style=display:flex><span>pg-restart                             <span style=color:#8f5902;font-style:italic># 重新拉起 PostgreSQL</span>
</span></span><span style=display:flex><span>pg-promote                             <span style=color:#8f5902;font-style:italic># 将 PostgreSQL 从库提升为主库</span>
</span></span><span style=display:flex><span>psql -c <span style=color:#4e9a06>&#39;SELECT pg_is_in_recovery();&#39;</span>  <span style=color:#8f5902;font-style:italic># 如果结果为 f，表示已经提升为主库</span>
</span></span></code></pre></div><p>如果你上面调整了 HAProxy 配置，那么现在可以执行 <code>systemctl reload haproxy</code> 重载 HAProxy 配置，将流量指向新的主库。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl reload haproxy                <span style=color:#8f5902;font-style:italic># 重载 HAProxy 配置，将写入流量指向当前实例</span>
</span></span></code></pre></div><hr><h2 id=避免脑裂>避免脑裂</h2><p>紧急止血后，第二优先级问题为：<strong>避免脑裂</strong>。用户应当防止另外两台服务器重新上线后，与当前主库形成脑裂，导致数据不一致。</p><p>简单的做法是：</p><ul><li>将另外两台服务器直接 <strong>断电/断网</strong>，确保它们不会在不受控的情况下再次上线。</li><li>调整应用使用的数据库连接串，将其 HOST 直接指向唯一幸存服务器上的主库。</li></ul><p>然后应当根据具体情况，决定下一步的操作：</p><ul><li>A：这两台服务器是临时故障（比如断网断电），可以原地修复后继续服务</li><li>B：这两台故障服务器是永久故障（比如硬件损坏），将移除并下线。</li></ul><hr><h2 id=临时故障后的复原>临时故障后的复原</h2><p>如果另外两台服务器是临时故障，可以修复后继续服务，那么可以按照以下步骤进行修复与重建：</p><ul><li>每次处理一台故障服务器，优先处理 管理节点 / INFRA 管理节点</li><li>启动故障服务器，并在启动后关停 Patroni</li></ul><p>ETCD 集群在法定人数恢复后，将恢复工作，此时可以启动幸存服务器（当前主库）上的 Patroni，接管现有 PostgreSQL，并重新获取集群领导者身份。
Patroni 启动后进入维护模式。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni
</span></span><span style=display:flex><span>pg pause &lt;pg_cluster&gt;
</span></span></code></pre></div><p>在另外两台实例上以 <code>postgres</code> 用户身份创建 <code>touch /pg/data/standby.signal</code> 标记文件将其标记为从库，然后拉起 Patroni：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>systemctl restart patroni
</span></span></code></pre></div><p>确认 Patroni 集群身份/角色正常后，退出维护模式：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg resume &lt;pg_cluster&gt;
</span></span></code></pre></div><hr><h2 id=永久故障后的复原>永久故障后的复原</h2><p>出现永久故障后，首先需要恢复管理节点上的 <code>~/pigsty</code> 目录，主要是需要 <code>pigsty.yml</code> 与 <code>files/pki/ca/ca.key</code> 两个核心文件。</p><blockquote><p>如果您无法取回或没有备份这两个文件，您可以选择部署一套新的 Pigsty，并通过 <a href=/docs/pgsql/config/cluster#%E5%A4%87%E4%BB%BD%E9%9B%86%E7%BE%A4>备份集群</a> 的方式将现有集群迁移至新部署中。</p><p>请定期备份 <code>pigsty</code> 目录（例如使用 Git 进行版本管理）。建议吸取教训，下次不要犯这样的错误。</p></blockquote><h4 id=配置修复>配置修复</h4><p>您可以将幸存的节点作为新的管理节点，将 <code>~/pigsty</code> 目录拷贝到新的管理节点上，然后开始调整配置。
例如，将原本默认的管理节点 <code>10.10.10.10</code> 替换为幸存节点 <code>10.10.10.12</code></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>all</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>admin_ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 使用新的管理节点地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>node_etc_hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#0000cf;font-weight:700>10.10.10.12</span><span style=color:#f8f8f8> </span><span style=color:#000>h.pigsty a.pigsty p.pigsty g.pigsty sss.pigsty]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra_portal</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                    </span><span style=color:#8f5902;font-style:italic># 一并修改其他引用旧管理节点 IP (10.10.10.10) 的配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>children</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                              </span><span style=color:#8f5902;font-style:italic># 调整 Infra 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># 10.10.10.10: { infra_seq: 1 } # 老的 Infra 节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>infra_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>   </span><span style=color:#8f5902;font-style:italic># 新增 Infra 节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>etcd</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                               </span><span style=color:#8f5902;font-style:italic># 调整 ETCD 集群</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.10: { etcd_seq: 1 }   # 注释掉此故障节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { etcd_seq: 2 }   # 注释掉此故障节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>etcd_seq</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 保留幸存节点</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>etcd_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>etcd</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># 调整 PGSQL 集群配置</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.10: { pg_seq: 1, pg_role: primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.11: { pg_seq: 2, pg_role: replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic>#10.10.10.12: { pg_seq: 3, pg_role: replica , pg_offline_query: true }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: primary , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>        </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><h4 id=etcd修复>ETCD修复</h4><p>然后执行以下命令，将 ETCD 重置为单节点集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./etcd.yml -e <span style=color:#000>etcd_safeguard</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>false</span> -e <span style=color:#000>etcd_clean</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span>
</span></span></code></pre></div><p>根据 <a href=/docs/etcd/admin#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE>ETCD重载配置</a> 的说明，调整对 ETCD Endpoint 的引用。</p><h4 id=infra修复>INFRA修复</h4><p>如果幸存节点上没有 INFRA 模块，请在当前节点上配置新的 INFRA 模块并安装。执行以下命令，将 INFRA 模块部署到幸存节点上：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./infra.yml -l 10.10.10.12
</span></span></code></pre></div><p>修复当前节点的监控</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./node.yml -t node_monitor
</span></span></code></pre></div><h4 id=pgsql修复>PGSQL修复</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_conf                            <span style=color:#8f5902;font-style:italic># 重新生成 PG 配置文件</span>
</span></span><span style=display:flex><span>systemctl reload patroni                          <span style=color:#8f5902;font-style:italic># 在幸存节点上重载 Patroni 配置</span>
</span></span></code></pre></div><p>各模块修复后，您可以参考标准扩容流程，将新的节点加入集群，恢复集群的高可用性。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-b4eeb541b5d47f6b2e5017106913ea72>7 - 使用 VIP-Manager 为 PostgreSQL 集群配置二层 VIP</h1><p>您可以在 PostgreSQL 集群上绑定一个可选的 L2 VIP —— 前提条件是：集群中的所有节点都在一个二层网络中。</p><p>这个 L2 VIP 强制使用 Master - Backup 模式，Master 始终指向在数据库集群主库实例所在的节点。</p><p>这个 VIP 由 <a href=https://github.com/cybertec-postgresql/vip-manager>VIP-Manager</a> 组件管理，它会从 DCS （etcd） 中直接读取由 Patroni 写入的 Leader Key，从而判断自己是否是 Master。</p><hr><h2 id=启用vip>启用VIP</h2><p>在 PostgreSQL 集群上定义 <a href=/docs/pgsql/param#pg_vip_enabled><code>pg_vip_enabled</code></a> 参数为 <code>true</code>，即可在集群上启用 VIP 组件。当然您也可以在全局配置中启用此配置项。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgsql 3 node ha cluster: pg-test</span>
</span></span><span style=display:flex><span>pg-test:
</span></span><span style=display:flex><span>  hosts:
</span></span><span style=display:flex><span>    10.10.10.11: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 1, pg_role: primary <span style=color:#ce5c00;font-weight:700>}</span>   <span style=color:#8f5902;font-style:italic># primary instance, leader of cluster</span>
</span></span><span style=display:flex><span>    10.10.10.12: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 2, pg_role: replica <span style=color:#ce5c00;font-weight:700>}</span>   <span style=color:#8f5902;font-style:italic># replica instance, follower of leader</span>
</span></span><span style=display:flex><span>    10.10.10.13: <span style=color:#ce5c00;font-weight:700>{</span> pg_seq: 3, pg_role: replica, pg_offline_query: <span style=color:#204a87>true</span> <span style=color:#ce5c00;font-weight:700>}</span> <span style=color:#8f5902;font-style:italic># replica with offline access</span>
</span></span><span style=display:flex><span>  vars:
</span></span><span style=display:flex><span>    pg_cluster: pg-test           <span style=color:#8f5902;font-style:italic># define pgsql cluster name</span>
</span></span><span style=display:flex><span>    pg_users:  <span style=color:#ce5c00;font-weight:700>[{</span> name: <span style=color:#204a87>test</span> , password: <span style=color:#204a87>test</span> , pgbouncer: <span style=color:#204a87>true</span> , roles: <span style=color:#ce5c00;font-weight:700>[</span> dbrole_admin <span style=color:#ce5c00;font-weight:700>]</span> <span style=color:#ce5c00;font-weight:700>}]</span>
</span></span><span style=display:flex><span>    pg_databases: <span style=color:#ce5c00;font-weight:700>[{</span> name: <span style=color:#204a87>test</span> <span style=color:#ce5c00;font-weight:700>}]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># 启用 L2 VIP</span>
</span></span><span style=display:flex><span>    pg_vip_enabled: <span style=color:#204a87>true</span>
</span></span><span style=display:flex><span>    pg_vip_address: 10.10.10.3/24
</span></span><span style=display:flex><span>    pg_vip_interface: eth1
</span></span></code></pre></div><p>请注意，<a href=/docs/pgsql/param#pg_vip_address><code>pg_vip_address</code></a> 必须是一个合法的 IP 地址，带有网段，且在当前二层网络中可用。</p><p>请注意，<a href=/docs/pgsql/param#pg_vip_interface><code>pg_vip_interface</code></a> 必须是一个合法的网络接口名，并且应当是与 inventory 中使用 IPv4 地址一致的网卡。
如果集群成员的网卡名不一样，用户应当为每个实例显式指定 <code>pg_vip_interface</code> 参数，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-test</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role: primary , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth0  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1  }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 3, pg_role: replica , pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>ens33 }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-test          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># define pgsql cluster name</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: test , password: test , pgbouncer: true , roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>test }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 启用 L2 VIP</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_address</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>10.10.10.3</span><span style=color:#000>/24</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic>#pg_vip_interface: eth1</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>使用以下命令，刷新 PG 的 vip-manager 配置并重启生效：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -t pg_vip 
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-1a6ecaf250187005e255b6c6eafd53e2>8 - Citus 集群部署</h1><div class=lead>如何部署 Citus 高可用分布式集群？</div><p>Citus 是一个 PostgreSQL 扩展，可以将 PostgreSQL 原地转换为一个分布式数据库，并实现在多个节点上水平扩展，以处理大量数据和大量查询。</p><p>Patroni 在 v3.0 后，提供了对 Citus 原生高可用的支持，简化了 Citus 集群的搭建，Pigsty 也对此提供了原生支持。</p><ul><li><a href=https://docs.citusdata.com/en/stable/get_started/what_is_citus.html>Citus 是什么</a></li><li><a href=https://patroni.readthedocs.io/en/latest/citus.html>Patroni Citus 支持</a></li></ul><blockquote><p>注意：Citus 13.x 支持 PostgreSQL 18、17、16、15、14 五个大版本。Pigsty 扩展仓库提供了 Citus ARM64 软件包。</p></blockquote><hr><h2 id=citus集群>Citus集群</h2><p>Pigsty 原生支持 Citus。可以参考 <a href=https://github.com/pgsty/pigsty/blob/main/conf/citus.yml><code>conf/citus.yml</code></a></p><p>这里使用 Pigsty 四节点沙箱，定义了一个 Citus 集群 <code>pg-citus</code>，其中包括一个两节点的协调者集群 <code>pg-citus0</code>，
以及两个 Worker 集群 <code>pg-citus1</code>，<code>pg-citus2</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.2/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.11</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.2/24 ,pg_seq: 2, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.12</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.3/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.13</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.4/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                            # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># citus 13.x supports PG 14-18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                        # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable vip for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip interface for all members</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># all dbsu password access for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, postgis, pgvector, topn, pg_cron, hll ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install these extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, pg_cron, pg_stat_statements&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_citus ,password: DBUser.Citus ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ]    }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: citus ,owner: dbuser_citus ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, vector, topn, pg_cron, hll ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>citus.node_conninfo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslmode=require sslrootcert=/pg/cert/ca.crt sslmode=verify-full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>相比标准 PostgreSQL 集群，Citus 集群的配置有一些特殊之处，首先，你需要确保 Citus 扩展被下载，安装，加载并启用，这涉及到以下四个参数</p><ul><li><a href=/docs/infra/param#repo_packages><code>repo_packages</code></a>：必须包含 <code>citus</code> 扩展，或者你需要使用带有 Citus 扩展的 PostgreSQL 离线安装包。</li><li><a href=/docs/pgsql/param#pg_extensions><code>pg_extensions</code></a>：必须包含 <code>citus</code> 扩展，即你必须在每个节点上安装 <code>citus</code> 扩展。</li><li><a href=/docs/pgsql/param#pg_libs><code>pg_libs</code></a>：必须包含 <code>citus</code> 扩展，而且首位必须为 <code>citus</code>，但现在 Patroni 会自动完成这件事了。</li><li><a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a>： 这里要定义一个首要数据库，该数据库必须安装 <code>citus</code> 扩展。</li></ul><p>其次，你需要确保 Citus 集群的配置正确：</p><ul><li><a href=/docs/pgsql/param#pg_mode><code>pg_mode</code></a>： 必须设置为 <code>citus</code>，从而告知 Patroni 使用 Citus 模式。</li><li><a href=/docs/pgsql/param#pg_primary_db><code>pg_primary_db</code></a>：必须指定一个首要数据库的名称，该数据库必须安装 <code>citus</code> 扩展，这里名为 <code>citus</code>。</li><li><a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a>：必须指定一个统一的名称，字符串，作为所有水平分片PG集群的集群名称前缀，这里为 <code>pg-citus</code>。</li><li><a href=/docs/pgsql/param#pg_group><code>pg_group</code></a>：必须指定一个分片号，从零开始依次分配的整数，<code>0</code> 号固定代表协调者集群，其他为 Worker 集群。</li><li><a href=/docs/pgsql/param#pg_cluster><code>pg_cluster</code></a> 必须与 <a href=/docs/pgsql/param#pg_shard><code>pg_shard</code></a> 和 <a href=/docs/pgsql/param#pg_group><code>pg_group</code></a> 组合后的结果对应。</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>：必须设置为非空的纯文本密码，否则 Citus 无法正常工作。</li><li><a href=/docs/pgsql/param#pg_parameters><code>pg_parameters</code></a>：建议设置 <code>citus.node_conninfo</code> 参数，强制要求 SSL 访问并要求节点间验证客户端证书。</li></ul><p>配置完成后，您可以像创建普通 PostgreSQL 集群一样，使用 <code>pgsql.yml</code> 部署 Citus 集群。</p><hr><h2 id=管理citus集群>管理Citus集群</h2><p>定义好 Citus 集群后，部署 Citus 集群同样使用的剧本 <code>pgsql.yml</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l pg-citus    <span style=color:#8f5902;font-style:italic># 部署 Citus 集群 pg-citus</span>
</span></span></code></pre></div><p>使用任意成员的 DBSU（<code>postgres</code>）用户，都能通过 <code>patronictl</code> （<code>alias: pg</code>） 列出 Citus 集群的状态：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ pg list
</span></span><span style=display:flex><span>+ Citus cluster: pg-citus ----------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> Group <span style=color:#000;font-weight:700>|</span> Member      <span style=color:#000;font-weight:700>|</span> Host        <span style=color:#000;font-weight:700>|</span> Role    <span style=color:#000;font-weight:700>|</span> State     <span style=color:#000;font-weight:700>|</span> TL <span style=color:#000;font-weight:700>|</span> Lag in MB <span style=color:#000;font-weight:700>|</span> Tags               <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> pg-citus0-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 20C.40G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> pg-citus1-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> pg-citus2-1 <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span> Leader  <span style=color:#000;font-weight:700>|</span> running   <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> pg-citus2-2 <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span> Replica <span style=color:#000;font-weight:700>|</span> streaming <span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>         <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> clonefrom: <span style=color:#204a87>true</span>    <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> conf: tiny.yml     <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> spec: 10C.20G.125G <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>       <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>             <span style=color:#000;font-weight:700>|</span>         <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span>    <span style=color:#000;font-weight:700>|</span>           <span style=color:#000;font-weight:700>|</span> version: <span style=color:#4e9a06>&#39;16&#39;</span>      <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+-------+-------------+-------------+---------+-----------+----+-----------+--------------------+
</span></span></code></pre></div><p>您可以将每个水平分片集群视为一个独立的 PGSQL 集群，使用 <code>pg</code> (<code>patronictl</code>) 命令管理它们。
但是务必注意，当你使用 <code>pg</code> 命令管理 Citus 集群时，需要额外使用 <code>--group</code> 参数指定集群分片号</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pg list pg-citus --group <span style=color:#0000cf;font-weight:700>0</span>   <span style=color:#8f5902;font-style:italic># 需要使用 --group 0 指定集群分片号</span>
</span></span></code></pre></div><p>Citus 中有一个名为 <code>pg_dist_node</code> 的系统表，用于记录 Citus 集群的节点信息，Patroni 会自动维护该表。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PGURL</span><span style=color:#ce5c00;font-weight:700>=</span>postgres://postgres:DBUser.Postgres@10.10.10.10/citus
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql <span style=color:#000>$PGURL</span> -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_node;&#39;</span>       <span style=color:#8f5902;font-style:italic># 查看节点信息</span>
</span></span><span style=display:flex><span> nodeid <span style=color:#000;font-weight:700>|</span> groupid <span style=color:#000;font-weight:700>|</span>  nodename   <span style=color:#000;font-weight:700>|</span> nodeport <span style=color:#000;font-weight:700>|</span> noderack <span style=color:#000;font-weight:700>|</span> hasmetadata <span style=color:#000;font-weight:700>|</span> isactive <span style=color:#000;font-weight:700>|</span> noderole  <span style=color:#000;font-weight:700>|</span> nodecluster <span style=color:#000;font-weight:700>|</span> metadatasynced <span style=color:#000;font-weight:700>|</span> shouldhaveshards
</span></span><span style=display:flex><span>--------+---------+-------------+----------+----------+-------------+----------+-----------+-------------+----------------+------------------
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.10 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>4</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.12 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.13 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> primary   <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> t
</span></span><span style=display:flex><span>      <span style=color:#0000cf;font-weight:700>6</span> <span style=color:#000;font-weight:700>|</span>       <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> 10.10.10.11 <span style=color:#000;font-weight:700>|</span>     <span style=color:#0000cf;font-weight:700>5432</span> <span style=color:#000;font-weight:700>|</span> default  <span style=color:#000;font-weight:700>|</span> t           <span style=color:#000;font-weight:700>|</span> t        <span style=color:#000;font-weight:700>|</span> secondary <span style=color:#000;font-weight:700>|</span> default     <span style=color:#000;font-weight:700>|</span> t              <span style=color:#000;font-weight:700>|</span> f
</span></span></code></pre></div><p>此外，你还可以查看用户认证信息（仅限超级用户访问）：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ psql <span style=color:#000>$PGURL</span> -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_authinfo;&#39;</span>   <span style=color:#8f5902;font-style:italic># 查看节点认证信息（仅限超级用户访问）</span>
</span></span></code></pre></div><p>然后，你可以使用普通业务用户（例如，具有 DDL 权限的 <code>dbuser_citus</code>）来访问 Citus 集群：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus -c <span style=color:#4e9a06>&#39;SELECT * FROM pg_dist_node;&#39;</span>
</span></span></code></pre></div><hr><h2 id=使用citus集群>使用Citus集群</h2><p>在使用 Citus 集群时，我们强烈建议您先阅读 <a href=https://docs.citusdata.com/en/stable/get_started/concepts.html>Citus 官方文档</a>，了解其架构设计与核心概念。</p><p>其中核心是了解 Citus 中的五种表，以及其特点与应用场景：</p><ul><li>分布式表（Distributed Table）</li><li>参考表（Reference Table）</li><li>本地表（Local Table）</li><li>本地管理表（Local Management Table）</li><li>架构表（Schema Table）</li></ul><p>在协调者节点上，您可以创建分布式表和引用表，并从任何数据节点查询它们。从 11.2 开始，任何 Citus 数据库节点都可以扮演协调者的角色了。</p><p>我们可以使用 pgbench 来创建一些表，并将其中的主表（<code>pgbench_accounts</code>）分布到各个节点上，然后将其他小表作为引用表：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>PGURL</span><span style=color:#ce5c00;font-weight:700>=</span>postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus
</span></span><span style=display:flex><span>pgbench -i <span style=color:#000>$PGURL</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>psql <span style=color:#000>$PGURL</span> <span style=color:#4e9a06>&lt;&lt;-EOF
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_distributed_table(&#39;pgbench_accounts&#39;, &#39;aid&#39;); SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_accounts&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_branches&#39;)         ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_branches&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_history&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_history&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>SELECT create_reference_table(&#39;pgbench_tellers&#39;)          ; SELECT truncate_local_data_after_distributing_table(&#39;public.pgbench_tellers&#39;);
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>EOF</span>
</span></span></code></pre></div><p>执行读写测试：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.10/citus      <span style=color:#8f5902;font-style:italic># 直连协调者 5432 端口</span>
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.10:6432/citus <span style=color:#8f5902;font-style:italic># 通过连接池，减少客户端连接数压力，可以有效提高整体吞吐。</span>
</span></span><span style=display:flex><span>pgbench -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.13/citus      <span style=color:#8f5902;font-style:italic># 任意 primary 节点都可以作为 coordinator</span>
</span></span><span style=display:flex><span>pgbench --select-only -nv -P1 -c10 -T500 postgres://dbuser_citus:DBUser.Citus@10.10.10.11/citus <span style=color:#8f5902;font-style:italic># 可以发起只读查询</span>
</span></span></code></pre></div><hr><h2 id=更严肃的生产部署>更严肃的生产部署</h2><p>要将 Citus 用于生产环境，您通常需要为 Coordinator 和每个 Worker 集群设置流复制物理副本。</p><p>例如，在 <a href=https://github.com/pgsty/pigsty/blob/main/conf/simu.yml><code>simu.yml</code></a> 中定义了一个 10 节点的 Citus 集群。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-citus</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus group</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.50</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.51</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 0, pg_cluster: pg-citus0 ,pg_vip_address: 10.10.10.60/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.52</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.53</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 1, pg_cluster: pg-citus1 ,pg_vip_address: 10.10.10.61/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.54</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.55</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 2, pg_cluster: pg-citus2 ,pg_vip_address: 10.10.10.62/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.56</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.57</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 3, pg_cluster: pg-citus3 ,pg_vip_address: 10.10.10.63/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.58</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 0, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.59</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_group: 4, pg_cluster: pg-citus4 ,pg_vip_address: 10.10.10.64/24 ,pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replica }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_mode: citus                            # pgsql cluster mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_version</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>17</span><span style=color:#f8f8f8>                            </span><span style=color:#8f5902;font-style:italic># citus 13.x supports PG 14-18</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_shard: pg-citus                        # citus shard name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_primary_db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># primary database used by citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_enabled</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># enable vip for citus cluster</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_vip_interface</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>eth1                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># vip interface for all members</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Postgres        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># enable dbsu password access for citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, postgis, pgvector, topn, pg_cron, hll ] </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># install these extensions</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_libs</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;citus, pg_cron, pg_stat_statements&#39;</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># citus will be added by patroni automatically</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_citus ,password: DBUser.Citus ,pgbouncer: true ,roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ]    }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: citus ,owner: dbuser_citus ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>citus, vector, topn, pg_cron, hll ] }]</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>cron.database_name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>citus</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span><span style=color:#204a87;font-weight:700>citus.node_conninfo</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;sslrootcert=/pg/cert/ca.crt sslmode=verify-full&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: 127.0.0.1/32  ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from localhost&#39;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: &#39;all&#39; ,db: all  ,addr: intra         ,auth: ssl   ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all user ssl access from intranet&#39;</span><span style=color:#f8f8f8>  </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>我们将在后续教程中覆盖一系列关于 Citus 的高级主题</p><ul><li>读写分离</li><li>故障处理</li><li>一致性备份与恢复</li><li>高级监控与问题诊断</li><li>连接池</li></ul></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>