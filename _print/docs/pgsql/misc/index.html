<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn class=no-js data-theme-init><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=color-scheme content="light dark"><meta name=theme-color media="(prefers-color-scheme: light)" content="#ffffff"><meta name=theme-color media="(prefers-color-scheme: dark)" content="#000000"><style>html{background:Canvas;color:CanvasText}@media(prefers-color-scheme:dark){html{background:#0b0d12;color:#e6e6e6}}html[data-theme-init] *{transition:none!important}</style><script>(function(){const t="td-color-theme",n=localStorage.getItem(t);let e=n||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");e==="auto"&&(e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),document.documentElement.setAttribute("data-bs-theme",e)})()</script><link rel=canonical type=text/html href=https://pigsty.cc/docs/pgsql/misc/><link rel=alternate type=application/rss+xml href=https://pigsty.cc/docs/pgsql/misc/index.xml><meta name=robots content="noindex, nofollow"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-36x36.png sizes=36x36><link rel=icon type=image/png href=/favicons/android-48x48.png sizes=48x48><link rel=icon type=image/png href=/favicons/android-72x72.png sizes=72x72><link rel=icon type=image/png href=/favicons/android-96x96.png sizes=96x96><link rel=icon type=image/png href=/favicons/android-144x144.png sizes=144x144><link rel=icon type=image/png href=/favicons/android-192x192.png sizes=192x192><title>其他说明 | PIGSTY</title><meta name=description content="其他说明与杂项文档"><meta property="og:url" content="https://pigsty.cc/docs/pgsql/misc/"><meta property="og:site_name" content="PIGSTY"><meta property="og:title" content="其他说明"><meta property="og:description" content="其他说明与杂项文档"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="website"><meta itemprop=name content="其他说明"><meta itemprop=description content="其他说明与杂项文档"><meta itemprop=dateModified content="2026-01-08T18:37:06+08:00"><meta itemprop=keywords content="参考,PGSQL"><meta name=twitter:card content="summary"><meta name=twitter:title content="其他说明"><meta name=twitter:description content="其他说明与杂项文档"><link rel=preload href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css as=style integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><link href=/scss/main.min.3858138289ee11ec3386acfac6cdb648f958d81bdf477441fa83b86e29a55a1b.css rel=stylesheet integrity="sha256-OFgTgonuEewzhqz6xs22SPlY2BvfR3RB+oO4bimlWhs=" crossorigin=anonymous><script src=https://code.jquery.com/jquery-3.7.1.min.js integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin=anonymous></script><script defer src=https://unpkg.com/lunr@2.3.9/lunr.min.js integrity=sha384-203J0SNzyqHby3iU6hzvzltrWi/M41wOP5Gu+BiJMz5nwKykbkUx8Kp7iti0Lpli crossorigin=anonymous></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-LG1V9WTKGE"></script><script>var doNotTrack=!1,dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes";if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-LG1V9WTKGE")}</script></head><body class=td-section><header><nav class="td-navbar js-navbar-scroll" data-bs-theme=dark><div class="td-navbar-container container-fluid flex-column flex-md-row"><a class=navbar-brand href=/><span class="navbar-brand__logo navbar-logo"><svg viewBox="0 0 24 24" width="24" height="24"><defs/><g id="32" fill="none" stroke-dasharray="none" fill-opacity="1" stroke-opacity="1" stroke="none"><title>32</title><g id="32_图层_2"><title>图层 2</title><g id="Group_17"><g id="Graphic_16"/><g id="Graphic_15"><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#bbb" fill-opacity=".9526367"/><path d="M7.666187 11.971335l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_14"><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" fill="#de372c" fill-opacity=".8545852"/><path d="M7.666187 19.474806l2.165064-3.75H14.16138l2.165065 3.75-2.165065 3.75H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_13"><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" fill="#424242" fill-opacity=".9016462"/><path d="M14.161476 15.751202l2.165064-3.75h4.33013l2.165064 3.75-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_12"><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" fill="#ffa269" fill-opacity=".8975772"/><path d="M14.161476 8.226008 16.32654 4.4760076h4.33013L22.821734 8.226008l-2.165064 3.75H16.32654z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_11"><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" fill="#419edb" fill-opacity=".8979957"/><path d="M7.666187 4.5 9.831251.75H14.16138L16.326445 4.5 14.16138 8.25H9.831251z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_10"><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" fill="#2f6793" fill-opacity=".9002511"/><path d="M1.1491742 8.226008 3.3142388 4.4760076H7.644368L9.809432 8.226008l-2.165064 3.75H3.3142388z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g><g id="Graphic_9"><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" fill="#53ac79" fill-opacity=".9"/><path d="M1.182071 15.741036l2.1650645-3.75h4.330129l2.1650645 3.75-2.1650645 3.75H3.3471355z" stroke="#fff" stroke-linecap="round" stroke-linejoin="round" stroke-width=".6730434"/></g></g></g></g></svg></span><span class=navbar-brand__name>PIGSTY</span></a><div class="td-navbar-nav-scroll td-navbar-nav-scroll--indicator" id=main_navbar><div class="scroll-indicator scroll-left"></div><ul class=navbar-nav><li class=nav-item><a class=nav-link href=/docs/><i class='fa-solid fa-book'></i><span>文档</span></a></li><li class=nav-item><a class=nav-link href=/blog/><i class="fas fa-blog"></i><span>博客</span></a></li><li class="nav-item dropdown d-none d-lg-block td-navbar__version-menu"><div class=dropdown><a class="nav-link dropdown-toggle" href=# role=button data-bs-toggle=dropdown aria-haspopup=true aria-expanded=false>版本</a><ul class=dropdown-menu><li><a class=dropdown-item href=https://pigsty.io>Pigsty English Site</a></li><li><a class=dropdown-item href=https://doc.pgsty.com/zh>Pigsty v3.7 文档</a></li><li><a class=dropdown-item href=https://v34.pigsty.cc/zh>Pigsty v3.4 文档</a></li><li><a class=dropdown-item href=https://v27.pigsty.cc>Pigsty v2.7 文档</a></li><li><a class=dropdown-item href=https://v15.pigsty.cc/docs>Pigsty v1.5 文档</a></li></ul></div></li><li class=nav-item><a class=nav-link href=https://pgext.cloud target=_blank rel=noopener><i class='fa-solid fa-puzzle-piece'></i><span>扩展</span></a></li><li class="nav-item td-navbar__light-dark-menu"><div class="td-light-dark-menu dropdown"><svg class="d-none"><symbol id="check2" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5.0 010 .708l-7 7a.5.5.0 01-.708.0l-3.5-3.5a.5.5.0 11.708-.708L6.5 10.293l6.646-6.647a.5.5.0 01.708.0z"/></symbol><symbol id="circle-half" viewBox="0 0 16 16"><path d="M8 15A7 7 0 108 1v14zm0 1A8 8 0 118 0a8 8 0 010 16z"/></symbol><symbol id="moon-stars-fill" viewBox="0 0 16 16"><path d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/><path d="M10.794 3.148a.217.217.0 01.412.0l.387 1.162c.173.518.579.924 1.097 1.097l1.162.387a.217.217.0 010 .412l-1.162.387A1.734 1.734.0 0011.593 7.69l-.387 1.162a.217.217.0 01-.412.0l-.387-1.162A1.734 1.734.0 009.31 6.593l-1.162-.387a.217.217.0 010-.412l1.162-.387a1.734 1.734.0 001.097-1.097l.387-1.162zM13.863.099a.145.145.0 01.274.0l.258.774c.115.346.386.617.732.732l.774.258a.145.145.0 010 .274l-.774.258a1.156 1.156.0 00-.732.732l-.258.774a.145.145.0 01-.274.0l-.258-.774a1.156 1.156.0 00-.732-.732l-.774-.258a.145.145.0 010-.274l.774-.258c.346-.115.617-.386.732-.732L13.863.1z"/></symbol><symbol id="sun-fill" viewBox="0 0 16 16"><path d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></symbol></svg>
<button class="btn btn-link nav-link dropdown-toggle d-flex align-items-center" id=bd-theme type=button aria-expanded=false data-bs-toggle=dropdown aria-label="Toggle theme (auto)">
<svg class="bi my-1 theme-icon-active"><use href="#circle-half"/></svg></button><ul class=dropdown-menu aria-labelledby=bd-theme><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=light aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#sun-fill"/></svg>
Light
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center" data-bs-theme-value=dark aria-pressed=false>
<svg class="bi me-2 opacity-50"><use href="#moon-stars-fill"/></svg>
Dark
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li><li><button type=button class="dropdown-item d-flex align-items-center active" data-bs-theme-value=auto aria-pressed=true>
<svg class="bi me-2 opacity-50"><use href="#circle-half"/></svg>
Auto
<svg class="bi ms-auto d-none"><use href="#check2"/></svg></button></li></ul></div></li><li class=nav-item><a class=nav-link href=# onclick="return switchLang(),!1" title="Switch to English / 切换语言"><i class="fas fa-language"></i></a></li></ul><div class="scroll-indicator scroll-right"></div></div><div class="d-none d-lg-block td-navbar__search"><div class="td-search td-search--offline"><div class=td-search__icon></div><input type=search class="td-search__input form-control" placeholder=站内搜索…… aria-label=站内搜索…… autocomplete=off data-offline-search-index-json-src=/offline-search-index.83c025000675b1802d158b8a9cff5b2a.json data-offline-search-base-href=/ data-offline-search-max-results=10></div></div></div></nav><script>function switchLang(){var t=window.location.host,e=window.location.pathname+window.location.search+window.location.hash;t.indexOf("pigsty.cc")!==-1?window.location.href="https://pigsty.io"+e:t.indexOf("pigsty.io")!==-1?window.location.href="https://pigsty.cc"+e:window.location.href="https://pigsty.io"+e}</script></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><div class="pageinfo pageinfo-primary d-print-none"><p>这是本节的多页打印视图。
<a href=# onclick="return print(),!1">点击此处打印</a>.</p><p><a href=/docs/pgsql/misc/>返回本页常规视图</a>.</p></div><h1 class=title>其他说明</h1><div class=lead>其他说明与杂项文档</div><ul><li>1: <a href=#pg-4d65100b9600fb960eb0de13b0e7c894>用户/角色</a></li><li>2: <a href=#pg-e73c12463833eb5e14e27191b7858ef7>数据库</a></li><li>3: <a href=#pg-3a18781032fdda789d5f38d1dd1c01a2>服务/接入</a></li><li>4: <a href=#pg-ba271faa49ebb08213e3b4f058522cdb>认证 / HBA</a></li><li>5: <a href=#pg-0b7772f5fffba0123e7353706362f45e>访问控制</a></li></ul><div class=content></div></div><div class=td-content><h1 id=pg-4d65100b9600fb960eb0de13b0e7c894>1 - 用户/角色</h1><div class=lead>用户/角色指的是使用 SQL 命令 <code>CREATE USER/ROLE</code> 创建的，数据库集簇内的逻辑对象。</div><blockquote><p>在这里的上下文中，用户指的是使用 SQL 命令 <code>CREATE USER/ROLE</code> 创建的，数据库集簇内的逻辑对象。</p></blockquote><p>在PostgreSQL中，用户直接隶属于数据库集簇而非某个具体的数据库。因此在创建业务数据库和业务用户时，应当遵循"先用户，后数据库"的原则。</p><hr><h2 id=定义用户>定义用户</h2><p>Pigsty通过两个配置参数定义数据库集群中的角色与用户：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>：定义全局统一使用的角色和用户</li><li><a href=/docs/pgsql/param#pg_users><code>pg_users</code></a>：在数据库集群层面定义业务用户和角色</li></ul><p>前者用于定义了整套环境中共用的角色与用户，后者定义单个集群中特有的业务角色与用户。二者形式相同，均为用户定义对象的数组。</p><p>你可以定义多个用户/角色，它们会按照先全局，后集群，最后按数组内排序的顺序依次创建，所以后面的用户可以属于前面定义的角色。</p><p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的业务用户定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_meta     ,password: DBUser.Meta     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_view     ,password: DBUser.Viewer   ,pgbouncer: true ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>read-only viewer for meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_grafana  ,password: DBUser.Grafana  ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for grafana database    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_bytebase ,password: DBUser.Bytebase ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for bytebase database   }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_kong     ,password: DBUser.Kong     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for kong api gateway    }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_gitea    ,password: DBUser.Gitea    ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for gitea service       }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_wiki     ,password: DBUser.Wiki     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for wiki.js service     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#204a87;font-weight:700>name: dbuser_noco     ,password: DBUser.Noco     ,pgbouncer: true ,roles: [dbrole_admin]    ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>admin user for nocodb service      }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个用户/角色定义都是一个 object，可能包括以下字段，以 <code>dbuser_meta</code> 用户为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必需，`name` 是用户定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Meta          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，密码，可以是 scram-sha-256 哈希字符串或明文</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>login</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，默认情况下可以登录</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>superuser</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，是超级用户吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createdb</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，可以创建数据库吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>createrole</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，可以创建角色吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>inherit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，默认情况下，此角色可以使用继承的权限吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>replication</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，此角色可以进行复制吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>bypassrls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，此角色可以绕过行级安全吗？</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，默认为 false，将此用户添加到 pgbouncer 用户列表吗？（使用连接池的生产用户应该显式定义为 true）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，用户连接限制，默认 -1 禁用限制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_in</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>3650</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，此角色过期时间：从创建时 + n天计算（优先级比 expire_at 更高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>expire_at</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;2030-12-31&#39;</span><span style=color:#f8f8f8>         </span><span style=color:#8f5902;font-style:italic># 可选，此角色过期的时间点，使用 YYYY-MM-DD 格式的字符串指定一个特定日期（优先级没 expire_in 高）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty admin user     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，此用户/角色的说明与备注字符串</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>dbrole_admin]          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认角色为：dbrole_{admin,readonly,readwrite,offline}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{}<span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># 可选，使用 `ALTER ROLE SET` 针对这个角色，配置角色级的数据库参数</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认为 transaction 的 pgbouncer 池模式，用户级别</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>              </span><span style=color:#8f5902;font-style:italic># 可选，用户级别的最大数据库连接数，默认 -1 禁用限制</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>search_path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，根据 postgresql 文档的键值配置参数（例如：使用 pigsty 作为默认 search_path）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>唯一必需的字段是 <code>name</code>，它应该是 PostgreSQL 集群中的一个有效且唯一的用户名。</li><li>角色不需要 <code>password</code>，但对于可登录的业务用户，通常是需要指定一个密码的。</li><li><code>password</code> 可以是明文或 scram-sha-256 / md5 哈希字符串，请最好不要使用明文密码。</li><li>用户/角色按数组顺序逐一创建，因此，请确保角色/分组的定义在成员之前。</li><li><code>login</code>、<code>superuser</code>、<code>createdb</code>、<code>createrole</code>、<code>inherit</code>、<code>replication</code>、<code>bypassrls</code> 是布尔标志。</li><li><code>pgbouncer</code> 默认是禁用的：要将业务用户添加到 pgbouncer 用户列表，您应当显式将其设置为 <code>true</code>。</li></ul><p><strong>ACL系统</strong></p><p>Pigsty 具有一套内置的，开箱即用的访问控制 / <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7>ACL</a> 系统，您只需将以下四个默认角色分配给业务用户即可轻松使用：</p><ul><li><code>dbrole_readwrite</code>：全局读写访问的角色（主属业务使用的生产账号应当具有数据库读写权限）</li><li><code>dbrole_readonly</code>：全局只读访问的角色（如果别的业务想要只读访问，可以使用此角色）</li><li><code>dbrole_admin</code>：拥有DDL权限的角色 （业务管理员，需要在应用中建表的场景）</li><li><code>dbrole_offline</code>：受限的只读访问角色（只能访问 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>offline</a> 实例，通常是个人用户）</li></ul><p>如果您希望重新设计您自己的 ACL 系统，可以考虑定制以下参数和模板：</p><ul><li><a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a>：系统范围的角色和全局用户</li><li><a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a>：新建对象的默认权限</li><li><a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-role.sql><code>roles/pgsql/templates/pg-init-role.sql</code></a>：角色创建 SQL 模板</li><li><a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>roles/pgsql/templates/pg-init-template.sql</code></a>：权限 SQL 模板</li></ul><hr><h2 id=创建用户>创建用户</h2><p>在 <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> 和 <a href=/docs/pgsql/param#pg_users><code>pg_users</code></a> 中 <a href=#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7>定义</a> 的用户和角色，将在集群初始化的 PROVISION 阶段中自动逐一创建。
如果您希望在现有的集群上 <a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7>创建用户</a>，可以使用 <code>bin/pgsql-user</code> 工具。
将新用户/角色定义添加到 <code>all.children.&lt;cls>.pg_users</code>，并使用以下方法创建该数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>不同于数据库，创建用户的剧本总是幂等的。当目标用户已经存在时，Pigsty会修改目标用户的属性使其符合配置。所以在现有集群上重复运行它通常不会有问题。</p><div class="alert alert-secondary" role=alert><div class="h4 alert-heading" role=heading>请使用剧本创建用户</div><p>我们不建议您手工创建新的业务用户，特别当您想要创建的用户使用默认的 pgbouncer 连接池时：除非您愿意手工负责维护 Pgbouncer 中的用户列表并与 PostgreSQL 保持一致。
使用 <strong><code>bin/pgsql-user</code></strong> 工具或 <a href=/docs/pgsql/playbook#pgsql-useryml><strong><code>pgsql-user.yml</code></strong></a> 剧本创建新数据库时，会将此数据库一并添加到 <a href=#pgbouncer%E7%94%A8%E6%88%B7>Pgbouncer用户</a> 列表中。</p></div><hr><h2 id=修改用户>修改用户</h2><p>修改 PostgreSQL 用户的属性的方式与 <a href=#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7><strong>创建用户</strong></a> 相同。</p><p>首先，调整您的用户定义，修改需要调整的属性，然后执行以下命令应用：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-user &lt;cls&gt; &lt;username&gt;    <span style=color:#8f5902;font-style:italic># pgsql-user.yml -l &lt;cls&gt; -e username=&lt;username&gt;</span>
</span></span></code></pre></div><p>请注意，修改用户不会删除用户，而是通过 <code>ALTER USER</code> 命令修改用户属性；也不会回收用户的权限与分组，并使用 <code>GRANT</code> 命令授予新的角色。</p><hr><h2 id=pgbouncer用户>Pgbouncer用户</h2><p>默认情况下启用 Pgbouncer，并作为连接池中间件，其用户默认被管理。</p><p>Pigsty 默认将 <a href=/docs/pgsql/param#pg_users><code>pg_users</code></a> 中显式带有 <code>pgbouncer: true</code> 标志的所有用户添加到 pgbouncer 用户列表中。</p><p>Pgbouncer 连接池中的用户在 <code>/etc/pgbouncer/userlist.txt</code> 中列出：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>&#34;postgres&#34; &#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_wiki&#34; &#34;SCRAM-SHA-256$4096:+77dyhrPeFDT/TptHs7/7Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$KeatuohpKIYzHPCt/tqBu85vI11o9mar/by0hHYM2W8=:X9gig4JtjoS8Y/o1vQsIX/gY1Fns8ynTXkbWOjUfbRQ=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_view&#34; &#34;SCRAM-SHA-256$4096:DFoZHU/DXsHL8MJ8regdEw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$gx9sUGgpVpdSM4o6A2R9PKAUkAsRPLhLoBDLBUYtKS0=:MujSgKe6rxcIUMv4GnyXJmV0YNbf39uFRZv724+X1FE=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_monitor&#34; &#34;SCRAM-SHA-256$4096:fwU97ZMO/KR0ScHO5+UuBg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$CrNsmGrx1DkIGrtrD1Wjexb/aygzqQdirTO1oBZROPY=:L8+dJ+fqlMQh7y4PmVR/gbAOvYWOr+KINjeMZ8LlFww=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_meta&#34; &#34;SCRAM-SHA-256$4096:leB2RQPcw1OIiRnPnOMUEg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$eyC+NIMKeoTxshJu314+BmbMFpCcspzI3UFZ1RYfNyU=:fJgXcykVPvOfro2MWNkl5q38oz21nSl1dTtM65uYR1Q=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_kong&#34; &#34;SCRAM-SHA-256$4096:bK8sLXIieMwFDz67/0dqXQ</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$P/tCRgyKx9MC9LH3ErnKsnlOqgNd/nn2RyvThyiK6e4=:CDM8QZNHBdPf97ztusgnE7olaKDNHBN0WeAbP/nzu5A=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_grafana&#34; &#34;SCRAM-SHA-256$4096:HjLdGaGmeIAGdWyn2gDt/Q</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$jgoyOB8ugoce+Wqjr0EwFf8NaIEMtiTuQTg1iEJs9BM=:ed4HUFqLyB4YpRr+y25FBT7KnlFDnan6JPVT9imxzA4=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_gitea&#34; &#34;SCRAM-SHA-256$4096:l1DBGCc4dtircZ8O8Fbzkw</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$tpmGwgLuWPDog8IEKdsaDGtiPAxD16z09slvu+rHE74=:pYuFOSDuWSofpD9OZhG7oWvyAR0PQjJBffgHZLpLHds=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_dba&#34; &#34;SCRAM-SHA-256$4096:zH8niABU7xmtblVUo2QFew</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$Zj7/pq+ICZx7fDcXikiN7GLqkKFA+X5NsvAX6CMshF0=:pqevR2WpizjRecPIQjMZOm+Ap+x0kgPL2Iv5zHZs0+g=&#34;</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>&#34;dbuser_bytebase&#34; &#34;SCRAM-SHA-256$4096:OMoTM9Zf8QcCCMD0svK5gg</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>=$kMchqbf4iLK1U67pVOfGrERa/fY818AwqfBPhsTShNQ=:6HqWteN+AadrUnrgC0byr5A72noqnPugItQjOLFw0Wk=&#34;</span>
</span></span></code></pre></div><p>而用户级别的连接池参数则是使用另一个单独的文件： <code>/etc/pgbouncer/useropts.txt</code> 进行维护，比如：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>dbuser_dba</span>                  <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=16</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>dbuser_monitor</span>              <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>pool_mode=session max_user_connections=8</span>
</span></span></code></pre></div><p>当您 <a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93>创建数据库</a> 时，Pgbouncer 的数据库列表定义文件将会被刷新，并通过在线重载配置的方式生效，不会影响现有的连接。</p><p>Pgbouncer 使用和 PostgreSQL 同样的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户，您可以使用 <code>pgb</code> 别名，使用 dbsu 访问 pgbouncer 管理功能。</p><p>Pigsty 还提供了一个实用函数 <code>pgb-route</code> ，可以将 pgbouncer 数据库流量快速切换至集群中的其他节点，用于零停机迁移：</p><p>连接池用户配置文件 <code>userlist.txt</code> 与 <code>useropts.txt</code> 会在您 <a href=#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7>创建用户</a> 时自动刷新，并通过在线重载配置的方式生效，正常不会影响现有的连接。</p><p>请注意，<a href=/docs/pgsql/param#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a> 参数允许你使用动态查询来完成连接池用户认证，当您懒得管理连接池中的用户时，这是一种折中的方案。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-e73c12463833eb5e14e27191b7858ef7>2 - 数据库</h1><div class=lead>数据库指的是使用 SQL 命令 <code>CREATE DATABASE</code> 创建的，数据库集簇内的逻辑对象。</div><blockquote><p>在这里的上下文中，数据库指的是使用 SQL 命令 <code>CREATE DATABASE</code> 创建的，数据库集簇内的逻辑对象。</p></blockquote><p>一组 PostgreSQL 服务器可以同时服务于多个 <strong>数据库</strong> （Database）。在 Pigsty 中，你可以在集群配置中 <a href=#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>定义</a> 好所需的数据库。</p><p>Pigsty会对默认模板数据库<code>template1</code>进行修改与定制，创建默认模式，安装默认扩展，配置默认权限，新创建的数据库默认会从<code>template1</code>继承这些设置。</p><p>默认情况下，所有业务数据库都会被1:1添加到 Pgbouncer 连接池中；<code>pg_exporter</code> 默认会通过 <strong>自动发现</strong> 机制查找所有业务数据库并进行库内对象监控。</p><hr><h2 id=定义数据库>定义数据库</h2><p>业务数据库定义在数据库集群参数 <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> 中，这是一个数据库定义构成的对象数组。
数组内的数据库按照<strong>定义顺序</strong>依次创建，因此后面定义的数据库可以使用先前定义的数据库作为<strong>模板</strong>。</p><p>下面是 Pigsty 演示环境中默认集群 <code>pg-meta</code> 中的数据库定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: meta ,baseline: cmdb.sql ,comment: pigsty meta database ,schemas: [pigsty] ,extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#204a87;font-weight:700>name: postgis, schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public}, {name: timescaledb}]}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: grafana  ,owner: dbuser_grafana  ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>grafana primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: bytebase ,owner: dbuser_bytebase ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>bytebase primary database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: kong     ,owner: dbuser_kong     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>kong the api gateway database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitea    ,owner: dbuser_gitea    ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>gitea meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: wiki     ,owner: dbuser_wiki     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>wiki meta database }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: noco     ,owner: dbuser_noco     ,revokeconn: true ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>nocodb database }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>每个数据库定义都是一个 object，可能包括以下字段，以 <code>meta</code> 数据库为例：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta                     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是数据库定义的唯一必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>baseline</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>cmdb.sql             </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库 sql 的基线定义文件路径（ansible 搜索路径中的相对路径，如 files/）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pgbouncer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库添加到 pgbouncer 数据库列表？默认为 true</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>schemas</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#000>pigsty]              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要创建的附加模式，由模式名称字符串组成的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>extensions</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                     </span><span style=color:#8f5902;font-style:italic># 可选，要安装的附加扩展： 扩展对象的数组</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgis , schema</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>public } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可以指定将扩展安装到某个模式中，也可以不指定（不指定则安装到 search_path 首位模式中）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>timescaledb }              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 例如有的扩展会创建并使用固定的模式，就不需要指定模式。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pigsty meta database  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库的说明与备注信息</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库所有者，默认为 postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>template</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>template1            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，要使用的模板，默认为 template1，目标必须是一个模板数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>encoding</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>UTF8                 </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库编码，默认为 UTF8（必须与模板数据库相同）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>locale</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库地区设置，默认为 C（必须与模板数据库相同）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_collate</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库 collate 排序规则，默认为 C（必须与模板数据库相同），没有理由不建议更改。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>lc_ctype</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>C                    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库 ctype 字符集，默认为 C（必须与模板数据库相同）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>tablespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，默认表空间，默认为 &#39;pg_default&#39;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>               </span><span style=color:#8f5902;font-style:italic># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>register_datasource</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 可选，是否将此数据库注册到 grafana 数据源？默认为 true，显式设置为 false 会跳过注册</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>-<span style=color:#0000cf;font-weight:700>1</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库连接限制，默认为 -1 ，不限制，设置为正整数则会限制连接数。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_auth_user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_meta    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，连接到此 pgbouncer 数据库的所有连接都将使用此用户进行验证（启用 pgbouncer_auth_query 才有用）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_mode</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>transaction         </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池化模式，默认为 transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>64</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 默认池子大小，默认为 64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_reserve</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>32</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池子保留空间，默认为 32，当默认池子不够用时，最多再申请这么多条突发连接。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_size_min</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#f8f8f8>                </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的 pgbouncer 池的最小大小，默认为 0</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>pool_connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>           </span><span style=color:#8f5902;font-style:italic># 可选，数据库级别的最大数据库连接数，默认为 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>唯一必选的字段是 <code>name</code>，它应该是当前 PostgreSQL 集群中有效且唯一的数据库名称，其他参数都有合理的默认值。</p><ul><li><code>name</code>：数据库名称，<strong>必选项</strong>。</li><li><code>baseline</code>：SQL文件路径（Ansible搜索路径，通常位于<code>files</code>），用于初始化数据库内容。</li><li><code>owner</code>：数据库属主，默认为<code>postgres</code></li><li><code>template</code>：数据库创建时使用的模板，默认为<code>template1</code></li><li><code>encoding</code>：数据库默认字符编码，默认为<code>UTF8</code>，默认与实例保持一致。建议不要配置与修改。</li><li><code>locale</code>：数据库默认的本地化规则，默认为<code>C</code>，建议不要配置，与实例保持一致。</li><li><code>lc_collate</code>：数据库默认的本地化字符串排序规则，默认与实例设置相同，建议不要修改，必须与模板数据库一致。强烈建议不要配置，或配置为<code>C</code>。</li><li><code>lc_ctype</code>：数据库默认的LOCALE，默认与实例设置相同，建议不要修改或设置，必须与模板数据库一致。建议配置为C或<code>en_US.UTF8</code>。</li><li><code>allowconn</code>：是否允许连接至数据库，默认为<code>true</code>，不建议修改。</li><li><code>revokeconn</code>：是否回收连接至数据库的权限？默认为<code>false</code>。如果为<code>true</code>，则数据库上的<code>PUBLIC CONNECT</code>权限会被回收。只有默认用户（<code>dbsu|monitor|admin|replicator|owner</code>）可以连接。此外，<code>admin|owner</code> 会拥有GRANT OPTION，可以赋予其他用户连接权限。</li><li><code>tablespace</code>：数据库关联的表空间，默认为<code>pg_default</code>。</li><li><code>connlimit</code>：数据库连接数限制，默认为<code>-1</code>，即没有限制。</li><li><code>extensions</code>：对象数组 ，每一个对象定义了一个数据库中的<strong>扩展</strong>，以及其安装的<strong>模式</strong>。</li><li><code>parameters</code>：KV对象，每一个KV定义了一个需要针对数据库通过<code>ALTER DATABASE</code>修改的参数。</li><li><code>pgbouncer</code>：布尔选项，是否将该数据库加入到Pgbouncer中。所有数据库都会加入至Pgbouncer列表，除非显式指定<code>pgbouncer: false</code>。</li><li><code>comment</code>：数据库备注信息。</li><li><code>pool_auth_user</code>：启用 <a href=/docs/pgsql/param#pgbouncer_auth_query><code>pgbouncer_auth_query</code></a> 时，连接到此 pgbouncer 数据库的所有连接都将使用这里指定的用户执行认证查询。你需要使用一个具有访问 <code>pg_shadow</code> 表权限的用户。</li><li><code>pool_mode</code>：数据库级别的 pgbouncer 池化模式，默认为 transaction，即事物池化。如果留空，会使用 <a href=/docs/pgsql/param#pgbouncer_poolmode><code>pgbouncer_poolmode</code></a> 参数作为默认值。</li><li><code>pool_size</code>：数据库级别的 pgbouncer 默认池子大小，默认为 64</li><li><code>pool_reserve</code>：数据库级别的 pgbouncer 池子保留空间，默认为 32，当默认池子不够用时，最多再申请这么多条突发连接。</li><li><code>pool_size_min</code>： 数据库级别的 pgbouncer 池的最小大小，默认为 0</li><li><code>pool_connlimit</code>： 数据库级别的 pgbouncer 连接池最大数据库连接数，默认为 100</li></ul><p>新创建的数据库默认会从 <code>template1</code> 数据库 Fork 出来，这个模版数据库会在 <a href=/docs/pgsql/param#pg_provision><code>PG_PROVISION</code></a> 阶段进行定制修改：
配置好扩展，模式以及默认权限，因此新创建的数据库也会继承这些配置，除非您显式使用一个其他的数据库作为模板。</p><p>关于数据库的访问权限，请参考 <a href=/docs/concept/sec/ac/#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9A%94%E7%A6%BB>ACL：数据库权限</a> 一节。</p><hr><h2 id=创建数据库>创建数据库</h2><p>在 <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> 中 <a href=#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>定义</a> 的数据库将在集群初始化时自动创建。
如果您希望在现有集群上 <a href=/docs/pgsql/admin/db#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93>创建数据库</a>，可以使用 <code>bin/pgsql-db</code> 包装脚本。
将新的数据库定义添加到 <code>all.children.&lt;cls>.pg_databases</code> 中，并使用以下命令创建该数据库：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-db &lt;cls&gt; &lt;dbname&gt;    <span style=color:#8f5902;font-style:italic># pgsql-db.yml -l &lt;cls&gt; -e dbname=&lt;dbname&gt;</span>
</span></span></code></pre></div><p>下面是新建数据库时的一些注意事项：</p><p>创建数据库的剧本默认为幂等剧本，不过当您当使用 <code>baseline</code> 脚本时就不一定了：这种情况下，通常不建议在现有数据库上重复执行此操作，除非您确定所提供的 baseline SQL也是幂等的。</p><p>我们不建议您手工创建新的数据库，特别当您使用默认的 pgbouncer 连接池时：除非您愿意手工负责维护 Pgbouncer 中的数据库列表并与 PostgreSQL 保持一致。
使用 <code>pgsql-db</code> 工具或 <code>pgsql-db.yml</code> 剧本创建新数据库时，会将此数据库一并添加到 <a href=#pgbouncer%E6%95%B0%E6%8D%AE%E5%BA%93>Pgbouncer 数据库</a> 列表中。</p><p>如果您的数据库定义有一个非常规 <code>owner</code>（默认为 dbsu <code>postgres</code>），那么请确保在创建该数据库前，属主用户已经存在。
最佳实践永远是在创建数据库之前 <a href=/docs/pgsql/admin/user#%E5%88%9B%E5%BB%BA%E7%94%A8%E6%88%B7>创建</a> <a href=/docs/pgsql/config/user>用户</a>。</p><hr><h2 id=pgbouncer数据库>Pgbouncer数据库</h2><p>Pigsty 会默认为 PostgreSQL 实例 1:1 配置启用一个 Pgbouncer 连接池，使用 <code>/var/run/postgresql</code> Unix Socket 通信。</p><p>连接池可以优化短连接性能，降低并发征用，以避免过高的连接数冲垮数据库，并在数据库迁移时提供额外的灵活处理空间。</p><p>Pigsty 默认将 <a href=/docs/pgsql/param#pg_databases><code>pg_databases</code></a> 中的所有数据库都添加到 pgbouncer 的数据库列表中。
您可以通过在数据库 <a href=#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>定义</a> 中显式设置 <code>pgbouncer: false</code> 来禁用特定数据库的 pgbouncer 连接池支持。</p><p>Pgbouncer数据库列表在 <code>/etc/pgbouncer/database.txt</code> 中定义，数据库定义中关于连接池的参数会体现在这里：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>meta                        = host=/var/run/postgresql mode=session</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>grafana                     = host=/var/run/postgresql mode=transaction</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>bytebase                    = host=/var/run/postgresql auth_user=dbuser_meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>kong                        = host=/var/run/postgresql pool_size=32 reserve_pool=64</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>gitea                       = host=/var/run/postgresql min_pool_size=10</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>wiki                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>noco                        = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>mongo                       = host=/var/run/postgresql</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>当您 <a href=#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93>创建数据库</a> 时，Pgbouncer 的数据库列表定义文件将会被刷新，并通过在线重载配置的方式生效，正常不会影响现有的连接。</p><p>Pgbouncer 使用和 PostgreSQL 同样的 <code>dbsu</code> 运行，默认为 <code>postgres</code> 操作系统用户，您可以使用 <code>pgb</code> 别名，使用 dbsu 访问 pgbouncer 管理功能。</p><p>Pigsty 还提供了一个实用函数 <code>pgb-route</code> ，可以将 pgbouncer 数据库流量快速切换至集群中的其他节点，用于零停机迁移：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># route pgbouncer traffic to another cluster member</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>function</span> pgb-route<span style=color:#ce5c00;font-weight:700>(){</span>
</span></span><span style=display:flex><span>  <span style=color:#204a87>local</span> <span style=color:#000>ip</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>${</span><span style=color:#000>1</span><span style=color:#000;font-weight:700>-</span><span style=color:#4e9a06>&#39;\/var\/run\/postgresql&#39;</span><span style=color:#4e9a06>}</span>
</span></span><span style=display:flex><span>  sed -ie <span style=color:#4e9a06>&#34;s/host=[^[:space:]]\+/host=</span><span style=color:#4e9a06>${</span><span style=color:#000>ip</span><span style=color:#4e9a06>}</span><span style=color:#4e9a06>/g&#34;</span> /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span>  cat /etc/pgbouncer/pgbouncer.ini
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div></div><div class=td-content style=page-break-before:always><h1 id=pg-3a18781032fdda789d5f38d1dd1c01a2>3 - 服务/接入</h1><div class=lead>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</div><blockquote><p>分离读写操作，正确路由流量，稳定可靠地交付 PostgreSQL 集群提供的能力。</p></blockquote><p><a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>服务</a> 是一种抽象：它是数据库集群对外提供能力的形式，并封装了底层集群的细节。</p><p>服务对于生产环境中的 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>稳定接入</a> 至关重要，在 <a href=/docs/concept/ha>高可用</a> 集群自动故障时方显其价值，<a href=#%E5%8D%95%E6%9C%BA%E7%94%A8%E6%88%B7>单机用户</a> 通常不需要操心这个概念。</p><hr><h2 id=单机用户>单机用户</h2><p>“服务” 的概念是给生产环境用的，个人用户/单机集群可以不折腾，直接拿实例名/IP地址访问数据库。</p><p>例如，Pigsty 默认的单节点 <code>pg-meta</code>.<code>meta</code> 数据库，就可以直接用下面三个不同的用户连接上去。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10/meta     <span style=color:#8f5902;font-style:italic># 直接用 DBA 超级用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@10.10.10.10/meta   <span style=color:#8f5902;font-style:italic># 用默认的业务管理员用户连上去</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_view:DBUser.View@pg-meta/meta       <span style=color:#8f5902;font-style:italic># 用默认的只读用户走实例域名连上去</span>
</span></span></code></pre></div><hr><h2 id=服务概述>服务概述</h2><p>在真实世界生产环境中，我们会使用基于复制的主从数据库集群。集群中有且仅有一个实例作为领导者（<a href=/docs/pgsql/config/cluster#%E8%AF%BB%E5%86%99%E4%B8%BB%E5%BA%93>主库</a>）可以接受写入。
而其他实例（<a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>从库</a>）则会从持续从集群领导者获取变更日志，与领导者保持一致。同时，从库还可以承载只读请求，在读多写少的场景下可以显著分担主库的负担，
因此对集群的写入请求与只读请求进行区分，是一种十分常见的实践。</p><p>此外对于高频短连接的生产环境，我们还会通过连接池中间件（Pgbouncer）对请求进行池化，减少连接与后端进程的创建开销。但对于ETL与变更执行等场景，我们又需要绕过连接池，直接访问数据库。
同时，高可用集群在故障时会出现故障切换（Failover），故障切换会导致集群的领导者出现变更。因此高可用的数据库方案要求写入流量可以自动适配集群的领导者变化。
这些不同的访问需求（读写分离，池化与直连，故障切换自动适配）最终抽象出 <strong>服务</strong> （Service）的概念。</p><p>通常来说，数据库集群都必须提供这种最基础的服务：</p><ul><li><strong>读写服务（primary）</strong> ：可以读写数据库</li></ul><p>对于生产数据库集群，至少应当提供这两种服务：</p><ul><li><strong>读写服务（primary）</strong> ：写入数据：只能由主库所承载。</li><li><strong>只读服务（replica）</strong> ：读取数据：可以由从库承载，没有从库时也可由主库承载</li></ul><p>此外，根据具体的业务场景，可能还会有其他的服务，例如：</p><ul><li><strong>默认直连服务（default）</strong> ：允许（管理）用户，绕过连接池直接访问数据库的服务</li><li><strong>离线从库服务（offline）</strong> ：不承接线上只读流量的专用从库，用于ETL与分析查询</li><li><strong>同步从库服务（standby）</strong> ：没有复制延迟的只读服务，由 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a>/主库处理只读查询</li><li><strong>延迟从库服务（delayed）</strong> ：访问同一个集群在一段时间之前的旧数据，由 <a href=/docs/pgsql/config/cluster#%E5%BB%B6%E8%BF%9F%E9%9B%86%E7%BE%A4>延迟从库</a> 来处理</li></ul><hr><h2 id=默认服务>默认服务</h2><p>Pigsty默认为每个 PostgreSQL 数据库集群提供四种不同的服务，以下是默认服务及其定义：</p><table class=full-width><thead><tr><th>服务</th><th>端口</th><th>描述</th></tr></thead><tbody><tr><td><a href=#primary%E6%9C%8D%E5%8A%A1>primary</a></td><td>5433</td><td>生产读写，连接到主库连接池（6432）</td></tr><tr><td><a href=#replica%E6%9C%8D%E5%8A%A1>replica</a></td><td>5434</td><td>生产只读，连接到备库连接池（6432）</td></tr><tr><td><a href=#default%E6%9C%8D%E5%8A%A1>default</a></td><td>5436</td><td>管理，ETL写入，直接访问主库（5432）</td></tr><tr><td><a href=#offline%E6%9C%8D%E5%8A%A1>offline</a></td><td>5438</td><td>OLAP、ETL、个人用户、交互式查询</td></tr></tbody></table><p>以默认的 <code>pg-meta</code> 集群为例，它提供四种默认服务：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5433/meta   <span style=color:#8f5902;font-style:italic># pg-meta-primary : 通过主要的 pgbouncer(6432) 进行生产读写</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_meta:DBUser.Meta@pg-meta:5434/meta   <span style=color:#8f5902;font-style:italic># pg-meta-replica : 通过备份的 pgbouncer(6432) 进行生产只读</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@pg-meta:5436/meta     <span style=color:#8f5902;font-style:italic># pg-meta-default : 通过主要的 postgres(5432) 直接连接</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_stats:DBUser.Stats@pg-meta:5438/meta <span style=color:#8f5902;font-style:italic># pg-meta-offline : 通过离线的 postgres(5432) 直接连接</span>
</span></span></code></pre></div><p>从示例集群 <a href=/docs/concept/arch/pgsql>架构图</a> 上可以看出这四种服务的工作方式：</p><p><a href=/docs/concept/ha><img src=/img/pigsty/ha.png alt=pigsty-ha.png></a></p><p>注意在这里<code>pg-meta</code> 域名指向了集群的 L2 VIP，进而指向集群主库上的 haproxy 负载均衡器，它负责将流量路由到不同的实例上，详见 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>服务接入</a></p><hr><h2 id=服务实现>服务实现</h2><p>在 Pigsty 中，服务使用 <a href=/docs/node>节点</a> 上的 <a href=/docs/node/param#haproxy>haproxy</a> 来实现，通过主机节点上的不同端口进行区分。</p><p>Pigsty 所纳管的每个节点上都默认启用了 Haproxy 以对外暴露服务，而数据库节点也不例外。
集群中的节点尽管从数据库的视角来看有主从之分，但从服务的视角来看，每个节点都是相同的：
这意味着即使您访问的是从库节点，只要使用正确的服务端口，就依然可以使用到主库读写的服务。
这样的设计可以屏蔽复杂度：所以您只要可以访问 PostgreSQL 集群上的任意一个实例，就可以完整的访问到所有服务。</p><p>这样的设计类似于 Kubernetes 中的 NodePort 服务，同样在 Pigsty 中，每一个服务都包括以下两个核心要素：</p><ol><li>通过 NodePort 暴露的访问端点（端口号，从哪访问？）</li><li>通过 Selectors 选择的目标实例（实例列表，谁来承载？）</li></ol><p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器，请参考 <a href=#%E6%8E%A5%E5%85%A5%E6%9C%8D%E5%8A%A1>接入服务</a>。</p><p>所有的服务都通过配置文件进行声明，例如，PostgreSQL 默认服务就是由 <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> 参数所定义的：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: default ,port: 5436 ,dest: postgres ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>您也可以在 <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a> 中定义额外的服务，参数 <code>pg_default_services</code> 与 <code>pg_services</code> 都是由 <a href=#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1>服务定义</a> 对象组成的数组。</p><hr><h2 id=定义服务>定义服务</h2><p>Pigsty 允许您定义自己的服务：</p><ul><li><a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a>：所有 PostgreSQL 集群统一对外暴露的服务，默认有四个。</li><li><a href=/docs/pgsql/param#pg_services><code>pg_services</code></a>：额外的 PostgreSQL 服务，可以视需求在全局或集群级别定义。</li><li><a href=/docs/node/param#haproxy_services><code>haproxy_servies</code></a>：直接定制 HAProxy 服务内容，可以用于其他组件的接入</li></ul><p>对于 PostgreSQL 集群来说，通常只需要关注前两者即可。
每一条服务定义都会在所有相关 HAProxy 实例的配置目录下生成一个新的配置文件：<a href=https://github.com/pgsty/pigsty/blob/main/roles/pgsql/templates/service.j2><code>/etc/haproxy/&lt;svcname>.cfg</code></a>
下面是一个自定义的服务样例 <code>standby</code>：当您想要对外提供没有复制延迟的只读服务时，就可以在 <a href=/docs/pgsql/param#pg_services><code>pg_services</code></a> 新增这条记录：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>standby                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，服务名称，最终的 svc 名称会使用 `pg_cluster` 作为前缀，例如：pg-meta-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5435</span><span style=color:#f8f8f8>                      </span><span style=color:#8f5902;font-style:italic># 必选，暴露的服务端口（作为 kubernetes 服务节点端口模式）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>ip</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;*&#34;</span><span style=color:#f8f8f8>                         </span><span style=color:#8f5902;font-style:italic># 可选，服务绑定的 IP 地址，默认情况下为所有 IP 地址</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8>                  </span><span style=color:#8f5902;font-style:italic># 必选，服务成员选择器，使用 JMESPath 来筛选配置清单</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary`]&#34;</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 可选，服务成员选择器（备份），也就是当默认选择器选中的实例都宕机后，服务才会由这里选中的实例成员来承载</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>dest</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>default                  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，目标端口，default|postgres|pgbouncer|&lt;port_number&gt;，默认为 &#39;default&#39;，Default的意思就是使用 pg_default_service_dest 的取值来最终决定</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>check</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>/sync                   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，健康检查 URL 路径，默认为 /，这里使用 Patroni API：/sync ，只有同步备库和主库才会返回 200 健康状态码 </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>maxconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>5000</span><span style=color:#f8f8f8>                   </span><span style=color:#8f5902;font-style:italic># 可选，允许的前端连接最大数，默认为5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>balance</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>roundrobin            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，haproxy 负载均衡算法（默认为 roundrobin，其他选项：leastconn）</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>options</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&#39;</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>而上面的服务定义，在样例的三节点 <code>pg-test</code> 上将会被转换为 haproxy 配置文件 <code>/etc/haproxy/pg-test-standby.conf</code>：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service: pg-test-standby @ 10.10.10.11:5435</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#---------------------------------------------------------------------</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service instances 10.10.10.11, 10.10.10.13, 10.10.10.12</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># service backups   10.10.10.11</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#000>listen pg-test-standby</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5435           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 绑定了所有IP地址上的 5435 端口</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp              </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 负载均衡器工作在 TCP 协议上</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 最大连接数为 5000，可按需调大</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin    </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 负载均衡算法为 rr 轮询，还可以使用 leastconn </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 启用 HTTP 健康检查</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- 保持HTTP连接</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /sync  </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- 这里使用 /sync ，Patroni 健康检查 API ，只有同步备库和主库才会返回 200 健康状态码。 </span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;---- 健康检查返回代码 200 代表正常</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers： # pg-test 集群全部三个实例都被 selector: &#34;[]&#34; 给圈中了，因为没有任何的筛选条件，所以都会作为 pg-test-replica 服务的后端服务器。但是因为还有 /sync 健康检查，所以只有主库和同步备库才能真正承载请求。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;----- 唯独主库满足条件 pg_role == `primary`， 被 backup selector 选中。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#        因此作为服务的兜底实例：平时不承载请求，其他从库全部宕机后，才会承载只读请求，从而最大避免了读写服务受到只读服务的影响</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic>#        </span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>在这里，<code>pg-test</code> 集群全部三个实例都被 <code>selector: "[]"</code> 给圈中了，渲染进入 <code>pg-test-replica</code> 服务的后端服务器列表中。但是因为还有 <code>/sync</code> 健康检查，Patroni Rest API只有在主库和 <a href=/docs/pgsql/config/cluster#%E5%90%8C%E6%AD%A5%E5%A4%87%E5%BA%93>同步备库</a> 上才会返回代表健康的 HTTP 200 状态码，因此只有主库和同步备库才能真正承载请求。
此外，主库因为满足条件 <code>pg_role == primary</code>， 被 backup selector 选中，被标记为了备份服务器，只有当没有其他实例（也就是同步备库）可以满足需求时，才会顶上。</p><hr><h2 id=primary服务>Primary服务</h2><p>Primary服务可能是生产环境中最关键的服务，它在 5433 端口提供对数据库集群的读写能力，服务定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>选择器参数 <code>selector: "[]"</code> 意味着所有集群成员都将被包括在Primary服务中</li><li>但只有主库能够通过健康检查（<code>check: /primary</code>），实际承载Primary服务的流量。</li><li>目的地参数 <code>dest: default</code> 意味着Primary服务的目的地受到 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 参数的影响</li><li><code>dest</code> 默认值 <code>default</code> 会被替换为 <code>pg_default_service_dest</code> 的值，默认为 <code>pgbouncer</code>。</li><li>默认情况下 Primary 服务的目的地默认是主库上的连接池，也就是由 <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a> 指定的端口，默认为 6432</li></ul><p>如果 <code>pg_default_service_dest</code> 的值为 <code>postgres</code>，那么 primary 服务的目的地就会绕过连接池，直接使用 PostgreSQL 数据库的端口（<a href=/docs/pgsql/param#pg_port><code>pg_port</code></a>，默认值 5432），对于一些不希望使用连接池的场景，这个参数非常实用。</p><details><summary>示例：pg-test-primary 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>listen pg-test-primary</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>bind *:5433        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary 服务默认使用 5433 端口</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>mode tcp</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>maxconn 5000</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>balance roundrobin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option httpchk</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>option http-keep-alive</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check send meth OPTIONS uri /primary</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># &lt;--- primary 服务默认使用 Patroni RestAPI /primary 健康检查</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>http-check expect status 200</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># servers</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><p>Patroni 的 <a href=/docs/concept/ha>高可用</a> 机制确保任何时候最多只会有一个实例的 <code>/primary</code> 健康检查为真，因此Primary服务将始终将流量路由到主实例。</p><p>使用 Primary 服务而不是直连数据库的一个好处是，如果集群因为某种情况出现了双主（比如在没有watchdog的情况下kill -9杀死主库 Patroni），Haproxy在这种情况下仍然可以避免脑裂，因为它只会在 Patroni 存活且返回主库状态时才会分发流量。</p><hr><h2 id=replica服务>Replica服务</h2><p>Replica服务在生产环境中的重要性仅次于Primary服务，它在 5434 端口提供对数据库集群的只读能力，服务定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replica ,port: 5434 ,dest: default  ,check: /read-only ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `primary` || pg_role == `offline` ]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>选择器参数 <code>selector: "[]"</code> 意味着所有集群成员都将被包括在Replica服务中</li><li>所有实例都能够通过健康检查（<code>check: /read-only</code>），承载Replica服务的流量。</li><li>备份选择器：<code>[? pg_role == 'primary' || pg_role == 'offline' ]</code> 将主库和 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a> 标注为备份服务器。</li><li>只有当所有 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>普通从库</a> 都宕机后，Replica服务才会由主库或离线从库来承载。</li><li>目的地参数 <code>dest: default</code> 意味着Replica服务的目的地也受到 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 参数的影响</li><li><code>dest</code> 默认值 <code>default</code> 会被替换为 <code>pg_default_service_dest</code> 的值，默认为 <code>pgbouncer</code>，这一点和 <a href=#primary%E6%9C%8D%E5%8A%A1>Primary服务</a> 相同</li><li>默认情况下 Replica 服务的目的地默认是从库上的连接池，也就是由 <a href=/docs/pgsql/param#pgbouncer_port><code>pgbouncer_port</code></a> 指定的端口，默认为 6432</li></ul><details><summary>示例：pg-test-replica 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5434</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /read-only</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:6432 check port 8008 weight 100 backup</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:6432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:6432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><p>Replica服务非常灵活：如果有存活的专用 Replica 实例，那么它会优先使用这些实例来承载只读请求，只有当从库实例全部宕机后，才会由主库来兜底只读请求。对于常见的一主一从双节点集群就是：只要从库活着就用从库，从库挂了再用主库。</p><p>此外，除非专用只读实例全部宕机，Replica 服务也不会使用专用 Offline 实例，这样就避免了在线快查询与离线慢查询混在一起，相互影响。</p><hr><h3 id=default服务>Default服务</h3><p>Default服务在 5436 端口上提供服务，它是Primary服务的变体。</p><p>Default服务总是绕过连接池直接连到主库上的 PostgreSQL，这对于管理连接、ETL写入、CDC数据变更捕获等都很有用。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 5433 ,dest: default  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果 <code>pg_default_service_dest</code> 被修改为 <code>postgres</code>，那么可以说 Default 服务除了端口和名称内容之外，与 Primary 服务是完全等价的。在这种情况下，您可以考虑将 Default 从默认服务中剔除。</p><details><summary>示例：pg-test-default 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-default</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5436         # &lt;--- 除了监听端口/目标端口和服务名，其他配置和 primary 服务一模一样</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /primary</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-1 10.10.10.11:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100</span>
</span></span></code></pre></div></details><hr><h3 id=offline服务>Offline服务</h3><p>Default服务在 5438 端口上提供服务，它也绕开连接池直接访问 PostgreSQL 数据库，通常用于慢查询/分析查询/ETL读取/个人用户交互式查询，其服务定义如下：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: offline ,port: 5438 ,dest: postgres ,check: /replica   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `offline` || pg_offline_query ]&#34;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>, backup</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[? pg_role == `replica` &amp;&amp; !pg_offline_query]&#34;</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>Offline服务将流量直接路由到专用的 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线从库</a> 上，或者带有 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> 标记的普通 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读实例</a>。</p><ul><li>选择器参数从集群中筛选出了两种实例：<a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code> 的离线从库，或是带有 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code> 标记的普通 <a href=/docs/pgsql/config/cluster#%E5%8F%AA%E8%AF%BB%E4%BB%8E%E5%BA%93>只读实例</a></li><li>专用离线从库和打标记的普通从库主要的区别在于：前者默认不承载 <a href=#replica%E6%9C%8D%E5%8A%A1>Replica服务</a> 的请求，避免快慢请求混在一起，而后者默认会承载。</li><li>备份选择器参数从集群中筛选出了一种实例：不带 offline 标记的普通从库，这意味着如果离线实例或者带Offline标记的普通从库挂了之后，其他普通的从库可以用来承载Offline服务。</li><li>健康检查 <code>/replica</code> 只会针对从库返回 200， 主库会返回错误，因此 Offline服务 永远不会将流量分发到主库实例上去，哪怕集群中只剩这一台主库。</li><li>同时，主库实例既不会被选择器圈中，也不会被备份选择器圈中，因此它永远不会承载Offline服务。因此 Offline 服务总是可以避免用户访问主库，从而避免对主库的影响。</li></ul><details><summary>示例：pg-test-offline 的 haproxy 配置</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#c4a000>listen pg-test-offline</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>bind *:5438</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>mode tcp</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>maxconn 5000</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>balance roundrobin</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option httpchk</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>option http-keep-alive</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check send meth OPTIONS uri /replica</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>http-check expect status 200</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic># servers</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-3 10.10.10.13:5432 check port 8008 weight 100</span>
</span></span><span style=display:flex><span>    <span style=color:#c4a000>server pg-test-2 10.10.10.12:5432 check port 8008 weight 100 backup</span>
</span></span></code></pre></div></details><p>Offline服务提供受限的只读服务，通常用于两类查询：交互式查询（个人用户），慢查询长事务（分析/ETL）。</p><p>Offline 服务需要额外的维护照顾：当集群发生主从切换或故障自动切换时，集群的实例角色会发生变化，而 Haproxy 的配置却不会自动发生变化。对于有多个从库的集群来说，这通常并不是一个问题。
然而对于一主一从，从库跑Offline查询的精简小集群而言，主从切换意味着从库变成了主库（健康检查失效），原来的主库变成了从库（不在 Offline 后端列表中），于是没有实例可以承载 Offline 服务了，因此需要手动 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a> 以使变更生效。</p><p>如果您的业务模型较为简单，您可以考虑剔除 Default 服务与 Offline 服务，使用 Primary 服务与 Replica 服务直连数据库。</p><hr><h2 id=重载服务>重载服务</h2><p>当集群成员发生变化，如添加/删除副本、主备切换或调整相对权重时， 你需要 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1>重载服务</a> 以使更改生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-svc &lt;cls&gt; <span style=color:#ce5c00;font-weight:700>[</span>ip...<span style=color:#ce5c00;font-weight:700>]</span>         <span style=color:#8f5902;font-style:italic># 为 lb 集群或 lb 实例重载服务</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ./pgsql.yml -t pg_service         # 重载服务的实际 ansible 任务</span>
</span></span></code></pre></div><hr><h2 id=接入服务>接入服务</h2><p>Pigsty的服务交付边界止步于集群的HAProxy，用户可以用各种手段访问这些负载均衡器。</p><p>典型的做法是使用 DNS 或 VIP 接入，将其绑定在集群所有或任意数量的负载均衡器上。</p><p><img src=/img/pigsty/access.jpg alt=pigsty-access.jpg></p><p>你可以使用不同的 主机 & 端口 组合，它们以不同的方式提供 PostgreSQL 服务。</p><p><strong>主机</strong></p><table class=full-width><thead><tr><th>类型</th><th>样例</th><th>描述</th></tr></thead><tbody><tr><td>集群域名</td><td><code>pg-test</code></td><td>通过集群域名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>集群 VIP 地址</td><td><code>10.10.10.3</code></td><td>通过由 <code>vip-manager</code> 管理的 L2 VIP 地址访问，绑定到主节点</td></tr><tr><td>实例主机名</td><td><code>pg-test-1</code></td><td>通过任何实例主机名访问（由 dnsmasq @ infra 节点解析）</td></tr><tr><td>实例 IP 地址</td><td><code>10.10.10.11</code></td><td>访问任何实例的 IP 地址</td></tr></tbody></table><p><strong>端口</strong></p><p>Pigsty 使用不同的 <strong>端口</strong> 来区分 <a href=#%E6%9C%8D%E5%8A%A1%E6%A6%82%E8%BF%B0>pg services</a></p><table class=full-width><thead><tr><th>端口</th><th>服务</th><th>类型</th><th>描述</th></tr></thead><tbody><tr><td>5432</td><td>postgres</td><td>数据库</td><td>直接访问 postgres 服务器</td></tr><tr><td>6432</td><td>pgbouncer</td><td>中间件</td><td>访问 postgres 前先通过连接池中间件</td></tr><tr><td>5433</td><td>primary</td><td>服务</td><td>访问主 pgbouncer (或 postgres)</td></tr><tr><td>5434</td><td>replica</td><td>服务</td><td>访问备份 pgbouncer (或 postgres)</td></tr><tr><td>5436</td><td>default</td><td>服务</td><td>访问主 postgres</td></tr><tr><td>5438</td><td>offline</td><td>服务</td><td>访问离线 postgres</td></tr></tbody></table><p><strong>组合</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群域名访问</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主直接连接</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@pg-test:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 通过集群 VIP 直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主直接访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:6432/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5433/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主连接池 -&gt; 主</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.3:5434/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 备份连接池 -&gt; 备份</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.3:5436/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 主直接连接 (用于管理员)</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.3::5438/test <span style=color:#8f5902;font-style:italic># L2 VIP -&gt; HAProxy -&gt; 离线直接连接 (用于 ETL/个人查询)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例名</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 数据库实例直接连接 (单例访问)</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:6432/test <span style=color:#8f5902;font-style:italic># DNS -&gt; 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5433/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@pg-test-1:5434/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@pg-test-1:5436/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@pg-test-1:5438/test <span style=color:#8f5902;font-style:italic># DNS -&gt; HAProxy -&gt; 数据库离线读/写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 直接指定任何集群实例 IP 访问</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5432/test <span style=color:#8f5902;font-style:italic># 数据库实例直接连接 (直接指定实例, 没有自动流量分配)</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432/test <span style=color:#8f5902;font-style:italic># 连接池 -&gt; 数据库</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5433/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库读/写</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:5434/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 连接池 -&gt; 数据库只读</span>
</span></span><span style=display:flex><span>postgres://dbuser_dba@10.10.10.11:5436/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库直接连接</span>
</span></span><span style=display:flex><span>postgres://dbuser_stats@10.10.10.11:5438/test <span style=color:#8f5902;font-style:italic># HAProxy -&gt; 数据库离线读-写</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># 智能客户端：自动进行读写分离</span>
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>primary
</span></span><span style=display:flex><span>postgres://test@10.10.10.11:6432,10.10.10.12:6432,10.10.10.13:6432/test?target_session_attrs<span style=color:#ce5c00;font-weight:700>=</span>prefer-standby
</span></span></code></pre></div><hr><h2 id=覆盖服务>覆盖服务</h2><p>你可以通过多种方式覆盖默认的服务配置，一种常见的需求是让 <a href=#primary%E6%9C%8D%E5%8A%A1>Primary服务</a> 与 <a href=#replica%E6%9C%8D%E5%8A%A1>Replica服务</a> 绕过Pgbouncer连接池，直接访问 PostgreSQL 数据库。</p><p>为了实现这一点，你可以将 <a href=/docs/pgsql/param#pg_default_service_dest><code>pg_default_service_dest</code></a> 更改为 <code>postgres</code>，这样所有服务定义中 <code>svc.dest='default'</code> 的服务都会使用 <code>postgres</code> 而不是默认的 <code>pgbouncer</code> 作为目标。</p><p>如果您已经将 <a href=#primary%E6%9C%8D%E5%8A%A1>Primary服务</a> 指向了 PostgreSQL，那么 <a href=#default%E6%9C%8D%E5%8A%A1>default服务</a> 就会比较多余，可以考虑移除。</p><p>如果您不需要区分个人交互式查询，分析/ETL慢查询，可以考虑从默认服务列表 <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> 中移除 <a href=#offline%E6%9C%8D%E5%8A%A1>Offline服务</a>。</p><p>如果您不需要只读从库来分担在线只读流量，也可以从默认服务列表中移除 <a href=#replica%E6%9C%8D%E5%8A%A1>Replica服务</a>。</p><hr><h2 id=委托服务>委托服务</h2><p>Pigsty 通过节点上的 haproxy 暴露 PostgreSQL 服务。整个集群中的所有 haproxy 实例都使用相同的 <a href=#%E5%AE%9A%E4%B9%89%E6%9C%8D%E5%8A%A1>服务定义</a> 进行配置。</p><p>但是，你可以将 pg 服务委托给特定的节点分组（例如，专门的 haproxy 负载均衡器集群），而不是 PostgreSQL 集群成员上的 haproxy。</p><p>为此，你需要使用 <a href=/docs/pgsql/param#pg_default_services><code>pg_default_services</code></a> 覆盖默认的服务定义，并将 <a href=/docs/pgsql/param#pg_service_provider><code>pg_service_provider</code></a> 设置为代理组名称。</p><p>例如，此配置将在端口 10013 的 <code>proxy</code> haproxy 节点组上公开 pg 集群的主服务。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_service_provider</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>proxy      </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 使用端口 10013 上的 `proxy` 组的负载均衡器</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_services</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>  </span><span style=color:#000;font-weight:700>[</span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: primary ,port: 10013 ,dest: postgres  ,check: /primary   ,selector</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;[]&#34;</span><span style=color:#f8f8f8> </span>}<span style=color:#000;font-weight:700>]</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>用户需要确保每个委托服务的端口，在代理集群中都是<strong>唯一</strong>的。</p><p>在 43 节点生产环境仿真 <a href=/docs/deploy/sandbox><strong>沙箱</strong></a> 中提供了一个使用专用负载均衡器集群的例子：<a href=https://github.com/Vonng/pigsty/blob/main/conf/prod.yml#L111>prod.yml</a></p></div><div class=td-content style=page-break-before:always><h1 id=pg-ba271faa49ebb08213e3b4f058522cdb>4 - 认证 / HBA</h1><div class=lead>Pigsty 中基于主机的身份认证 HBA（Host-Based Authentication）详解。</div><blockquote><p>Pigsty 中基于主机的身份认证 HBA（Host-Based Authentication）详解。</p></blockquote><p>认证是 <a href=/docs/concept/sec/ac/>访问控制</a> 与 <a href=/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E6%9D%83%E9%99%90%E7%AD%96%E7%95%A5>权限系统</a> 的基石，PostgreSQL 拥有多种 <a href=https://www.postgresql.org/docs/current/client-authentication.html>认证</a> 方法。</p><p>这里主要介绍 HBA：Host Based Authentication，HBA规则定义了哪些用户能够通过哪些方式从哪些地方访问哪些数据库。</p><hr><h2 id=客户端认证>客户端认证</h2><p>要连接到PostgreSQL数据库，用户必须先经过认证（默认使用密码）。</p><p>您可以在连接字符串中提供密码（不安全）或使用<code>PGPASSWORD</code>环境变量或<code>.pgpass</code>文件传递密码。参考 <a href=https://www.postgresql.org/docs/current/app-psql.html#usage><code>psql</code></a> 文档和 <a href=https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING>PostgreSQL连接字符串</a> 以获取更多详细信息。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;host=&lt;host&gt; port=&lt;port&gt; dbname=&lt;dbname&gt; user=&lt;username&gt; password=&lt;password&gt;&#39;</span>
</span></span><span style=display:flex><span>psql postgres://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;:&lt;port&gt;/&lt;dbname&gt;
</span></span><span style=display:flex><span><span style=color:#000>PGPASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>&lt;password&gt;<span style=color:#000;font-weight:700>;</span> psql -U &lt;username&gt; -h &lt;host&gt; -p &lt;port&gt; -d &lt;dbname&gt;
</span></span></code></pre></div><p>例如，连接 Pigsty 默认的 <code>meta</code> 数据库，可以使用以下连接串：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;host=10.10.10.10 port=5432 dbname=meta user=dbuser_dba password=DBUser.DBA&#39;</span>
</span></span><span style=display:flex><span>psql postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta
</span></span><span style=display:flex><span><span style=color:#000>PGPASSWORD</span><span style=color:#ce5c00;font-weight:700>=</span>DBUser.DBA<span style=color:#000;font-weight:700>;</span> psql -U dbuser_dba -h 10.10.10.10 -p <span style=color:#0000cf;font-weight:700>5432</span> -d meta
</span></span></code></pre></div><p>默认配置下，Pigsty会启用服务端 SSL 加密，但不验证客户端 SSL 证书。要使用客户端SSL证书连接，你可以使用<code>PGSSLCERT</code>和<code>PGSSLKEY</code>环境变量或<code>sslkey</code>和<code>sslcert</code>参数提供客户端参数。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>psql <span style=color:#4e9a06>&#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta?sslkey=/path/to/dbuser_dba.key&amp;sslcert=/path/to/dbuser_dba.crt&#39;</span>
</span></span></code></pre></div><p>客户端证书（<code>CN</code> = 用户名）可以使用本地CA与 <a href=https://github.com/Vonng/pigsty/blob/main/cert.yml><code>cert.yml</code></a> 剧本签发。</p><hr><h2 id=定义hba>定义HBA</h2><p>在Pigsty中，有四个与HBA规则有关的参数：</p><ul><li><a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a>：postgres HBA规则</li><li><a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a>：postgres 全局默认HBA规则</li><li><a href=/docs/pgsql/param#pgb_hba_rules><code>pgb_hba_rules</code></a>：pgbouncer HBA规则</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a>：pgbouncer 全局默认HBA规则</li></ul><p>这些都是 HBA 规则对象的数组，每个HBA规则都是以下两种形式之一的对象：</p><h3 id=1-原始形式>1. 原始形式</h3><p>原始形式的 HBA 与 PostgreSQL <code>pg_hba.conf</code> 的格式几乎完全相同：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>common</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  10.0.0.0/8      md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  172.16.0.0/12   md5</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span>- <span style=color:#000>host   all  all  192.168.0.0/16  md5</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>在这种形式中，<code>rules</code> 字段是字符串数组，每一行都是条原始形式的 <a href=https://www.postgresql.org/docs/current/auth-pg-hba-conf.html>HBA规则</a>。<code>title</code> 字段会被渲染为一条注释，解释下面规则的作用。</p><p><code>role</code> 字段用于说明该规则适用于哪些实例角色，当实例的 <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> 与<code>role</code>相同时，HBA规则将被添加到这台实例的 HBA 中。</p><ul><li><code>role: common</code>的HBA规则将被添加到所有实例上。</li><li><code>role: primary</code> 的 HBA 规则只会添加到主库实例上。</li><li><code>role: replica</code> 的 HBA 规则只会添加到从库实例上。</li><li><code>role: offline</code>的HBA规则将被添加到离线实例上（ <a href=/docs/pgsql/param#pg_role><code>pg_role</code></a> = <code>offline</code>或 <a href=/docs/pgsql/param#pg_offline_query><code>pg_offline_query</code></a> = <code>true</code>）</li></ul><h3 id=2-别名形式>2. 别名形式</h3><p>别名形式允许您用更简单清晰便捷的方式维护 HBA 规则：它用<code>addr</code>、<code>auth</code>、<code>user</code>和<code>db</code> 字段替换了 <code>rules</code>。 <code>title</code>、<code>role</code> 和 <code>order</code> 字段则仍然生效。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;intra&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># world|intra|infra|admin|local|localhost|cluster|&lt;cidr&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>auth</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;pwd&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># trust|pwd|ssl|cert|deny|&lt;official auth method&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>      </span><span style=color:#8f5902;font-style:italic># all|${dbsu}|${repl}|${admin}|${monitor}|&lt;user&gt;|&lt;group&gt;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>db</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;all&#39;</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># all|replication|....</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[]</span><span style=color:#f8f8f8>        </span><span style=color:#8f5902;font-style:italic># raw hba string precedence over above all</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>allow intranet password access</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8>       </span><span style=color:#8f5902;font-style:italic># 排序权重，数字小的排前面（可选，默认追加到最后）</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li><code>addr</code>: <strong>where</strong> 哪些IP地址段受本条规则影响？<ul><li><code>world</code>: 所有的IP地址</li><li><code>intra</code>: 所有的内网IP地址段： <code>'10.0.0.0/8', '172.16.0.0/12', '192.168.0.0/16'</code></li><li><code>infra</code>: Infra节点的IP地址</li><li><code>admin</code>: <code>admin_ip</code> 管理节点的IP地址</li><li><code>local</code>: 本地 Unix Socket</li><li><code>localhost</code>: 本地 Unix Socket 以及TCP 127.0.0.1/32 环回地址</li><li><code>cluster</code>: 同一个 PostgresQL 集群所有成员的IP地址</li><li><code>&lt;cidr></code>: 一个特定的 CIDR 地址块或IP地址</li></ul></li><li><code>auth</code>: <strong>how</strong> 本条规则指定的认证方式？<ul><li><code>deny</code>: 拒绝访问</li><li><code>trust</code>: 直接信任，不需要认证</li><li><code>pwd</code>: 密码认证，根据 <a href=/docs/pgsql/param#pg_pwd_enc><code>pg_pwd_enc</code></a> 参数选用 <code>md5</code> 或 <code>scram-sha-256</code> 认证</li><li><code>sha</code>/<code>scram-sha-256</code>：强制使用 <code>scram-sha-256</code> 密码认证方式。</li><li><code>md5</code>: <code>md5</code> 密码认证方式，但也可以兼容 <code>scram-sha-256</code> 认证，不建议使用。</li><li><code>ssl</code>: 在密码认证 <code>pwd</code> 的基础上，强制要求启用SSL</li><li><code>ssl-md5</code>: 在密码认证 <code>md5</code> 的基础上，强制要求启用SSL</li><li><code>ssl-sha</code>: 在密码认证 <code>sha</code> 的基础上，强制要求启用SSL</li><li><code>os</code>/<code>ident</code>: 使用操作系统用户的身份进行 <code>ident</code> 认证</li><li><code>peer</code>: 使用 <code>peer</code> 认证方式，类似于 <code>os ident</code></li><li><code>cert</code>: 使用基于客户端SSL证书的认证方式，证书CN为用户名</li></ul></li><li><code>user</code>: <strong>who</strong>：哪些用户受本条规则影响？<ul><li><code>all</code>: 所有用户</li><li><code>${dbsu}</code>: 默认数据库超级用户 <a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a></li><li><code>${repl}</code>: 默认数据库复制用户 <a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a></li><li><code>${admin}</code>: 默认数据库管理用户 <a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a></li><li><code>${monitor}</code>: 默认数据库监控用户 <a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a></li><li>其他特定的用户或者角色</li></ul></li><li><code>db</code>: <strong>which</strong>：哪些数据库受本条规则影响？<ul><li><code>all</code>: 所有数据库</li><li><code>replication</code>: 允许建立复制连接（不指定特定数据库）</li><li>某个特定的数据库</li></ul></li></ul><h3 id=3-定义位置>3. 定义位置</h3><p>通常，全局的HBA定义在 <code>all.vars</code> 中，如果您想要修改全局默认的HBA规则，可以从 <a href=https://github.com/Vonng/pigsty/blob/main/conf/full.yml#L690><code>full.yml</code></a> 模板中复制一份到 <code>all.vars</code> 中进行修改。</p><ul><li><a href=/docs/pgsql/param#pg_default_hba_rules><code>pg_default_hba_rules</code></a>：postgres 全局默认HBA规则</li><li><a href=/docs/pgsql/param#pgb_default_hba_rules><code>pgb_default_hba_rules</code></a>：pgbouncer 全局默认HBA规则</li></ul><p>而集群特定的 HBA 规则定义在数据库的集群级配置中：</p><ul><li><a href=/docs/pgsql/param#pg_hba_rules><code>pg_hba_rules</code></a>：postgres HBA规则</li><li><a href=/docs/pgsql/param#pgb_hba_rules><code>pgb_hba_rules</code></a>：pgbouncer HBA规则</li></ul><p>下面是一些集群HBA规则的定义例子：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-meta</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>10.10.10.10</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary } }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-meta</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: dbuser_view ,db: all    ,addr: infra        ,auth: pwd  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;允许 dbuser_view 从基础设施节点密码访问所有库&#39;</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user: all         ,db: all    ,addr: 100.0.0.0/8  ,auth: pwd  ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;允许所有用户从K8S网段密码访问所有库&#39;</span><span style=color:#f8f8f8>          </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>,db: world  ,addr: 0.0.0.0/0    ,auth: cert ,title</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;允许管理员用户从任何地方用客户端证书登陆&#39;</span><span style=color:#f8f8f8>       </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=重载hba>重载HBA</h2><p>HBA 是一个静态的规则配置文件，修改后需要重载才能生效。默认的 HBA 规则集合因为不涉及 Role 与集群成员，所以通常不需要重载。</p><p>如果您设计的 HBA 使用了特定的实例角色限制，或者集群成员限制，那么当集群实例成员发生变化（新增/下线/主从切换），一部分HBA规则的生效条件/涉及范围发生变化，通常也需要 <a href=/docs/pgsql/admin/cluster#%E5%88%B7%E6%96%B0hba>重载HBA</a> 以反映最新变化。</p><p>要重新加载 postgres/pgbouncer 的 hba 规则：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt;                 <span style=color:#8f5902;font-style:italic># 重新加载集群 `&lt;cls&gt;` 的 hba 规则</span>
</span></span><span style=display:flex><span>bin/pgsql-hba &lt;cls&gt; ip1 ip2...      <span style=color:#8f5902;font-style:italic># 重新加载特定实例的 hba 规则</span>
</span></span></code></pre></div><p>底层实际执行的 Ansible 剧本命令为：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -t pg_hba,pg_reload
</span></span><span style=display:flex><span>./pgsql.yml -l &lt;cls&gt; -e <span style=color:#000>pg_reload</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#204a87>true</span> -t pgbouncer_hba,pgbouncer_reload
</span></span></code></pre></div><hr><h2 id=默认hba>默认HBA</h2><p>Pigsty 有一套默认的 HBA 规则，对于绝大多数场景来说，它已经足够安全了。这些规则使用别名形式，因此基本可以自我解释。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres 全局默认的HBA规则，按 order 排序</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: pwd   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: pwd   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: pwd   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: pwd   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: ssl   ,title: &#39;admin @ everywhere with ssl &amp; pwd&#39;    ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: pwd   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: pwd   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer 全局默认的HBA规则，按 order 排序</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: pwd   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: pwd   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><blockquote><p><strong>注意</strong>：<code>order</code> 字段控制规则渲染顺序。<code>0-99</code> 用于高优先规则（如黑名单），<code>100-650</code> 为默认规则区间，<code>1000+</code> 用于追加规则。详见 <a href=/docs/pgsql/config/hba/>HBA 配置</a>。</p></blockquote><details><summary>示例：渲染 pg_hba.conf</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># File      :   pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Desc      :   Postgres HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Time      :   2023-01-11 15:19</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Path      :   /pg/data/pg_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># License   :   Apache-2.0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># addr alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local     : /var/run/postgresql</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># infra     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># user alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu    :  postgres</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># repl    :  replicator</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor :  dbuser_monitor</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin   :  dbuser_dba</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu access via local os user ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                postgres                              ident</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu replication from local os ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    replication        postgres                              ident</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator replication from localhost [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    replication        replicator                            scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator replication from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     replication        replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># replicator postgres db from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     postgres           replicator         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor from localhost with password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                dbuser_monitor                        scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor from infra host with password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     10.10.10.10/32     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin @ infra nodes with pwd &amp; ssl [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  all                dbuser_dba         10.10.10.10/32     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin @ everywhere with ssl &amp; pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>hostssl  all                dbuser_dba         0.0.0.0/0          scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># pgbouncer read/write via local socket [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                +dbrole_readonly                      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># read/write biz user via password [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_readonly   192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow etl offline tasks from intranet [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                +dbrole_offline    192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow application database intranet access [common] [DISABLED]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    kong            dbuser_kong         10.0.0.0/8          md5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    bytebase        dbuser_bytebase     10.0.0.0/8          md5</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#host    grafana         dbuser_grafana      10.0.0.0/8          md5</span>
</span></span></code></pre></div></details><details><summary>示例: 渲染 pgb_hba.conf</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># File      :   pgb_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Desc      :   Pgbouncer HBA Rules for pg-meta-1 [primary]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Time      :   2023-01-11 15:28</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Host      :   pg-meta-1 @ 10.10.10.10:5432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Path      :   /etc/pgbouncer/pgb_hba.conf</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Note      :   ANSIBLE MANAGED, DO NOT CHANGE!</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># Author    :   Ruohang Feng (rh@vonng.com)</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># License   :   Apache-2.0</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>#==============================================================#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># PGBOUNCER HBA RULES FOR pg-meta-1 @ 10.10.10.10:6432</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># ansible managed: 2023-01-11 14:30:58</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># addr alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># local     : /var/run/postgresql</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># infra     : 10.10.10.10</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># intra     : 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># user alias</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu    :  postgres</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># repl    :  replicator</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor :  dbuser_monitor</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin   :  dbuser_dba</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># dbsu local admin access with os ident [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    pgbouncer          postgres                              peer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow all user local access with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>local    all                all                                   scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                127.0.0.1/32       scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># monitor access via intranet with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     pgbouncer          dbuser_monitor     192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># reject all other monitor access addr [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_monitor     0.0.0.0/0          reject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># admin access via intranet with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         192.168.0.0/16     scram-sha-256</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># reject all other admin access addr [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                dbuser_dba         0.0.0.0/0          reject</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># allow all user intra access with pwd [default]</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                10.0.0.0/8         scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                172.16.0.0/12      scram-sha-256</span>
</span></span><span style=display:flex><span><span style=color:#c4a000>host     all                all                192.168.0.0/16     scram-sha-256</span>
</span></span></code></pre></div></details><hr><h2 id=安全加固>安全加固</h2><p>对于那些需要更高安全性的场合，我们提供了一个安全加固的配置模板 <a href=https://github.com/Vonng/pigsty/blob/main/conf/safe.yml>security.yml</a>，使用了以下的默认 HBA 规则集：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>             </span><span style=color:#8f5902;font-style:italic># postgres host-based auth rules by default, order by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: local     ,auth: ident ,title: &#39;dbsu access via local os user ident&#39;  ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: local     ,auth: ident ,title: &#39;dbsu replication from local os ident&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: localhost ,auth: ssl   ,title: &#39;replicator replication from localhost&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: replication ,addr: intra     ,auth: ssl   ,title: &#39;replicator replication from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${repl}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: postgres    ,addr: intra     ,auth: ssl   ,title: &#39;replicator postgres db from intranet&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;monitor from localhost with password&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;monitor from infra host with password&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: infra     ,auth: ssl   ,title: &#39;admin @ infra nodes with pwd &amp; ssl&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>450</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: cert  ,title: &#39;admin @ everywhere with ssl &amp; cert&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>500</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: localhost ,auth: ssl   ,title: &#39;pgbouncer read/write via local socket&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>550</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_readonly&#39;,db: all    ,addr: intra     ,auth: ssl   ,title: &#39;read/write biz user via password&#39;     ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>600</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;+dbrole_offline&#39; ,db: all    ,addr: intra     ,auth: ssl   ,title: &#39;allow etl offline tasks from intranet&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>650</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pgb_default_hba_rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>            </span><span style=color:#8f5902;font-style:italic># pgbouncer host-based authentication rules, order by `order`</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${dbsu}&#39;</span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: local     ,auth: peer  ,title: &#39;dbsu local admin access with os ident&#39;,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: localhost ,auth: pwd   ,title: &#39;allow all user local access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>150</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: pgbouncer   ,addr: intra     ,auth: ssl   ,title: &#39;monitor access via intranet with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>200</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${monitor}&#39;</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other monitor access addr&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>250</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: intra     ,auth: ssl   ,title: &#39;admin access via intranet with pwd&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>300</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;${admin}&#39;</span><span style=color:#f8f8f8>   </span><span style=color:#204a87;font-weight:700>,db: all         ,addr: world     ,auth: deny  ,title: &#39;reject all other admin access addr&#39;   ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>350</span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#204a87;font-weight:700>user: &#39;all&#39;        ,db: all         ,addr: intra     ,auth: ssl   ,title: &#39;allow all user intra access with pwd&#39; ,order</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>400</span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>更多信息，请参考 <a href=/docs/setup/security>安全加固</a> 一节。</p></div><div class=td-content style=page-break-before:always><h1 id=pg-0b7772f5fffba0123e7353706362f45e>5 - 访问控制</h1><div class=lead>Pigsty 提供的默认角色系统与权限模型</div><blockquote><p>Pigsty 提供了一套开箱即用的，基于 <a href=#%E8%A7%92%E8%89%B2%E7%B3%BB%E7%BB%9F>角色系统</a> 和 <a href=#%E6%9D%83%E9%99%90%E7%B3%BB%E7%BB%9F>权限系统</a> 的访问控制模型。</p></blockquote><p>权限控制很重要，但很多用户做不好。因此 Pigsty 提供了一套开箱即用的精简访问控制模型，为您的集群安全性提供一个兜底。</p><hr><h2 id=角色系统>角色系统</h2><p>Pigsty 默认的角色系统包含四个 <a href=#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2>默认角色</a> 和四个 <a href=#%E9%BB%98%E8%AE%A4%E7%94%A8%E6%88%B7>默认用户</a>：</p><table class=full-width><thead><tr><th>角色名称</th><th>属性</th><th>所属</th><th>描述</th></tr></thead><tbody><tr><td><code>dbrole_readonly</code></td><td><code>NOLOGIN</code></td><td></td><td>角色：全局只读访问</td></tr><tr><td><code>dbrole_readwrite</code></td><td><code>NOLOGIN</code></td><td>dbrole_readonly</td><td>角色：全局读写访问</td></tr><tr><td><code>dbrole_admin</code></td><td><code>NOLOGIN</code></td><td>pg_monitor,dbrole_readwrite</td><td>角色：管理员/对象创建</td></tr><tr><td><code>dbrole_offline</code></td><td><code>NOLOGIN</code></td><td></td><td>角色：受限的只读访问</td></tr><tr><td><code>postgres</code></td><td><code>SUPERUSER</code></td><td></td><td>系统超级用户</td></tr><tr><td><code>replicator</code></td><td><code>REPLICATION</code></td><td>pg_monitor,dbrole_readonly</td><td>系统复制用户</td></tr><tr><td><code>dbuser_dba</code></td><td><code>SUPERUSER</code></td><td>dbrole_admin</td><td>pgsql 管理用户</td></tr><tr><td><code>dbuser_monitor</code></td><td></td><td>pg_monitor</td><td>pgsql 监控用户</td></tr></tbody></table><p>这些 <a href=/docs/pgsql/config/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7>角色与用户</a> 的详细定义如下所示：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_default_roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>                 </span><span style=color:#8f5902;font-style:italic># 全局默认的角色与系统用户</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access     }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline   ,login: false ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite ,login: false ,roles: [dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin     ,login: false ,roles: [pg_monitor, dbrole_readwrite] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true  ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly] ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor ,roles: [pg_monitor] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=默认角色>默认角色</h2><p>Pigsty 中有四个默认角色：</p><ul><li>业务只读 (<code>dbrole_readonly</code>): 用于全局只读访问的角色。如果别的业务想要此库只读访问权限，可以使用此角色。</li><li>业务读写 (<code>dbrole_readwrite</code>): 用于全局读写访问的角色，主属业务使用的生产账号应当具有数据库读写权限</li><li>业务管理员 (<code>dbrole_admin</code>): 拥有DDL权限的角色，通常用于业务管理员，或者需要在应用中建表的场景（比如各种业务软件）</li><li>离线只读访问 (<code>dbrole_offline</code>): 受限的只读访问角色（只能访问 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>offline</a> 实例，通常是个人用户，ETL工具账号）</li></ul><p>默认角色在 <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> 中定义，除非您确实知道自己在干什么，建议不要更改默认角色的名称。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readonly  , login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-only access  }                           </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产环境的只读角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_offline ,   login: false , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for restricted read-only access (offline instance) }     </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 受限的只读角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_readwrite , login: false , roles: [dbrole_readonly], comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for global read-write access } </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产环境的读写角色</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbrole_admin , login: false , roles: [pg_monitor, dbrole_readwrite] , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>role for object creation }</span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 生产环境的 DDL 更改角色</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=默认用户>默认用户</h2><p>Pigsty 也有四个默认用户（系统用户）：</p><ul><li>超级用户 (<code>postgres</code>)，集群的所有者和创建者，与操作系统 dbsu 名称相同。</li><li>复制用户 (<code>replicator</code>)，用于主-从复制的系统用户。</li><li>监控用户 (<code>dbuser_monitor</code>)，用于监控数据库和连接池指标的用户。</li><li>管理用户 (<code>dbuser_dba</code>)，执行日常操作和数据库更改的管理员用户。</li></ul><p>这4个默认用户的用户名/密码通过4对专用参数进行定义，并在很多地方引用：</p><ul><li><a href=/docs/pgsql/param#pg_dbsu><code>pg_dbsu</code></a>：操作系统 dbsu 名称，默认为 postgres，最好不要更改它</li><li><a href=/docs/pgsql/param#pg_dbsu_password><code>pg_dbsu_password</code></a>：dbsu 密码，默认为空字符串意味着不设置 dbsu 密码，最好不要设置。</li><li><a href=/docs/pgsql/param#pg_replication_username><code>pg_replication_username</code></a>：postgres 复制用户名，默认为 <code>replicator</code></li><li><a href=/docs/pgsql/param#pg_replication_password><code>pg_replication_password</code></a>：postgres 复制密码，默认为 <code>DBUser.Replicator</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>pg_admin_username</code></a>：postgres 管理员用户名，默认为 <code>dbuser_dba</code></li><li><a href=/docs/pgsql/param#pg_admin_password><code>pg_admin_password</code></a>：postgres 管理员密码的明文，默认为 <code>DBUser.DBA</code></li><li><a href=/docs/pgsql/param#pg_monitor_username><code>pg_monitor_username</code></a>：postgres 监控用户名，默认为 <code>dbuser_monitor</code></li><li><a href=/docs/pgsql/param#pg_monitor_password><code>pg_monitor_password</code></a>：postgres 监控密码，默认为 <code>DBUser.Monitor</code></li></ul><blockquote><p><strong>在生产部署中记得更改这些密码，不要使用默认值！</strong></p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres                            </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 数据库超级用户名，这个用户名建议不要修改。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_dbsu_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#39;&#39;</span><span style=color:#f8f8f8>                          </span><span style=color:#8f5902;font-style:italic># 数据库超级用户密码，这个密码建议留空！禁止dbsu密码登陆。</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>replicator          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统复制用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_replication_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Replicator   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统复制密码，请务必修改此密码！</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统监控用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_monitor_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.Monitor          </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统监控密码，请务必修改此密码！</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_username</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>dbuser_dba                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统管理用户名</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg_admin_password</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>DBUser.DBA                </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 系统管理密码，请务必修改此密码！</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>如果您修改默认用户的参数，在 <a href=/docs/pgsql/param#pg_default_roles><code>pg_default_roles</code></a> 中修改相应的角色 <a href=/docs/pgsql/config/user#%E5%AE%9A%E4%B9%89%E7%94%A8%E6%88%B7>定义</a> 即可：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: postgres     ,superuser: true                                          ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system superuser }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: replicator ,replication: true  ,roles: [pg_monitor, dbrole_readonly]   ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>system replicator }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_dba   ,superuser: true  ,roles: [dbrole_admin]  ,pgbouncer: true ,pool_mode: session, pool_connlimit: 16 , comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql admin user }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_monitor   ,roles: [pg_monitor, dbrole_readonly] ,pgbouncer: true ,parameters</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#204a87;font-weight:700>log_min_duration_statement: 1000 } ,pool_mode: session ,pool_connlimit: 8 ,comment</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pgsql monitor user }</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><hr><h2 id=权限系统>权限系统</h2><p>Pigsty 拥有一套开箱即用的权限模型，该模型与 <a href=#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2>默认角色</a> 一起配合工作。</p><ul><li>所有用户都可以访问所有模式。</li><li>只读用户（<code>dbrole_readonly</code>）可以从所有表中读取数据。（SELECT，EXECUTE）</li><li>读写用户（<code>dbrole_readwrite</code>）可以向所有表中写入数据并运行 DML。（INSERT，UPDATE，DELETE）。</li><li>管理员用户（<code>dbrole_admin</code>）可以创建对象并运行 DDL（CREATE，USAGE，TRUNCATE，REFERENCES，TRIGGER）。</li><li>离线用户（<code>dbrole_offline</code>）类似只读用户，但访问受到限制，只允许访问 <a href=/docs/pgsql/config/cluster#%E7%A6%BB%E7%BA%BF%E4%BB%8E%E5%BA%93>离线实例</a>（<code>pg_role = 'offline'</code> 或 <code>pg_offline_query = true</code>）</li><li>由管理员用户创建的对象将具有正确的权限。</li><li>所有数据库上都配置了默认权限，包括模板数据库。</li><li>数据库连接权限由数据库 <a href=/docs/pgsql/config/db#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>定义</a> 管理。</li><li>默认撤销<code>PUBLIC</code>在数据库和<code>public</code>模式下的<code>CREATE</code>权限。</li></ul><hr><h2 id=对象权限>对象权限</h2><p>数据库中新建对象的默认权限由参数 <a href=/docs/pgsql/param#pg_default_privileges><code>pg_default_privileges</code></a> 所控制：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_readonly</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SCHEMAS   TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON TABLES    TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT SELECT     ON SEQUENCES TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT EXECUTE    ON FUNCTIONS TO dbrole_offline</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT INSERT     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT DELETE     ON TABLES    TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT USAGE      ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT UPDATE     ON SEQUENCES TO dbrole_readwrite</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRUNCATE   ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT REFERENCES ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT TRIGGER    ON TABLES    TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span>- <span style=color:#000>GRANT CREATE     ON SCHEMAS   TO dbrole_admin</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>由管理员<strong>新创建</strong>的对象，默认将会上述权限。使用 <code>\ddp+</code> 可以查看这些默认权限：</p><table class=full-width><thead><tr><th>类型</th><th>访问权限</th></tr></thead><tbody><tr><td>函数</td><td>=X</td></tr><tr><td></td><td>dbrole_readonly=X</td></tr><tr><td></td><td>dbrole_offline=X</td></tr><tr><td></td><td>dbrole_admin=X</td></tr><tr><td>模式</td><td>dbrole_readonly=U</td></tr><tr><td></td><td>dbrole_offline=U</td></tr><tr><td></td><td>dbrole_admin=UC</td></tr><tr><td>序列号</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=wU</td></tr><tr><td></td><td>dbrole_admin=rwU</td></tr><tr><td>表</td><td>dbrole_readonly=r</td></tr><tr><td></td><td>dbrole_offline=r</td></tr><tr><td></td><td>dbrole_readwrite=awd</td></tr><tr><td></td><td>dbrole_admin=arwdDxt</td></tr></tbody></table><hr><h2 id=默认权限>默认权限</h2><p><a href=https://www.postgresql.org/docs/current/sql-alterdefaultprivileges.html><code>ALTER DEFAULT PRIVILEGES</code></a> 允许您设置将来创建的对象的权限。 它不会影响已经存在对象的权限，也不会影响非管理员用户创建的对象。</p><p>在 Pigsty 中，默认权限针对三个角色进行定义：</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_dbsu</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_admin_username</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>-- 对于其他业务管理员而言，它们应当在执行 DDL 前执行 SET ROLE dbrole_admin，从而使用对应的默认权限配置。
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>for</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>in</span><span style=color:#f8f8f8> </span><span style=color:#000>pg_default_privileges</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>ALTER</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>DEFAULT</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>PRIVILEGES</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>FOR</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>ROLE</span><span style=color:#f8f8f8> </span><span style=color:#4e9a06>&#34;dbrole_admin&#34;</span><span style=color:#f8f8f8> </span><span style=color:#a40000>{{</span><span style=color:#f8f8f8> </span><span style=color:#000>priv</span><span style=color:#f8f8f8> </span><span style=color:#a40000>}}</span><span style=color:#000;font-weight:700>;</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#a40000>{</span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#f8f8f8> </span><span style=color:#000>endfor</span><span style=color:#f8f8f8> </span><span style=color:#ce5c00;font-weight:700>%</span><span style=color:#a40000>}</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><p>这些内容将会被 PG集群初始化模板 <a href=https://github.com/Vonng/pigsty/blob/main/roles/pgsql/templates/pg-init-template.sql><code>pg-init-template.sql</code></a> 所使用，在集群初始化的过程中渲染并输出至 <code>/pg/tmp/pg-init-template.sql</code>。
该命令会在 <code>template1</code> 与 <code>postgres</code> 数据库中执行，新创建的数据库会通过模板 <code>template1</code> 继承这些默认权限配置。</p><p>也就是说，为了维持正确的对象权限，您必须用<strong>管理员用户</strong>来执行 DDL，它们可以是：</p><ol><li><a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>，默认为 <code>postgres</code></li><li><a href=/docs/pgsql/param#pg_admin_username><code>{{ pg_admin_username }}</code></a>，默认为 <code>dbuser_dba</code></li><li>授予了 <code>dbrole_admin</code> 角色的业务管理员用户（通过 <code>SET ROLE</code> 切换为 <code>dbrole_admin</code> 身份）。</li></ol><p>使用 <code>postgres</code> 作为全局对象所有者是明智的。如果您希望以业务管理员用户身份创建对象，创建之前必须使用 <code>SET ROLE dbrole_admin</code> 来维护正确的权限。</p><p>当然，您也可以在数据库中通过 <code>ALTER DEFAULT PRIVILEGE FOR ROLE &lt;some_biz_admin> XXX</code> 来显式对业务管理员授予默认权限。</p><hr><h2 id=数据库权限>数据库权限</h2><p>在 Pigsty 中，数据库（Database）层面的权限在 <a href=/docs/pgsql/config/db#%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E5%BA%93>数据库定义</a> 中被涵盖。</p><p>数据库有三个级别的权限：<code>CONNECT</code>、<code>CREATE</code>、<code>TEMP</code>，以及一个特殊的&rsquo;权限&rsquo;：<code>OWNERSHIP</code>。</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>meta        </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 必选，`name` 是数据库定义中唯一的必选字段</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>owner</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>postgres   </span><span style=color:#f8f8f8> </span><span style=color:#8f5902;font-style:italic># 可选，数据库所有者，默认为 postgres</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>allowconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8>    </span><span style=color:#8f5902;font-style:italic># 可选，是否允许连接，默认为 true。显式设置 false 将完全禁止连接到此数据库</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>revokeconn</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>false</span><span style=color:#f8f8f8>  </span><span style=color:#8f5902;font-style:italic># 可选，撤销公共连接权限。默认为 false，设置为 true 时，属主和管理员之外用户的 CONNECT 权限会被回收</span><span style=color:#f8f8f8>
</span></span></span></code></pre></div><ul><li>如果 <code>owner</code> 参数存在，它作为数据库属主，替代默认的 <a href=/docs/pgsql/param#pg_dbsu><code>{{ pg_dbsu }}</code></a>（通常也就是<code>postgres</code>）</li><li>如果 <code>revokeconn</code> 为 <code>false</code>，所有用户都有数据库的 <code>CONNECT</code> 权限，这是默认的行为。</li><li>如果显式设置了 <code>revokeconn</code> 为 <code>true</code>：<ul><li>数据库的 <code>CONNECT</code> 权限将从 <code>PUBLIC</code> 中撤销：普通用户无法连接上此数据库</li><li><code>CONNECT</code> 权限将被显式授予 <code>{{ pg_replication_username }}</code>、<code>{{ pg_monitor_username }}</code> 和 <code>{{ pg_admin_username }}</code></li><li><code>CONNECT</code> 权限将 <code>GRANT OPTION</code> 被授予数据库属主，数据库属主用户可以自行授权其他用户连接权限。</li></ul></li><li><code>revokeconn</code> 选项可用于在同一个集群间隔离跨数据库访问，您可以为每个数据库创建不同的业务用户作为属主，并为它们设置 <code>revokeconn</code> 选项。</li></ul><details><summary>示例：数据库隔离</summary><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#204a87;font-weight:700>pg-infra</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.40</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 1, pg_role</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>primary }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>10.10.10.41</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span>{<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>pg_seq: 2, pg_role: replica , pg_offline_query</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>true</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>  </span><span style=color:#204a87;font-weight:700>vars</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_cluster</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000>pg-infra</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_users</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_confluence, password: mc2iohos , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_gitlab, password: sdf23g22sfdd , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_readwrite ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: dbuser_jira, password: sdpijfsfdsfdfs , pgbouncer: true, roles</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#000;font-weight:700>[</span><span style=color:#f8f8f8> </span><span style=color:#000>dbrole_admin ] }</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>    </span><span style=color:#204a87;font-weight:700>pg_databases</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: confluence , revokeconn: true, owner: dbuser_confluence , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: gitlab , revokeconn: true, owner: dbuser_gitlab, connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8>      </span>- {<span style=color:#f8f8f8> </span><span style=color:#204a87;font-weight:700>name: jira , revokeconn: true, owner: dbuser_jira , connlimit</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8> </span><span style=color:#0000cf;font-weight:700>100</span><span style=color:#f8f8f8> </span>}<span style=color:#f8f8f8>
</span></span></span></code></pre></div></details><hr><h2 id=create权限>CREATE权限</h2><p>出于安全考虑，Pigsty 默认从 <code>PUBLIC</code> 撤销数据库上的 <code>CREATE</code> 权限，从 PostgreSQL 15 开始这也是默认行为。</p><p>数据库属主总是可以根据实际需要，来自行调整 CREATE 权限。</p></div></main></div></div><footer class="td-footer row d-print-none"><div class=container-fluid><div class="row mx-md-2"><div class="td-footer__left col-6 col-sm-4 order-sm-1"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=邮件 aria-label=邮件><a target=_blank rel=noopener href=mailto:rh@vonng.com aria-label=邮件><i class="fa fa-envelope"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="GitHub - Vonng" aria-label="GitHub - Vonng"><a target=_blank rel=noopener href=https://github.com/Vonng aria-label="GitHub - Vonng"><i class="fab fa-github"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Vonng" aria-label="X - Vonng"><a target=_blank rel=noopener href=https://x.com/RonVonng aria-label="X - Vonng"><i class="fab fa-x-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="X - Pigsty" aria-label="X - Pigsty"><a target=_blank rel=noopener href=https://x.com/PlGSTY aria-label="X - Pigsty"><i class="fab fa-twitter"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title="LinkedIn - Vonng" aria-label="LinkedIn - Vonng"><a target=_blank rel=noopener href=https://www.linkedin.com/in/vonng/ aria-label="LinkedIn - Vonng"><i class="fab fa-linkedin"></i></a></li></ul></div><div class="td-footer__right col-6 col-sm-4 order-sm-3"><ul class=td-footer__links-list><li class=td-footer__links-item data-bs-toggle=tooltip title=Discord aria-label=Discord><a target=_blank rel=noopener href=https://discord.gg/wDzt5VyWEz aria-label=Discord><i class="fab fa-discord"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=Telegram aria-label=Telegram><a target=_blank rel=noopener href=https://t.me/joinchat/gV9zfZraNPM3YjFh aria-label=Telegram><i class="fab fa-telegram"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=微信 aria-label=微信><a target=_blank rel=noopener href=/img/pigsty/pigsty-cc.jpg aria-label=微信><i class="fab fa-weixin"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=论坛 aria-label=论坛><a target=_blank rel=noopener href=https://github.com/orgs/pgsty/discussions aria-label=论坛><i class="fab fa-discourse"></i></a></li><li class=td-footer__links-item data-bs-toggle=tooltip title=GitHub aria-label=GitHub><a target=_blank rel=noopener href=https://github.com/pgsty/pigsty aria-label=GitHub><i class="fab fa-github"></i></a></li></ul></div><div class="td-footer__center col-12 col-sm-4 py-2 order-sm-2"><span class=td-footer__copyright>&copy;
2018&ndash;2026
<span class=td-footer__authors>Ruohang Feng</span></span><span class=td-footer__all_rights_reserved>保留所有权利</span><span class=ms-2><a href=/docs/about/privacy target=_blank rel=noopener>隐私政策</a></span></div></div></div></footer></div><script src=/js/main.min.d20e761d6aa4d2ace0488e45da0e775a8b17300a8430f32fbcfa016e6c9e6eb6.js integrity="sha256-0g52HWqk0qzgSI5F2g53WosXMAqEMPMvvPoBbmyebrY=" crossorigin=anonymous></script><script defer src=/js/click-to-copy.min.73478a7d4807698aed7e355eb23f9890ca18fea3158604c8471746d046702bad.js integrity="sha256-c0eKfUgHaYrtfjVesj+YkMoY/qMVhgTIRxdG0EZwK60=" crossorigin=anonymous></script><script src=/js/tabpane-persist.js></script></body></html>