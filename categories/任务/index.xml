<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>任务 on PIGSTY</title><link>https://pigsty.cc/categories/%E4%BB%BB%E5%8A%A1/</link><description>Recent content in 任务 on PIGSTY</description><generator>Hugo</generator><language>zh-CN</language><lastBuildDate>Sat, 14 Feb 2026 08:23:51 +0800</lastBuildDate><atom:link href="https://pigsty.cc/categories/%E4%BB%BB%E5%8A%A1/index.xml" rel="self" type="application/rss+xml"/><item><title>管理 PostgreSQL 数据库集群</title><link>https://pigsty.cc/docs/pgsql/admin/cluster/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/cluster/</guid><description>&lt;h2 id="速查手册"&gt;速查手册&lt;/h2&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th style="text-align: left"&gt;操作&lt;/th&gt;
 &lt;th style="text-align: left"&gt;快捷命令&lt;/th&gt;
 &lt;th style="text-align: left"&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4"&gt;&lt;strong&gt;创建集群&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;bin/pgsql-add &amp;lt;cls&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;创建新的 PostgreSQL 集群&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#%E6%89%A9%E5%AE%B9%E9%9B%86%E7%BE%A4"&gt;&lt;strong&gt;扩容集群&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;bin/pgsql-add &amp;lt;cls&amp;gt; &amp;lt;ip...&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;为现有集群添加从库副本&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#%E7%BC%A9%E5%AE%B9%E9%9B%86%E7%BE%A4"&gt;&lt;strong&gt;缩容集群&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;bin/pgsql-rm &amp;lt;cls&amp;gt; &amp;lt;ip...&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;从集群中移除指定实例&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#%E9%94%80%E6%AF%81%E9%9B%86%E7%BE%A4"&gt;&lt;strong&gt;销毁集群&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;bin/pgsql-rm &amp;lt;cls&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;销毁整个 PostgreSQL 集群&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#%E5%88%B7%E6%96%B0%E6%9C%8D%E5%8A%A1"&gt;&lt;strong&gt;刷新服务&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;bin/pgsql-svc &amp;lt;cls&amp;gt; [ip...]&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;重载集群的负载均衡配置&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#%E5%88%B7%E6%96%B0hba"&gt;&lt;strong&gt;刷新HBA&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;bin/pgsql-hba &amp;lt;cls&amp;gt; [ip...]&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;重载集群的 HBA 访问规则&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#%E5%85%8B%E9%9A%86%E9%9B%86%E7%BE%A4"&gt;&lt;strong&gt;克隆集群&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;-&lt;/td&gt;
 &lt;td style="text-align: left"&gt;通过备份集群或 PITR 克隆&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;其他管理任务，请参考：&lt;a href="https://pigsty.cc/docs/pgsql/admin/patroni"&gt;&lt;strong&gt;高可用管理&lt;/strong&gt;&lt;/a&gt;，&lt;a href="https://pigsty.cc/docs/pgsql/admin/user/"&gt;&lt;strong&gt;管理用户&lt;/strong&gt;&lt;/a&gt;，&lt;a href="https://pigsty.cc/docs/pgsql/admin/db/"&gt;&lt;strong&gt;管理数据库&lt;/strong&gt;&lt;/a&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="创建集群"&gt;创建集群&lt;/h2&gt;
&lt;p&gt;要创建一个新的 PostgreSQL 集群，请首先在 &lt;a href="https://pigsty.cc/docs/concept/iac/inventory"&gt;&lt;strong&gt;配置清单&lt;/strong&gt;&lt;/a&gt; 中 &lt;a href="https://pigsty.cc/docs/pgsql/config/cluster"&gt;&lt;strong&gt;定义集群&lt;/strong&gt;&lt;/a&gt;，然后 &lt;a href="https://pigsty.cc/docs/node/admin#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9"&gt;&lt;strong&gt;纳管节点&lt;/strong&gt;&lt;/a&gt;并进行初始化：&lt;/p&gt;




&lt;ul class="nav nav-tabs" id="tabs-0" role="tablist"&gt;
 &lt;li class="nav-item"&gt;
 &lt;button class="nav-link active"
 id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
 data-td-tp-persist="脚本" aria-controls="tabs-00-00" aria-selected="true"&gt;
 脚本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
 data-td-tp-persist="剧本" aria-controls="tabs-00-01" aria-selected="false"&gt;
 剧本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
 data-td-tp-persist="示例" aria-controls="tabs-00-02" aria-selected="false"&gt;
 示例
 &lt;/button&gt;
 &lt;/li&gt;
&lt;/ul&gt;

&lt;div class="tab-content" id="tabs-0-content"&gt;
 &lt;div class="tab-body tab-pane fade show active"
 id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/node-add &amp;lt;cls&amp;gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 添加分组 &amp;lt;cls&amp;gt; 下的节点&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./node.yml -l &amp;lt;cls&amp;gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 直接使用 Ansible 剧本添加分组 &amp;lt;cls&amp;gt; 下的节点&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-add pg-test &lt;span style="color:#8f5902;font-style:italic"&gt;# 例子，添加 pg-test 分组下的节点，实际执行 ./node.yml -l pg-test&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;在被纳管的节点上，可以使用以下命令创建集群：（针对 &lt;strong&gt;&lt;code&gt;&amp;lt;cls&amp;gt;&lt;/code&gt;&lt;/strong&gt; 分组执行 &lt;a href="https://pigsty.cc/docs/pgsql/playbook#pgsqlyml"&gt;&lt;strong&gt;&lt;code&gt;pgsql.yml&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; 剧本）&lt;/p&gt;</description></item><item><title>管理 PostgreSQL 业务用户</title><link>https://pigsty.cc/docs/pgsql/admin/user/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/user/</guid><description>&lt;h2 id="快速上手"&gt;快速上手&lt;/h2&gt;
&lt;p&gt;Pigsty 使用声明式管理方式，首先在 &lt;a href="https://pigsty.cc/docs/concept/iac/inventory"&gt;&lt;strong&gt;配置清单&lt;/strong&gt;&lt;/a&gt; 中 &lt;a href="https://pigsty.cc/docs/pgsql/config/user"&gt;&lt;strong&gt;定义用户&lt;/strong&gt;&lt;/a&gt;，然后使用 &lt;code&gt;bin/pgsql-user &amp;lt;cls&amp;gt; &amp;lt;username&amp;gt;&lt;/code&gt; 创建或修改用户。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg-meta&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_seq: 1, pg_role&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;primary } }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_cluster&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg-meta&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_users&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;[&lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;name: dbuser_app, password: &amp;#39;DBUser.App&amp;#39;, pgbouncer&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;true&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#000;font-weight:bold"&gt;]&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# &amp;lt;--- 在这里定义用户列表！&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;



&lt;ul class="nav nav-tabs" id="tabs-0" role="tablist"&gt;
 &lt;li class="nav-item"&gt;
 &lt;button class="nav-link active"
 id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
 data-td-tp-persist="脚本" aria-controls="tabs-00-00" aria-selected="true"&gt;
 脚本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
 data-td-tp-persist="剧本" aria-controls="tabs-00-01" aria-selected="false"&gt;
 剧本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
 data-td-tp-persist="示例" aria-controls="tabs-00-02" aria-selected="false"&gt;
 示例
 &lt;/button&gt;
 &lt;/li&gt;
&lt;/ul&gt;

&lt;div class="tab-content" id="tabs-0-content"&gt;
 &lt;div class="tab-body tab-pane fade show active"
 id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-user &amp;lt;cls&amp;gt; &amp;lt;username&amp;gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 &amp;lt;cls&amp;gt; 集群上创建/修改 &amp;lt;username&amp;gt; 用户&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-user.yml -l pg-meta -e &lt;span style="color:#000"&gt;username&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;dbuser_app &lt;span style="color:#8f5902;font-style:italic"&gt;# 直接使用剧本在 &amp;lt;cls&amp;gt; 集群上创建/修改 &amp;lt;username&amp;gt; 用户&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-user pg-meta dbuser_app &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 pg-meta 集群上创建/修改 dbuser_app 用户&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;关于用户定义参数的完整参考，请查阅 &lt;a href="https://pigsty.cc/docs/pgsql/config/user"&gt;&lt;strong&gt;用户配置&lt;/strong&gt;&lt;/a&gt;。关于用户的访问权限，请参考 &lt;a href="https://pigsty.cc/docs/concept/sec/ac/#%E9%BB%98%E8%AE%A4%E8%A7%92%E8%89%B2%E4%B8%8E%E7%B3%BB%E7%BB%9F%E7%94%A8%E6%88%B7"&gt;&lt;strong&gt;ACL：角色权限&lt;/strong&gt;&lt;/a&gt;。&lt;/p&gt;</description></item><item><title>安装</title><link>https://pigsty.cc/docs/pig/install/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pig/install/</guid><description>&lt;h2 id="脚本安装"&gt;脚本安装&lt;/h2&gt;
&lt;p&gt;安装 &lt;code&gt;pig&lt;/code&gt; 最简单的方式是运行以下安装脚本：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;默认安装&lt;/strong&gt;（Cloudflare CDN）：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl -fsSL https://repo.pigsty.io/pig &lt;span style="color:#000;font-weight:bold"&gt;|&lt;/span&gt; bash
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;中国镜像&lt;/strong&gt;：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl -fsSL https://repo.pigsty.cc/pig &lt;span style="color:#000;font-weight:bold"&gt;|&lt;/span&gt; bash
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;该脚本会从 Pigsty &lt;a href="https://pigsty.cc/docs/repo/"&gt;软件仓库&lt;/a&gt; 下载最新版 &lt;code&gt;pig&lt;/code&gt; 的 RPM / DEB 包，并通过 &lt;code&gt;rpm&lt;/code&gt; 或 &lt;code&gt;dpkg&lt;/code&gt; 进行安装。&lt;/p&gt;
&lt;h2 id="指定版本"&gt;指定版本&lt;/h2&gt;
&lt;p&gt;您可以指定特定版本进行安装，将版本号作为参数传入即可：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;默认安装&lt;/strong&gt;（Cloudflare CDN）：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl -fsSL https://repo.pigsty.io/pig &lt;span style="color:#000;font-weight:bold"&gt;|&lt;/span&gt; bash -s 1.0.0
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;中国镜像&lt;/strong&gt;：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl -fsSL https://repo.pigsty.cc/pig &lt;span style="color:#000;font-weight:bold"&gt;|&lt;/span&gt; bash -s 1.0.0
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="发布页下载"&gt;发布页下载&lt;/h2&gt;
&lt;p&gt;你也可以直接从 Pigsty 仓库下载 &lt;code&gt;pig&lt;/code&gt; 安装包（&lt;code&gt;RPM&lt;/code&gt;/&lt;code&gt;DEB&lt;/code&gt;/ 压缩包）：&lt;a href="https://github.com/pgsty/pig/releases/tag/v1.0.0"&gt;GitHub v1.0.0 稳定版发布页&lt;/a&gt;&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;latest
└── v1.0.0
 ├── pig_1.0.0-1_amd64.deb
 ├── pig_1.0.0-1_arm64.deb
 ├── pig-1.0.0-1.aarch64.rpm
 ├── pig-1.0.0-1.x86_64.rpm
 ├── pig-v1.0.0.linux-amd64.tar.gz
 ├── pig-v1.0.0.linux-arm64.tar.gz
 ├── pig-v1.0.0.darwin-amd64.tar.gz
 └── pig-v1.0.0.darwin-arm64.tar.gz
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;将其解压后，将二进制文件放入您的 PATH 系统路径中即可。&lt;/p&gt;</description></item><item><title>管理 PostgreSQL 业务数据库</title><link>https://pigsty.cc/docs/pgsql/admin/db/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/db/</guid><description>&lt;h2 id="快速上手"&gt;快速上手&lt;/h2&gt;
&lt;p&gt;Pigsty 使用声明式管理方式，首先在 &lt;a href="https://pigsty.cc/docs/concept/iac/inventory"&gt;&lt;strong&gt;配置清单&lt;/strong&gt;&lt;/a&gt; 中 &lt;a href="https://pigsty.cc/docs/pgsql/config/db"&gt;&lt;strong&gt;定义数据库&lt;/strong&gt;&lt;/a&gt;，然后使用 &lt;code&gt;bin/pgsql-db &amp;lt;cls&amp;gt; &amp;lt;dbname&amp;gt;&lt;/code&gt; 创建或修改数据库。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg-meta&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_seq: 1, pg_role&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;primary } }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_cluster&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg-meta&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_databases&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;[&lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;name&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;some_db }] &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# &amp;lt;--- 在这里定义数据库列表！&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;



&lt;ul class="nav nav-tabs" id="tabs-0" role="tablist"&gt;
 &lt;li class="nav-item"&gt;
 &lt;button class="nav-link active"
 id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
 data-td-tp-persist="脚本" aria-controls="tabs-00-00" aria-selected="true"&gt;
 脚本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
 data-td-tp-persist="剧本" aria-controls="tabs-00-01" aria-selected="false"&gt;
 剧本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
 data-td-tp-persist="示例" aria-controls="tabs-00-02" aria-selected="false"&gt;
 示例
 &lt;/button&gt;
 &lt;/li&gt;
&lt;/ul&gt;

&lt;div class="tab-content" id="tabs-0-content"&gt;
 &lt;div class="tab-body tab-pane fade show active"
 id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-db &amp;lt;cls&amp;gt; &amp;lt;dbname&amp;gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 &amp;lt;cls&amp;gt; 集群上创建/修改 &amp;lt;dbname&amp;gt; 数据库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-db.yml -l pg-meta -e &lt;span style="color:#000"&gt;dbname&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;some_db &lt;span style="color:#8f5902;font-style:italic"&gt;# 直接使用剧本在 &amp;lt;cls&amp;gt; 集群上创建/修改 &amp;lt;dbname&amp;gt; 数据库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-db pg-meta some_db &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 pg-meta 集群上创建/修改 some_db 数据库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;关于数据库定义参数的完整参考，请查阅 &lt;a href="https://pigsty.cc/docs/pgsql/config/db"&gt;&lt;strong&gt;数据库配置&lt;/strong&gt;&lt;/a&gt;。关于数据库的访问权限，请参考 &lt;a href="https://pigsty.cc/docs/concept/sec/ac/#%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9A%94%E7%A6%BB"&gt;&lt;strong&gt;ACL：数据库权限&lt;/strong&gt;&lt;/a&gt;。&lt;/p&gt;</description></item><item><title>管理 Patroni 高可用</title><link>https://pigsty.cc/docs/pgsql/admin/patroni/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/patroni/</guid><description>&lt;h2 id="概览"&gt;概览&lt;/h2&gt;
&lt;p&gt;Pigsty 使用 Patroni 管理 PostgreSQL 集群，它可以用来修改集群配置，查看集群状态，执行主从切换，重启集群，重做从库等操作。&lt;/p&gt;
&lt;p&gt;要使用 Patroni 进行管理，您需要有以下两种身份之一：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;从 &lt;a href="https://pigsty.cc/docs/concept/arch/node#infra%E8%8A%82%E7%82%B9"&gt;&lt;strong&gt;INFRA 节点&lt;/strong&gt;&lt;/a&gt; 上使用 &lt;a href="https://pigsty.cc/docs/deploy/admin"&gt;&lt;strong&gt;管理员用户&lt;/strong&gt;&lt;/a&gt; ，可以管理环境中的所有集群。&lt;/li&gt;
&lt;li&gt;从 &lt;a href="https://pigsty.cc/docs/concept/arch/node#pgsql%E8%8A%82%E7%82%B9"&gt;&lt;strong&gt;PGSQL节点&lt;/strong&gt;&lt;/a&gt; 上使用 &lt;a href="https://pigsty.cc/docs/pgsql/param#pg_dbsu"&gt;&lt;strong&gt;&lt;code&gt;pg_dbsu&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; （默认为 &lt;code&gt;postgres&lt;/code&gt;），可以管理当前集群。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Patroni 提供了 &lt;a href="https://patroni.readthedocs.io/en/latest/patronictl.html"&gt;&lt;strong&gt;&lt;code&gt;patronictl&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; 命令行工具用于管理，Pigsty 提供了封装的快捷命令 &lt;code&gt;pg&lt;/code&gt; 来简化其操作。&lt;/p&gt;
&lt;details&gt;&lt;summary&gt;通过 pg 别名使用 patronictl&lt;/summary&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg &lt;span style="color:#ce5c00;font-weight:bold"&gt;()&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#204a87"&gt;local&lt;/span&gt; &lt;span style="color:#000"&gt;patroni_conf&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;/infra/conf/patronictl.yml&amp;#34;&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#204a87;font-weight:bold"&gt;if&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;[&lt;/span&gt; ! -r &lt;span style="color:#4e9a06"&gt;${&lt;/span&gt;&lt;span style="color:#000"&gt;patroni_conf&lt;/span&gt;&lt;span style="color:#4e9a06"&gt;}&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;]&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt; &lt;span style="color:#204a87;font-weight:bold"&gt;then&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#000"&gt;patroni_conf&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;/etc/patroni/patroni.yml&amp;#34;&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#204a87;font-weight:bold"&gt;if&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;[&lt;/span&gt; ! -r &lt;span style="color:#4e9a06"&gt;${&lt;/span&gt;&lt;span style="color:#000"&gt;patroni_conf&lt;/span&gt;&lt;span style="color:#4e9a06"&gt;}&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;]&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt; &lt;span style="color:#204a87;font-weight:bold"&gt;then&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#204a87"&gt;echo&lt;/span&gt; &lt;span style="color:#4e9a06"&gt;&amp;#34;error: patronictl config not found&amp;#34;&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#204a87;font-weight:bold"&gt;return&lt;/span&gt; 1&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#204a87;font-weight:bold"&gt;fi&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#204a87;font-weight:bold"&gt;fi&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; patronictl -c &lt;span style="color:#4e9a06"&gt;${&lt;/span&gt;&lt;span style="color:#000"&gt;patroni_conf&lt;/span&gt;&lt;span style="color:#4e9a06"&gt;}&lt;/span&gt; &lt;span style="color:#4e9a06"&gt;&amp;#34;&lt;/span&gt;&lt;span style="color:#000"&gt;$@&lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/details&gt;
&lt;hr&gt;
&lt;h2 id="可用命令"&gt;可用命令&lt;/h2&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;命令&lt;/th&gt;
 &lt;th&gt;功能&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE"&gt;&lt;strong&gt;&lt;code&gt;edit-config&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;修改配置&lt;/td&gt;
 &lt;td&gt;交互式修改集群的 Patroni/PostgreSQL 配置&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E6%9F%A5%E7%9C%8B%E7%8A%B6%E6%80%81"&gt;&lt;strong&gt;&lt;code&gt;list&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;查看状态&lt;/td&gt;
 &lt;td&gt;列出集群成员及其状态&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E4%B8%BB%E5%8A%A8%E5%88%87%E6%8D%A2"&gt;&lt;strong&gt;&lt;code&gt;switchover&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;主动切换&lt;/td&gt;
 &lt;td&gt;将主库角色切换到指定从库（计划内维护）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E6%95%85%E9%9A%9C%E5%88%87%E6%8D%A2"&gt;&lt;strong&gt;&lt;code&gt;failover&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;故障切换&lt;/td&gt;
 &lt;td&gt;强制故障转移到指定从库（紧急情况）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E9%87%8D%E5%90%AF%E5%AE%9E%E4%BE%8B"&gt;&lt;strong&gt;&lt;code&gt;restart&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;重启实例&lt;/td&gt;
 &lt;td&gt;重启 PostgreSQL 实例以应用需要重启的参数&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE"&gt;&lt;strong&gt;&lt;code&gt;reload&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;重载配置&lt;/td&gt;
 &lt;td&gt;重载 Patroni 配置（无需重启）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E9%87%8D%E5%81%9A%E4%BB%8E%E5%BA%93"&gt;&lt;strong&gt;&lt;code&gt;reinit&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;重做从库&lt;/td&gt;
 &lt;td&gt;重新初始化从库（擦除数据并重新复制）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E6%9A%82%E5%81%9C%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2"&gt;&lt;strong&gt;&lt;code&gt;pause&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;暂停自动切换&lt;/td&gt;
 &lt;td&gt;暂停 Patroni 的自动故障转移功能&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E6%81%A2%E5%A4%8D%E8%87%AA%E5%8A%A8%E5%88%87%E6%8D%A2"&gt;&lt;strong&gt;&lt;code&gt;resume&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;恢复自动切换&lt;/td&gt;
 &lt;td&gt;恢复 Patroni 的自动故障转移功能&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E6%9F%A5%E7%9C%8B%E5%8E%86%E5%8F%B2"&gt;&lt;strong&gt;&lt;code&gt;history&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;查看历史&lt;/td&gt;
 &lt;td&gt;显示集群的故障转移历史记录&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E6%98%BE%E7%A4%BA%E9%85%8D%E7%BD%AE"&gt;&lt;strong&gt;&lt;code&gt;show-config&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;显示配置&lt;/td&gt;
 &lt;td&gt;显示集群当前的配置（只读）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E6%89%A7%E8%A1%8C%E6%9F%A5%E8%AF%A2"&gt;&lt;strong&gt;&lt;code&gt;query&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;执行查询&lt;/td&gt;
 &lt;td&gt;在集群成员上执行 SQL 查询&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E6%9F%A5%E7%9C%8B%E6%8B%93%E6%89%91"&gt;&lt;strong&gt;&lt;code&gt;topology&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;查看拓扑&lt;/td&gt;
 &lt;td&gt;显示集群的复制拓扑结构&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E6%9F%A5%E7%9C%8B%E7%89%88%E6%9C%AC"&gt;&lt;strong&gt;&lt;code&gt;version&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;查看版本&lt;/td&gt;
 &lt;td&gt;显示 Patroni 版本信息&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#%E7%A7%BB%E9%99%A4%E6%88%90%E5%91%98"&gt;&lt;strong&gt;&lt;code&gt;remove&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;移除成员&lt;/td&gt;
 &lt;td&gt;从 DCS 中移除集群成员（危险操作）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h2 id="修改配置"&gt;修改配置&lt;/h2&gt;
&lt;p&gt;使用 &lt;a href="https://patroni.readthedocs.io/en/latest/patronictl.html#patronictl-edit-config"&gt;&lt;strong&gt;&lt;code&gt;edit-config&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; 子命令可以交互式修改集群的 Patroni 与 PostgreSQL 配置。该命令会打开一个编辑器，让您修改存储在 DCS（分布式配置存储）中的集群配置，修改后会自动应用到所有集群成员。您可以更改 Patroni 本身的参数（如 &lt;code&gt;ttl&lt;/code&gt;、&lt;code&gt;loop_wait&lt;/code&gt;、&lt;code&gt;synchronous_mode&lt;/code&gt; 等），以及 &lt;code&gt;postgresql.parameters&lt;/code&gt; 中的 PostgreSQL 参数。&lt;/p&gt;</description></item><item><title>Pgbouncer 连接池管理</title><link>https://pigsty.cc/docs/pgsql/admin/pgbouncer/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/pgbouncer/</guid><description>&lt;h2 id="概览"&gt;概览&lt;/h2&gt;
&lt;p&gt;Pigsty 使用 &lt;a href="https://www.pgbouncer.org/"&gt;&lt;strong&gt;Pgbouncer&lt;/strong&gt;&lt;/a&gt; 作为 PostgreSQL 的连接池中间件，默认监听 &lt;code&gt;6432&lt;/code&gt; 端口，代理访问本机 &lt;code&gt;5432&lt;/code&gt; 端口上的 PostgreSQL 实例。&lt;/p&gt;
&lt;p&gt;这是一个 &lt;strong&gt;可选组件&lt;/strong&gt;，如果您并没有海量链接，也不需要事务池化与查询监控指标，可以关闭连接池，直连数据库，或者保留但不使用。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="用户与数据库管理"&gt;用户与数据库管理&lt;/h2&gt;
&lt;p&gt;Pgbouncer 中的用户和数据库由 Pigsty 自动管理，并在 &lt;a href="https://pigsty.cc/docs/pgsql/admin/db"&gt;&lt;strong&gt;创建数据库&lt;/strong&gt;&lt;/a&gt; 与 &lt;a href="https://pigsty.cc/docs/pgsql/admin/user"&gt;&lt;strong&gt;创建用户&lt;/strong&gt;&lt;/a&gt; 时自动应用 &lt;a href="https://pigsty.cc/docs/pgsql/config/db"&gt;&lt;strong&gt;数据库配置&lt;/strong&gt;&lt;/a&gt; 与 &lt;a href="https://pigsty.cc/docs/pgsql/config/user"&gt;&lt;strong&gt;用户配置&lt;/strong&gt;&lt;/a&gt;。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;数据库管理&lt;/strong&gt;：在 &lt;a href="https://pigsty.cc/docs/pgsql/param#pg_databases"&gt;&lt;strong&gt;&lt;code&gt;pg_databases&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; 中定义的数据库，默认会自动添加到 Pgbouncer。设置 &lt;a href="https://pigsty.cc/docs/pgsql/admin/db#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%AE%A1%E7%90%86"&gt;&lt;strong&gt;&lt;code&gt;pgbouncer: false&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; 可以排除特定数据库。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_databases&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;- &lt;span style="color:#204a87;font-weight:bold"&gt;name&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;mydb &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 默认加入连接池&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pool_auth_user&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;dbuser_meta&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 可选，认证查询用户（配合 pgbouncer_auth_query）&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pool_mode&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;transaction &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 数据库级池化模式&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pool_size&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;64&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 默认池大小&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pool_reserve&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;32&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 保留池大小&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pool_size_min&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;0&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 最小池大小&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pool_connlimit&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;100&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 最大数据库连接数&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;- &lt;span style="color:#204a87;font-weight:bold"&gt;name&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;internal&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pgbouncer&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;false&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 不加入连接池&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;用户管理&lt;/strong&gt;：在 &lt;a href="https://pigsty.cc/docs/pgsql/param#pg_users"&gt;&lt;strong&gt;&lt;code&gt;pg_users&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; 中定义的用户，需要显式设置 &lt;a href="https://pigsty.cc/docs/pgsql/admin/user#%E8%BF%9E%E6%8E%A5%E6%B1%A0%E7%AE%A1%E7%90%86"&gt;&lt;strong&gt;&lt;code&gt;pgbouncer: true&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; 才会加入连接池用户列表。&lt;/p&gt;</description></item><item><title>管理 PostgreSQL 组件服务</title><link>https://pigsty.cc/docs/pgsql/admin/component/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/component/</guid><description>&lt;h2 id="概述"&gt;概述&lt;/h2&gt;
&lt;p&gt;Pigsty 的 PGSQL 模块由多个组件构成，每个组件都以 systemd 服务的形式运行在节点上。（ &lt;a href="https://pigsty.cc/docs/concept/arch/pgsql#pgbackrest"&gt;&lt;strong&gt;pgbackrest&lt;/strong&gt;&lt;/a&gt; 除外）&lt;/p&gt;
&lt;p&gt;了解这些组件及其管理方式，对于维护生产环境中的 PostgreSQL 集群非常重要。&lt;/p&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th style="text-align: left"&gt;组件&lt;/th&gt;
 &lt;th style="text-align: left"&gt;端口&lt;/th&gt;
 &lt;th style="text-align: left"&gt;服务名&lt;/th&gt;
 &lt;th style="text-align: left"&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;Patroni&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;&lt;code&gt;8008&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;patroni&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;高可用管理器，负责 PostgreSQL 的生命周期管理&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;PostgreSQL&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;&lt;code&gt;5432&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;postgres&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;占位服务，默认不使用，应急使用&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;Pgbouncer&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;&lt;code&gt;6432&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;pgbouncer&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;连接池中间件，业务流量入口&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;PgBackRest&lt;/td&gt;
 &lt;td style="text-align: left"&gt;-&lt;/td&gt;
 &lt;td style="text-align: left"&gt;-&lt;/td&gt;
 &lt;td style="text-align: left"&gt;pgBackRest 没有守护服务&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;HAProxy&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;&lt;code&gt;543x&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;haproxy&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;负载均衡器，暴露数据库服务&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;pg_exporter&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;&lt;code&gt;9630&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;pg_exporter&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;PostgreSQL 监控指标导出器&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;pgbouncer_exporter&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;strong&gt;&lt;code&gt;9631&lt;/code&gt;&lt;/strong&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;pgbouncer_exporter&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;Pgbouncer 监控指标导出器&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;vip-manager&lt;/td&gt;
 &lt;td style="text-align: left"&gt;-&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;vip-manager&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;可选，管理 L2 VIP 地址漂移&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;div class="alert alert-warning" role="alert"&gt;&lt;div class="h4 alert-heading" role="heading"&gt;重要提示&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;不要直接使用 systemctl 管理 PostgreSQL 服务&lt;/strong&gt;。PostgreSQL 由 Patroni 托管，应通过 &lt;a href="https://pigsty.cc/docs/pgsql/admin/patroni"&gt;&lt;strong&gt;&lt;code&gt;patronictl&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; 命令进行管理。
直接操作 PostgreSQL 可能导致 Patroni 状态不一致，触发意外的故障转移。&lt;code&gt;postgres&lt;/code&gt; 服务是 Patroni 服务失效时的应急逃生窗口。&lt;/p&gt;</description></item><item><title>管理 PostgreSQL 定时任务</title><link>https://pigsty.cc/docs/pgsql/admin/crontab/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/crontab/</guid><description>&lt;p&gt;Pigsty 使用 crontab 来管理定时任务，用于执行例行备份，冻结老化事务，重整膨胀表索引等维护工作。&lt;/p&gt;
&lt;h2 id="速查手册"&gt;速查手册&lt;/h2&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th style="text-align: left"&gt;操作&lt;/th&gt;
 &lt;th style="text-align: left"&gt;快捷命令&lt;/th&gt;
 &lt;th style="text-align: left"&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#%E9%85%8D%E7%BD%AE%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"&gt;&lt;strong&gt;配置定时任务&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;./pgsql.yml -t pg_crontab -l &amp;lt;cls&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;应用 pg_crontab 配置&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#%E6%9F%A5%E7%9C%8B%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"&gt;&lt;strong&gt;查看定时任务&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;crontab -l&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;以 postgres 用户查看&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#pg-backup"&gt;&lt;strong&gt;物理备份&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;pg-backup [full|diff|incr]&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;使用 pgBackRest 执行备份&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#pg-vacuum"&gt;&lt;strong&gt;事务冻结&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;pg-vacuum [database...]&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;冻结老化事务，预防 XID 回卷&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;a href="#pg-repack"&gt;&lt;strong&gt;膨胀治理&lt;/strong&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;pg-repack [database...]&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;在线重整膨胀的表与索引&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;其他管理任务，请参考：&lt;a href="https://pigsty.cc/docs/pgsql/backup/"&gt;&lt;strong&gt;备份管理&lt;/strong&gt;&lt;/a&gt;，&lt;a href="https://pigsty.cc/docs/pgsql/monitor/"&gt;&lt;strong&gt;监控系统&lt;/strong&gt;&lt;/a&gt;，&lt;a href="https://pigsty.cc/docs/pgsql/admin/patroni"&gt;&lt;strong&gt;高可用管理&lt;/strong&gt;&lt;/a&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="配置定时任务"&gt;配置定时任务&lt;/h2&gt;
&lt;p&gt;使用 &lt;a href="https://pigsty.cc/docs/pgsql/param/#pg_crontab"&gt;&lt;strong&gt;&lt;code&gt;pg_crontab&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt; 参数配置 PostgreSQL 数据库超级用户（&lt;a href="https://pigsty.cc/docs/pgsql/param#pg_dbsu"&gt;&lt;strong&gt;&lt;code&gt;pg_dbsu&lt;/code&gt;&lt;/strong&gt;&lt;/a&gt;，默认 &lt;code&gt;postgres&lt;/code&gt;）的定时任务。&lt;/p&gt;
&lt;p&gt;下面 &lt;code&gt;pg-meta&lt;/code&gt; 集群配置了每天凌晨1点进行全量备份的定时任务，&lt;code&gt;pg-test&lt;/code&gt; 配置了每周一全量备份，其余日期增量备份的定时任务。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg-meta&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_seq: 1, pg_role&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;primary } }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_cluster&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg-meta&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_crontab&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;- &lt;span style="color:#4e9a06"&gt;&amp;#39;00 01 * * * /pg/bin/pg-backup&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg-test&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.11&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_seq: 1, pg_role&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;primary }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.12&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_seq: 2, pg_role&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;replica }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_cluster&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg-test&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_crontab&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;- &lt;span style="color:#4e9a06"&gt;&amp;#39;00 01 * * 1 /pg/bin/pg-backup full&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;- &lt;span style="color:#4e9a06"&gt;&amp;#39;00 01 * * 2,3,4,5,6,7 /pg/bin/pg-backup&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;推荐的维护计划&lt;/strong&gt;&lt;/p&gt;</description></item><item><title>升级 PostgreSQL 大小版本</title><link>https://pigsty.cc/docs/pgsql/admin/upgrade/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/upgrade/</guid><description>&lt;h2 id="快速上手"&gt;快速上手&lt;/h2&gt;
&lt;p&gt;PostgreSQL 版本升级分为两种类型：&lt;strong&gt;小版本升级&lt;/strong&gt; 和 &lt;strong&gt;大版本升级&lt;/strong&gt;，两者的风险和复杂度差异很大。&lt;/p&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th style="text-align: left"&gt;类型&lt;/th&gt;
 &lt;th style="text-align: left"&gt;示例&lt;/th&gt;
 &lt;th style="text-align: left"&gt;停机时间&lt;/th&gt;
 &lt;th style="text-align: left"&gt;数据兼容性&lt;/th&gt;
 &lt;th style="text-align: left"&gt;风险等级&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;小版本升级&lt;/td&gt;
 &lt;td style="text-align: left"&gt;17.2 → 17.3&lt;/td&gt;
 &lt;td style="text-align: left"&gt;秒级（滚动重启）&lt;/td&gt;
 &lt;td style="text-align: left"&gt;完全兼容&lt;/td&gt;
 &lt;td style="text-align: left"&gt;低&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;大版本升级&lt;/td&gt;
 &lt;td style="text-align: left"&gt;17 → 18&lt;/td&gt;
 &lt;td style="text-align: left"&gt;分钟级&lt;/td&gt;
 &lt;td style="text-align: left"&gt;需要升级数据目录&lt;/td&gt;
 &lt;td style="text-align: left"&gt;中&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;




&lt;ul class="nav nav-tabs" id="tabs-0" role="tablist"&gt;
 &lt;li class="nav-item"&gt;
 &lt;button class="nav-link active"
 id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
 data-td-tp-persist="小版本" aria-controls="tabs-00-00" aria-selected="true"&gt;
 小版本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
 data-td-tp-persist="大版本" aria-controls="tabs-00-01" aria-selected="false"&gt;
 大版本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
 data-td-tp-persist="扩展" aria-controls="tabs-00-02" aria-selected="false"&gt;
 扩展
 &lt;/button&gt;
 &lt;/li&gt;
&lt;/ul&gt;

&lt;div class="tab-content" id="tabs-0-content"&gt;
 &lt;div class="tab-body tab-pane fade show active"
 id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 滚动升级：先从库后主库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ansible &amp;lt;cls&amp;gt; -b -a &lt;span style="color:#4e9a06"&gt;&amp;#39;yum upgrade -y postgresql17*&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg restart --role replica --force &amp;lt;cls&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg switchover &amp;lt;cls&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg restart &amp;lt;cls&amp;gt; &amp;lt;old-primary&amp;gt; --force
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 推荐：逻辑复制迁移&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-add pg-new &lt;span style="color:#8f5902;font-style:italic"&gt;# 创建新版本集群&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 配置逻辑复制同步数据...&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 切换流量到新集群&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;ansible &amp;lt;cls&amp;gt; -b -a &lt;span style="color:#4e9a06"&gt;&amp;#39;yum upgrade -y postgis36_17*&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;psql -c &lt;span style="color:#4e9a06"&gt;&amp;#39;ALTER EXTENSION postgis UPDATE;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;关于在线迁移的详细流程，请参考 &lt;a href="https://pigsty.cc/docs/pgsql/migration"&gt;&lt;strong&gt;在线迁移&lt;/strong&gt;&lt;/a&gt; 文档。&lt;/p&gt;</description></item><item><title>管理 PostgreSQL 扩展插件</title><link>https://pigsty.cc/docs/pgsql/admin/ext/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/ext/</guid><description>&lt;h2 id="快速上手"&gt;快速上手&lt;/h2&gt;
&lt;p&gt;Pigsty 提供 &lt;a href="https://pgext.cloud/zh/list"&gt;&lt;strong&gt;451 扩展&lt;/strong&gt;&lt;/a&gt;，使用扩展涉及四个步骤：&lt;strong&gt;下载&lt;/strong&gt;、&lt;strong&gt;安装&lt;/strong&gt;、&lt;strong&gt;配置&lt;/strong&gt;、&lt;strong&gt;启用&lt;/strong&gt;。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg-meta&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_seq: 1, pg_role&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;primary } }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_cluster&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg-meta&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_extensions&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;[&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;postgis, timescaledb, pgvector ] &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# &amp;lt;--- 安装扩展软件包&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_libs&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#39;timescaledb, pg_stat_statements, auto_explain&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# &amp;lt;--- 配置预加载扩展&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_databases&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;- &lt;span style="color:#204a87;font-weight:bold"&gt;name&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;meta&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;extensions&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;[&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;postgis, timescaledb, vector ] &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# &amp;lt;--- 在数据库中启用&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;



&lt;ul class="nav nav-tabs" id="tabs-0" role="tablist"&gt;
 &lt;li class="nav-item"&gt;
 &lt;button class="nav-link active"
 id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
 data-td-tp-persist="脚本" aria-controls="tabs-00-00" aria-selected="true"&gt;
 脚本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
 data-td-tp-persist="剧本" aria-controls="tabs-00-01" aria-selected="false"&gt;
 剧本
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
 data-td-tp-persist="示例" aria-controls="tabs-00-02" aria-selected="false"&gt;
 示例
 &lt;/button&gt;
 &lt;/li&gt;
&lt;/ul&gt;

&lt;div class="tab-content" id="tabs-0-content"&gt;
 &lt;div class="tab-body tab-pane fade show active"
 id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-ext &amp;lt;cls&amp;gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 &amp;lt;cls&amp;gt; 集群上安装配置中定义的扩展&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-ext &amp;lt;cls&amp;gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;[&lt;/span&gt;ext...&lt;span style="color:#ce5c00;font-weight:bold"&gt;]&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 &amp;lt;cls&amp;gt; 集群上安装命令行参数给出的扩展&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql.yml -l pg-meta -t pg_ext &lt;span style="color:#8f5902;font-style:italic"&gt;# 使用剧本安装扩展&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-body tab-pane fade"
 id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-ext pg-meta &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 pg-meta 集群上安装定义的扩展&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-ext pg-meta pg_duckdb pg_mooncake &lt;span style="color:#8f5902;font-style:italic"&gt;# 安装指定扩展&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;关于扩展的完整参考，请查阅 &lt;a href="https://pigsty.cc/docs/pgsql/ext/"&gt;&lt;strong&gt;扩展插件&lt;/strong&gt;&lt;/a&gt; 章节。关于可用扩展列表，请参考 &lt;a href="https://pgext.cloud/zh/list"&gt;&lt;strong&gt;扩展目录&lt;/strong&gt;&lt;/a&gt;。&lt;/p&gt;</description></item><item><title>ByteBase：模式迁移</title><link>https://pigsty.cc/docs/app/bytebase/</link><pubDate>Fri, 20 May 2022 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/app/bytebase/</guid><description>&lt;h2 id="bytebase"&gt;ByteBase&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://bytebase.com/"&gt;ByteBase&lt;/a&gt; 是一个进行数据库模式变更的工具，以下命令将在元节点 8887 端口启动一个ByteBase。&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;mkdir -p /data/bytebase/data;
docker run --init --name bytebase --restart always --detach --publish 8887:8887 --volume /data/bytebase/data:/var/opt/bytebase \
 bytebase/bytebase:1.0.4 --data /var/opt/bytebase --host http://ddl.pigsty --port 8887
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;访问 http://10.10.10.10:8887/ 或 &lt;a href="http://ddl.pigsty/"&gt;http://ddl.pigsty&lt;/a&gt; 即可使用 ByteBase，您需要依次创建项目、环境、实例、数据库，即可开始进行模式变更。 公开Demo地址： &lt;a href="http://ddl.pigsty.cc"&gt;http://ddl.pigsty.cc&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;公开Demo地址：&lt;a href="http://ddl.pigsty.cc"&gt;http://ddl.pigsty.cc&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;默认用户名与密码： &lt;code&gt;admin&lt;/code&gt; / &lt;code&gt;pigsty&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src="https://pigsty.cc/img/docs/app/bytebase.jpeg" alt=""&gt;&lt;/p&gt;
&lt;h2 id="bytebase概览"&gt;Bytebase概览&lt;/h2&gt;
&lt;p&gt;Schema Migrator for PostgreSQL&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87"&gt;cd&lt;/span&gt; app/bytebase&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt; make up
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Visit &lt;a href="http://ddl.pigsty"&gt;http://ddl.pigsty&lt;/a&gt; or http://10.10.10.10:8887&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make up &lt;span style="color:#8f5902;font-style:italic"&gt;# pull up bytebase with docker-compose in minimal mode&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make run &lt;span style="color:#8f5902;font-style:italic"&gt;# launch bytebase with docker , local data dir and external PostgreSQL&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make view &lt;span style="color:#8f5902;font-style:italic"&gt;# print bytebase access point&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make log &lt;span style="color:#8f5902;font-style:italic"&gt;# tail -f bytebase logs&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make info &lt;span style="color:#8f5902;font-style:italic"&gt;# introspect bytebase with jq&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make stop &lt;span style="color:#8f5902;font-style:italic"&gt;# stop bytebase container&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make clean &lt;span style="color:#8f5902;font-style:italic"&gt;# remove bytebase container&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make pull &lt;span style="color:#8f5902;font-style:italic"&gt;# pull latest bytebase image&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make rmi &lt;span style="color:#8f5902;font-style:italic"&gt;# remove bytebase image&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make save &lt;span style="color:#8f5902;font-style:italic"&gt;# save bytebase image to /tmp/bytebase.tgz&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;make load &lt;span style="color:#8f5902;font-style:italic"&gt;# load bytebase image from /tmp&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="使用外部的postgresql"&gt;使用外部的PostgreSQL&lt;/h2&gt;
&lt;p&gt;Bytebase use its internal PostgreSQL database by default, You can use external PostgreSQL for higher durability.&lt;/p&gt;</description></item><item><title>PGAdmin：GUI 工具</title><link>https://pigsty.cc/docs/app/pgadmin/</link><pubDate>Mon, 25 Apr 2022 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/app/pgadmin/</guid><description>&lt;p&gt;&lt;a href="https://www.pgadmin.org/"&gt;pgAdmin&lt;/a&gt; 是最受欢迎且功能丰富的 PostgreSQL 开源管理和开发平台，PostgreSQL 是世界上最先进的开源数据库。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="快速开始"&gt;快速开始&lt;/h2&gt;
&lt;p&gt;Pigsty 内置（但可选）支持 pgAdmin，它使用 &lt;a href="https://pigsty.cc/docs/docker"&gt;Docker&lt;/a&gt; Compose 启动 pgadmin：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./docker.yml
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./app.yml -e &lt;span style="color:#000"&gt;app&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;pgadmin
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;pgadmin 的默认端口是 &lt;code&gt;8885&lt;/code&gt;，您可以通过 IP:端口访问它：&lt;code&gt;http://10.10.10.10:8885&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;默认凭据在 &lt;a href="https://github.com/pgsty/pigsty/blob/main/app/pgadmin/.env"&gt;&lt;code&gt;.env&lt;/code&gt;&lt;/a&gt; 中定义，用户名：&lt;code&gt;admin@pigsty.cc&lt;/code&gt;，密码：&lt;code&gt;pigsty&lt;/code&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="自定义"&gt;自定义&lt;/h2&gt;
&lt;p&gt;在 &lt;code&gt;/opt/pgadmin/.env&lt;/code&gt; 中自定义 pgadmin 配置并使用 &lt;code&gt;docker compose&lt;/code&gt; 管理它。&lt;/p&gt;
&lt;p&gt;您还可以自定义 &lt;code&gt;apps&lt;/code&gt; 参数并使用以下方式覆盖默认 &lt;code&gt;.env&lt;/code&gt; 配置：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;all&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;children&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;infra&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;infra_seq&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;docker_enabled&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;true&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;app&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pgadmin &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 指定要安装的应用程序名称（pgadmin）（在 apps 中）&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;apps&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 定义所有应用程序&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pgadmin&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# pgadmin 应用程序的定义&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;conf&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 覆盖 /opt/pgadmin/.env&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;PGADMIN_DEFAULT_EMAIL&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;your@email.com&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;PGADMIN_DEFAULT_PASSWORD&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;yourPassword&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;PGADMIN_LISTEN_ADDRESS&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;0.0.0.0&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;PGADMIN_PORT&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;8885&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;PGADMIN_SERVER_JSON_FILE&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;/pgadmin4/servers.json&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;PGADMIN_REPLACE_SERVERS_ON_STARTUP&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;true&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;要启动应用程序，运行：&lt;/p&gt;</description></item><item><title>日常管理</title><link>https://pigsty.cc/docs/pgsql/admin/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/admin/</guid><description/></item><item><title>备份恢复</title><link>https://pigsty.cc/docs/pgsql/backup/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/backup/</guid><description>&lt;p&gt;Pigsty 使用 &lt;a href="https://pgbackrest.org/"&gt;pgBackRest&lt;/a&gt; 管理 PostgreSQL 备份，这可能是生态系统中最强大的开源备份工具。
它支持增量/并行备份与恢复、加密、&lt;a href="https://pigsty.cc/docs/minio"&gt;MinIO&lt;/a&gt;/S3 等众多特性。Pigsty 默认为每个 &lt;a href="https://pigsty.cc/docs/pgsql"&gt;PGSQL&lt;/a&gt; 集群预配置了备份功能。&lt;/p&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;章节&lt;/th&gt;
 &lt;th&gt;内容&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="https://pigsty.cc/docs/pgsql/backup/mechanism"&gt;机制&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;备份脚本、定时任务、pgbackrest、仓库与管理&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="https://pigsty.cc/docs/pgsql/backup/policy"&gt;策略&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;备份策略、磁盘规划、恢复窗口权衡&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="https://pigsty.cc/docs/pgsql/backup/repository"&gt;仓库&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;配置备份仓库：本地、MinIO、S3&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="https://pigsty.cc/docs/pgsql/backup/admin"&gt;管理&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;常用备份管理命令&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="https://pigsty.cc/docs/pgsql/backup/restore"&gt;恢复&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;使用剧本恢复到特定时间点&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="https://pigsty.cc/docs/pgsql/backup/restore#%E5%88%86%E6%AD%A5%E6%89%A7%E8%A1%8C"&gt;示例&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;沙箱示例：手工执行恢复操作&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;div class="alert alert-warning" role="alert"&gt;&lt;div class="h4 alert-heading" role="heading"&gt;免责声明&lt;/div&gt;
&lt;blockquote&gt;
&lt;p&gt;Pigsty 尽最大努力提供可靠的 PITR 解决方案，但我们不对 PITR 操作导致的数据丢失承担任何责任，使用需自担风险。如需专业支持，请考虑我们的 &lt;a href="https://pigsty.cc/docs/about/service"&gt;专业服务&lt;/a&gt;。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/div&gt;
&lt;hr&gt;
&lt;h2 id="快速上手"&gt;快速上手&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href="https://pigsty.cc/docs/pgsql/backup/mechanism"&gt;备份策略&lt;/a&gt;：使用 Crontab 调度基础备份&lt;/li&gt;
&lt;li&gt;&lt;a href="https://pigsty.cc/docs/pgsql/backup/policy"&gt;WAL 归档&lt;/a&gt;：持续记录写入活动&lt;/li&gt;
&lt;li&gt;&lt;a href="https://pigsty.cc/docs/pgsql/backup/restore"&gt;恢复与还原&lt;/a&gt;：从备份和 WAL 归档中恢复&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;node_crontab&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;[&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#39;00 01 * * * postgres /pg/bin/pg-backup full&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;]&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-pitr.yml -e &lt;span style="color:#4e9a06"&gt;&amp;#39;{&amp;#34;pg_pitr&amp;#34;: { &amp;#34;time&amp;#34;: &amp;#34;2025-07-13 10:00:00+00&amp;#34; }}&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description></item><item><title>故障排查</title><link>https://pigsty.cc/docs/pgsql/tutorial/failure/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/tutorial/failure/</guid><description>&lt;p&gt;本文档列举了 PostgreSQL 和 Pigsty 中可能出现的故障，以及定位、处理、分析问题的 SOP。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="磁盘空间写满"&gt;磁盘空间写满&lt;/h2&gt;
&lt;p&gt;磁盘空间写满是最常见的故障类型。&lt;/p&gt;
&lt;h3 id="现象"&gt;现象&lt;/h3&gt;
&lt;p&gt;当数据库所在磁盘空间耗尽时，PostgreSQL 将无法正常工作，可能出现以下现象：数据库日志反复报错&amp;quot;no space left on device&amp;quot;（磁盘空间不足），
新数据无法写入，甚至 PostgreSQL 可能触发 PANIC 强制关闭。&lt;/p&gt;
&lt;p&gt;Pigsty 带有 NodeFsSpaceFull 告警规则，当文件系统可用空间不足 10% 时触发告警。
使用监控系统 NODE Instance 面板查阅 FS 指标面板定位问题。&lt;/p&gt;
&lt;h3 id="诊断"&gt;诊断&lt;/h3&gt;
&lt;p&gt;您也可以登录数据库节点，使用 &lt;code&gt;df -h&lt;/code&gt; 查看各挂载盘符使用率，确定哪个分区被写满。
对于数据库节点，重点检查以下目录及其大小，以判断是哪个类别的文件占满了空间：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;数据目录&lt;/strong&gt;（&lt;code&gt;/pg/data/base&lt;/code&gt;）：存放表和索引的数据文件，大量写入与临时文件需要关注&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;WAL目录&lt;/strong&gt;（如 &lt;code&gt;pg/data/pg_wal&lt;/code&gt;）：存放 PG WAL，WAL 堆积/复制槽保留是常见的磁盘写满原因。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;数据库日志目录&lt;/strong&gt;（如 &lt;code&gt;pg/log&lt;/code&gt;）：如果 PG 日志未及时轮转写大量报错写入，也可能占用大量空间。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;本地备份目录&lt;/strong&gt;（如 &lt;code&gt;data/backups&lt;/code&gt;）：使用 pgBackRest 等在本机保存备份时，也有可能撑满磁盘。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果问题出在 Pigsty 管理节点或监控节点，还需考虑：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;监控数据&lt;/strong&gt;：VictoriaMetrics 的时序指标和 VictoriaLogs 日志存储都会占用磁盘，可检查保留策略。&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;对象存储数据&lt;/strong&gt;：Pigsty 集成的 MinIO 对象存储可能会被用于 PG 备份保存。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;明确占用空间最大的目录后，可进一步使用 &lt;code&gt;du -sh &amp;lt;目录&amp;gt;&lt;/code&gt; 深入查找特定大型文件或子目录。&lt;/p&gt;</description></item><item><title>误删处理</title><link>https://pigsty.cc/docs/pgsql/tutorial/drop/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/tutorial/drop/</guid><description>&lt;h2 id="误删数据"&gt;误删数据&lt;/h2&gt;
&lt;p&gt;如果是小批量 &lt;code&gt;DELETE&lt;/code&gt; 误操作，可以考虑使用 &lt;a href="https://pgext.cloud/e/pg_surgery"&gt;&lt;code&gt;pg_surgery&lt;/code&gt;&lt;/a&gt; 或者 &lt;a href="https://pgext.cloud/e/pg_dirtyread"&gt;&lt;code&gt;pg_dirtyread&lt;/code&gt;&lt;/a&gt; 扩展进行原地手术恢复。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-sql" data-lang="sql"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;-- 立即关闭此表上的 Auto Vacuum 并中止 Auto Vacuum 本表的 worker 进程
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;ALTER&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;TABLE&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;public&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;.&lt;/span&gt;&lt;span style="color:#000"&gt;some_table&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;SET&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;(&lt;/span&gt;&lt;span style="color:#000"&gt;autovacuum_enabled&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;off&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;,&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;toast&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;.&lt;/span&gt;&lt;span style="color:#000"&gt;autovacuum_enabled&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;off&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;);&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;CREATE&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;EXTENSION&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg_dirtyread&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;SELECT&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;*&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;FROM&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg_dirtyread&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;(&lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#39;tablename&amp;#39;&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;)&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;AS&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;t&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;(&lt;/span&gt;&lt;span style="color:#000"&gt;col1&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;type1&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;,&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;col2&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;type2&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;,&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;...);&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;如果被删除的数据已经被 VACUUM 回收，那么使用通用的误删处理流程。&lt;/p&gt;
&lt;h2 id="误删对象"&gt;误删对象&lt;/h2&gt;
&lt;p&gt;当出现 &lt;code&gt;DROP/DELETE&lt;/code&gt; 类误操作，通常按照以下流程决定恢复方案。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;确认此数据是否可以通过业务系统或其他数据系统找回，如果可以，直接从业务侧修复。&lt;/li&gt;
&lt;li&gt;确认是否有延迟从库，如果有，推进延迟从库至误删时间点，查询出来恢复。&lt;/li&gt;
&lt;li&gt;如果数据已经确认删除，确认备份信息，恢复范围是否覆盖误删时间点，如果覆盖，开始 PITR&lt;/li&gt;
&lt;li&gt;确认是整集群原地 &lt;a href="https://pigsty.cc/docs/pgsql/backup/restore"&gt;PITR 回滚&lt;/a&gt;，还是新开服务器重放，还是用从库来重放，并执行恢复策略&lt;/li&gt;
&lt;/ol&gt;
&lt;h2 id="误删集群"&gt;误删集群&lt;/h2&gt;
&lt;p&gt;如果出现整个数据库集群通过 Pigsty 管理命令被误删的情况，例如错误的执行 &lt;a href="https://pigsty.cc/docs/pgsql/playbook#pgsql-rmyml"&gt;&lt;code&gt;pgsql-rm.yml&lt;/code&gt;&lt;/a&gt; 剧本或 &lt;code&gt;bin/pgsql-rm&lt;/code&gt; 命令。
除非您指定了 &lt;a href="https://pigsty.cc/docs/pgsql/param#pg_rm_backup"&gt;&lt;code&gt;pg_rm_backup&lt;/code&gt;&lt;/a&gt; 参数为 &lt;code&gt;false&lt;/code&gt;，否则备份会与数据库集群一起被删除。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;警告&lt;/strong&gt;：在这种情况，您的数据将无法找回！&lt;strong&gt;请务必三思而后行！&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;建议：对于生产环境，您可以在配置清单中全局配置此参数为 &lt;code&gt;false&lt;/code&gt;，在移除集群时保留备份。&lt;/p&gt;</description></item><item><title>数据迁移</title><link>https://pigsty.cc/docs/pgsql/migration/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/migration/</guid><description>&lt;p&gt;Pigsty 内置了一个剧本 &lt;a href="https://github.com/Vonng/pigsty/blob/main/pgsql-migration.yml"&gt;&lt;code&gt;pgsql-migration.yml&lt;/code&gt;&lt;/a&gt; ，基于逻辑复制来实现在线数据库迁移。&lt;/p&gt;
&lt;p&gt;通过预生成的自动化脚本，应用停机时间可以缩减到几秒内。但请注意，逻辑复制需要 PostgreSQL 10 以上的版本才能工作。&lt;/p&gt;
&lt;p&gt;当然如果您有充足的停机时间预算，那么总是可以使用 &lt;code&gt;pg_dump | psql&lt;/code&gt; 的方式进行停机迁移。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="定义迁移任务"&gt;定义迁移任务&lt;/h2&gt;
&lt;p&gt;想要使用Pigsty提供的在线迁移剧本，您需要创建一个定义文件，来描述迁移任务的细节。&lt;/p&gt;
&lt;p&gt;请查看任务定义文件示例作为参考： &lt;a href="https://github.com/Vonng/pigsty/blob/main/files/migration/pg-meta.yml"&gt;&lt;code&gt;files/migration/pg-meta.yml&lt;/code&gt;&lt;/a&gt; 。&lt;/p&gt;
&lt;p&gt;这个迁移任务要将 &lt;code&gt;pg-meta.meta&lt;/code&gt; 在线迁移到 &lt;code&gt;pg-test.test&lt;/code&gt;，前者称为 &lt;strong&gt;源集群（SRC）&lt;/strong&gt;， 后者称为 &lt;strong&gt;宿集群（DST）&lt;/strong&gt;。&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;pg-meta-1	10.10.10.10 --&amp;gt; pg-test-1	10.10.10.11 (10.10.10.12,10.10.10.13)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;基于逻辑复制的迁移以数据库为单位，您需要指定需要迁移的数据库名称，以及数据库源宿集群主节点的 IP 地址，以及超级用户的连接信息。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#000"&gt;---&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#-----------------------------------------------------------------&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# PG_MIGRATION&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#-----------------------------------------------------------------&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;context_dir&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;~/migration &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 迁移手册 &amp;amp; 脚本的放置目录&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#-----------------------------------------------------------------&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# SRC Cluster (旧集群)&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#-----------------------------------------------------------------&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;src_cls&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg-meta &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 源集群名称 &amp;lt;必填&amp;gt;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;src_db&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;meta &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 源数据库名称 &amp;lt;必填&amp;gt;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;src_ip&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 源集群主 IP &amp;lt;必填&amp;gt;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#src_pg: &amp;#39;&amp;#39; # 如果定义，使用此作为源 dbsu pgurl 代替：&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# # postgres://{{ pg_admin_username }}@{{ src_ip }}/{{ src_db }}&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# # 例如: &amp;#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.10:5432/meta&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#sub_conn: &amp;#39;&amp;#39; # 如果定义，使用此作为订阅连接字符串代替：&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# # host={{ src_ip }} dbname={{ src_db }} user={{ pg_replication_username }}&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# # 例如: &amp;#39;host=10.10.10.10 dbname=meta user=replicator password=DBUser.Replicator&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#-----------------------------------------------------------------&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# DST Cluster (新集群)&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#-----------------------------------------------------------------&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;dst_cls&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg-test &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 宿集群名称 &amp;lt;必填&amp;gt;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;dst_db&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;test &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 宿数据库名称 &amp;lt;必填&amp;gt;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;dst_ip&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;10.10.10.11&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 宿集群主 IP &amp;lt;必填&amp;gt;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#dst_pg: &amp;#39;&amp;#39; # 如果定义，使用此作为目标 dbsu pgurl 代替：&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# # postgres://{{ pg_admin_username }}@{{ dst_ip }}/{{ dst_db }}&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# # 例如: &amp;#39;postgres://dbuser_dba:DBUser.DBA@10.10.10.11:5432/test&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#-----------------------------------------------------------------&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# PGSQL&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#-----------------------------------------------------------------&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_dbsu&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;postgres&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_replication_username&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;replicator&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_replication_password&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;DBUser.Replicator&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_admin_username&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;dbuser_dba&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_admin_password&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;DBUser.DBA&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_monitor_username&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;dbuser_monitor&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_monitor_password&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;DBUser.Monitor&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;#-----------------------------------------------------------------&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#000"&gt;...&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;默认情况下，源宿集群两侧的超级用户连接串会使用全局的管理员用户和各自主库的 IP 地址拼接而成，但您总是可以通过 &lt;code&gt;src_pg&lt;/code&gt; 和 &lt;code&gt;dst_pg&lt;/code&gt; 参数来覆盖这些默认值。
同理，您也可以通过 &lt;code&gt;sub_conn&lt;/code&gt; 参数来覆盖订阅连接串的默认值。&lt;/p&gt;</description></item><item><title>备份策略</title><link>https://pigsty.cc/docs/pgsql/backup/policy/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/backup/policy/</guid><description>&lt;p&gt;下图将“恢复窗口”与“存储空间占用”合并到同一时间轴（&lt;code&gt;0~108h&lt;/code&gt;）中，便于一起观察。&lt;/p&gt;
&lt;p&gt;在相同假设（数据库 &lt;code&gt;100GB&lt;/code&gt;、日写入 &lt;code&gt;10GB&lt;/code&gt;）下，下图展示“每 7 天全量 + 每日增量、全量保留 14 天”时，30 天内恢复窗口与存储占用变化。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;何时&lt;/strong&gt;：备份策略&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;何处&lt;/strong&gt;：备份仓库&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;如何&lt;/strong&gt;：备份方法&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="何时备份"&gt;何时备份&lt;/h2&gt;
&lt;p&gt;第一个问题是&lt;strong&gt;何时&lt;/strong&gt;备份您的数据库——这是备份频率和恢复时间之间的权衡。
由于您需要从上一次备份开始重放 WAL 日志到恢复目标点，备份越频繁，需要重放的 WAL 日志就越少，恢复速度就越快。&lt;/p&gt;
&lt;h3 id="每日全量备份"&gt;每日全量备份&lt;/h3&gt;
&lt;p&gt;对于生产数据库，建议从最简单的每日全量备份策略开始。
这也是 Pigsty 的默认备份策略，通过 &lt;a href="https://pigsty.cc/docs/pgsql/backup/mechanism#%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD"&gt;crontab&lt;/a&gt; 实现。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_crontab&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;[&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#39;00 01 * * * /pg/bin/pg-backup full&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;]&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pgbackrest_method&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;local &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 选择备份仓库方法：`local`、`minio` 或其他自定义仓库&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pgbackrest_repo: # pgbackrest 仓库配置&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;https://pgbackrest.org/configuration.html#section-repository&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;local&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 使用本地 POSIX 文件系统的默认 pgbackrest 仓库&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;path&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;/pg/backup &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 本地备份目录，默认为 `/pg/backup`&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;retention_full_type&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;count &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 按数量保留全量备份&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;retention_full&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;2&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 使用本地文件系统仓库时，保留2个，最多3个全量备份&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;假设您的数据库大小为 100GB，每天更新写入 10GB 数据，备份耗时1小时，那么在每日全量备份，使用本地仓库的策略下，恢复窗口与备份空间随时间的变化如下图所示：&lt;/p&gt;</description></item><item><title>备份机制</title><link>https://pigsty.cc/docs/pgsql/backup/mechanism/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/backup/mechanism/</guid><description>&lt;p&gt;备份可以通过内置 &lt;a href="#%E8%84%9A%E6%9C%AC"&gt;脚本&lt;/a&gt; 调用，使用节点 &lt;a href="#%E5%AE%9A%E6%97%B6%E5%A4%87%E4%BB%BD"&gt;crontab&lt;/a&gt; 定时执行，
由 &lt;a href="https://pgbackrest.org/"&gt;pgbackrest&lt;/a&gt; 管理，存储在备份仓库中，
仓库可以是本地磁盘文件系统或 MinIO / S3，并支持不同的 &lt;a href="https://pigsty.cc/docs/pgsql/backup/repository#%E4%BB%93%E5%BA%93%E4%BF%9D%E7%95%99%E7%AD%96%E7%95%A5"&gt;保留&lt;/a&gt; 策略。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="脚本"&gt;脚本&lt;/h2&gt;
&lt;p&gt;您可以使用 &lt;a href="https://pigsty.cc/docs/pgsql/param#pg_dbsu"&gt;&lt;code&gt;pg_dbsu&lt;/code&gt;&lt;/a&gt; 用户（默认为 &lt;code&gt;postgres&lt;/code&gt;）执行 &lt;code&gt;pgbackrest&lt;/code&gt; 命令创建备份：&lt;/p&gt;







&lt;ul class="nav nav-tabs" id="tabs-0" role="tablist"&gt;
 &lt;li class="nav-item"&gt;
 &lt;button class="nav-link disabled"
 id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
 aria-controls="tabs-00-00" aria-selected="false"&gt;
 备份命令
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link active"
 id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
 aria-controls="tabs-00-01" aria-selected="true"&gt;
 backup
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
 aria-controls="tabs-00-02" aria-selected="false"&gt;
 full
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
 aria-controls="tabs-00-03" aria-selected="false"&gt;
 diff
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
 aria-controls="tabs-00-04" aria-selected="false"&gt;
 incr
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-05-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-05" role="tab"
 aria-controls="tabs-00-05" aria-selected="false"&gt;
 info
 &lt;/button&gt;
 &lt;/li&gt;
&lt;/ul&gt;

&lt;div class="tab-content" id="tabs-0-content"&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0"&gt;
 &lt;pre tabindex="0"&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade show active"
 id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pgbackrest --stanza&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;pg-meta --type&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;full backup &lt;span style="color:#8f5902;font-style:italic"&gt;# 为集群 pg-meta 创建全量备份&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ pgbackrest --stanza&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;pg-meta --type&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;full backup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:36:57.007 P00 INFO: backup &lt;span style="color:#204a87"&gt;command&lt;/span&gt; begin 2.54.2: --annotation&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#000"&gt;pg_cluster&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;pg-meta ...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:36:57.030 P00 INFO: execute non-exclusive backup start: backup begins after the requested immediate checkpoint completes
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:36:57.105 P00 INFO: backup start &lt;span style="color:#000"&gt;archive&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 000000010000000000000006, &lt;span style="color:#000"&gt;lsn&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 0/6000028
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:36:58.540 P00 INFO: new backup &lt;span style="color:#000"&gt;label&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 20250715-013657F
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:36:58.588 P00 INFO: full backup &lt;span style="color:#000"&gt;size&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 44.5MB, file &lt;span style="color:#000"&gt;total&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; &lt;span style="color:#0000cf;font-weight:bold"&gt;1437&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:36:58.589 P00 INFO: backup &lt;span style="color:#204a87"&gt;command&lt;/span&gt; end: completed successfully &lt;span style="color:#ce5c00;font-weight:bold"&gt;(&lt;/span&gt;1584ms&lt;span style="color:#ce5c00;font-weight:bold"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ pgbackrest --stanza&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;pg-meta --type&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;diff backup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:24.952 P00 INFO: backup &lt;span style="color:#204a87"&gt;command&lt;/span&gt; begin 2.54.2: ...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:24.985 P00 INFO: last backup &lt;span style="color:#000"&gt;label&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 20250715-013657F, &lt;span style="color:#000"&gt;version&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 2.54.2
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:26.337 P00 INFO: new backup &lt;span style="color:#000"&gt;label&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 20250715-013657F_20250715-013724D
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:26.381 P00 INFO: diff backup &lt;span style="color:#000"&gt;size&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 424.3KB, file &lt;span style="color:#000"&gt;total&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; &lt;span style="color:#0000cf;font-weight:bold"&gt;1437&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:26.381 P00 INFO: backup &lt;span style="color:#204a87"&gt;command&lt;/span&gt; end: completed successfully &lt;span style="color:#ce5c00;font-weight:bold"&gt;(&lt;/span&gt;1431ms&lt;span style="color:#ce5c00;font-weight:bold"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ pgbackrest --stanza&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;pg-meta --type&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;incr backup
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:30.305 P00 INFO: backup &lt;span style="color:#204a87"&gt;command&lt;/span&gt; begin 2.54.2: ...
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:30.337 P00 INFO: last backup &lt;span style="color:#000"&gt;label&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 20250715-013657F_20250715-013724D, &lt;span style="color:#000"&gt;version&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 2.54.2
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:31.356 P00 INFO: new backup &lt;span style="color:#000"&gt;label&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 20250715-013657F_20250715-013730I
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:31.403 P00 INFO: incr backup &lt;span style="color:#000"&gt;size&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; 8.3KB, file &lt;span style="color:#000"&gt;total&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt; &lt;span style="color:#0000cf;font-weight:bold"&gt;1437&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;2025-07-15 01:37:31.403 P00 INFO: backup &lt;span style="color:#204a87"&gt;command&lt;/span&gt; end: completed successfully &lt;span style="color:#ce5c00;font-weight:bold"&gt;(&lt;/span&gt;1099ms&lt;span style="color:#ce5c00;font-weight:bold"&gt;)&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-05" role="tabpanel" aria-labelled-by="tabs-00-05-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;$ pgbackrest --stanza&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;pg-meta info
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;stanza: pg-meta
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; status: ok
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; cipher: aes-256-cbc
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; db &lt;span style="color:#ce5c00;font-weight:bold"&gt;(&lt;/span&gt;current&lt;span style="color:#ce5c00;font-weight:bold"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; wal archive min/max &lt;span style="color:#ce5c00;font-weight:bold"&gt;(&lt;/span&gt;17&lt;span style="color:#ce5c00;font-weight:bold"&gt;)&lt;/span&gt;: 000000010000000000000001/00000001000000000000000A
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; full backup: 20250715-013657F
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; timestamp start/stop: 2025-07-15 01:36:57+00 / 2025-07-15 01:36:58+00
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; wal start/stop: &lt;span style="color:#0000cf;font-weight:bold"&gt;000000010000000000000006&lt;/span&gt; / &lt;span style="color:#0000cf;font-weight:bold"&gt;000000010000000000000006&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; database size: 44.5MB, database backup size: 44.5MB
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; repo1: backup size: 8.7MB
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; diff backup: 20250715-013657F_20250715-013724D
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; timestamp start/stop: 2025-07-15 01:37:24+00 / 2025-07-15 01:37:26+00
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; database size: 44.5MB, database backup size: 424.3KB
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; repo1: backup size: 94KB
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; backup reference total: &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt; full
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; incr backup: 20250715-013657F_20250715-013730I
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; timestamp start/stop: 2025-07-15 01:37:30+00 / 2025-07-15 01:37:31+00
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; database size: 44.5MB, database backup size: 8.3KB
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; repo1: backup size: 504B
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; backup reference total: &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt; full, &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt; diff&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;这里的 &lt;code&gt;stanza&lt;/code&gt; 是数据库集群名称：&lt;a href="https://pigsty.cc/docs/pgsql/param#pg_cluster"&gt;&lt;code&gt;pg_cluster&lt;/code&gt;&lt;/a&gt;，在默认配置中为 &lt;code&gt;pg-meta&lt;/code&gt;。&lt;/p&gt;</description></item><item><title>备份仓库</title><link>https://pigsty.cc/docs/pgsql/backup/repository/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/backup/repository/</guid><description>&lt;p&gt;您可以通过指定 &lt;a href="https://pigsty.cc/docs/pgsql/param/#pgbackrest_repo"&gt;&lt;code&gt;pgbackrest_repo&lt;/code&gt;&lt;/a&gt; 参数来配置备份&lt;strong&gt;存储位置&lt;/strong&gt;。
您可以在此定义多个仓库，Pigsty 会根据 &lt;a href="https://pigsty.cc/docs/pgsql/param/#pgbackrest_method"&gt;&lt;code&gt;pgbackrest_method&lt;/code&gt;&lt;/a&gt; 的值选择使用哪个。&lt;/p&gt;
&lt;h2 id="默认仓库"&gt;默认仓库&lt;/h2&gt;
&lt;p&gt;默认情况下，Pigsty 提供两个默认备份仓库定义：&lt;code&gt;local&lt;/code&gt; 和 &lt;code&gt;minio&lt;/code&gt; 备份仓库。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;local&lt;/code&gt;：&lt;strong&gt;默认选项&lt;/strong&gt;，使用本地 &lt;code&gt;/pg/backup&lt;/code&gt; 目录（软链接指向 &lt;a href="https://pigsty.cc/docs/pgsql/param/#pg_fs_backup"&gt;&lt;code&gt;pg_fs_backup&lt;/code&gt;&lt;/a&gt;：&lt;code&gt;/data/backups&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio&lt;/code&gt;：使用 SNSD 单节点 MinIO 集群（Pigsty 支持，但默认不启用）&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pgbackrest_method&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;local &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 选择备份仓库方法：`local`、`minio` 或其他自定义仓库&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pgbackrest_repo: # pgbackrest 仓库配置&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;https://pgbackrest.org/configuration.html#section-repository&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;local&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 使用本地 POSIX 文件系统的默认 pgbackrest 仓库&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;path&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;/pg/backup &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 本地备份目录，默认为 `/pg/backup`&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;retention_full_type&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;count &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 按数量保留全量备份&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;retention_full&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;2&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 使用本地文件系统仓库时，保留2个，最多3个全量备份&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;minio&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 可选的 minio 仓库&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;type&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;s3 &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# minio 兼容 S3 协议&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;s3_endpoint&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;sss.pigsty &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# minio 端点域名，默认为 `sss.pigsty`&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;s3_region&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;us-east-1 &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# minio 区域，默认 us-east-1，对 minio 无实际意义&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;s3_bucket&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pgsql &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# minio 桶名，默认为 `pgsql`&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;s3_key&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pgbackrest &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# pgbackrest 的 minio 用户访问密钥&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;s3_key_secret&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;S3User.Backup &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# pgbackrest 的 minio 用户密钥&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;s3_uri_style&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;path &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# minio 使用路径风格 URI 而非主机风格&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;path&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;/pgbackrest &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# minio 备份路径，默认为 `/pgbackrest`&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;storage_port&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;9000&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# minio 端口，默认 9000&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;storage_ca_file&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;/etc/pki/ca.crt &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# minio CA 证书路径，默认 `/etc/pki/ca.crt`&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;block&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;y&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 启用块级增量备份&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;bundle&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;y&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 将小文件打包成单个文件&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;bundle_limit&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;20MiB &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 文件包大小限制，对象存储建议 20MiB&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;bundle_size&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;128MiB &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 文件包目标大小，对象存储建议 128MiB&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;cipher_type&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;aes-256-cbc &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 为远程备份仓库启用 AES 加密&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;cipher_pass&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pgBackRest &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# AES 加密密码，默认为 &amp;#39;pgBackRest&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;retention_full_type&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;time &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 按时间保留全量备份&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;retention_full&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;14&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 保留最近 14 天的全量备份&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="仓库保留策略"&gt;仓库保留策略&lt;/h2&gt;
&lt;p&gt;如果每天备份但不删除旧备份，备份仓库会不断增长并耗尽磁盘空间。
您需要定义保留策略，只保留有限数量的备份。&lt;/p&gt;</description></item><item><title>管理命令</title><link>https://pigsty.cc/docs/pgsql/backup/admin/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/backup/admin/</guid><description>&lt;h2 id="启用备份"&gt;启用备份&lt;/h2&gt;
&lt;p&gt;如果数据库集群创建时 &lt;a href="https://pigsty.cc/docs/pgsql/param/#pgbackrest_enabled"&gt;&lt;code&gt;pgbackrest_enabled&lt;/code&gt;&lt;/a&gt; 设置为 &lt;code&gt;true&lt;/code&gt;，备份将自动启用。&lt;/p&gt;
&lt;p&gt;如果创建时该值为 &lt;code&gt;false&lt;/code&gt;，您可以使用以下命令启用 pgbackrest 组件：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql.yml -t pg_backup &lt;span style="color:#8f5902;font-style:italic"&gt;# 运行 pgbackrest 子任务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="删除备份"&gt;删除备份&lt;/h2&gt;
&lt;p&gt;当移除主实例（&lt;a href="https://pigsty.cc/docs/pgsql/param/#pg_role"&gt;&lt;code&gt;pg_role&lt;/code&gt;&lt;/a&gt; = &lt;code&gt;primary&lt;/code&gt;）时，Pigsty 会删除 pgbackrest 备份 stanza。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-rm.yml
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-rm.yml -e &lt;span style="color:#000"&gt;pg_rm_backup&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#204a87"&gt;false&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 保留备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-rm.yml -t pg_backup &lt;span style="color:#8f5902;font-style:italic"&gt;# 仅删除备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用 &lt;code&gt;pg_backup&lt;/code&gt; 子任务仅删除备份，使用 &lt;a href="https://pigsty.cc/docs/pgsql/param/#pg_rm_backup"&gt;&lt;code&gt;pg_rm_backup&lt;/code&gt;&lt;/a&gt; 参数（设为 &lt;code&gt;false&lt;/code&gt;）保留备份。&lt;/p&gt;
&lt;p&gt;如果您的备份仓库被&lt;strong&gt;锁定&lt;/strong&gt;（例如 S3 / MinIO 有锁定选项），此操作将失败。&lt;/p&gt;
&lt;div class="alert alert-warning" role="alert"&gt;&lt;div class="h4 alert-heading" role="heading"&gt;备份删除&lt;/div&gt;
&lt;p&gt;删除备份可能导致永久性数据丢失，这是一个危险操作，请务必谨慎。&lt;/p&gt;
&lt;/div&gt;
&lt;hr&gt;
&lt;h2 id="列出备份"&gt;列出备份&lt;/h2&gt;
&lt;p&gt;此命令将列出 pgbackrest 仓库中的所有备份（所有集群共享）&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pgbackrest info
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="手动备份"&gt;手动备份&lt;/h2&gt;
&lt;p&gt;Pigsty 提供了内置脚本 &lt;code&gt;/pg/bin/pg-backup&lt;/code&gt;，封装了 &lt;code&gt;pgbackrest&lt;/code&gt; 备份命令。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-backup &lt;span style="color:#8f5902;font-style:italic"&gt;# 执行增量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-backup full &lt;span style="color:#8f5902;font-style:italic"&gt;# 执行全量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-backup incr &lt;span style="color:#8f5902;font-style:italic"&gt;# 执行增量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-backup diff &lt;span style="color:#8f5902;font-style:italic"&gt;# 执行差异备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="基础备份"&gt;基础备份&lt;/h2&gt;
&lt;p&gt;Pigsty 提供了一个替代备份脚本 &lt;code&gt;/pg/bin/pg-basebackup&lt;/code&gt;，它不依赖 &lt;code&gt;pgbackrest&lt;/code&gt;，直接提供数据库集群的物理副本。
默认备份目录为 &lt;code&gt;/pg/backup&lt;/code&gt;。&lt;/p&gt;</description></item><item><title>恢复操作</title><link>https://pigsty.cc/docs/pgsql/backup/restore/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/backup/restore/</guid><description>&lt;p&gt;您可以使用预配置的 pgbackrest 在 Pigsty 中执行时间点恢复（PITR）。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B"&gt;&lt;strong&gt;剧本方式&lt;/strong&gt;&lt;/a&gt;：使用 &lt;code&gt;pgsql-pitr.yml&lt;/code&gt; 剧本自动执行 PITR&lt;/li&gt;
&lt;li&gt;&lt;a href="https://pigsty.cc/docs/pgsql/tutorial/pg-fork#pg-pitr"&gt;&lt;strong&gt;手动方式&lt;/strong&gt;&lt;/a&gt;：使用 &lt;code&gt;pg-pitr&lt;/code&gt; 脚本手动执行 PITR&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="快速上手"&gt;快速上手&lt;/h2&gt;
&lt;p&gt;如果您想将 &lt;code&gt;pg-meta&lt;/code&gt; 集群回滚到之前的时间点，添加 &lt;code&gt;pg_pitr&lt;/code&gt; 参数：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg-meta&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_seq: 1, pg_role&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;primary } }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_cluster&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg-meta2&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_pitr&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;time&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#39;2025-07-13 10:00:00+00&amp;#39;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 从最新备份恢复&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;然后运行 &lt;code&gt;pgsql-pitr.yml&lt;/code&gt; 剧本，它将把 &lt;code&gt;pg-meta&lt;/code&gt; 集群回滚到指定时间点。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-pitr.yml -l pg-meta
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="恢复后处理"&gt;恢复后处理&lt;/h2&gt;
&lt;p&gt;恢复后的集群会&lt;strong&gt;禁用&lt;/strong&gt; &lt;code&gt;archive_mode&lt;/code&gt;，以防止意外的 WAL 写入。
如果恢复后的数据库状态正常，您可以启用 &lt;code&gt;archive_mode&lt;/code&gt; 并执行全量备份。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;psql -c &lt;span style="color:#4e9a06"&gt;&amp;#39;ALTER SYSTEM RESET archive_mode; SELECT pg_reload_conf();&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-backup full &lt;span style="color:#8f5902;font-style:italic"&gt;# 执行新的全量备份&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="恢复目标"&gt;恢复目标&lt;/h2&gt;
&lt;p&gt;您可以在 &lt;code&gt;pg_pitr&lt;/code&gt; 中指定不同类型的恢复目标，但它们是互斥的：&lt;/p&gt;</description></item><item><title>手工恢复</title><link>https://pigsty.cc/docs/pgsql/tutorial/pitr/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/tutorial/pitr/</guid><description>&lt;p&gt;您可以使用 &lt;code&gt;pgsql-pitr.yml&lt;/code&gt; 剧本执行 PITR，但在某些情况下，您可能希望手动执行 PITR，直接使用 pgbackrest 原语实现精细的控制。
我们将使用带有 MinIO 备份仓库的 &lt;a href="https://pigsty.cc/docs/deploy/sandbox"&gt;&lt;strong&gt;四节点沙箱&lt;/strong&gt;&lt;/a&gt; 集群来演示该过程。&lt;/p&gt;
&lt;p&gt;&lt;img src="https://pigsty.cc/img/pigsty/sandbox.png" alt="pigsty-sandbox"&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="初始化沙箱"&gt;初始化沙箱&lt;/h2&gt;
&lt;p&gt;使用 &lt;a href="https://pigsty.cc/docs/deploy/vagrant"&gt;&lt;strong&gt;vagrant&lt;/strong&gt;&lt;/a&gt; 或 &lt;a href="https://pigsty.cc/docs/deploy/terraform"&gt;&lt;strong&gt;terraform&lt;/strong&gt;&lt;/a&gt; 准备四节点沙箱环境，然后：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl https://repo.pigsty.io/get &lt;span style="color:#000;font-weight:bold"&gt;|&lt;/span&gt; bash&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt; &lt;span style="color:#204a87"&gt;cd&lt;/span&gt; ~/pigsty/
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./configure -c full
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./install
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;现在以管理节点上的管理员用户（或 dbsu）身份操作。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="检查备份"&gt;检查备份&lt;/h2&gt;
&lt;p&gt;要检查备份状态，您需要切换到 &lt;code&gt;postgres&lt;/code&gt; 用户并使用 &lt;code&gt;pb&lt;/code&gt; 命令：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo su - postgres &lt;span style="color:#8f5902;font-style:italic"&gt;# 切换到 dbsu: postgres 用户&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pb info &lt;span style="color:#8f5902;font-style:italic"&gt;# 打印 pgbackrest 备份信息&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;pb&lt;/code&gt; 是 &lt;code&gt;pgbackrest&lt;/code&gt; 的别名，会自动从 pgbackrest 配置中获取 &lt;code&gt;stanza&lt;/code&gt; 名称。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;function&lt;/span&gt; pb&lt;span style="color:#ce5c00;font-weight:bold"&gt;()&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#204a87"&gt;local&lt;/span&gt; &lt;span style="color:#000"&gt;stanza&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;$(&lt;/span&gt;grep -o &lt;span style="color:#4e9a06"&gt;&amp;#39;\[[^][]*]&amp;#39;&lt;/span&gt; /etc/pgbackrest/pgbackrest.conf &lt;span style="color:#000;font-weight:bold"&gt;|&lt;/span&gt; head -n1 &lt;span style="color:#000;font-weight:bold"&gt;|&lt;/span&gt; sed &lt;span style="color:#4e9a06"&gt;&amp;#39;s/.*\[\([^]]*\)].*/\1/&amp;#39;&lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; pgbackrest --stanza&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#000"&gt;$stanza&lt;/span&gt; &lt;span style="color:#000"&gt;$@&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;您可以看到初始备份信息，这是一个全量备份：&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;root@pg-meta-1:~# pb info
stanza: pg-meta
 status: ok
 cipher: aes-256-cbc

 db (current)
 wal archive min/max (17): 000000010000000000000001/000000010000000000000007

 full backup: 20250713-022731F
 timestamp start/stop: 2025-07-13 02:27:31+00 / 2025-07-13 02:27:33+00
 wal start/stop: 000000010000000000000004 / 000000010000000000000004
 database size: 44MB, database backup size: 44MB
 repo1: backup size: 8.4MB
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;备份完成于 &lt;code&gt;2025-07-13 02:27:33+00&lt;/code&gt;，这是您可以恢复到的最早时间。
由于 WAL 归档处于活动状态，您可以恢复到备份之后的任何时间点，直到 WAL 结束（即现在）。&lt;/p&gt;</description></item><item><title>克隆数据库集群</title><link>https://pigsty.cc/docs/pgsql/backup/cluster/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/backup/cluster/</guid><description>&lt;h2 id="快速上手"&gt;快速上手&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;利用 Standby Cluster 创建现有集群的在线副本&lt;/li&gt;
&lt;li&gt;利用 PITR 创建现有集群的时间点快照&lt;/li&gt;
&lt;li&gt;在 PITR 完成后进行善后，确保新集群的备份流程正常运行&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;您可以使用 PG PITR 机制克隆整个数据库集群。&lt;/p&gt;
&lt;h2 id="重置一个集群的状态"&gt;重置一个集群的状态&lt;/h2&gt;
&lt;p&gt;您也可以考虑创建一个全新的空集群，然后利用 PITR，将其重置为 &lt;code&gt;pg-meta&lt;/code&gt; 集群的特定状态。&lt;/p&gt;
&lt;p&gt;利用这种技术，您可以将现有集群 &lt;code&gt;pg-meta&lt;/code&gt; 的任意时间点（备份保留期内）状态克隆到一个新的集群中。&lt;/p&gt;
&lt;p&gt;我们依然以 Pigsty 4 节点沙箱环境为例，使用以下命令将 &lt;code&gt;pg-test&lt;/code&gt; 集群重置为 &lt;code&gt;pg-meta&lt;/code&gt; 集群的最新状态：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-pitr.yml -l pg-test -e &lt;span style="color:#4e9a06"&gt;&amp;#39;{&amp;#34;pg_pitr&amp;#34;: { &amp;#34;cluster&amp;#34;: &amp;#34;pg-meta&amp;#34; }}&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id="pitr-善后工作"&gt;PITR 善后工作&lt;/h2&gt;
&lt;p&gt;当你使用 PITR 恢复一个集群后，这个新集群本身的 PITR 功能是被禁用的。
因为如果它也尝试去生成备份，归档 WAL，有可能会写脏数据之前集群的备份仓库。&lt;/p&gt;
&lt;p&gt;因此，当你确认这个 PITR 恢复出来的新集群状态符合预期后，你需要执行以下善后工作。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;升级备份仓库 Stanza，允许它接纳来自不同集群的新备份（仅当从别的集群恢复时）。&lt;/li&gt;
&lt;li&gt;启用 &lt;code&gt;archive_mode&lt;/code&gt;，允许新集群归档 WAL 日志（需要重启集群）&lt;/li&gt;
&lt;li&gt;执行一个新的全量备份，确保新集群的数据被纳入（可选，也可以等 crontab 定时执行）&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pb stanza-upgrade
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;psql -c &lt;span style="color:#4e9a06"&gt;&amp;#39;ALTER SYSTEM RESET archive_mode;&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-backup full
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;通过这些操作，你的新集群将从第一次全量备份开始时，拥有自己的备份历史。
如果你跳过这些步骤，新集群本身的备份将无法进行，WAL 归档也不会生效。
意味着你将无法对新集群执行任何备份或 PITR 操作。&lt;/p&gt;</description></item><item><title>利用 xfs 实现实例 Fork</title><link>https://pigsty.cc/docs/pgsql/tutorial/pg-fork/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/tutorial/pg-fork/</guid><description>&lt;p&gt;Pigsty 提供了两个实用脚本，用于在同一台机器上快速克隆实例并执行时间点恢复：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#pg-fork"&gt;&lt;code&gt;pg-fork&lt;/code&gt;&lt;/a&gt;：在同一台机器上快速克隆一个新的 PostgreSQL 实例&lt;/li&gt;
&lt;li&gt;&lt;a href="#pg-pitr"&gt;&lt;code&gt;pg-pitr&lt;/code&gt;&lt;/a&gt;：使用 pgbackrest 手动执行时间点恢复&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这两个脚本可以配合使用：先用 &lt;code&gt;pg-fork&lt;/code&gt; 克隆实例，再用 &lt;code&gt;pg-pitr&lt;/code&gt; 将克隆实例恢复到指定时间点。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="pg-fork"&gt;pg-fork&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://github.com/pgsty/pigsty/blob/main/files/postgres/pg-fork"&gt;&lt;code&gt;pg-fork&lt;/code&gt;&lt;/a&gt; 可以在同一台机器上快速克隆一个新的 PostgreSQL 实例。&lt;/p&gt;
&lt;h3 id="快速上手"&gt;快速上手&lt;/h3&gt;
&lt;p&gt;使用 &lt;code&gt;postgres&lt;/code&gt; 用户（dbsu）执行以下命令，即可创建一个新的实例：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 从 /pg/data 克隆到 /pg/data1，端口 15432&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;2&lt;/span&gt; -d /pg/data1 &lt;span style="color:#8f5902;font-style:italic"&gt;# 从 /pg/data1 克隆到 /pg/data2，端口 25432&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;3&lt;/span&gt; -D /tmp/test -P &lt;span style="color:#0000cf;font-weight:bold"&gt;5555&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 克隆到自定义目录和端口&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;克隆完成后，可以启动并访问新实例：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg_ctl -D /pg/data1 start &lt;span style="color:#8f5902;font-style:italic"&gt;# 启动克隆实例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;psql -p &lt;span style="color:#0000cf;font-weight:bold"&gt;15432&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 连接克隆实例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="命令语法"&gt;命令语法&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &amp;lt;FORK_ID&amp;gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;[&lt;/span&gt;options&lt;span style="color:#ce5c00;font-weight:bold"&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;必填参数：&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;参数&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;&amp;lt;FORK_ID&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;克隆实例编号（1-9），决定默认端口和数据目录&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;&lt;strong&gt;可选参数：&lt;/strong&gt;&lt;/p&gt;
&lt;table&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;参数&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;th&gt;默认值&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;-d, --data &amp;lt;datadir&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;源实例数据目录&lt;/td&gt;
 &lt;td&gt;&lt;code&gt;/pg/data&lt;/code&gt; 或 &lt;code&gt;$PG_DATA&lt;/code&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;-D, --dst &amp;lt;dst_dir&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;目标数据目录&lt;/td&gt;
 &lt;td&gt;&lt;code&gt;/pg/data&amp;lt;FORK_ID&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;-p, --port &amp;lt;port&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;源实例端口&lt;/td&gt;
 &lt;td&gt;&lt;code&gt;5432&lt;/code&gt; 或 &lt;code&gt;$PG_PORT&lt;/code&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;-P, --dst-port &amp;lt;port&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;目标实例端口&lt;/td&gt;
 &lt;td&gt;&lt;code&gt;&amp;lt;FORK_ID&amp;gt;5432&lt;/code&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;-s, --skip&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;跳过备份 API，使用冷拷贝模式&lt;/td&gt;
 &lt;td&gt;-&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;-y, --yes&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;跳过确认提示&lt;/td&gt;
 &lt;td&gt;-&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;-h, --help&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;显示帮助信息&lt;/td&gt;
 &lt;td&gt;-&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="使用示例"&gt;使用示例&lt;/h3&gt;







&lt;ul class="nav nav-tabs" id="tabs-0" role="tablist"&gt;
 &lt;li class="nav-item"&gt;
 &lt;button class="nav-link disabled"
 id="tabs-00-00-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-00" role="tab"
 aria-controls="tabs-00-00" aria-selected="false"&gt;
 pg-fork 示例
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link active"
 id="tabs-00-01-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-01" role="tab"
 aria-controls="tabs-00-01" aria-selected="true"&gt;
 基础克隆
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-02-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-02" role="tab"
 aria-controls="tabs-00-02" aria-selected="false"&gt;
 指定源端口
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-03-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-03" role="tab"
 aria-controls="tabs-00-03" aria-selected="false"&gt;
 链式克隆
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-04-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-04" role="tab"
 aria-controls="tabs-00-04" aria-selected="false"&gt;
 自定义位置
 &lt;/button&gt;
 &lt;/li&gt;&lt;li class="nav-item"&gt;
 &lt;button class="nav-link"
 id="tabs-00-05-tab" data-bs-toggle="tab" data-bs-target="#tabs-00-05" role="tab"
 aria-controls="tabs-00-05" aria-selected="false"&gt;
 冷拷贝模式
 &lt;/button&gt;
 &lt;/li&gt;
&lt;/ul&gt;

&lt;div class="tab-content" id="tabs-0-content"&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-00" role="tabpanel" aria-labelled-by="tabs-00-00-tab" tabindex="0"&gt;
 &lt;pre tabindex="0"&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade show active"
 id="tabs-00-01" role="tabpanel" aria-labelled-by="tabs-00-01-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 从默认实例克隆到 /pg/data1，端口 15432&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 从默认实例克隆到 /pg/data2，端口 25432&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;2&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-02" role="tabpanel" aria-labelled-by="tabs-00-02-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 从端口 5433 的实例克隆&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt; -p &lt;span style="color:#0000cf;font-weight:bold"&gt;5433&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 使用环境变量指定源端口&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#000"&gt;PG_PORT&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;5433&lt;/span&gt; pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-03" role="tabpanel" aria-labelled-by="tabs-00-03-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 从 /pg/data1 克隆到 /pg/data2&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;2&lt;/span&gt; -d /pg/data1
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 从 /pg/data2 克隆到 /pg/data3&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;3&lt;/span&gt; -d /pg/data2&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-04" role="tabpanel" aria-labelled-by="tabs-00-04-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 克隆到自定义目录和端口&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt; -D /tmp/pgtest -P &lt;span style="color:#0000cf;font-weight:bold"&gt;5555&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 完全自定义&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt; -d /pg/data -D /mnt/backup/pgclone -P &lt;span style="color:#0000cf;font-weight:bold"&gt;6543&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
 &lt;div class="tab-pane fade"
 id="tabs-00-05" role="tabpanel" aria-labelled-by="tabs-00-05-tab" tabindex="0"&gt;
 &lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 源实例已停止时使用冷拷贝&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt; -s
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 跳过确认直接执行&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-fork &lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt; -s -y&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
 &lt;/div&gt;
&lt;/div&gt;

&lt;h3 id="工作原理"&gt;工作原理&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;pg-fork&lt;/code&gt; 支持两种工作模式：&lt;/p&gt;</description></item><item><title>为 PostgreSQL 集群启用 HugePage</title><link>https://pigsty.cc/docs/pgsql/tutorial/hugepage/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/tutorial/hugepage/</guid><description>&lt;blockquote&gt;
&lt;p&gt;使用 &lt;code&gt;node_hugepage_count&lt;/code&gt; 和 &lt;code&gt;node_hugepage_ratio&lt;/code&gt; 或 &lt;code&gt;/pg/bin/pg-tune-hugepage&lt;/code&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;如果你计划启用大页（HugePage），请考虑使用 &lt;a href="https://pigsty.cc/docs/node/param#node_hugepage_count"&gt;&lt;code&gt;node_hugepage_count&lt;/code&gt;&lt;/a&gt; 和 &lt;a href="https://pigsty.cc/docs/node/param#node_hugepage_ratio"&gt;&lt;code&gt;node_hugepage_ratio&lt;/code&gt;&lt;/a&gt;，并配合 &lt;code&gt;./node.yml -t node_tune&lt;/code&gt; 进行应用。&lt;/p&gt;
&lt;p&gt;大页对于数据库来说有利有弊，利是内存是专门管理的，不用担心被挪用，降低数据库 OOM 风险。缺点是某些场景下可能对性能由负面影响。&lt;/p&gt;
&lt;p&gt;在 PostgreSQL 启动前，您需要分配 &lt;strong&gt;足够多的&lt;/strong&gt; 大页，浪费的部分可以使用 &lt;code&gt;pg-tune-hugepage&lt;/code&gt; 脚本对其进行回收，不过此脚本仅 PostgreSQL 15+ 可用。&lt;/p&gt;
&lt;p&gt;如果你的 PostgreSQL 已经在运行，你可以使用下面的办法启动大页（仅 PG15+ 可用）：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sync&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt; &lt;span style="color:#204a87"&gt;echo&lt;/span&gt; &lt;span style="color:#0000cf;font-weight:bold"&gt;3&lt;/span&gt; &amp;gt; /proc/sys/vm/drop_caches &lt;span style="color:#8f5902;font-style:italic"&gt;# 刷盘，释放系统缓存（请做好数据库性能受到冲击的准备）&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;sudo /pg/bin/pg-tune-hugepage &lt;span style="color:#8f5902;font-style:italic"&gt;# 将 nr_hugepages 写入 /etc/sysctl.d/hugepage.conf&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg restart &amp;lt;cls&amp;gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 重启 postgres 以使用 hugepage&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description></item><item><title>任务教程</title><link>https://pigsty.cc/docs/pgsql/tutorial/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/tutorial/</guid><description/></item><item><title>3坏2应急处理</title><link>https://pigsty.cc/docs/pgsql/tutorial/drill/</link><pubDate>Sat, 11 Jan 2025 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/tutorial/drill/</guid><description>&lt;p&gt;如果经典3节点高可用部署同时出现两台（多数主体）故障，系统通常无法自动完成故障切换，需要人工介入：&lt;/p&gt;
&lt;p&gt;首先判断另外两台服务器的情况，如果短时间内可以拉起，优先选择拉起另外两台服务。否则进入 &lt;strong&gt;紧急止血流程&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;紧急止血流程假设您的管理节点故障&lt;/strong&gt;，只有单台普通数据库节点存活，在这种情况下，最快的恢复操作流程为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;调整 HAProxy 配置，将流量指向主库。&lt;/li&gt;
&lt;li&gt;关闭 Patroni，手动提升 PostgreSQL 从库为主库。&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="调整haproxy配置"&gt;调整HAProxy配置&lt;/h2&gt;
&lt;p&gt;如果你通过其他方式绕开 HAProxy 访问集群，那么可以跳过这一步。
如果你通过 HAProxy 方式访问数据库集群，那么你需要调整负载均衡配置，将读写流量手工指向主库。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;编辑 &lt;code&gt;/etc/haproxy/&amp;lt;pg_cluster&amp;gt;-primary.cfg&lt;/code&gt; 配置文件，其中 &lt;code&gt;&amp;lt;pg_cluster&amp;gt;&lt;/code&gt; 为你的 PostgreSQL 集群名称，例如 &lt;code&gt;pg-meta&lt;/code&gt;。&lt;/li&gt;
&lt;li&gt;将健康检查配置选项注释，停止进行健康鉴擦好&lt;/li&gt;
&lt;li&gt;将服务器列表中，其他两台故障的机器注释掉，只保留当前主库服务器。&lt;/li&gt;
&lt;/ul&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-ini" data-lang="ini"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#c4a000"&gt;listen pg-meta-primary&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c4a000"&gt;bind *:5433&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c4a000"&gt;mode tcp&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c4a000"&gt;maxconn 5000&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c4a000"&gt;balance roundrobin&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 注释掉以下四行健康检查配置&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;#option httpchk # &amp;lt;---- remove this&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;#option http-keep-alive # &amp;lt;---- remove this&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;#http-check send meth OPTIONS uri /primary # &amp;lt;---- remove this&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;#http-check expect status 200 # &amp;lt;---- remove this&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c4a000"&gt;default-server inter 3s fastinter 1s downinter 5s rise 3 fall 3 on-marked-down shutdown-sessions slowstart 30s maxconn 3000 maxqueue 128 weight 100&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#c4a000"&gt;server pg-meta-1 10.10.10.10:6432 check port 8008 weight 100&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 注释掉其他两台故障的机器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;#server pg-meta-2 10.10.10.11:6432 check port 8008 weight 100 &amp;lt;---- comment this&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;#server pg-meta-3 10.10.10.12:6432 check port 8008 weight 100 &amp;lt;---- comment this&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;配置调整完成后，先不着急执行 &lt;code&gt;systemctl reload haproxy&lt;/code&gt; 重载生效，等待后续主库提升后一起执行。
以上配置的效果是，HAProxy 将不再进行主库健康检查（默认使用 Patroni），而是直接将写入流量指向当前主库&lt;/p&gt;</description></item><item><title>使用 VIP-Manager 为 PostgreSQL 集群配置二层 VIP</title><link>https://pigsty.cc/docs/pgsql/tutorial/pg-vip/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/tutorial/pg-vip/</guid><description>&lt;p&gt;您可以在 PostgreSQL 集群上绑定一个可选的 L2 VIP —— 前提条件是：集群中的所有节点都在一个二层网络中。&lt;/p&gt;
&lt;p&gt;这个 L2 VIP 强制使用 Master - Backup 模式，Master 始终指向在数据库集群主库实例所在的节点。&lt;/p&gt;
&lt;p&gt;这个 VIP 由 &lt;a href="https://github.com/cybertec-postgresql/vip-manager"&gt;VIP-Manager&lt;/a&gt; 组件管理，它会从 DCS （etcd） 中直接读取由 Patroni 写入的 Leader Key，从而判断自己是否是 Master。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="启用vip"&gt;启用VIP&lt;/h2&gt;
&lt;p&gt;在 PostgreSQL 集群上定义 &lt;a href="https://pigsty.cc/docs/pgsql/param#pg_vip_enabled"&gt;&lt;code&gt;pg_vip_enabled&lt;/code&gt;&lt;/a&gt; 参数为 &lt;code&gt;true&lt;/code&gt;，即可在集群上启用 VIP 组件。当然您也可以在全局配置中启用此配置项。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# pgsql 3 node ha cluster: pg-test&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;pg-test:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; hosts:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; 10.10.10.11: &lt;span style="color:#ce5c00;font-weight:bold"&gt;{&lt;/span&gt; pg_seq: 1, pg_role: primary &lt;span style="color:#ce5c00;font-weight:bold"&gt;}&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# primary instance, leader of cluster&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; 10.10.10.12: &lt;span style="color:#ce5c00;font-weight:bold"&gt;{&lt;/span&gt; pg_seq: 2, pg_role: replica &lt;span style="color:#ce5c00;font-weight:bold"&gt;}&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# replica instance, follower of leader&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; 10.10.10.13: &lt;span style="color:#ce5c00;font-weight:bold"&gt;{&lt;/span&gt; pg_seq: 3, pg_role: replica, pg_offline_query: &lt;span style="color:#204a87"&gt;true&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;}&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# replica with offline access&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; vars:
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; pg_cluster: pg-test &lt;span style="color:#8f5902;font-style:italic"&gt;# define pgsql cluster name&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; pg_users: &lt;span style="color:#ce5c00;font-weight:bold"&gt;[{&lt;/span&gt; name: &lt;span style="color:#204a87"&gt;test&lt;/span&gt; , password: &lt;span style="color:#204a87"&gt;test&lt;/span&gt; , pgbouncer: &lt;span style="color:#204a87"&gt;true&lt;/span&gt; , roles: &lt;span style="color:#ce5c00;font-weight:bold"&gt;[&lt;/span&gt; dbrole_admin &lt;span style="color:#ce5c00;font-weight:bold"&gt;]&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;}]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; pg_databases: &lt;span style="color:#ce5c00;font-weight:bold"&gt;[{&lt;/span&gt; name: &lt;span style="color:#204a87"&gt;test&lt;/span&gt; &lt;span style="color:#ce5c00;font-weight:bold"&gt;}]&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 启用 L2 VIP&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; pg_vip_enabled: &lt;span style="color:#204a87"&gt;true&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; pg_vip_address: 10.10.10.3/24
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; pg_vip_interface: eth1
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;请注意，&lt;a href="https://pigsty.cc/docs/pgsql/param#pg_vip_address"&gt;&lt;code&gt;pg_vip_address&lt;/code&gt;&lt;/a&gt; 必须是一个合法的 IP 地址，带有网段，且在当前二层网络中可用。&lt;/p&gt;</description></item><item><title>预置剧本</title><link>https://pigsty.cc/docs/pgsql/playbook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pgsql/playbook/</guid><description>&lt;blockquote&gt;
&lt;p&gt;Pigsty提供了一系列剧本，用于集群上下线扩缩容，用户/数据库管理，监控、备份恢复或迁移已有实例。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;table&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;剧本&lt;/th&gt;
 &lt;th&gt;功能&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#pgsqlyml"&gt;&lt;code&gt;pgsql.yml&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;初始化 PostgreSQL 集群或添加新的从库&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#pgsql-rmyml"&gt;&lt;code&gt;pgsql-rm.yml&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;移除 PostgreSQL 集群，或移除某个实例&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#pgsql-useryml"&gt;&lt;code&gt;pgsql-user.yml&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;在现有的 PostgreSQL 集群中添加新的业务用户&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#pgsql-dbyml"&gt;&lt;code&gt;pgsql-db.yml&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;在现有的 PostgreSQL 集群中添加新的业务数据库&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#pgsql-monitoryml"&gt;&lt;code&gt;pgsql-monitor.yml&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;将远程 PostgreSQL 实例纳入监控中&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#pgsql-migrationyml"&gt;&lt;code&gt;pgsql-migration.yml&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;为现有的 PostgreSQL 集群生成迁移手册和脚本&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;a href="#pgsql-pitryml"&gt;&lt;code&gt;pgsql-pitr.yml&lt;/code&gt;&lt;/a&gt;&lt;/td&gt;
 &lt;td&gt;执行 PostgreSQL 时间点恢复 (PITR)&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h2 id="保护机制"&gt;保护机制&lt;/h2&gt;
&lt;p&gt;使用 &lt;a href="https://pigsty.cc/docs/pgsql"&gt;&lt;code&gt;PGSQL&lt;/code&gt;&lt;/a&gt; 剧本时需要&lt;strong&gt;特别注意&lt;/strong&gt;，剧本 &lt;a href="#pgsqlyml"&gt;&lt;code&gt;pgsql.yml&lt;/code&gt;&lt;/a&gt; 与 &lt;a href="#pgsql-rmyml"&gt;&lt;code&gt;pgsql-rm.yml&lt;/code&gt;&lt;/a&gt; 使用不当会有误删数据库的风险！&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;在执行时添加 &lt;code&gt;-l&lt;/code&gt; 参数，限制命令执行的对象范围，并确保自己在正确的目标上执行正确的任务。&lt;/li&gt;
&lt;li&gt;限制范围通常以一个数据库集群为宜，使用不带参数的 &lt;code&gt;pgsql.yml&lt;/code&gt; 在生产环境中是一个高危操作，务必三思而后行。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;出于防止误删的目的，Pigsty 的 PGSQL 模块提供了防误删保险，由 &lt;a href="https://pigsty.cc/docs/pgsql/param#pg_safeguard"&gt;&lt;code&gt;pg_safeguard&lt;/code&gt;&lt;/a&gt; 参数控制。
当 &lt;code&gt;pg_safeguard&lt;/code&gt; 设置为 &lt;code&gt;true&lt;/code&gt; 时，&lt;a href="#pgsql-rmyml"&gt;&lt;code&gt;pgsql-rm.yml&lt;/code&gt;&lt;/a&gt; 剧本会立即中止执行，防止误删数据库集群。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 将会中止执行，保护数据安全&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-rm.yml -l pg-test
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 通过命令行参数强制覆盖保护开关&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql-rm.yml -l pg-test -e &lt;span style="color:#000"&gt;pg_safeguard&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#204a87"&gt;false&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;除了 &lt;code&gt;pg_safeguard&lt;/code&gt; 外，&lt;a href="#pgsql-rmyml"&gt;&lt;code&gt;pgsql-rm.yml&lt;/code&gt;&lt;/a&gt; 还提供了更细粒度的控制参数：&lt;/p&gt;</description></item><item><title>预置剧本</title><link>https://pigsty.cc/docs/infra/playbook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/infra/playbook/</guid><description>&lt;p&gt;Pigsty 提供了三个与 INFRA 模块相关的剧本：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#deployyml"&gt;&lt;code&gt;deploy.yml&lt;/code&gt;&lt;/a&gt;：在所有节点上一次性完整部署所有组件&lt;/li&gt;
&lt;li&gt;&lt;a href="#infrayml"&gt;&lt;code&gt;infra.yml&lt;/code&gt;&lt;/a&gt;：在 infra 节点上初始化 pigsty 基础设施&lt;/li&gt;
&lt;li&gt;&lt;a href="#infra-rmyml"&gt;&lt;code&gt;infra-rm.yml&lt;/code&gt;&lt;/a&gt;：从 infra 节点移除基础设施组件&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="deployyml"&gt;&lt;code&gt;deploy.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;在所有节点上一次性完整部署所有组件，解决 INFRA/NODE 循环依赖问题。&lt;/p&gt;
&lt;p&gt;该剧本会交叉执行 &lt;code&gt;infra.yml&lt;/code&gt; 与 &lt;code&gt;node.yml&lt;/code&gt; 的子任务，按以下顺序完成所有组件的部署：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;id&lt;/strong&gt;：生成节点与 PostgreSQL 身份标识&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;ca&lt;/strong&gt;：在本地创建自签名 CA 证书&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;repo&lt;/strong&gt;：在 infra 节点上创建本地软件仓库&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;node-init&lt;/strong&gt;：初始化节点、HAProxy 与 Docker&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;infra&lt;/strong&gt;：初始化 Nginx、DNS、VictoriaMetrics、Grafana 等&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;node-monitor&lt;/strong&gt;：初始化 node-exporter、vector&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;etcd&lt;/strong&gt;：初始化 etcd（PostgreSQL 高可用必需）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;minio&lt;/strong&gt;：初始化 MinIO（可选）&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;pgsql&lt;/strong&gt;：初始化 PostgreSQL 集群&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;pgsql-monitor&lt;/strong&gt;：初始化 PostgreSQL 监控&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;该剧本等效于依次执行以下四个剧本：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -l infra &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 infra 分组上部署基础设施&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./node.yml &lt;span style="color:#8f5902;font-style:italic"&gt;# 在所有节点上初始化节点&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./etcd.yml &lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化 etcd 集群&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./pgsql.yml &lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化 PostgreSQL 集群&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="infrayml"&gt;&lt;code&gt;infra.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;在配置文件的 &lt;code&gt;infra&lt;/code&gt; 分组所定义的 Infra节点 上初始化基础设施模块。&lt;/p&gt;</description></item><item><title>管理预案</title><link>https://pigsty.cc/docs/infra/admin/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/infra/admin/</guid><description>&lt;p&gt;本章节介绍 Pigsty 部署的日常管理和运维操作。&lt;/p&gt;</description></item><item><title>Nginx 管理</title><link>https://pigsty.cc/docs/infra/admin/portal/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/infra/admin/portal/</guid><description>&lt;p&gt;Pigsty 在 INFRA 节点上安装 Nginx 作为所有 Web 服务的入口，默认监听在 80/443 标准端口上。&lt;/p&gt;
&lt;p&gt;在 Pigsty 中，你可以通过修改配置清单，让 nginx 对外提供多种服务：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;对外暴露 Grafana、VictoriaMetrics（VMUI）、Alertmanager、VictoriaLogs 等监控组件的 Web 界面&lt;/li&gt;
&lt;li&gt;提供静态文件服务（如软件仓库、文档站，网站等）&lt;/li&gt;
&lt;li&gt;代理自定义的应用服务（如内部应用、数据库管理界面，Docker 应用的界面等）&lt;/li&gt;
&lt;li&gt;自动签发自签名的 HTTPS 证书，或者使用 certbot 申请免费的 Let&amp;rsquo;s Encrypt 证书&lt;/li&gt;
&lt;li&gt;通过不同的子域名，使用单一端口对外暴露服务&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="基础配置"&gt;基础配置&lt;/h2&gt;
&lt;p&gt;您可以通过 &lt;a href="https://pigsty.cc/docs/infra/param#infra_portal"&gt;&lt;code&gt;infra_portal&lt;/code&gt;&lt;/a&gt; 参数定制 Nginx 的行为：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;infra_portal&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;home&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;domain&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;i.pigsty }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;code&gt;infra_portal&lt;/code&gt; 是一个字典，每个键定义一个服务，值为服务的配置选项。
只有定义了 &lt;code&gt;domain&lt;/code&gt; 的服务才会生成对应的 Nginx 配置文件。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;&lt;code&gt;home&lt;/code&gt;&lt;/strong&gt;：特殊的默认服务器，用于处理首页和内置监控组件的反向代理&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;代理服务&lt;/strong&gt;：通过 &lt;code&gt;endpoint&lt;/code&gt; 指定上游服务地址，进行反向代理&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;静态服务&lt;/strong&gt;：通过 &lt;code&gt;path&lt;/code&gt; 指定本地目录，提供静态文件服务&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="服务器参数"&gt;服务器参数&lt;/h2&gt;
&lt;h3 id="基本参数"&gt;基本参数&lt;/h3&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;参数&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;domain&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;可选的代理域名&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;endpoint&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;上游服务地址（IP:PORT 或 socket）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;path&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;静态内容的本地目录&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;scheme&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;协议类型（http/https），默认 http&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;domains&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;额外的域名列表（别名）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="ssltls-选项"&gt;SSL/TLS 选项&lt;/h3&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;参数&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;certbot&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;启用 Let&amp;rsquo;s Encrypt 证书管理，值为证书名称&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;cert&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;自定义证书文件路径&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;key&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;自定义私钥文件路径&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;enforce_https&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;强制跳转 HTTPS（301 重定向）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="高级设置"&gt;高级设置&lt;/h3&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;参数&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;config&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;自定义 Nginx 配置片段&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;index&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;启用目录列表（用于静态服务）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;log&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;自定义日志文件名称&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;websocket&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;启用 WebSocket 支持&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;auth&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;启用 Basic Auth 认证&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;realm&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;Basic Auth 认证提示语&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h2 id="配置示例"&gt;配置示例&lt;/h2&gt;
&lt;h3 id="反向代理服务"&gt;反向代理服务&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;grafana&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;domain: g.pigsty, endpoint&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;${admin_ip}:3000&amp;#34;&lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;, websocket&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;true&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pgadmin&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;domain: adm.pigsty, endpoint&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;127.0.0.1:8885&amp;#34;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="静态文件与目录列表"&gt;静态文件与目录列表&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;repo&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;domain: repo.pigsty.cc, path&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;/www/repo&amp;#34;&lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;, index&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;true&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="自定义-ssl-证书"&gt;自定义 SSL 证书&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;secure_app&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;domain&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;secure.pigsty.cc&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;endpoint&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;${admin_ip}:8443&amp;#34;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;cert&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;/etc/ssl/certs/custom.crt&amp;#34;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;key&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;/etc/ssl/private/custom.key&amp;#34;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="使用-lets-encrypt-证书"&gt;使用 Let&amp;rsquo;s Encrypt 证书&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;grafana&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;domain&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;demo.pigsty.cc&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;endpoint&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;${admin_ip}:3000&amp;#34;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;websocket&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;true&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;certbot&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pigsty.demo &lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 证书名称，多个域名可共用同一证书&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="强制-https-跳转"&gt;强制 HTTPS 跳转&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;web.io&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;domain&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;en.pigsty.cc&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;path&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;/www/web.io&amp;#34;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;certbot&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pigsty.doc&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;enforce_https&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;true&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="自定义配置片段"&gt;自定义配置片段&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;web.cc&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;domain&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pigsty.cc&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;path&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#4e9a06"&gt;&amp;#34;/www/web.cc&amp;#34;&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;domains&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;[&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;zh.pigsty.cc ]&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;certbot&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pigsty.doc&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;config&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;|&lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt; # rewrite /zh/ to /
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt; location /zh/ {
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt; rewrite ^/zh/(.*)$ /$1 permanent;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt; }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="管理命令"&gt;管理命令&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t nginx &lt;span style="color:#8f5902;font-style:italic"&gt;# 完整重新配置 Nginx&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t nginx_config &lt;span style="color:#8f5902;font-style:italic"&gt;# 重新生成配置文件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t nginx_launch &lt;span style="color:#8f5902;font-style:italic"&gt;# 重启 Nginx 服务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t nginx_cert &lt;span style="color:#8f5902;font-style:italic"&gt;# 重新生成 SSL 证书&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t nginx_certbot &lt;span style="color:#8f5902;font-style:italic"&gt;# 使用 certbot 签发证书&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t nginx_reload &lt;span style="color:#8f5902;font-style:italic"&gt;# 重新加载 Nginx 配置&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="域名解析"&gt;域名解析&lt;/h2&gt;
&lt;p&gt;有三种方式将域名解析到 Pigsty 服务器：&lt;/p&gt;</description></item><item><title>软件仓库</title><link>https://pigsty.cc/docs/infra/admin/repo/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/infra/admin/repo/</guid><description>&lt;p&gt;Pigsty 支持创建和管理本地 APT/YUM 软件仓库，用于在离线环境中部署或加速软件包安装。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="快速开始"&gt;快速开始&lt;/h2&gt;
&lt;p&gt;向本地仓库添加软件包：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;将软件包添加到 &lt;a href="https://pigsty.cc/docs/infra/param#repo_packages"&gt;&lt;code&gt;repo_packages&lt;/code&gt;&lt;/a&gt;（默认软件包）&lt;/li&gt;
&lt;li&gt;将软件包添加到 &lt;a href="https://pigsty.cc/docs/infra/param#repo_extra_packages"&gt;&lt;code&gt;repo_extra_packages&lt;/code&gt;&lt;/a&gt;（额外软件包）&lt;/li&gt;
&lt;li&gt;执行构建命令：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_build &lt;span style="color:#8f5902;font-style:italic"&gt;# 从上游构建本地仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./node.yml -t node_repo &lt;span style="color:#8f5902;font-style:italic"&gt;# 刷新节点仓库缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="软件包别名"&gt;软件包别名&lt;/h2&gt;
&lt;p&gt;Pigsty 预定义了常用的软件包组合，方便批量安装：&lt;/p&gt;
&lt;h3 id="el-系统rhelcentosrocky"&gt;EL 系统（RHEL/CentOS/Rocky）&lt;/h3&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;别名&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;node-bootstrap&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;Ansible、Python3 工具、SSH 相关&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;infra-package&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;Nginx、etcd、HAProxy、监控导出器、MinIO 等&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;pgsql-utility&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;Patroni、pgBouncer、pgBackRest、PG 工具&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;pgsql&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;完整 PostgreSQL（服务端、客户端、扩展）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;pgsql-mini&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;最小化 PostgreSQL 安装&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="debianubuntu-系统"&gt;Debian/Ubuntu 系统&lt;/h3&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;别名&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;node-bootstrap&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;Ansible、开发工具&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;infra-package&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;基础设施组件（使用 Debian 命名规范）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;pgsql-client&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;PostgreSQL 客户端&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;pgsql-server&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;PostgreSQL 服务端及相关包&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h2 id="剧本任务"&gt;剧本任务&lt;/h2&gt;
&lt;h3 id="主要任务"&gt;主要任务&lt;/h3&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;任务&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;repo&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;从互联网或离线包创建本地仓库&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;repo_build&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;如不存在则从上游构建&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;repo_upstream&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;添加上游仓库文件&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;repo_pkg&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;下载软件包及依赖&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;repo_create&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;创建/更新 YUM 或 APT 仓库&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;repo_nginx&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;启动 Nginx 文件服务器&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="完整任务列表"&gt;完整任务列表&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_dir &lt;span style="color:#8f5902;font-style:italic"&gt;# 创建本地软件仓库目录&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_check &lt;span style="color:#8f5902;font-style:italic"&gt;# 检查本地仓库是否存在&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_prepare &lt;span style="color:#8f5902;font-style:italic"&gt;# 直接使用已有仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_build &lt;span style="color:#8f5902;font-style:italic"&gt;# 从上游构建仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_upstream &lt;span style="color:#8f5902;font-style:italic"&gt;# 添加上游仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_remove &lt;span style="color:#8f5902;font-style:italic"&gt;# 删除现有仓库文件&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_add &lt;span style="color:#8f5902;font-style:italic"&gt;# 添加仓库到系统目录&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_url_pkg &lt;span style="color:#8f5902;font-style:italic"&gt;# 从互联网下载包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_cache &lt;span style="color:#8f5902;font-style:italic"&gt;# 创建元数据缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_boot_pkg &lt;span style="color:#8f5902;font-style:italic"&gt;# 安装引导包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_pkg &lt;span style="color:#8f5902;font-style:italic"&gt;# 下载包及依赖&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_create &lt;span style="color:#8f5902;font-style:italic"&gt;# 创建本地仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_use &lt;span style="color:#8f5902;font-style:italic"&gt;# 添加新建仓库到系统&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_nginx &lt;span style="color:#8f5902;font-style:italic"&gt;# 启动 Nginx 文件服务器&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="常用操作"&gt;常用操作&lt;/h2&gt;
&lt;h3 id="添加新软件包"&gt;添加新软件包&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 1. 配置上游仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_upstream
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 2. 下载软件包及依赖&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_pkg
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 3. 构建本地仓库元数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo_create
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="刷新节点仓库"&gt;刷新节点仓库&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./node.yml -t node_repo &lt;span style="color:#8f5902;font-style:italic"&gt;# 刷新所有节点的仓库缓存&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="完整重建仓库"&gt;完整重建仓库&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -t repo &lt;span style="color:#8f5902;font-style:italic"&gt;# 从互联网或离线包创建仓库&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description></item><item><title>域名管理</title><link>https://pigsty.cc/docs/infra/admin/domain/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/infra/admin/domain/</guid><description>&lt;p&gt;使用域名代替 IP 地址访问 Pigsty 的各项 Web 服务。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="快速开始"&gt;快速开始&lt;/h2&gt;
&lt;p&gt;将以下静态解析记录添加到 &lt;code&gt;/etc/hosts&lt;/code&gt;：&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;10.10.10.10 i.pigsty g.pigsty p.pigsty a.pigsty
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;将 IP 地址替换为实际 Pigsty 节点的 IP。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="为什么使用域名"&gt;为什么使用域名&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;比 IP 地址更易于记忆&lt;/li&gt;
&lt;li&gt;灵活指向不同 IP&lt;/li&gt;
&lt;li&gt;通过 Nginx 统一管理服务&lt;/li&gt;
&lt;li&gt;支持 HTTPS 加密&lt;/li&gt;
&lt;li&gt;防止某些地区的 ISP 劫持&lt;/li&gt;
&lt;li&gt;允许通过代理访问内部绑定的服务&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="dns-机制"&gt;DNS 机制&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;DNS 协议&lt;/strong&gt;：将域名解析为 IP 地址。多个域名可以指向同一个 IP。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;HTTP 协议&lt;/strong&gt;：使用 Host 头将请求路由到同一端口（80/443）上的不同站点。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="默认域名"&gt;默认域名&lt;/h2&gt;
&lt;p&gt;Pigsty 预定义了以下默认域名：&lt;/p&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;域名&lt;/th&gt;
 &lt;th&gt;服务&lt;/th&gt;
 &lt;th&gt;端口&lt;/th&gt;
 &lt;th&gt;用途&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;i.pigsty&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;Nginx&lt;/td&gt;
 &lt;td&gt;80/443&lt;/td&gt;
 &lt;td&gt;默认首页、本地仓库与统一入口&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;g.pigsty&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;Grafana&lt;/td&gt;
 &lt;td&gt;3000&lt;/td&gt;
 &lt;td&gt;监控与可视化&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;p.pigsty&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;VictoriaMetrics&lt;/td&gt;
 &lt;td&gt;8428&lt;/td&gt;
 &lt;td&gt;VMUI/PromQL 入口&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;a.pigsty&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;AlertManager&lt;/td&gt;
 &lt;td&gt;9059&lt;/td&gt;
 &lt;td&gt;告警路由&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;m.pigsty&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;MinIO&lt;/td&gt;
 &lt;td&gt;9001&lt;/td&gt;
 &lt;td&gt;对象存储控制台&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h2 id="解析方式"&gt;解析方式&lt;/h2&gt;
&lt;h3 id="本地静态解析"&gt;本地静态解析&lt;/h3&gt;
&lt;p&gt;在客户端机器的 &lt;code&gt;/etc/hosts&lt;/code&gt; 中添加条目：&lt;/p&gt;</description></item><item><title>模块管理</title><link>https://pigsty.cc/docs/infra/admin/sop/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/infra/admin/sop/</guid><description>&lt;p&gt;本文介绍 INFRA 模块的日常管理操作，包括安装、卸载、扩容、以及各组件的管理维护。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="安装-infra-模块"&gt;安装 Infra 模块&lt;/h2&gt;
&lt;p&gt;使用 &lt;a href="https://pigsty.cc/docs/infra/playbook/#infrayml"&gt;&lt;code&gt;infra.yml&lt;/code&gt;&lt;/a&gt; 剧本在 &lt;code&gt;infra&lt;/code&gt; 分组上安装 INFRA 模块：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 infra 分组上安装 INFRA 模块&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="卸载-infra-模块"&gt;卸载 Infra 模块&lt;/h2&gt;
&lt;p&gt;使用 &lt;a href="https://pigsty.cc/docs/infra/playbook/#infra-rmyml"&gt;&lt;code&gt;infra-rm.yml&lt;/code&gt;&lt;/a&gt; 剧本从 &lt;code&gt;infra&lt;/code&gt; 分组上卸载 INFRA 模块：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra-rm.yml &lt;span style="color:#8f5902;font-style:italic"&gt;# 从 infra 分组上卸载 INFRA 模块&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="扩容-infra-模块"&gt;扩容 Infra 模块&lt;/h2&gt;
&lt;p&gt;在配置清单中为新节点分配 &lt;a href="https://pigsty.cc/docs/infra/param/#infra_seq"&gt;&lt;code&gt;infra_seq&lt;/code&gt;&lt;/a&gt; 并加入 &lt;code&gt;infra&lt;/code&gt; 分组：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;all&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;children&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;infra&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;infra_seq&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 原有节点&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.11&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;infra_seq&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;2&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 新节点&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;使用限制选项 &lt;code&gt;-l&lt;/code&gt; 仅在新节点上执行剧本：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./infra.yml -l 10.10.10.11 &lt;span style="color:#8f5902;font-style:italic"&gt;# 在新节点上安装 INFRA 模块&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="管理本地软件仓库"&gt;管理本地软件仓库&lt;/h2&gt;
&lt;p&gt;本地软件仓库相关的管理任务：&lt;/p&gt;</description></item><item><title>CA 与证书</title><link>https://pigsty.cc/docs/infra/admin/cert/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/infra/admin/cert/</guid><description>&lt;p&gt;Pigsty 默认使用&lt;strong&gt;自签名证书颁发机构 (CA)&lt;/strong&gt; 进行内部 SSL/TLS 加密。本文档包含：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#%E8%87%AA%E7%AD%BE%E5%90%8D-ca"&gt;自签名 CA&lt;/a&gt;：默认的 PKI 基础设施&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E7%AD%BE%E5%8F%91%E8%AF%81%E4%B9%A6"&gt;签发证书&lt;/a&gt;：使用 &lt;code&gt;cert.yml&lt;/code&gt; 签发额外证书&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E4%BF%A1%E4%BB%BB-ca-%E8%AF%81%E4%B9%A6"&gt;信任 CA 证书&lt;/a&gt;：在客户端机器上安装 CA&lt;/li&gt;
&lt;li&gt;&lt;a href="#lets-encrypt"&gt;Let&amp;rsquo;s Encrypt&lt;/a&gt;：为公网服务使用真实证书&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="自签名-ca"&gt;自签名 CA&lt;/h2&gt;
&lt;p&gt;Pigsty 在基础设施初始化 (&lt;code&gt;infra.yml&lt;/code&gt;) 时自动创建自签名 CA。该 CA 用于签发以下证书：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;PostgreSQL 服务器/客户端 SSL&lt;/li&gt;
&lt;li&gt;Patroni REST API&lt;/li&gt;
&lt;li&gt;etcd 集群通信&lt;/li&gt;
&lt;li&gt;MinIO 集群通信&lt;/li&gt;
&lt;li&gt;Nginx HTTPS（备用）&lt;/li&gt;
&lt;li&gt;基础设施服务&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="pki-目录结构"&gt;PKI 目录结构&lt;/h3&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;files/pki/
├── ca/
│ ├── ca.key # CA 私钥（务必保管好！）
│ └── ca.crt # CA 证书
├── csr/ # 证书签名请求
├── misc/ # 杂项证书（cert.yml 输出）
├── etcd/ # ETCD 证书
├── pgsql/ # PostgreSQL 证书
├── minio/ # MinIO 证书
├── infra/ # 基础设施证书
├── nginx/ # Nginx 证书
└── mongo/ # FerretDB 证书
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id="ca-变量"&gt;CA 变量&lt;/h3&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;变量&lt;/th&gt;
 &lt;th&gt;默认值&lt;/th&gt;
 &lt;th&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;ca_create&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;&lt;code&gt;true&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;如果不存在则创建 CA，否则中止&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;ca_cn&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;&lt;code&gt;pigsty-ca&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;CA 证书通用名称&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;cert_validity&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;&lt;code&gt;7300d&lt;/code&gt;&lt;/td&gt;
 &lt;td&gt;签发证书的默认有效期&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;h3 id="证书有效期"&gt;证书有效期&lt;/h3&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;证书类型&lt;/th&gt;
 &lt;th&gt;有效期&lt;/th&gt;
 &lt;th&gt;控制参数&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;CA 证书&lt;/td&gt;
 &lt;td&gt;100 年&lt;/td&gt;
 &lt;td&gt;硬编码（36500 天）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;服务器/客户端&lt;/td&gt;
 &lt;td&gt;20 年&lt;/td&gt;
 &lt;td&gt;&lt;code&gt;cert_validity&lt;/code&gt;（7300d）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;Nginx HTTPS&lt;/td&gt;
 &lt;td&gt;~1 年&lt;/td&gt;
 &lt;td&gt;&lt;code&gt;nginx_cert_validity&lt;/code&gt;（397d）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;注意&lt;/strong&gt;：浏览器厂商限制超过 398 天的证书信任。Nginx 使用较短有效期以保证浏览器兼容性。&lt;/p&gt;</description></item><item><title>预置剧本</title><link>https://pigsty.cc/docs/node/playbook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/node/playbook/</guid><description>&lt;p&gt;Pigsty 提供两个与 NODE 模块相关的剧本：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#nodeyml"&gt;&lt;code&gt;node.yml&lt;/code&gt;&lt;/a&gt;：纳管节点，调整节点到期望状态&lt;/li&gt;
&lt;li&gt;&lt;a href="#node-rmyml"&gt;&lt;code&gt;node-rm.yml&lt;/code&gt;&lt;/a&gt;：从 Pigsty 中移除纳管节点&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另提供两个包装命令工具：&lt;code&gt;bin/node-add&lt;/code&gt; 与 &lt;code&gt;bin/node-rm&lt;/code&gt;，用于快速调用剧本。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="nodeyml"&gt;&lt;code&gt;node.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;向 Pigsty 添加节点的 &lt;a href="https://github.com/pgsty/pigsty/blob/main/node.yml"&gt;&lt;code&gt;node.yml&lt;/code&gt;&lt;/a&gt; 包含以下子任务：&lt;/p&gt;
&lt;pre tabindex="0"&gt;&lt;code&gt;node-id ：生成节点身份标识
node_name ：设置主机名
node_hosts ：配置 /etc/hosts 记录
node_resolv ：配置 DNS 解析器 /etc/resolv.conf
node_firewall ：设置防火墙 &amp;amp; selinux
node_ca ：添加并信任CA证书
node_repo ：添加上游软件仓库
node_pkg ：安装 rpm/deb 软件包
node_uv ：配置 uv Python 虚拟环境
node_feature ：配置 numa、grub、静态网络等特性
node_kernel ：配置操作系统内核模块
node_tune ：配置 tuned 调优模板
node_sysctl ：设置额外的 sysctl 参数
node_profile ：写入 /etc/profile.d/node.sh
node_ulimit ：配置资源限制
node_data ：配置数据目录
node_admin ：配置管理员用户和ssh密钥
node_timezone ：配置时区
node_ntp ：配置 NTP 服务器/客户端
node_crontab ：添加/覆盖 crontab 定时任务
node_vip ：为节点集群设置可选的 L2 VIP
haproxy ：在节点上设置 haproxy 以暴露服务
monitor ：配置节点监控：node_exporter &amp;amp; vector
&lt;/code&gt;&lt;/pre&gt;&lt;hr&gt;
&lt;h2 id="node-rmyml"&gt;&lt;code&gt;node-rm.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;从 Pigsty 中移除节点的剧本 &lt;a href="https://github.com/pgsty/pigsty/blob/main/node-rm.yml"&gt;&lt;code&gt;node-rm.yml&lt;/code&gt;&lt;/a&gt; 包含以下子任务：&lt;/p&gt;</description></item><item><title>管理预案</title><link>https://pigsty.cc/docs/node/admin/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/node/admin/</guid><description>&lt;p&gt;下面是 Node 模块中常用的管理操作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9"&gt;添加节点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E7%A7%BB%E9%99%A4%E8%8A%82%E7%82%B9"&gt;移除节点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E5%88%9B%E5%BB%BA%E7%AE%A1%E7%90%86%E5%91%98"&gt;创建管理员&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E7%BB%91%E5%AE%9Avip"&gt;绑定VIP&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E6%B7%BB%E5%8A%A0%E8%8A%82%E7%82%B9%E7%9B%91%E6%8E%A7"&gt;添加节点监控&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E5%85%B6%E4%BB%96%E5%B8%B8%E8%A7%81%E4%BB%BB%E5%8A%A1"&gt;其他常见任务&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更多问题请参考 &lt;a href="https://pigsty.cc/docs/node/faq/"&gt;FAQ：NODE&lt;/a&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="添加节点"&gt;添加节点&lt;/h2&gt;
&lt;p&gt;要将节点添加到 Pigsty，您需要对该节点具有无密码的 ssh/sudo 访问权限。&lt;/p&gt;
&lt;p&gt;您也可以选择一次性添加一个集群，或使用通配符匹配配置清单中要加入 Pigsty 的节点。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# ./node.yml -l &amp;lt;cls|ip|group&amp;gt; # 向 Pigsty 中添加节点的实际剧本&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# bin/node-add &amp;lt;selector|ip...&amp;gt; # 向 Pigsty 中添加节点&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/node-add node-test &lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化节点集群 &amp;#39;node-test&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/node-add 10.10.10.10 &lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化节点 &amp;#39;10.10.10.10&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;示例：将 PG 集群 &lt;code&gt;pg-test&lt;/code&gt; 的三个节点纳入 Pigsty 管理&lt;/strong&gt;&lt;/p&gt;
&lt;link rel="stylesheet" href="https://pigsty.cc/css/asciinema-player.css" /&gt;
&lt;script src="https://pigsty.cc/js/asciinema-player.min.js"&gt;&lt;/script&gt;&lt;div id="asciinema-7069a298b7596d78fe1fbba39686127a" class="asciinema-container td-max-width-on-larger-screens" style="margin: 1em 0;"&gt;&lt;/div&gt;

&lt;script&gt;
(function() {
 var containerId = "asciinema-7069a298b7596d78fe1fbba39686127a";
 var castURL = "\/demo\/node-add.cast";
 var configuredTheme = "auto";
 var player = null;

 
 function detectTheme() {
 var htmlTheme = document.documentElement.getAttribute("data-bs-theme");
 if (htmlTheme === "dark") return "solarized-dark";
 if (htmlTheme === "light") return "solarized-light";
 
 if (window.matchMedia &amp;&amp; window.matchMedia("(prefers-color-scheme: dark)").matches) {
 return "solarized-dark";
 }
 return "solarized-light";
 }

 function getTheme() {
 if (configuredTheme === "auto") {
 return detectTheme();
 }
 return configuredTheme;
 }

 function createPlayer() {
 var container = document.getElementById(containerId);
 
 container.innerHTML = "";

 var opts = {
 theme: getTheme(),
 speed: "1.2",
 startAt: 0 ,
 fit: "width"
 };
 opts.autoPlay = true;
 opts.loop = true;
 opts.markers = [[ 4 , "执行"]];

 player = AsciinemaPlayer.create(castURL, container, opts);
 }

 
 createPlayer();

 
 if (configuredTheme === "auto") {
 
 var observer = new MutationObserver(function(mutations) {
 mutations.forEach(function(mutation) {
 if (mutation.attributeName === "data-bs-theme") {
 createPlayer();
 }
 });
 });
 observer.observe(document.documentElement, { attributes: true });

 
 if (window.matchMedia) {
 window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", function() {
 
 var htmlTheme = document.documentElement.getAttribute("data-bs-theme");
 if (!htmlTheme || htmlTheme === "auto") {
 createPlayer();
 }
 });
 }
 }
})();
&lt;/script&gt;

&lt;hr&gt;
&lt;h2 id="移除节点"&gt;移除节点&lt;/h2&gt;
&lt;p&gt;要从 Pigsty 中移除一个节点，您可以使用以下命令：&lt;/p&gt;</description></item><item><title>管理预案</title><link>https://pigsty.cc/docs/etcd/admin/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/etcd/admin/</guid><description>&lt;p&gt;以下是一些常见的 etcd 管理任务 SOP（预案）：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#%E5%88%9B%E5%BB%BA%E9%9B%86%E7%BE%A4"&gt;创建集群&lt;/a&gt;：如何初始化 etcd 集群？&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E9%94%80%E6%AF%81%E9%9B%86%E7%BE%A4"&gt;销毁集群&lt;/a&gt;：如何销毁 etcd 集群？&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"&gt;环境变量&lt;/a&gt;：如何配置 etcd 客户端，以访问 etcd 服务器集群？&lt;/li&gt;
&lt;li&gt;&lt;a href="#rbac-%E8%AE%A4%E8%AF%81"&gt;RBAC 认证&lt;/a&gt;：如何使用 etcd 的 RBAC 认证？&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E9%87%8D%E8%BD%BD%E9%85%8D%E7%BD%AE"&gt;重载配置&lt;/a&gt;：如何更新客户端使用的 etcd 服务器成员列表？&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E6%B7%BB%E5%8A%A0%E6%88%90%E5%91%98"&gt;添加成员&lt;/a&gt;：如何向现有 etcd 集群添加新成员？&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E7%A7%BB%E9%99%A4%E6%88%90%E5%91%98"&gt;移除成员&lt;/a&gt;：如何从 etcd 集群移除老成员？&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E4%BE%BF%E6%8D%B7%E8%84%9A%E6%9C%AC"&gt;便捷脚本&lt;/a&gt;：使用 &lt;code&gt;bin/etcd-add&lt;/code&gt; 和 &lt;code&gt;bin/etcd-rm&lt;/code&gt; 简化操作&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更多问题请参考 &lt;a href="https://pigsty.cc/docs/etcd/faq/"&gt;FAQ：ETCD&lt;/a&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="创建集群"&gt;创建集群&lt;/h2&gt;
&lt;p&gt;要创建一个集群，首先需要在 &lt;a href="https://pigsty.cc/docs/setup/config/"&gt;&lt;strong&gt;配置清单&lt;/strong&gt;&lt;/a&gt; 中定义 &lt;code&gt;etcd&lt;/code&gt; 集群：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;etcd&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;etcd_seq&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;1&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.11&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;etcd_seq&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;2&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.12&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;etcd_seq&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;3&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;}&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;etcd_cluster&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;etcd }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;执行 &lt;a href="https://pigsty.cc/docs/etcd/playbook#etcdyml"&gt;&lt;code&gt;etcd.yml&lt;/code&gt;&lt;/a&gt; 剧本即可。&lt;/p&gt;</description></item><item><title>预置剧本</title><link>https://pigsty.cc/docs/etcd/playbook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/etcd/playbook/</guid><description>&lt;p&gt;Etcd 模块提供了两个核心剧本：&lt;a href="#etcdyml"&gt;&lt;code&gt;etcd.yml&lt;/code&gt;&lt;/a&gt; 用于安装与配置 Etcd 集群，&lt;a href="#etcd-rmyml"&gt;&lt;code&gt;etcd-rm.yml&lt;/code&gt;&lt;/a&gt; 用于移除 Etcd 集群或成员。&lt;/p&gt;
&lt;div class="alert alert-info" role="alert"&gt;&lt;div class="h4 alert-heading" role="heading"&gt;架构变化：Pigsty v3.6+&lt;/div&gt;
&lt;p&gt;自 Pigsty v3.6 起，&lt;code&gt;etcd.yml&lt;/code&gt; 剧本专注于集群安装和成员添加，所有移除操作已迁移至独立的 &lt;code&gt;etcd-rm.yml&lt;/code&gt; 剧本和 &lt;code&gt;etcd_remove&lt;/code&gt; 角色。&lt;/p&gt;
&lt;/div&gt;
&lt;hr&gt;
&lt;h2 id="etcdyml"&gt;&lt;code&gt;etcd.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;剧本原始文件：&lt;a href="https://github.com/pgsty/pigsty/blob/main/etcd.yml"&gt;&lt;code&gt;etcd.yml&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;执行本剧本，将会在硬编码的固定分组 &lt;code&gt;etcd&lt;/code&gt; 上安装配置 Etcd 集群，并启动 etcd 服务。&lt;/p&gt;
&lt;p&gt;在 &lt;a href="https://github.com/pgsty/pigsty/blob/main/etcd.yml"&gt;&lt;code&gt;etcd.yml&lt;/code&gt;&lt;/a&gt; 中，提供了以下是可用的任务子集：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;etcd_assert&lt;/code&gt; ：验证 etcd 身份参数（&lt;code&gt;etcd_seq&lt;/code&gt; 必须定义且为非负整数）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;etcd_install&lt;/code&gt; ：安装 etcd 软件包&lt;/li&gt;
&lt;li&gt;&lt;code&gt;etcd_dir&lt;/code&gt; ：创建 etcd 数据和配置目录&lt;/li&gt;
&lt;li&gt;&lt;code&gt;etcd_config&lt;/code&gt; ：生成 etcd 配置
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;etcd_conf&lt;/code&gt; ：生成 etcd 主配置文件 &lt;code&gt;/etc/etcd/etcd.conf&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;etcd_cert&lt;/code&gt; ：生成 etcd TLS 证书（CA、服务器证书、私钥）&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;etcd_member&lt;/code&gt; ：将新成员添加到现有集群（仅当 &lt;code&gt;etcd_init=existing&lt;/code&gt; 时执行）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;etcd_launch&lt;/code&gt; ：启动 etcd 服务&lt;/li&gt;
&lt;li&gt;&lt;code&gt;etcd_auth&lt;/code&gt; ：启用 RBAC 认证（创建 root 用户并启用认证）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;etcd_register&lt;/code&gt; ：将 etcd 注册到 VictoriaMetrics/Prometheus 监控&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="etcd-rmyml"&gt;&lt;code&gt;etcd-rm.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;剧本原始文件：&lt;a href="https://github.com/pgsty/pigsty/blob/main/etcd-rm.yml"&gt;&lt;code&gt;etcd-rm.yml&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;</description></item><item><title>预置剧本</title><link>https://pigsty.cc/docs/minio/playbook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/minio/playbook/</guid><description>&lt;p&gt;MinIO 模块提供了两个内置剧本用于集群管理：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#minioyml"&gt;&lt;code&gt;minio.yml&lt;/code&gt;&lt;/a&gt;：用于安装 MinIO 集群&lt;/li&gt;
&lt;li&gt;&lt;a href="#minio-rmyml"&gt;&lt;code&gt;minio-rm.yml&lt;/code&gt;&lt;/a&gt;：用于移除 MinIO 集群&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="minioyml"&gt;&lt;code&gt;minio.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;剧本 &lt;a href="https://github.com/pgsty/pigsty/blob/main/minio.yml"&gt;&lt;code&gt;minio.yml&lt;/code&gt;&lt;/a&gt; 用于在节点上安装 MinIO 模块。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;minio-id&lt;/code&gt; : 生成/校验 minio 身份参数&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_install&lt;/code&gt; : 安装 minio
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;minio_os_user&lt;/code&gt; : 创建操作系统用户 minio&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_pkg&lt;/code&gt; : 安装 minio/mcli 软件包&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_dir&lt;/code&gt; : 创建 minio 目录&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_config&lt;/code&gt; : 生成 minio 配置
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;minio_conf&lt;/code&gt; : minio 主配置文件&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_cert&lt;/code&gt; : minio SSL 证书签发&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_dns&lt;/code&gt; : minio DNS 记录插入&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_launch&lt;/code&gt; : minio 服务启动&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_register&lt;/code&gt; : minio 纳入监控&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_provision&lt;/code&gt; : 创建 minio 别名/存储桶/业务用户
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;minio_alias&lt;/code&gt; : 创建 minio 客户端别名（管理节点上）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_bucket&lt;/code&gt; : 创建 minio 存储桶&lt;/li&gt;
&lt;li&gt;&lt;code&gt;minio_user&lt;/code&gt; : 创建 minio 业务用户&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;在执行剧本前，请先在 &lt;a href="https://pigsty.cc/docs/setup/config"&gt;配置清单&lt;/a&gt; 中，完成 MinIO 集群的 &lt;a href="https://pigsty.cc/docs/minio/config/"&gt;配置&lt;/a&gt;。&lt;/p&gt;</description></item><item><title>管理预案</title><link>https://pigsty.cc/docs/minio/admin/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/minio/admin/</guid><description>&lt;hr&gt;
&lt;h2 id="创建集群"&gt;创建集群&lt;/h2&gt;
&lt;p&gt;要创建一个集群，在配置清单中定义好后，执行 &lt;a href="https://pigsty.cc/docs/minio/playbook#minioyml"&gt;&lt;code&gt;minio.yml&lt;/code&gt;&lt;/a&gt; 剧本即可。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;minio&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.10&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;minio_seq: 1 } }, vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;minio_cluster&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;minio } }&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;例如，上面的配置定义了一个 SNSD &lt;a href="https://pigsty.cc/docs/minio/config#%E5%8D%95%E6%9C%BA%E5%8D%95%E7%9B%98"&gt;单机单盘&lt;/a&gt; MinIO 集群，使用以下命令即可创建该 MinIO 集群：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./minio.yml -l minio &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 minio 分组上安装 MinIO 模块 &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="销毁集群"&gt;销毁集群&lt;/h2&gt;
&lt;p&gt;要销毁一个集群，执行专用的 &lt;a href="https://pigsty.cc/docs/minio/playbook#minio-rmyml"&gt;&lt;code&gt;minio-rm.yml&lt;/code&gt;&lt;/a&gt; 剧本即可：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./minio-rm.yml -l minio &lt;span style="color:#8f5902;font-style:italic"&gt;# 移除 MinIO 集群&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./minio-rm.yml -l minio -e &lt;span style="color:#000"&gt;minio_rm_data&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#204a87"&gt;false&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 移除集群但保留数据&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./minio-rm.yml -l minio -e &lt;span style="color:#000"&gt;minio_rm_pkg&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#204a87"&gt;true&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 移除集群并卸载软件包&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="alert alert-info" role="alert"&gt;&lt;div class="h4 alert-heading" role="heading"&gt;架构变更：Pigsty v3.6+&lt;/div&gt;
&lt;p&gt;从 Pigsty v3.6 开始，集群移除操作已从 &lt;code&gt;minio.yml&lt;/code&gt; 剧本迁移至专用的 &lt;code&gt;minio-rm.yml&lt;/code&gt; 剧本。旧的 &lt;code&gt;minio_clean&lt;/code&gt; 任务已被弃用。&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;移除剧本会自动完成以下操作：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;从 Victoria/Prometheus 监控系统中注销 MinIO 目标&lt;/li&gt;
&lt;li&gt;从 INFRA 节点的 DNS 服务中移除记录&lt;/li&gt;
&lt;li&gt;停止并禁用 MinIO systemd 服务&lt;/li&gt;
&lt;li&gt;删除 MinIO 数据目录和配置文件（可选）&lt;/li&gt;
&lt;li&gt;卸载 MinIO 软件包（可选）&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="集群扩容"&gt;集群扩容&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="https://min.io/docs/minio/linux/operations/install-deploy-manage/expand-minio-deployment.html"&gt;集群扩容教程&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;MinIO 无法在节点/磁盘级别上扩容，但可以在存储池（多个节点）层次上进行扩容。&lt;/p&gt;</description></item><item><title>预置剧本</title><link>https://pigsty.cc/docs/redis/playbook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/redis/playbook/</guid><description>&lt;p&gt;REDIS模块提供了两个剧本，用于部署/移除 Redis 集群/节点/实例：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#redisyml"&gt;&lt;code&gt;redis.yml&lt;/code&gt;&lt;/a&gt;：部署 Redis 集群/节点/实例&lt;/li&gt;
&lt;li&gt;&lt;a href="#redis-rmyml"&gt;&lt;code&gt;redis-rm.yml&lt;/code&gt;&lt;/a&gt;：移除 Redis 集群/节点/实例&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="redisyml"&gt;&lt;code&gt;redis.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;用于部署 Redis 的 &lt;a href="https://github.com/pgsty/pigsty/blob/main/redis.yml"&gt;&lt;code&gt;redis.yml&lt;/code&gt;&lt;/a&gt; 剧本包含以下子任务：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;redis_node : 初始化redis节点
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - redis_install : 安装redis &lt;span style="color:#000;font-weight:bold"&gt;&amp;amp;&lt;/span&gt; redis_exporter
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - redis_user : 创建操作系统用户 redis
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - redis_dir : 配置 redis的FHS目录结构
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;redis_exporter : 配置 redis_exporter 监控
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - redis_exporter_config : 生成redis_exporter配置
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - redis_exporter_launch : 启动redis_exporter
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;redis_instance : 初始化并重启redis集群/节点/实例
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - redis_config : 生成redis实例配置
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - redis_launch : 启动redis实例
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;redis_register : 将redis注册到基础设施中
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;redis_ha : 配置redis哨兵（仅sentinel模式）
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;redis_join : 组建redis原生集群（仅cluster模式）
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="操作级别"&gt;操作级别&lt;/h3&gt;
&lt;p&gt;&lt;code&gt;redis.yml&lt;/code&gt; 支持三种操作级别，通过 &lt;code&gt;-l&lt;/code&gt; 限制目标范围，通过 &lt;code&gt;-e redis_port=&amp;lt;port&amp;gt;&lt;/code&gt; 指定单个实例：&lt;/p&gt;</description></item><item><title>管理预案</title><link>https://pigsty.cc/docs/redis/admin/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/redis/admin/</guid><description>&lt;p&gt;以下是一些常见的 Redis 管理任务 SOP（预案）：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;基础运维&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#%E5%88%9D%E5%A7%8B%E5%8C%96redis"&gt;初始化Redis&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E4%B8%8B%E7%BA%BFredis"&gt;下线Redis&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E9%87%8D%E6%96%B0%E9%85%8D%E7%BD%AEredis"&gt;重新配置Redis&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E4%BD%BF%E7%94%A8redis%E5%AE%A2%E6%88%B7%E7%AB%AF"&gt;使用Redis客户端&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;高可用管理&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#%E6%89%8B%E5%B7%A5%E8%AE%BE%E7%BD%AEredis%E4%BB%8E%E5%BA%93"&gt;手工设置Redis从库&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E8%AE%BE%E7%BD%AEredis%E4%B8%BB%E4%BB%8E%E9%AB%98%E5%8F%AF%E7%94%A8"&gt;设置Redis主从高可用&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E5%88%9D%E5%A7%8B%E5%8C%96-redis-%E5%8E%9F%E7%94%9F%E9%9B%86%E7%BE%A4"&gt;初始化Redis原生集群&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;扩缩容与迁移&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#%E6%89%A9%E5%AE%B9redis%E8%8A%82%E7%82%B9"&gt;扩容Redis节点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E7%BC%A9%E5%AE%B9redis%E8%8A%82%E7%82%B9"&gt;缩容Redis节点&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E6%95%B0%E6%8D%AE%E5%A4%87%E4%BB%BD%E4%B8%8E%E6%81%A2%E5%A4%8D"&gt;数据备份与恢复&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;strong&gt;故障排查&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%E8%AF%8A%E6%96%AD"&gt;常见问题诊断&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"&gt;性能调优&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更多问题请参考 &lt;a href="https://pigsty.cc/docs/redis/faq/"&gt;FAQ：REDIS&lt;/a&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;h3 id="初始化redis"&gt;初始化Redis&lt;/h3&gt;
&lt;p&gt;您可以使用 &lt;a href="https://pigsty.cc/docs/redis/playbook#redisyml"&gt;&lt;code&gt;redis.yml&lt;/code&gt;&lt;/a&gt; 剧本来初始化 Redis 集群、节点、或实例：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化集群内所有 Redis 实例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./redis.yml -l &amp;lt;cluster&amp;gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化 redis 集群&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化特定节点上的所有 Redis 实例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./redis.yml -l 10.10.10.10 &lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化 redis 节点&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化特定 Redis 实例： 10.10.10.11:6379&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./redis.yml -l 10.10.10.11 -e &lt;span style="color:#000"&gt;redis_port&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#0000cf;font-weight:bold"&gt;6379&lt;/span&gt; -t redis
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;你也可以使用包装脚本命令行脚本来初始化：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/redis-add redis-ms &lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化 redis 集群 &amp;#39;redis-ms&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/redis-add 10.10.10.10 &lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化 redis 节点 &amp;#39;10.10.10.10&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/redis-add 10.10.10.10 &lt;span style="color:#0000cf;font-weight:bold"&gt;6379&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 初始化 redis 实例 &amp;#39;10.10.10.10:6379&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h3 id="下线redis"&gt;下线Redis&lt;/h3&gt;
&lt;p&gt;您可以使用 &lt;a href="https://pigsty.cc/docs/redis/playbook#redis-rmyml"&gt;&lt;code&gt;redis-rm.yml&lt;/code&gt;&lt;/a&gt; 剧本来下线 Redis 集群、节点、或实例：&lt;/p&gt;</description></item><item><title>Grafana 高可用部署：使用 PostgreSQL 后端数据库</title><link>https://pigsty.cc/docs/infra/admin/grafana/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/infra/admin/grafana/</guid><description>&lt;p&gt;您可以使用 PostgreSQL 作为 Grafana 后端使用的数据库。&lt;/p&gt;
&lt;p&gt;这是了解Pigsty部署系统使用方式的好机会，完成此教程，您会了解：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如何 &lt;a href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9B%86%E7%BE%A4"&gt;创建新数据库集群&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;如何在已有数据库集群中 &lt;a href="#%E5%88%9B%E5%BB%BAgrafana%E4%B8%9A%E5%8A%A1%E7%94%A8%E6%88%B7"&gt;创建新业务用户&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;如何在已有数据库集群中 &lt;a href="#%E5%88%9B%E5%BB%BAgrafana%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93"&gt;创建新业务数据库&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;如何 &lt;a href="#%E4%BD%BF%E7%94%A8grafana%E4%B8%9A%E5%8A%A1%E6%95%B0%E6%8D%AE%E5%BA%93"&gt;访问Pigsty所创建的数据库&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;如何 &lt;a href="#%E7%AE%A1%E7%90%86grafana%E7%9B%91%E6%8E%A7%E9%9D%A2%E6%9D%BF"&gt;管理Grafana中的监控面板&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;如何管理Grafana中的 &lt;a href="#%E7%AE%A1%E7%90%86postgres%E6%95%B0%E6%8D%AE%E6%BA%90"&gt;PostgreSQL数据源&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;如何一步到位完成 &lt;a href="#%E4%B8%80%E6%AD%A5%E5%88%B0%E4%BD%8D%E6%9B%B4%E6%96%B0grafana"&gt;Grafana数据库升级&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="太长不看"&gt;太长不看&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;vi pigsty.yml &lt;span style="color:#8f5902;font-style:italic"&gt;# 取消注释DB/User定义：dbuser_grafana grafana &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-user pg-meta dbuser_grafana
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;bin/pgsql-db pg-meta grafana
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;psql postgres://dbuser_grafana:DBUser.Grafana@meta:5436/grafana -c &lt;span style="color:#4e9a06"&gt;\
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; &lt;span style="color:#4e9a06"&gt;&amp;#39;CREATE TABLE t(); DROP TABLE t;&amp;#39;&lt;/span&gt; &lt;span style="color:#8f5902;font-style:italic"&gt;# 检查连接串可用性&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;vi /etc/grafana/grafana.ini &lt;span style="color:#8f5902;font-style:italic"&gt;# 修改 [database] type url&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;systemctl restart grafana-server
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="创建数据库集群"&gt;创建数据库集群&lt;/h2&gt;
&lt;p&gt;我们可以在&lt;code&gt;pg-meta&lt;/code&gt;上定义一个新的数据库&lt;code&gt;grafana&lt;/code&gt;，也可以在新的机器节点上创建一个专用于Grafana的数据库集群：&lt;code&gt;pg-grafana&lt;/code&gt;&lt;/p&gt;
&lt;h3 id="定义集群"&gt;定义集群&lt;/h3&gt;
&lt;p&gt;如果需要创建新的专用数据库集群&lt;code&gt;pg-grafana&lt;/code&gt;，部署在&lt;code&gt;10.10.10.11&lt;/code&gt;，&lt;code&gt;10.10.10.12&lt;/code&gt;两台机器上，可以使用以下配置文件：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg-grafana&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;hosts&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.11&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#204a87;font-weight:bold"&gt;pg_seq: 1, pg_role&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;primary}&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;10.10.10.12&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;{&lt;span style="color:#204a87;font-weight:bold"&gt;pg_seq: 2, pg_role&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;replica}&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;vars&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_cluster&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;pg-grafana&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_databases&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;- &lt;span style="color:#204a87;font-weight:bold"&gt;name&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;grafana&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;owner&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;dbuser_grafana&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;revokeconn&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;true&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;comment&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;grafana primary database&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pg_users&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;- &lt;span style="color:#204a87;font-weight:bold"&gt;name&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;dbuser_grafana&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;password&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;DBUser.Grafana&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;pgbouncer&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;true&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;roles&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;[&lt;/span&gt;&lt;span style="color:#000"&gt;dbrole_admin]&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;comment&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;admin user for grafana database&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h3 id="创建集群"&gt;创建集群&lt;/h3&gt;
&lt;p&gt;使用以下命令完成数据库集群&lt;code&gt;pg-grafana&lt;/code&gt;的创建：&lt;a href="https://pigsty.cc/docs/pgsql/playbook#pgsqlyml"&gt;&lt;code&gt;pgsql.yml&lt;/code&gt;&lt;/a&gt;。&lt;/p&gt;</description></item><item><title>管理预案</title><link>https://pigsty.cc/docs/ferret/admin/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/ferret/admin/</guid><description>&lt;p&gt;本文档介绍 FerretDB 集群的日常管理操作。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="创建-ferretdb-集群"&gt;创建 FerretDB 集群&lt;/h2&gt;
&lt;p&gt;在 &lt;a href="https://pigsty.cc/docs/setup/config"&gt;配置清单&lt;/a&gt; 中 &lt;a href="https://pigsty.cc/docs/ferret/config"&gt;定义&lt;/a&gt; FerretDB 集群后，您可以使用以下命令安装它：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./mongo.yml -l ferret &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 ferret 分组上安装 FerretDB&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;由于 FerretDB 使用 PostgreSQL 作为其底层存储，多次运行此剧本通常是安全的（幂等性）。&lt;/p&gt;
&lt;p&gt;FerretDB 服务配置了失败自动重启（&lt;code&gt;Restart=on-failure&lt;/code&gt;），为这个无状态代理层提供了基本的容错能力。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="移除-ferretdb-集群"&gt;移除 FerretDB 集群&lt;/h2&gt;
&lt;p&gt;要移除 FerretDB 集群，请使用 &lt;code&gt;mongo_purge&lt;/code&gt; 参数运行 &lt;a href="https://pigsty.cc/docs/ferret/playbook#mongoyml"&gt;&lt;code&gt;mongo.yml&lt;/code&gt;&lt;/a&gt; 剧本的 &lt;code&gt;mongo_purge&lt;/code&gt; 子任务：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./mongo.yml -l ferret -e &lt;span style="color:#000"&gt;mongo_purge&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&lt;span style="color:#204a87"&gt;true&lt;/span&gt; -t mongo_purge
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;&lt;strong&gt;重要&lt;/strong&gt;：请务必使用 &lt;code&gt;-l &amp;lt;cluster&amp;gt;&lt;/code&gt; 参数限制执行范围，避免误删其他集群。&lt;/p&gt;
&lt;p&gt;此命令将会：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;停止 FerretDB 服务&lt;/li&gt;
&lt;li&gt;移除 systemd 服务文件&lt;/li&gt;
&lt;li&gt;清理配置文件和证书&lt;/li&gt;
&lt;li&gt;从 Prometheus 监控中注销&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="连接到-ferretdb"&gt;连接到 FerretDB&lt;/h2&gt;
&lt;p&gt;您可以使用 MongoDB 连接串，用任何语言的 MongoDB 驱动访问 FerretDB。以下是使用 &lt;a href="https://pigsty.cc/docs/ferret/usage#%E5%AE%89%E8%A3%85%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%B7%A5%E5%85%B7"&gt;&lt;code&gt;mongosh&lt;/code&gt;&lt;/a&gt; 命令行工具的示例：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mongosh &lt;span style="color:#4e9a06"&gt;&amp;#39;mongodb://dbuser_meta:DBUser.Meta@10.10.10.10:27017&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;mongosh &lt;span style="color:#4e9a06"&gt;&amp;#39;mongodb://test:test@10.10.10.11:27017/test&amp;#39;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Pigsty 管理的 PostgreSQL 集群默认使用 &lt;code&gt;scram-sha-256&lt;/code&gt;。FerretDB 2.x 对应使用 &lt;code&gt;SCRAM-SHA-256&lt;/code&gt; 认证，绝大多数客户端会自动协商；如果遇到协商失败，可在连接串中显式追加 &lt;code&gt;authMechanism=SCRAM-SHA-256&lt;/code&gt;。参阅 &lt;a href="https://docs.ferretdb.io/security/authentication/"&gt;FerretDB：认证&lt;/a&gt; 获取详细信息。&lt;/p&gt;</description></item><item><title>管理剧本</title><link>https://pigsty.cc/docs/ferret/playbook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/ferret/playbook/</guid><description>&lt;p&gt;Pigsty 提供了一个内置剧本 &lt;a href="https://github.com/pgsty/pigsty/blob/v4.1.0/mongo.yml"&gt;&lt;code&gt;mongo.yml&lt;/code&gt;&lt;/a&gt; 用于在节点上安装 FerretDB。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;重要说明&lt;/strong&gt;：此剧本仅在定义了 &lt;a href="https://pigsty.cc/docs/ferret/param#mongo_seq"&gt;&lt;code&gt;mongo_seq&lt;/code&gt;&lt;/a&gt; 参数的主机上执行。
对于未定义 &lt;code&gt;mongo_seq&lt;/code&gt; 的主机，剧本会安全跳过所有任务，因此可以安全地在混合主机组上运行。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="mongoyml"&gt;&lt;code&gt;mongo.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;剧本地址：&lt;a href="https://github.com/pgsty/pigsty/blob/v4.1.0/mongo.yml"&gt;&lt;code&gt;mongo.yml&lt;/code&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;功能说明：在定义了 &lt;code&gt;mongo_seq&lt;/code&gt; 的目标主机上安装 MongoDB/FerretDB。&lt;/p&gt;
&lt;p&gt;此剧本包含以下子任务：&lt;/p&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;子任务&lt;/th&gt;
 &lt;th style="text-align: left"&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;mongo_check&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;检查 mongo 身份参数&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;mongo_dbsu&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;创建操作系统用户 mongod&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;mongo_install&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;安装 ferretdb RPM/DEB 包&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;mongo_purge&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;清理现有 FerretDB（默认不执行）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;mongo_config&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;配置 FerretDB 服务&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;mongo_cert&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;签发 FerretDB SSL 证书&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;mongo_launch&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;启动 FerretDB 服务&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;&lt;code&gt;mongo_register&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;将 FerretDB 注册到 Prometheus&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h2 id="任务详解"&gt;任务详解&lt;/h2&gt;
&lt;h3 id="mongo_check"&gt;&lt;code&gt;mongo_check&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;检查必选的身份参数是否已定义：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;mongo_cluster&lt;/code&gt;：集群名称&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mongo_seq&lt;/code&gt;：实例序号&lt;/li&gt;
&lt;li&gt;&lt;code&gt;mongo_pgurl&lt;/code&gt;：PostgreSQL 连接串&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如果任一参数缺失，剧本将报错退出。&lt;/p&gt;
&lt;h3 id="mongo_dbsu"&gt;&lt;code&gt;mongo_dbsu&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;创建 FerretDB 运行所需的操作系统用户和组：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;创建 &lt;code&gt;mongod&lt;/code&gt; 用户组&lt;/li&gt;
&lt;li&gt;创建 &lt;code&gt;mongod&lt;/code&gt; 用户，家目录为 &lt;code&gt;/var/lib/mongod&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="mongo_install"&gt;&lt;code&gt;mongo_install&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;安装 FerretDB 软件包：&lt;/p&gt;</description></item><item><title>预置剧本</title><link>https://pigsty.cc/docs/docker/playbook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/docker/playbook/</guid><description>&lt;p&gt;Docker 模块提供了一个默认的剧本 &lt;a href="#dockeryml"&gt;&lt;code&gt;docker.yml&lt;/code&gt;&lt;/a&gt; ，用于安装 Docker Daemon 与 Docker Compose。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="dockeryml"&gt;&lt;code&gt;docker.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;剧本原始文件：&lt;a href="https://github.com/pgsty/pigsty/blob/main/docker.yml"&gt;&lt;code&gt;docker.yml&lt;/code&gt;&lt;/a&gt; 中&lt;/p&gt;
&lt;p&gt;执行本剧本，将会在带有 &lt;code&gt;docker_enabled: true&lt;/code&gt; 标记的目标节点上安装 &lt;code&gt;docker-ce&lt;/code&gt; 与 &lt;code&gt;docker-compose-plugin&lt;/code&gt;，启用 &lt;code&gt;dockerd&lt;/code&gt; 服务&lt;/p&gt;
&lt;p&gt;以下是 &lt;code&gt;docker.yml&lt;/code&gt; 剧本中可用的任务子集：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;docker_install&lt;/code&gt; ： 在节点上安装 Docker，Docker Compose 软件包&lt;/li&gt;
&lt;li&gt;&lt;code&gt;docker_admin&lt;/code&gt; ： 将指定的用户加入 Docker 管理员用户组中&lt;/li&gt;
&lt;li&gt;&lt;code&gt;docker_dir&lt;/code&gt; ： 创建 Docker 相关目录&lt;/li&gt;
&lt;li&gt;&lt;code&gt;docker_config&lt;/code&gt; ： 生成 Docker 守护进程服务配置文件&lt;/li&gt;
&lt;li&gt;&lt;code&gt;docker_launch&lt;/code&gt; ： 启动 Docker 守护进程服务&lt;/li&gt;
&lt;li&gt;&lt;code&gt;docker_register&lt;/code&gt; ： 将 Docker 守护进程注册为监控目标（别名标签：&lt;code&gt;register&lt;/code&gt; / &lt;code&gt;add_metrics&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;&lt;code&gt;docker_image&lt;/code&gt; ： 尝试从 &lt;code&gt;/tmp/docker/*.tgz&lt;/code&gt; 加载预置镜像压缩包（如果存在）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Docker 模块没有提供专门的卸载剧本，如果您需要卸载 Docker，可以手工停止 docker 后卸载：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;systemctl stop docker &lt;span style="color:#8f5902;font-style:italic"&gt;# 停止 Docker 守护进程服务&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;yum remove docker-ce docker-compose-plugin &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 EL 系统上卸载 Docker &lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;apt remove docker-ce docker-compose-plugin &lt;span style="color:#8f5902;font-style:italic"&gt;# 在 Debian 系统上卸载 Docker&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</description></item><item><title>预置剧本</title><link>https://pigsty.cc/docs/juice/playbook/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/juice/playbook/</guid><description>&lt;p&gt;JUICE 模块提供 &lt;code&gt;juice.yml&lt;/code&gt; 剧本，用于部署与移除 JuiceFS 实例。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="juiceyml"&gt;&lt;code&gt;juice.yml&lt;/code&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href="https://github.com/pgsty/pigsty/blob/v4.1.0/juice.yml"&gt;&lt;code&gt;juice.yml&lt;/code&gt;&lt;/a&gt; 的任务结构如下：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;juice_id : 校验配置、检查端口冲突
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;juice_install : 安装 juicefs 软件包
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;juice_cache : 创建共享缓存目录
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;juice_clean : 移除实例（state&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;absent）
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;juice_instance : 创建实例（state&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;create）
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - juice_init : 格式化文件系统（--no-update）
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - juice_dir : 创建挂载点目录
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - juice_config: 渲染环境文件与 systemd 服务单元
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt; - juice_launch: 启动服务并等待指标端口就绪
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;juice_register : 注册到 VictoriaMetrics 目标文件
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="运行粒度"&gt;运行粒度&lt;/h2&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th style="text-align: left"&gt;粒度&lt;/th&gt;
 &lt;th style="text-align: left"&gt;限制参数&lt;/th&gt;
 &lt;th style="text-align: left"&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;节点&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;-l &amp;lt;host&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;部署该节点所有实例&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;实例&lt;/td&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;-l &amp;lt;host&amp;gt; -e fsname=&amp;lt;name&amp;gt;&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;只处理指定实例&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;示例：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./juice.yml -l 10.10.10.10 &lt;span style="color:#8f5902;font-style:italic"&gt;# 部署该节点所有实例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./juice.yml -l 10.10.10.10 -e &lt;span style="color:#000"&gt;fsname&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;jfs &lt;span style="color:#8f5902;font-style:italic"&gt;# 仅部署 jfs 实例&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="常用标签"&gt;常用标签&lt;/h2&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th style="text-align: left"&gt;标签&lt;/th&gt;
 &lt;th style="text-align: left"&gt;说明&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_id&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;校验 &lt;code&gt;juice_instances&lt;/code&gt; 与端口冲突&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_install&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;安装 &lt;code&gt;juicefs&lt;/code&gt; 软件包&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_cache&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;创建共享缓存目录&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_clean&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;移除实例（state=absent）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_instance&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;创建实例（伞形标签）&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_init&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;格式化文件系统&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_dir&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;创建挂载点目录&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_config&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;渲染配置文件&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_launch&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;启动服务&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td style="text-align: left"&gt;&lt;code&gt;juice_register&lt;/code&gt;&lt;/td&gt;
 &lt;td style="text-align: left"&gt;写入 VictoriaMetrics 目标文件&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;hr&gt;
&lt;h2 id="配置更新"&gt;配置更新&lt;/h2&gt;
&lt;p&gt;仅更新配置文件（不重启服务）：&lt;/p&gt;</description></item><item><title>管理预案</title><link>https://pigsty.cc/docs/juice/admin/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/juice/admin/</guid><description>&lt;p&gt;常见运维场景如下：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%9E%E4%BE%8B"&gt;初始化实例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E9%87%8D%E6%96%B0%E9%85%8D%E7%BD%AE"&gt;重新配置&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E7%A7%BB%E9%99%A4%E5%AE%9E%E4%BE%8B"&gt;移除实例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E5%AE%9E%E4%BE%8B"&gt;添加新实例&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E5%A4%9A%E8%8A%82%E7%82%B9%E5%85%B1%E4%BA%AB%E6%8C%82%E8%BD%BD"&gt;多节点共享挂载&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#pitr-%E6%81%A2%E5%A4%8D"&gt;PITR 恢复&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5"&gt;故障排查&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="#%E6%80%A7%E8%83%BD%E8%B0%83%E4%BC%98"&gt;性能调优&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;更多问题参见 &lt;a href="https://pigsty.cc/docs/juice/faq/"&gt;FAQ&lt;/a&gt;。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="初始化实例"&gt;初始化实例&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./juice.yml -l &amp;lt;host&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./juice.yml -l &amp;lt;host&amp;gt; -e &lt;span style="color:#000"&gt;fsname&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;&amp;lt;name&amp;gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;初始化流程：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;安装 &lt;code&gt;juicefs&lt;/code&gt; 软件包&lt;/li&gt;
&lt;li&gt;创建共享缓存目录（默认 &lt;code&gt;/data/juice&lt;/code&gt;）&lt;/li&gt;
&lt;li&gt;执行 &lt;code&gt;juicefs format --no-update&lt;/code&gt;（仅首次创建有效）&lt;/li&gt;
&lt;li&gt;创建挂载点目录并设置权限&lt;/li&gt;
&lt;li&gt;渲染 systemd 单元与环境文件&lt;/li&gt;
&lt;li&gt;启动服务并等待指标端口就绪&lt;/li&gt;
&lt;li&gt;注册到 VictoriaMetrics（若存在 infra 节点）&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="重新配置"&gt;重新配置&lt;/h2&gt;
&lt;p&gt;修改配置后，建议执行以下命令（更新配置并确保服务在线）：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./juice.yml -l &amp;lt;host&amp;gt; -t juice_config,juice_launch
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;仅渲染配置文件而不触碰服务状态：&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./juice.yml -l &amp;lt;host&amp;gt; -t juice_config
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;说明：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;juice_config,juice_launch&lt;/code&gt; 会确保服务处于 &lt;code&gt;started&lt;/code&gt;，但不会强制重启已运行实例&lt;/li&gt;
&lt;li&gt;&lt;code&gt;data&lt;/code&gt; 仅在首次 &lt;code&gt;format&lt;/code&gt; 时生效&lt;/li&gt;
&lt;li&gt;变更 &lt;code&gt;mount&lt;/code&gt; 参数后，请手动重启对应服务（&lt;code&gt;systemctl restart juicefs-&amp;lt;name&amp;gt;&lt;/code&gt;）&lt;/li&gt;
&lt;/ul&gt;
&lt;hr&gt;
&lt;h2 id="移除实例"&gt;移除实例&lt;/h2&gt;
&lt;ol&gt;
&lt;li&gt;将实例 &lt;code&gt;state&lt;/code&gt; 设为 &lt;code&gt;absent&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;执行 &lt;code&gt;juice_clean&lt;/code&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-yaml" data-lang="yaml"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;juice_instances&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;jfs&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;path&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;/fs&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;meta&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;postgres://...&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#204a87;font-weight:bold"&gt;state&lt;/span&gt;&lt;span style="color:#000;font-weight:bold"&gt;:&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt; &lt;/span&gt;&lt;span style="color:#000"&gt;absent&lt;/span&gt;&lt;span style="color:#f8f8f8"&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./juice.yml -l &amp;lt;host&amp;gt; -t juice_clean
&lt;/span&gt;&lt;/span&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;./juice.yml -l &amp;lt;host&amp;gt; -e &lt;span style="color:#000"&gt;fsname&lt;/span&gt;&lt;span style="color:#ce5c00;font-weight:bold"&gt;=&lt;/span&gt;jfs -t juice_clean
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;移除动作：&lt;/p&gt;</description></item><item><title>安装指南</title><link>https://pigsty.cc/docs/pg_exporter/install/</link><pubDate>Mon, 01 Jan 0001 00:00:00 +0000</pubDate><guid>https://pigsty.cc/docs/pg_exporter/install/</guid><description>&lt;p&gt;PG Exporter 提供多种安装方式以适应不同的部署场景。本指南涵盖了各平台的所有可用安装选项及详细说明。&lt;/p&gt;
&lt;hr&gt;
&lt;h2 id="pigsty"&gt;Pigsty&lt;/h2&gt;
&lt;p&gt;最简单的使用 &lt;code&gt;pg_exporter&lt;/code&gt; 的方式是使用 &lt;a href="https://pigsty.cc"&gt;Pigsty&lt;/a&gt;，这是一个完整的 PostgreSQL 发行版，内置了基于 &lt;code&gt;pg_exporter&lt;/code&gt;、Prometheus 和 Grafana 的可观测性最佳实践。您甚至不需要了解 &lt;code&gt;pg_exporter&lt;/code&gt; 的任何细节，它会直接为您提供所有指标和仪表盘面板。&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"&gt;&lt;code class="language-bash" data-lang="bash"&gt;&lt;span style="display:flex;"&gt;&lt;span&gt;curl -fsSL https://repo.pigsty.io/get &lt;span style="color:#000;font-weight:bold"&gt;|&lt;/span&gt; bash&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt; &lt;span style="color:#204a87"&gt;cd&lt;/span&gt; ~/pigsty&lt;span style="color:#000;font-weight:bold"&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;hr&gt;
&lt;h2 id="发布版本"&gt;发布版本&lt;/h2&gt;
&lt;p&gt;您也可以直接从 &lt;a href="https://github.com/pgsty/pg_exporter/releases/latest"&gt;GitHub 发布页面&lt;/a&gt; 下载 &lt;code&gt;pg_exporter&lt;/code&gt; 软件包（&lt;code&gt;RPM&lt;/code&gt;/&lt;code&gt;DEB&lt;/code&gt;/Tarball）：&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;v1.2.0 发布文件：&lt;/strong&gt;&lt;/p&gt;
&lt;table class="full-width"&gt;
 &lt;thead&gt;
 &lt;tr&gt;
 &lt;th&gt;类型&lt;/th&gt;
 &lt;th&gt;文件&lt;/th&gt;
 &lt;/tr&gt;
 &lt;/thead&gt;
 &lt;tbody&gt;
 &lt;tr&gt;
 &lt;td&gt;DEB (amd64)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg-exporter_1.2.0-1_amd64.deb"&gt;pg-exporter_1.2.0-1_amd64.deb&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;DEB (arm64)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg-exporter_1.2.0-1_arm64.deb"&gt;pg-exporter_1.2.0-1_arm64.deb&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;DEB (ppc64le)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg-exporter_1.2.0-1_ppc64le.deb"&gt;pg-exporter_1.2.0-1_ppc64le.deb&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;RPM (aarch64)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0-1.aarch64.rpm"&gt;pg_exporter-1.2.0-1.aarch64.rpm&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;RPM (x86_64)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0-1.x86_64.rpm"&gt;pg_exporter-1.2.0-1.x86_64.rpm&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;RPM (ppc64le)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0-1.ppc64le.rpm"&gt;pg_exporter-1.2.0-1.ppc64le.rpm&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;Tarball (Linux amd64)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.linux-amd64.tar.gz"&gt;pg_exporter-1.2.0.linux-amd64.tar.gz&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;Tarball (Linux arm64)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.linux-arm64.tar.gz"&gt;pg_exporter-1.2.0.linux-arm64.tar.gz&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;Tarball (Linux ppc64le)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.linux-ppc64le.tar.gz"&gt;pg_exporter-1.2.0.linux-ppc64le.tar.gz&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;Tarball (macOS amd64)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.darwin-amd64.tar.gz"&gt;pg_exporter-1.2.0.darwin-amd64.tar.gz&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;Tarball (macOS arm64)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.darwin-arm64.tar.gz"&gt;pg_exporter-1.2.0.darwin-arm64.tar.gz&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;tr&gt;
 &lt;td&gt;Tarball (Windows amd64)&lt;/td&gt;
 &lt;td&gt;&lt;a href="https://github.com/pgsty/pg_exporter/releases/download/v1.2.0/pg_exporter-1.2.0.windows-amd64.tar.gz"&gt;pg_exporter-1.2.0.windows-amd64.tar.gz&lt;/a&gt;&lt;/td&gt;
 &lt;/tr&gt;
 &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;您可以直接使用操作系统的包管理器（&lt;code&gt;rpm&lt;/code&gt;/&lt;code&gt;dpkg&lt;/code&gt;）安装，或者将二进制文件放入 &lt;code&gt;$PATH&lt;/code&gt; 中。&lt;/p&gt;</description></item></channel></rss>